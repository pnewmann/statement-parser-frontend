<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Statement Scan - Portfolio Intelligence</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><rect width='32' height='32' rx='6' fill='%23635bff'/><rect x='2' y='2' width='14' height='14' rx='3' fill='white'/><rect x='16' y='16' width='14' height='14' rx='3' fill='white'/><rect x='0' y='13' width='32' height='6' fill='white' opacity='0.4'/><rect x='11' y='11' width='10' height='10' rx='2' fill='white'/></svg>" type="image/svg+xml">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://d3js.org/topojson.v3.min.js"></script>
    <script src="https://cdn.plaid.com/link/v2/stable/link-initialize.js"></script>
    <style>
        :root {
            --primary: #635bff;
            --primary-dark: #5851db;
            --primary-light: #7a73ff;
            --success: #30d158;
            --danger: #ff453a;
            --warning: #ffd60a;
            --text-primary: #0a2540;
            --text-secondary: #425466;
            --text-muted: #8898aa;
            --bg-primary: #ffffff;
            --bg-secondary: #f6f9fc;
            --bg-tertiary: #e3e8ee;
            --border: #e3e8ee;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.04);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
            --shadow-lg: 0 8px 24px rgba(0,0,0,0.12);
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 16px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-secondary);
            color: var(--text-primary);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 24px;
        }

        /* Header */
        header {
            text-align: center;
            margin-bottom: 48px;
        }

        .logo {
            display: inline-flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 24px;
        }

        .logo-icon {
            width: 72px;
            height: 72px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--primary);
            border-radius: 16px;
            box-shadow: 0 4px 16px rgba(99, 91, 255, 0.3);
        }

        .logo-icon svg {
            width: 44px;
            height: 44px;
        }

        .brand-text {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .brand-name {
            font-size: 2rem;
            font-weight: 800;
            color: var(--text-primary);
            letter-spacing: -0.03em;
            line-height: 1;
            text-transform: uppercase;
        }

        .brand-tagline {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--primary);
            letter-spacing: 0.15em;
            text-transform: uppercase;
            margin-top: 6px;
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: -0.02em;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 1.125rem;
            margin-top: 12px;
            max-width: 400px;
        }

        /* Cards */
        .card {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
            padding: 24px;
            transition: box-shadow 0.2s, transform 0.2s;
        }

        .card:hover {
            box-shadow: var(--shadow-md);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Upload Section */
        .upload-card {
            max-width: 600px;
            margin: 0 auto;
            padding: 48px;
            text-align: center;
        }

        .upload-card.dragover {
            border-color: var(--primary);
            background: rgba(99, 91, 255, 0.04);
        }

        .upload-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 24px;
            background: var(--bg-secondary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .upload-icon svg {
            width: 28px;
            height: 28px;
            color: var(--primary);
        }

        .upload-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .upload-hint {
            color: var(--text-muted);
            font-size: 0.875rem;
            margin-bottom: 24px;
        }

        #fileInput {
            display: none;
        }

        /* Multi-file Upload Queue */
        .upload-queue {
            margin-top: 24px;
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            overflow: hidden;
            max-height: 300px;
            overflow-y: auto;
        }

        .upload-queue-header {
            padding: 12px 16px;
            background: var(--bg-secondary);
            font-size: 0.8125rem;
            font-weight: 600;
            color: var(--text-secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
        }

        .upload-queue-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            border-top: 1px solid var(--border);
            gap: 12px;
        }

        .upload-queue-item:first-of-type {
            border-top: none;
        }

        .upload-file-icon {
            width: 36px;
            height: 36px;
            background: var(--bg-secondary);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .upload-file-icon svg {
            width: 18px;
            height: 18px;
            color: var(--primary);
        }

        .upload-file-icon.success {
            background: #dcfce7;
        }

        .upload-file-icon.success svg {
            color: var(--success);
        }

        .upload-file-icon.error {
            background: #fee2e2;
        }

        .upload-file-icon.error svg {
            color: #ef4444;
        }

        .upload-file-icon.processing {
            background: #e0e7ff;
        }

        .upload-file-info {
            flex: 1;
            min-width: 0;
        }

        .upload-file-name {
            font-weight: 500;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .upload-file-status {
            font-size: 0.8125rem;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .upload-file-status.success {
            color: var(--success);
        }

        .upload-file-status.error {
            color: #ef4444;
        }

        .upload-progress-bar {
            width: 100%;
            height: 4px;
            background: var(--bg-tertiary);
            border-radius: 2px;
            margin-top: 6px;
            overflow: hidden;
        }

        .upload-progress-fill {
            height: 100%;
            background: var(--primary);
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        .upload-summary {
            display: flex;
            gap: 16px;
            margin-top: 16px;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            justify-content: center;
        }

        .upload-summary-stat {
            text-align: center;
        }

        .upload-summary-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .upload-summary-value.success {
            color: var(--success);
        }

        .upload-summary-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Entry Method Selector */
        .entry-methods {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 24px;
            padding: 6px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }

        .entry-method-btn {
            flex: 1;
            padding: 12px 16px;
            border: none;
            background: transparent;
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .entry-method-btn:hover {
            color: var(--text-primary);
        }

        .entry-method-btn.active {
            background: var(--bg-primary);
            color: var(--primary);
            box-shadow: var(--shadow-sm);
        }

        .entry-method-btn svg {
            width: 18px;
            height: 18px;
        }

        .entry-panel {
            display: none;
        }

        .entry-panel.active {
            display: block;
        }

        /* Manual Entry */
        .manual-entry-card {
            max-width: 700px;
            margin: 0 auto;
            padding: 32px;
        }

        .manual-entry-form {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .manual-entry-form .form-group {
            flex: 1;
            min-width: 120px;
        }

        .manual-entry-form label {
            display: block;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .manual-entry-form input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 0.9375rem;
            background: var(--bg-primary);
            transition: border-color 0.2s;
        }

        .manual-entry-form input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .manual-entry-form input::placeholder {
            color: var(--text-muted);
        }

        .manual-entry-form .btn-add {
            align-self: flex-end;
            padding: 10px 20px;
        }

        .holdings-list {
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            overflow: hidden;
            margin-bottom: 24px;
        }

        .holdings-list-header {
            display: grid;
            grid-template-columns: 2fr 1.5fr 1.5fr 1.5fr auto;
            gap: 12px;
            padding: 12px 16px;
            background: var(--bg-secondary);
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .holdings-list-empty {
            padding: 48px 24px;
            text-align: center;
            color: var(--text-muted);
        }

        .holdings-list-item {
            display: grid;
            grid-template-columns: 2fr 1.5fr 1.5fr 1.5fr auto;
            gap: 12px;
            padding: 14px 16px;
            border-top: 1px solid var(--border);
            align-items: center;
        }

        .holdings-list-item:first-of-type {
            border-top: none;
        }

        .holding-symbol {
            font-weight: 600;
            color: var(--text-primary);
        }

        .holding-value {
            color: var(--text-secondary);
        }

        .holding-total {
            font-weight: 600;
            color: var(--success);
        }

        .btn-remove {
            width: 32px;
            height: 32px;
            padding: 0;
            border: none;
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .btn-remove:hover {
            background: #fee2e2;
            color: #ef4444;
        }

        .manual-entry-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .manual-total {
            font-size: 1rem;
            color: var(--text-secondary);
        }

        .manual-total strong {
            color: var(--text-primary);
            font-size: 1.25rem;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 24px;
            font-size: 0.9375rem;
            font-weight: 600;
            border-radius: var(--radius-md);
            border: none;
            cursor: pointer;
            transition: all 0.15s ease;
            text-decoration: none;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-secondary {
            background: var(--bg-primary);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--bg-secondary);
            border-color: var(--text-muted);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Account List */
        .accounts-section {
            margin-top: 32px;
        }

        .accounts-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .accounts-header h3 {
            font-size: 1rem;
            font-weight: 600;
        }

        .account-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            margin-bottom: 8px;
        }

        .account-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.875rem;
        }

        .account-details {
            flex: 1;
        }

        .account-name-input {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 8px 12px;
            font-size: 0.9375rem;
            color: var(--text-primary);
            font-family: inherit;
        }

        .account-name-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 91, 255, 0.1);
        }

        .account-meta {
            color: var(--text-muted);
            font-size: 0.8125rem;
            margin-top: 4px;
        }

        .account-value {
            font-weight: 600;
            font-size: 1.125rem;
            color: var(--success);
        }

        .remove-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 8px;
            border-radius: var(--radius-sm);
            transition: all 0.15s;
        }

        .remove-btn:hover {
            background: rgba(255, 69, 58, 0.1);
            color: var(--danger);
        }

        .actions-row {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        /* Progress */
        .progress-section {
            display: none;
            text-align: center;
            padding: 80px 40px;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 24px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .progress-text {
            color: var(--text-secondary);
            font-size: 1rem;
        }

        /* Error */
        .error-message {
            background: rgba(255, 69, 58, 0.08);
            border: 1px solid rgba(255, 69, 58, 0.2);
            color: var(--danger);
            padding: 16px 20px;
            border-radius: var(--radius-md);
            margin-bottom: 24px;
            display: none;
            font-size: 0.9375rem;
        }

        /* Dashboard */
        .dashboard {
            display: none;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .dashboard-title {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .dashboard-logo {
            width: 44px;
            height: 44px;
            background: var(--primary);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(99, 91, 255, 0.25);
        }

        .dashboard-logo svg {
            width: 28px;
            height: 28px;
        }

        .dashboard-title h2 {
            font-size: 1.75rem;
            font-weight: 700;
        }

        .total-badge {
            background: linear-gradient(135deg, var(--success) 0%, #28a745 100%);
            color: white;
            padding: 8px 20px;
            border-radius: 100px;
            font-weight: 600;
            font-size: 1.125rem;
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 4px;
            background: var(--bg-primary);
            padding: 4px;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
            margin-bottom: 32px;
            overflow-x: auto;
        }

        .tab {
            padding: 12px 20px;
            font-size: 0.9375rem;
            font-weight: 500;
            color: var(--text-secondary);
            background: transparent;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.15s;
            white-space: nowrap;
        }

        .tab:hover {
            color: var(--text-primary);
            background: var(--bg-secondary);
        }

        .tab.active {
            background: var(--primary);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: var(--bg-primary);
            border-radius: var(--radius-md);
            padding: 20px;
            border: 1px solid var(--border);
        }

        .stat-label {
            font-size: 0.8125rem;
            font-weight: 500;
            color: var(--text-muted);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .stat-value.positive {
            color: var(--success);
        }

        .stat-value.negative {
            color: var(--danger);
        }

        .stat-subtitle {
            font-size: 0.8125rem;
            color: var(--text-muted);
            margin-top: 4px;
        }

        /* Charts */
        .chart-card {
            margin-bottom: 24px;
        }

        .chart-wrapper {
            position: relative;
            height: 320px;
        }

        .charts-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 24px;
            margin-bottom: 24px;
        }

        /* Performance Returns */
        .period-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .period-btn {
            padding: 10px 20px;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-secondary);
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.15s;
        }

        .period-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .period-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .returns-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-bottom: 32px;
        }

        .return-card {
            text-align: center;
            padding: 20px 16px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .return-card:hover {
            border-color: var(--primary);
        }

        .return-card.active {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 91, 255, 0.1);
        }

        .return-card .stat-value {
            font-size: 1.5rem;
        }

        .benchmark-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 8px;
        }

        /* World Map */
        .map-container {
            position: relative;
            padding: 24px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
        }

        #worldMapContainer {
            width: 100%;
            max-width: 900px;
            margin: 0 auto;
        }

        #worldMapContainer svg {
            width: 100%;
            height: auto;
            display: block;
        }

        .country {
            fill: #dce3eb;
            stroke: #fff;
            stroke-width: 0.4;
            transition: fill 0.2s;
        }

        .country:hover {
            opacity: 0.85;
        }

        .country.us { fill: var(--primary); }
        .country.developed { fill: #a5b4fc; }
        .country.emerging { fill: #fbbf24; }

        .map-legend {
            display: flex;
            justify-content: center;
            gap: 32px;
            margin-top: 24px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9375rem;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .legend-dot {
            width: 14px;
            height: 14px;
            border-radius: 4px;
        }

        .legend-dot.us { background: var(--primary); }
        .legend-dot.developed { background: #a5b4fc; }
        .legend-dot.emerging { background: #fbbf24; }

        /* Scenario Analysis */
        .scenarios-container {
            display: grid;
            gap: 16px;
        }

        .scenario-card {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 16px;
            align-items: center;
        }

        .scenario-info h4 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .scenario-info p {
            font-size: 0.8125rem;
            color: var(--text-muted);
        }

        .scenario-impact {
            text-align: right;
        }

        .scenario-pct {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .scenario-pct.positive { color: var(--success); }
        .scenario-pct.negative { color: var(--danger); }

        .scenario-value {
            font-size: 0.8125rem;
            color: var(--text-muted);
        }

        .scenario-bar-container {
            grid-column: 1 / -1;
            height: 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }

        .scenario-bar {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .scenario-bar.positive { background: var(--success); }
        .scenario-bar.negative { background: var(--danger); }

        /* Sector Comparison */
        .sector-list {
            display: grid;
            gap: 16px;
        }

        .sector-item {
            display: grid;
            grid-template-columns: 140px 1fr 70px 70px;
            gap: 16px;
            align-items: center;
        }

        .sector-name {
            font-size: 0.9375rem;
            font-weight: 500;
        }

        .sector-bar-container {
            position: relative;
            height: 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
            overflow: hidden;
        }

        .sector-bar {
            position: absolute;
            height: 100%;
            border-radius: 4px;
        }

        .sector-bar.portfolio {
            background: var(--primary);
            z-index: 2;
        }

        .sector-bar.benchmark {
            background: var(--bg-tertiary);
            z-index: 1;
        }

        .sector-pct {
            font-size: 0.875rem;
            text-align: right;
            font-weight: 500;
            font-variant-numeric: tabular-nums;
        }

        .sector-pct.portfolio { color: var(--primary); }
        .sector-pct.benchmark { color: var(--text-muted); }

        /* Risk Cards */
        .risk-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px;
            margin-bottom: 32px;
        }

        .risk-card {
            text-align: center;
            padding: 28px 20px;
        }

        .risk-value {
            font-size: 2.25rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .risk-label {
            font-size: 0.9375rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .risk-desc {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* Holdings Table */
        .table-container {
            overflow-x: auto;
            border-radius: var(--radius-md);
            border: 1px solid var(--border);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9375rem;
        }

        th, td {
            padding: 14px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        th {
            background: var(--bg-secondary);
            font-weight: 600;
            font-size: 0.8125rem;
            text-transform: uppercase;
            letter-spacing: 0.03em;
            color: var(--text-secondary);
        }

        tbody tr:hover {
            background: var(--bg-secondary);
        }

        tbody tr:last-child td {
            border-bottom: none;
        }

        .text-right {
            text-align: right;
        }

        .font-mono {
            font-variant-numeric: tabular-nums;
        }

        .symbol-cell {
            font-weight: 600;
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 100px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .badge-primary {
            background: rgba(99, 91, 255, 0.1);
            color: var(--primary);
        }

        .badge-secondary {
            background: var(--bg-secondary);
            color: var(--text-secondary);
        }

        .total-row {
            background: var(--bg-secondary);
            font-weight: 600;
        }

        /* Top Holdings */
        .holdings-list {
            display: grid;
            gap: 12px;
        }

        .holding-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }

        .holding-item:last-child {
            border-bottom: none;
        }

        .holding-rank {
            width: 28px;
            height: 28px;
            background: var(--bg-secondary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8125rem;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .holding-info {
            flex: 1;
        }

        .holding-symbol {
            font-weight: 600;
        }

        .holding-values {
            text-align: right;
        }

        .holding-amount {
            font-weight: 600;
        }

        .holding-pct {
            font-size: 0.8125rem;
            color: var(--text-muted);
        }

        /* Footer */
        footer {
            text-align: center;
            padding: 40px 0;
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 24px 16px;
            }

            h1 {
                font-size: 1.75rem;
            }

            .upload-card {
                padding: 32px 24px;
            }

            .charts-row {
                grid-template-columns: 1fr;
            }

            .sector-item {
                grid-template-columns: 100px 1fr 60px 60px;
                gap: 8px;
            }

            .tabs {
                padding: 3px;
            }

            .tab {
                padding: 10px 14px;
                font-size: 0.875rem;
            }
        }

        /* Auth Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(10, 37, 64, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            width: 100%;
            max-width: 400px;
            margin: 24px;
            transform: translateY(20px);
            transition: transform 0.2s;
        }

        .modal-overlay.active .modal {
            transform: translateY(0);
        }

        .modal-header {
            padding: 24px 24px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 8px;
            border-radius: var(--radius-sm);
            transition: all 0.15s;
        }

        .modal-close:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .modal-body {
            padding: 24px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            font-size: 0.9375rem;
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: inherit;
            transition: all 0.15s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 91, 255, 0.1);
        }

        .form-input::placeholder {
            color: var(--text-muted);
        }

        .form-error {
            color: var(--danger);
            font-size: 0.8125rem;
            margin-top: 8px;
        }

        .auth-tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
            margin-bottom: 24px;
        }

        .auth-tab {
            flex: 1;
            padding: 12px;
            font-size: 0.9375rem;
            font-weight: 500;
            color: var(--text-muted);
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            transition: all 0.15s;
        }

        .auth-tab:hover {
            color: var(--text-primary);
        }

        .auth-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        /* User Menu */
        .user-menu {
            position: relative;
        }

        .user-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-primary);
            transition: all 0.15s;
        }

        .user-btn:hover {
            border-color: var(--primary);
        }

        .user-avatar {
            width: 28px;
            height: 28px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.75rem;
        }

        .user-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-md);
            min-width: 200px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.15s;
            z-index: 100;
        }

        .user-dropdown.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-item {
            display: block;
            width: 100%;
            padding: 12px 16px;
            font-size: 0.875rem;
            color: var(--text-primary);
            background: none;
            border: none;
            text-align: left;
            cursor: pointer;
            transition: background 0.15s;
        }

        .dropdown-item:hover {
            background: var(--bg-secondary);
        }

        .dropdown-divider {
            height: 1px;
            background: var(--border);
            margin: 4px 0;
        }

        /* Saved Portfolios */
        .saved-portfolios {
            margin-top: 32px;
        }

        .saved-portfolios-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .saved-portfolios-header h3 {
            font-size: 1rem;
            font-weight: 600;
        }

        .portfolio-list {
            display: grid;
            gap: 12px;
        }

        .portfolio-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.15s;
        }

        .portfolio-item:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow-sm);
        }

        .portfolio-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .portfolio-info {
            flex: 1;
        }

        .portfolio-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .portfolio-meta {
            font-size: 0.8125rem;
            color: var(--text-muted);
        }

        .portfolio-value {
            font-weight: 600;
            color: var(--success);
        }

        .portfolio-actions {
            display: flex;
            gap: 8px;
        }

        .portfolio-action-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 8px;
            border-radius: var(--radius-sm);
            transition: all 0.15s;
        }

        .portfolio-action-btn:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .portfolio-action-btn.delete:hover {
            background: rgba(255, 69, 58, 0.1);
            color: var(--danger);
        }

        /* Save Portfolio Modal */
        .save-modal .modal {
            max-width: 450px;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
        }

        .empty-state-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 16px;
            color: var(--text-muted);
        }

        /* Compare Tab */
        .compare-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }

        @media (max-width: 900px) {
            .compare-container {
                grid-template-columns: 1fr;
            }
        }

        .compare-selectors {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 16px;
            align-items: end;
            margin-bottom: 32px;
        }

        @media (max-width: 768px) {
            .compare-selectors {
                grid-template-columns: 1fr;
            }
        }

        .compare-select-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .compare-select-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .compare-select {
            padding: 12px 16px;
            font-size: 0.9375rem;
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            background: var(--bg-primary);
            color: var(--text-primary);
            cursor: pointer;
            font-family: inherit;
        }

        .compare-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 91, 255, 0.1);
        }

        .compare-vs {
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: var(--text-muted);
            padding-bottom: 12px;
        }

        .compare-column {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 24px;
        }

        .compare-column-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }

        .compare-column-title {
            font-size: 1.125rem;
            font-weight: 600;
        }

        .compare-column-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--success);
        }

        .compare-chart-wrapper {
            height: 200px;
            margin-bottom: 20px;
        }

        .compare-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .compare-stat {
            text-align: center;
            padding: 12px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
        }

        .compare-stat-value {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .compare-stat-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        /* Difference Summary */
        .diff-summary {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 24px;
            margin-top: 24px;
        }

        .diff-summary-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-secondary);
        }

        .diff-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
        }

        .diff-item {
            text-align: center;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
        }

        .diff-value {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .diff-value.positive {
            color: var(--success);
        }

        .diff-value.negative {
            color: var(--danger);
        }

        .diff-value.neutral {
            color: var(--text-muted);
        }

        .diff-label {
            font-size: 0.8125rem;
            color: var(--text-muted);
        }

        .compare-btn {
            margin-top: 16px;
        }

        /* What-If Tab */
        .whatif-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }

        @media (max-width: 900px) {
            .whatif-container {
                grid-template-columns: 1fr;
            }
        }

        .whatif-editor {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 24px;
        }

        .whatif-section-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .whatif-position-list {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .whatif-position {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            margin-bottom: 8px;
        }

        .whatif-position-symbol {
            font-weight: 600;
            min-width: 60px;
        }

        .whatif-position-shares {
            flex: 1;
        }

        .whatif-position-shares input {
            width: 80px;
            padding: 8px 12px;
            font-size: 0.875rem;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            background: var(--bg-primary);
            text-align: right;
            font-family: inherit;
        }

        .whatif-position-shares input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .whatif-position-value {
            min-width: 90px;
            text-align: right;
            font-weight: 500;
            color: var(--text-muted);
        }

        .whatif-position-remove {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 4px;
            border-radius: var(--radius-sm);
            transition: all 0.15s;
        }

        .whatif-position-remove:hover {
            background: rgba(255, 69, 58, 0.1);
            color: var(--danger);
        }

        .whatif-add-form {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr auto;
            gap: 12px;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            margin-bottom: 20px;
        }

        @media (max-width: 600px) {
            .whatif-add-form {
                grid-template-columns: 1fr 1fr;
            }
        }

        .whatif-add-form input {
            padding: 10px 12px;
            font-size: 0.875rem;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            background: var(--bg-primary);
            font-family: inherit;
        }

        .whatif-add-form input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .whatif-add-form button {
            padding: 10px 16px;
        }

        /* Rebalance Section */
        .rebalance-targets {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }

        @media (max-width: 600px) {
            .rebalance-targets {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .rebalance-target {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .rebalance-target label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .rebalance-target input {
            padding: 8px 12px;
            font-size: 0.875rem;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            background: var(--bg-primary);
            text-align: center;
            font-family: inherit;
        }

        .rebalance-target input:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* What-If Preview */
        .whatif-preview {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 24px;
        }

        .whatif-preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .whatif-preview-title {
            font-size: 1rem;
            font-weight: 600;
        }

        .whatif-preview-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--success);
        }

        .whatif-impact-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .whatif-impact-card {
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            text-align: center;
        }

        .whatif-impact-value {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .whatif-impact-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .whatif-chart-wrapper {
            height: 180px;
            margin-bottom: 16px;
        }

        .whatif-actions {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        /* Plaid Integration */
        .plaid-section {
            margin-top: 32px;
            padding-top: 32px;
            border-top: 1px solid var(--border);
        }

        .plaid-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .plaid-header h3 {
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .plaid-connections {
            display: grid;
            gap: 12px;
        }

        .plaid-connection {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
        }

        .plaid-connection-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #00d4aa 0%, #00a884 100%);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .plaid-connection-info {
            flex: 1;
        }

        .plaid-connection-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .plaid-connection-meta {
            font-size: 0.8125rem;
            color: var(--text-muted);
        }

        .plaid-connection-actions {
            display: flex;
            gap: 8px;
        }

        .plaid-unavailable {
            text-align: center;
            padding: 32px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            color: var(--text-muted);
        }

        .plaid-unavailable svg {
            width: 48px;
            height: 48px;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        /* Benchmark Toggles */
        .benchmark-toggle {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.8125rem;
            cursor: pointer;
            padding: 6px 12px;
            background: var(--bg-secondary);
            border-radius: var(--radius-sm);
            transition: all 0.15s;
        }

        .benchmark-toggle:hover {
            background: var(--bg-tertiary);
        }

        .benchmark-toggle input {
            display: none;
        }

        .benchmark-label-box {
            width: 12px;
            height: 12px;
            border-radius: 2px;
            opacity: 0.4;
            transition: opacity 0.15s;
        }

        .benchmark-toggle input:checked + .benchmark-label-box {
            opacity: 1;
        }

        /* Projections */
        .projection-stat {
            text-align: center;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
        }

        .projection-stat-value {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .projection-stat-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .monte-carlo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .monte-carlo-item {
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
        }

        .monte-carlo-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .monte-carlo-value {
            font-size: 1.125rem;
            font-weight: 600;
        }

        .monte-carlo-value.positive { color: var(--success); }
        .monte-carlo-value.highlight { color: var(--primary); }

        /* Toast Notifications */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            padding: 16px 24px;
            border-radius: var(--radius-md);
            color: white;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: var(--shadow-lg);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 2000;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast.success {
            background: var(--success);
        }

        .toast.error {
            background: var(--danger);
        }

        .toast svg {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div style="position: absolute; top: 24px; right: 24px;">
                <div id="authSection">
                    <!-- Shows login button or user menu -->
                    <button class="btn btn-secondary" id="loginBtn" onclick="showAuthModal()">
                        Sign In
                    </button>
                </div>
            </div>
            <div class="logo">
                <div class="logo-icon">
                    <!-- Paul Rand-inspired logo: Bold geometric "S" with scan line -->
                    <svg viewBox="0 0 44 44" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <!-- Abstract S formed by two offset squares with negative space -->
                        <rect x="0" y="0" width="24" height="24" rx="4" fill="white"/>
                        <rect x="20" y="20" width="24" height="24" rx="4" fill="white"/>
                        <!-- Scan line cutting through - the key action element -->
                        <rect x="0" y="19" width="44" height="6" fill="white" opacity="0.4"/>
                        <!-- Central diamond connector -->
                        <rect x="16" y="16" width="12" height="12" rx="2" fill="white" transform="rotate(0 22 22)"/>
                    </svg>
                </div>
                <div class="brand-text">
                    <span class="brand-name">Statement Scan</span>
                    <span class="brand-tagline">Portfolio Intelligence</span>
                </div>
            </div>
            <p class="subtitle">Upload your brokerage statements and get instant portfolio analytics, benchmarking, and projections.</p>
        </header>

        <div class="error-message" id="errorMessage"></div>

        <!-- Upload Section -->
        <div id="uploadSection">
            <!-- Entry Method Selector -->
            <div class="entry-methods">
                <button class="entry-method-btn active" data-method="upload" onclick="switchEntryMethod('upload')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="17 8 12 3 7 8"/>
                        <line x1="12" y1="3" x2="12" y2="15"/>
                    </svg>
                    Upload Files
                </button>
                <button class="entry-method-btn" data-method="manual" onclick="switchEntryMethod('manual')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                    </svg>
                    Enter Manually
                </button>
                <button class="entry-method-btn" data-method="connect" onclick="switchEntryMethod('connect')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="2" y="4" width="20" height="16" rx="2"/>
                        <path d="M7 15h0M2 9h20"/>
                    </svg>
                    Connect Account
                </button>
            </div>

            <!-- Upload Panel -->
            <div class="entry-panel active" id="uploadPanel">
                <div class="card upload-card" id="dropZone">
                    <div class="upload-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="17 8 12 3 7 8"/>
                            <line x1="12" y1="3" x2="12" y2="15"/>
                        </svg>
                    </div>
                    <div class="upload-title">Upload brokerage statements</div>
                    <p class="upload-hint">Drag and drop multiple PDF or CSV files at once, or click to browse</p>
                    <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                        Select Files
                    </button>
                    <input type="file" id="fileInput" accept=".pdf,.csv" multiple>

                    <!-- Upload Queue (shown during batch upload) -->
                    <div class="upload-queue" id="uploadQueue" style="display: none;">
                        <div class="upload-queue-header">
                            <span id="uploadQueueTitle">Uploading files...</span>
                            <span id="uploadQueueCount"></span>
                        </div>
                        <div id="uploadQueueList"></div>
                    </div>
                </div>
            </div>

            <!-- Manual Entry Panel -->
            <div class="entry-panel" id="manualPanel">
                <div class="card manual-entry-card">
                    <div class="upload-title" style="text-align: center; margin-bottom: 8px;">Enter your holdings</div>
                    <p class="upload-hint" style="text-align: center; margin-bottom: 24px;">Add each position with its symbol, shares, and price per share</p>

                    <div class="manual-entry-form">
                        <div class="form-group" style="flex: 1.5;">
                            <label>Symbol</label>
                            <input type="text" id="manualSymbol" placeholder="e.g., AAPL" onkeypress="if(event.key==='Enter') addManualHolding()">
                        </div>
                        <div class="form-group">
                            <label>Shares</label>
                            <input type="number" id="manualShares" placeholder="100" step="any" onkeypress="if(event.key==='Enter') addManualHolding()">
                        </div>
                        <div class="form-group">
                            <label>Price</label>
                            <input type="number" id="manualPrice" placeholder="150.00" step="0.01" onkeypress="if(event.key==='Enter') addManualHolding()">
                        </div>
                        <button class="btn btn-primary btn-add" onclick="addManualHolding()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="5" x2="12" y2="19"/>
                                <line x1="5" y1="12" x2="19" y2="12"/>
                            </svg>
                            Add
                        </button>
                    </div>

                    <div class="holdings-list" id="manualHoldingsList">
                        <div class="holdings-list-header">
                            <span>Symbol</span>
                            <span>Shares</span>
                            <span>Price</span>
                            <span>Value</span>
                            <span></span>
                        </div>
                        <div class="holdings-list-empty" id="holdingsEmpty">
                            No holdings added yet. Enter a symbol above to get started.
                        </div>
                    </div>

                    <div class="manual-entry-actions">
                        <div class="manual-total">
                            Total: <strong id="manualTotal">$0.00</strong>
                        </div>
                        <div style="display: flex; gap: 12px;">
                            <button class="btn btn-secondary" onclick="clearManualHoldings()">Clear All</button>
                            <button class="btn btn-primary" id="analyzeManualBtn" onclick="analyzeManualHoldings()" disabled>
                                Analyze Portfolio
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Connect Account Panel -->
            <div class="entry-panel" id="connectPanel">
                <div class="card upload-card">
                    <div class="upload-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="2" y="4" width="20" height="16" rx="2"/>
                            <path d="M7 15h0M2 9h20"/>
                        </svg>
                    </div>
                    <div class="upload-title">Connect your brokerage</div>
                    <p class="upload-hint">Securely link your account to automatically import holdings</p>
                    <button class="btn btn-primary" onclick="connectPlaidAccount()">
                        Connect with Plaid
                    </button>
                </div>
            </div>

            <div class="accounts-section" id="accountsSection" style="display: none;">
                <div class="accounts-header">
                    <h3>Uploaded Accounts</h3>
                    <button class="btn btn-secondary" id="addMoreBtn">Add More</button>
                </div>
                <div id="accountsList"></div>
                <div class="actions-row">
                    <button class="btn btn-primary" id="analyzeBtn" disabled>Analyze Portfolio</button>
                    <button class="btn btn-secondary" id="clearAllBtn">Clear All</button>
                </div>
            </div>

            <!-- Plaid Integration Section -->
            <div class="plaid-section" id="plaidSection" style="display: none;">
                <div class="plaid-header">
                    <h3>
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="2" y="4" width="20" height="16" rx="2"/>
                            <path d="M7 15h0M2 9h20"/>
                        </svg>
                        Connected Accounts
                    </h3>
                    <button class="btn btn-primary" onclick="connectPlaidAccount()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <line x1="12" y1="8" x2="12" y2="16"/>
                            <line x1="8" y1="12" x2="16" y2="12"/>
                        </svg>
                        Connect Account
                    </button>
                </div>
                <div class="plaid-connections" id="plaidConnections">
                    <!-- Populated dynamically -->
                </div>
            </div>
        </div>

        <!-- Progress -->
        <div class="progress-section" id="progressSection">
            <div class="spinner"></div>
            <p class="progress-text" id="progressText">Analyzing your portfolio...</p>
        </div>

        <!-- Dashboard -->
        <div class="dashboard" id="dashboard">
            <div class="dashboard-header">
                <div class="dashboard-title">
                    <div class="dashboard-logo">
                        <svg viewBox="0 0 44 44" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <rect x="0" y="0" width="24" height="24" rx="4" fill="white"/>
                            <rect x="20" y="20" width="24" height="24" rx="4" fill="white"/>
                            <rect x="0" y="19" width="44" height="6" fill="white" opacity="0.4"/>
                            <rect x="16" y="16" width="12" height="12" rx="2" fill="white"/>
                        </svg>
                    </div>
                    <h2>Portfolio Analysis</h2>
                    <span class="total-badge" id="totalBadge">$0</span>
                </div>
                <div class="header-actions">
                    <button class="btn btn-secondary" id="newAnalysisBtn">New Analysis</button>
                    <button class="btn btn-success" id="savePortfolioBtn" style="display: none;">Save Portfolio</button>
                    <button class="btn btn-primary" id="downloadBtn">Download CSV</button>
                </div>
            </div>

            <div class="tabs">
                <button class="tab active" data-tab="allocation">Allocation</button>
                <button class="tab" data-tab="performance">Performance</button>
                <button class="tab" data-tab="sectors">Sectors</button>
                <button class="tab" data-tab="geography">Geography</button>
                <button class="tab" data-tab="risk">Risk</button>
                <button class="tab" data-tab="holdings">Holdings</button>
                <button class="tab" data-tab="whatif">What-If</button>
                <button class="tab" data-tab="compare">Compare</button>
            </div>

            <!-- Allocation Tab -->
            <div class="tab-content active" id="tab-allocation">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Stocks</div>
                        <div class="stat-value" id="stocksPct">0%</div>
                        <div class="stat-subtitle" id="stocksVal">$0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Bonds</div>
                        <div class="stat-value" id="bondsPct">0%</div>
                        <div class="stat-subtitle" id="bondsVal">$0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Cash</div>
                        <div class="stat-value" id="cashPct">0%</div>
                        <div class="stat-subtitle" id="cashVal">$0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Alternatives</div>
                        <div class="stat-value" id="altsPct">0%</div>
                        <div class="stat-subtitle" id="altsVal">$0</div>
                    </div>
                </div>
                <div class="charts-row">
                    <div class="card chart-card">
                        <div class="card-title">Asset Allocation</div>
                        <div class="chart-wrapper">
                            <canvas id="allocationChart"></canvas>
                        </div>
                    </div>
                    <div class="card chart-card">
                        <div class="card-title">Sub-Asset Breakdown</div>
                        <div class="chart-wrapper">
                            <canvas id="subClassChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Performance Tab -->
            <div class="tab-content" id="tab-performance">
                <div class="returns-grid" id="returnsGrid"></div>
                <div class="card chart-card">
                    <div class="card-header">
                        <div class="card-title">Historical Performance</div>
                        <div class="period-selector" id="periodSelector">
                            <button class="period-btn" data-period="1M">1M</button>
                            <button class="period-btn" data-period="3M">3M</button>
                            <button class="period-btn" data-period="6M">6M</button>
                            <button class="period-btn" data-period="YTD">YTD</button>
                            <button class="period-btn" data-period="1Y">1Y</button>
                            <button class="period-btn" data-period="3Y">3Y</button>
                            <button class="period-btn active" data-period="5Y">5Y</button>
                        </div>
                    </div>
                    <div style="display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap;">
                        <label class="benchmark-toggle">
                            <input type="checkbox" checked onchange="toggleBenchmark('sp500', this.checked)">
                            <span class="benchmark-label-box" style="background: #8898aa;"></span>
                            S&P 500
                        </label>
                        <label class="benchmark-toggle">
                            <input type="checkbox" onchange="toggleBenchmark('bonds', this.checked)">
                            <span class="benchmark-label-box" style="background: #30d158;"></span>
                            US Bonds
                        </label>
                        <label class="benchmark-toggle">
                            <input type="checkbox" onchange="toggleBenchmark('world', this.checked)">
                            <span class="benchmark-label-box" style="background: #ff9f0a;"></span>
                            Total World
                        </label>
                        <label class="benchmark-toggle">
                            <input type="checkbox" onchange="toggleBenchmark('sixty_forty', this.checked)">
                            <span class="benchmark-label-box" style="background: #bf5af2;"></span>
                            60/40 Portfolio
                        </label>
                    </div>
                    <div class="chart-wrapper" style="height: 380px;">
                        <canvas id="performanceChart"></canvas>
                    </div>
                </div>

                <!-- Projections Section -->
                <div class="card chart-card" style="margin-top: 24px;">
                    <div class="card-header">
                        <div class="card-title">10-Year Projections (Monte Carlo Simulation)</div>
                    </div>
                    <div id="projectionsInfo" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-bottom: 20px;"></div>
                    <div class="chart-wrapper" style="height: 350px;">
                        <canvas id="projectionsChart"></canvas>
                    </div>
                    <div id="monteCarloSummary" style="margin-top: 20px;"></div>
                </div>
            </div>

            <!-- Sectors Tab -->
            <div class="tab-content" id="tab-sectors">
                <div class="card" style="margin-bottom: 24px;">
                    <div class="card-header">
                        <div class="card-title">Sector Exposure vs S&P 500 Benchmark</div>
                        <div style="display: flex; gap: 16px; font-size: 0.8125rem;">
                            <span><span style="display: inline-block; width: 12px; height: 12px; background: var(--primary); border-radius: 2px; margin-right: 6px;"></span>Portfolio</span>
                            <span><span style="display: inline-block; width: 12px; height: 12px; background: var(--bg-tertiary); border-radius: 2px; margin-right: 6px;"></span>S&P 500</span>
                        </div>
                    </div>
                    <div class="sector-list" id="sectorList"></div>
                </div>
                <div class="card chart-card">
                    <div class="card-title">Sector Distribution</div>
                    <div class="chart-wrapper">
                        <canvas id="sectorChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Geography Tab -->
            <div class="tab-content" id="tab-geography">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">United States</div>
                        <div class="stat-value" id="usPct">0%</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Developed Markets</div>
                        <div class="stat-value" id="devPct">0%</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Emerging Markets</div>
                        <div class="stat-value" id="emPct">0%</div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-title">Geographic Allocation</div>
                    <div class="map-container">
                        <div id="worldMapContainer"></div>
                        <div class="map-legend">
                            <div class="legend-item"><div class="legend-dot us"></div><span>United States <strong id="usMapPct">0%</strong></span></div>
                            <div class="legend-item"><div class="legend-dot developed"></div><span>Developed <strong id="devMapPct">0%</strong></span></div>
                            <div class="legend-item"><div class="legend-dot emerging"></div><span>Emerging <strong id="emMapPct">0%</strong></span></div>
                        </div>
                    </div>
                </div>
                <div class="card chart-card" style="margin-top: 24px;">
                    <div class="card-title">Regional Breakdown</div>
                    <div class="chart-wrapper">
                        <canvas id="geoChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Risk Tab -->
            <div class="tab-content" id="tab-risk">
                <div class="risk-grid">
                    <div class="card risk-card">
                        <div class="risk-value" id="volatilityVal">--</div>
                        <div class="risk-label">Volatility</div>
                        <div class="risk-desc">Annualized standard deviation</div>
                    </div>
                    <div class="card risk-card">
                        <div class="risk-value" id="betaVal">--</div>
                        <div class="risk-label">Beta</div>
                        <div class="risk-desc">Sensitivity to market</div>
                    </div>
                    <div class="card risk-card">
                        <div class="risk-value" id="sharpeVal">--</div>
                        <div class="risk-label">Sharpe Ratio</div>
                        <div class="risk-desc">Risk-adjusted return</div>
                    </div>
                    <div class="card risk-card">
                        <div class="risk-value negative" id="maxDdVal">--</div>
                        <div class="risk-label">Max Drawdown</div>
                        <div class="risk-desc">Largest peak-to-trough</div>
                    </div>
                </div>

                <div class="card" style="margin-bottom: 24px;">
                    <div class="card-header">
                        <div class="card-title">Concentration Risk</div>
                    </div>
                    <div class="stats-grid" style="margin-bottom: 20px;">
                        <div class="stat-card">
                            <div class="stat-label">Top 10 Holdings</div>
                            <div class="stat-value" id="top10Pct">0%</div>
                            <div class="stat-subtitle">of total portfolio</div>
                        </div>
                    </div>
                    <div class="holdings-list" id="topHoldingsList"></div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Scenario Analysis</div>
                    </div>
                    <p style="color: var(--text-muted); font-size: 0.875rem; margin-bottom: 20px;">
                        Estimated portfolio impact under various market conditions
                    </p>
                    <div class="scenarios-container" id="scenariosList"></div>
                </div>
            </div>

            <!-- Holdings Tab -->
            <div class="tab-content" id="tab-holdings">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Symbol</th>
                                <th>Description</th>
                                <th>Asset Class</th>
                                <th>Sector</th>
                                <th class="text-right">Shares</th>
                                <th class="text-right">Price</th>
                                <th class="text-right">Value</th>
                                <th class="text-right">Weight</th>
                            </tr>
                        </thead>
                        <tbody id="holdingsBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- What-If Tab -->
            <div class="tab-content" id="tab-whatif">
                <div class="whatif-container">
                    <div class="whatif-editor">
                        <div class="whatif-section-title">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                            </svg>
                            Edit Positions
                        </div>

                        <div class="whatif-position-list" id="whatifPositionList">
                            <!-- Populated dynamically -->
                        </div>

                        <div class="whatif-section-title" style="margin-top: 24px;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <line x1="12" y1="8" x2="12" y2="16"/>
                                <line x1="8" y1="12" x2="16" y2="12"/>
                            </svg>
                            Add Position
                        </div>

                        <div class="whatif-add-form">
                            <input type="text" id="whatifAddSymbol" placeholder="Symbol" style="text-transform: uppercase;">
                            <input type="number" id="whatifAddShares" placeholder="Shares" min="0" step="0.0001">
                            <input type="number" id="whatifAddPrice" placeholder="Price" min="0" step="0.01">
                            <button class="btn btn-primary" onclick="addWhatIfPosition()">Add</button>
                        </div>

                        <div class="whatif-section-title" style="margin-top: 24px;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0z"/>
                                <path d="M9 12h6"/>
                            </svg>
                            Rebalance to Target
                        </div>

                        <div class="rebalance-targets">
                            <div class="rebalance-target">
                                <label>Stocks %</label>
                                <input type="number" id="rebalanceStocks" placeholder="60" min="0" max="100">
                            </div>
                            <div class="rebalance-target">
                                <label>Bonds %</label>
                                <input type="number" id="rebalanceBonds" placeholder="30" min="0" max="100">
                            </div>
                            <div class="rebalance-target">
                                <label>Cash %</label>
                                <input type="number" id="rebalanceCash" placeholder="10" min="0" max="100">
                            </div>
                        </div>
                        <button class="btn btn-secondary" onclick="applyRebalance()">Apply Rebalance</button>
                    </div>

                    <div class="whatif-preview">
                        <div class="whatif-preview-header">
                            <div class="whatif-preview-title">Preview</div>
                            <div class="whatif-preview-value" id="whatifPreviewValue">$0</div>
                        </div>

                        <div class="whatif-impact-grid" id="whatifImpactGrid">
                            <div class="whatif-impact-card">
                                <div class="whatif-impact-value" id="whatifValueChange">--</div>
                                <div class="whatif-impact-label">Value Change</div>
                            </div>
                            <div class="whatif-impact-card">
                                <div class="whatif-impact-value" id="whatifCost">--</div>
                                <div class="whatif-impact-label">Est. Trade Cost</div>
                            </div>
                            <div class="whatif-impact-card">
                                <div class="whatif-impact-value" id="whatifVolChange">--</div>
                                <div class="whatif-impact-label">Volatility Change</div>
                            </div>
                            <div class="whatif-impact-card">
                                <div class="whatif-impact-value" id="whatifBetaChange">--</div>
                                <div class="whatif-impact-label">Beta Change</div>
                            </div>
                        </div>

                        <div class="whatif-chart-wrapper">
                            <canvas id="whatifChart"></canvas>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 16px;">
                            <div>
                                <div class="stat-label">Original Allocation</div>
                                <div id="whatifOriginalAlloc" style="font-size: 0.875rem; color: var(--text-secondary);"></div>
                            </div>
                            <div>
                                <div class="stat-label">Modified Allocation</div>
                                <div id="whatifModifiedAlloc" style="font-size: 0.875rem; color: var(--text-secondary);"></div>
                            </div>
                        </div>

                        <div class="whatif-actions">
                            <button class="btn btn-secondary" onclick="resetWhatIf()">Reset Changes</button>
                            <button class="btn btn-primary" onclick="runWhatIfAnalysis()">Run Analysis</button>
                            <button class="btn btn-success" onclick="saveWhatIfAsNew()" style="display: none;" id="saveWhatIfBtn">Save as New</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Compare Tab -->
            <div class="tab-content" id="tab-compare">
                <div class="compare-selectors">
                    <div class="compare-select-group">
                        <label class="compare-select-label">Portfolio A</label>
                        <select class="compare-select" id="compareSelectA">
                            <option value="current">Current Analysis</option>
                        </select>
                    </div>
                    <div class="compare-vs">VS</div>
                    <div class="compare-select-group">
                        <label class="compare-select-label">Portfolio B</label>
                        <select class="compare-select" id="compareSelectB">
                            <option value="">Select a portfolio...</option>
                        </select>
                    </div>
                </div>

                <button class="btn btn-primary compare-btn" onclick="runComparison()" id="runCompareBtn">
                    Compare Portfolios
                </button>

                <div id="comparisonResults" style="display: none;">
                    <div class="compare-container" style="margin-top: 32px;">
                        <div class="compare-column">
                            <div class="compare-column-header">
                                <div class="compare-column-title" id="compareNameA">Portfolio A</div>
                                <div class="compare-column-value" id="compareValueA">$0</div>
                            </div>
                            <div class="compare-chart-wrapper">
                                <canvas id="compareChartA"></canvas>
                            </div>
                            <div class="compare-stats" id="compareStatsA"></div>
                        </div>

                        <div class="compare-column">
                            <div class="compare-column-header">
                                <div class="compare-column-title" id="compareNameB">Portfolio B</div>
                                <div class="compare-column-value" id="compareValueB">$0</div>
                            </div>
                            <div class="compare-chart-wrapper">
                                <canvas id="compareChartB"></canvas>
                            </div>
                            <div class="compare-stats" id="compareStatsB"></div>
                        </div>
                    </div>

                    <div class="diff-summary">
                        <div class="diff-summary-title">Difference Summary (B - A)</div>
                        <div class="diff-grid" id="diffGrid"></div>
                    </div>
                </div>

                <div id="compareEmptyState" class="empty-state">
                    <svg class="empty-state-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <rect x="2" y="3" width="8" height="18" rx="1"/>
                        <rect x="14" y="3" width="8" height="18" rx="1"/>
                        <path d="M10 12h4"/>
                    </svg>
                    <p>Select two portfolios to compare</p>
                    <p style="font-size: 0.8125rem;">Save portfolios to unlock comparison features</p>
                </div>
            </div>
        </div>

        <!-- Saved Portfolios Section (visible when logged in) -->
        <div class="saved-portfolios" id="savedPortfoliosSection" style="display: none;">
            <div class="saved-portfolios-header">
                <h3>Saved Portfolios</h3>
                <button class="btn btn-secondary" onclick="loadSavedPortfolios()">Refresh</button>
            </div>
            <div class="portfolio-list" id="portfolioList">
                <!-- Populated dynamically -->
            </div>
        </div>

        <footer>
            <p>Supports Schwab, Fidelity, Vanguard, and most major brokerage statements</p>
        </footer>
    </div>

    <!-- Auth Modal -->
    <div class="modal-overlay" id="authModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Welcome</h2>
                <button class="modal-close" onclick="hideAuthModal()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="auth-tabs">
                    <button class="auth-tab active" data-tab="login" onclick="switchAuthTab('login')">Sign In</button>
                    <button class="auth-tab" data-tab="register" onclick="switchAuthTab('register')">Create Account</button>
                </div>

                <!-- Login Form -->
                <form class="auth-form active" id="loginForm" onsubmit="handleLogin(event)">
                    <div class="form-group">
                        <label class="form-label" for="loginEmail">Email</label>
                        <input type="email" class="form-input" id="loginEmail" placeholder="you@example.com" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="loginPassword">Password</label>
                        <input type="password" class="form-input" id="loginPassword" placeholder="Enter your password" required>
                    </div>
                    <div class="form-error" id="loginError" style="display: none;"></div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">Sign In</button>
                </form>

                <!-- Register Form -->
                <form class="auth-form" id="registerForm" onsubmit="handleRegister(event)">
                    <div class="form-group">
                        <label class="form-label" for="registerName">Name (optional)</label>
                        <input type="text" class="form-input" id="registerName" placeholder="Your name">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="registerEmail">Email</label>
                        <input type="email" class="form-input" id="registerEmail" placeholder="you@example.com" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="registerPassword">Password</label>
                        <input type="password" class="form-input" id="registerPassword" placeholder="At least 8 characters" minlength="8" required>
                    </div>
                    <div class="form-error" id="registerError" style="display: none;"></div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">Create Account</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
            <polyline points="22 4 12 14.01 9 11.01"/>
        </svg>
        <span id="toastMessage">Success!</span>
    </div>

    <!-- Save Portfolio Modal -->
    <div class="modal-overlay save-modal" id="saveModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Save Portfolio</h2>
                <button class="modal-close" onclick="hideSaveModal()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <form id="saveForm" onsubmit="handleSavePortfolio(event)">
                    <div class="form-group">
                        <label class="form-label" for="portfolioName">Portfolio Name</label>
                        <input type="text" class="form-input" id="portfolioName" placeholder="e.g., Retirement Account" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="portfolioDescription">Description (optional)</label>
                        <input type="text" class="form-input" id="portfolioDescription" placeholder="Brief description">
                    </div>
                    <div class="form-error" id="saveError" style="display: none;"></div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">Save Portfolio</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'https://statement-parser-backend-yg0a.onrender.com';

        let accounts = [];
        let portfolioData = null;
        let charts = {};
        let currentUser = null;
        let authToken = localStorage.getItem('authToken');

        // =============================================================================
        // AUTHENTICATION
        // =============================================================================

        function showAuthModal() {
            document.getElementById('authModal').classList.add('active');
        }

        function hideAuthModal() {
            document.getElementById('authModal').classList.remove('active');
            document.getElementById('loginError').style.display = 'none';
            document.getElementById('registerError').style.display = 'none';
        }

        function switchAuthTab(tab) {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
            document.querySelector(`.auth-tab[data-tab="${tab}"]`).classList.add('active');
            document.getElementById(tab === 'login' ? 'loginForm' : 'registerForm').classList.add('active');
        }

        async function handleLogin(event) {
            event.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const errorEl = document.getElementById('loginError');

            try {
                const res = await fetch(`${API_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await res.json();

                if (!res.ok) {
                    errorEl.textContent = data.error || 'Login failed';
                    errorEl.style.display = 'block';
                    return;
                }

                authToken = data.access_token;
                currentUser = data.user;
                localStorage.setItem('authToken', authToken);
                hideAuthModal();
                updateAuthUI();
                loadSavedPortfolios();
            } catch (err) {
                errorEl.textContent = 'Connection error. Please try again.';
                errorEl.style.display = 'block';
            }
        }

        async function handleRegister(event) {
            event.preventDefault();
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const errorEl = document.getElementById('registerError');

            try {
                const res = await fetch(`${API_URL}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, email, password })
                });

                const data = await res.json();

                if (!res.ok) {
                    errorEl.textContent = data.error || 'Registration failed';
                    errorEl.style.display = 'block';
                    return;
                }

                authToken = data.access_token;
                currentUser = data.user;
                localStorage.setItem('authToken', authToken);
                hideAuthModal();
                updateAuthUI();
                loadSavedPortfolios();
            } catch (err) {
                errorEl.textContent = 'Connection error. Please try again.';
                errorEl.style.display = 'block';
            }
        }

        function logout() {
            authToken = null;
            currentUser = null;
            localStorage.removeItem('authToken');
            updateAuthUI();
            document.getElementById('savedPortfoliosSection').style.display = 'none';
        }

        function updateAuthUI() {
            const authSection = document.getElementById('authSection');
            const saveBtn = document.getElementById('savePortfolioBtn');

            if (currentUser) {
                const initials = (currentUser.name || currentUser.email || 'U').substring(0, 2).toUpperCase();
                authSection.innerHTML = `
                    <div class="user-menu">
                        <button class="user-btn" onclick="toggleUserDropdown()">
                            <div class="user-avatar">${initials}</div>
                            <span>${currentUser.name || currentUser.email}</span>
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="6 9 12 15 18 9"/>
                            </svg>
                        </button>
                        <div class="user-dropdown" id="userDropdown">
                            <div class="dropdown-item" style="color: var(--text-muted); pointer-events: none;">
                                ${currentUser.email}
                            </div>
                            <div class="dropdown-divider"></div>
                            <button class="dropdown-item" onclick="loadSavedPortfolios(); toggleUserDropdown();">
                                My Portfolios
                            </button>
                            <div class="dropdown-divider"></div>
                            <button class="dropdown-item" onclick="logout()">Sign Out</button>
                        </div>
                    </div>
                `;
                saveBtn.style.display = 'inline-flex';
                document.getElementById('savedPortfoliosSection').style.display = 'block';
                updatePlaidUI();
            } else {
                authSection.innerHTML = `
                    <button class="btn btn-secondary" onclick="showAuthModal()">Sign In</button>
                `;
                saveBtn.style.display = 'none';
                document.getElementById('savedPortfoliosSection').style.display = 'none';
                document.getElementById('plaidSection').style.display = 'none';
            }
        }

        function toggleUserDropdown() {
            const dropdown = document.getElementById('userDropdown');
            dropdown.classList.toggle('active');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            const dropdown = document.getElementById('userDropdown');
            const userBtn = e.target.closest('.user-btn');
            if (!userBtn && dropdown) {
                dropdown.classList.remove('active');
            }
        });

        // Check auth on page load
        async function checkAuth() {
            if (!authToken) return;

            try {
                const res = await fetch(`${API_URL}/auth/me`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (res.ok) {
                    const data = await res.json();
                    currentUser = data.user;
                    updateAuthUI();
                    loadSavedPortfolios();
                } else {
                    logout();
                }
            } catch (err) {
                // API might not be available yet, keep token
            }
        }

        // =============================================================================
        // PORTFOLIO SAVING
        // =============================================================================

        function showSaveModal() {
            if (!currentUser) {
                showAuthModal();
                return;
            }
            document.getElementById('saveModal').classList.add('active');
        }

        function hideSaveModal() {
            document.getElementById('saveModal').classList.remove('active');
            document.getElementById('saveError').style.display = 'none';
            document.getElementById('saveForm').reset();
        }

        async function handleSavePortfolio(event) {
            event.preventDefault();

            if (!portfolioData || !portfolioData.positions) {
                return;
            }

            const name = document.getElementById('portfolioName').value;
            const description = document.getElementById('portfolioDescription').value;
            const errorEl = document.getElementById('saveError');

            try {
                const res = await fetch(`${API_URL}/portfolios`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        name,
                        description,
                        positions: portfolioData.positions
                    })
                });

                const data = await res.json();

                if (!res.ok) {
                    errorEl.textContent = data.error || 'Failed to save portfolio';
                    errorEl.style.display = 'block';
                    return;
                }

                hideSaveModal();
                showToast('Portfolio saved successfully!');
                loadSavedPortfolios();
            } catch (err) {
                errorEl.textContent = 'Connection error. Please try again.';
                errorEl.style.display = 'block';
            }
        }

        async function loadSavedPortfolios() {
            if (!authToken) return;

            const listEl = document.getElementById('portfolioList');

            try {
                const res = await fetch(`${API_URL}/portfolios`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (!res.ok) {
                    listEl.innerHTML = '<div class="empty-state">Failed to load portfolios</div>';
                    return;
                }

                const data = await res.json();
                const portfolios = data.portfolios || [];

                if (portfolios.length === 0) {
                    listEl.innerHTML = `
                        <div class="empty-state">
                            <svg class="empty-state-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <rect x="2" y="3" width="20" height="18" rx="2"/>
                                <path d="M12 8v8M8 12h8"/>
                            </svg>
                            <p>No saved portfolios yet</p>
                            <p style="font-size: 0.8125rem;">Upload statements and save your analysis</p>
                        </div>
                    `;
                    return;
                }

                listEl.innerHTML = portfolios.map(p => `
                    <div class="portfolio-item" onclick="loadPortfolio(${p.id})">
                        <div class="portfolio-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                            </svg>
                        </div>
                        <div class="portfolio-info">
                            <div class="portfolio-name">${escapeHtml(p.name)}</div>
                            <div class="portfolio-meta">
                                ${p.positions?.length || 0} positions
                                ${p.description ? ' - ' + escapeHtml(p.description) : ''}
                            </div>
                        </div>
                        <div class="portfolio-value">${formatCurrency(p.total_value)}</div>
                        <div class="portfolio-actions" onclick="event.stopPropagation()">
                            <button class="portfolio-action-btn delete" onclick="deletePortfolio(${p.id})" title="Delete">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="3 6 5 6 21 6"/>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                `).join('');

            } catch (err) {
                listEl.innerHTML = '<div class="empty-state">Failed to load portfolios</div>';
            }
        }

        async function loadPortfolio(portfolioId) {
            if (!authToken) return;

            showProgress('Loading portfolio...');

            try {
                const res = await fetch(`${API_URL}/portfolios/${portfolioId}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (!res.ok) {
                    hideProgress();
                    showError('Failed to load portfolio');
                    return;
                }

                const data = await res.json();
                const portfolio = data.portfolio;

                // Create a fake account for the loaded portfolio
                accounts = [{
                    id: Date.now(),
                    name: portfolio.name,
                    positions: portfolio.positions,
                    brokerage: 'saved',
                    totalValue: portfolio.total_value
                }];

                // Analyze the portfolio
                await analyzePortfolio();

            } catch (err) {
                hideProgress();
                showError('Failed to load portfolio: ' + err.message);
            }
        }

        async function deletePortfolio(portfolioId) {
            if (!confirm('Are you sure you want to delete this portfolio?')) {
                return;
            }

            try {
                const res = await fetch(`${API_URL}/portfolios/${portfolioId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (!res.ok) {
                    const data = await res.json();
                    showError(data.error || 'Failed to delete portfolio');
                    return;
                }

                loadSavedPortfolios();
            } catch (err) {
                showError('Failed to delete portfolio');
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');

            toastMessage.textContent = message;
            toast.className = 'toast ' + type;
            toast.classList.add('show');

            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // =============================================================================
        // PORTFOLIO COMPARISON
        // =============================================================================

        let compareCharts = {};

        function updateCompareSelectors() {
            const selectA = document.getElementById('compareSelectA');
            const selectB = document.getElementById('compareSelectB');

            // Build options
            let options = '';

            // Add current analysis if available
            if (portfolioData && portfolioData.positions) {
                options += '<option value="current">Current Analysis</option>';
            }

            // Fetch saved portfolios for options
            if (authToken) {
                fetch(`${API_URL}/portfolios`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                })
                .then(res => res.json())
                .then(data => {
                    const portfolios = data.portfolios || [];
                    portfolios.forEach(p => {
                        options += `<option value="${p.id}">${escapeHtml(p.name)} (${formatCurrency(p.total_value)})</option>`;
                    });

                    // Update select A
                    selectA.innerHTML = portfolioData ? '<option value="current">Current Analysis</option>' : '';
                    selectA.innerHTML += portfolios.map(p =>
                        `<option value="${p.id}">${escapeHtml(p.name)} (${formatCurrency(p.total_value)})</option>`
                    ).join('');

                    // Update select B
                    selectB.innerHTML = '<option value="">Select a portfolio...</option>';
                    if (portfolioData) {
                        selectB.innerHTML += '<option value="current">Current Analysis</option>';
                    }
                    selectB.innerHTML += portfolios.map(p =>
                        `<option value="${p.id}">${escapeHtml(p.name)} (${formatCurrency(p.total_value)})</option>`
                    ).join('');
                })
                .catch(() => {});
            } else {
                selectA.innerHTML = portfolioData ? '<option value="current">Current Analysis</option>' : '<option value="">No portfolios available</option>';
                selectB.innerHTML = '<option value="">Sign in to compare saved portfolios</option>';
            }
        }

        async function runComparison() {
            const selectA = document.getElementById('compareSelectA').value;
            const selectB = document.getElementById('compareSelectB').value;

            if (!selectA || !selectB) {
                showError('Please select two portfolios to compare');
                return;
            }

            if (selectA === selectB) {
                showError('Please select two different portfolios');
                return;
            }

            // Build request body
            const body = {
                portfolio_a: selectA === 'current' ? { positions: portfolioData.positions } : { id: parseInt(selectA) },
                portfolio_b: selectB === 'current' ? { positions: portfolioData.positions } : { id: parseInt(selectB) }
            };

            showProgress('Comparing portfolios...');

            try {
                const headers = { 'Content-Type': 'application/json' };
                if (authToken) {
                    headers['Authorization'] = `Bearer ${authToken}`;
                }

                const res = await fetch(`${API_URL}/compare`, {
                    method: 'POST',
                    headers,
                    body: JSON.stringify(body)
                });

                if (!res.ok) {
                    const data = await res.json();
                    hideProgress();
                    showError(data.error || 'Comparison failed');
                    return;
                }

                const data = await res.json();
                hideProgress();
                renderComparison(data);

            } catch (err) {
                hideProgress();
                showError('Comparison failed: ' + err.message);
            }
        }

        function renderComparison(data) {
            const resultsEl = document.getElementById('comparisonResults');
            const emptyEl = document.getElementById('compareEmptyState');

            resultsEl.style.display = 'block';
            emptyEl.style.display = 'none';

            const { portfolio_a, portfolio_b, comparison } = data;

            // Get names from selectors
            const selectA = document.getElementById('compareSelectA');
            const selectB = document.getElementById('compareSelectB');
            const nameA = selectA.options[selectA.selectedIndex].text;
            const nameB = selectB.options[selectB.selectedIndex].text;

            // Update headers
            document.getElementById('compareNameA').textContent = nameA.split(' (')[0];
            document.getElementById('compareNameB').textContent = nameB.split(' (')[0];
            document.getElementById('compareValueA').textContent = formatCurrency(portfolio_a.total_value);
            document.getElementById('compareValueB').textContent = formatCurrency(portfolio_b.total_value);

            // Render allocation charts
            renderCompareChart('compareChartA', portfolio_a.asset_allocation);
            renderCompareChart('compareChartB', portfolio_b.asset_allocation);

            // Render stats
            renderCompareStats('compareStatsA', portfolio_a);
            renderCompareStats('compareStatsB', portfolio_b);

            // Render difference grid
            renderDiffGrid(comparison);
        }

        function renderCompareChart(canvasId, allocation) {
            const ctx = document.getElementById(canvasId).getContext('2d');

            if (compareCharts[canvasId]) {
                compareCharts[canvasId].destroy();
            }

            const labels = Object.keys(allocation).filter(k => allocation[k] > 0);
            const values = labels.map(k => allocation[k]);
            const colors = {
                Stocks: '#635bff', Bonds: '#30d158', Cash: '#ffd60a',
                'Real Estate': '#bf5af2', Crypto: '#ff9f0a', Commodities: '#64d2ff'
            };
            const bgColors = labels.map(l => colors[l] || '#8898aa');

            compareCharts[canvasId] = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels,
                    datasets: [{ data: values, backgroundColor: bgColors, borderWidth: 0 }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { padding: 12, usePointStyle: true, font: { size: 11 } } },
                        tooltip: { callbacks: { label: ctx => `${ctx.label}: ${ctx.raw.toFixed(1)}%` } }
                    }
                }
            });
        }

        function renderCompareStats(containerId, analysis) {
            const risk = analysis.risk_metrics || {};
            const perf = analysis.historical_performance?.returns || {};

            document.getElementById(containerId).innerHTML = `
                <div class="compare-stat">
                    <div class="compare-stat-value">${risk.volatility !== null ? risk.volatility.toFixed(1) + '%' : '--'}</div>
                    <div class="compare-stat-label">Volatility</div>
                </div>
                <div class="compare-stat">
                    <div class="compare-stat-value">${risk.beta !== null ? risk.beta.toFixed(2) : '--'}</div>
                    <div class="compare-stat-label">Beta</div>
                </div>
                <div class="compare-stat">
                    <div class="compare-stat-value">${risk.sharpe_ratio !== null ? risk.sharpe_ratio.toFixed(2) : '--'}</div>
                    <div class="compare-stat-label">Sharpe</div>
                </div>
                <div class="compare-stat">
                    <div class="compare-stat-value">${perf['1Y']?.portfolio !== null ? (perf['1Y']?.portfolio > 0 ? '+' : '') + perf['1Y']?.portfolio?.toFixed(1) + '%' : '--'}</div>
                    <div class="compare-stat-label">1Y Return</div>
                </div>
            `;
        }

        function renderDiffGrid(comparison) {
            const grid = document.getElementById('diffGrid');

            const formatDiff = (val, suffix = '') => {
                if (val === null || val === undefined) return '--';
                const sign = val > 0 ? '+' : '';
                return sign + val.toFixed(1) + suffix;
            };

            const getDiffClass = (val) => {
                if (val === null || val === undefined || val === 0) return 'neutral';
                return val > 0 ? 'positive' : 'negative';
            };

            const items = [
                { label: 'Total Value', value: comparison.total_value_diff, format: v => formatCurrency(v), rawValue: comparison.total_value_diff },
                { label: 'Stocks %', value: comparison.allocation_diff?.Stocks, suffix: '%' },
                { label: 'Bonds %', value: comparison.allocation_diff?.Bonds, suffix: '%' },
                { label: 'Volatility', value: comparison.risk_diff?.volatility, suffix: '%' },
                { label: 'Beta', value: comparison.risk_diff?.beta, suffix: '' },
                { label: 'Sharpe Ratio', value: comparison.risk_diff?.sharpe_ratio, suffix: '' },
                { label: '1Y Return', value: comparison.performance_diff?.['1Y'], suffix: '%' },
                { label: '3Y Return', value: comparison.performance_diff?.['3Y'], suffix: '%' }
            ];

            grid.innerHTML = items.map(item => {
                const displayVal = item.format ? item.format(item.value) : formatDiff(item.value, item.suffix || '');
                const rawVal = item.rawValue !== undefined ? item.rawValue : item.value;
                return `
                    <div class="diff-item">
                        <div class="diff-value ${getDiffClass(rawVal)}">${displayVal}</div>
                        <div class="diff-label">${item.label}</div>
                    </div>
                `;
            }).join('');
        }

        // =============================================================================
        // WHAT-IF ANALYSIS
        // =============================================================================

        let whatIfPositions = [];
        let whatIfChanges = [];
        let whatIfChart = null;
        let whatIfResult = null;

        function initWhatIf() {
            if (!portfolioData || !portfolioData.positions) return;

            // Clone current positions
            whatIfPositions = JSON.parse(JSON.stringify(portfolioData.positions));
            whatIfChanges = [];
            whatIfResult = null;

            renderWhatIfPositions();
            updateWhatIfPreview();
        }

        function renderWhatIfPositions() {
            const list = document.getElementById('whatifPositionList');

            if (!whatIfPositions || whatIfPositions.length === 0) {
                list.innerHTML = '<div class="empty-state">No positions to edit</div>';
                return;
            }

            list.innerHTML = whatIfPositions.map((pos, idx) => {
                const value = (pos.shares || 0) * (pos.price || 0);
                return `
                    <div class="whatif-position">
                        <div class="whatif-position-symbol">${pos.symbol}</div>
                        <div class="whatif-position-shares">
                            <input type="number" value="${pos.shares || 0}" min="0" step="0.0001"
                                   onchange="updateWhatIfShares(${idx}, this.value)">
                            <span style="color: var(--text-muted); font-size: 0.75rem; margin-left: 4px;">shares</span>
                        </div>
                        <div class="whatif-position-value">${formatCurrency(value)}</div>
                        <button class="whatif-position-remove" onclick="removeWhatIfPosition(${idx})" title="Remove">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                            </svg>
                        </button>
                    </div>
                `;
            }).join('');
        }

        function updateWhatIfShares(idx, newShares) {
            const pos = whatIfPositions[idx];
            if (!pos) return;

            const oldShares = pos.shares || 0;
            pos.shares = parseFloat(newShares) || 0;
            pos.value = pos.shares * (pos.price || 0);

            // Track the change
            whatIfChanges = whatIfChanges.filter(c => !(c.action === 'adjust' && c.symbol === pos.symbol));
            if (pos.shares !== oldShares) {
                whatIfChanges.push({
                    action: 'adjust',
                    symbol: pos.symbol,
                    new_shares: pos.shares
                });
            }

            renderWhatIfPositions();
            updateWhatIfPreview();
        }

        function removeWhatIfPosition(idx) {
            const pos = whatIfPositions[idx];
            if (!pos) return;

            whatIfChanges.push({
                action: 'remove',
                symbol: pos.symbol
            });

            whatIfPositions.splice(idx, 1);
            renderWhatIfPositions();
            updateWhatIfPreview();
        }

        function addWhatIfPosition() {
            const symbol = document.getElementById('whatifAddSymbol').value.toUpperCase().trim();
            const shares = parseFloat(document.getElementById('whatifAddShares').value) || 0;
            const price = parseFloat(document.getElementById('whatifAddPrice').value) || 0;

            if (!symbol) {
                showError('Please enter a symbol');
                return;
            }
            if (shares <= 0) {
                showError('Please enter a valid number of shares');
                return;
            }
            if (price <= 0) {
                showError('Please enter a valid price');
                return;
            }

            // Check if already exists
            const existing = whatIfPositions.find(p => p.symbol.toUpperCase() === symbol);
            if (existing) {
                existing.shares = (existing.shares || 0) + shares;
                existing.value = existing.shares * (existing.price || price);
            } else {
                whatIfPositions.push({
                    symbol: symbol,
                    description: '',
                    shares: shares,
                    price: price,
                    value: shares * price
                });
            }

            whatIfChanges.push({
                action: 'add',
                symbol: symbol,
                shares: shares,
                price: price
            });

            // Clear form
            document.getElementById('whatifAddSymbol').value = '';
            document.getElementById('whatifAddShares').value = '';
            document.getElementById('whatifAddPrice').value = '';

            renderWhatIfPositions();
            updateWhatIfPreview();
        }

        function applyRebalance() {
            const stocks = parseFloat(document.getElementById('rebalanceStocks').value) || 0;
            const bonds = parseFloat(document.getElementById('rebalanceBonds').value) || 0;
            const cash = parseFloat(document.getElementById('rebalanceCash').value) || 0;

            const total = stocks + bonds + cash;
            if (total === 0) {
                showError('Please enter target allocations');
                return;
            }

            if (Math.abs(total - 100) > 0.1) {
                showError(`Allocations sum to ${total.toFixed(1)}%, should be 100%`);
                return;
            }

            whatIfChanges.push({
                action: 'rebalance',
                target: { Stocks: stocks, Bonds: bonds, Cash: cash }
            });

            // Run analysis to get rebalanced positions
            runWhatIfAnalysis();
        }

        function updateWhatIfPreview() {
            const totalValue = whatIfPositions.reduce((sum, p) => sum + ((p.shares || 0) * (p.price || 0)), 0);
            document.getElementById('whatifPreviewValue').textContent = formatCurrency(totalValue);

            // Calculate allocation preview
            const alloc = {};
            whatIfPositions.forEach(pos => {
                const value = (pos.shares || 0) * (pos.price || 0);
                // Simple classification based on symbol database
                const cls = getAssetClass(pos.symbol);
                alloc[cls] = (alloc[cls] || 0) + value;
            });

            const allocPct = {};
            for (const [cls, val] of Object.entries(alloc)) {
                allocPct[cls] = totalValue > 0 ? ((val / totalValue) * 100).toFixed(1) : '0.0';
            }

            // Render preview allocation chart
            renderWhatIfChart(allocPct);

            // Show modified allocation
            document.getElementById('whatifModifiedAlloc').innerHTML = Object.entries(allocPct)
                .map(([cls, pct]) => `${cls}: ${pct}%`)
                .join('<br>');

            // Show original allocation
            if (portfolioData && portfolioData.asset_allocation) {
                document.getElementById('whatifOriginalAlloc').innerHTML = Object.entries(portfolioData.asset_allocation)
                    .filter(([_, pct]) => pct > 0)
                    .map(([cls, pct]) => `${cls}: ${pct.toFixed(1)}%`)
                    .join('<br>');
            }
        }

        function getAssetClass(symbol) {
            // Simple lookup - in production this would use the backend classification
            const stockSymbols = ['VTI', 'VOO', 'SPY', 'QQQ', 'IVV', 'VEA', 'VWO', 'AAPL', 'MSFT', 'GOOGL', 'AMZN', 'META', 'NVDA', 'TSLA'];
            const bondSymbols = ['AGG', 'BND', 'TLT', 'BNDX', 'LQD', 'HYG', 'TIP', 'MUB', 'SGOV'];
            const cashSymbols = ['CASH', 'SPAXX', 'VMFXX', 'SWVXX'];
            const cryptoSymbols = ['IBIT', 'GBTC', 'ETHA', 'FBTC'];

            symbol = symbol.toUpperCase();
            if (cashSymbols.includes(symbol)) return 'Cash';
            if (bondSymbols.includes(symbol)) return 'Bonds';
            if (cryptoSymbols.includes(symbol)) return 'Crypto';
            return 'Stocks'; // Default
        }

        function renderWhatIfChart(allocation) {
            const ctx = document.getElementById('whatifChart').getContext('2d');

            if (whatIfChart) {
                whatIfChart.destroy();
            }

            const labels = Object.keys(allocation).filter(k => parseFloat(allocation[k]) > 0);
            const values = labels.map(k => parseFloat(allocation[k]));
            const colors = {
                Stocks: '#635bff', Bonds: '#30d158', Cash: '#ffd60a',
                'Real Estate': '#bf5af2', Crypto: '#ff9f0a', Commodities: '#64d2ff'
            };
            const bgColors = labels.map(l => colors[l] || '#8898aa');

            whatIfChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels,
                    datasets: [{ data: values, backgroundColor: bgColors, borderWidth: 0 }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { padding: 8, usePointStyle: true, font: { size: 10 } } },
                        tooltip: { callbacks: { label: ctx => `${ctx.label}: ${ctx.raw}%` } }
                    }
                }
            });
        }

        async function runWhatIfAnalysis() {
            if (!portfolioData || !portfolioData.positions) {
                showError('No portfolio to analyze');
                return;
            }

            showProgress('Running what-if analysis...');

            try {
                const headers = { 'Content-Type': 'application/json' };
                if (authToken) {
                    headers['Authorization'] = `Bearer ${authToken}`;
                }

                const res = await fetch(`${API_URL}/what-if`, {
                    method: 'POST',
                    headers,
                    body: JSON.stringify({
                        positions: portfolioData.positions,
                        changes: whatIfChanges
                    })
                });

                if (!res.ok) {
                    const data = await res.json();
                    hideProgress();
                    showError(data.error || 'Analysis failed');
                    return;
                }

                const data = await res.json();
                hideProgress();
                whatIfResult = data;

                // Update positions from result
                whatIfPositions = data.modified.positions.map(p => ({
                    symbol: p.symbol,
                    description: p.description,
                    shares: p.shares,
                    price: p.price,
                    value: p.value
                }));

                renderWhatIfPositions();
                renderWhatIfResults(data);

                // Show save button if logged in
                if (currentUser) {
                    document.getElementById('saveWhatIfBtn').style.display = 'inline-flex';
                }

            } catch (err) {
                hideProgress();
                showError('Analysis failed: ' + err.message);
            }
        }

        function renderWhatIfResults(data) {
            const { original, modified, impact } = data;

            // Update preview value
            document.getElementById('whatifPreviewValue').textContent = formatCurrency(modified.total_value);

            // Update impact cards
            const formatDiff = (val, suffix = '') => {
                if (val === null || val === undefined) return '--';
                const sign = val > 0 ? '+' : '';
                return sign + val.toFixed(1) + suffix;
            };

            document.getElementById('whatifValueChange').textContent = formatCurrency(impact.value_change);
            document.getElementById('whatifValueChange').className = 'whatif-impact-value ' +
                (impact.value_change > 0 ? 'positive' : impact.value_change < 0 ? 'negative' : '');

            document.getElementById('whatifCost').textContent = formatCurrency(impact.cost_to_execute);

            document.getElementById('whatifVolChange').textContent = formatDiff(impact.risk_change?.volatility, '%');
            document.getElementById('whatifVolChange').className = 'whatif-impact-value ' +
                (impact.risk_change?.volatility < 0 ? 'positive' : impact.risk_change?.volatility > 0 ? 'negative' : '');

            document.getElementById('whatifBetaChange').textContent = formatDiff(impact.risk_change?.beta, '');

            // Update allocation displays
            document.getElementById('whatifOriginalAlloc').innerHTML = Object.entries(original.asset_allocation)
                .filter(([_, pct]) => pct > 0)
                .map(([cls, pct]) => `${cls}: ${pct.toFixed(1)}%`)
                .join('<br>');

            document.getElementById('whatifModifiedAlloc').innerHTML = Object.entries(modified.asset_allocation)
                .filter(([_, pct]) => pct > 0)
                .map(([cls, pct]) => `${cls}: ${pct.toFixed(1)}%`)
                .join('<br>');

            // Update chart
            renderWhatIfChart(modified.asset_allocation);
        }

        function resetWhatIf() {
            initWhatIf();
            document.getElementById('saveWhatIfBtn').style.display = 'none';
            document.getElementById('whatifValueChange').textContent = '--';
            document.getElementById('whatifCost').textContent = '--';
            document.getElementById('whatifVolChange').textContent = '--';
            document.getElementById('whatifBetaChange').textContent = '--';
        }

        function saveWhatIfAsNew() {
            if (!whatIfResult || !currentUser) return;

            // Populate save modal with modified positions
            const tempPositions = whatIfResult.modified.positions;
            const tempData = portfolioData;

            // Temporarily set portfolio data to modified positions
            portfolioData = { positions: tempPositions };

            document.getElementById('portfolioName').value = 'What-If Scenario';
            showSaveModal();

            // Restore original after modal shown
            portfolioData = tempData;
        }

        // =============================================================================
        // PLAID INTEGRATION
        // =============================================================================

        let plaidAvailable = false;
        let plaidHandler = null;

        async function checkPlaidStatus() {
            try {
                const res = await fetch(`${API_URL}/plaid/status`);
                const data = await res.json();
                plaidAvailable = data.available;
                updatePlaidUI();
            } catch (err) {
                plaidAvailable = false;
            }
        }

        function updatePlaidUI() {
            const section = document.getElementById('plaidSection');

            // Only show Plaid section if user is logged in
            if (!currentUser) {
                section.style.display = 'none';
                return;
            }

            section.style.display = 'block';

            if (!plaidAvailable) {
                document.getElementById('plaidConnections').innerHTML = `
                    <div class="plaid-unavailable">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <rect x="2" y="4" width="20" height="16" rx="2"/>
                            <path d="M7 15h0M2 9h20"/>
                        </svg>
                        <p>Plaid integration is not configured</p>
                        <p style="font-size: 0.8125rem;">Contact your administrator to enable account linking</p>
                    </div>
                `;
                return;
            }

            loadPlaidConnections();
        }

        async function loadPlaidConnections() {
            if (!authToken || !plaidAvailable) return;

            const container = document.getElementById('plaidConnections');

            try {
                const res = await fetch(`${API_URL}/plaid/connections`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (!res.ok) {
                    container.innerHTML = '<div class="empty-state">Failed to load connections</div>';
                    return;
                }

                const data = await res.json();
                const connections = data.connections || [];

                if (connections.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <p>No accounts connected yet</p>
                            <p style="font-size: 0.8125rem;">Link your brokerage to automatically import holdings</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = connections.map(c => `
                    <div class="plaid-connection">
                        <div class="plaid-connection-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="2" y="4" width="20" height="16" rx="2"/>
                                <path d="M7 15h0M2 9h20"/>
                            </svg>
                        </div>
                        <div class="plaid-connection-info">
                            <div class="plaid-connection-name">${escapeHtml(c.institution_name || 'Connected Account')}</div>
                            <div class="plaid-connection-meta">
                                Last synced: ${c.last_synced ? new Date(c.last_synced).toLocaleString() : 'Never'}
                            </div>
                        </div>
                        <div class="plaid-connection-actions">
                            <button class="btn btn-secondary" onclick="syncPlaidConnection(${c.id})">
                                Sync
                            </button>
                            <button class="portfolio-action-btn delete" onclick="disconnectPlaidAccount(${c.id})" title="Disconnect">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                `).join('');

            } catch (err) {
                container.innerHTML = '<div class="empty-state">Failed to load connections</div>';
            }
        }

        async function connectPlaidAccount() {
            if (!authToken) {
                showAuthModal();
                return;
            }

            if (!plaidAvailable) {
                showError('Plaid integration is not available');
                return;
            }

            try {
                // Get link token from backend
                const res = await fetch(`${API_URL}/plaid/create-link-token`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (!res.ok) {
                    const data = await res.json();
                    showError(data.error || 'Failed to initialize Plaid');
                    return;
                }

                const data = await res.json();
                const linkToken = data.link_token;

                // Initialize Plaid Link
                plaidHandler = Plaid.create({
                    token: linkToken,
                    onSuccess: async (publicToken, metadata) => {
                        await exchangePlaidToken(publicToken, metadata);
                    },
                    onExit: (err, metadata) => {
                        if (err) {
                            console.error('Plaid Link error:', err);
                        }
                    },
                    onEvent: (eventName, metadata) => {
                        console.log('Plaid event:', eventName);
                    }
                });

                plaidHandler.open();

            } catch (err) {
                showError('Failed to connect account: ' + err.message);
            }
        }

        async function exchangePlaidToken(publicToken, metadata) {
            try {
                const res = await fetch(`${API_URL}/plaid/exchange-token`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        public_token: publicToken,
                        institution_name: metadata.institution?.name || '',
                        institution_id: metadata.institution?.institution_id || ''
                    })
                });

                if (!res.ok) {
                    const data = await res.json();
                    showError(data.error || 'Failed to connect account');
                    return;
                }

                // Reload connections
                loadPlaidConnections();

            } catch (err) {
                showError('Failed to connect account: ' + err.message);
            }
        }

        async function syncPlaidConnection(connectionId) {
            showProgress('Syncing account...');

            try {
                const res = await fetch(`${API_URL}/plaid/connections/${connectionId}/sync`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (!res.ok) {
                    const data = await res.json();
                    hideProgress();
                    showError(data.error || 'Sync failed');
                    return;
                }

                const data = await res.json();
                hideProgress();

                if (data.positions && data.positions.length > 0) {
                    // Add as an account
                    accounts.push({
                        id: Date.now() + Math.random(),
                        name: data.connection.institution_name || 'Plaid Account',
                        positions: data.positions,
                        brokerage: 'plaid',
                        totalValue: data.positions.reduce((s, p) => s + (p.value || 0), 0)
                    });
                    renderAccounts();
                    loadPlaidConnections();
                } else {
                    showError('No holdings found in this account');
                }

            } catch (err) {
                hideProgress();
                showError('Sync failed: ' + err.message);
            }
        }

        async function disconnectPlaidAccount(connectionId) {
            if (!confirm('Are you sure you want to disconnect this account?')) {
                return;
            }

            try {
                const res = await fetch(`${API_URL}/plaid/connections/${connectionId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (!res.ok) {
                    const data = await res.json();
                    showError(data.error || 'Failed to disconnect');
                    return;
                }

                loadPlaidConnections();

            } catch (err) {
                showError('Failed to disconnect: ' + err.message);
            }
        }

        // Initialize auth check and Plaid status
        checkAuth();
        checkPlaidStatus();

        // DOM Elements
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const accountsSection = document.getElementById('accountsSection');
        const accountsList = document.getElementById('accountsList');
        const addMoreBtn = document.getElementById('addMoreBtn');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const clearAllBtn = document.getElementById('clearAllBtn');
        const progressSection = document.getElementById('progressSection');
        const progressText = document.getElementById('progressText');
        const dashboard = document.getElementById('dashboard');
        const errorMessage = document.getElementById('errorMessage');
        const uploadSection = document.getElementById('uploadSection');

        // Event Listeners
        dropZone.addEventListener('click', (e) => {
            if (e.target.closest('button')) return;
            fileInput.click();
        });
        addMoreBtn.addEventListener('click', () => fileInput.click());

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });

        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
            fileInput.value = '';
        });

        analyzeBtn.addEventListener('click', analyzePortfolio);
        clearAllBtn.addEventListener('click', () => { accounts = []; renderAccounts(); });
        document.getElementById('newAnalysisBtn').addEventListener('click', resetUI);
        document.getElementById('downloadBtn').addEventListener('click', downloadCSV);
        document.getElementById('savePortfolioBtn').addEventListener('click', showSaveModal);

        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
            });
        });

        async function handleFiles(files) {
            const validFiles = Array.from(files).filter(file => {
                const ext = file.name.split('.').pop().toLowerCase();
                return ['pdf', 'csv'].includes(ext);
            });

            if (validFiles.length === 0) {
                showError('Please select PDF or CSV files');
                return;
            }

            // Show upload queue for multiple files
            const queue = document.getElementById('uploadQueue');
            const queueList = document.getElementById('uploadQueueList');
            const queueTitle = document.getElementById('uploadQueueTitle');
            const queueCount = document.getElementById('uploadQueueCount');

            if (validFiles.length > 1) {
                queue.style.display = 'block';
                queueTitle.textContent = 'Processing files...';
                queueCount.textContent = `0 / ${validFiles.length}`;

                // Initialize queue items
                queueList.innerHTML = validFiles.map((file, i) => `
                    <div class="upload-queue-item" id="queueItem${i}">
                        <div class="upload-file-icon" id="queueIcon${i}">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                <polyline points="14 2 14 8 20 8"/>
                            </svg>
                        </div>
                        <div class="upload-file-info">
                            <div class="upload-file-name">${file.name}</div>
                            <div class="upload-file-status" id="queueStatus${i}">Waiting...</div>
                        </div>
                    </div>
                `).join('');
            }

            // Process all files in parallel
            let completed = 0;
            let successful = 0;

            const processFile = async (file, index) => {
                const iconEl = document.getElementById(`queueIcon${index}`);
                const statusEl = document.getElementById(`queueStatus${index}`);

                if (validFiles.length > 1) {
                    iconEl?.classList.add('processing');
                    if (statusEl) statusEl.textContent = 'Processing...';
                } else {
                    showProgress(`Parsing ${file.name}...`);
                }

                try {
                    const result = await parseFile(file);

                    if (result.error && !result.positions?.length) {
                        if (validFiles.length > 1) {
                            iconEl?.classList.remove('processing');
                            iconEl?.classList.add('error');
                            if (statusEl) {
                                statusEl.textContent = result.error;
                                statusEl.classList.add('error');
                            }
                        } else {
                            hideProgress();
                            showError(`${file.name}: ${result.error}`);
                        }
                        return { success: false };
                    }

                    accounts.push({
                        id: Date.now() + Math.random(),
                        name: getBrokerageName(result.brokerage),
                        positions: result.positions,
                        brokerage: result.brokerage,
                        totalValue: result.positions.reduce((s, p) => s + (p.value || 0), 0)
                    });

                    if (validFiles.length > 1) {
                        iconEl?.classList.remove('processing');
                        iconEl?.classList.add('success');
                        if (iconEl) {
                            iconEl.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="20 6 9 17 4 12"/>
                            </svg>`;
                        }
                        if (statusEl) {
                            statusEl.textContent = `${result.positions.length} positions found`;
                            statusEl.classList.add('success');
                        }
                    }

                    return { success: true };
                } catch (err) {
                    if (validFiles.length > 1) {
                        iconEl?.classList.remove('processing');
                        iconEl?.classList.add('error');
                        if (iconEl) {
                            iconEl.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <line x1="15" y1="9" x2="9" y2="15"/>
                                <line x1="9" y1="9" x2="15" y2="15"/>
                            </svg>`;
                        }
                        if (statusEl) {
                            statusEl.textContent = err.message;
                            statusEl.classList.add('error');
                        }
                    } else {
                        hideProgress();
                        showError(`${file.name}: ${err.message}`);
                    }
                    return { success: false };
                }
            };

            // Process files in parallel (max 3 concurrent)
            const results = [];
            const concurrency = 3;

            for (let i = 0; i < validFiles.length; i += concurrency) {
                const batch = validFiles.slice(i, i + concurrency);
                const batchResults = await Promise.all(
                    batch.map((file, j) => processFile(file, i + j))
                );
                results.push(...batchResults);

                completed += batch.length;
                successful += batchResults.filter(r => r.success).length;

                if (validFiles.length > 1) {
                    queueCount.textContent = `${completed} / ${validFiles.length}`;
                }
            }

            // Finish up
            if (validFiles.length > 1) {
                queueTitle.textContent = 'Upload complete';

                // Auto-hide queue after delay if all successful
                if (successful === validFiles.length) {
                    setTimeout(() => {
                        queue.style.display = 'none';
                    }, 2000);
                }
            } else {
                hideProgress();
            }

            hideError();
            renderAccounts();
        }

        function getBrokerageName(brokerage) {
            const names = { schwab: 'Schwab', fidelity: 'Fidelity', vanguard: 'Vanguard', csv: 'Account' };
            const base = names[brokerage] || 'Account';
            const count = accounts.filter(a => a.name.startsWith(base)).length + 1;
            return count > 1 ? `${base} ${count}` : base;
        }

        async function parseFile(file) {
            const formData = new FormData();
            formData.append('file', file);
            const res = await fetch(`${API_URL}/parse`, { method: 'POST', body: formData });
            return res.json();
        }

        function renderAccounts() {
            accountsSection.style.display = accounts.length ? 'block' : 'none';
            analyzeBtn.disabled = !accounts.length;
            accountsList.innerHTML = accounts.map(a => `
                <div class="account-item">
                    <div class="account-icon">${a.brokerage[0].toUpperCase()}</div>
                    <div class="account-details">
                        <input type="text" class="account-name-input" value="${a.name}" onchange="updateName(${a.id}, this.value)">
                        <div class="account-meta">${a.positions.length} positions</div>
                    </div>
                    <div class="account-value">${formatCurrency(a.totalValue)}</div>
                    <button class="remove-btn" onclick="removeAccount(${a.id})">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                </div>
            `).join('');
        }

        function updateName(id, name) {
            const acc = accounts.find(a => a.id === id);
            if (acc) acc.name = name;
        }

        function removeAccount(id) {
            accounts = accounts.filter(a => a.id !== id);
            renderAccounts();
        }

        function aggregatePositions() {
            const agg = {};
            accounts.forEach(acc => {
                acc.positions.forEach(pos => {
                    if (!agg[pos.symbol]) agg[pos.symbol] = { ...pos, shares: 0, value: 0 };
                    agg[pos.symbol].shares += pos.shares || 0;
                    agg[pos.symbol].value += pos.value || 0;
                    if (!agg[pos.symbol].description && pos.description) agg[pos.symbol].description = pos.description;
                });
            });
            Object.values(agg).forEach(p => { if (p.shares > 0) p.price = p.value / p.shares; });
            return Object.values(agg);
        }

        async function analyzePortfolio() {
            if (!accounts.length) return;
            showProgress('Analyzing portfolio...');
            try {
                const res = await fetch(`${API_URL}/analyze`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ positions: aggregatePositions(), include_risk: true })
                });
                if (!res.ok) throw new Error('Analysis failed');
                portfolioData = await res.json();
                hideProgress();
                hideError();
                showDashboard();
            } catch (err) {
                hideProgress();
                showError('Analysis failed: ' + err.message);
            }
        }

        function showDashboard() {
            uploadSection.style.display = 'none';
            dashboard.style.display = 'block';
            document.getElementById('totalBadge').textContent = formatCurrency(portfolioData.total_value);
            renderAllocation();
            renderPerformance();
            renderSectors();
            renderGeography();
            renderRisk();
            renderHoldings();
            updateCompareSelectors();
            initWhatIf();
        }

        function renderAllocation() {
            const alloc = portfolioData.asset_allocation || {};
            const vals = portfolioData.asset_allocation_values || {};
            const stocks = alloc.Stocks || 0;
            const bonds = alloc.Bonds || 0;
            const cash = alloc.Cash || 0;
            const alts = (alloc['Real Estate'] || 0) + (alloc.Crypto || 0) + (alloc.Commodities || 0);

            document.getElementById('stocksPct').textContent = stocks.toFixed(1) + '%';
            document.getElementById('bondsPct').textContent = bonds.toFixed(1) + '%';
            document.getElementById('cashPct').textContent = cash.toFixed(1) + '%';
            document.getElementById('altsPct').textContent = alts.toFixed(1) + '%';
            document.getElementById('stocksVal').textContent = formatCurrency(vals.Stocks || 0);
            document.getElementById('bondsVal').textContent = formatCurrency(vals.Bonds || 0);
            document.getElementById('cashVal').textContent = formatCurrency(vals.Cash || 0);
            document.getElementById('altsVal').textContent = formatCurrency((vals['Real Estate'] || 0) + (vals.Crypto || 0) + (vals.Commodities || 0));

            renderDoughnut('allocationChart', alloc, {
                Stocks: '#635bff', Bonds: '#30d158', Cash: '#ffd60a',
                'Real Estate': '#bf5af2', Crypto: '#ff9f0a', Commodities: '#64d2ff'
            });

            const subClass = portfolioData.sub_class_allocation || {};
            renderSubClassChart('subClassChart', subClass, portfolioData.positions || []);
        }

        // Map sub-classes to their parent asset class
        function getAssetClassForSubClass(subClassName, positions) {
            // Find a position with this sub-class to get the asset class
            for (const pos of positions) {
                if (pos.classification && pos.classification.sub_class === subClassName) {
                    return pos.classification.asset_class;
                }
            }
            // Fallback mapping
            const subClassMap = {
                'US Total Market': 'Stocks', 'US Large Cap': 'Stocks', 'US Large Cap Growth': 'Stocks',
                'US Large Cap Value': 'Stocks', 'US Mid Cap': 'Stocks', 'US Mid Cap Growth': 'Stocks',
                'US Mid Cap Value': 'Stocks', 'US Small Cap': 'Stocks', 'US Small Cap Growth': 'Stocks',
                'US Small Cap Value': 'Stocks', 'US Mega Cap': 'Stocks', 'US Dividend': 'Stocks',
                'US Dividend Growth': 'Stocks', 'US High Dividend': 'Stocks',
                'International Developed': 'Stocks', 'International Total': 'Stocks',
                'International Small Cap': 'Stocks', 'International Dividend': 'Stocks',
                'Emerging Markets': 'Stocks', 'Europe': 'Stocks', 'Pacific': 'Stocks',
                'Japan': 'Stocks', 'China': 'Stocks', 'India': 'Stocks', 'Brazil': 'Stocks',
                'Global': 'Stocks', 'Germany': 'Stocks', 'UK': 'Stocks', 'Canada': 'Stocks',
                'Australia': 'Stocks', 'Taiwan': 'Stocks', 'South Korea': 'Stocks', 'MLPs': 'Stocks',
                'US Treasury': 'Bonds', 'TIPS': 'Bonds', 'US Aggregate': 'Bonds',
                'Short-Term Bond': 'Bonds', 'Intermediate Bond': 'Bonds', 'Long-Term Bond': 'Bonds',
                'Investment Grade Corp': 'Bonds', 'High Yield': 'Bonds', 'Municipal': 'Bonds',
                'Mortgage-Backed': 'Bonds', 'International Developed': 'Bonds',
                'International Aggregate': 'Bonds', 'International Treasury': 'Bonds',
                'Cash': 'Cash', 'Money Market': 'Cash',
                'US REITs': 'Real Estate', 'International REITs': 'Real Estate',
                'Bitcoin': 'Crypto', 'Ethereum': 'Crypto', 'DeFi': 'Crypto',
                'Gold': 'Commodities', 'Silver': 'Commodities', 'Platinum': 'Commodities',
                'Palladium': 'Commodities', 'Broad Commodities': 'Commodities',
                'Oil': 'Commodities', 'Natural Gas': 'Commodities', 'Agriculture': 'Commodities'
            };
            return subClassMap[subClassName] || 'Stocks';
        }

        function generateShades(baseColor, count) {
            // Convert hex to HSL, then generate shades
            const hex = baseColor.replace('#', '');
            const r = parseInt(hex.substr(0, 2), 16) / 255;
            const g = parseInt(hex.substr(2, 2), 16) / 255;
            const b = parseInt(hex.substr(4, 2), 16) / 255;

            const max = Math.max(r, g, b), min = Math.min(r, g, b);
            let h, s, l = (max + min) / 2;

            if (max === min) {
                h = s = 0;
            } else {
                const d = max - min;
                s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                switch (max) {
                    case r: h = ((g - b) / d + (g < b ? 6 : 0)) / 6; break;
                    case g: h = ((b - r) / d + 2) / 6; break;
                    case b: h = ((r - g) / d + 4) / 6; break;
                }
            }

            // Base color is darkest, then get progressively lighter
            const shades = [];
            const maxL = Math.min(0.9, l + 0.45); // How light the lightest shade can be
            const step = count > 1 ? (maxL - l) / (count - 1) : 0;

            for (let i = 0; i < count; i++) {
                const newL = l + (step * i); // Start at base color lightness, go lighter
                shades.push(hslToHex(h, s, newL));
            }
            return shades;
        }

        function hslToHex(h, s, l) {
            let r, g, b;
            if (s === 0) {
                r = g = b = l;
            } else {
                const hue2rgb = (p, q, t) => {
                    if (t < 0) t += 1;
                    if (t > 1) t -= 1;
                    if (t < 1/6) return p + (q - p) * 6 * t;
                    if (t < 1/2) return q;
                    if (t < 2/3) return p + (q - p) * (2/3 - t) * 6;
                    return p;
                };
                const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
                const p = 2 * l - q;
                r = hue2rgb(p, q, h + 1/3);
                g = hue2rgb(p, q, h);
                b = hue2rgb(p, q, h - 1/3);
            }
            const toHex = x => {
                const hex = Math.round(x * 255).toString(16);
                return hex.length === 1 ? '0' + hex : hex;
            };
            return `#${toHex(r)}${toHex(g)}${toHex(b)}`;
        }

        function renderSubClassChart(id, data, positions) {
            const ctx = document.getElementById(id).getContext('2d');
            if (charts[id]) charts[id].destroy();

            const assetColors = {
                Stocks: '#635bff', Bonds: '#30d158', Cash: '#ffd60a',
                'Real Estate': '#bf5af2', Crypto: '#ff9f0a', Commodities: '#64d2ff'
            };

            // Group sub-classes by asset class
            const grouped = {};
            Object.keys(data).forEach(subClass => {
                if (data[subClass] <= 0) return;
                const assetClass = getAssetClassForSubClass(subClass, positions);
                if (!grouped[assetClass]) grouped[assetClass] = [];
                grouped[assetClass].push({ name: subClass, value: data[subClass] });
            });

            // Sort each group by value (descending) and generate colors
            const labels = [];
            const values = [];
            const colors = [];

            Object.keys(grouped).sort().forEach(assetClass => {
                const items = grouped[assetClass].sort((a, b) => b.value - a.value);
                const baseColor = assetColors[assetClass] || '#8e8e93';
                const shades = generateShades(baseColor, items.length);

                items.forEach((item, idx) => {
                    labels.push(item.name);
                    values.push(item.value);
                    colors.push(shades[idx]); // Darkest first (highest allocation)
                });
            });

            charts[id] = new Chart(ctx, {
                type: 'doughnut',
                data: { labels, datasets: [{ data: values, backgroundColor: colors, borderWidth: 0 }] },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right', labels: { padding: 16, usePointStyle: true, font: { size: 12 } } },
                        tooltip: { callbacks: { label: ctx => `${ctx.label}: ${ctx.raw.toFixed(1)}%` } }
                    }
                }
            });
        }

        let fullChartData = null;
        let currentPeriod = '5Y';

        function renderPerformance() {
            const perf = portfolioData.historical_performance || {};
            let returns = perf.returns || {};
            const periods = ['1M', '3M', '6M', 'YTD', '1Y', '3Y', '5Y'];

            // Calculate returns from chart data if not provided by backend
            if (perf.chart_data && perf.chart_data.labels && perf.chart_data.portfolio) {
                const chartData = perf.chart_data;
                const labels = chartData.labels;
                const portfolio = chartData.portfolio;
                const benchmark = chartData.benchmark;
                const lastDate = new Date(labels[labels.length - 1]);
                const lastPortVal = portfolio[portfolio.length - 1];
                const lastBenchVal = benchmark ? benchmark[benchmark.length - 1] : null;

                // Helper to find return for a period
                function calcReturnFromChart(daysBack) {
                    const targetDate = new Date(lastDate);
                    targetDate.setDate(targetDate.getDate() - daysBack);

                    // Find the closest date at or before target
                    let idx = -1;
                    for (let i = labels.length - 1; i >= 0; i--) {
                        if (new Date(labels[i]) <= targetDate) {
                            idx = i;
                            break;
                        }
                    }
                    if (idx < 0) return { portfolio: null, benchmark: null };

                    const portReturn = ((lastPortVal / portfolio[idx]) - 1) * 100;
                    const benchReturn = benchmark ? ((lastBenchVal / benchmark[idx]) - 1) * 100 : null;
                    return { portfolio: portReturn, benchmark: benchReturn };
                }

                // Fill in missing period returns from chart data
                const periodDays = { '1M': 30, '3M': 90, '6M': 180, '1Y': 365, '3Y': 1095, '5Y': 1825 };
                for (const [period, days] of Object.entries(periodDays)) {
                    if (!returns[period] || returns[period].portfolio === null) {
                        const calc = calcReturnFromChart(days);
                        if (calc.portfolio !== null) {
                            returns[period] = calc;
                        }
                    }
                }

                // Calculate YTD if missing
                if (!returns['YTD'] || returns['YTD'].portfolio === null) {
                    const yearStart = new Date(lastDate.getFullYear(), 0, 1);
                    let idx = -1;
                    for (let i = 0; i < labels.length; i++) {
                        if (new Date(labels[i]) >= yearStart) {
                            idx = i;
                            break;
                        }
                    }
                    if (idx >= 0) {
                        const portReturn = ((lastPortVal / portfolio[idx]) - 1) * 100;
                        const benchReturn = benchmark ? ((lastBenchVal / benchmark[idx]) - 1) * 100 : null;
                        returns['YTD'] = { portfolio: portReturn, benchmark: benchReturn };
                    }
                }
            }

            document.getElementById('returnsGrid').innerHTML = periods.map(p => {
                const data = returns[p] || {};
                const val = data.portfolio;
                const bench = data.benchmark;
                const cls = val > 0 ? 'positive' : val < 0 ? 'negative' : '';
                return `
                    <div class="stat-card return-card" data-period="${p}">
                        <div class="stat-label">${p}</div>
                        <div class="stat-value ${cls}">${val !== null && val !== undefined ? (val > 0 ? '+' : '') + val.toFixed(2) + '%' : '--'}</div>
                        <div class="benchmark-label">S&P: ${bench !== null && bench !== undefined ? (bench > 0 ? '+' : '') + bench.toFixed(2) + '%' : '--'}</div>
                    </div>
                `;
            }).join('');

            // Store full chart data for filtering
            if (perf.chart_data) {
                fullChartData = perf.chart_data;
                renderLineChart(fullChartData, currentPeriod);
            }

            // Add click handlers for return cards
            document.querySelectorAll('.return-card').forEach(card => {
                card.addEventListener('click', () => {
                    const period = card.dataset.period;
                    selectPeriod(period);
                });
            });

            // Add click handlers for period buttons
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const period = btn.dataset.period;
                    selectPeriod(period);
                });
            });

            // Render projections chart
            renderProjections();
        }

        function selectPeriod(period) {
            currentPeriod = period;

            // Update period button states
            document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`.period-btn[data-period="${period}"]`)?.classList.add('active');

            // Update return card states
            document.querySelectorAll('.return-card').forEach(c => c.classList.remove('active'));
            document.querySelector(`.return-card[data-period="${period}"]`)?.classList.add('active');

            // Re-render chart with filtered data
            if (fullChartData) {
                renderLineChart(fullChartData, period);
            }
        }

        function filterChartDataByPeriod(data, period) {
            if (!data || !data.labels || !data.labels.length) return data;

            const now = new Date(data.labels[data.labels.length - 1]);
            let startDate = new Date(now);

            switch (period) {
                case '1M': startDate.setMonth(now.getMonth() - 1); break;
                case '3M': startDate.setMonth(now.getMonth() - 3); break;
                case '6M': startDate.setMonth(now.getMonth() - 6); break;
                case 'YTD': startDate = new Date(now.getFullYear(), 0, 1); break;
                case '1Y': startDate.setFullYear(now.getFullYear() - 1); break;
                case '3Y': startDate.setFullYear(now.getFullYear() - 3); break;
                case '5Y':
                default: return data; // Return full data for 5Y
            }

            const startIdx = data.labels.findIndex(d => new Date(d) >= startDate);
            if (startIdx === -1) return data;

            const filteredLabels = data.labels.slice(startIdx);
            const filteredPortfolio = data.portfolio.slice(startIdx);

            // Normalize portfolio
            const portfolioStart = filteredPortfolio[0] || 100;
            const result = {
                labels: filteredLabels,
                portfolio: filteredPortfolio.map(v => (v / portfolioStart) * 100)
            };

            // Handle multiple benchmarks
            const benchmarkKeys = ['sp500', 'bonds', 'world', 'sixty_forty', 'benchmark'];
            benchmarkKeys.forEach(key => {
                if (data[key]) {
                    const filtered = data[key].slice(startIdx);
                    const start = filtered[0] || 100;
                    result[key] = filtered.map(v => v !== null ? (v / start) * 100 : null);
                }
            });

            return result;
        }

        // Track which benchmarks are visible
        let visibleBenchmarks = { sp500: true, bonds: false, world: false, sixty_forty: false };

        function toggleBenchmark(key, checked) {
            visibleBenchmarks[key] = checked;
            if (fullChartData) {
                renderLineChart(fullChartData, currentPeriod);
            }
        }

        function renderProjections() {
            const projections = portfolioData.projections;
            if (!projections || !projections.monte_carlo) {
                document.getElementById('projectionsInfo').innerHTML = '<p style="color: var(--text-secondary);">Projections require more data</p>';
                return;
            }

            const mc = projections.monte_carlo;
            const cma = projections.capital_market_assumptions || {};
            const totalValue = portfolioData.total_value || 100000;
            const summary = mc.summary || {};

            // Render summary info cards
            const expectedReturn = cma.expected_annual_return || 0;
            const expectedVol = cma.expected_volatility || 0;
            const infoHtml = `
                <div class="stat-card">
                    <div class="stat-label">Expected Return</div>
                    <div class="stat-value ${expectedReturn >= 0 ? 'positive' : ''}">${expectedReturn.toFixed(1)}%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Expected Volatility</div>
                    <div class="stat-value">${expectedVol.toFixed(1)}%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Median 10Y Outcome</div>
                    <div class="stat-value">${formatCurrency(summary.median || 0)}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Best Case (95th)</div>
                    <div class="stat-value positive">${formatCurrency(summary.p95 || 0)}</div>
                </div>
            `;
            document.getElementById('projectionsInfo').innerHTML = infoHtml;

            // Render projections chart with confidence bands
            const ctx = document.getElementById('projectionsChart').getContext('2d');
            if (charts.projectionsChart) charts.projectionsChart.destroy();

            const projData = mc.projection_data || {};
            const percentiles = projData.percentiles || {};
            const years = projData.labels || Array.from({length: 11}, (_, i) => `Year ${i}`);
            const p5 = percentiles.p5 || [];
            const p25 = percentiles.p25 || [];
            const p50 = percentiles.p50 || [];
            const p75 = percentiles.p75 || [];
            const p95 = percentiles.p95 || [];

            charts.projectionsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: years,
                    datasets: [
                        {
                            label: '95th Percentile',
                            data: p95,
                            borderColor: 'rgba(48, 209, 88, 0.3)',
                            backgroundColor: 'transparent',
                            borderWidth: 1,
                            borderDash: [3, 3],
                            pointRadius: 0,
                            tension: 0.3
                        },
                        {
                            label: '75th Percentile',
                            data: p75,
                            borderColor: 'rgba(48, 209, 88, 0.6)',
                            backgroundColor: 'rgba(48, 209, 88, 0.1)',
                            borderWidth: 1.5,
                            fill: '+1',
                            pointRadius: 0,
                            tension: 0.3
                        },
                        {
                            label: 'Median (50th)',
                            data: p50,
                            borderColor: '#635bff',
                            backgroundColor: 'rgba(99, 91, 255, 0.15)',
                            borderWidth: 2.5,
                            fill: false,
                            pointRadius: 0,
                            pointHoverRadius: 6,
                            tension: 0.3
                        },
                        {
                            label: '25th Percentile',
                            data: p25,
                            borderColor: 'rgba(255, 159, 10, 0.6)',
                            backgroundColor: 'rgba(255, 159, 10, 0.1)',
                            borderWidth: 1.5,
                            fill: '-1',
                            pointRadius: 0,
                            tension: 0.3
                        },
                        {
                            label: '5th Percentile',
                            data: p5,
                            borderColor: 'rgba(255, 69, 58, 0.3)',
                            backgroundColor: 'transparent',
                            borderWidth: 1,
                            borderDash: [3, 3],
                            pointRadius: 0,
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { display: true, position: 'top', labels: { usePointStyle: true, padding: 15 } },
                        tooltip: {
                            backgroundColor: 'rgba(10, 37, 64, 0.95)',
                            titleFont: { size: 13, weight: '600' },
                            bodyFont: { size: 12 },
                            padding: 12,
                            cornerRadius: 8,
                            callbacks: {
                                label: ctx => `${ctx.dataset.label}: ${formatCurrency(ctx.raw)}`
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: '#e3e8ee', drawBorder: false },
                            ticks: { color: '#8898aa' }
                        },
                        y: {
                            grid: { color: '#e3e8ee', drawBorder: false },
                            ticks: {
                                color: '#8898aa',
                                callback: v => formatCurrency(v)
                            }
                        }
                    }
                }
            });

            // Render Monte Carlo summary
            const medianValue = summary.median || totalValue;
            const growthRate = Math.pow(medianValue / totalValue, 1/10) - 1;
            const probGain = summary.prob_gain !== undefined ? summary.prob_gain.toFixed(0) : '--';
            const probDouble = summary.prob_double !== undefined ? summary.prob_double.toFixed(0) : '--';
            const summaryHtml = `
                <div class="monte-carlo-grid">
                    <div class="monte-carlo-item">
                        <div class="monte-carlo-label">Simulations Run</div>
                        <div class="monte-carlo-value">${(mc.simulations || 1000).toLocaleString()}</div>
                    </div>
                    <div class="monte-carlo-item">
                        <div class="monte-carlo-label">Starting Value</div>
                        <div class="monte-carlo-value">${formatCurrency(mc.starting_value || totalValue)}</div>
                    </div>
                    <div class="monte-carlo-item">
                        <div class="monte-carlo-label">Worst Case (5th)</div>
                        <div class="monte-carlo-value">${formatCurrency(summary.p5 || 0)}</div>
                    </div>
                    <div class="monte-carlo-item">
                        <div class="monte-carlo-label">Probability of Gain</div>
                        <div class="monte-carlo-value positive">${probGain}%</div>
                    </div>
                    <div class="monte-carlo-item">
                        <div class="monte-carlo-label">Implied CAGR (Median)</div>
                        <div class="monte-carlo-value highlight">${(growthRate * 100).toFixed(1)}%</div>
                    </div>
                    <div class="monte-carlo-item">
                        <div class="monte-carlo-label">Chance to Double</div>
                        <div class="monte-carlo-value">${probDouble}%</div>
                    </div>
                </div>
            `;
            document.getElementById('monteCarloSummary').innerHTML = summaryHtml;
        }

        function renderLineChart(data, period = '5Y') {
            const ctx = document.getElementById('performanceChart').getContext('2d');
            if (charts.performanceChart) charts.performanceChart.destroy();

            const filteredData = filterChartDataByPeriod(data, period);

            // Downsample for performance
            const maxPoints = 150;
            const step = Math.max(1, Math.floor(filteredData.labels.length / maxPoints));
            const labels = filteredData.labels.filter((_, i) => i % step === 0);
            const portfolio = filteredData.portfolio.filter((_, i) => i % step === 0);

            // Benchmark configurations
            const benchmarkConfigs = {
                sp500: { label: 'S&P 500', color: '#8898aa', dash: [5, 5] },
                bonds: { label: 'US Bonds', color: '#30d158', dash: [3, 3] },
                world: { label: 'Total World', color: '#ff9f0a', dash: [8, 4] },
                sixty_forty: { label: '60/40', color: '#bf5af2', dash: [2, 2] }
            };

            // Build datasets
            const datasets = [{
                label: 'Portfolio', data: portfolio,
                borderColor: '#635bff', backgroundColor: 'rgba(99,91,255,0.1)',
                borderWidth: 2.5, fill: true, tension: 0.3,
                pointRadius: 0, pointHoverRadius: 6, pointHoverBackgroundColor: '#635bff'
            }];

            // Add visible benchmarks
            Object.entries(benchmarkConfigs).forEach(([key, config]) => {
                if (visibleBenchmarks[key] && filteredData[key]) {
                    const bmData = filteredData[key].filter((_, i) => i % step === 0);
                    datasets.push({
                        label: config.label, data: bmData,
                        borderColor: config.color, backgroundColor: 'transparent',
                        borderWidth: 2, borderDash: config.dash, fill: false, tension: 0.3,
                        pointRadius: 0, pointHoverRadius: 5, pointHoverBackgroundColor: config.color
                    });
                }
            });

            charts.performanceChart = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: { display: true, position: 'top', labels: { usePointStyle: true, padding: 20 } },
                        tooltip: {
                            enabled: true,
                            backgroundColor: 'rgba(10, 37, 64, 0.95)',
                            titleFont: { size: 13, weight: '600' },
                            bodyFont: { size: 12 },
                            padding: 12,
                            cornerRadius: 8,
                            displayColors: true,
                            callbacks: {
                                title: (items) => {
                                    const date = new Date(items[0].label);
                                    return date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
                                },
                                label: ctx => {
                                    const change = ctx.raw - 100;
                                    const sign = change >= 0 ? '+' : '';
                                    return `${ctx.dataset.label}: ${sign}${change.toFixed(2)}%`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: '#e3e8ee', drawBorder: false },
                            ticks: {
                                color: '#8898aa',
                                maxTicksLimit: 8,
                                callback: (v) => {
                                    const d = new Date(labels[v]);
                                    // Use more granular format for shorter periods
                                    if (period === '1M') {
                                        return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                                    } else if (period === '3M' || period === 'YTD') {
                                        return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                                    } else if (period === '6M' || period === '1Y') {
                                        return d.toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
                                    } else {
                                        return d.toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
                                    }
                                }
                            }
                        },
                        y: {
                            grid: { color: '#e3e8ee', drawBorder: false },
                            ticks: {
                                color: '#8898aa',
                                callback: (v) => (v - 100 >= 0 ? '+' : '') + (v - 100).toFixed(0) + '%'
                            }
                        }
                    }
                }
            });
        }

        function renderSectors() {
            const sectors = portfolioData.sector_exposure || {};
            const benchmark = portfolioData.sector_benchmark || {};
            const all = [...new Set([...Object.keys(sectors), ...Object.keys(benchmark)])].sort((a, b) => (sectors[b] || 0) - (sectors[a] || 0));

            document.getElementById('sectorList').innerHTML = all.map(s => {
                const p = sectors[s] || 0;
                const b = (benchmark[s] || 0) * 100;
                const max = Math.max(p, b, 30);
                return `
                    <div class="sector-item">
                        <div class="sector-name">${s}</div>
                        <div class="sector-bar-container">
                            <div class="sector-bar benchmark" style="width: ${(b / max * 100)}%"></div>
                            <div class="sector-bar portfolio" style="width: ${(p / max * 100)}%"></div>
                        </div>
                        <div class="sector-pct portfolio">${p.toFixed(1)}%</div>
                        <div class="sector-pct benchmark">${b.toFixed(1)}%</div>
                    </div>
                `;
            }).join('');

            renderDoughnut('sectorChart', sectors);
        }

        function renderGeography() {
            const geo = portfolioData.geography || {};
            const us = geo.US || 0;
            const dev = (geo['Developed Markets'] || 0) + (geo.Europe || 0) + (geo.Japan || 0) + (geo['Asia Pacific'] || 0);
            const em = (geo['Emerging Markets'] || 0) + (geo.China || 0) + (geo['Latin America'] || 0);

            document.getElementById('usPct').textContent = us.toFixed(1) + '%';
            document.getElementById('devPct').textContent = dev.toFixed(1) + '%';
            document.getElementById('emPct').textContent = em.toFixed(1) + '%';

            // Update map legend percentages
            document.getElementById('usMapPct').textContent = us.toFixed(0) + '%';
            document.getElementById('devMapPct').textContent = dev.toFixed(0) + '%';
            document.getElementById('emMapPct').textContent = em.toFixed(0) + '%';

            renderWorldMap(us, dev, em);
            renderDoughnut('geoChart', geo, {
                US: '#635bff', 'Developed Markets': '#a5b4fc', 'Emerging Markets': '#fbbf24',
                Europe: '#a78bfa', 'Asia Pacific': '#c4b5fd', Global: '#64d2ff',
                International: '#818cf8', Japan: '#6366f1', China: '#ef4444'
            });
        }

        async function renderWorldMap(us, dev, em) {
            const container = document.getElementById('worldMapContainer');
            container.innerHTML = '';

            // Country classifications
            const usCountries = ['United States of America', 'USA', 'United States'];
            const developedCountries = ['Canada', 'United Kingdom', 'Germany', 'France', 'Japan', 'Australia', 'New Zealand', 'Italy', 'Spain', 'Portugal', 'Netherlands', 'Belgium', 'Switzerland', 'Austria', 'Sweden', 'Norway', 'Denmark', 'Finland', 'Ireland', 'Singapore', 'Israel', 'South Korea', 'Luxembourg', 'Iceland'];
            const emergingCountries = ['China', 'India', 'Brazil', 'Mexico', 'Russia', 'South Africa', 'Indonesia', 'Turkey', 'Thailand', 'Malaysia', 'Philippines', 'Vietnam', 'Poland', 'Czech Republic', 'Czechia', 'Hungary', 'Chile', 'Colombia', 'Peru', 'Argentina', 'Taiwan', 'Saudi Arabia', 'United Arab Emirates', 'Qatar', 'Kuwait', 'Egypt', 'Pakistan', 'Bangladesh', 'Nigeria', 'Greece'];

            function getCountryClass(name) {
                if (us > 5 && usCountries.some(c => name.includes(c) || c.includes(name))) return 'country us';
                if (dev > 5 && developedCountries.some(c => name.includes(c) || c.includes(name))) return 'country developed';
                if (em > 5 && emergingCountries.some(c => name.includes(c) || c.includes(name))) return 'country emerging';
                return 'country';
            }

            try {
                // Fetch world topology data
                const response = await fetch('https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json');
                const world = await response.json();

                const width = 900;
                const height = 450;

                const svg = d3.select(container)
                    .append('svg')
                    .attr('viewBox', `0 0 ${width} ${height}`)
                    .attr('preserveAspectRatio', 'xMidYMid meet');

                const projection = d3.geoNaturalEarth1()
                    .scale(170)
                    .translate([width / 2, height / 2]);

                const path = d3.geoPath().projection(projection);

                const countries = topojson.feature(world, world.objects.countries);

                svg.selectAll('path')
                    .data(countries.features)
                    .enter()
                    .append('path')
                    .attr('d', path)
                    .attr('class', d => getCountryClass(d.properties.name || ''))
                    .append('title')
                    .text(d => d.properties.name || '');

            } catch (error) {
                console.error('Failed to load map:', error);
                container.innerHTML = '<p style="text-align:center;color:#8898aa;padding:40px;">Map unavailable</p>';
            }
        }

        function renderRisk() {
            const risk = portfolioData.risk_metrics || {};
            const conc = portfolioData.concentration || {};
            const scenarios = portfolioData.scenario_analysis?.scenarios || [];

            document.getElementById('volatilityVal').textContent = risk.volatility !== null ? risk.volatility.toFixed(1) + '%' : '--';
            document.getElementById('betaVal').textContent = risk.beta !== null ? risk.beta.toFixed(2) : '--';
            document.getElementById('sharpeVal').textContent = risk.sharpe_ratio !== null ? risk.sharpe_ratio.toFixed(2) : '--';
            document.getElementById('maxDdVal').textContent = risk.max_drawdown !== null ? risk.max_drawdown.toFixed(1) + '%' : '--';

            document.getElementById('top10Pct').textContent = (conc.top_10_pct || 0).toFixed(1) + '%';
            document.getElementById('topHoldingsList').innerHTML = (conc.top_10_holdings || []).map((h, i) => `
                <div class="holding-item">
                    <div class="holding-rank">${i + 1}</div>
                    <div class="holding-info"><div class="holding-symbol">${h.symbol}</div></div>
                    <div class="holding-values">
                        <div class="holding-amount">${formatCurrency(h.value)}</div>
                        <div class="holding-pct">${h.pct.toFixed(1)}%</div>
                    </div>
                </div>
            `).join('');

            document.getElementById('scenariosList').innerHTML = scenarios.map(s => {
                const isPositive = s.portfolio_impact >= 0;
                const barWidth = Math.min(Math.abs(s.portfolio_impact) * 2, 100);
                return `
                    <div class="scenario-card">
                        <div class="scenario-info">
                            <h4>${s.name}</h4>
                            <p>${s.description}</p>
                        </div>
                        <div class="scenario-impact">
                            <div class="scenario-pct ${isPositive ? 'positive' : 'negative'}">${isPositive ? '+' : ''}${s.portfolio_impact.toFixed(1)}%</div>
                            <div class="scenario-value">${formatCurrency(s.value_change)}</div>
                        </div>
                        <div class="scenario-bar-container">
                            <div class="scenario-bar ${isPositive ? 'positive' : 'negative'}" style="width: ${barWidth}%"></div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderHoldings() {
            const positions = portfolioData.positions || [];
            const total = portfolioData.total_value || 0;
            const sorted = [...positions].sort((a, b) => (b.value || 0) - (a.value || 0));

            document.getElementById('holdingsBody').innerHTML = sorted.map(p => {
                const cls = p.classification || {};
                const weight = total > 0 ? (p.value || 0) / total * 100 : 0;
                return `
                    <tr>
                        <td class="symbol-cell">${p.symbol}</td>
                        <td>${p.description || '-'}</td>
                        <td><span class="badge badge-primary">${cls.asset_class || 'Unknown'}</span></td>
                        <td><span class="badge badge-secondary">${cls.sector || 'Unknown'}</span></td>
                        <td class="text-right font-mono">${formatNumber(p.shares)}</td>
                        <td class="text-right font-mono">${formatCurrency(p.price)}</td>
                        <td class="text-right font-mono">${formatCurrency(p.value)}</td>
                        <td class="text-right font-mono">${weight.toFixed(2)}%</td>
                    </tr>
                `;
            }).join('') + `
                <tr class="total-row">
                    <td colspan="6" class="text-right">Total Portfolio Value</td>
                    <td class="text-right font-mono">${formatCurrency(total)}</td>
                    <td class="text-right font-mono">100%</td>
                </tr>
            `;
        }

        function renderDoughnut(id, data, colors = null) {
            const ctx = document.getElementById(id).getContext('2d');
            if (charts[id]) charts[id].destroy();

            const labels = Object.keys(data).filter(k => data[k] > 0);
            const values = labels.map(k => data[k]);
            const defaultColors = ['#635bff', '#30d158', '#ff9f0a', '#bf5af2', '#ff453a', '#64d2ff', '#ffd60a', '#8e8e93'];
            const bgColors = colors ? labels.map((l, i) => colors[l] || defaultColors[i % defaultColors.length]) : defaultColors;

            charts[id] = new Chart(ctx, {
                type: 'doughnut',
                data: { labels, datasets: [{ data: values, backgroundColor: bgColors, borderWidth: 0 }] },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right', labels: { padding: 16, usePointStyle: true, font: { size: 12 } } },
                        tooltip: { callbacks: { label: ctx => `${ctx.label}: ${ctx.raw.toFixed(1)}%` } }
                    }
                }
            });
        }

        function downloadCSV() {
            if (!portfolioData?.positions) return;
            let csv = 'Symbol,Description,Asset Class,Sub Class,Sector,Geography,Shares,Price,Value,Weight\n';
            const total = portfolioData.total_value || 0;
            portfolioData.positions.forEach(p => {
                const c = p.classification || {};
                const w = total > 0 ? (p.value || 0) / total * 100 : 0;
                csv += [p.symbol, `"${(p.description || '').replace(/"/g, '""')}"`, c.asset_class || '', c.sub_class || '', c.sector || '', c.geography || '', p.shares || '', p.price || '', p.value || '', w.toFixed(2) + '%'].join(',') + '\n';
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'portfolio_analysis.csv';
            a.click();
        }

        function resetUI() {
            dashboard.style.display = 'none';
            uploadSection.style.display = 'block';
            portfolioData = null;
            Object.values(charts).forEach(c => c.destroy());
            charts = {};
        }

        function showProgress(text) {
            progressSection.style.display = 'block';
            progressText.textContent = text;
            uploadSection.style.display = 'none';
        }

        function hideProgress() {
            progressSection.style.display = 'none';
            uploadSection.style.display = 'block';
        }

        function showError(msg) {
            errorMessage.textContent = msg;
            errorMessage.style.display = 'block';
        }

        function hideError() {
            errorMessage.style.display = 'none';
        }

        function formatNumber(n) {
            return n == null ? '-' : n.toLocaleString('en-US', { maximumFractionDigits: 4 });
        }

        function formatCurrency(n) {
            return n == null ? '-' : '$' + n.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        // Entry Method Switching
        function switchEntryMethod(method) {
            // Update buttons
            document.querySelectorAll('.entry-method-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.method === method);
            });

            // Update panels
            document.querySelectorAll('.entry-panel').forEach(panel => {
                panel.classList.remove('active');
            });

            const panelMap = {
                'upload': 'uploadPanel',
                'manual': 'manualPanel',
                'connect': 'connectPanel'
            };
            document.getElementById(panelMap[method])?.classList.add('active');
        }

        // Manual Holdings Entry
        let manualHoldings = [];

        function addManualHolding() {
            const symbolInput = document.getElementById('manualSymbol');
            const sharesInput = document.getElementById('manualShares');
            const priceInput = document.getElementById('manualPrice');

            const symbol = symbolInput.value.trim().toUpperCase();
            const shares = parseFloat(sharesInput.value);
            const price = parseFloat(priceInput.value);

            if (!symbol) {
                symbolInput.focus();
                return;
            }
            if (isNaN(shares) || shares <= 0) {
                sharesInput.focus();
                return;
            }
            if (isNaN(price) || price <= 0) {
                priceInput.focus();
                return;
            }

            // Check for duplicate
            const existing = manualHoldings.findIndex(h => h.symbol === symbol);
            if (existing >= 0) {
                // Update existing
                manualHoldings[existing].shares += shares;
                manualHoldings[existing].price = price;
                manualHoldings[existing].value = manualHoldings[existing].shares * price;
            } else {
                // Add new
                manualHoldings.push({
                    symbol,
                    shares,
                    price,
                    value: shares * price,
                    description: symbol
                });
            }

            // Clear inputs
            symbolInput.value = '';
            sharesInput.value = '';
            priceInput.value = '';
            symbolInput.focus();

            renderManualHoldings();
        }

        function removeManualHolding(index) {
            manualHoldings.splice(index, 1);
            renderManualHoldings();
        }

        function clearManualHoldings() {
            manualHoldings = [];
            renderManualHoldings();
        }

        function renderManualHoldings() {
            const list = document.getElementById('manualHoldingsList');
            const empty = document.getElementById('holdingsEmpty');
            const totalEl = document.getElementById('manualTotal');
            const analyzeBtn = document.getElementById('analyzeManualBtn');

            // Calculate total
            const total = manualHoldings.reduce((sum, h) => sum + h.value, 0);
            totalEl.textContent = formatCurrency(total);

            // Enable/disable analyze button
            analyzeBtn.disabled = manualHoldings.length === 0;

            // Render list
            if (manualHoldings.length === 0) {
                empty.style.display = 'block';
                // Remove any existing items
                list.querySelectorAll('.holdings-list-item').forEach(el => el.remove());
                return;
            }

            empty.style.display = 'none';

            // Build items HTML
            const itemsHtml = manualHoldings.map((h, i) => `
                <div class="holdings-list-item">
                    <span class="holding-symbol">${h.symbol}</span>
                    <span class="holding-value">${formatNumber(h.shares)}</span>
                    <span class="holding-value">${formatCurrency(h.price)}</span>
                    <span class="holding-total">${formatCurrency(h.value)}</span>
                    <button class="btn-remove" onclick="removeManualHolding(${i})" title="Remove">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                </div>
            `).join('');

            // Update list (keep header)
            list.querySelectorAll('.holdings-list-item').forEach(el => el.remove());
            list.insertAdjacentHTML('beforeend', itemsHtml);
        }

        async function analyzeManualHoldings() {
            if (manualHoldings.length === 0) return;

            showProgress('Analyzing portfolio...');
            try {
                const res = await fetch(`${API_URL}/analyze`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ positions: manualHoldings, include_risk: true })
                });
                if (!res.ok) throw new Error('Analysis failed');
                portfolioData = await res.json();
                hideProgress();
                hideError();
                showDashboard();
            } catch (err) {
                hideProgress();
                showError('Analysis failed: ' + err.message);
            }
        }
    </script>
</body>
</html>
