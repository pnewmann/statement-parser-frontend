<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio Analytics</title>
    <link rel="icon" href="favicon.svg" type="image/svg+xml">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://d3js.org/topojson.v3.min.js"></script>
    <style>
        :root {
            --primary: #635bff;
            --primary-dark: #5851db;
            --primary-light: #7a73ff;
            --success: #30d158;
            --danger: #ff453a;
            --warning: #ffd60a;
            --text-primary: #0a2540;
            --text-secondary: #425466;
            --text-muted: #8898aa;
            --bg-primary: #ffffff;
            --bg-secondary: #f6f9fc;
            --bg-tertiary: #e3e8ee;
            --border: #e3e8ee;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.04);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
            --shadow-lg: 0 8px 24px rgba(0,0,0,0.12);
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 16px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-secondary);
            color: var(--text-primary);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 24px;
        }

        /* Header */
        header {
            text-align: center;
            margin-bottom: 48px;
        }

        .logo {
            display: inline-flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo-icon svg {
            width: 24px;
            height: 24px;
            color: white;
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: -0.02em;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 1.125rem;
            margin-top: 8px;
        }

        /* Cards */
        .card {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
            padding: 24px;
            transition: box-shadow 0.2s, transform 0.2s;
        }

        .card:hover {
            box-shadow: var(--shadow-md);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Upload Section */
        .upload-card {
            max-width: 600px;
            margin: 0 auto;
            padding: 48px;
            text-align: center;
        }

        .upload-card.dragover {
            border-color: var(--primary);
            background: rgba(99, 91, 255, 0.04);
        }

        .upload-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 24px;
            background: var(--bg-secondary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .upload-icon svg {
            width: 28px;
            height: 28px;
            color: var(--primary);
        }

        .upload-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .upload-hint {
            color: var(--text-muted);
            font-size: 0.875rem;
            margin-bottom: 24px;
        }

        #fileInput {
            display: none;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 24px;
            font-size: 0.9375rem;
            font-weight: 600;
            border-radius: var(--radius-md);
            border: none;
            cursor: pointer;
            transition: all 0.15s ease;
            text-decoration: none;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-secondary {
            background: var(--bg-primary);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--bg-secondary);
            border-color: var(--text-muted);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Account List */
        .accounts-section {
            margin-top: 32px;
        }

        .accounts-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .accounts-header h3 {
            font-size: 1rem;
            font-weight: 600;
        }

        .account-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            margin-bottom: 8px;
        }

        .account-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.875rem;
        }

        .account-details {
            flex: 1;
        }

        .account-name-input {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 8px 12px;
            font-size: 0.9375rem;
            color: var(--text-primary);
            font-family: inherit;
        }

        .account-name-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 91, 255, 0.1);
        }

        .account-meta {
            color: var(--text-muted);
            font-size: 0.8125rem;
            margin-top: 4px;
        }

        .account-value {
            font-weight: 600;
            font-size: 1.125rem;
            color: var(--success);
        }

        .remove-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 8px;
            border-radius: var(--radius-sm);
            transition: all 0.15s;
        }

        .remove-btn:hover {
            background: rgba(255, 69, 58, 0.1);
            color: var(--danger);
        }

        .actions-row {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        /* Progress */
        .progress-section {
            display: none;
            text-align: center;
            padding: 80px 40px;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 24px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .progress-text {
            color: var(--text-secondary);
            font-size: 1rem;
        }

        /* Error */
        .error-message {
            background: rgba(255, 69, 58, 0.08);
            border: 1px solid rgba(255, 69, 58, 0.2);
            color: var(--danger);
            padding: 16px 20px;
            border-radius: var(--radius-md);
            margin-bottom: 24px;
            display: none;
            font-size: 0.9375rem;
        }

        /* Dashboard */
        .dashboard {
            display: none;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .dashboard-title {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .dashboard-title h2 {
            font-size: 1.75rem;
            font-weight: 700;
        }

        .total-badge {
            background: linear-gradient(135deg, var(--success) 0%, #28a745 100%);
            color: white;
            padding: 8px 20px;
            border-radius: 100px;
            font-weight: 600;
            font-size: 1.125rem;
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 4px;
            background: var(--bg-primary);
            padding: 4px;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
            margin-bottom: 32px;
            overflow-x: auto;
        }

        .tab {
            padding: 12px 20px;
            font-size: 0.9375rem;
            font-weight: 500;
            color: var(--text-secondary);
            background: transparent;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.15s;
            white-space: nowrap;
        }

        .tab:hover {
            color: var(--text-primary);
            background: var(--bg-secondary);
        }

        .tab.active {
            background: var(--primary);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: var(--bg-primary);
            border-radius: var(--radius-md);
            padding: 20px;
            border: 1px solid var(--border);
        }

        .stat-label {
            font-size: 0.8125rem;
            font-weight: 500;
            color: var(--text-muted);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .stat-value.positive {
            color: var(--success);
        }

        .stat-value.negative {
            color: var(--danger);
        }

        .stat-subtitle {
            font-size: 0.8125rem;
            color: var(--text-muted);
            margin-top: 4px;
        }

        /* Charts */
        .chart-card {
            margin-bottom: 24px;
        }

        .chart-wrapper {
            position: relative;
            height: 320px;
        }

        .charts-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 24px;
            margin-bottom: 24px;
        }

        /* Performance Returns */
        .period-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .period-btn {
            padding: 10px 20px;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-secondary);
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.15s;
        }

        .period-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .period-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .returns-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-bottom: 32px;
        }

        .return-card {
            text-align: center;
            padding: 20px 16px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .return-card:hover {
            border-color: var(--primary);
        }

        .return-card.active {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 91, 255, 0.1);
        }

        .return-card .stat-value {
            font-size: 1.5rem;
        }

        .benchmark-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 8px;
        }

        /* World Map */
        .map-container {
            position: relative;
            padding: 24px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
        }

        #worldMapContainer {
            width: 100%;
            max-width: 900px;
            margin: 0 auto;
        }

        #worldMapContainer svg {
            width: 100%;
            height: auto;
            display: block;
        }

        .country {
            fill: #dce3eb;
            stroke: #fff;
            stroke-width: 0.4;
            transition: fill 0.2s;
        }

        .country:hover {
            opacity: 0.85;
        }

        .country.us { fill: var(--primary); }
        .country.developed { fill: #a5b4fc; }
        .country.emerging { fill: #fbbf24; }

        .map-legend {
            display: flex;
            justify-content: center;
            gap: 32px;
            margin-top: 24px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9375rem;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .legend-dot {
            width: 14px;
            height: 14px;
            border-radius: 4px;
        }

        .legend-dot.us { background: var(--primary); }
        .legend-dot.developed { background: #a5b4fc; }
        .legend-dot.emerging { background: #fbbf24; }

        /* Scenario Analysis */
        .scenarios-container {
            display: grid;
            gap: 16px;
        }

        .scenario-card {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 16px;
            align-items: center;
        }

        .scenario-info h4 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .scenario-info p {
            font-size: 0.8125rem;
            color: var(--text-muted);
        }

        .scenario-impact {
            text-align: right;
        }

        .scenario-pct {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .scenario-pct.positive { color: var(--success); }
        .scenario-pct.negative { color: var(--danger); }

        .scenario-value {
            font-size: 0.8125rem;
            color: var(--text-muted);
        }

        .scenario-bar-container {
            grid-column: 1 / -1;
            height: 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }

        .scenario-bar {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .scenario-bar.positive { background: var(--success); }
        .scenario-bar.negative { background: var(--danger); }

        /* Sector Comparison */
        .sector-list {
            display: grid;
            gap: 16px;
        }

        .sector-item {
            display: grid;
            grid-template-columns: 140px 1fr 70px 70px;
            gap: 16px;
            align-items: center;
        }

        .sector-name {
            font-size: 0.9375rem;
            font-weight: 500;
        }

        .sector-bar-container {
            position: relative;
            height: 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
            overflow: hidden;
        }

        .sector-bar {
            position: absolute;
            height: 100%;
            border-radius: 4px;
        }

        .sector-bar.portfolio {
            background: var(--primary);
            z-index: 2;
        }

        .sector-bar.benchmark {
            background: var(--bg-tertiary);
            z-index: 1;
        }

        .sector-pct {
            font-size: 0.875rem;
            text-align: right;
            font-weight: 500;
            font-variant-numeric: tabular-nums;
        }

        .sector-pct.portfolio { color: var(--primary); }
        .sector-pct.benchmark { color: var(--text-muted); }

        /* Risk Cards */
        .risk-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px;
            margin-bottom: 32px;
        }

        .risk-card {
            text-align: center;
            padding: 28px 20px;
        }

        .risk-value {
            font-size: 2.25rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .risk-label {
            font-size: 0.9375rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .risk-desc {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* Holdings Table */
        .table-container {
            overflow-x: auto;
            border-radius: var(--radius-md);
            border: 1px solid var(--border);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9375rem;
        }

        th, td {
            padding: 14px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        th {
            background: var(--bg-secondary);
            font-weight: 600;
            font-size: 0.8125rem;
            text-transform: uppercase;
            letter-spacing: 0.03em;
            color: var(--text-secondary);
        }

        tbody tr:hover {
            background: var(--bg-secondary);
        }

        tbody tr:last-child td {
            border-bottom: none;
        }

        .text-right {
            text-align: right;
        }

        .font-mono {
            font-variant-numeric: tabular-nums;
        }

        .symbol-cell {
            font-weight: 600;
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 100px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .badge-primary {
            background: rgba(99, 91, 255, 0.1);
            color: var(--primary);
        }

        .badge-secondary {
            background: var(--bg-secondary);
            color: var(--text-secondary);
        }

        .total-row {
            background: var(--bg-secondary);
            font-weight: 600;
        }

        /* Top Holdings */
        .holdings-list {
            display: grid;
            gap: 12px;
        }

        .holding-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }

        .holding-item:last-child {
            border-bottom: none;
        }

        .holding-rank {
            width: 28px;
            height: 28px;
            background: var(--bg-secondary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8125rem;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .holding-info {
            flex: 1;
        }

        .holding-symbol {
            font-weight: 600;
        }

        .holding-values {
            text-align: right;
        }

        .holding-amount {
            font-weight: 600;
        }

        .holding-pct {
            font-size: 0.8125rem;
            color: var(--text-muted);
        }

        /* Footer */
        footer {
            text-align: center;
            padding: 40px 0;
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 24px 16px;
            }

            h1 {
                font-size: 1.75rem;
            }

            .upload-card {
                padding: 32px 24px;
            }

            .charts-row {
                grid-template-columns: 1fr;
            }

            .sector-item {
                grid-template-columns: 100px 1fr 60px 60px;
                gap: 8px;
            }

            .tabs {
                padding: 3px;
            }

            .tab {
                padding: 10px 14px;
                font-size: 0.875rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <div class="logo-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                    </svg>
                </div>
            </div>
            <h1>Portfolio Analytics</h1>
            <p class="subtitle">Professional-grade portfolio analysis and risk assessment</p>
        </header>

        <div class="error-message" id="errorMessage"></div>

        <!-- Upload Section -->
        <div id="uploadSection">
            <div class="card upload-card" id="dropZone">
                <div class="upload-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="17 8 12 3 7 8"/>
                        <line x1="12" y1="3" x2="12" y2="15"/>
                    </svg>
                </div>
                <div class="upload-title">Upload brokerage statements</div>
                <p class="upload-hint">Drag and drop PDF or CSV files, or click to browse</p>
                <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                    Select Files
                </button>
                <input type="file" id="fileInput" accept=".pdf,.csv" multiple>
            </div>

            <div class="accounts-section" id="accountsSection" style="display: none;">
                <div class="accounts-header">
                    <h3>Uploaded Accounts</h3>
                    <button class="btn btn-secondary" id="addMoreBtn">Add More</button>
                </div>
                <div id="accountsList"></div>
                <div class="actions-row">
                    <button class="btn btn-primary" id="analyzeBtn" disabled>Analyze Portfolio</button>
                    <button class="btn btn-secondary" id="clearAllBtn">Clear All</button>
                </div>
            </div>
        </div>

        <!-- Progress -->
        <div class="progress-section" id="progressSection">
            <div class="spinner"></div>
            <p class="progress-text" id="progressText">Analyzing your portfolio...</p>
        </div>

        <!-- Dashboard -->
        <div class="dashboard" id="dashboard">
            <div class="dashboard-header">
                <div class="dashboard-title">
                    <h2>Portfolio Analysis</h2>
                    <span class="total-badge" id="totalBadge">$0</span>
                </div>
                <div class="header-actions">
                    <button class="btn btn-secondary" id="newAnalysisBtn">New Analysis</button>
                    <button class="btn btn-primary" id="downloadBtn">Download CSV</button>
                </div>
            </div>

            <div class="tabs">
                <button class="tab active" data-tab="allocation">Allocation</button>
                <button class="tab" data-tab="performance">Performance</button>
                <button class="tab" data-tab="sectors">Sectors</button>
                <button class="tab" data-tab="geography">Geography</button>
                <button class="tab" data-tab="risk">Risk</button>
                <button class="tab" data-tab="holdings">Holdings</button>
            </div>

            <!-- Allocation Tab -->
            <div class="tab-content active" id="tab-allocation">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Stocks</div>
                        <div class="stat-value" id="stocksPct">0%</div>
                        <div class="stat-subtitle" id="stocksVal">$0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Bonds</div>
                        <div class="stat-value" id="bondsPct">0%</div>
                        <div class="stat-subtitle" id="bondsVal">$0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Cash</div>
                        <div class="stat-value" id="cashPct">0%</div>
                        <div class="stat-subtitle" id="cashVal">$0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Alternatives</div>
                        <div class="stat-value" id="altsPct">0%</div>
                        <div class="stat-subtitle" id="altsVal">$0</div>
                    </div>
                </div>
                <div class="charts-row">
                    <div class="card chart-card">
                        <div class="card-title">Asset Allocation</div>
                        <div class="chart-wrapper">
                            <canvas id="allocationChart"></canvas>
                        </div>
                    </div>
                    <div class="card chart-card">
                        <div class="card-title">Sub-Asset Breakdown</div>
                        <div class="chart-wrapper">
                            <canvas id="subClassChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Performance Tab -->
            <div class="tab-content" id="tab-performance">
                <div class="returns-grid" id="returnsGrid"></div>
                <div class="card chart-card">
                    <div class="card-header">
                        <div class="card-title">Historical Performance vs S&P 500</div>
                        <div class="period-selector" id="periodSelector">
                            <button class="period-btn" data-period="1M">1M</button>
                            <button class="period-btn" data-period="3M">3M</button>
                            <button class="period-btn" data-period="6M">6M</button>
                            <button class="period-btn" data-period="YTD">YTD</button>
                            <button class="period-btn" data-period="1Y">1Y</button>
                            <button class="period-btn" data-period="3Y">3Y</button>
                            <button class="period-btn active" data-period="5Y">5Y</button>
                        </div>
                    </div>
                    <div class="chart-wrapper" style="height: 380px;">
                        <canvas id="performanceChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Sectors Tab -->
            <div class="tab-content" id="tab-sectors">
                <div class="card" style="margin-bottom: 24px;">
                    <div class="card-header">
                        <div class="card-title">Sector Exposure vs S&P 500 Benchmark</div>
                        <div style="display: flex; gap: 16px; font-size: 0.8125rem;">
                            <span><span style="display: inline-block; width: 12px; height: 12px; background: var(--primary); border-radius: 2px; margin-right: 6px;"></span>Portfolio</span>
                            <span><span style="display: inline-block; width: 12px; height: 12px; background: var(--bg-tertiary); border-radius: 2px; margin-right: 6px;"></span>S&P 500</span>
                        </div>
                    </div>
                    <div class="sector-list" id="sectorList"></div>
                </div>
                <div class="card chart-card">
                    <div class="card-title">Sector Distribution</div>
                    <div class="chart-wrapper">
                        <canvas id="sectorChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Geography Tab -->
            <div class="tab-content" id="tab-geography">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">United States</div>
                        <div class="stat-value" id="usPct">0%</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Developed Markets</div>
                        <div class="stat-value" id="devPct">0%</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Emerging Markets</div>
                        <div class="stat-value" id="emPct">0%</div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-title">Geographic Allocation</div>
                    <div class="map-container">
                        <div id="worldMapContainer"></div>
                        <div class="map-legend">
                            <div class="legend-item"><div class="legend-dot us"></div><span>United States <strong id="usMapPct">0%</strong></span></div>
                            <div class="legend-item"><div class="legend-dot developed"></div><span>Developed <strong id="devMapPct">0%</strong></span></div>
                            <div class="legend-item"><div class="legend-dot emerging"></div><span>Emerging <strong id="emMapPct">0%</strong></span></div>
                        </div>
                    </div>
                </div>
                <div class="card chart-card" style="margin-top: 24px;">
                    <div class="card-title">Regional Breakdown</div>
                    <div class="chart-wrapper">
                        <canvas id="geoChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Risk Tab -->
            <div class="tab-content" id="tab-risk">
                <div class="risk-grid">
                    <div class="card risk-card">
                        <div class="risk-value" id="volatilityVal">--</div>
                        <div class="risk-label">Volatility</div>
                        <div class="risk-desc">Annualized standard deviation</div>
                    </div>
                    <div class="card risk-card">
                        <div class="risk-value" id="betaVal">--</div>
                        <div class="risk-label">Beta</div>
                        <div class="risk-desc">Sensitivity to market</div>
                    </div>
                    <div class="card risk-card">
                        <div class="risk-value" id="sharpeVal">--</div>
                        <div class="risk-label">Sharpe Ratio</div>
                        <div class="risk-desc">Risk-adjusted return</div>
                    </div>
                    <div class="card risk-card">
                        <div class="risk-value negative" id="maxDdVal">--</div>
                        <div class="risk-label">Max Drawdown</div>
                        <div class="risk-desc">Largest peak-to-trough</div>
                    </div>
                </div>

                <div class="card" style="margin-bottom: 24px;">
                    <div class="card-header">
                        <div class="card-title">Concentration Risk</div>
                    </div>
                    <div class="stats-grid" style="margin-bottom: 20px;">
                        <div class="stat-card">
                            <div class="stat-label">Top 10 Holdings</div>
                            <div class="stat-value" id="top10Pct">0%</div>
                            <div class="stat-subtitle">of total portfolio</div>
                        </div>
                    </div>
                    <div class="holdings-list" id="topHoldingsList"></div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Scenario Analysis</div>
                    </div>
                    <p style="color: var(--text-muted); font-size: 0.875rem; margin-bottom: 20px;">
                        Estimated portfolio impact under various market conditions
                    </p>
                    <div class="scenarios-container" id="scenariosList"></div>
                </div>
            </div>

            <!-- Holdings Tab -->
            <div class="tab-content" id="tab-holdings">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Symbol</th>
                                <th>Description</th>
                                <th>Asset Class</th>
                                <th>Sector</th>
                                <th class="text-right">Shares</th>
                                <th class="text-right">Price</th>
                                <th class="text-right">Value</th>
                                <th class="text-right">Weight</th>
                            </tr>
                        </thead>
                        <tbody id="holdingsBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <footer>
            <p>Supports Schwab, Fidelity, Vanguard, and most major brokerage statements</p>
        </footer>
    </div>

    <script>
        const API_URL = 'https://statement-parser-backend-yg0a.onrender.com';

        let accounts = [];
        let portfolioData = null;
        let charts = {};

        // DOM Elements
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const accountsSection = document.getElementById('accountsSection');
        const accountsList = document.getElementById('accountsList');
        const addMoreBtn = document.getElementById('addMoreBtn');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const clearAllBtn = document.getElementById('clearAllBtn');
        const progressSection = document.getElementById('progressSection');
        const progressText = document.getElementById('progressText');
        const dashboard = document.getElementById('dashboard');
        const errorMessage = document.getElementById('errorMessage');
        const uploadSection = document.getElementById('uploadSection');

        // Event Listeners
        dropZone.addEventListener('click', (e) => {
            if (e.target.closest('button')) return;
            fileInput.click();
        });
        addMoreBtn.addEventListener('click', () => fileInput.click());

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });

        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
            fileInput.value = '';
        });

        analyzeBtn.addEventListener('click', analyzePortfolio);
        clearAllBtn.addEventListener('click', () => { accounts = []; renderAccounts(); });
        document.getElementById('newAnalysisBtn').addEventListener('click', resetUI);
        document.getElementById('downloadBtn').addEventListener('click', downloadCSV);

        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
            });
        });

        async function handleFiles(files) {
            for (const file of files) {
                const ext = file.name.split('.').pop().toLowerCase();
                if (!['pdf', 'csv'].includes(ext)) {
                    showError(`${file.name}: Only PDF and CSV files supported`);
                    continue;
                }
                showProgress(`Parsing ${file.name}...`);
                try {
                    const result = await parseFile(file);
                    if (result.error && !result.positions?.length) {
                        hideProgress();
                        showError(`${file.name}: ${result.error}`);
                        continue;
                    }
                    accounts.push({
                        id: Date.now() + Math.random(),
                        name: getBrokerageName(result.brokerage),
                        positions: result.positions,
                        brokerage: result.brokerage,
                        totalValue: result.positions.reduce((s, p) => s + (p.value || 0), 0)
                    });
                    hideProgress();
                    hideError();
                    renderAccounts();
                } catch (err) {
                    hideProgress();
                    showError(`${file.name}: ${err.message}`);
                }
            }
        }

        function getBrokerageName(brokerage) {
            const names = { schwab: 'Schwab', fidelity: 'Fidelity', vanguard: 'Vanguard', csv: 'Account' };
            const base = names[brokerage] || 'Account';
            const count = accounts.filter(a => a.name.startsWith(base)).length + 1;
            return count > 1 ? `${base} ${count}` : base;
        }

        async function parseFile(file) {
            const formData = new FormData();
            formData.append('file', file);
            const res = await fetch(`${API_URL}/parse`, { method: 'POST', body: formData });
            return res.json();
        }

        function renderAccounts() {
            accountsSection.style.display = accounts.length ? 'block' : 'none';
            analyzeBtn.disabled = !accounts.length;
            accountsList.innerHTML = accounts.map(a => `
                <div class="account-item">
                    <div class="account-icon">${a.brokerage[0].toUpperCase()}</div>
                    <div class="account-details">
                        <input type="text" class="account-name-input" value="${a.name}" onchange="updateName(${a.id}, this.value)">
                        <div class="account-meta">${a.positions.length} positions</div>
                    </div>
                    <div class="account-value">${formatCurrency(a.totalValue)}</div>
                    <button class="remove-btn" onclick="removeAccount(${a.id})">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                </div>
            `).join('');
        }

        function updateName(id, name) {
            const acc = accounts.find(a => a.id === id);
            if (acc) acc.name = name;
        }

        function removeAccount(id) {
            accounts = accounts.filter(a => a.id !== id);
            renderAccounts();
        }

        function aggregatePositions() {
            const agg = {};
            accounts.forEach(acc => {
                acc.positions.forEach(pos => {
                    if (!agg[pos.symbol]) agg[pos.symbol] = { ...pos, shares: 0, value: 0 };
                    agg[pos.symbol].shares += pos.shares || 0;
                    agg[pos.symbol].value += pos.value || 0;
                    if (!agg[pos.symbol].description && pos.description) agg[pos.symbol].description = pos.description;
                });
            });
            Object.values(agg).forEach(p => { if (p.shares > 0) p.price = p.value / p.shares; });
            return Object.values(agg);
        }

        async function analyzePortfolio() {
            if (!accounts.length) return;
            showProgress('Analyzing portfolio...');
            try {
                const res = await fetch(`${API_URL}/analyze`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ positions: aggregatePositions(), include_risk: true })
                });
                if (!res.ok) throw new Error('Analysis failed');
                portfolioData = await res.json();
                hideProgress();
                hideError();
                showDashboard();
            } catch (err) {
                hideProgress();
                showError('Analysis failed: ' + err.message);
            }
        }

        function showDashboard() {
            uploadSection.style.display = 'none';
            dashboard.style.display = 'block';
            document.getElementById('totalBadge').textContent = formatCurrency(portfolioData.total_value);
            renderAllocation();
            renderPerformance();
            renderSectors();
            renderGeography();
            renderRisk();
            renderHoldings();
        }

        function renderAllocation() {
            const alloc = portfolioData.asset_allocation || {};
            const vals = portfolioData.asset_allocation_values || {};
            const stocks = alloc.Stocks || 0;
            const bonds = alloc.Bonds || 0;
            const cash = alloc.Cash || 0;
            const alts = (alloc['Real Estate'] || 0) + (alloc.Crypto || 0) + (alloc.Commodities || 0);

            document.getElementById('stocksPct').textContent = stocks.toFixed(1) + '%';
            document.getElementById('bondsPct').textContent = bonds.toFixed(1) + '%';
            document.getElementById('cashPct').textContent = cash.toFixed(1) + '%';
            document.getElementById('altsPct').textContent = alts.toFixed(1) + '%';
            document.getElementById('stocksVal').textContent = formatCurrency(vals.Stocks || 0);
            document.getElementById('bondsVal').textContent = formatCurrency(vals.Bonds || 0);
            document.getElementById('cashVal').textContent = formatCurrency(vals.Cash || 0);
            document.getElementById('altsVal').textContent = formatCurrency((vals['Real Estate'] || 0) + (vals.Crypto || 0) + (vals.Commodities || 0));

            renderDoughnut('allocationChart', alloc, {
                Stocks: '#635bff', Bonds: '#30d158', Cash: '#ffd60a',
                'Real Estate': '#bf5af2', Crypto: '#ff9f0a', Commodities: '#64d2ff'
            });

            const subClass = portfolioData.sub_class_allocation || {};
            renderDoughnut('subClassChart', subClass);
        }

        let fullChartData = null;
        let currentPeriod = '5Y';

        function renderPerformance() {
            const perf = portfolioData.historical_performance || {};
            let returns = perf.returns || {};
            const periods = ['1M', '3M', '6M', 'YTD', '1Y', '3Y', '5Y'];

            // Calculate returns from chart data if not provided by backend
            if (perf.chart_data && perf.chart_data.labels && perf.chart_data.portfolio) {
                const chartData = perf.chart_data;
                const labels = chartData.labels;
                const portfolio = chartData.portfolio;
                const benchmark = chartData.benchmark;
                const lastDate = new Date(labels[labels.length - 1]);
                const lastPortVal = portfolio[portfolio.length - 1];
                const lastBenchVal = benchmark ? benchmark[benchmark.length - 1] : null;

                // Helper to find return for a period
                function calcReturnFromChart(daysBack) {
                    const targetDate = new Date(lastDate);
                    targetDate.setDate(targetDate.getDate() - daysBack);

                    // Find the closest date at or before target
                    let idx = -1;
                    for (let i = labels.length - 1; i >= 0; i--) {
                        if (new Date(labels[i]) <= targetDate) {
                            idx = i;
                            break;
                        }
                    }
                    if (idx < 0) return { portfolio: null, benchmark: null };

                    const portReturn = ((lastPortVal / portfolio[idx]) - 1) * 100;
                    const benchReturn = benchmark ? ((lastBenchVal / benchmark[idx]) - 1) * 100 : null;
                    return { portfolio: portReturn, benchmark: benchReturn };
                }

                // Fill in missing period returns from chart data
                const periodDays = { '1M': 30, '3M': 90, '6M': 180, '1Y': 365, '3Y': 1095, '5Y': 1825 };
                for (const [period, days] of Object.entries(periodDays)) {
                    if (!returns[period] || returns[period].portfolio === null) {
                        const calc = calcReturnFromChart(days);
                        if (calc.portfolio !== null) {
                            returns[period] = calc;
                        }
                    }
                }

                // Calculate YTD if missing
                if (!returns['YTD'] || returns['YTD'].portfolio === null) {
                    const yearStart = new Date(lastDate.getFullYear(), 0, 1);
                    let idx = -1;
                    for (let i = 0; i < labels.length; i++) {
                        if (new Date(labels[i]) >= yearStart) {
                            idx = i;
                            break;
                        }
                    }
                    if (idx >= 0) {
                        const portReturn = ((lastPortVal / portfolio[idx]) - 1) * 100;
                        const benchReturn = benchmark ? ((lastBenchVal / benchmark[idx]) - 1) * 100 : null;
                        returns['YTD'] = { portfolio: portReturn, benchmark: benchReturn };
                    }
                }
            }

            document.getElementById('returnsGrid').innerHTML = periods.map(p => {
                const data = returns[p] || {};
                const val = data.portfolio;
                const bench = data.benchmark;
                const cls = val > 0 ? 'positive' : val < 0 ? 'negative' : '';
                return `
                    <div class="stat-card return-card" data-period="${p}">
                        <div class="stat-label">${p}</div>
                        <div class="stat-value ${cls}">${val !== null && val !== undefined ? (val > 0 ? '+' : '') + val.toFixed(2) + '%' : '--'}</div>
                        <div class="benchmark-label">S&P: ${bench !== null && bench !== undefined ? (bench > 0 ? '+' : '') + bench.toFixed(2) + '%' : '--'}</div>
                    </div>
                `;
            }).join('');

            // Store full chart data for filtering
            if (perf.chart_data) {
                fullChartData = perf.chart_data;
                renderLineChart(fullChartData, currentPeriod);
            }

            // Add click handlers for return cards
            document.querySelectorAll('.return-card').forEach(card => {
                card.addEventListener('click', () => {
                    const period = card.dataset.period;
                    selectPeriod(period);
                });
            });

            // Add click handlers for period buttons
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const period = btn.dataset.period;
                    selectPeriod(period);
                });
            });
        }

        function selectPeriod(period) {
            currentPeriod = period;

            // Update period button states
            document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`.period-btn[data-period="${period}"]`)?.classList.add('active');

            // Update return card states
            document.querySelectorAll('.return-card').forEach(c => c.classList.remove('active'));
            document.querySelector(`.return-card[data-period="${period}"]`)?.classList.add('active');

            // Re-render chart with filtered data
            if (fullChartData) {
                renderLineChart(fullChartData, period);
            }
        }

        function filterChartDataByPeriod(data, period) {
            if (!data || !data.labels || !data.labels.length) return data;

            const now = new Date(data.labels[data.labels.length - 1]);
            let startDate = new Date(now);

            switch (period) {
                case '1M': startDate.setMonth(now.getMonth() - 1); break;
                case '3M': startDate.setMonth(now.getMonth() - 3); break;
                case '6M': startDate.setMonth(now.getMonth() - 6); break;
                case 'YTD': startDate = new Date(now.getFullYear(), 0, 1); break;
                case '1Y': startDate.setFullYear(now.getFullYear() - 1); break;
                case '3Y': startDate.setFullYear(now.getFullYear() - 3); break;
                case '5Y':
                default: return data; // Return full data for 5Y
            }

            const startIdx = data.labels.findIndex(d => new Date(d) >= startDate);
            if (startIdx === -1) return data;

            const filteredLabels = data.labels.slice(startIdx);
            const filteredPortfolio = data.portfolio.slice(startIdx);
            const filteredBenchmark = data.benchmark?.slice(startIdx);

            // Normalize to start at 100
            const portfolioStart = filteredPortfolio[0] || 100;
            const benchmarkStart = filteredBenchmark?.[0] || 100;

            return {
                labels: filteredLabels,
                portfolio: filteredPortfolio.map(v => (v / portfolioStart) * 100),
                benchmark: filteredBenchmark?.map(v => (v / benchmarkStart) * 100)
            };
        }

        function renderLineChart(data, period = '5Y') {
            const ctx = document.getElementById('performanceChart').getContext('2d');
            if (charts.performanceChart) charts.performanceChart.destroy();

            const filteredData = filterChartDataByPeriod(data, period);

            // Downsample for performance
            const maxPoints = 150;
            const step = Math.max(1, Math.floor(filteredData.labels.length / maxPoints));
            const labels = filteredData.labels.filter((_, i) => i % step === 0);
            const portfolio = filteredData.portfolio.filter((_, i) => i % step === 0);
            const benchmark = filteredData.benchmark?.filter((_, i) => i % step === 0);

            charts.performanceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [
                        {
                            label: 'Portfolio', data: portfolio,
                            borderColor: '#635bff', backgroundColor: 'rgba(99,91,255,0.1)',
                            borderWidth: 2.5, fill: true, tension: 0.3,
                            pointRadius: 0, pointHoverRadius: 6, pointHoverBackgroundColor: '#635bff'
                        },
                        ...(benchmark ? [{
                            label: 'S&P 500', data: benchmark,
                            borderColor: '#8898aa', backgroundColor: 'transparent',
                            borderWidth: 2, borderDash: [5, 5], fill: false, tension: 0.3,
                            pointRadius: 0, pointHoverRadius: 5, pointHoverBackgroundColor: '#8898aa'
                        }] : [])
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: { display: true, position: 'top', labels: { usePointStyle: true, padding: 20 } },
                        tooltip: {
                            enabled: true,
                            backgroundColor: 'rgba(10, 37, 64, 0.95)',
                            titleFont: { size: 13, weight: '600' },
                            bodyFont: { size: 12 },
                            padding: 12,
                            cornerRadius: 8,
                            displayColors: true,
                            callbacks: {
                                title: (items) => {
                                    const date = new Date(items[0].label);
                                    return date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
                                },
                                label: ctx => {
                                    const change = ctx.raw - 100;
                                    const sign = change >= 0 ? '+' : '';
                                    return `${ctx.dataset.label}: ${sign}${change.toFixed(2)}%`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: '#e3e8ee', drawBorder: false },
                            ticks: {
                                color: '#8898aa',
                                maxTicksLimit: 8,
                                callback: (v) => {
                                    const d = new Date(labels[v]);
                                    // Use more granular format for shorter periods
                                    if (period === '1M') {
                                        return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                                    } else if (period === '3M' || period === 'YTD') {
                                        return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                                    } else if (period === '6M' || period === '1Y') {
                                        return d.toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
                                    } else {
                                        return d.toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
                                    }
                                }
                            }
                        },
                        y: {
                            grid: { color: '#e3e8ee', drawBorder: false },
                            ticks: {
                                color: '#8898aa',
                                callback: (v) => (v - 100 >= 0 ? '+' : '') + (v - 100).toFixed(0) + '%'
                            }
                        }
                    }
                }
            });
        }

        function renderSectors() {
            const sectors = portfolioData.sector_exposure || {};
            const benchmark = portfolioData.sector_benchmark || {};
            const all = [...new Set([...Object.keys(sectors), ...Object.keys(benchmark)])].sort((a, b) => (sectors[b] || 0) - (sectors[a] || 0));

            document.getElementById('sectorList').innerHTML = all.map(s => {
                const p = sectors[s] || 0;
                const b = (benchmark[s] || 0) * 100;
                const max = Math.max(p, b, 30);
                return `
                    <div class="sector-item">
                        <div class="sector-name">${s}</div>
                        <div class="sector-bar-container">
                            <div class="sector-bar benchmark" style="width: ${(b / max * 100)}%"></div>
                            <div class="sector-bar portfolio" style="width: ${(p / max * 100)}%"></div>
                        </div>
                        <div class="sector-pct portfolio">${p.toFixed(1)}%</div>
                        <div class="sector-pct benchmark">${b.toFixed(1)}%</div>
                    </div>
                `;
            }).join('');

            renderDoughnut('sectorChart', sectors);
        }

        function renderGeography() {
            const geo = portfolioData.geography || {};
            const us = geo.US || 0;
            const dev = (geo['Developed Markets'] || 0) + (geo.Europe || 0) + (geo.Japan || 0) + (geo['Asia Pacific'] || 0);
            const em = (geo['Emerging Markets'] || 0) + (geo.China || 0) + (geo['Latin America'] || 0);

            document.getElementById('usPct').textContent = us.toFixed(1) + '%';
            document.getElementById('devPct').textContent = dev.toFixed(1) + '%';
            document.getElementById('emPct').textContent = em.toFixed(1) + '%';

            // Update map legend percentages
            document.getElementById('usMapPct').textContent = us.toFixed(0) + '%';
            document.getElementById('devMapPct').textContent = dev.toFixed(0) + '%';
            document.getElementById('emMapPct').textContent = em.toFixed(0) + '%';

            renderWorldMap(us, dev, em);
            renderDoughnut('geoChart', geo, {
                US: '#635bff', 'Developed Markets': '#a5b4fc', 'Emerging Markets': '#fbbf24',
                Europe: '#a78bfa', 'Asia Pacific': '#c4b5fd', Global: '#64d2ff',
                International: '#818cf8', Japan: '#6366f1', China: '#ef4444'
            });
        }

        async function renderWorldMap(us, dev, em) {
            const container = document.getElementById('worldMapContainer');
            container.innerHTML = '';

            // Country classifications
            const usCountries = ['United States of America', 'USA', 'United States'];
            const developedCountries = ['Canada', 'United Kingdom', 'Germany', 'France', 'Japan', 'Australia', 'New Zealand', 'Italy', 'Spain', 'Portugal', 'Netherlands', 'Belgium', 'Switzerland', 'Austria', 'Sweden', 'Norway', 'Denmark', 'Finland', 'Ireland', 'Singapore', 'Israel', 'South Korea', 'Luxembourg', 'Iceland'];
            const emergingCountries = ['China', 'India', 'Brazil', 'Mexico', 'Russia', 'South Africa', 'Indonesia', 'Turkey', 'Thailand', 'Malaysia', 'Philippines', 'Vietnam', 'Poland', 'Czech Republic', 'Czechia', 'Hungary', 'Chile', 'Colombia', 'Peru', 'Argentina', 'Taiwan', 'Saudi Arabia', 'United Arab Emirates', 'Qatar', 'Kuwait', 'Egypt', 'Pakistan', 'Bangladesh', 'Nigeria', 'Greece'];

            function getCountryClass(name) {
                if (us > 5 && usCountries.some(c => name.includes(c) || c.includes(name))) return 'country us';
                if (dev > 5 && developedCountries.some(c => name.includes(c) || c.includes(name))) return 'country developed';
                if (em > 5 && emergingCountries.some(c => name.includes(c) || c.includes(name))) return 'country emerging';
                return 'country';
            }

            try {
                // Fetch world topology data
                const response = await fetch('https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json');
                const world = await response.json();

                const width = 900;
                const height = 450;

                const svg = d3.select(container)
                    .append('svg')
                    .attr('viewBox', `0 0 ${width} ${height}`)
                    .attr('preserveAspectRatio', 'xMidYMid meet');

                const projection = d3.geoNaturalEarth1()
                    .scale(170)
                    .translate([width / 2, height / 2]);

                const path = d3.geoPath().projection(projection);

                const countries = topojson.feature(world, world.objects.countries);

                svg.selectAll('path')
                    .data(countries.features)
                    .enter()
                    .append('path')
                    .attr('d', path)
                    .attr('class', d => getCountryClass(d.properties.name || ''))
                    .append('title')
                    .text(d => d.properties.name || '');

            } catch (error) {
                console.error('Failed to load map:', error);
                container.innerHTML = '<p style="text-align:center;color:#8898aa;padding:40px;">Map unavailable</p>';
            }
        }

        function renderRisk() {
            const risk = portfolioData.risk_metrics || {};
            const conc = portfolioData.concentration || {};
            const scenarios = portfolioData.scenario_analysis?.scenarios || [];

            document.getElementById('volatilityVal').textContent = risk.volatility !== null ? risk.volatility.toFixed(1) + '%' : '--';
            document.getElementById('betaVal').textContent = risk.beta !== null ? risk.beta.toFixed(2) : '--';
            document.getElementById('sharpeVal').textContent = risk.sharpe_ratio !== null ? risk.sharpe_ratio.toFixed(2) : '--';
            document.getElementById('maxDdVal').textContent = risk.max_drawdown !== null ? risk.max_drawdown.toFixed(1) + '%' : '--';

            document.getElementById('top10Pct').textContent = (conc.top_10_pct || 0).toFixed(1) + '%';
            document.getElementById('topHoldingsList').innerHTML = (conc.top_10_holdings || []).map((h, i) => `
                <div class="holding-item">
                    <div class="holding-rank">${i + 1}</div>
                    <div class="holding-info"><div class="holding-symbol">${h.symbol}</div></div>
                    <div class="holding-values">
                        <div class="holding-amount">${formatCurrency(h.value)}</div>
                        <div class="holding-pct">${h.pct.toFixed(1)}%</div>
                    </div>
                </div>
            `).join('');

            document.getElementById('scenariosList').innerHTML = scenarios.map(s => {
                const isPositive = s.portfolio_impact >= 0;
                const barWidth = Math.min(Math.abs(s.portfolio_impact) * 2, 100);
                return `
                    <div class="scenario-card">
                        <div class="scenario-info">
                            <h4>${s.name}</h4>
                            <p>${s.description}</p>
                        </div>
                        <div class="scenario-impact">
                            <div class="scenario-pct ${isPositive ? 'positive' : 'negative'}">${isPositive ? '+' : ''}${s.portfolio_impact.toFixed(1)}%</div>
                            <div class="scenario-value">${formatCurrency(s.value_change)}</div>
                        </div>
                        <div class="scenario-bar-container">
                            <div class="scenario-bar ${isPositive ? 'positive' : 'negative'}" style="width: ${barWidth}%"></div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderHoldings() {
            const positions = portfolioData.positions || [];
            const total = portfolioData.total_value || 0;
            const sorted = [...positions].sort((a, b) => (b.value || 0) - (a.value || 0));

            document.getElementById('holdingsBody').innerHTML = sorted.map(p => {
                const cls = p.classification || {};
                const weight = total > 0 ? (p.value || 0) / total * 100 : 0;
                return `
                    <tr>
                        <td class="symbol-cell">${p.symbol}</td>
                        <td>${p.description || '-'}</td>
                        <td><span class="badge badge-primary">${cls.asset_class || 'Unknown'}</span></td>
                        <td><span class="badge badge-secondary">${cls.sector || 'Unknown'}</span></td>
                        <td class="text-right font-mono">${formatNumber(p.shares)}</td>
                        <td class="text-right font-mono">${formatCurrency(p.price)}</td>
                        <td class="text-right font-mono">${formatCurrency(p.value)}</td>
                        <td class="text-right font-mono">${weight.toFixed(2)}%</td>
                    </tr>
                `;
            }).join('') + `
                <tr class="total-row">
                    <td colspan="6" class="text-right">Total Portfolio Value</td>
                    <td class="text-right font-mono">${formatCurrency(total)}</td>
                    <td class="text-right font-mono">100%</td>
                </tr>
            `;
        }

        function renderDoughnut(id, data, colors = null) {
            const ctx = document.getElementById(id).getContext('2d');
            if (charts[id]) charts[id].destroy();

            const labels = Object.keys(data).filter(k => data[k] > 0);
            const values = labels.map(k => data[k]);
            const defaultColors = ['#635bff', '#30d158', '#ff9f0a', '#bf5af2', '#ff453a', '#64d2ff', '#ffd60a', '#8e8e93'];
            const bgColors = colors ? labels.map((l, i) => colors[l] || defaultColors[i % defaultColors.length]) : defaultColors;

            charts[id] = new Chart(ctx, {
                type: 'doughnut',
                data: { labels, datasets: [{ data: values, backgroundColor: bgColors, borderWidth: 0 }] },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right', labels: { padding: 16, usePointStyle: true, font: { size: 12 } } },
                        tooltip: { callbacks: { label: ctx => `${ctx.label}: ${ctx.raw.toFixed(1)}%` } }
                    }
                }
            });
        }

        function downloadCSV() {
            if (!portfolioData?.positions) return;
            let csv = 'Symbol,Description,Asset Class,Sub Class,Sector,Geography,Shares,Price,Value,Weight\n';
            const total = portfolioData.total_value || 0;
            portfolioData.positions.forEach(p => {
                const c = p.classification || {};
                const w = total > 0 ? (p.value || 0) / total * 100 : 0;
                csv += [p.symbol, `"${(p.description || '').replace(/"/g, '""')}"`, c.asset_class || '', c.sub_class || '', c.sector || '', c.geography || '', p.shares || '', p.price || '', p.value || '', w.toFixed(2) + '%'].join(',') + '\n';
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'portfolio_analysis.csv';
            a.click();
        }

        function resetUI() {
            dashboard.style.display = 'none';
            uploadSection.style.display = 'block';
            portfolioData = null;
            Object.values(charts).forEach(c => c.destroy());
            charts = {};
        }

        function showProgress(text) {
            progressSection.style.display = 'block';
            progressText.textContent = text;
            uploadSection.style.display = 'none';
        }

        function hideProgress() {
            progressSection.style.display = 'none';
            uploadSection.style.display = 'block';
        }

        function showError(msg) {
            errorMessage.textContent = msg;
            errorMessage.style.display = 'block';
        }

        function hideError() {
            errorMessage.style.display = 'none';
        }

        function formatNumber(n) {
            return n == null ? '-' : n.toLocaleString('en-US', { maximumFractionDigits: 4 });
        }

        function formatCurrency(n) {
            return n == null ? '-' : '$' + n.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }
    </script>
</body>
</html>
