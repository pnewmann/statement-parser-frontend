<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio Analytics</title>
    <link rel="icon" href="favicon.svg" type="image/svg+xml">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #e0e0e0;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding-top: 20px;
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 600;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #00d4ff, #7b2ff7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            color: #888;
            font-size: 1.1rem;
        }

        /* Upload Section */
        .upload-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 20px;
            border: 2px dashed rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .upload-section.dragover {
            border-color: #00d4ff;
            background: rgba(0, 212, 255, 0.05);
        }

        .upload-area {
            text-align: center;
            cursor: pointer;
            padding: 20px;
        }

        .upload-icon {
            width: 60px;
            height: 60px;
            margin: 0 auto 15px;
            opacity: 0.6;
        }

        .upload-text {
            font-size: 1.1rem;
            margin-bottom: 8px;
        }

        .upload-hint {
            color: #666;
            font-size: 0.85rem;
        }

        #fileInput {
            display: none;
        }

        /* Account List */
        .accounts-section {
            margin-top: 20px;
        }

        .accounts-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .accounts-header h3 {
            color: #00d4ff;
            font-size: 1rem;
        }

        .account-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 15px;
        }

        .account-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .account-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(90deg, #00d4ff, #7b2ff7);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .account-details {
            flex: 1;
        }

        .account-name-input {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            padding: 6px 10px;
            color: #fff;
            font-size: 0.95rem;
            width: 100%;
            max-width: 200px;
        }

        .account-name-input:focus {
            outline: none;
            border-color: #00d4ff;
        }

        .account-meta {
            color: #888;
            font-size: 0.8rem;
            margin-top: 4px;
        }

        .account-value {
            font-weight: 600;
            color: #2ecc71;
            font-size: 1.1rem;
        }

        .remove-account {
            background: none;
            border: none;
            color: #ff6b6b;
            cursor: pointer;
            font-size: 1.4rem;
            padding: 5px;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .remove-account:hover {
            opacity: 1;
        }

        /* Buttons */
        .btn {
            background: linear-gradient(90deg, #00d4ff, #7b2ff7);
            color: white;
            border: none;
            padding: 12px 28px;
            font-size: 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 212, 255, 0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.05);
            box-shadow: none;
        }

        .btn-success {
            background: #2ecc71;
        }

        .btn-success:hover {
            box-shadow: 0 5px 20px rgba(46, 204, 113, 0.3);
        }

        .actions-row {
            display: flex;
            gap: 12px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        /* Progress */
        .progress-section {
            display: none;
            text-align: center;
            padding: 60px 40px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top-color: #00d4ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Error Message */
        .error-message {
            background: rgba(255, 107, 107, 0.1);
            border: 1px solid rgba(255, 107, 107, 0.3);
            color: #ff6b6b;
            padding: 15px 20px;
            border-radius: 8px;
            text-align: center;
            display: none;
            margin-bottom: 20px;
        }

        /* Analytics Dashboard */
        .analytics-section {
            display: none;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .dashboard-title {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .dashboard-title h2 {
            font-size: 1.5rem;
        }

        .total-value-badge {
            background: linear-gradient(90deg, #2ecc71, #27ae60);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 1.1rem;
            font-weight: 600;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 25px;
            flex-wrap: wrap;
            background: rgba(0, 0, 0, 0.2);
            padding: 5px;
            border-radius: 12px;
        }

        .tab {
            background: transparent;
            border: none;
            color: #888;
            padding: 12px 20px;
            font-size: 0.95rem;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .tab:hover {
            color: #fff;
            background: rgba(255, 255, 255, 0.05);
        }

        .tab.active {
            background: linear-gradient(90deg, #00d4ff, #7b2ff7);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Cards Grid */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
        }

        .card-title {
            color: #888;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
        }

        .card-value {
            font-size: 2rem;
            font-weight: 600;
            color: #fff;
        }

        .card-value.positive {
            color: #2ecc71;
        }

        .card-value.negative {
            color: #ff6b6b;
        }

        .card-subtitle {
            color: #666;
            font-size: 0.8rem;
            margin-top: 5px;
        }

        /* Performance / Returns */
        .returns-grid {
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        }

        .return-card .card-value {
            font-size: 1.8rem;
        }

        .return-card .card-value.positive {
            color: #2ecc71;
        }

        .return-card .card-value.negative {
            color: #e74c3c;
        }

        .benchmark-return {
            color: #888;
            font-size: 0.8rem;
        }

        .chart-legend {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #ccc;
        }

        .legend-color {
            width: 16px;
            height: 3px;
            border-radius: 2px;
        }

        .legend-color.portfolio {
            background: linear-gradient(90deg, #00d4ff, #7b2ff7);
        }

        .legend-color.benchmark {
            background: rgba(255, 255, 255, 0.4);
        }

        /* Charts */
        .chart-container {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
        }

        .chart-title {
            font-size: 1.1rem;
            margin-bottom: 20px;
            color: #00d4ff;
        }

        .chart-wrapper {
            position: relative;
            height: 300px;
        }

        .chart-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }

        /* Table */
        .table-container {
            overflow-x: auto;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            margin-bottom: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
        }

        th, td {
            padding: 14px 16px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        th {
            background: rgba(0, 0, 0, 0.2);
            font-weight: 600;
            color: #00d4ff;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.5px;
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .number {
            text-align: right;
            font-family: 'Monaco', 'Consolas', monospace;
        }

        .symbol {
            font-weight: 600;
            color: #fff;
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            background: rgba(0, 212, 255, 0.2);
            color: #00d4ff;
        }

        .badge-green {
            background: rgba(46, 204, 113, 0.2);
            color: #2ecc71;
        }

        .badge-yellow {
            background: rgba(241, 196, 15, 0.2);
            color: #f1c40f;
        }

        .badge-purple {
            background: rgba(155, 89, 182, 0.2);
            color: #9b59b6;
        }

        .total-row {
            font-weight: 600;
            background: rgba(0, 212, 255, 0.08) !important;
        }

        .total-row td {
            border-top: 2px solid rgba(0, 212, 255, 0.2);
        }

        /* Sector Comparison */
        .sector-comparison {
            display: grid;
            gap: 12px;
        }

        .sector-row {
            display: grid;
            grid-template-columns: 140px 1fr 60px 60px;
            align-items: center;
            gap: 15px;
        }

        .sector-name {
            font-size: 0.9rem;
            color: #ccc;
        }

        .sector-bars {
            position: relative;
            height: 24px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
            overflow: hidden;
        }

        .sector-bar {
            position: absolute;
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .sector-bar.portfolio {
            background: linear-gradient(90deg, #00d4ff, #7b2ff7);
            z-index: 2;
        }

        .sector-bar.benchmark {
            background: rgba(255, 255, 255, 0.15);
            z-index: 1;
        }

        .sector-pct {
            text-align: right;
            font-size: 0.85rem;
            font-family: monospace;
        }

        .sector-pct.portfolio {
            color: #00d4ff;
        }

        .sector-pct.benchmark {
            color: #888;
        }

        /* Risk Metrics */
        .risk-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .risk-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 24px;
            text-align: center;
        }

        .risk-value {
            font-size: 2.5rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .risk-label {
            color: #888;
            font-size: 0.9rem;
            margin-bottom: 8px;
        }

        .risk-description {
            color: #555;
            font-size: 0.75rem;
        }

        /* Top Holdings */
        .holding-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .holding-item:last-child {
            border-bottom: none;
        }

        .holding-rank {
            width: 28px;
            height: 28px;
            background: rgba(0, 212, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            color: #00d4ff;
            margin-right: 12px;
        }

        .holding-info {
            flex: 1;
        }

        .holding-symbol {
            font-weight: 600;
            color: #fff;
        }

        .holding-value {
            text-align: right;
        }

        .holding-amount {
            color: #fff;
            font-weight: 500;
        }

        .holding-pct {
            color: #888;
            font-size: 0.85rem;
        }

        /* Footer */
        footer {
            text-align: center;
            margin-top: 40px;
            color: #555;
            font-size: 0.85rem;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 1.8rem;
            }

            .upload-section {
                padding: 20px;
            }

            .sector-row {
                grid-template-columns: 100px 1fr 50px 50px;
                gap: 10px;
            }

            .tabs {
                overflow-x: auto;
            }

            .tab {
                padding: 10px 16px;
                font-size: 0.85rem;
                white-space: nowrap;
            }

            th, td {
                padding: 10px 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Portfolio Analytics</h1>
            <p class="subtitle">Upload statements from multiple accounts for comprehensive analysis</p>
        </header>

        <div class="error-message" id="errorMessage"></div>

        <!-- Upload Section -->
        <div id="uploadSection">
            <div class="upload-section" id="dropZone">
                <div class="upload-area" id="uploadArea">
                    <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="17 8 12 3 7 8"/>
                        <line x1="12" y1="3" x2="12" y2="15"/>
                    </svg>
                    <p class="upload-text">Drop your brokerage statements here</p>
                    <p class="upload-hint">or click to browse (PDF or CSV) - Add multiple accounts</p>
                    <input type="file" id="fileInput" accept=".pdf,.csv" multiple>
                </div>
            </div>

            <!-- Uploaded Accounts List -->
            <div class="accounts-section" id="accountsSection" style="display: none;">
                <div class="accounts-header">
                    <h3>Uploaded Accounts</h3>
                    <button class="btn btn-secondary" id="addMoreBtn">+ Add More</button>
                </div>
                <div id="accountsList"></div>

                <div class="actions-row">
                    <button class="btn" id="analyzeBtn" disabled>Analyze Portfolio</button>
                    <button class="btn btn-secondary" id="clearAllBtn">Clear All</button>
                </div>
            </div>
        </div>

        <!-- Progress Section -->
        <div class="progress-section" id="progressSection">
            <div class="spinner"></div>
            <p id="progressText">Analyzing your portfolio...</p>
        </div>

        <!-- Analytics Dashboard -->
        <div class="analytics-section" id="analyticsSection">
            <div class="dashboard-header">
                <div class="dashboard-title">
                    <h2>Portfolio Analysis</h2>
                    <span class="total-value-badge" id="totalValueBadge">$0</span>
                </div>
                <div>
                    <button class="btn btn-secondary" id="newAnalysisBtn">New Analysis</button>
                    <button class="btn btn-success" id="downloadCsvBtn">Download CSV</button>
                </div>
            </div>

            <!-- Tabs -->
            <div class="tabs">
                <button class="tab active" data-tab="allocation">Allocation</button>
                <button class="tab" data-tab="performance">Performance</button>
                <button class="tab" data-tab="sectors">Sectors</button>
                <button class="tab" data-tab="geography">Geography</button>
                <button class="tab" data-tab="risk">Risk</button>
                <button class="tab" data-tab="holdings">Holdings</button>
            </div>

            <!-- Allocation Tab -->
            <div class="tab-content active" id="tab-allocation">
                <div class="cards-grid">
                    <div class="card">
                        <div class="card-title">Stocks</div>
                        <div class="card-value" id="stocksPct">0%</div>
                        <div class="card-subtitle" id="stocksValue">$0</div>
                    </div>
                    <div class="card">
                        <div class="card-title">Bonds</div>
                        <div class="card-value" id="bondsPct">0%</div>
                        <div class="card-subtitle" id="bondsValue">$0</div>
                    </div>
                    <div class="card">
                        <div class="card-title">Cash</div>
                        <div class="card-value" id="cashPct">0%</div>
                        <div class="card-subtitle" id="cashValue">$0</div>
                    </div>
                    <div class="card">
                        <div class="card-title">Alternatives</div>
                        <div class="card-value" id="altsPct">0%</div>
                        <div class="card-subtitle" id="altsValue">$0</div>
                    </div>
                </div>

                <div class="chart-row">
                    <div class="chart-container">
                        <div class="chart-title">Asset Allocation</div>
                        <div class="chart-wrapper">
                            <canvas id="assetAllocationChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-container">
                        <div class="chart-title">Sub-Asset Breakdown</div>
                        <div class="chart-wrapper">
                            <canvas id="subClassChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Performance Tab -->
            <div class="tab-content" id="tab-performance">
                <div class="cards-grid returns-grid">
                    <div class="card return-card">
                        <div class="card-title">1 Month</div>
                        <div class="card-value" id="return1M">--</div>
                        <div class="card-subtitle benchmark-return" id="benchmark1M">S&P 500: --</div>
                    </div>
                    <div class="card return-card">
                        <div class="card-title">3 Month</div>
                        <div class="card-value" id="return3M">--</div>
                        <div class="card-subtitle benchmark-return" id="benchmark3M">S&P 500: --</div>
                    </div>
                    <div class="card return-card">
                        <div class="card-title">6 Month</div>
                        <div class="card-value" id="return6M">--</div>
                        <div class="card-subtitle benchmark-return" id="benchmark6M">S&P 500: --</div>
                    </div>
                    <div class="card return-card">
                        <div class="card-title">YTD</div>
                        <div class="card-value" id="returnYTD">--</div>
                        <div class="card-subtitle benchmark-return" id="benchmarkYTD">S&P 500: --</div>
                    </div>
                    <div class="card return-card">
                        <div class="card-title">1 Year</div>
                        <div class="card-value" id="return1Y">--</div>
                        <div class="card-subtitle benchmark-return" id="benchmark1Y">S&P 500: --</div>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-title">Portfolio Performance vs S&P 500 (1 Year)</div>
                    <div class="chart-legend">
                        <span class="legend-item"><span class="legend-color portfolio"></span> Portfolio</span>
                        <span class="legend-item"><span class="legend-color benchmark"></span> S&P 500</span>
                    </div>
                    <div class="chart-wrapper" style="height: 350px;">
                        <canvas id="performanceChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Sectors Tab -->
            <div class="tab-content" id="tab-sectors">
                <div class="chart-container">
                    <div class="chart-title">Sector Exposure vs S&P 500</div>
                    <div class="sector-comparison" id="sectorComparison"></div>
                </div>

                <div class="chart-container">
                    <div class="chart-title">Sector Breakdown</div>
                    <div class="chart-wrapper">
                        <canvas id="sectorChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Geography Tab -->
            <div class="tab-content" id="tab-geography">
                <div class="cards-grid">
                    <div class="card">
                        <div class="card-title">US Exposure</div>
                        <div class="card-value" id="usPct">0%</div>
                    </div>
                    <div class="card">
                        <div class="card-title">International</div>
                        <div class="card-value" id="intlPct">0%</div>
                    </div>
                    <div class="card">
                        <div class="card-title">Emerging Markets</div>
                        <div class="card-value" id="emPct">0%</div>
                    </div>
                </div>

                <div class="chart-row">
                    <div class="chart-container">
                        <div class="chart-title">Geographic Allocation</div>
                        <div class="chart-wrapper">
                            <canvas id="geoChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Risk Tab -->
            <div class="tab-content" id="tab-risk">
                <div class="risk-grid">
                    <div class="risk-card">
                        <div class="risk-value" id="volatilityValue">--</div>
                        <div class="risk-label">Volatility</div>
                        <div class="risk-description">Annualized standard deviation</div>
                    </div>
                    <div class="risk-card">
                        <div class="risk-value" id="betaValue">--</div>
                        <div class="risk-label">Beta</div>
                        <div class="risk-description">Sensitivity to S&P 500</div>
                    </div>
                    <div class="risk-card">
                        <div class="risk-value" id="sharpeValue">--</div>
                        <div class="risk-label">Sharpe Ratio</div>
                        <div class="risk-description">Risk-adjusted return</div>
                    </div>
                    <div class="risk-card">
                        <div class="risk-value negative" id="maxDrawdownValue">--</div>
                        <div class="risk-label">Max Drawdown</div>
                        <div class="risk-description">Largest peak-to-trough decline</div>
                    </div>
                </div>

                <div class="chart-container" style="margin-top: 25px;">
                    <div class="chart-title">Concentration Risk - Top 10 Holdings</div>
                    <div class="cards-grid">
                        <div class="card">
                            <div class="card-title">Top 10 Concentration</div>
                            <div class="card-value" id="top10Pct">0%</div>
                            <div class="card-subtitle">of total portfolio</div>
                        </div>
                    </div>
                    <div id="topHoldingsList" style="margin-top: 20px;"></div>
                </div>
            </div>

            <!-- Holdings Tab -->
            <div class="tab-content" id="tab-holdings">
                <div class="table-container">
                    <table id="holdingsTable">
                        <thead>
                            <tr>
                                <th>Symbol</th>
                                <th>Description</th>
                                <th>Asset Class</th>
                                <th>Sector</th>
                                <th class="number">Shares</th>
                                <th class="number">Price</th>
                                <th class="number">Value</th>
                                <th class="number">Weight</th>
                            </tr>
                        </thead>
                        <tbody id="holdingsBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <footer>
            <p>Supports Schwab, Fidelity, Vanguard, and most other brokerage statements</p>
        </footer>
    </div>

    <script>
        // Configuration
        const API_URL = 'https://statement-parser-backend-yg0a.onrender.com';

        // State
        let accounts = []; // { id, name, file, positions, brokerage, totalValue }
        let portfolioData = null;
        let charts = {};

        // DOM Elements
        const dropZone = document.getElementById('dropZone');
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const accountsSection = document.getElementById('accountsSection');
        const accountsList = document.getElementById('accountsList');
        const addMoreBtn = document.getElementById('addMoreBtn');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const clearAllBtn = document.getElementById('clearAllBtn');
        const progressSection = document.getElementById('progressSection');
        const progressText = document.getElementById('progressText');
        const analyticsSection = document.getElementById('analyticsSection');
        const errorMessage = document.getElementById('errorMessage');
        const uploadSection = document.getElementById('uploadSection');
        const newAnalysisBtn = document.getElementById('newAnalysisBtn');
        const downloadCsvBtn = document.getElementById('downloadCsvBtn');

        // Event Listeners
        uploadArea.addEventListener('click', () => fileInput.click());
        addMoreBtn.addEventListener('click', () => fileInput.click());

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });

        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
            fileInput.value = '';
        });

        analyzeBtn.addEventListener('click', analyzePortfolio);
        clearAllBtn.addEventListener('click', clearAll);
        newAnalysisBtn.addEventListener('click', resetToUpload);
        downloadCsvBtn.addEventListener('click', downloadCSV);

        // Tab handling
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
            });
        });

        // Functions
        async function handleFiles(files) {
            for (const file of files) {
                const ext = file.name.toLowerCase().split('.').pop();
                if (ext !== 'pdf' && ext !== 'csv') {
                    showError(`${file.name}: Only PDF and CSV files are supported`);
                    continue;
                }

                showProgress(`Parsing ${file.name}...`);

                try {
                    const result = await parseFile(file);
                    if (result.error && (!result.positions || result.positions.length === 0)) {
                        hideProgress();
                        showError(`${file.name}: ${result.error}`);
                        continue;
                    }

                    const totalValue = result.positions.reduce((sum, p) => sum + (p.value || 0), 0);

                    accounts.push({
                        id: Date.now() + Math.random(),
                        name: generateAccountName(result.brokerage, file.name),
                        file: file,
                        positions: result.positions,
                        brokerage: result.brokerage,
                        totalValue: totalValue
                    });

                    hideProgress();
                    hideError();
                    renderAccountsList();
                } catch (err) {
                    hideProgress();
                    showError(`${file.name}: Failed to parse - ${err.message}`);
                }
            }
        }

        function generateAccountName(brokerage, filename) {
            const brokerageNames = {
                'schwab': 'Schwab',
                'fidelity': 'Fidelity',
                'vanguard': 'Vanguard',
                'csv': 'Account'
            };
            const base = brokerageNames[brokerage] || 'Account';
            const count = accounts.filter(a => a.name.startsWith(base)).length + 1;
            return count > 1 ? `${base} ${count}` : base;
        }

        async function parseFile(file) {
            const formData = new FormData();
            formData.append('file', file);

            const response = await fetch(`${API_URL}/parse`, {
                method: 'POST',
                body: formData
            });

            return await response.json();
        }

        function renderAccountsList() {
            if (accounts.length === 0) {
                accountsSection.style.display = 'none';
                analyzeBtn.disabled = true;
                return;
            }

            accountsSection.style.display = 'block';
            analyzeBtn.disabled = false;

            accountsList.innerHTML = accounts.map(account => `
                <div class="account-item" data-id="${account.id}">
                    <div class="account-info">
                        <div class="account-icon">${account.brokerage.charAt(0).toUpperCase()}</div>
                        <div class="account-details">
                            <input type="text" class="account-name-input" value="${escapeHtml(account.name)}"
                                   onchange="updateAccountName(${account.id}, this.value)">
                            <div class="account-meta">${account.positions.length} positions</div>
                        </div>
                    </div>
                    <div class="account-value">${formatCurrency(account.totalValue)}</div>
                    <button class="remove-account" onclick="removeAccount(${account.id})">&times;</button>
                </div>
            `).join('');
        }

        function updateAccountName(id, name) {
            const account = accounts.find(a => a.id === id);
            if (account) account.name = name;
        }

        function removeAccount(id) {
            accounts = accounts.filter(a => a.id !== id);
            renderAccountsList();
        }

        function clearAll() {
            accounts = [];
            renderAccountsList();
        }

        function aggregatePositions() {
            const aggregated = {};

            for (const account of accounts) {
                for (const pos of account.positions) {
                    const symbol = pos.symbol;
                    if (!aggregated[symbol]) {
                        aggregated[symbol] = {
                            symbol: symbol,
                            description: pos.description || '',
                            shares: 0,
                            value: 0,
                            accounts: []
                        };
                    }

                    aggregated[symbol].shares += pos.shares || 0;
                    aggregated[symbol].value += pos.value || 0;
                    aggregated[symbol].accounts.push(account.name);

                    if (!aggregated[symbol].description && pos.description) {
                        aggregated[symbol].description = pos.description;
                    }
                }
            }

            // Calculate average price
            for (const symbol in aggregated) {
                const pos = aggregated[symbol];
                if (pos.shares > 0) {
                    pos.price = pos.value / pos.shares;
                } else {
                    pos.price = null;
                }
            }

            return Object.values(aggregated);
        }

        async function analyzePortfolio() {
            if (accounts.length === 0) return;

            showProgress('Aggregating positions...');
            const positions = aggregatePositions();

            showProgress('Analyzing portfolio...');

            try {
                const response = await fetch(`${API_URL}/analyze`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ positions, include_risk: true })
                });

                if (!response.ok) {
                    throw new Error('Analysis failed');
                }

                portfolioData = await response.json();
                hideProgress();
                hideError();
                showAnalytics();
            } catch (err) {
                hideProgress();
                showError('Failed to analyze portfolio: ' + err.message);
            }
        }

        function showAnalytics() {
            uploadSection.style.display = 'none';
            analyticsSection.style.display = 'block';

            // Total Value
            document.getElementById('totalValueBadge').textContent = formatCurrency(portfolioData.total_value);

            // Render all sections
            renderAllocationTab();
            renderPerformanceTab();
            renderSectorsTab();
            renderGeographyTab();
            renderRiskTab();
            renderHoldingsTab();
        }

        function renderAllocationTab() {
            const allocation = portfolioData.asset_allocation || {};
            const values = portfolioData.asset_allocation_values || {};

            // Cards
            const stocks = (allocation['Stocks'] || 0);
            const bonds = (allocation['Bonds'] || 0);
            const cash = (allocation['Cash'] || 0);
            const alts = (allocation['Real Estate'] || 0) + (allocation['Crypto'] || 0) + (allocation['Commodities'] || 0);

            document.getElementById('stocksPct').textContent = stocks.toFixed(1) + '%';
            document.getElementById('bondsPct').textContent = bonds.toFixed(1) + '%';
            document.getElementById('cashPct').textContent = cash.toFixed(1) + '%';
            document.getElementById('altsPct').textContent = alts.toFixed(1) + '%';

            document.getElementById('stocksValue').textContent = formatCurrency(values['Stocks'] || 0);
            document.getElementById('bondsValue').textContent = formatCurrency(values['Bonds'] || 0);
            document.getElementById('cashValue').textContent = formatCurrency(values['Cash'] || 0);
            document.getElementById('altsValue').textContent = formatCurrency(
                (values['Real Estate'] || 0) + (values['Crypto'] || 0) + (values['Commodities'] || 0)
            );

            // Asset Allocation Pie Chart
            renderPieChart('assetAllocationChart', allocation, {
                'Stocks': '#3498db',
                'Bonds': '#2ecc71',
                'Cash': '#f1c40f',
                'Real Estate': '#9b59b6',
                'Crypto': '#e67e22',
                'Commodities': '#1abc9c'
            });

            // Sub-class Chart
            const subClass = portfolioData.sub_class_allocation || {};
            renderPieChart('subClassChart', subClass);
        }

        function renderPerformanceTab() {
            const performance = portfolioData.historical_performance || {};
            const returns = performance.returns || {};
            const chartData = performance.chart_data;

            // Helper to format return value
            function formatReturn(val) {
                if (val === null || val === undefined) return '--';
                const sign = val >= 0 ? '+' : '';
                return sign + val.toFixed(2) + '%';
            }

            // Helper to set return class
            function getReturnClass(val) {
                if (val === null || val === undefined) return '';
                return val >= 0 ? 'positive' : 'negative';
            }

            // Update return cards
            const periods = ['1M', '3M', '6M', 'YTD', '1Y'];
            periods.forEach(period => {
                const data = returns[period] || {};
                const returnEl = document.getElementById('return' + period);
                const benchmarkEl = document.getElementById('benchmark' + period);

                if (returnEl) {
                    returnEl.textContent = formatReturn(data.portfolio);
                    returnEl.className = 'card-value ' + getReturnClass(data.portfolio);
                }
                if (benchmarkEl) {
                    benchmarkEl.textContent = 'S&P 500: ' + formatReturn(data.benchmark);
                }
            });

            // Render performance line chart
            if (chartData && chartData.labels && chartData.portfolio) {
                renderPerformanceChart(chartData);
            }
        }

        function renderPerformanceChart(chartData) {
            const ctx = document.getElementById('performanceChart').getContext('2d');

            // Destroy existing chart
            if (charts['performanceChart']) {
                charts['performanceChart'].destroy();
            }

            // Downsample data for smoother rendering (take every nth point)
            const maxPoints = 100;
            const step = Math.max(1, Math.floor(chartData.labels.length / maxPoints));

            const labels = chartData.labels.filter((_, i) => i % step === 0 || i === chartData.labels.length - 1);
            const portfolioData = chartData.portfolio.filter((_, i) => i % step === 0 || i === chartData.portfolio.length - 1);
            const benchmarkData = chartData.benchmark ?
                chartData.benchmark.filter((_, i) => i % step === 0 || i === chartData.benchmark.length - 1) : null;

            const datasets = [
                {
                    label: 'Portfolio',
                    data: portfolioData,
                    borderColor: '#00d4ff',
                    backgroundColor: 'rgba(0, 212, 255, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.3,
                    pointRadius: 0,
                    pointHoverRadius: 4
                }
            ];

            if (benchmarkData) {
                datasets.push({
                    label: 'S&P 500',
                    data: benchmarkData,
                    borderColor: 'rgba(255, 255, 255, 0.4)',
                    backgroundColor: 'transparent',
                    borderWidth: 2,
                    borderDash: [5, 5],
                    fill: false,
                    tension: 0.3,
                    pointRadius: 0,
                    pointHoverRadius: 4
                });
            }

            charts['performanceChart'] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    return context[0].label;
                                },
                                label: function(context) {
                                    const change = (context.raw - 100).toFixed(2);
                                    const sign = change >= 0 ? '+' : '';
                                    return `${context.dataset.label}: ${context.raw.toFixed(2)} (${sign}${change}%)`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.05)'
                            },
                            ticks: {
                                color: '#888',
                                maxTicksLimit: 6,
                                callback: function(val, index) {
                                    const date = new Date(this.getLabelForValue(val));
                                    return date.toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
                                }
                            }
                        },
                        y: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.05)'
                            },
                            ticks: {
                                color: '#888',
                                callback: function(val) {
                                    return val.toFixed(0);
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderSectorsTab() {
            const sectors = portfolioData.sector_exposure || {};
            const benchmark = portfolioData.sector_benchmark || {};

            // Sector comparison bars
            const sectorComparison = document.getElementById('sectorComparison');
            const allSectors = [...new Set([...Object.keys(sectors), ...Object.keys(benchmark)])];

            // Sort by portfolio weight
            allSectors.sort((a, b) => (sectors[b] || 0) - (sectors[a] || 0));

            sectorComparison.innerHTML = allSectors.map(sector => {
                const portfolioPct = sectors[sector] || 0;
                const benchmarkPct = (benchmark[sector] || 0) * 100;
                const maxPct = Math.max(portfolioPct, benchmarkPct, 30);

                return `
                    <div class="sector-row">
                        <div class="sector-name">${sector}</div>
                        <div class="sector-bars">
                            <div class="sector-bar benchmark" style="width: ${(benchmarkPct / maxPct * 100)}%"></div>
                            <div class="sector-bar portfolio" style="width: ${(portfolioPct / maxPct * 100)}%"></div>
                        </div>
                        <div class="sector-pct portfolio">${portfolioPct.toFixed(1)}%</div>
                        <div class="sector-pct benchmark">${benchmarkPct.toFixed(1)}%</div>
                    </div>
                `;
            }).join('');

            // Sector pie chart
            renderPieChart('sectorChart', sectors);
        }

        function renderGeographyTab() {
            const geo = portfolioData.geography || {};

            // Aggregate into categories
            const us = geo['US'] || 0;
            const developed = (geo['Developed Markets'] || 0) + (geo['Europe'] || 0) + (geo['Japan'] || 0) + (geo['Asia Pacific'] || 0) + (geo['North America'] || 0);
            const em = (geo['Emerging Markets'] || 0) + (geo['China'] || 0) + (geo['Latin America'] || 0);
            const global = geo['Global'] || 0;
            const intl = geo['International'] || 0;

            document.getElementById('usPct').textContent = us.toFixed(1) + '%';
            document.getElementById('intlPct').textContent = (developed + intl + global).toFixed(1) + '%';
            document.getElementById('emPct').textContent = em.toFixed(1) + '%';

            // Geography pie chart
            renderPieChart('geoChart', geo, {
                'US': '#3498db',
                'Developed Markets': '#2ecc71',
                'Emerging Markets': '#e74c3c',
                'Europe': '#9b59b6',
                'Asia Pacific': '#f1c40f',
                'Global': '#1abc9c',
                'International': '#e67e22',
                'Japan': '#34495e',
                'China': '#c0392b',
                'Latin America': '#16a085'
            });
        }

        function renderRiskTab() {
            const risk = portfolioData.risk_metrics || {};
            const concentration = portfolioData.concentration || {};

            // Risk metrics
            document.getElementById('volatilityValue').textContent =
                risk.volatility !== null ? risk.volatility.toFixed(1) + '%' : '--';

            document.getElementById('betaValue').textContent =
                risk.beta !== null ? risk.beta.toFixed(2) : '--';

            document.getElementById('sharpeValue').textContent =
                risk.sharpe_ratio !== null ? risk.sharpe_ratio.toFixed(2) : '--';

            document.getElementById('maxDrawdownValue').textContent =
                risk.max_drawdown !== null ? risk.max_drawdown.toFixed(1) + '%' : '--';

            // Concentration
            document.getElementById('top10Pct').textContent = (concentration.top_10_pct || 0).toFixed(1) + '%';

            // Top holdings list
            const topHoldings = concentration.top_10_holdings || [];
            document.getElementById('topHoldingsList').innerHTML = topHoldings.map((h, i) => `
                <div class="holding-item">
                    <div class="holding-rank">${i + 1}</div>
                    <div class="holding-info">
                        <div class="holding-symbol">${h.symbol}</div>
                    </div>
                    <div class="holding-value">
                        <div class="holding-amount">${formatCurrency(h.value)}</div>
                        <div class="holding-pct">${h.pct.toFixed(1)}%</div>
                    </div>
                </div>
            `).join('');
        }

        function renderHoldingsTab() {
            const positions = portfolioData.positions || [];
            const totalValue = portfolioData.total_value || 0;

            // Sort by value descending
            const sorted = [...positions].sort((a, b) => (b.value || 0) - (a.value || 0));

            const tbody = document.getElementById('holdingsBody');
            tbody.innerHTML = sorted.map(pos => {
                const classification = pos.classification || {};
                const weight = totalValue > 0 ? ((pos.value || 0) / totalValue * 100) : 0;

                return `
                    <tr>
                        <td class="symbol">${escapeHtml(pos.symbol)}</td>
                        <td>${escapeHtml(pos.description || '-')}</td>
                        <td><span class="badge">${classification.asset_class || 'Unknown'}</span></td>
                        <td><span class="badge badge-purple">${classification.sector || 'Unknown'}</span></td>
                        <td class="number">${formatNumber(pos.shares)}</td>
                        <td class="number">${formatCurrency(pos.price)}</td>
                        <td class="number">${formatCurrency(pos.value)}</td>
                        <td class="number">${weight.toFixed(2)}%</td>
                    </tr>
                `;
            }).join('');

            // Add total row
            const totalRow = document.createElement('tr');
            totalRow.className = 'total-row';
            totalRow.innerHTML = `
                <td colspan="6" style="text-align: right;">Total Portfolio Value:</td>
                <td class="number">${formatCurrency(totalValue)}</td>
                <td class="number">100%</td>
            `;
            tbody.appendChild(totalRow);
        }

        function renderPieChart(canvasId, data, colors = null) {
            const ctx = document.getElementById(canvasId).getContext('2d');

            // Destroy existing chart
            if (charts[canvasId]) {
                charts[canvasId].destroy();
            }

            const labels = Object.keys(data).filter(k => data[k] > 0);
            const values = labels.map(k => data[k]);

            const defaultColors = [
                '#3498db', '#2ecc71', '#9b59b6', '#f1c40f', '#e74c3c',
                '#1abc9c', '#e67e22', '#34495e', '#16a085', '#c0392b',
                '#8e44ad', '#2980b9', '#27ae60', '#d35400', '#7f8c8d'
            ];

            const backgroundColors = colors
                ? labels.map(l => colors[l] || defaultColors[labels.indexOf(l) % defaultColors.length])
                : labels.map((_, i) => defaultColors[i % defaultColors.length]);

            charts[canvasId] = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: backgroundColors,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: '#ccc',
                                padding: 15,
                                font: { size: 12 }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.label}: ${context.raw.toFixed(1)}%`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function downloadCSV() {
            if (!portfolioData || !portfolioData.positions) return;

            let csv = 'Symbol,Description,Asset Class,Sub Class,Sector,Geography,Shares,Price,Value,Weight\n';

            const totalValue = portfolioData.total_value || 0;

            portfolioData.positions.forEach(pos => {
                const classification = pos.classification || {};
                const weight = totalValue > 0 ? ((pos.value || 0) / totalValue * 100) : 0;

                const row = [
                    pos.symbol,
                    `"${(pos.description || '').replace(/"/g, '""')}"`,
                    classification.asset_class || '',
                    classification.sub_class || '',
                    classification.sector || '',
                    classification.geography || '',
                    pos.shares || '',
                    pos.price || '',
                    pos.value || '',
                    weight.toFixed(2) + '%'
                ];
                csv += row.join(',') + '\n';
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'portfolio_analysis.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function resetToUpload() {
            analyticsSection.style.display = 'none';
            uploadSection.style.display = 'block';
            portfolioData = null;

            // Destroy all charts
            Object.values(charts).forEach(chart => chart.destroy());
            charts = {};
        }

        // Utility functions
        function showProgress(text) {
            progressSection.style.display = 'block';
            progressText.textContent = text;
            uploadSection.style.display = 'none';
        }

        function hideProgress() {
            progressSection.style.display = 'none';
            uploadSection.style.display = 'block';
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
        }

        function hideError() {
            errorMessage.style.display = 'none';
        }

        function formatNumber(num) {
            if (num === null || num === undefined) return '-';
            return num.toLocaleString('en-US', { maximumFractionDigits: 4 });
        }

        function formatCurrency(num) {
            if (num === null || num === undefined) return '-';
            return '$' + num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
