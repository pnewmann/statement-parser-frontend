<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Statement Scan - Portfolio Intelligence</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><rect width='32' height='32' rx='6' fill='%23635bff'/><rect x='2' y='2' width='14' height='14' rx='3' fill='white'/><rect x='16' y='16' width='14' height='14' rx='3' fill='white'/><rect x='0' y='13' width='32' height='6' fill='white' opacity='0.4'/><rect x='11' y='11' width='10' height='10' rx='2' fill='white'/></svg>" type="image/svg+xml">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'><rect width='180' height='180' rx='40' fill='%23635bff'/><rect x='22' y='22' width='75' height='75' rx='15' fill='white'/><rect x='83' y='83' width='75' height='75' rx='15' fill='white'/><rect x='0' y='78' width='180' height='24' fill='white' opacity='0.4'/><rect x='67' y='67' width='46' height='46' rx='8' fill='white'/></svg>">
    <meta name="theme-color" content="#635bff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Statement Scan">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- pdf.js needed for brokerage detection on upload -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        :root {
            --primary: #635bff;
            --primary-dark: #5851db;
            --primary-light: #7a73ff;
            --success: #30d158;
            --danger: #ff453a;
            --warning: #ffd60a;
            --text-primary: #0a2540;
            --text-secondary: #425466;
            --text-muted: #8898aa;
            --bg-primary: #ffffff;
            --bg-secondary: #f6f9fc;
            --bg-tertiary: #e3e8ee;
            --border: #e3e8ee;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.04);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
            --shadow-lg: 0 8px 24px rgba(0,0,0,0.12);
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 16px;

            /* Stripe-inspired Design System */
            --accent-teal: #00D4AA;
            --accent-purple: #A259FF;
            --dark-section-bg: #0A2540;
            --dark-card-bg: #112840;
            --dark-border: #1E3A5F;
            --gradient-primary: linear-gradient(90deg, #635BFF, #A259FF);

            /* Spacing System - 8px base scale */
            --section-padding-y: 64px;
            --section-padding-y-sm: 48px;
            --section-padding-y-lg: 80px;
            --heading-gap: 16px;
            --content-gap: 56px;
            --section-divider-height: 60px;
        }

        @media (max-width: 768px) {
            :root {
                --section-padding-y: 64px;
                --section-padding-y-sm: 48px;
                --section-padding-y-lg: 80px;
                --content-gap: 40px;
                --section-divider-height: 48px;
            }
        }

        /* Gradient Text Utility - Enhanced for vibrancy */
        .gradient-text {
            background: linear-gradient(135deg, #635BFF 0%, #A259FF 50%, #00D4AA 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Dark Section Text Colors - Enhanced contrast */
        .text-white { color: #ffffff; }
        .text-light { color: rgba(255, 255, 255, 0.9); }
        .text-muted-light { color: #94A3B8; }

        /* Global Polish */
        html {
            scroll-behavior: smooth;
        }

        ::selection {
            background: rgba(99, 91, 255, 0.2);
            color: #0A2540;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-secondary);
            color: var(--text-primary);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 24px;
        }

        /* Announcement Bar */
        .announcement-bar {
            width: 100%;
            background: linear-gradient(90deg, #0A2540 0%, #112840 100%);
            color: #94A3B8;
            font-size: 13px;
            padding: 10px 0;
            text-align: center;
            border-bottom: 1px solid rgba(99, 91, 255, 0.15);
            position: relative;
            z-index: 1001;
        }

        .announcement-inner {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .announcement-link {
            color: #A259FF;
            font-weight: 600;
            text-decoration: none;
            margin-left: 4px;
            transition: color 0.2s;
        }

        .announcement-link:hover {
            color: #FFFFFF;
        }

        .announcement-close {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #556B7E;
            font-size: 14px;
            cursor: pointer;
            padding: 4px 8px;
            transition: color 0.2s;
        }

        .announcement-close:hover {
            color: #FFFFFF;
        }

        @media (max-width: 768px) {
            .announcement-bar {
                padding: 8px 40px 8px 16px;
                font-size: 12px;
            }
            .announcement-inner {
                gap: 4px;
            }
        }

        /* Top Navigation */
        .top-nav {
            position: sticky;
            top: 0;
            left: 0;
            right: 0;
            width: 100%;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            transition: background 0.3s ease, backdrop-filter 0.3s ease, box-shadow 0.3s ease, top 0.3s ease;
            border-bottom: 1px solid rgba(0, 0, 0, 0.08);
        }

        .nav-inner {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
            padding: 16px 24px;
        }

        :root[data-theme="dark"] .top-nav {
            background: rgba(30, 41, 59, 0.95);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .top-nav.navbar-scrolled {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            box-shadow: 0 1px 0 var(--border);
        }

        :root[data-theme="dark"] .top-nav.navbar-scrolled {
            background: rgba(30, 41, 59, 0.95);
        }

        /* Navbar Layout - Three Sections */
        .nav-left {
            flex: 0 0 auto;
        }

        .nav-center {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* Nav Links */
        .nav-link {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 8px 16px;
            font-size: 15px;
            font-weight: 500;
            color: #425466;
            text-decoration: none;
            border-radius: 6px;
            transition: color 0.2s ease, background 0.2s ease;
            cursor: pointer;
            position: relative;
            background: transparent;
            border: none;
        }

        :root[data-theme="dark"] .nav-link {
            color: #C1C9D2;
        }

        .nav-link:hover {
            color: #0A2540;
            background: rgba(0, 0, 0, 0.04);
        }

        :root[data-theme="dark"] .nav-link:hover {
            color: #FFFFFF;
            background: rgba(255, 255, 255, 0.06);
        }

        /* Nav Link Chevron */
        .nav-link-chevron {
            width: 10px;
            height: 10px;
            transition: transform 0.2s ease;
            opacity: 0.6;
        }

        .nav-item:hover .nav-link-chevron,
        .nav-item.active .nav-link-chevron {
            transform: rotate(180deg);
        }

        /* Nav Item Container */
        .nav-item {
            position: relative;
        }

        /* Dropdown Mega Menu */
        .nav-dropdown {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(-8px);
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(10, 37, 64, 0.15);
            border: 1px solid rgba(0, 0, 0, 0.06);
            padding: 24px 32px;
            min-width: 280px;
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            transition: opacity 0.2s ease, transform 0.2s ease, visibility 0.2s ease;
            z-index: 1001;
        }

        .nav-dropdown.dropdown-wide {
            min-width: 520px;
        }

        :root[data-theme="dark"] .nav-dropdown {
            background: #112840;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        /* Hover bridge - invisible connector between nav link and dropdown */
        .nav-item::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            height: 20px;
            background: transparent;
            display: none;
        }

        .nav-item:hover::after {
            display: block;
        }

        .nav-item:hover .nav-dropdown,
        .nav-item.active .nav-dropdown {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
            transform: translateX(-50%) translateY(0);
        }

        /* Dropdown Columns */
        .dropdown-columns {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 32px;
        }

        .dropdown-column-title {
            font-size: 11px;
            font-weight: 600;
            color: #8898AA;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            margin-bottom: 16px;
        }

        :root[data-theme="dark"] .dropdown-column-title {
            color: #8898AA;
        }

        /* Dropdown Items */
        .dropdown-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px;
            margin: 0 -12px;
            border-radius: 8px;
            text-decoration: none;
            cursor: pointer;
            transition: background 0.15s ease;
        }

        .dropdown-item:hover {
            background: rgba(99, 91, 255, 0.04);
        }

        :root[data-theme="dark"] .dropdown-item:hover {
            background: rgba(99, 91, 255, 0.1);
        }

        .dropdown-item-icon {
            font-size: 20px;
            line-height: 1;
            flex-shrink: 0;
            width: 24px;
            text-align: center;
        }

        .dropdown-item-content {
            flex: 1;
            min-width: 0;
        }

        .dropdown-item-title {
            font-size: 15px;
            font-weight: 600;
            color: #0A2540;
            margin-bottom: 2px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        :root[data-theme="dark"] .dropdown-item-title {
            color: #FFFFFF;
        }

        .dropdown-item-desc {
            font-size: 13px;
            color: #425466;
            line-height: 1.4;
        }

        :root[data-theme="dark"] .dropdown-item-desc {
            color: #8898AA;
        }

        /* Coming Soon Tag */
        .tag-coming-soon {
            display: inline-block;
            background: #E3E8EE;
            color: #425466;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.02em;
        }

        :root[data-theme="dark"] .tag-coming-soon {
            background: rgba(255, 255, 255, 0.1);
            color: #8898AA;
        }

        /* Create Account Button */
        .btn-get-started {
            background: #635BFF;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 20px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .btn-get-started:hover {
            background: #4B45C6;
        }

        /* Mobile Menu Button */
        .mobile-menu-btn {
            display: none;
            background: transparent;
            border: none;
            padding: 8px;
            cursor: pointer;
            color: var(--text-secondary);
        }

        .mobile-menu-btn svg {
            width: 24px;
            height: 24px;
        }

        /* Mobile Menu Overlay */
        .mobile-menu-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            z-index: 2000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            overflow-y: auto;
        }

        :root[data-theme="dark"] .mobile-menu-overlay {
            background: #0A2540;
        }

        .mobile-menu-overlay.open {
            transform: translateX(0);
        }

        .mobile-menu-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 24px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.08);
        }

        :root[data-theme="dark"] .mobile-menu-header {
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .mobile-menu-close {
            background: transparent;
            border: none;
            padding: 8px;
            cursor: pointer;
            color: var(--text-secondary);
            font-size: 24px;
            line-height: 1;
        }

        .mobile-menu-content {
            padding: 16px 24px;
        }

        /* Mobile Accordion */
        .mobile-accordion {
            border-bottom: 1px solid rgba(0, 0, 0, 0.06);
        }

        :root[data-theme="dark"] .mobile-accordion {
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        }

        .mobile-accordion-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            padding: 16px 0;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            text-align: left;
        }

        .mobile-accordion-header svg {
            width: 20px;
            height: 20px;
            transition: transform 0.2s ease;
            color: var(--text-muted);
        }

        .mobile-accordion.open .mobile-accordion-header svg {
            transform: rotate(180deg);
        }

        .mobile-accordion-content {
            display: none;
            padding-bottom: 16px;
        }

        .mobile-accordion.open .mobile-accordion-content {
            display: block;
        }

        .mobile-dropdown-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px 0;
            text-decoration: none;
            cursor: pointer;
        }

        .mobile-menu-actions {
            padding: 24px 0;
            display: flex;
            flex-direction: column;
            gap: 12px;
            border-top: 1px solid rgba(0, 0, 0, 0.08);
            margin-top: 16px;
        }

        :root[data-theme="dark"] .mobile-menu-actions {
            border-top: 1px solid rgba(255, 255, 255, 0.08);
        }

        .mobile-menu-actions .btn {
            width: 100%;
            justify-content: center;
        }

        .mobile-menu-actions .btn-get-started {
            width: 100%;
            padding: 14px 20px;
        }

        /* Mobile Nav Link (no dropdown) */
        .mobile-nav-link {
            display: block;
            padding: 16px 0;
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            text-decoration: none;
            border-bottom: 1px solid rgba(0, 0, 0, 0.06);
        }

        :root[data-theme="dark"] .mobile-nav-link {
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        }

        /* Navbar Mobile Responsive */
        @media (max-width: 768px) {
            .nav-center {
                display: none;
            }

            .btn-get-started {
                display: none;
            }

            .mobile-menu-btn {
                display: flex;
            }

            .mobile-menu-overlay {
                display: block;
            }

            .nav-inner {
                padding: 12px 16px;
            }
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-icon {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--primary);
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(99, 91, 255, 0.25);
        }

        .logo-icon svg {
            width: 22px;
            height: 22px;
        }

        .brand-text {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .brand-name {
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: -0.01em;
            line-height: 1.2;
        }

        .brand-tagline {
            font-size: 0.625rem;
            font-weight: 500;
            color: var(--text-muted);
            letter-spacing: 0.04em;
            text-transform: uppercase;
            margin-top: 2px;
        }

        h1 {
            font-size: 3.5rem;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: -0.02em;
            line-height: 1.1;
        }

        /* Hero Typography */
        .hero-headline {
            font-size: 3.5rem;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: -0.02em;
            line-height: 1.1;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            h1, .hero-headline {
                font-size: 2.25rem;
            }
        }

        /* Section Headings */
        .section-title {
            font-size: 2.75rem;
            font-weight: 600;
            letter-spacing: -0.02em;
        }

        /* ========== SCROLL ANIMATIONS ========== */
        [data-animate] {
            opacity: 0;
            transform: translateY(30px);
            transition: opacity 0.6s ease-out, transform 0.6s ease-out;
        }

        [data-animate].animated {
            opacity: 1;
            transform: translateY(0);
        }

        /* Staggered children animations */
        [data-animate-child] > *:nth-child(1) { transition-delay: 0ms; }
        [data-animate-child] > *:nth-child(2) { transition-delay: 100ms; }
        [data-animate-child] > *:nth-child(3) { transition-delay: 200ms; }
        [data-animate-child] > *:nth-child(4) { transition-delay: 300ms; }
        [data-animate-child] > *:nth-child(5) { transition-delay: 400ms; }
        [data-animate-child] > *:nth-child(6) { transition-delay: 500ms; }

        /* Accessibility: Reduce motion for users who prefer it */
        @media (prefers-reduced-motion: reduce) {
            [data-animate] {
                opacity: 1;
                transform: none;
                transition: none;
            }
            [data-animate-child] > * {
                transition-delay: 0ms !important;
            }
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 1rem;
            text-align: center;
            max-width: 480px;
            margin: 0 auto;
            line-height: 1.6;
        }

        /* Cards */
        .card {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
            padding: 24px;
            transition: box-shadow 0.2s, transform 0.2s;
        }

        .card:hover {
            box-shadow: var(--shadow-md);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Upload Section */
        .upload-card {
            max-width: 600px;
            margin: 0 auto;
            padding: 48px;
            text-align: center;
        }

        .upload-card.dragover {
            border-color: var(--primary);
            background: rgba(99, 91, 255, 0.04);
        }

        .upload-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 24px;
            background: var(--bg-secondary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .upload-icon svg {
            width: 28px;
            height: 28px;
            color: var(--primary);
        }

        .upload-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .upload-hint {
            color: var(--text-muted);
            font-size: 0.875rem;
            margin-bottom: 12px;
        }

        .upload-free-badge {
            display: block;
            font-size: 12px;
            color: #94A3B8;
            margin-bottom: 20px;
            text-align: center;
        }

        /* Coming Soon Card Styles */
        .coming-soon-card {
            position: relative;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
        }

        .coming-soon-badge {
            position: absolute;
            top: 16px;
            right: 16px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            font-size: 0.75rem;
            font-weight: 600;
            padding: 6px 12px;
            border-radius: 20px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .coming-soon-icon {
            background: linear-gradient(135deg, rgba(99, 91, 255, 0.1) 0%, rgba(99, 91, 255, 0.05) 100%);
        }

        .coming-soon-features {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin: 24px 0;
            text-align: left;
            max-width: 280px;
            margin-left: auto;
            margin-right: auto;
        }

        .feature-item {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .feature-item svg {
            color: var(--success);
            flex-shrink: 0;
        }

        .coming-soon-note {
            margin-top: 16px;
            font-size: 0.8rem;
            color: var(--text-muted);
            max-width: 320px;
            margin-left: auto;
            margin-right: auto;
            line-height: 1.5;
        }

        #fileInput {
            display: none;
        }

        /* PII Redaction Option */
        .redact-pii-option {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 20px;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            border: 1px solid var(--border);
        }

        .redact-pii-label {
            display: flex;
            flex-direction: column;
            text-align: left;
        }

        .redact-pii-title {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .redact-pii-hint {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 2px;
        }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
            flex-shrink: 0;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-tertiary);
            transition: 0.3s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        .toggle-switch input:checked + .toggle-slider {
            background-color: var(--primary);
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(20px);
        }

        .toggle-switch input:focus + .toggle-slider {
            box-shadow: 0 0 0 2px rgba(99, 91, 255, 0.2);
        }

        /* Multi-file Upload Queue */
        .upload-queue {
            margin-top: 24px;
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            overflow: hidden;
            max-height: 300px;
            overflow-y: auto;
        }

        .upload-queue-header {
            padding: 12px 16px;
            background: var(--bg-secondary);
            font-size: 0.8125rem;
            font-weight: 600;
            color: var(--text-secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
        }

        .upload-queue-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            border-top: 1px solid var(--border);
            gap: 12px;
        }

        .upload-queue-item:first-of-type {
            border-top: none;
        }

        .upload-file-icon {
            width: 36px;
            height: 36px;
            background: var(--bg-secondary);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .upload-file-icon svg {
            width: 18px;
            height: 18px;
            color: var(--primary);
        }

        .upload-file-icon.success {
            background: #dcfce7;
        }

        .upload-file-icon.success svg {
            color: var(--success);
        }

        .upload-file-icon.error {
            background: #fee2e2;
        }

        .upload-file-icon.error svg {
            color: #ef4444;
        }

        .upload-file-icon.processing {
            background: #e0e7ff;
        }

        .upload-file-info {
            flex: 1;
            min-width: 0;
        }

        .upload-file-name {
            font-weight: 500;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .upload-file-status {
            font-size: 0.8125rem;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .upload-file-status.success {
            color: var(--success);
        }

        .upload-file-status.error {
            color: #ef4444;
        }

        .upload-progress-bar {
            width: 100%;
            height: 4px;
            background: var(--bg-tertiary);
            border-radius: 2px;
            margin-top: 6px;
            overflow: hidden;
        }

        .upload-progress-fill {
            height: 100%;
            background: var(--primary);
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        .upload-summary {
            display: flex;
            gap: 16px;
            margin-top: 16px;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            justify-content: center;
        }

        .upload-summary-stat {
            text-align: center;
        }

        .upload-summary-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .upload-summary-value.success {
            color: var(--success);
        }

        .upload-summary-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Entry Method Selector */
        .entry-methods {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 24px;
            padding: 6px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }

        .entry-method-btn {
            flex: 1;
            padding: 12px 16px;
            border: none;
            background: transparent;
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .entry-method-btn:hover {
            color: var(--text-primary);
        }

        .entry-method-btn.active {
            background: var(--bg-primary);
            color: var(--primary);
            box-shadow: var(--shadow-sm);
        }

        .entry-method-btn svg {
            width: 18px;
            height: 18px;
        }

        .entry-panel {
            display: none;
        }

        .entry-panel.active {
            display: block;
        }

        /* Manual Entry */
        .manual-entry-card {
            max-width: 700px;
            margin: 0 auto;
            padding: 32px;
        }

        .manual-entry-form {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .manual-entry-form .form-group {
            flex: 1;
            min-width: 120px;
        }

        .manual-entry-form label {
            display: block;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .manual-entry-form input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 0.9375rem;
            background: var(--bg-primary);
            transition: border-color 0.2s;
        }

        .manual-entry-form input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .manual-entry-form input::placeholder {
            color: var(--text-muted);
        }

        .manual-entry-form .btn-add {
            align-self: flex-end;
            padding: 10px 20px;
        }

        /* Input Mode Toggle */
        .input-mode-toggle {
            display: flex;
            justify-content: center;
            gap: 8px;
            padding: 6px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            max-width: 280px;
            margin: 0 auto 20px;
        }

        .mode-btn {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 10px 16px;
            border: none;
            background: transparent;
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .mode-btn:hover {
            color: var(--text-primary);
        }

        .mode-btn.active {
            background: var(--bg-primary);
            color: var(--primary);
            box-shadow: var(--shadow-sm);
        }

        .mode-btn svg {
            width: 16px;
            height: 16px;
        }

        .manual-entry-form .form-group .price-loading {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
        }

        .holdings-list {
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            overflow: hidden;
            margin-bottom: 24px;
        }

        .holdings-list-header {
            display: grid;
            grid-template-columns: 2fr 1.5fr 1.5fr 1.5fr auto;
            gap: 12px;
            padding: 12px 16px;
            background: var(--bg-secondary);
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .holdings-list-header.percent-mode {
            grid-template-columns: 1.5fr 0.8fr 1fr 1fr 1.2fr 40px;
        }

        .holdings-list-item.percent-mode {
            grid-template-columns: 1.5fr 0.8fr 1fr 1fr 1.2fr 40px;
        }

        .holdings-list-empty {
            padding: 48px 24px;
            text-align: center;
            color: var(--text-muted);
        }

        .holdings-list-item {
            display: grid;
            grid-template-columns: 2fr 1.5fr 1.5fr 1.5fr auto;
            gap: 12px;
            padding: 14px 16px;
            border-top: 1px solid var(--border);
            align-items: center;
        }

        .holdings-list-item:first-of-type {
            border-top: none;
        }

        .holding-symbol {
            font-weight: 600;
            color: var(--text-primary);
        }

        .holding-percent {
            font-weight: 500;
            color: var(--primary);
        }

        /* Stock search autocomplete */
        .symbol-input-wrapper {
            position: relative;
            width: 100%;
        }

        .stock-search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            box-shadow: var(--shadow-lg);
            max-height: 280px;
            overflow-y: auto;
            z-index: 100;
            display: none;
        }

        .stock-search-results.visible {
            display: block;
        }

        .stock-search-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid var(--border);
            transition: background 0.15s;
        }

        .stock-search-item:last-child {
            border-bottom: none;
        }

        .stock-search-item:hover {
            background: var(--bg-secondary);
        }

        .stock-search-item .symbol {
            font-weight: 600;
            color: var(--primary);
            min-width: 60px;
        }

        .stock-search-item .name {
            flex: 1;
            color: var(--text-primary);
            font-size: 0.875rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .stock-search-item .type {
            font-size: 0.7rem;
            padding: 2px 6px;
            background: var(--bg-secondary);
            border-radius: 4px;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .stock-search-loading {
            padding: 12px;
            text-align: center;
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        .stock-search-empty {
            padding: 12px;
            text-align: center;
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        .holding-value {
            color: var(--text-secondary);
        }

        .holding-total {
            font-weight: 600;
            color: var(--success);
        }

        .btn-remove {
            width: 32px;
            height: 32px;
            padding: 0;
            border: none;
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .btn-remove:hover {
            background: #fee2e2;
            color: #ef4444;
        }

        .manual-entry-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .manual-total {
            font-size: 1rem;
            color: var(--text-secondary);
        }

        .manual-total strong {
            color: var(--text-primary);
            font-size: 1.25rem;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 10px 18px;
            font-size: 0.875rem;
            font-weight: 600;
            border-radius: var(--radius-md);
            border: none;
            cursor: pointer;
            transition: all 0.15s ease;
            text-decoration: none;
        }

        .btn-primary {
            background: #635BFF;
            color: white;
            border-radius: 12px;
            font-weight: 600;
            padding: 14px 28px;
            transition: all 0.2s ease;
        }

        .btn-primary:hover {
            background: #4B45C6;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(99, 91, 255, 0.4);
        }

        /* Subtle pulse animation for primary CTA buttons on page load */
        @keyframes subtlePulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(99, 91, 255, 0.4); }
            50% { box-shadow: 0 0 0 12px rgba(99, 91, 255, 0); }
        }

        .hero-upload-card .btn-primary {
            animation: subtlePulse 2s ease 1s 1;
        }

        .btn-secondary {
            background: var(--bg-primary);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--bg-secondary);
            border-color: var(--text-muted);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Account List */
        .accounts-section {
            margin-top: 32px;
        }

        .accounts-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .accounts-header h3 {
            font-size: 1rem;
            font-weight: 600;
        }

        .account-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            margin-bottom: 8px;
        }

        .account-icon {
            width: 40px;
            height: 40px;
            min-width: 40px;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .account-icon.has-favicon {
            background: #FFFFFF;
            border: 1px solid rgba(0, 0, 0, 0.08);
        }

        .account-icon.no-favicon {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            font-weight: 600;
            font-size: 0.875rem;
        }

        .account-favicon {
            width: 24px;
            height: 24px;
            object-fit: contain;
        }

        .account-icon-fallback {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            font-weight: 600;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            border-radius: var(--radius-sm);
        }

        .account-details {
            flex: 1;
        }

        .account-name-input {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 8px 12px;
            font-size: 0.9375rem;
            color: var(--text-primary);
            font-family: inherit;
        }

        .account-name-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 91, 255, 0.1);
        }

        .account-meta {
            color: var(--text-muted);
            font-size: 0.8125rem;
            margin-top: 4px;
        }

        .account-value {
            font-weight: 600;
            font-size: 1.125rem;
            color: var(--success);
        }

        .remove-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 8px;
            border-radius: var(--radius-sm);
            transition: all 0.15s;
        }

        .remove-btn:hover {
            background: rgba(255, 69, 58, 0.1);
            color: var(--danger);
        }

        .actions-row {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        /* Progress */
        .progress-section {
            display: none;
            text-align: center;
            padding: 60px 40px;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 24px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .spin {
            animation: spin 1s linear infinite;
        }

        .progress-text {
            color: var(--text-secondary);
            font-size: 1rem;
        }

        /* Enhanced Progress Indicator */
        .progress-container {
            max-width: 500px;
            margin: 0 auto;
        }

        .progress-stages {
            display: flex;
            justify-content: space-between;
            margin-bottom: 24px;
            position: relative;
        }

        .progress-stages::before {
            content: '';
            position: absolute;
            top: 16px;
            left: 40px;
            right: 40px;
            height: 2px;
            background: var(--border);
            z-index: 0;
        }

        .progress-stage {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            position: relative;
            z-index: 1;
        }

        .progress-stage-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .progress-stage.active .progress-stage-icon {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
            animation: pulse-stage 1.5s ease-in-out infinite;
        }

        .progress-stage.completed .progress-stage-icon {
            background: var(--success);
            border-color: var(--success);
            color: white;
        }

        @keyframes pulse-stage {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(99, 91, 255, 0.4); }
            50% { transform: scale(1.05); box-shadow: 0 0 0 8px rgba(99, 91, 255, 0); }
        }

        .progress-stage-label {
            font-size: 12px;
            color: var(--text-muted);
            font-weight: 500;
            transition: color 0.3s ease;
        }

        .progress-stage.active .progress-stage-label,
        .progress-stage.completed .progress-stage-label {
            color: var(--text-primary);
        }

        .progress-bar-container {
            background: var(--bg-secondary);
            border-radius: 8px;
            height: 8px;
            overflow: hidden;
            margin-bottom: 16px;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--primary-light));
            border-radius: 8px;
            transition: width 0.3s ease;
            position: relative;
        }

        .progress-bar-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 1.5s ease-in-out infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .progress-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .progress-percentage {
            font-weight: 600;
            color: var(--primary);
        }

        .progress-time {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .progress-time svg {
            width: 14px;
            height: 14px;
        }

        .progress-details {
            font-size: 14px;
            color: var(--text-secondary);
            margin-top: 16px;
        }

        .progress-file-info {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 12px;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            font-size: 13px;
        }

        .progress-file-info svg {
            width: 16px;
            height: 16px;
            color: var(--primary);
        }

        .progress-tip {
            margin-top: 24px;
            padding: 12px 16px;
            background: rgba(99, 91, 255, 0.08);
            border-radius: var(--radius-md);
            font-size: 13px;
            color: var(--text-secondary);
        }

        .progress-tip strong {
            color: var(--primary);
        }

        /* Error */
        .error-message {
            background: rgba(255, 69, 58, 0.08);
            border: 1px solid rgba(255, 69, 58, 0.2);
            color: var(--danger);
            padding: 16px 20px;
            border-radius: var(--radius-md);
            margin-bottom: 24px;
            display: none;
            font-size: 0.9375rem;
        }

        /* Dashboard (Portfolio Analysis) */
        .dashboard {
            display: none;
            width: 100%;
            background: var(--bg-secondary);
            min-height: calc(100vh - 72px);
            padding: 48px 24px 80px;
        }

        .dashboard > * {
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .dashboard-title {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .dashboard-logo {
            width: 44px;
            height: 44px;
            background: var(--primary);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(99, 91, 255, 0.25);
        }

        .dashboard-logo svg {
            width: 28px;
            height: 28px;
        }

        .dashboard-title h2 {
            font-size: 1.75rem;
            font-weight: 700;
        }

        .total-badge {
            background: linear-gradient(135deg, var(--success) 0%, #28a745 100%);
            color: white;
            padding: 8px 20px;
            border-radius: 100px;
            font-weight: 600;
            font-size: 1.125rem;
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            background: var(--bg-primary);
            padding: 8px;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
            margin-bottom: 32px;
        }

        .tab {
            padding: 8px 14px;
            font-size: 0.8125rem;
            font-weight: 500;
            color: var(--text-secondary);
            background: var(--bg-secondary);
            border: 1px solid transparent;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.15s;
            white-space: nowrap;
        }

        .tab:hover {
            color: var(--text-primary);
            background: var(--bg-tertiary);
            border-color: var(--border);
        }

        .tab.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .tabs-primary {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            flex: 1;
        }

        .tabs-more {
            position: relative;
        }

        .tabs-more-btn {
            padding: 8px 14px;
            font-size: 0.8125rem;
            font-weight: 500;
            color: var(--text-secondary);
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .tabs-more-btn:hover {
            background: var(--bg-tertiary);
        }

        .tabs-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 4px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            min-width: 180px;
            z-index: 100;
            display: none;
        }

        .tabs-dropdown.show {
            display: block;
        }

        .tabs-dropdown .tab {
            display: block;
            width: 100%;
            text-align: left;
            border-radius: 0;
            border: none;
            background: transparent;
        }

        .tabs-dropdown .tab:first-child {
            border-radius: var(--radius-md) var(--radius-md) 0 0;
        }

        .tabs-dropdown .tab:last-child {
            border-radius: 0 0 var(--radius-md) var(--radius-md);
        }

        .tabs-dropdown .tab:hover {
            background: var(--bg-secondary);
        }

        .tabs-dropdown .tab.active {
            background: rgba(99, 91, 255, 0.1);
            color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Insights Section */
        .insights-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .insights-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .insights-header h3 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .insights-subtitle {
            color: var(--text-muted);
            font-size: 0.9375rem;
        }

        .insights-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .insight-card {
            background: var(--bg-primary);
            border-radius: var(--radius-md);
            padding: 20px 24px;
            border: 1px solid var(--border);
            border-left: 4px solid var(--primary);
            transition: box-shadow 0.2s ease, transform 0.2s ease;
        }

        .insight-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            transform: translateY(-2px);
        }

        .insight-card.insight-warning {
            border-left-color: var(--warning);
            background: linear-gradient(to right, rgba(255, 214, 10, 0.05), transparent);
        }

        .insight-card.insight-positive {
            border-left-color: var(--success);
            background: linear-gradient(to right, rgba(48, 209, 88, 0.05), transparent);
        }

        .insight-card.insight-info {
            border-left-color: var(--primary);
        }

        .insight-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .insight-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }

        .insight-warning .insight-icon {
            background: rgba(255, 214, 10, 0.15);
        }

        .insight-positive .insight-icon {
            background: rgba(48, 209, 88, 0.15);
        }

        .insight-info .insight-icon {
            background: rgba(99, 91, 255, 0.15);
        }

        .insight-category {
            font-size: 0.6875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            background: var(--bg-secondary);
            padding: 4px 8px;
            border-radius: 4px;
        }

        .insight-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 6px;
        }

        .insight-text {
            font-size: 0.9375rem;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .no-insights {
            text-align: center;
            padding: 48px 24px;
            color: var(--text-muted);
        }

        .no-insights svg {
            width: 48px;
            height: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: var(--bg-primary);
            border-radius: var(--radius-md);
            padding: 20px;
            border: 1px solid var(--border);
        }

        .stat-label {
            font-size: 0.8125rem;
            font-weight: 500;
            color: var(--text-muted);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .stat-value.positive {
            color: var(--success);
        }

        .stat-value.negative {
            color: var(--danger);
        }

        .stat-subtitle {
            font-size: 0.8125rem;
            color: var(--text-muted);
            margin-top: 4px;
        }

        /* Charts */
        .chart-card {
            margin-bottom: 24px;
        }

        .chart-wrapper {
            position: relative;
            height: 320px;
        }

        .charts-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 24px;
            margin-bottom: 24px;
        }

        /* Performance Returns */
        .period-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .period-btn {
            padding: 10px 20px;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-secondary);
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.15s;
        }

        .period-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .period-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .returns-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-bottom: 32px;
        }

        .return-card {
            text-align: center;
            padding: 20px 16px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .return-card:hover {
            border-color: var(--primary);
        }

        .return-card.active {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 91, 255, 0.1);
        }

        .return-card .stat-value {
            font-size: 1.5rem;
        }

        .benchmark-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 8px;
        }

        /* World Map */
        .map-container {
            position: relative;
            padding: 24px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
        }

        #worldMapContainer {
            width: 100%;
            max-width: 900px;
            margin: 0 auto;
        }

        #worldMapContainer svg {
            width: 100%;
            height: auto;
            display: block;
        }

        .country {
            fill: #dce3eb;
            stroke: #fff;
            stroke-width: 0.4;
            transition: fill 0.2s;
        }

        .country:hover {
            opacity: 0.85;
        }

        .country.us { fill: var(--primary); }
        .country.developed { fill: #a5b4fc; }
        .country.emerging { fill: #fbbf24; }

        .map-legend {
            display: flex;
            justify-content: center;
            gap: 32px;
            margin-top: 24px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9375rem;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .legend-dot {
            width: 14px;
            height: 14px;
            border-radius: 4px;
        }

        .legend-dot.us { background: var(--primary); }
        .legend-dot.developed { background: #a5b4fc; }
        .legend-dot.emerging { background: #fbbf24; }

        /* Scenario Analysis */
        .scenarios-container {
            display: grid;
            gap: 16px;
        }

        .scenario-card {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 16px;
            align-items: center;
        }

        .scenario-info h4 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .scenario-info p {
            font-size: 0.8125rem;
            color: var(--text-muted);
        }

        .scenario-impact {
            text-align: right;
        }

        .scenario-pct {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .scenario-pct.positive { color: var(--success); }
        .scenario-pct.negative { color: var(--danger); }

        .scenario-value {
            font-size: 0.8125rem;
            color: var(--text-muted);
        }

        .scenario-bar-container {
            grid-column: 1 / -1;
            height: 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }

        .scenario-bar {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .scenario-bar.positive { background: var(--success); }
        .scenario-bar.negative { background: var(--danger); }

        /* Sector Comparison */
        .sector-list {
            display: grid;
            gap: 16px;
        }

        .sector-item {
            display: grid;
            grid-template-columns: 140px 1fr 70px 70px;
            gap: 16px;
            align-items: center;
        }

        .sector-name {
            font-size: 0.9375rem;
            font-weight: 500;
        }

        .sector-bar-container {
            position: relative;
            height: 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
            overflow: hidden;
        }

        .sector-bar {
            position: absolute;
            height: 100%;
            border-radius: 4px;
        }

        .sector-bar.portfolio {
            background: var(--primary);
            z-index: 2;
        }

        .sector-bar.benchmark {
            background: var(--bg-tertiary);
            z-index: 1;
        }

        .sector-pct {
            font-size: 0.875rem;
            text-align: right;
            font-weight: 500;
            font-variant-numeric: tabular-nums;
        }

        .sector-pct.portfolio { color: var(--primary); }
        .sector-pct.benchmark { color: var(--text-muted); }

        /* Risk Cards */
        .risk-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px;
            margin-bottom: 32px;
        }

        .risk-card {
            text-align: center;
            padding: 28px 20px;
        }

        .risk-value {
            font-size: 2.25rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .risk-label {
            font-size: 0.9375rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .risk-desc {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* Holdings Table */
        .table-container {
            overflow-x: auto;
            border-radius: var(--radius-md);
            border: 1px solid var(--border);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9375rem;
        }

        th, td {
            padding: 14px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        th {
            background: var(--bg-secondary);
            font-weight: 600;
            font-size: 0.8125rem;
            text-transform: uppercase;
            letter-spacing: 0.03em;
            color: var(--text-secondary);
        }

        tbody tr:hover {
            background: var(--bg-secondary);
        }

        tbody tr:last-child td {
            border-bottom: none;
        }

        .text-right {
            text-align: right;
        }

        .font-mono {
            font-variant-numeric: tabular-nums;
        }

        .symbol-cell {
            font-weight: 600;
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 100px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .badge-primary {
            background: rgba(99, 91, 255, 0.1);
            color: var(--primary);
        }

        .badge-secondary {
            background: var(--bg-secondary);
            color: var(--text-secondary);
        }

        .total-row {
            background: var(--bg-secondary);
            font-weight: 600;
        }

        /* Top Holdings */
        .holdings-list {
            display: grid;
            gap: 12px;
        }

        .holding-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }

        .holding-item:last-child {
            border-bottom: none;
        }

        .holding-rank {
            width: 28px;
            height: 28px;
            background: var(--bg-secondary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8125rem;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .holding-info {
            flex: 1;
        }

        .holding-symbol {
            font-weight: 600;
        }

        .holding-values {
            text-align: right;
        }

        .holding-amount {
            font-weight: 600;
        }

        .holding-pct {
            font-size: 0.8125rem;
            color: var(--text-muted);
        }

        /* Footer */
        footer {
            text-align: center;
            padding: 40px 0;
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        /* ========== LANDING PAGE SECTIONS ========== */

        /* Hero Subheadline */
        .hero-subheadline {
            color: var(--primary);
            font-size: 1.125rem;
            font-weight: 500;
            text-align: center;
            margin-top: 12px;
            opacity: 0.9;
        }

        /* Landing Sections Container */
        .landing-sections {
            margin-top: 0;
            margin-bottom: 0;
        }

        .landing-section {
            padding: var(--section-padding-y) 0;
        }

        .section-header {
            text-align: center;
            margin-bottom: 48px;
        }

        .section-title {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: -0.02em;
            margin-bottom: 12px;
        }

        .section-subtitle {
            font-size: 1.125rem;
            color: var(--text-secondary);
            max-width: 600px;
            margin: 0 auto;
            line-height: 1.6;
        }

        .section-heading {
            font-size: 44px;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: var(--heading-gap);
            text-align: center;
            letter-spacing: -0.03em;
        }

        .section-subheading {
            font-size: 1.125rem;
            color: var(--text-secondary);
            line-height: 1.7;
            margin-bottom: var(--content-gap);
            text-align: center;
        }

        /* ========== HERO SECTION - STRIPE-INSPIRED ========== */
        .hero-section {
            width: 100%;
            padding: 48px 0 48px;
            position: relative;
            background:
                radial-gradient(ellipse 80% 60% at 15% 45%, rgba(99, 91, 255, 0.1) 0%, transparent 60%),
                radial-gradient(ellipse 60% 80% at 85% 25%, rgba(0, 212, 170, 0.07) 0%, transparent 55%),
                radial-gradient(ellipse 50% 50% at 50% 90%, rgba(162, 89, 255, 0.06) 0%, transparent 50%),
                linear-gradient(180deg, #F6F9FC 0%, #EEF2F7 100%);
            overflow: hidden;
        }

        .hero-section::before {
            content: '';
            position: absolute;
            inset: 0;
            background-image: radial-gradient(circle, rgba(99, 91, 255, 0.05) 1px, transparent 1px);
            background-size: 28px 28px;
            pointer-events: none;
            z-index: 0;
        }

        .hero-inner {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 24px;
            position: relative;
            z-index: 1;
        }

        /* Hero page load animation */
        .hero-inner [data-hero-animate] {
            opacity: 0;
            transform: translateY(24px);
            animation: heroFadeIn 0.7s ease forwards;
        }

        @keyframes heroFadeIn {
            to { opacity: 1; transform: translateY(0); }
        }

        /* Section Dividers - Stripe-style waves */
        .section-divider {
            line-height: 0;
            margin: 0;
            padding: 0;
            height: var(--section-divider-height);
            overflow: hidden;
        }

        .section-divider svg {
            display: block;
            width: 100%;
            height: 100%;
        }

        .section-divider-inverted {
            transform: rotate(180deg);
        }

        /* Light to Dark transition (preview  value-props) */
        .section-divider-light-to-dark {
            background: transparent;
        }

        /* Dark to Light transition (value-props  trust) */
        .section-divider-dark-to-light {
            background: #0A2540;
        }

        .hero-grid {
            display: grid;
            grid-template-columns: 1.1fr 0.9fr;
            gap: 60px;
            align-items: start;
            max-width: 1200px;
            margin: 0 auto;
        }

        .hero-content {
            max-width: 560px;
        }

        .hero-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(99, 91, 255, 0.1);
            color: var(--primary);
            font-size: 0.8125rem;
            font-weight: 600;
            padding: 8px 16px;
            border-radius: 50px;
            margin-bottom: 24px;
        }

        .hero-badge svg {
            width: 16px;
            height: 16px;
        }

        .hero-title {
            font-size: 3.5rem;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1.1;
            letter-spacing: -0.02em;
            margin-bottom: 24px;
        }

        .hero-subtitle {
            font-size: 1.25rem;
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: 36px;
            max-width: 480px;
        }

        .hero-ctas {
            display: flex;
            align-items: center;
            gap: 24px;
            flex-wrap: wrap;
        }

        .hero-cta-primary {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            background: var(--primary);
            color: white;
            font-size: 1rem;
            font-weight: 600;
            padding: 16px 28px;
            border-radius: var(--radius-md);
            border: none;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s, background 0.2s;
            box-shadow: 0 4px 14px rgba(99, 91, 255, 0.35);
        }

        .hero-cta-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(99, 91, 255, 0.4);
        }

        .hero-cta-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            color: var(--text-secondary);
            font-size: 0.9375rem;
            font-weight: 500;
            text-decoration: none;
            transition: color 0.2s;
        }

        .hero-cta-link:hover {
            color: var(--primary);
        }

        .hero-cta-link svg {
            width: 16px;
            height: 16px;
            transition: transform 0.2s;
        }

        .hero-cta-link:hover svg {
            transform: translateX(3px);
        }

        .hero-trust-line {
            font-size: 13px;
            color: #94A3B8;
            margin-top: 20px;
            letter-spacing: 0.01em;
        }

        /* Hero Upload Widget */
        .hero-upload-wrapper {
            position: relative;
        }

        .hero-upload-glow {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 120%;
            height: 120%;
            background: radial-gradient(circle, rgba(99, 91, 255, 0.15) 0%, transparent 70%);
            pointer-events: none;
            z-index: 0;
        }

        .hero-upload-card {
            position: relative;
            z-index: 1;
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            border: 1px solid rgba(10, 37, 64, 0.04);
            padding: 40px;
            box-shadow: 0 25px 60px rgba(10, 37, 64, 0.12), 0 0 0 1px rgba(10, 37, 64, 0.04);
            transition: transform 0.4s ease, box-shadow 0.4s ease;
        }

        .hero-upload-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 35px 80px rgba(10, 37, 64, 0.16), 0 0 0 1px rgba(10, 37, 64, 0.04);
        }

        .hero-upload-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 40px 80px rgba(10, 37, 64, 0.15);
        }

        @media (max-width: 900px) {
            .hero-grid {
                grid-template-columns: 1fr;
                gap: 48px;
                text-align: center;
            }

            .hero-content {
                max-width: 100%;
            }

            .hero-title {
                font-size: 2.5rem;
            }

            .hero-subtitle {
                margin-left: auto;
                margin-right: auto;
            }

            .hero-ctas {
                justify-content: center;
            }

            .hero-badge {
                margin-left: auto;
                margin-right: auto;
            }
        }

        @media (max-width: 480px) {
            .hero-title {
                font-size: 2rem;
            }

            .hero-subtitle {
                font-size: 1.0625rem;
            }

            .hero-ctas {
                flex-direction: column;
                gap: 16px;
            }
        }

        /* Upload Drop Area (inside hero) */
        .upload-drop-area {
            text-align: center;
            padding: 32px 24px;
            border: 2px dashed #CBD5E1;
            border-radius: var(--radius-lg);
            margin: 8px;
            background: linear-gradient(180deg, rgba(99, 91, 255, 0.02) 0%, rgba(99, 91, 255, 0.05) 100%);
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .upload-drop-area:hover {
            border-color: var(--primary);
            background: linear-gradient(180deg, rgba(99, 91, 255, 0.04) 0%, rgba(99, 91, 255, 0.08) 100%);
        }

        .upload-drop-area.dragover {
            border: 2px dashed var(--primary);
            background: rgba(99, 91, 255, 0.08);
            border-radius: var(--radius-lg);
            box-shadow: 0 0 0 4px rgba(99, 91, 255, 0.1);
        }

        .hero-upload-card .entry-methods {
            display: flex;
            justify-content: center;
            gap: 8px;
            background: var(--bg-secondary);
            padding: 6px;
            border-radius: var(--radius-md);
        }

        .hero-upload-card .entry-method-btn {
            font-size: 0.8125rem;
            padding: 8px 14px;
        }

        /* How It Works Section - Dark Bento Cards */
        .how-it-works {
            background: #0A2540;
            padding: 40px 0 48px;
            position: relative;
        }

        /* Subtle grid texture background */
        .how-it-works::before {
            content: '';
            position: absolute;
            inset: 0;
            background-image:
                linear-gradient(rgba(255,255,255,0.02) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.02) 1px, transparent 1px);
            background-size: 48px 48px;
            pointer-events: none;
            z-index: 0;
        }

        .how-it-works > .container {
            position: relative;
            z-index: 1;
        }

        /* Section badge pill */
        .how-it-works .section-badge {
            display: inline-block;
            background: rgba(99, 91, 255, 0.15);
            color: #A78BFA;
            font-size: 13px;
            font-weight: 600;
            padding: 6px 16px;
            border-radius: 100px;
            letter-spacing: 0.5px;
            margin-bottom: 16px;
            text-transform: uppercase;
        }

        .how-it-works .section-heading {
            color: #FFFFFF;
            font-size: 44px;
            font-weight: 800;
            letter-spacing: -0.03em;
            margin-bottom: var(--heading-gap);
        }

        .how-it-works .section-subheading {
            color: #94A3B8;
            font-size: 18px;
            margin-bottom: var(--content-gap);
        }

        .how-it-works-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 24px;
            max-width: 1000px;
            margin: 0 auto;
            position: relative;
        }

        /* Grid with connectors on desktop */
        @media (min-width: 768px) {
            .how-it-works-grid {
                display: grid;
                grid-template-columns: 1fr auto 1fr auto 1fr;
                gap: 0 16px;
                align-items: stretch;
            }

            .step-connector {
                align-self: center;
            }
        }

        .how-it-works-step,
        .step-card {
            text-align: center;
            padding: 40px 28px 36px;
            position: relative;
            background: #112840;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.06);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.15);
        }

        .how-it-works-step::before,
        .step-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #635BFF, #A259FF, #00D4AA);
            background-size: 200% 100%;
            border-radius: 20px 20px 0 0;
            transition: background-position 0.6s ease;
        }

        .how-it-works-step:hover::before,
        .step-card:hover::before {
            background-position: 100% 0;
        }

        .how-it-works-step:hover,
        .step-card:hover {
            transform: translateY(-8px);
            background: #152D4A;
            border-color: rgba(99, 91, 255, 0.3);
            box-shadow: 0 24px 48px rgba(0, 0, 0, 0.3), 0 0 0 1px rgba(99, 91, 255, 0.15);
        }

        .step-number {
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, #635BFF, #7C3AED);
            color: #FFFFFF;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            font-weight: 800;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            margin: 0 auto 24px;
            box-shadow: 0 4px 16px rgba(99, 91, 255, 0.4);
            position: relative;
            z-index: 1;
        }

        .step-icon {
            width: 72px;
            height: 72px;
            background: rgba(0, 212, 170, 0.12);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            color: #00D4AA !important;
            transition: all 0.3s ease;
        }

        .step-card:hover .step-icon {
            background: rgba(0, 212, 170, 0.2);
            transform: scale(1.08);
        }

        .how-it-works .step-icon svg,
        .step-card .step-icon svg {
            width: 32px;
            height: 32px;
            color: #00D4AA !important;
            stroke: currentColor !important;
        }

        .how-it-works .step-title,
        .step-card .step-title {
            font-size: 20px;
            font-weight: 700;
            color: #FFFFFF;
            margin-bottom: 12px;
            letter-spacing: -0.01em;
        }

        .how-it-works .step-description,
        .step-card .step-description {
            font-size: 15px;
            color: #B0BEC5;
            line-height: 1.7;
        }

        .how-it-works-step:hover .step-number,
        .step-card:hover .step-number {
            transform: scale(1.1);
            box-shadow: 0 8px 24px rgba(99, 91, 255, 0.5);
        }

        /* Step connector arrows */
        .step-connector {
            display: none;
            align-items: center;
            justify-content: center;
            padding-top: 80px;
        }

        .step-connector svg {
            width: 40px;
            height: 2px;
        }

        @media (min-width: 768px) {
            .step-connector {
                display: flex;
            }
        }

        @media (max-width: 767px) {
            .how-it-works-grid {
                display: flex;
                flex-direction: column;
                gap: 24px;
            }
            .step-connector {
                display: none;
            }
        }

        /* ========== SOCIAL PROOF SECTION ========== */

        .social-proof-section {
            background: #0A2540;
            padding: 48px 0;
            border-top: 1px solid rgba(255, 255, 255, 0.06);
        }

        .social-proof-container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 0 24px;
        }

        .social-proof-stats {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 64px;
            flex-wrap: wrap;
        }

        .social-proof-stat {
            text-align: center;
        }

        .social-proof-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: #ffffff;
            letter-spacing: -0.02em;
            line-height: 1;
            margin-bottom: 8px;
        }

        .social-proof-number span {
            color: #635bff;
        }

        .social-proof-label {
            font-size: 0.875rem;
            color: #8899AA;
            letter-spacing: 0.02em;
        }

        .social-proof-divider {
            width: 1px;
            height: 48px;
            background: rgba(255, 255, 255, 0.1);
        }

        .social-proof-testimonial {
            margin-top: 40px;
            text-align: center;
            max-width: 700px;
            margin-left: auto;
            margin-right: auto;
        }

        .testimonial-quote {
            font-size: 1.25rem;
            color: rgba(255, 255, 255, 0.9);
            font-style: italic;
            line-height: 1.6;
            margin-bottom: 16px;
        }

        .testimonial-author {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .testimonial-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #635bff 0%, #a259ff 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 1rem;
        }

        .testimonial-info {
            text-align: left;
        }

        .testimonial-name {
            color: #ffffff;
            font-weight: 600;
            font-size: 0.9375rem;
        }

        .testimonial-role {
            color: #8899AA;
            font-size: 0.8125rem;
        }

        @media (max-width: 768px) {
            .social-proof-stats {
                gap: 32px;
            }

            .social-proof-divider {
                display: none;
            }

            .social-proof-number {
                font-size: 2rem;
            }

            .testimonial-quote {
                font-size: 1.0625rem;
            }
        }

        /* Preview Grid - 2x2 layout with Browser Frame */
        .preview-section {
            background: linear-gradient(180deg, #F6F9FC 0%, #FFFFFF 50%, #F6F9FC 100%);
            padding: var(--section-padding-y) 0;
        }

        /* Section badge pill */
        .preview-section .section-badge {
            display: inline-block;
            background: rgba(99, 91, 255, 0.08);
            color: #635BFF;
            font-size: 13px;
            font-weight: 600;
            padding: 6px 16px;
            border-radius: 100px;
            letter-spacing: 0.5px;
            margin-bottom: 16px;
            text-transform: uppercase;
        }

        .preview-section .section-heading {
            font-size: 44px;
            font-weight: 800;
            color: #0A2540;
            letter-spacing: -0.03em;
            margin-bottom: var(--heading-gap);
        }

        .preview-section .section-subheading {
            font-size: 20px;
            color: #556B7E;
            margin-bottom: var(--content-gap);
        }

        /* Browser Frame */
        .browser-frame {
            background: #FFFFFF;
            border-radius: 16px;
            box-shadow:
                0 50px 100px -20px rgba(10, 37, 64, 0.2),
                0 30px 60px -15px rgba(99, 91, 255, 0.07),
                0 0 0 1px rgba(10, 37, 64, 0.04);
            overflow: hidden;
            max-width: 1000px;
            margin: 0 auto;
            transform: perspective(2000px) rotateY(-1deg) rotateX(1deg);
            transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.6s ease;
            position: relative;
        }

        /* Shine overlay on browser frame */
        .browser-frame::after {
            content: '';
            position: absolute;
            top: 0;
            left: -50%;
            width: 200%;
            height: 50%;
            background: linear-gradient(
                180deg,
                rgba(255, 255, 255, 0.04) 0%,
                transparent 100%
            );
            pointer-events: none;
            z-index: 1;
        }

        .browser-frame:hover {
            transform: perspective(1500px) rotateX(0deg);
            box-shadow:
                0 60px 120px -20px rgba(10, 37, 64, 0.22),
                0 35px 70px -15px rgba(99, 91, 255, 0.1),
                0 0 0 1px rgba(10, 37, 64, 0.06);
        }

        .browser-header {
            background: #F5F5F5;
            padding: 14px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 1px solid #E3E8EE;
        }

        .browser-dots {
            display: flex;
            gap: 8px;
        }

        .browser-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            box-shadow: inset 0 -1px 2px rgba(0,0,0,0.2);
        }

        .browser-dot.red { background: #FF5F57 !important; }
        .browser-dot.yellow { background: #FFBD2E !important; }
        .browser-dot.green { background: #27C93F !important; }

        .browser-url-bar {
            flex: 1;
            background: #FFFFFF;
            border: 1px solid #E0E4E8;
            border-radius: 8px;
            padding: 8px 14px;
            font-size: 13px;
            color: #425466;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .browser-url-bar svg {
            width: 14px;
            height: 14px;
            color: var(--success);
        }

        .browser-content {
            padding: 28px;
            background: #F6F9FC;
        }

        .preview-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .preview-card {
            background: #FFFFFF;
            border-radius: 14px;
            padding: 24px;
            border: 1px solid rgba(0, 0, 0, 0.06);
            box-shadow: 0 2px 8px rgba(10, 37, 64, 0.06);
            transition: all 0.3s ease;
            position: relative;
        }

        .preview-card:hover {
            box-shadow: 0 8px 24px rgba(10, 37, 64, 0.1);
            transform: translateY(-2px);
        }

        /* Colored left borders for each preview card */
        .preview-grid .preview-card:nth-child(1) {
            border-left: 4px solid #635BFF; /* Asset Allocation - Purple */
        }
        .preview-grid .preview-card:nth-child(2) {
            border-left: 4px solid #FFBD2E; /* Risk Score - Amber */
        }
        .preview-grid .preview-card:nth-child(3) {
            border-left: 4px solid #00D4AA; /* Sector Exposure - Teal */
        }
        .preview-grid .preview-card:nth-child(4) {
            border-left: 4px solid #FF5F57; /* Fee Analysis - Red */
        }
        .preview-grid .preview-card:nth-child(5) {
            border-left: 4px solid #4F46E5; /* Performance Analysis - Indigo */
            grid-column: 1 / -1; /* span full width */
        }

        .preview-card-header h3 {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .preview-card-header h3::before {
            content: '';
            width: 4px;
            height: 16px;
            border-radius: 2px;
        }

        /* Keep the header accent bars too */
        .preview-grid .preview-card:nth-child(1) .preview-card-header h3::before {
            background: #635BFF;
        }
        .preview-grid .preview-card:nth-child(2) .preview-card-header h3::before {
            background: #FFBD2E;
        }
        .preview-grid .preview-card:nth-child(3) .preview-card-header h3::before {
            background: #00D4AA;
        }
        .preview-grid .preview-card:nth-child(4) .preview-card-header h3::before {
            background: #FF5F57;
        }
        .preview-grid .preview-card:nth-child(5) .preview-card-header h3::before {
            background: #4F46E5;
        }

        .preview-card-body {
            min-height: 200px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        @media (max-width: 768px) {
            .browser-frame {
                transform: none;
                margin: 0 16px;
            }
            .preview-grid {
                grid-template-columns: 1fr;
            }
            .preview-grid .preview-card:nth-child(5) {
                grid-column: 1; /* no span on mobile single-column grid */
            }
            .preview-section .section-heading {
                font-size: 28px;
            }
            .preview-section .section-subheading {
                font-size: 16px;
            }
        }

        /* Performance Analysis Card Styles */
        .pv-performance {
            display: flex;
            align-items: center;
            gap: 32px;
            width: 100%;
        }

        .pv-perf-summary {
            display: flex;
            gap: 24px;
            flex-shrink: 0;
        }

        .pv-perf-metric {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .pv-perf-value {
            font-size: 24px;
            font-weight: 700;
            color: #0A2540;
        }

        .pv-perf-value.positive {
            color: #00D4AA;
        }

        .pv-perf-label {
            font-size: 11px;
            color: #94A3B8;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 500;
        }

        .pv-perf-chart {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .pv-perf-bars {
            display: flex;
            align-items: flex-end;
            gap: 6px;
            height: 64px;
            width: 100%;
            justify-content: center;
        }

        .pv-perf-bar {
            width: 100%;
            max-width: 28px;
            border-radius: 3px 3px 0 0;
            transition: opacity 0.2s;
        }

        .pv-perf-bar.positive {
            background: linear-gradient(180deg, #00D4AA, #00B894);
        }

        .pv-perf-bar.negative {
            background: linear-gradient(180deg, #FF6B6B, #EE5A5A);
        }

        .pv-perf-chart-label {
            font-size: 10px;
            color: #94A3B8;
            text-transform: uppercase;
            letter-spacing: 0.04em;
        }

        @media (max-width: 768px) {
            .pv-performance {
                flex-direction: column;
                gap: 20px;
            }

            .pv-perf-summary {
                width: 100%;
                justify-content: space-around;
            }

            .pv-perf-value {
                font-size: 20px;
            }
        }

        .preview-grid .preview-card:nth-child(5) .preview-card-body {
            min-height: auto;
            padding: 8px 0;
        }

        /* ========== PREVIEW SECTION CHARTS (unique pv- prefix) ========== */

        /* Preview Donut Chart */
        .pv-donut {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
            width: 100%;
        }

        .pv-donut-ring {
            width: 130px;
            height: 130px;
            border-radius: 50%;
            background: conic-gradient(
                #635BFF 0deg 223deg,
                #00D4AA 223deg 310deg,
                #F7B955 310deg 360deg
            );
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .pv-donut-ring::before {
            content: '';
            position: absolute;
            width: 75px;
            height: 75px;
            background: var(--bg-primary);
            border-radius: 50%;
        }

        .pv-donut-value {
            position: relative;
            z-index: 1;
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1;
        }

        .pv-donut-label {
            position: relative;
            z-index: 1;
            font-size: 0.625rem;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .pv-donut-legend {
            display: flex;
            flex-direction: row;
            justify-content: center;
            gap: 14px;
            width: 100%;
        }

        .pv-legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .pv-dot {
            width: 8px;
            height: 8px;
            border-radius: 2px;
            flex-shrink: 0;
        }

        .pv-dot-stocks { background: #635BFF; }
        .pv-dot-bonds { background: #00D4AA; }
        .pv-dot-cash { background: #F7B955; }

        /* Preview Gauge Chart */
        .pv-gauge {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
        }

        .pv-gauge-arc {
            width: 130px;
            height: 65px;
            background: conic-gradient(
                from 180deg,
                #00D4AA 0deg 60deg,
                #F7B955 60deg 120deg,
                #FF6B6B 120deg 180deg
            );
            border-radius: 130px 130px 0 0;
            position: relative;
        }

        .pv-gauge-arc::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 40px;
            background: var(--bg-primary);
            border-radius: 80px 80px 0 0;
        }

        .pv-gauge-needle {
            width: 3px;
            height: 32px;
            background: var(--text-primary);
            border-radius: 2px;
            transform: rotate(24deg);
            transform-origin: bottom center;
            margin-top: -32px;
            margin-bottom: 0;
            position: relative;
            z-index: 2;
        }

        .pv-gauge-needle::after {
            content: '';
            position: absolute;
            bottom: -3px;
            left: 50%;
            transform: translateX(-50%);
            width: 7px;
            height: 7px;
            background: var(--text-primary);
            border-radius: 50%;
        }

        .pv-gauge-info {
            text-align: center;
            margin-top: 12px;
        }

        .pv-gauge-value {
            display: block;
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1;
        }

        .pv-gauge-label {
            display: inline-block;
            font-size: 0.625rem;
            font-weight: 600;
            color: #F7B955;
            background: rgba(247, 185, 85, 0.15);
            padding: 3px 8px;
            border-radius: 10px;
            margin-top: 6px;
        }

        .pv-gauge-scale {
            display: flex;
            justify-content: space-between;
            width: 130px;
            font-size: 0.5625rem;
            color: var(--text-muted);
            margin-top: 8px;
        }

        /* Preview Bar Chart */
        .pv-bars {
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 100%;
        }

        .pv-bar-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .pv-bar-label {
            width: 75px;
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-align: right;
            flex-shrink: 0;
        }

        .pv-bar-track {
            flex: 1;
            height: 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            overflow: hidden;
        }

        .pv-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #635BFF, #A259FF);
            border-radius: 4px;
            transition: width 0.6s ease;
        }

        .pv-bar-value {
            width: 36px;
            font-size: 0.8125rem;
            font-weight: 600;
            color: var(--text-primary);
            text-align: right;
            flex-shrink: 0;
        }

        /* ========== OLD DONUT (kept for compatibility) ========== */
        /* Donut Chart Mockup */
        .donut-mockup {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            width: 100%;
        }

        .donut-ring {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            background: conic-gradient(
                #635BFF 0deg 223deg,
                #00D4AA 223deg 310deg,
                #F7B955 310deg 360deg
            );
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .donut-ring::before {
            content: '';
            position: absolute;
            width: 80px;
            height: 80px;
            background: var(--bg-primary);
            border-radius: 50%;
        }

        .donut-center {
            position: absolute;
            text-align: center;
            z-index: 1;
        }

        .donut-value {
            display: block;
            font-size: 1.375rem;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1.2;
        }

        .donut-label {
            display: block;
            font-size: 0.6875rem;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .donut-legend {
            display: flex !important;
            flex-direction: row !important;
            justify-content: center !important;
            align-items: center !important;
            gap: 16px !important;
            font-size: 0.8125rem;
            width: 100%;
            margin-top: 0;
        }

        .donut-legend .legend-item {
            display: flex !important;
            align-items: center !important;
            gap: 6px !important;
            color: var(--text-secondary) !important;
            font-weight: 500;
            white-space: nowrap;
            position: static !important;
        }

        .donut-legend .legend-dot {
            width: 10px !important;
            height: 10px !important;
            border-radius: 3px !important;
            flex-shrink: 0;
        }

        .donut-legend .legend-dot.stocks { background: #635BFF !important; }
        .donut-legend .legend-dot.bonds { background: #00D4AA !important; }
        .donut-legend .legend-dot.cash { background: #F7B955 !important; }

        /* Preview Section Gauge Mockup */
        .preview-card .gauge-mockup {
            display: flex !important;
            flex-direction: column !important;
            align-items: center !important;
            width: 100% !important;
        }

        .preview-card .gauge-arc {
            width: 140px !important;
            height: 70px !important;
            background: conic-gradient(
                from 180deg,
                #00D4AA 0deg 60deg,
                #F7B955 60deg 120deg,
                #FF6B6B 120deg 180deg
            ) !important;
            border-radius: 140px 140px 0 0 !important;
            position: relative !important;
            overflow: visible !important;
        }

        .preview-card .gauge-arc::before {
            content: '' !important;
            position: absolute !important;
            bottom: 0 !important;
            left: 50% !important;
            transform: translateX(-50%) !important;
            width: 90px !important;
            height: 45px !important;
            background: var(--bg-primary) !important;
            border-radius: 90px 90px 0 0 !important;
        }

        .preview-card .gauge-needle {
            width: 3px !important;
            height: 35px !important;
            background: var(--text-primary) !important;
            position: absolute !important;
            bottom: 0 !important;
            left: 50% !important;
            transform-origin: bottom center !important;
            transform: translateX(-50%) rotate(24deg) !important;
            border-radius: 2px !important;
            z-index: 2 !important;
        }

        .preview-card .gauge-needle::after {
            content: '' !important;
            position: absolute !important;
            bottom: -4px !important;
            left: 50% !important;
            transform: translateX(-50%) !important;
            width: 8px !important;
            height: 8px !important;
            background: var(--text-primary) !important;
            border-radius: 50% !important;
        }

        .preview-card .gauge-center {
            text-align: center !important;
            margin-top: 20px !important;
        }

        .preview-card .gauge-value {
            display: block !important;
            font-size: 2.25rem !important;
            font-weight: 700 !important;
            color: var(--text-primary) !important;
            line-height: 1 !important;
        }

        .preview-card .gauge-label {
            display: inline-block !important;
            font-size: 0.6875rem !important;
            color: #F7B955 !important;
            font-weight: 600 !important;
            margin-top: 8px !important;
            background: rgba(247, 185, 85, 0.15) !important;
            padding: 3px 10px !important;
            border-radius: 12px !important;
        }

        .preview-card .gauge-scale {
            display: flex !important;
            justify-content: space-between !important;
            width: 140px !important;
            font-size: 0.625rem !important;
            color: var(--text-muted) !important;
            margin-top: 12px !important;
        }

        /* Preview Section Bar Chart */
        .preview-card .bar-mockup {
            display: flex !important;
            flex-direction: column !important;
            align-items: stretch !important;
            gap: 12px !important;
            width: 100% !important;
            height: auto !important;
            padding: 0 !important;
        }

        .preview-card .bar-item {
            display: flex !important;
            flex-direction: row !important;
            align-items: center !important;
            gap: 12px !important;
            width: 100% !important;
        }

        .preview-card .bar-label {
            font-size: 0.8125rem;
            color: var(--text-secondary);
            width: 80px;
            min-width: 80px;
            text-align: right;
            flex-shrink: 0;
        }

        .preview-card .bar-track {
            flex: 1 !important;
            height: 8px !important;
            background: var(--bg-tertiary) !important;
            border-radius: 4px !important;
            overflow: hidden !important;
            min-width: 80px !important;
        }

        .preview-card .bar-fill {
            height: 100% !important;
            background: linear-gradient(90deg, #635BFF 0%, #818CF8 100%) !important;
            border-radius: 4px !important;
        }

        .preview-card .bar-value {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-primary);
            width: 40px;
            min-width: 40px;
            text-align: right;
            flex-shrink: 0;
        }

        /* Fee Analysis Mockup */
        .fee-mockup {
            display: flex;
            flex-direction: column;
            gap: 20px;
            width: 100%;
        }

        .fee-stat {
            text-align: center;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }

        .fee-amount {
            display: block;
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1;
        }

        .fee-label {
            display: block;
            font-size: 0.9375rem;
            color: var(--text-muted);
            margin-top: 6px;
        }

        .fee-breakdown {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .fee-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9375rem;
            color: var(--text-secondary);
            padding: 10px 14px;
            background: var(--bg-secondary);
            border-radius: 8px;
        }

        .fee-item svg {
            flex-shrink: 0;
            width: 18px;
            height: 18px;
        }

        .fee-item.warning {
            background: rgba(247, 185, 85, 0.1);
            border: 1px solid rgba(247, 185, 85, 0.2);
        }

        .fee-item.warning svg {
            color: #F7B955;
        }

        .fee-item:not(.warning) svg {
            color: #00D4AA;
        }

        .fee-savings {
            background: rgba(0, 212, 170, 0.1);
            border: 1px solid rgba(0, 212, 170, 0.25);
            padding: 14px 20px;
            border-radius: 10px;
            text-align: center;
            font-size: 1rem;
            color: #00B894;
            font-weight: 600;
        }

        .fee-savings strong {
            color: #00B894;
            font-size: 20px;
            font-weight: 800;
        }

        /* Value Props Section - Dark 2x2 Grid */
        .value-props {
            background: #0A2540;
            padding: var(--section-padding-y) 0;
        }

        .value-props .section-heading {
            color: #FFFFFF;
            font-size: 44px;
            font-weight: 800;
            letter-spacing: -0.03em;
            margin-bottom: var(--heading-gap);
        }

        .value-props .section-subheading {
            color: #94A3B8;
            margin-bottom: var(--content-gap);
        }

        .value-props-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 24px;
            max-width: 900px;
            margin: 0 auto;
        }

        .value-card {
            text-align: left;
            background: #112840;
            border-radius: var(--radius-lg);
            padding: 32px;
            border: 1px solid var(--dark-border);
            transition: all 0.3s ease;
        }

        .value-card:hover {
            border-color: rgba(99, 91, 255, 0.4);
            box-shadow: 0 0 30px rgba(99, 91, 255, 0.15);
            transform: translateY(-2px);
        }

        .value-icon {
            width: 56px;
            height: 56px;
            background: rgba(99, 91, 255, 0.15);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
        }

        .value-icon svg {
            width: 28px;
            height: 28px;
            color: #635BFF;
        }

        .value-props .value-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #FFFFFF;
            margin-bottom: 10px;
        }

        .value-props .value-description {
            font-size: 1rem;
            color: #94A3B8;
            line-height: 1.7;
        }

        /* Trust Section - Marquee */
        /* Compact Brokerage Strip (inside hero section) */
        .brokerage-strip {
            background: transparent;
            padding: 16px 24px 0;
            margin-top: 32px;
            text-align: center;
        }

        .brokerage-strip-label {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: #8899AA;
            margin: 0 0 12px 0;
        }

        .brokerage-strip-logos {
            overflow: hidden;
            position: relative;
            max-width: 1000px;
            margin: 0 auto;
            -webkit-mask-image: linear-gradient(to right, transparent, black 8%, black 92%, transparent);
            mask-image: linear-gradient(to right, transparent, black 8%, black 92%, transparent);
        }

        .brokerage-strip-track {
            display: flex;
            align-items: center;
            gap: 40px;
            animation: scrollLogosStrip 30s linear infinite;
            width: max-content;
        }

        .brokerage-strip-track:hover {
            animation-play-state: paused;
        }

        @keyframes scrollLogosStrip {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }

        .brokerage-strip-track .brokerage-logo {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
            opacity: 0.5;
            transition: opacity 0.2s;
        }

        .brokerage-strip-track .brokerage-logo:hover {
            opacity: 0.8;
        }

        .brokerage-strip-track .brokerage-logo-img {
            width: 20px;
            height: 20px;
            object-fit: contain;
        }

        .brokerage-strip-track .brokerage-name {
            font-size: 13px;
            font-weight: 500;
            color: #425466;
            white-space: nowrap;
        }

        .brokerage-strip-more {
            font-size: 12px;
            color: #8899AA;
            margin: 10px 0 0 0;
        }

        @media (max-width: 768px) {
            .brokerage-strip {
                padding: 12px 16px 16px;
            }

            .brokerage-strip-label {
                font-size: 10px;
                margin-bottom: 10px;
            }

            .brokerage-strip-track {
                gap: 28px;
            }

            .brokerage-strip-track .brokerage-logo-img {
                width: 18px;
                height: 18px;
            }

            .brokerage-strip-track .brokerage-name {
                font-size: 12px;
            }

            .brokerage-strip-more {
                font-size: 11px;
                margin-top: 8px;
            }

            .section-divider.hero-to-dark {
                height: 40px;
            }
        }

        .trust-section {
            background: var(--bg-primary);
            text-align: center;
            padding: 56px 0;
            overflow: hidden;
        }

        /* Wave divider: Hero area to How It Works (dark navy) */
        .section-divider.hero-to-dark {
            height: 50px;
            background: transparent;
            line-height: 0;
            overflow: hidden;
            margin: 0;
            padding: 0;
        }

        .section-divider.hero-to-dark svg {
            width: 100%;
            height: 100%;
            display: block;
            margin: 0;
            padding: 0;
        }

        .trust-label {
            font-size: 1rem;
            color: #425466;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            margin-bottom: 32px;
            font-weight: 500;
        }

        .marquee-container {
            position: relative;
            width: 100%;
            overflow: hidden;
        }

        .marquee-container::before,
        .marquee-container::after {
            content: '';
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100px;
            z-index: 2;
            pointer-events: none;
        }

        .marquee-container::before {
            left: 0;
            background: linear-gradient(to right, var(--bg-primary), transparent);
        }

        .marquee-container::after {
            right: 0;
            background: linear-gradient(to left, var(--bg-primary), transparent);
        }

        .marquee-track {
            display: flex;
            animation: marquee 45s linear infinite;
            width: max-content;
        }

        .marquee-track:hover {
            animation-play-state: paused;
        }

        @keyframes marquee {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }

        .brokerage-logos {
            display: flex;
            align-items: center;
            gap: 0;
            padding: 0;
        }

        .brokerage-logo {
            flex-shrink: 0;
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 0 48px;
            transition: opacity 0.3s ease;
        }

        .brokerage-logo:hover {
            opacity: 1;
        }

        .brokerage-logo-img {
            height: 28px;
            width: auto;
            filter: grayscale(100%) opacity(0.7);
            transition: filter 0.3s ease;
        }

        .brokerage-logo:hover .brokerage-logo-img {
            filter: grayscale(0%) opacity(1);
        }

        .brokerage-name {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-muted);
            white-space: nowrap;
            transition: color 0.3s ease;
        }

        .brokerage-logo:hover .brokerage-name {
            color: var(--text-primary);
        }

        .brokerage-name.fallback-only {
            display: none;
        }

        .trust-note {
            font-size: 0.875rem;
            color: var(--text-muted);
            margin-top: 32px;
        }

        /* CTA Section - Animated Gradient */
        .cta-section {
            background: linear-gradient(-45deg, #635BFF, #A259FF, #4B45C6, #7C3AED);
            background-size: 400% 400%;
            animation: ctaGradientFlow 8s ease infinite;
            padding: var(--section-padding-y) 24px;
            text-align: center;
            border-radius: var(--radius-lg);
            margin: 0 24px;
            position: relative;
            overflow: hidden;
        }

        .cta-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
            opacity: 0.03;
            pointer-events: none;
        }

        @keyframes ctaGradientFlow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .cta-heading {
            font-size: 3rem;
            font-weight: 700;
            color: white;
            margin-bottom: 16px;
            letter-spacing: -0.02em;
            position: relative;
            z-index: 1;
        }

        .cta-subheading {
            font-size: 1.25rem;
            color: rgba(255, 255, 255, 0.9);
            position: relative;
            z-index: 1;
            margin-bottom: 40px;
        }

        .cta-button {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            background: white;
            color: #0A2540;
            font-size: 1.125rem;
            font-weight: 600;
            padding: 20px 40px;
            border-radius: 12px;
            border: none;
            position: relative;
            z-index: 1;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .cta-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.25);
        }

        /* ========== FAQ SECTION ========== */

        .faq-section {
            background: #f6f9fc;
            padding: var(--section-padding-y) 0;
        }

        .faq-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .faq-header {
            text-align: center;
            margin-bottom: 48px;
        }

        .faq-title {
            font-size: 2.5rem;
            font-weight: 700;
            color: #0A2540;
            margin-bottom: 16px;
            letter-spacing: -0.02em;
        }

        .faq-subtitle {
            font-size: 1.125rem;
            color: #425466;
        }

        .faq-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .faq-item {
            background: white;
            border-radius: 12px;
            border: 1px solid #e6ebf1;
            overflow: hidden;
            transition: box-shadow 0.2s ease;
        }

        .faq-item:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .faq-question {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            background: none;
            border: none;
            cursor: pointer;
            text-align: left;
            font-size: 1rem;
            font-weight: 600;
            color: #0A2540;
            transition: background 0.2s ease;
        }

        .faq-question:hover {
            background: #f6f9fc;
        }

        .faq-icon {
            width: 24px;
            height: 24px;
            flex-shrink: 0;
            color: #635bff;
            transition: transform 0.3s ease;
        }

        .faq-item.active .faq-icon {
            transform: rotate(45deg);
        }

        .faq-answer {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, padding 0.3s ease;
        }

        .faq-item.active .faq-answer {
            max-height: 300px;
        }

        .faq-answer-content {
            padding: 0 24px 20px;
            color: #425466;
            line-height: 1.6;
        }

        .faq-answer-content a {
            color: #635bff;
            text-decoration: none;
        }

        .faq-answer-content a:hover {
            text-decoration: underline;
        }

        /* ========== MINIMAL FOOTER ========== */

        .site-footer {
            background: #0A2540;
            color: #8899AA;
            padding: 0;
            margin: 0;
        }

        .footer-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 56px 24px 32px;
        }

        /* --- Row 1: Brand + Nav --- */
        .footer-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding-bottom: 40px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }

        .footer-logo-link {
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
        }

        .footer-logo-icon {
            width: 32px;
            height: 32px;
            background: #635BFF;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .footer-logo-icon svg {
            width: 20px;
            height: 20px;
        }

        .footer-brand-name {
            font-size: 18px;
            font-weight: 700;
            color: #FFFFFF;
            letter-spacing: -0.01em;
        }

        .footer-nav {
            display: flex;
            gap: 56px;
        }

        .footer-nav-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .footer-nav-label {
            font-size: 12px;
            font-weight: 600;
            color: #FFFFFF;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            margin-bottom: 4px;
        }

        .footer-nav-group a {
            font-size: 14px;
            color: #8899AA;
            text-decoration: none;
            transition: color 0.15s;
        }

        .footer-nav-group a:hover {
            color: #FFFFFF;
        }

        /* --- Row 2: Disclaimer --- */
        .footer-disclaimer {
            font-size: 12px;
            line-height: 1.6;
            color: #5A6B7A;
            padding: 24px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            max-width: 800px;
        }

        /* --- Row 3: Bottom bar --- */
        .footer-bottom {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 24px;
        }

        .footer-copyright {
            font-size: 13px;
            color: #5A6B7A;
        }

        .footer-legal-links {
            display: flex;
            gap: 24px;
        }

        .footer-legal-links a {
            font-size: 13px;
            color: #5A6B7A;
            text-decoration: none;
            transition: color 0.15s;
        }

        .footer-legal-links a:hover {
            color: #FFFFFF;
        }

        /* --- Footer Mobile --- */
        @media (max-width: 768px) {
            .footer-top {
                flex-direction: column;
                gap: 32px;
            }

            .footer-nav {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 28px;
            }

            .footer-bottom {
                flex-direction: column;
                gap: 12px;
                text-align: center;
            }

            .footer-legal-links {
                justify-content: center;
                flex-wrap: wrap;
            }
        }

        @media (max-width: 480px) {
            .footer-nav {
                grid-template-columns: 1fr;
            }
        }

        /* Landing Page Responsive */
        @media (max-width: 900px) {
            .how-it-works-grid {
                grid-template-columns: 1fr;
                max-width: 400px;
            }

            .preview-grid {
                grid-template-columns: 1fr;
            }

            .value-props-grid {
                grid-template-columns: 1fr;
                max-width: 500px;
            }

            .footer-links {
                justify-content: center;
            }
        }

        @media (max-width: 768px) {
            .value-props-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .cta-section {
                margin: 0 16px 40px;
                padding: 60px 20px;
            }

            .cta-heading {
                font-size: 1.5rem;
            }

            .footer-links {
                grid-template-columns: 1fr;
                text-align: center;
            }

            .faq-title {
                font-size: 1.75rem;
            }

            .faq-question {
                padding: 16px 20px;
                font-size: 0.9375rem;
            }

            .faq-answer-content {
                padding: 0 20px 16px;
                font-size: 0.875rem;
            }
        }

        @media (max-width: 480px) {
            .value-props-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Sample Report Preview Section */
        .report-preview-container {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border);
            padding: 32px;
            max-width: 1000px;
            margin: 0 auto;
        }

        .report-preview-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }

        .report-preview-logo {
            width: 32px;
            height: 32px;
            background: var(--primary);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .report-preview-logo svg {
            width: 20px;
            height: 20px;
        }

        .report-preview-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .report-preview-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }

        .preview-card {
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            padding: 20px;
            border: 1px solid var(--border);
        }

        .preview-card-title {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 12px;
        }

        .preview-chart-placeholder {
            height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        /* Donut Chart Mockup */
        .donut-mockup {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: conic-gradient(
                var(--primary) 0deg 180deg,
                var(--success) 180deg 270deg,
                var(--warning) 270deg 320deg,
                var(--text-muted) 320deg 360deg
            );
            position: relative;
        }

        .donut-mockup::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60px;
            height: 60px;
            background: var(--bg-secondary);
            border-radius: 50%;
        }

        /* Bar Chart Mockup */
        .bar-mockup {
            display: flex;
            align-items: flex-end;
            gap: 8px;
            height: 100%;
            padding: 10px 0;
        }

        .bar-mockup-item {
            flex: 1;
            background: var(--primary);
            border-radius: 4px 4px 0 0;
            opacity: 0.8;
        }

        .bar-mockup-item:nth-child(1) { height: 70%; }
        .bar-mockup-item:nth-child(2) { height: 45%; background: var(--primary-light); }
        .bar-mockup-item:nth-child(3) { height: 85%; }
        .bar-mockup-item:nth-child(4) { height: 60%; background: var(--primary-light); }
        .bar-mockup-item:nth-child(5) { height: 40%; }

        /* Line Chart Mockup */
        .line-mockup {
            width: 100%;
            height: 80px;
            position: relative;
        }

        .line-mockup svg {
            width: 100%;
            height: 100%;
        }

        /* Fee Display Mockup */
        .fee-mockup {
            display: flex;
            flex-direction: column;
            gap: 8px;
            width: 100%;
        }

        .fee-mockup-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: var(--bg-primary);
            border-radius: var(--radius-sm);
            font-size: 0.8125rem;
        }

        .fee-mockup-label {
            color: var(--text-secondary);
        }

        .fee-mockup-value {
            font-weight: 600;
            color: var(--text-primary);
        }

        .fee-mockup-value.highlight {
            color: var(--danger);
        }

        /* Benchmark Mockup */
        .benchmark-mockup {
            display: flex;
            flex-direction: column;
            gap: 12px;
            width: 100%;
        }

        .benchmark-row {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .benchmark-label {
            font-size: 0.8125rem;
            color: var(--text-secondary);
            width: 80px;
            flex-shrink: 0;
        }

        .benchmark-bar-container {
            flex: 1;
            height: 24px;
            background: var(--bg-primary);
            border-radius: var(--radius-sm);
            overflow: hidden;
            position: relative;
        }

        .benchmark-bar {
            height: 100%;
            border-radius: var(--radius-sm);
        }

        .benchmark-bar.portfolio {
            background: var(--primary);
            width: 75%;
        }

        .benchmark-bar.sp500 {
            background: var(--text-muted);
            width: 68%;
        }

        .benchmark-value {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Value Props Section */
        .value-props-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 24px;
            max-width: 1100px;
            margin: 0 auto;
        }

        .value-prop-card {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            padding: 28px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow-sm);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .value-prop-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-md);
        }

        .value-prop-icon {
            width: 48px;
            height: 48px;
            background: rgba(99, 91, 255, 0.1);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 16px;
        }

        .value-prop-icon svg {
            width: 24px;
            height: 24px;
            color: var(--primary);
        }

        .value-prop-title {
            font-size: 1.0625rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .value-prop-description {
            font-size: 0.9375rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        /* Social Proof / Trust Section */
        .trust-section {
            background: var(--bg-primary);
            border-top: 1px solid var(--border);
            border-bottom: 1px solid var(--border);
        }

        .trust-content {
            text-align: center;
        }

        .trust-title {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.08em;
            margin-bottom: 32px;
        }

        /* CTA Section */
        .cta-section {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
        }

        .cta-content {
            text-align: center;
            max-width: 600px;
            margin: 0 auto;
        }

        .cta-title {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 12px;
        }

        .cta-subtitle {
            font-size: 1.125rem;
            opacity: 0.9;
            margin-bottom: 28px;
        }

        .cta-button {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: white;
            color: var(--primary);
            font-size: 1rem;
            font-weight: 600;
            padding: 16px 32px;
            border-radius: var(--radius-md);
            border: none;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .cta-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
        }

        .cta-button svg {
            width: 20px;
            height: 20px;
        }

        /* Site Footer */
        .site-footer {
            background: var(--bg-primary);
            border-top: 1px solid var(--border);
            padding: 48px 0 32px;
        }

        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 24px;
        }

        .footer-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 32px;
            flex-wrap: wrap;
            gap: 32px;
        }

        .footer-brand {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .footer-links {
            display: flex;
            gap: 32px;
            flex-wrap: wrap;
        }

        .footer-link {
            font-size: 0.9375rem;
            color: var(--text-secondary);
            text-decoration: none;
            transition: color 0.2s;
        }

        .footer-link:hover {
            color: var(--primary);
        }

        .footer-bottom {
            padding-top: 24px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }

        .footer-copyright {
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        .footer-legal {
            display: flex;
            gap: 24px;
        }

        .footer-legal a {
            font-size: 0.875rem;
            color: var(--text-muted);
            text-decoration: none;
            transition: color 0.2s;
        }

        .footer-legal a:hover {
            color: var(--text-secondary);
        }

        /* Landing Page Responsive */
        @media (max-width: 1024px) {
            .value-props-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .landing-section {
                padding: 48px 0;
            }

            .section-title {
                font-size: 1.5rem;
            }

            .how-it-works-grid {
                grid-template-columns: 1fr;
                gap: 24px;
            }

            .step-connector {
                display: none;
            }

            .report-preview-grid {
                grid-template-columns: 1fr;
            }

            .value-props-grid {
                grid-template-columns: 1fr;
            }

            .cta-title {
                font-size: 1.5rem;
            }

            .footer-top {
                flex-direction: column;
                align-items: center;
                text-align: center;
            }

            .footer-links {
                justify-content: center;
            }

            .footer-bottom {
                flex-direction: column;
                text-align: center;
            }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 24px 16px;
            }

            h1 {
                font-size: 1.75rem;
            }

            .upload-card {
                padding: 32px 24px;
            }

            .charts-row {
                grid-template-columns: 1fr;
            }

            .sector-item {
                grid-template-columns: 100px 1fr 60px 60px;
                gap: 8px;
            }

            .tabs {
                padding: 3px;
            }

            .tab {
                padding: 10px 14px;
                font-size: 0.875rem;
            }

            .insights-container {
                padding: 0;
            }

            .insights-header {
                margin-bottom: 24px;
            }

            .insights-header h3 {
                font-size: 1.25rem;
            }

            .insight-card {
                padding: 16px 18px;
            }

            .insight-icon {
                width: 28px;
                height: 28px;
                font-size: 0.875rem;
            }

            .insight-title {
                font-size: 0.9375rem;
            }

            .insight-text {
                font-size: 0.875rem;
            }
        }

        /* Auth Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(10, 37, 64, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            width: 100%;
            max-width: 400px;
            margin: 24px;
            transform: translateY(20px);
            transition: transform 0.2s;
        }

        .modal-overlay.active .modal {
            transform: translateY(0);
        }

        .modal-header {
            padding: 24px 24px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 8px;
            border-radius: var(--radius-sm);
            transition: all 0.15s;
        }

        .modal-close:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .modal-body {
            padding: 24px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            font-size: 0.9375rem;
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: inherit;
            transition: all 0.15s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 91, 255, 0.1);
        }

        .form-input::placeholder {
            color: var(--text-muted);
        }

        .form-error {
            color: var(--danger);
            font-size: 0.8125rem;
            margin-top: 8px;
        }

        .auth-tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
            margin-bottom: 24px;
        }

        .auth-tab {
            flex: 1;
            padding: 12px;
            font-size: 0.9375rem;
            font-weight: 500;
            color: var(--text-muted);
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            transition: all 0.15s;
        }

        .auth-tab:hover {
            color: var(--text-primary);
        }

        .auth-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        .forgot-password-link {
            text-align: center;
            margin-top: 16px;
        }

        .forgot-password-link a,
        .back-to-login a {
            color: var(--primary);
            text-decoration: none;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .forgot-password-link a:hover,
        .back-to-login a:hover {
            text-decoration: underline;
        }

        .back-to-login {
            text-align: center;
            margin-top: 16px;
        }

        .form-description {
            color: var(--text-muted);
            font-size: 0.875rem;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .form-success {
            color: var(--success);
            font-size: 0.875rem;
            margin-top: 8px;
            padding: 12px;
            background: rgba(48, 209, 88, 0.1);
            border-radius: var(--radius-sm);
        }

        /* User Menu */
        .user-menu {
            position: relative;
        }

        .user-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-primary);
            transition: all 0.15s;
        }

        .user-btn:hover {
            border-color: var(--primary);
        }

        .user-avatar {
            width: 28px;
            height: 28px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.75rem;
        }

        .user-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-md);
            min-width: 200px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.15s;
            z-index: 100;
        }

        .user-dropdown.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-item {
            display: block;
            width: 100%;
            padding: 12px 16px;
            font-size: 0.875rem;
            color: var(--text-primary);
            background: none;
            border: none;
            text-align: left;
            cursor: pointer;
            transition: background 0.15s;
        }

        .dropdown-item:hover {
            background: var(--bg-secondary);
        }

        .dropdown-divider {
            height: 1px;
            background: var(--border);
            margin: 4px 0;
        }

        /* User Dashboard */
        .user-dashboard {
            padding: 48px 0 80px;
            min-height: calc(100vh - 72px);
            background: var(--bg-secondary);
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .dashboard-welcome h1 {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .dashboard-subtitle {
            color: var(--text-secondary);
            font-size: 1rem;
        }

        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 24px;
            margin-bottom: 48px;
        }

        .dashboard-stat-card {
            background: var(--bg-primary);
            border-radius: 12px;
            padding: 24px;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            border: 1px solid var(--border);
        }

        .dashboard-stat-number {
            display: block;
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 4px;
        }

        .dashboard-stat-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .dashboard-section {
            margin-bottom: 48px;
        }

        .dashboard-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .dashboard-section-header h2 {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .dashboard-section-header a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 500;
            font-size: 0.875rem;
        }

        .dashboard-section-header a:hover {
            text-decoration: underline;
        }

        .dashboard-portfolios-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .dashboard-portfolio-card {
            background: var(--bg-primary);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            border: 1px solid var(--border);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
        }

        .dashboard-portfolio-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-color: var(--primary);
        }

        .dashboard-portfolio-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .dashboard-portfolio-card-title {
            font-weight: 600;
            font-size: 1rem;
            color: var(--text-primary);
        }

        .dashboard-portfolio-card-date {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .dashboard-portfolio-card-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .dashboard-portfolio-card-holdings {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .dashboard-empty-state {
            text-align: center;
            padding: 60px 20px;
            background: var(--bg-primary);
            border-radius: 12px;
            border: 2px dashed var(--border);
        }

        .dashboard-empty-icon {
            font-size: 3rem;
            margin-bottom: 16px;
        }

        .dashboard-empty-state h3 {
            font-size: 1.125rem;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .dashboard-empty-state p {
            color: var(--text-secondary);
            margin-bottom: 20px;
        }

        .dashboard-connected-accounts {
            display: grid;
            gap: 12px;
        }

        .dashboard-no-accounts {
            color: var(--text-secondary);
            font-size: 0.875rem;
            padding: 24px;
            background: var(--bg-primary);
            border-radius: 12px;
            border: 1px solid var(--border);
            text-align: center;
        }

        @media (max-width: 768px) {
            .dashboard-stats {
                grid-template-columns: 1fr;
            }
            .dashboard-header {
                flex-direction: column;
                align-items: flex-start;
            }
            .dashboard-portfolios-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Saved Portfolios */
        .saved-portfolios {
            margin-top: 32px;
        }

        .saved-portfolios-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .saved-portfolios-header h3 {
            font-size: 1rem;
            font-weight: 600;
        }

        .portfolio-list {
            display: grid;
            gap: 12px;
        }

        .portfolio-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.15s;
        }

        .portfolio-item:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow-sm);
        }

        .portfolio-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .portfolio-info {
            flex: 1;
        }

        .portfolio-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .portfolio-meta {
            font-size: 0.8125rem;
            color: var(--text-muted);
        }

        .portfolio-value {
            font-weight: 600;
            color: var(--success);
        }

        .portfolio-actions {
            display: flex;
            gap: 8px;
        }

        .portfolio-action-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 8px;
            border-radius: var(--radius-sm);
            transition: all 0.15s;
        }

        .portfolio-action-btn:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .portfolio-action-btn.delete:hover {
            background: rgba(255, 69, 58, 0.1);
            color: var(--danger);
        }

        /* Save Portfolio Modal */
        .save-modal .modal {
            max-width: 450px;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
        }

        .empty-state-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 16px;
            color: var(--text-muted);
        }

        /* Compare Tab */
        .compare-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }

        @media (max-width: 900px) {
            .compare-container {
                grid-template-columns: 1fr;
            }
        }

        .compare-selectors {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 16px;
            align-items: end;
            margin-bottom: 32px;
        }

        @media (max-width: 768px) {
            .compare-selectors {
                grid-template-columns: 1fr;
            }
        }

        .compare-select-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .compare-select-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .compare-select {
            padding: 12px 16px;
            font-size: 0.9375rem;
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            background: var(--bg-primary);
            color: var(--text-primary);
            cursor: pointer;
            font-family: inherit;
        }

        .compare-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 91, 255, 0.1);
        }

        .compare-vs {
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: var(--text-muted);
            padding-bottom: 12px;
        }

        .compare-column {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 24px;
        }

        .compare-column-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }

        .compare-column-title {
            font-size: 1.125rem;
            font-weight: 600;
        }

        .compare-column-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--success);
        }

        .compare-chart-wrapper {
            height: 200px;
            margin-bottom: 20px;
        }

        .compare-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .compare-stat {
            text-align: center;
            padding: 12px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
        }

        .compare-stat-value {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .compare-stat-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        /* Difference Summary */
        .diff-summary {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 24px;
            margin-top: 24px;
        }

        .diff-summary-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-secondary);
        }

        .diff-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
        }

        .diff-item {
            text-align: center;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
        }

        .diff-value {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .diff-value.positive {
            color: var(--success);
        }

        .diff-value.negative {
            color: var(--danger);
        }

        .diff-value.neutral {
            color: var(--text-muted);
        }

        .diff-label {
            font-size: 0.8125rem;
            color: var(--text-muted);
        }

        .compare-btn {
            margin-top: 16px;
        }

        /* What-If Tab */
        .whatif-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }

        @media (max-width: 900px) {
            .whatif-container {
                grid-template-columns: 1fr;
            }
        }

        .whatif-editor {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 24px;
        }

        .whatif-section-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .whatif-position-list {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .whatif-position {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            margin-bottom: 8px;
        }

        .whatif-position-symbol {
            font-weight: 600;
            min-width: 60px;
        }

        .whatif-position-shares {
            flex: 1;
        }

        .whatif-position-shares input {
            width: 80px;
            padding: 8px 12px;
            font-size: 0.875rem;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            background: var(--bg-primary);
            text-align: right;
            font-family: inherit;
        }

        .whatif-position-shares input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .whatif-position-value {
            min-width: 90px;
            text-align: right;
            font-weight: 500;
            color: var(--text-muted);
        }

        .whatif-position-remove {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 4px;
            border-radius: var(--radius-sm);
            transition: all 0.15s;
        }

        .whatif-position-remove:hover {
            background: rgba(255, 69, 58, 0.1);
            color: var(--danger);
        }

        .whatif-add-form {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr auto;
            gap: 12px;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            margin-bottom: 20px;
        }

        @media (max-width: 600px) {
            .whatif-add-form {
                grid-template-columns: 1fr 1fr;
            }
        }

        .whatif-add-form input {
            padding: 10px 12px;
            font-size: 0.875rem;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            background: var(--bg-primary);
            font-family: inherit;
        }

        .whatif-add-form input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .whatif-add-form button {
            padding: 10px 16px;
        }

        /* Rebalance Section */
        .rebalance-targets {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }

        @media (max-width: 600px) {
            .rebalance-targets {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .rebalance-target {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .rebalance-target label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .rebalance-target input {
            padding: 8px 12px;
            font-size: 0.875rem;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            background: var(--bg-primary);
            text-align: center;
            font-family: inherit;
        }

        .rebalance-target input:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* What-If Preview */
        .whatif-preview {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 24px;
        }

        .whatif-preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .whatif-preview-title {
            font-size: 1rem;
            font-weight: 600;
        }

        .whatif-preview-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--success);
        }

        .whatif-impact-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .whatif-impact-card {
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            text-align: center;
        }

        .whatif-impact-value {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .whatif-impact-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .whatif-chart-wrapper {
            height: 180px;
            margin-bottom: 16px;
        }

        .whatif-actions {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        /* Plaid Integration */
        .plaid-section {
            margin-top: 32px;
            padding-top: 32px;
            border-top: 1px solid var(--border);
        }

        .plaid-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .plaid-header h3 {
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .plaid-connections {
            display: grid;
            gap: 12px;
        }

        .plaid-connection {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
        }

        .plaid-connection-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #00d4aa 0%, #00a884 100%);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .plaid-connection-info {
            flex: 1;
        }

        .plaid-connection-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .plaid-connection-meta {
            font-size: 0.8125rem;
            color: var(--text-muted);
        }

        .plaid-connection-actions {
            display: flex;
            gap: 8px;
        }

        .plaid-unavailable {
            text-align: center;
            padding: 32px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            color: var(--text-muted);
        }

        .plaid-unavailable svg {
            width: 48px;
            height: 48px;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        /* Benchmark Toggles */
        .benchmark-toggle {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.8125rem;
            cursor: pointer;
            padding: 6px 12px;
            background: var(--bg-secondary);
            border-radius: var(--radius-sm);
            transition: all 0.15s;
        }

        .benchmark-toggle:hover {
            background: var(--bg-tertiary);
        }

        .benchmark-toggle input {
            display: none;
        }

        .benchmark-label-box {
            width: 12px;
            height: 12px;
            border-radius: 2px;
            opacity: 0.4;
            transition: opacity 0.15s;
        }

        .benchmark-toggle input:checked + .benchmark-label-box {
            opacity: 1;
        }

        /* Projections */
        .projection-stat {
            text-align: center;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
        }

        .projection-stat-value {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .projection-stat-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .monte-carlo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .monte-carlo-item {
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
        }

        .monte-carlo-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .monte-carlo-value {
            font-size: 1.125rem;
            font-weight: 600;
        }

        .monte-carlo-value.positive { color: var(--success); }
        .monte-carlo-value.highlight { color: var(--primary); }

        /* Toast Notifications */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            padding: 16px 24px;
            border-radius: var(--radius-md);
            color: white;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: var(--shadow-lg);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 2000;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast.success {
            background: var(--success);
        }

        .toast.error {
            background: var(--danger);
        }

        .toast svg {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }

        /* Footer */
        .site-footer {
            margin-top: 48px;
            padding: 24px 0;
            border-top: 1px solid var(--border);
            text-align: center;
            color: var(--text-muted);
            font-size: 0.8125rem;
        }

        .footer-links {
            display: flex;
            justify-content: center;
            gap: 24px;
            margin-bottom: 12px;
        }

        .footer-links a {
            color: var(--text-secondary);
            text-decoration: none;
            transition: color 0.2s;
        }

        .footer-links a:hover {
            color: var(--primary);
        }

        .footer-copyright {
            color: var(--text-muted);
        }

        /* ========== MOBILE OPTIMIZATIONS ========== */
        @media (max-width: 480px) {
            body {
                font-size: 14px;
            }

            .container {
                padding: 16px 12px;
            }

            /* Logo & Header */
            .logo {
                gap: 8px;
            }

            .logo-icon {
                width: 32px;
                height: 32px;
                border-radius: 6px;
            }

            .logo-icon svg {
                width: 18px;
                height: 18px;
            }

            .brand-name {
                font-size: 1rem;
            }

            .brand-tagline {
                font-size: 0.5625rem;
            }

            .subtitle {
                font-size: 0.875rem;
                padding: 0 8px;
            }

            /* Entry Method Tabs */
            .entry-methods {
                flex-direction: column;
                gap: 4px;
                padding: 4px;
            }

            .entry-method-btn {
                padding: 10px 12px;
                font-size: 0.8125rem;
            }

            .entry-method-btn svg {
                width: 16px;
                height: 16px;
            }

            /* Upload Card */
            .upload-card {
                padding: 24px 16px !important;
            }

            .upload-icon {
                width: 48px;
                height: 48px;
                margin-bottom: 16px;
            }

            .upload-icon svg {
                width: 24px;
                height: 24px;
            }

            .upload-title {
                font-size: 1.1rem;
            }

            .upload-hint {
                font-size: 0.8125rem;
            }

            /* Manual Entry Form */
            .manual-entry-card {
                padding: 20px 16px !important;
            }

            .manual-entry-form {
                flex-direction: column;
                gap: 12px;
            }

            .manual-entry-form .form-group {
                min-width: 100%;
            }

            .manual-entry-form .btn-add {
                width: 100%;
            }

            /* Holdings List */
            .holdings-list-header {
                display: none;
            }

            .holdings-list-item {
                grid-template-columns: 1fr auto;
                gap: 8px;
            }

            .holdings-list-item .holding-symbol {
                grid-column: 1;
            }

            .holdings-list-item .btn-remove {
                grid-column: 2;
                grid-row: 1 / 3;
            }

            .holdings-list-item .holding-value {
                font-size: 0.8125rem;
            }

            .holdings-list-item .holding-total {
                font-size: 0.875rem;
            }

            .holdings-list-item::before {
                display: none;
            }

            .manual-entry-actions {
                flex-direction: column;
                gap: 16px;
            }

            .manual-entry-actions .manual-total {
                text-align: center;
            }

            .manual-entry-actions > div {
                width: 100%;
                display: flex;
                gap: 8px;
            }

            .manual-entry-actions > div .btn {
                flex: 1;
            }

            /* Dashboard Header */
            .dashboard-header {
                flex-direction: column;
                align-items: stretch;
                gap: 12px;
            }

            .dashboard-title {
                justify-content: center;
                flex-wrap: wrap;
            }

            .dashboard-logo {
                width: 36px;
                height: 36px;
                border-radius: 8px;
            }

            .dashboard-logo svg {
                width: 22px;
                height: 22px;
            }

            .dashboard-title h2 {
                font-size: 1.25rem;
            }

            .total-badge {
                padding: 6px 14px;
                font-size: 1rem;
            }

            .header-actions {
                justify-content: center;
                flex-wrap: wrap;
            }

            .header-actions .btn {
                font-size: 0.8125rem;
                padding: 8px 12px;
            }

            /* Tabs - Horizontal scroll */
            .tabs {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
                flex-wrap: nowrap;
                justify-content: flex-start;
                padding: 4px;
                margin: 0 -12px;
                padding-left: 12px;
                padding-right: 12px;
            }

            .tabs::-webkit-scrollbar {
                display: none;
            }

            .tab {
                flex-shrink: 0;
                padding: 8px 12px;
                font-size: 0.8125rem;
                white-space: nowrap;
            }

            /* Stats Grid */
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }

            .stat-card {
                padding: 14px;
            }

            .stat-label {
                font-size: 0.6875rem;
            }

            .stat-value {
                font-size: 1.25rem;
            }

            .stat-sub {
                font-size: 0.75rem;
            }

            /* Charts */
            .chart-wrapper {
                height: 250px !important;
            }

            .charts-row {
                gap: 16px;
            }

            .chart-card {
                padding: 16px;
            }

            .card-title {
                font-size: 0.9375rem;
            }

            /* Returns Grid */
            .returns-grid {
                grid-template-columns: repeat(4, 1fr) !important;
                gap: 6px;
            }

            .return-card {
                padding: 10px 6px;
            }

            .return-card .stat-label {
                font-size: 0.625rem;
            }

            .return-card .stat-value {
                font-size: 0.9375rem;
            }

            .benchmark-label {
                font-size: 0.625rem;
            }

            /* Benchmark Toggles */
            .benchmark-toggles {
                flex-wrap: wrap;
                gap: 6px;
            }

            .benchmark-toggle {
                padding: 4px 8px;
                font-size: 0.75rem;
            }

            /* Period Buttons */
            .period-buttons {
                gap: 4px;
            }

            .period-btn {
                padding: 6px 10px;
                font-size: 0.75rem;
            }

            /* Projections */
            #projectionsInfo {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 8px;
            }

            .monte-carlo-grid {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 8px;
            }

            .monte-carlo-item {
                padding: 12px;
            }

            .monte-carlo-label {
                font-size: 0.6875rem;
            }

            .monte-carlo-value {
                font-size: 0.9375rem;
            }

            /* Sectors */
            .sector-item {
                grid-template-columns: 1fr !important;
                gap: 6px;
                padding: 12px 0;
            }

            .sector-name {
                font-weight: 600;
            }

            .sector-bar-container {
                order: 3;
            }

            .sector-pct {
                display: inline;
            }

            .sector-pct.benchmark {
                margin-left: 12px;
                color: var(--text-muted);
            }

            /* Geography */
            .map-container {
                flex-direction: column;
            }

            #worldMapContainer {
                min-height: 200px;
            }

            .map-legend {
                flex-direction: row;
                flex-wrap: wrap;
                justify-content: center;
                gap: 12px;
                padding: 12px 0;
            }

            /* Risk Metrics */
            .risk-grid {
                grid-template-columns: repeat(2, 1fr) !important;
            }

            /* Holdings Table */
            .holdings-table th,
            .holdings-table td {
                padding: 10px 8px;
                font-size: 0.8125rem;
            }

            .holdings-table th:nth-child(2),
            .holdings-table td:nth-child(2) {
                display: none;
            }

            /* What-If */
            .whatif-add-form {
                grid-template-columns: 1fr !important;
            }

            /* Compare */
            .compare-container {
                flex-direction: column;
            }

            .compare-side {
                min-width: 100%;
            }

            /* Accounts Section */
            .account-item {
                flex-wrap: wrap;
                gap: 8px;
            }

            .account-details {
                flex: 1;
                min-width: calc(100% - 60px);
            }

            .account-value {
                order: 4;
                width: 100%;
                text-align: left;
                padding-left: 44px;
            }

            /* Upload Queue */
            .upload-queue {
                max-height: 200px;
            }

            .upload-queue-item {
                padding: 10px 12px;
            }

            .upload-file-icon {
                width: 32px;
                height: 32px;
            }

            .upload-file-name {
                font-size: 0.875rem;
            }

            .upload-file-status {
                font-size: 0.75rem;
            }

            /* Buttons */
            .btn {
                padding: 10px 16px;
                font-size: 0.875rem;
            }

            .actions-row {
                flex-direction: column;
                gap: 8px;
            }

            .actions-row .btn {
                width: 100%;
            }

            /* Cards */
            .card {
                padding: 16px;
                border-radius: 12px;
            }

            /* Modal */
            .modal {
                margin: 12px;
                max-height: calc(100vh - 24px);
                overflow-y: auto;
            }

            .modal-header {
                padding: 16px 16px 0;
            }

            .modal-body {
                padding: 16px;
            }

            /* Toast */
            .toast {
                left: 12px;
                right: 12px;
                bottom: 12px;
                transform: none;
                max-width: none;
            }
        }

        /* Tablet adjustments */
        @media (min-width: 481px) and (max-width: 768px) {
            .entry-methods {
                max-width: 100%;
            }

            .manual-entry-form {
                flex-wrap: wrap;
            }

            .manual-entry-form .form-group {
                flex: 1 1 calc(50% - 6px);
                min-width: calc(50% - 6px);
            }

            .manual-entry-form .btn-add {
                flex: 1 1 100%;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .returns-grid {
                grid-template-columns: repeat(4, 1fr) !important;
            }

            .dashboard-title h2 {
                font-size: 1.5rem;
            }
        }

        /* ========== DARK MODE SUPPORT ========== */
        :root[data-theme="dark"] {
            --primary: #7a73ff;
            --primary-dark: #635bff;
            --primary-light: #9d97ff;
            --success: #34d399;
            --danger: #f87171;
            --warning: #fbbf24;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --bg-primary: #1e293b;
            --bg-secondary: #0f172a;
            --bg-tertiary: #334155;
            --border: #334155;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.2);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.3);
            --shadow-lg: 0 8px 24px rgba(0,0,0,0.4);
        }

        :root[data-theme="dark"] body {
            background: var(--bg-secondary);
        }

        :root[data-theme="dark"] .country {
            fill: #475569;
        }

        :root[data-theme="dark"] .upload-file-icon.success {
            background: rgba(52, 211, 153, 0.2);
        }

        :root[data-theme="dark"] .upload-file-icon.error {
            background: rgba(248, 113, 113, 0.2);
        }

        /* Dark Mode Compatibility for Stripe-Inspired Sections */
        /* Dark sections should stay dark in both modes */
        :root[data-theme="dark"] .how-it-works,
        :root[data-theme="dark"] .value-props,
        :root[data-theme="dark"] .site-footer {
            background: var(--dark-section-bg);
        }

        :root[data-theme="dark"] .how-it-works-step,
        :root[data-theme="dark"] .step-card,
        :root[data-theme="dark"] .value-card {
            background: var(--dark-card-bg);
            border-color: var(--dark-border);
        }

        /* Light sections in dark mode */
        :root[data-theme="dark"] .preview-section {
            background: var(--bg-primary);
        }

        /* Brokerage strip in dark mode */
        :root[data-theme="dark"] .brokerage-strip-label,
        :root[data-theme="dark"] .brokerage-strip-more {
            color: #8899AA;
        }

        :root[data-theme="dark"] .brokerage-strip-track .brokerage-name {
            color: var(--text-secondary);
        }

        :root[data-theme="dark"] .brokerage-strip-logos {
            -webkit-mask-image: linear-gradient(to right, transparent, black 8%, black 92%, transparent);
            mask-image: linear-gradient(to right, transparent, black 8%, black 92%, transparent);
        }

        :root[data-theme="dark"] .browser-frame {
            background: var(--bg-secondary);
        }

        :root[data-theme="dark"] .browser-header {
            background: var(--bg-tertiary);
        }

        :root[data-theme="dark"] .browser-content {
            background: var(--bg-secondary);
        }

        :root[data-theme="dark"] .preview-card {
            background: var(--bg-primary);
            border-color: var(--border);
        }

        /* Maintain colored left borders in dark mode */
        :root[data-theme="dark"] .preview-grid .preview-card:nth-child(1) {
            border-left: 4px solid #635BFF;
        }
        :root[data-theme="dark"] .preview-grid .preview-card:nth-child(2) {
            border-left: 4px solid #FFBD2E;
        }
        :root[data-theme="dark"] .preview-grid .preview-card:nth-child(3) {
            border-left: 4px solid #00D4AA;
        }
        :root[data-theme="dark"] .preview-grid .preview-card:nth-child(4) {
            border-left: 4px solid #FF5F57;
        }
        :root[data-theme="dark"] .preview-grid .preview-card:nth-child(5) {
            border-left: 4px solid #4F46E5;
        }
        :root[data-theme="dark"] .pv-perf-value {
            color: var(--text-primary);
        }
        :root[data-theme="dark"] .pv-perf-value.positive {
            color: #00D4AA;
        }

        /* Section badge in dark mode */
        :root[data-theme="dark"] .preview-section .section-badge {
            background: rgba(99, 91, 255, 0.15);
        }

        /* Marquee gradients for dark mode */
        :root[data-theme="dark"] .marquee-container::before {
            background: linear-gradient(to right, var(--bg-primary), transparent);
        }

        :root[data-theme="dark"] .marquee-container::after {
            background: linear-gradient(to left, var(--bg-primary), transparent);
        }

        :root[data-theme="dark"] .brokerage-logo-img {
            filter: grayscale(100%) brightness(0) invert(1) opacity(0.5);
        }

        :root[data-theme="dark"] .brokerage-logo:hover .brokerage-logo-img {
            filter: grayscale(0%) brightness(1) invert(0) opacity(1);
        }

        /* Hero upload card in dark mode */
        :root[data-theme="dark"] .hero-upload-card {
            background: var(--bg-primary);
            border-color: var(--border);
        }

        :root[data-theme="dark"] .hero-badge {
            background: rgba(122, 115, 255, 0.15);
        }

        /* Theme toggle button */
        .theme-toggle {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            color: var(--text-secondary);
        }

        .theme-toggle:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .theme-toggle svg {
            width: 18px;
            height: 18px;
        }

        .theme-toggle .sun-icon { display: none; }
        .theme-toggle .moon-icon { display: block; }

        :root[data-theme="dark"] .theme-toggle .sun-icon { display: block; }
        :root[data-theme="dark"] .theme-toggle .moon-icon { display: none; }

        /* Smooth theme transition */
        body, .card, .modal, .btn, input, select, .toast {
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }

        /* ========== ENHANCED TOAST SYSTEM ========== */
        .toast-container {
            position: fixed;
            bottom: 24px;
            right: 24px;
            display: flex;
            flex-direction: column-reverse;
            gap: 12px;
            z-index: 2000;
            pointer-events: none;
        }

        .toast {
            position: relative;
            padding: 16px 48px 16px 20px;
            border-radius: var(--radius-md);
            color: white;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: var(--shadow-lg);
            transform: translateX(120%);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: auto;
            max-width: 400px;
            overflow: hidden;
        }

        .toast.show {
            transform: translateX(0);
            opacity: 1;
        }

        .toast.success { background: var(--success); }
        .toast.error { background: var(--danger); }
        .toast.warning { background: #f59e0b; }
        .toast.info { background: var(--primary); }

        .toast-icon {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            margin-bottom: 2px;
        }

        .toast-message {
            font-size: 0.875rem;
            opacity: 0.95;
        }

        .toast-close {
            position: absolute;
            top: 50%;
            right: 12px;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            padding: 4px;
            border-radius: var(--radius-sm);
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .toast-close:hover {
            opacity: 1;
        }

        .toast-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            background: rgba(255,255,255,0.4);
            border-radius: 0 0 var(--radius-md) var(--radius-md);
            animation: toast-progress linear forwards;
        }

        @keyframes toast-progress {
            from { width: 100%; }
            to { width: 0%; }
        }

        /* Toast Action Button */
        .toast.has-action {
            padding-right: 48px;
        }

        .toast-action-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            font-size: 0.8125rem;
            font-weight: 600;
            padding: 8px 16px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
            margin-left: 8px;
        }

        .toast-action-btn:hover {
            background: rgba(255, 255, 255, 0.35);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-1px);
        }

        .toast-action-btn:active {
            transform: translateY(0);
        }

        .toast.info .toast-action-btn {
            background: var(--primary);
            border-color: var(--primary);
        }

        .toast.info .toast-action-btn:hover {
            background: var(--primary-dark);
            border-color: var(--primary-dark);
        }

        /* ========== LOADING STATES & SKELETON LOADERS ========== */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(10, 37, 64, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1500;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
        }

        .loading-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        :root[data-theme="dark"] .loading-overlay {
            background: rgba(0, 0, 0, 0.7);
        }

        .loading-content {
            background: var(--bg-primary);
            padding: 32px 48px;
            border-radius: var(--radius-lg);
            text-align: center;
            box-shadow: var(--shadow-lg);
        }

        .loading-content .spinner {
            margin: 0 auto 16px;
        }

        .skeleton {
            background: linear-gradient(90deg, var(--bg-secondary) 25%, var(--bg-tertiary) 50%, var(--bg-secondary) 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
            border-radius: var(--radius-sm);
        }

        @keyframes skeleton-loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .skeleton-text {
            height: 1em;
            margin-bottom: 0.5em;
        }

        .skeleton-text:last-child {
            width: 60%;
        }

        .skeleton-card {
            height: 120px;
            margin-bottom: 16px;
        }

        .skeleton-row {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
        }

        .skeleton-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
        }

        .skeleton-block {
            flex: 1;
            height: 40px;
        }

        /* Button loading state */
        .btn.loading {
            position: relative;
            color: transparent !important;
            pointer-events: none;
        }

        .btn.loading::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            border: 2px solid transparent;
            border-top-color: currentColor;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
        }

        .btn-primary.loading::after { border-top-color: white; }
        .btn-secondary.loading::after { border-top-color: var(--primary); }

        /* ========== FORM VALIDATION STYLES ========== */
        .form-group.has-error .form-input,
        .manual-entry-form .form-group.has-error input {
            border-color: var(--danger);
            animation: shake 0.5s ease;
        }

        .form-group.has-success .form-input,
        .manual-entry-form .form-group.has-success input {
            border-color: var(--success);
        }

        .form-group .validation-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            width: 18px;
            height: 18px;
        }

        .form-group.has-error .validation-icon { color: var(--danger); }
        .form-group.has-success .validation-icon { color: var(--success); }

        .form-input-wrapper {
            position: relative;
        }

        .form-input-wrapper .form-input {
            padding-right: 40px;
        }

        .inline-error {
            color: var(--danger);
            font-size: 0.75rem;
            margin-top: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }
        }

        /* ========== KEYBOARD SHORTCUT HINTS ========== */
        .kbd {
            display: inline-block;
            padding: 2px 6px;
            font-size: 0.6875rem;
            font-family: ui-monospace, monospace;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 4px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            margin-left: 8px;
            color: var(--text-muted);
        }

        .shortcut-hint {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-left: auto;
        }

        /* Shortcuts Help Modal */
        .shortcuts-grid {
            display: grid;
            gap: 12px;
        }

        .shortcut-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border-radius: var(--radius-sm);
        }

        .shortcut-action {
            color: var(--text-primary);
            font-weight: 500;
        }

        .shortcut-keys {
            display: flex;
            gap: 4px;
        }

        /* ========== ACCESSIBILITY IMPROVEMENTS ========== */
        .skip-link {
            position: absolute;
            top: -100px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary);
            color: white;
            padding: 12px 24px;
            border-radius: var(--radius-md);
            z-index: 9999;
            font-weight: 600;
            transition: top 0.2s;
            text-decoration: none;
        }

        .skip-link:focus {
            top: 16px;
        }

        /* Focus visible styles */
        *:focus-visible {
            outline: 2px solid var(--primary);
            outline-offset: 2px;
        }

        .btn:focus-visible {
            box-shadow: 0 0 0 3px rgba(99, 91, 255, 0.3);
        }

        /* Screen reader only text */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* Reduced motion preference */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* ========== CONNECTION STATUS INDICATOR ========== */
        .connection-status {
            position: fixed;
            bottom: 16px;
            left: 16px;
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: var(--radius-md);
            font-size: 0.75rem;
            font-weight: 500;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            box-shadow: var(--shadow-sm);
            z-index: 100;
            opacity: 0.8;
            transition: opacity 0.2s;
        }

        .connection-status:hover {
            opacity: 1;
        }

        .connection-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
        }

        .connection-status.offline .connection-dot {
            background: var(--danger);
        }

        .connection-status.offline {
            color: var(--danger);
        }

        /* Session timeout warning */
        .session-warning {
            position: fixed;
            top: 16px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--warning);
            color: #1a1a1a;
            padding: 12px 24px;
            border-radius: var(--radius-md);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 1900;
            box-shadow: var(--shadow-lg);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }

        .session-warning.show {
            opacity: 1;
            visibility: visible;
        }

        /* ========== SETTINGS PANEL ========== */
        .settings-section {
            margin-bottom: 24px;
        }

        .settings-section-title {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-bottom: 12px;
        }

        .settings-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }

        .settings-option:last-child {
            border-bottom: none;
        }

        .settings-option-label {
            font-weight: 500;
            color: var(--text-primary);
        }

        .settings-option-desc {
            font-size: 0.8125rem;
            color: var(--text-muted);
            margin-top: 2px;
        }

        /* Toggle switch */
        .toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-tertiary);
            border-radius: 24px;
            transition: 0.3s;
        }

        .toggle-slider::before {
            content: '';
            position: absolute;
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background: white;
            border-radius: 50%;
            transition: 0.3s;
        }

        .toggle-switch input:checked + .toggle-slider {
            background: var(--primary);
        }

        .toggle-switch input:checked + .toggle-slider::before {
            transform: translateX(20px);
        }

        .toggle-switch input:focus-visible + .toggle-slider {
            box-shadow: 0 0 0 3px rgba(99, 91, 255, 0.3);
        }

        /* Select dropdown for settings */
        .settings-select {
            padding: 8px 32px 8px 12px;
            font-size: 0.875rem;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            background: var(--bg-primary);
            color: var(--text-primary);
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%238898aa' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
        }

        .settings-select:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* ========== CONFIRMATION MODAL ========== */
        .confirm-modal .modal {
            max-width: 380px;
        }

        .confirm-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 16px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .confirm-icon.danger {
            background: rgba(248, 113, 113, 0.15);
            color: var(--danger);
        }

        .confirm-icon.warning {
            background: rgba(251, 191, 36, 0.15);
            color: #f59e0b;
        }

        .confirm-text {
            text-align: center;
            margin-bottom: 24px;
        }

        .confirm-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .confirm-desc {
            color: var(--text-muted);
            font-size: 0.9375rem;
        }

        .confirm-actions {
            display: flex;
            gap: 12px;
        }

        .confirm-actions .btn {
            flex: 1;
        }

        .confirm-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 16px;
            font-size: 0.8125rem;
            color: var(--text-muted);
        }

        /* ========== IMPROVED EMPTY STATES ========== */
        .empty-state-enhanced {
            text-align: center;
            padding: 48px 24px;
        }

        .empty-state-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 24px;
            background: var(--bg-secondary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: empty-bounce 2s ease-in-out infinite;
        }

        @keyframes empty-bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }

        .empty-state-icon svg {
            width: 40px;
            height: 40px;
            color: var(--text-muted);
        }

        .empty-state-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .empty-state-desc {
            color: var(--text-muted);
            margin-bottom: 24px;
            max-width: 320px;
            margin-left: auto;
            margin-right: auto;
        }

        .empty-state-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
        }

        /* ========== UNDO TOAST ========== */
        .undo-toast {
            background: var(--text-primary);
        }

        .undo-toast .btn-undo {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 4px 12px;
            border-radius: var(--radius-sm);
            font-weight: 600;
            cursor: pointer;
            margin-left: 12px;
        }

        .undo-toast .btn-undo:hover {
            background: rgba(255,255,255,0.3);
        }

        /* Mobile adjustments for new components */
        @media (max-width: 480px) {
            .toast-container {
                left: 12px;
                right: 12px;
                bottom: 12px;
            }

            .toast {
                max-width: none;
            }

            .shortcuts-grid {
                gap: 8px;
            }

            .shortcut-item {
                padding: 10px 12px;
            }

            .settings-option {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .confirm-actions {
                flex-direction: column;
            }
        }

        /* ========== ONBOARDING TUTORIAL ========== */
        .onboarding-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(10, 37, 64, 0.85);
            z-index: 3000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }

        .onboarding-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        :root[data-theme="dark"] .onboarding-overlay {
            background: rgba(0, 0, 0, 0.9);
        }

        .onboarding-card {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            max-width: 480px;
            width: 90%;
            overflow: hidden;
            animation: onboarding-enter 0.4s ease;
        }

        @keyframes onboarding-enter {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .onboarding-image {
            height: 200px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .onboarding-image svg {
            width: 80px;
            height: 80px;
            opacity: 0.9;
        }

        .onboarding-content {
            padding: 32px;
            text-align: center;
        }

        .onboarding-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 12px;
            color: var(--text-primary);
        }

        .onboarding-text {
            color: var(--text-secondary);
            margin-bottom: 24px;
            line-height: 1.6;
        }

        .onboarding-steps {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 24px;
        }

        .onboarding-step {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            transition: all 0.3s;
        }

        .onboarding-step.active {
            width: 24px;
            border-radius: 4px;
            background: var(--primary);
        }

        .onboarding-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .onboarding-skip {
            color: var(--text-muted);
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.875rem;
            padding: 8px 16px;
        }

        .onboarding-skip:hover {
            color: var(--text-primary);
        }

        /* Spotlight highlight for tutorial */
        .spotlight {
            position: fixed;
            z-index: 2999;
            pointer-events: none;
        }

        .spotlight-hole {
            position: absolute;
            border-radius: var(--radius-md);
            box-shadow: 0 0 0 9999px rgba(10, 37, 64, 0.85);
            transition: all 0.4s ease;
        }

        :root[data-theme="dark"] .spotlight-hole {
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.9);
        }

        .spotlight-tooltip {
            position: absolute;
            background: var(--bg-primary);
            border-radius: var(--radius-md);
            padding: 16px 20px;
            box-shadow: var(--shadow-lg);
            max-width: 300px;
            pointer-events: auto;
        }

        .spotlight-tooltip::before {
            content: '';
            position: absolute;
            width: 12px;
            height: 12px;
            background: var(--bg-primary);
            transform: rotate(45deg);
        }

        .spotlight-tooltip.top::before {
            bottom: -6px;
            left: 50%;
            margin-left: -6px;
        }

        .spotlight-tooltip.bottom::before {
            top: -6px;
            left: 50%;
            margin-left: -6px;
        }

        /* ========== ANIMATED TRANSITIONS ========== */
        .view-transition {
            animation: view-fade-in 0.3s ease;
        }

        @keyframes view-fade-in {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .tab-content {
            animation: none;
        }

        .tab-content.active {
            animation: tab-slide-in 0.3s ease;
        }

        @keyframes tab-slide-in {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .card-enter {
            animation: card-pop-in 0.3s ease;
        }

        @keyframes card-pop-in {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .stagger-enter > * {
            opacity: 0;
            animation: stagger-fade-in 0.4s ease forwards;
        }

        .stagger-enter > *:nth-child(1) { animation-delay: 0.05s; }
        .stagger-enter > *:nth-child(2) { animation-delay: 0.1s; }
        .stagger-enter > *:nth-child(3) { animation-delay: 0.15s; }
        .stagger-enter > *:nth-child(4) { animation-delay: 0.2s; }
        .stagger-enter > *:nth-child(5) { animation-delay: 0.25s; }
        .stagger-enter > *:nth-child(6) { animation-delay: 0.3s; }

        @keyframes stagger-fade-in {
            to {
                opacity: 1;
            }
        }

        /* ========== DRAG AND DROP ========== */
        .draggable {
            cursor: grab;
            transition: transform 0.15s, box-shadow 0.15s;
        }

        .draggable:active {
            cursor: grabbing;
        }

        .draggable.dragging {
            opacity: 0.8;
            transform: scale(1.02);
            box-shadow: var(--shadow-lg);
            z-index: 100;
        }

        .drag-handle {
            cursor: grab;
            color: var(--text-muted);
            padding: 4px;
            margin-right: 8px;
        }

        .drag-handle:hover {
            color: var(--text-secondary);
        }

        .drop-zone {
            transition: all 0.2s;
        }

        .drop-zone.drag-over {
            background: rgba(99, 91, 255, 0.05);
            border-color: var(--primary);
        }

        .drop-indicator {
            height: 2px;
            background: var(--primary);
            border-radius: 1px;
            margin: 4px 0;
            opacity: 0;
            transition: opacity 0.15s;
        }

        .drop-indicator.active {
            opacity: 1;
        }

        /* ========== QUICK ACTIONS & RECENT ========== */
        .quick-actions {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .quick-action-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 100px;
            font-size: 0.8125rem;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.15s;
        }

        .quick-action-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .quick-action-btn svg {
            width: 14px;
            height: 14px;
        }

        .recent-section {
            margin-bottom: 32px;
        }

        .recent-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .recent-title {
            font-size: 0.8125rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .recent-clear {
            font-size: 0.75rem;
            color: var(--text-muted);
            background: none;
            border: none;
            cursor: pointer;
        }

        .recent-clear:hover {
            color: var(--primary);
        }

        .recent-list {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .recent-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 14px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.15s;
        }

        .recent-item:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow-sm);
        }

        .recent-item-icon {
            width: 32px;
            height: 32px;
            background: var(--bg-secondary);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
        }

        .recent-item-info {
            flex: 1;
        }

        .recent-item-name {
            font-weight: 500;
            color: var(--text-primary);
        }

        .recent-item-meta {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* ========== DIVIDEND TRACKING ========== */
        .dividend-card {
            background: linear-gradient(135deg, var(--success) 0%, #28a745 100%);
            color: white;
            border: none;
        }

        .dividend-card .stat-label {
            color: rgba(255,255,255,0.8);
        }

        .dividend-card .stat-value {
            color: white;
        }

        .dividend-calendar {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }

        .dividend-month {
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            text-align: center;
        }

        .dividend-month-name {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .dividend-month-amount {
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--success);
        }

        .dividend-month.current {
            border: 2px solid var(--primary);
        }

        /* ========== TAX LOT TRACKING ========== */
        .tax-lot-table {
            font-size: 0.875rem;
        }

        .tax-lot-table th {
            font-size: 0.75rem;
        }

        .tax-lot-gain {
            color: var(--success);
            font-weight: 600;
        }

        .tax-lot-loss {
            color: var(--danger);
            font-weight: 600;
        }

        .tax-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .tax-summary-card {
            padding: 20px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            text-align: center;
        }

        .tax-summary-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .tax-summary-value {
            font-size: 1.5rem;
            font-weight: 700;
        }

        /* ========== REBALANCING ========== */
        .rebalance-visual {
            display: flex;
            gap: 24px;
            align-items: center;
            margin-bottom: 24px;
        }

        .rebalance-pie {
            width: 150px;
            height: 150px;
            flex-shrink: 0;
        }

        .rebalance-trades {
            flex: 1;
        }

        .rebalance-trade-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            margin-bottom: 8px;
        }

        .rebalance-trade-action {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .rebalance-trade-action.buy {
            background: rgba(48, 209, 88, 0.15);
            color: var(--success);
        }

        .rebalance-trade-action.sell {
            background: rgba(255, 69, 58, 0.15);
            color: var(--danger);
        }

        .rebalance-trade-symbol {
            font-weight: 600;
            min-width: 60px;
        }

        .rebalance-trade-amount {
            flex: 1;
            text-align: right;
            color: var(--text-secondary);
        }

        /* ========== PORTFOLIO ALERTS ========== */
        .alerts-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .alert-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
        }

        .alert-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .alert-icon.price-up {
            background: rgba(48, 209, 88, 0.15);
            color: var(--success);
        }

        .alert-icon.price-down {
            background: rgba(255, 69, 58, 0.15);
            color: var(--danger);
        }

        .alert-content {
            flex: 1;
        }

        .alert-title {
            font-weight: 600;
            margin-bottom: 2px;
        }

        .alert-desc {
            font-size: 0.8125rem;
            color: var(--text-muted);
        }

        .alert-toggle {
            flex-shrink: 0;
        }

        .add-alert-form {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr auto;
            gap: 12px;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            margin-top: 16px;
        }

        /* ========== HISTORICAL SNAPSHOTS ========== */
        .snapshot-timeline {
            position: relative;
            padding-left: 24px;
        }

        .snapshot-timeline::before {
            content: '';
            position: absolute;
            left: 8px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--border);
        }

        .snapshot-item {
            position: relative;
            padding: 16px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            margin-bottom: 16px;
            margin-left: 16px;
        }

        .snapshot-item::before {
            content: '';
            position: absolute;
            left: -24px;
            top: 20px;
            width: 12px;
            height: 12px;
            background: var(--primary);
            border-radius: 50%;
            border: 3px solid var(--bg-primary);
        }

        .snapshot-date {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .snapshot-value {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .snapshot-change {
            font-size: 0.875rem;
        }

        /* ========== EXPORT OPTIONS ========== */
        .export-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
        }

        .export-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            padding: 24px 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.15s;
        }

        .export-option:hover {
            border-color: var(--primary);
            background: var(--bg-primary);
        }

        .export-option-icon {
            width: 48px;
            height: 48px;
            background: var(--bg-primary);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
        }

        .export-option-label {
            font-weight: 600;
            color: var(--text-primary);
        }

        .export-option-desc {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-align: center;
        }

        .export-divider {
            height: 1px;
            background: var(--border);
            margin: 16px 0;
        }

        .export-section-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        .export-option.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        /* ========== IMPORT TEMPLATES ========== */
        .import-templates {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .import-template {
            padding: 20px;
            background: var(--bg-primary);
            border: 1px dashed var(--border);
            border-radius: var(--radius-md);
            text-align: center;
            cursor: pointer;
            transition: all 0.15s;
        }

        .import-template:hover {
            border-color: var(--primary);
            border-style: solid;
        }

        .import-template-icon {
            width: 40px;
            height: 40px;
            margin: 0 auto 12px;
            color: var(--text-muted);
        }

        .import-template-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .import-template-desc {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* ========== PRINT STYLES ========== */
        @media print {
            .top-nav,
            .theme-toggle,
            .connection-status,
            .session-warning,
            .toast-container,
            .tabs,
            .header-actions,
            .btn,
            footer {
                display: none !important;
            }

            body {
                background: white;
                color: black;
            }

            .container {
                max-width: 100%;
                padding: 0;
            }

            .card {
                box-shadow: none;
                border: 1px solid #ddd;
                break-inside: avoid;
            }

            .chart-wrapper {
                height: 250px !important;
            }

            .tab-content {
                display: block !important;
                page-break-before: always;
            }

            .tab-content:first-child {
                page-break-before: avoid;
            }

            .print-header {
                display: block !important;
                text-align: center;
                margin-bottom: 24px;
                padding-bottom: 16px;
                border-bottom: 2px solid #333;
            }

            .print-footer {
                display: block !important;
                text-align: center;
                margin-top: 24px;
                padding-top: 16px;
                border-top: 1px solid #ddd;
                font-size: 0.75rem;
            }
        }

        .print-header,
        .print-footer {
            display: none;
        }

        /* ========== SHARE PORTFOLIO ========== */
        .share-modal .modal {
            max-width: 500px;
        }

        .share-link-container {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .share-link-input {
            flex: 1;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            font-family: monospace;
            font-size: 0.875rem;
            color: var(--text-primary);
        }

        .share-options {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 20px;
        }

        .share-option-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 16px 24px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.15s;
            color: var(--text-primary);
        }

        .share-option-btn:hover {
            border-color: var(--primary);
        }

        .share-option-btn svg {
            width: 24px;
            height: 24px;
        }

        /* ========== PWA INSTALL PROMPT ========== */
        .pwa-install-prompt {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 16px;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .pwa-install-prompt.show {
            opacity: 1;
            visibility: visible;
        }

        .pwa-install-icon {
            width: 48px;
            height: 48px;
            background: var(--primary);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .pwa-install-text {
            flex: 1;
        }

        .pwa-install-title {
            font-weight: 600;
            margin-bottom: 2px;
        }

        .pwa-install-desc {
            font-size: 0.8125rem;
            color: var(--text-muted);
        }

        .pwa-install-close {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 4px;
        }

        /* ========== PORTFOLIO COMPARISON ========== */
        .comparison-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }

        .comparison-panel {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            padding: 24px;
            border: 1px solid var(--border);
        }

        .comparison-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }

        .comparison-panel-title {
            font-weight: 600;
            font-size: 1rem;
        }

        .comparison-select {
            padding: 8px 12px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            background: var(--bg-secondary);
            font-size: 0.875rem;
            min-width: 200px;
        }

        .comparison-metrics {
            display: grid;
            gap: 16px;
        }

        .comparison-metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px dashed var(--border);
        }

        .comparison-metric:last-child {
            border-bottom: none;
        }

        .comparison-metric-label {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .comparison-metric-value {
            font-weight: 600;
            font-size: 1rem;
        }

        .comparison-diff {
            text-align: center;
            padding: 24px;
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            margin-top: 24px;
        }

        .comparison-diff-title {
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text-secondary);
        }

        .comparison-diff-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
        }

        .diff-item {
            text-align: center;
        }

        .diff-value {
            font-size: 1.25rem;
            font-weight: 700;
        }

        .diff-value.positive { color: var(--success); }
        .diff-value.negative { color: var(--danger); }

        .diff-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 4px;
        }

        /* ========== PERFORMANCE CHART ========== */
        .performance-chart-container {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            padding: 24px;
            margin-bottom: 24px;
        }

        .performance-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .performance-title {
            font-weight: 600;
            font-size: 1.125rem;
        }

        .performance-period-tabs {
            display: flex;
            gap: 8px;
        }

        .period-tab {
            padding: 6px 12px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            background: var(--bg-secondary);
            font-size: 0.8125rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .period-tab:hover {
            border-color: var(--primary);
        }

        .period-tab.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .performance-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }

        .perf-stat {
            text-align: center;
        }

        .perf-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .perf-stat-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 4px;
        }

        /* ========== NEWS FEED ========== */
        .news-feed {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            padding: 24px;
        }

        .news-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .news-title {
            font-weight: 600;
            font-size: 1.125rem;
        }

        .news-filter {
            display: flex;
            gap: 8px;
        }

        .news-filter-btn {
            padding: 4px 10px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            background: var(--bg-secondary);
            font-size: 0.75rem;
            cursor: pointer;
        }

        .news-filter-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .news-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
            max-height: 500px;
            overflow-y: auto;
        }

        .news-item {
            display: flex;
            gap: 16px;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.2s;
        }

        .news-item:hover {
            transform: translateX(4px);
            box-shadow: var(--shadow-sm);
        }

        .news-thumbnail {
            width: 80px;
            height: 60px;
            border-radius: var(--radius-sm);
            background: var(--bg-tertiary);
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            font-size: 1.5rem;
        }

        .news-content {
            flex: 1;
            min-width: 0;
        }

        .news-item-title {
            font-weight: 500;
            font-size: 0.9375rem;
            margin-bottom: 4px;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .news-meta {
            display: flex;
            gap: 12px;
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .news-source {
            font-weight: 500;
            color: var(--primary);
        }

        .news-ticker {
            background: var(--bg-tertiary);
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 500;
        }

        /* ========== WATCHLIST ========== */
        .watchlist-container {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            padding: 24px;
        }

        .watchlist-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .watchlist-title {
            font-weight: 600;
            font-size: 1.125rem;
        }

        .watchlist-add {
            display: flex;
            gap: 8px;
        }

        .watchlist-input {
            padding: 8px 12px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            font-size: 0.875rem;
            width: 120px;
            text-transform: uppercase;
        }

        .watchlist-table {
            width: 100%;
            border-collapse: collapse;
        }

        .watchlist-table th {
            text-align: left;
            padding: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--border);
        }

        .watchlist-table td {
            padding: 12px;
            border-bottom: 1px solid var(--border);
        }

        .watchlist-table tr:last-child td {
            border-bottom: none;
        }

        .watchlist-symbol {
            font-weight: 600;
            color: var(--primary);
        }

        .watchlist-change {
            font-weight: 500;
        }

        .watchlist-change.up { color: var(--success); }
        .watchlist-change.down { color: var(--danger); }

        .watchlist-sparkline {
            width: 80px;
            height: 30px;
        }

        .watchlist-actions {
            display: flex;
            gap: 8px;
        }

        .watchlist-action-btn {
            padding: 4px 8px;
            border-radius: 4px;
            border: none;
            background: var(--bg-secondary);
            cursor: pointer;
            font-size: 0.75rem;
        }

        .watchlist-action-btn:hover {
            background: var(--bg-tertiary);
        }

        .watchlist-action-btn.add-portfolio {
            background: var(--primary);
            color: white;
        }

        /* ========== GOAL TRACKING ========== */
        .goals-container {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            padding: 24px;
        }

        .goals-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .goals-title {
            font-weight: 600;
            font-size: 1.125rem;
        }

        .goals-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .goal-card {
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            padding: 20px;
        }

        .goal-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .goal-info {
            flex: 1;
        }

        .goal-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .goal-target {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .goal-target-value {
            font-weight: 600;
            color: var(--primary);
        }

        .goal-eta {
            text-align: right;
        }

        .goal-eta-label {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .goal-eta-value {
            font-weight: 600;
            color: var(--text-primary);
        }

        .goal-progress {
            margin-bottom: 12px;
        }

        .goal-progress-bar {
            height: 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            overflow: hidden;
        }

        .goal-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--primary-light));
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .goal-progress-text {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 0.8125rem;
        }

        .goal-current {
            font-weight: 600;
        }

        .goal-remaining {
            color: var(--text-muted);
        }

        .goal-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px dashed var(--border);
        }

        .goal-action-btn {
            padding: 6px 12px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            background: var(--bg-primary);
            font-size: 0.8125rem;
            cursor: pointer;
        }

        .goal-action-btn:hover {
            border-color: var(--primary);
        }

        /* Add Goal Modal */
        .goal-form-group {
            margin-bottom: 16px;
        }

        .goal-form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 6px;
        }

        .goal-type-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .goal-type-option {
            padding: 16px;
            border: 2px solid var(--border);
            border-radius: var(--radius-md);
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }

        .goal-type-option:hover {
            border-color: var(--primary-light);
        }

        .goal-type-option.selected {
            border-color: var(--primary);
            background: rgba(99, 91, 255, 0.05);
        }

        .goal-type-icon {
            font-size: 1.5rem;
            margin-bottom: 8px;
        }

        .goal-type-name {
            font-weight: 500;
            font-size: 0.875rem;
        }

        /* ========== ADVANCED RISK METRICS ========== */
        .risk-metrics-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .risk-metric-card {
            background: var(--bg-primary);
            border-radius: var(--radius-md);
            padding: 20px;
            text-align: center;
            border: 1px solid var(--border);
        }

        .risk-metric-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .risk-metric-value.good { color: var(--success); }
        .risk-metric-value.moderate { color: var(--warning); }
        .risk-metric-value.poor { color: var(--danger); }

        .risk-metric-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .risk-metric-desc {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .risk-gauge {
            position: relative;
            width: 120px;
            height: 60px;
            margin: 0 auto 12px;
        }

        .risk-gauge-bg {
            position: absolute;
            width: 120px;
            height: 60px;
            border-radius: 60px 60px 0 0;
            background: linear-gradient(90deg, var(--success) 0%, var(--warning) 50%, var(--danger) 100%);
            overflow: hidden;
        }

        .risk-gauge-mask {
            position: absolute;
            bottom: 0;
            left: 10px;
            right: 10px;
            height: 50px;
            background: var(--bg-primary);
            border-radius: 50px 50px 0 0;
        }

        .risk-gauge-needle {
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 4px;
            height: 50px;
            background: var(--text-primary);
            transform-origin: bottom center;
            border-radius: 2px;
            transition: transform 0.5s ease;
        }

        /* ========== CORRELATION MATRIX ========== */
        .correlation-matrix {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            padding: 24px;
            overflow-x: auto;
        }

        .correlation-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8125rem;
        }

        .correlation-table th,
        .correlation-table td {
            padding: 8px 12px;
            text-align: center;
            min-width: 60px;
        }

        .correlation-table th {
            font-weight: 600;
            background: var(--bg-secondary);
        }

        .correlation-cell {
            border-radius: 4px;
            font-weight: 500;
        }

        .correlation-cell[data-value="high-positive"] { background: rgba(48, 209, 88, 0.3); }
        .correlation-cell[data-value="medium-positive"] { background: rgba(48, 209, 88, 0.15); }
        .correlation-cell[data-value="low"] { background: var(--bg-secondary); }
        .correlation-cell[data-value="medium-negative"] { background: rgba(255, 69, 58, 0.15); }
        .correlation-cell[data-value="high-negative"] { background: rgba(255, 69, 58, 0.3); }

        /* ========== EARNINGS CALENDAR ========== */
        .earnings-calendar {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            padding: 24px;
        }

        .earnings-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .earnings-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
        }

        .earnings-date {
            text-align: center;
            min-width: 60px;
        }

        .earnings-day {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .earnings-month {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .earnings-info {
            flex: 1;
        }

        .earnings-symbol {
            font-weight: 600;
            margin-bottom: 2px;
        }

        .earnings-name {
            font-size: 0.8125rem;
            color: var(--text-secondary);
        }

        .earnings-estimates {
            text-align: right;
        }

        .earnings-eps-label {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .earnings-eps-value {
            font-weight: 600;
        }

        .earnings-time {
            font-size: 0.75rem;
            color: var(--text-muted);
            padding: 4px 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
        }

        @media (max-width: 768px) {
            .comparison-container {
                grid-template-columns: 1fr;
            }

            .comparison-diff-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .performance-stats {
                grid-template-columns: repeat(2, 1fr);
            }

            .risk-metrics-grid {
                grid-template-columns: 1fr;
            }

            .goal-type-options {
                grid-template-columns: 1fr;
            }
        }

        /* ========== REBALANCING CALCULATOR ========== */
        .rebalance-container {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            padding: 24px;
        }

        .rebalance-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .rebalance-mode-toggle {
            display: flex;
            gap: 8px;
        }

        .rebalance-mode-btn {
            padding: 8px 16px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            background: var(--bg-secondary);
            font-size: 0.875rem;
            cursor: pointer;
        }

        .rebalance-mode-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .rebalance-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }

        .rebalance-current, .rebalance-target {
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            padding: 20px;
        }

        .rebalance-section-title {
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .rebalance-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }

        .rebalance-table th {
            text-align: left;
            padding: 10px 8px;
            font-weight: 600;
            color: var(--text-muted);
            font-size: 0.75rem;
            text-transform: uppercase;
            border-bottom: 1px solid var(--border);
        }

        .rebalance-table td {
            padding: 10px 8px;
            border-bottom: 1px solid var(--border);
        }

        .rebalance-table input {
            width: 70px;
            padding: 6px 8px;
            border-radius: 4px;
            border: 1px solid var(--border);
            text-align: right;
            font-size: 0.875rem;
        }

        .rebalance-trades {
            margin-top: 24px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            padding: 20px;
        }

        .trade-action {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg-primary);
            border-radius: var(--radius-sm);
            margin-bottom: 8px;
        }

        .trade-action:last-child {
            margin-bottom: 0;
        }

        .trade-direction {
            padding: 4px 10px;
            border-radius: 4px;
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
        }

        .trade-direction.buy {
            background: rgba(48, 209, 88, 0.15);
            color: var(--success);
        }

        .trade-direction.sell {
            background: rgba(255, 69, 58, 0.15);
            color: var(--danger);
        }

        .trade-symbol {
            font-weight: 600;
            min-width: 60px;
        }

        .trade-details {
            flex: 1;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .trade-value {
            font-weight: 600;
        }

        /* ========== CONTRIBUTION CALCULATOR ========== */
        .contribution-calculator {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            padding: 24px;
        }

        .contribution-inputs {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .contribution-input-group {
            display: flex;
            flex-direction: column;
        }

        .contribution-input-group label {
            font-size: 0.8125rem;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .contribution-input-group input,
        .contribution-input-group select {
            padding: 10px 12px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            font-size: 0.9375rem;
        }

        .contribution-results {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid var(--border);
        }

        .contribution-result {
            text-align: center;
            padding: 20px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
        }

        .contribution-result-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 4px;
        }

        .contribution-result-label {
            font-size: 0.8125rem;
            color: var(--text-secondary);
        }

        .contribution-breakdown {
            margin-top: 24px;
        }

        .contribution-breakdown-title {
            font-weight: 600;
            margin-bottom: 16px;
        }

        .contribution-bar {
            height: 32px;
            border-radius: var(--radius-sm);
            display: flex;
            overflow: hidden;
        }

        .contribution-bar-segment {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 500;
            color: white;
        }

        .contribution-bar-principal {
            background: var(--primary);
        }

        .contribution-bar-contributions {
            background: var(--success);
        }

        .contribution-bar-growth {
            background: var(--warning);
        }

        /* ========== HOLDING NOTES & TAGS ========== */
        .holding-notes-btn {
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid var(--border);
            background: var(--bg-secondary);
            font-size: 0.75rem;
            cursor: pointer;
        }

        .holding-notes-btn:hover {
            border-color: var(--primary);
        }

        .holding-tags {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
            margin-top: 4px;
        }

        .holding-tag {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.6875rem;
            font-weight: 500;
        }

        .holding-tag.growth { background: rgba(99, 91, 255, 0.15); color: var(--primary); }
        .holding-tag.value { background: rgba(48, 209, 88, 0.15); color: var(--success); }
        .holding-tag.dividend { background: rgba(255, 159, 10, 0.15); color: #ff9f0a; }
        .holding-tag.speculative { background: rgba(255, 69, 58, 0.15); color: var(--danger); }
        .holding-tag.core { background: rgba(136, 152, 170, 0.15); color: var(--text-secondary); }

        .notes-modal-content {
            max-width: 500px;
        }

        .notes-textarea {
            width: 100%;
            min-height: 120px;
            padding: 12px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            font-family: inherit;
            font-size: 0.9375rem;
            resize: vertical;
            margin-bottom: 16px;
        }

        .tag-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 16px;
        }

        .tag-option {
            padding: 6px 12px;
            border-radius: 16px;
            border: 2px solid var(--border);
            font-size: 0.8125rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tag-option:hover {
            border-color: var(--primary-light);
        }

        .tag-option.selected {
            border-color: var(--primary);
            background: rgba(99, 91, 255, 0.1);
        }

        /* ========== QUICK STATS MINI CARDS ========== */
        .quick-stats-row {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            overflow-x: auto;
            padding-bottom: 8px;
        }

        .quick-stat-mini {
            flex-shrink: 0;
            background: var(--bg-primary);
            border-radius: var(--radius-md);
            padding: 16px 20px;
            min-width: 140px;
            border: 1px solid var(--border);
        }

        .quick-stat-mini-value {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 2px;
        }

        .quick-stat-mini-label {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .quick-stat-mini-change {
            font-size: 0.75rem;
            margin-top: 4px;
        }

        .quick-stat-mini-change.positive { color: var(--success); }
        .quick-stat-mini-change.negative { color: var(--danger); }

        @media (max-width: 768px) {
            .rebalance-grid {
                grid-template-columns: 1fr;
            }

            .contribution-inputs {
                grid-template-columns: 1fr 1fr;
            }

            .contribution-results {
                grid-template-columns: 1fr;
            }
        }

        /* ========== RISK GAUGE VISUALIZATION ========== */
        .risk-gauge-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 24px;
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            margin-bottom: 24px;
        }

        .risk-gauge-wrapper {
            position: relative;
            width: 200px;
            height: 120px;
            margin-bottom: 16px;
        }

        .risk-gauge-arc {
            position: absolute;
            width: 200px;
            height: 100px;
            border-radius: 100px 100px 0 0;
            background: conic-gradient(from 180deg,
                var(--success) 0deg,
                var(--success) 36deg,
                #8BC34A 36deg,
                #8BC34A 72deg,
                var(--warning) 72deg,
                var(--warning) 108deg,
                #FF9800 108deg,
                #FF9800 144deg,
                var(--danger) 144deg,
                var(--danger) 180deg
            );
            clip-path: polygon(0 100%, 100% 100%, 100% 0, 0 0);
        }

        .risk-gauge-inner {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 160px;
            height: 80px;
            background: var(--bg-primary);
            border-radius: 80px 80px 0 0;
        }

        .risk-gauge-needle {
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 4px;
            height: 80px;
            background: linear-gradient(to top, var(--text-primary), var(--text-primary) 70%, transparent);
            transform-origin: bottom center;
            transform: translateX(-50%) rotate(-90deg);
            transition: transform 1s ease-out;
            border-radius: 2px;
        }

        .risk-gauge-center {
            position: absolute;
            bottom: -8px;
            left: 50%;
            width: 16px;
            height: 16px;
            background: var(--text-primary);
            border-radius: 50%;
            transform: translateX(-50%);
        }

        .risk-gauge-labels {
            display: flex;
            justify-content: space-between;
            width: 200px;
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .risk-gauge-score {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .risk-gauge-label {
            font-size: 1rem;
            color: var(--text-secondary);
        }

        /* ========== FACTOR EXPOSURE ========== */
        .factor-exposure-container {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            padding: 24px;
            margin-bottom: 24px;
        }

        .factor-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        .factor-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .factor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .factor-name {
            font-weight: 500;
            font-size: 0.9375rem;
        }

        .factor-value {
            font-weight: 600;
            font-size: 0.875rem;
        }

        .factor-bar {
            height: 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            overflow: hidden;
        }

        .factor-bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .factor-bar-fill.value { background: #4CAF50; }
        .factor-bar-fill.growth { background: #2196F3; }
        .factor-bar-fill.momentum { background: #9C27B0; }
        .factor-bar-fill.quality { background: #FF9800; }
        .factor-bar-fill.size { background: #607D8B; }
        .factor-bar-fill.volatility { background: #f44336; }

        .factor-description {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* ========== MARKET INDICATORS ========== */
        .market-indicators {
            display: flex;
            justify-content: center;
            gap: 12px;
            padding: 8px 24px 12px;
            background: transparent;
            border-radius: var(--radius-lg);
            margin-top: 0;
            margin-bottom: 0;
            overflow-x: auto;
        }

        .market-indicator {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 100px;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            position: relative;
            overflow: hidden;
        }

        .market-indicator::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 50%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.15), transparent);
            animation: shimmer 10s ease-in-out infinite;
        }

        @keyframes shimmer {
            0%, 90%, 100% { left: -100%; }
            95% { left: 200%; }
        }

        .market-indicator-name {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 4px;
            white-space: nowrap;
        }

        .market-indicator-value {
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 2px;
        }

        .market-indicator-change {
            font-size: 0.75rem;
            font-weight: 500;
        }

        .market-indicator-change.up { color: var(--success); }
        .market-indicator-change.down { color: var(--danger); }

        /* ========== INCOME PROJECTION ========== */
        .income-projection {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            padding: 24px;
        }

        .income-projection-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .income-chart-container {
            height: 300px;
            margin-bottom: 20px;
        }

        .income-summary-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
        }

        .income-summary-item {
            text-align: center;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
        }

        .income-summary-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--success);
            margin-bottom: 4px;
        }

        .income-summary-label {
            font-size: 0.8125rem;
            color: var(--text-secondary);
        }

        /* ========== STOCK SCREENER MINI ========== */
        .screener-mini {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            padding: 24px;
        }

        .screener-filters {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .screener-filter {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .screener-filter label {
            font-size: 0.8125rem;
            color: var(--text-secondary);
        }

        .screener-filter select,
        .screener-filter input {
            padding: 6px 10px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            font-size: 0.875rem;
            min-width: 100px;
        }

        .screener-results {
            max-height: 400px;
            overflow-y: auto;
        }

        @media (max-width: 768px) {
            .factor-grid {
                grid-template-columns: 1fr;
            }

            .income-summary-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* ========== PORTFOLIO HEAT MAP ========== */
        .heat-map-container {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            padding: 24px;
            margin-bottom: 24px;
        }

        .heat-map-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .heat-map-period-selector {
            display: flex;
            gap: 8px;
        }

        .heat-map-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 8px;
        }

        .heat-map-cell {
            aspect-ratio: 1.2;
            border-radius: var(--radius-sm);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px 6px;
            cursor: pointer;
            transition: transform 0.2s;
            gap: 2px;
        }

        .heat-map-cell:hover {
            transform: scale(1.05);
            z-index: 1;
        }

        .heat-map-symbol {
            font-weight: 600;
            font-size: 0.875rem;
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        .heat-map-change {
            font-size: 0.75rem;
            color: white;
            opacity: 0.9;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        .heat-map-name {
            font-size: 0.625rem;
            color: white;
            opacity: 0.75;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            text-align: center;
            line-height: 1.2;
        }

        .heat-map-cell.gain-large { background: #1B5E20; }
        .heat-map-cell.gain-medium { background: #388E3C; }
        .heat-map-cell.gain-small { background: #4CAF50; }
        .heat-map-cell.neutral { background: #9E9E9E; }
        .heat-map-cell.loss-small { background: #E57373; }
        .heat-map-cell.loss-medium { background: #E53935; }
        .heat-map-cell.loss-large { background: #B71C1C; }

        .heat-map-legend {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 16px;
            font-size: 0.75rem;
        }

        .heat-map-legend-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .heat-map-legend-color {
            width: 16px;
            height: 16px;
            border-radius: 2px;
        }

        /* ========== ALLOCATION SUGGESTIONS ========== */
        .suggestions-container {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            padding: 24px;
            margin-bottom: 24px;
        }

        .suggestion-card {
            display: flex;
            gap: 16px;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            margin-bottom: 12px;
            border-left: 4px solid var(--primary);
        }

        .suggestion-card.warning {
            border-left-color: var(--warning);
        }

        .suggestion-card.success {
            border-left-color: var(--success);
        }

        .suggestion-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .suggestion-content {
            flex: 1;
        }

        .suggestion-title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .suggestion-text {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .suggestion-action {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 0.8125rem;
            color: var(--primary);
            font-weight: 500;
            cursor: pointer;
        }

        .suggestion-action:hover {
            text-decoration: underline;
        }

        /* ========== VALUATION METRICS ========== */
        .valuation-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
        }

        .valuation-card {
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            padding: 16px;
        }

        .valuation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .valuation-symbol {
            font-weight: 600;
        }

        .valuation-sector {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .valuation-metrics {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .valuation-metric {
            text-align: center;
        }

        .valuation-metric-value {
            font-weight: 600;
            font-size: 1rem;
        }

        .valuation-metric-value.undervalued { color: var(--success); }
        .valuation-metric-value.fair { color: var(--text-primary); }
        .valuation-metric-value.overvalued { color: var(--danger); }

        .valuation-metric-label {
            font-size: 0.6875rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        /* ========== CURRENCY EXPOSURE ========== */
        .currency-exposure-container {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            padding: 24px;
        }

        .currency-chart-container {
            display: flex;
            gap: 24px;
            align-items: center;
        }

        .currency-donut {
            width: 200px;
            height: 200px;
            flex-shrink: 0;
        }

        .currency-list {
            flex: 1;
        }

        .currency-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }

        .currency-item:last-child {
            border-bottom: none;
        }

        .currency-flag {
            width: 32px;
            height: 24px;
            border-radius: 4px;
            background: var(--bg-tertiary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .currency-info {
            flex: 1;
        }

        .currency-name {
            font-weight: 500;
            font-size: 0.9375rem;
        }

        .currency-code {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .currency-allocation {
            text-align: right;
        }

        .currency-percent {
            font-weight: 600;
        }

        .currency-value {
            font-size: 0.8125rem;
            color: var(--text-secondary);
        }

        @media (max-width: 768px) {
            .currency-chart-container {
                flex-direction: column;
            }

            .heat-map-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
    </style>
</head>
<body>
    <!-- Skip to main content link for accessibility -->
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <!-- Announcement Bar -->
    <div class="announcement-bar" id="announcement-bar">
        <div class="announcement-inner">
            <span> Now supporting 50+ brokerages including Schwab, Fidelity, and Vanguard</span>
            <a href="#hero-upload" class="announcement-link" onclick="scrollToUpload(); return false;">Try it free </a>
            <button class="announcement-close" aria-label="Close announcement" onclick="document.getElementById('announcement-bar').style.display='none';"></button>
        </div>
    </div>

    <nav class="top-nav" role="navigation" aria-label="Main navigation">
        <div class="nav-inner">
            <!-- Left: Logo -->
            <div class="nav-left">
                    <div class="logo">
                        <div class="logo-icon">
                            <!-- Paul Rand-inspired logo: Bold geometric "S" with scan line -->
                            <svg viewBox="0 0 44 44" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <!-- Abstract S formed by two offset squares with negative space -->
                                <rect x="0" y="0" width="24" height="24" rx="4" fill="white"/>
                                <rect x="20" y="20" width="24" height="24" rx="4" fill="white"/>
                                <!-- Scan line cutting through - the key action element -->
                                <rect x="0" y="19" width="44" height="6" fill="white" opacity="0.4"/>
                                <!-- Central diamond connector -->
                                <rect x="16" y="16" width="12" height="12" rx="2" fill="white" transform="rotate(0 22 22)"/>
                            </svg>
                        </div>
                        <div class="brand-text">
                            <span class="brand-name">Statement Scan</span>
                            <span class="brand-tagline">Portfolio Intelligence</span>
                        </div>
                    </div>
                </div>

                <!-- Center: Navigation Links -->
                <div class="nav-center">
                    <!-- Products Dropdown -->
                    <div class="nav-item" data-dropdown="products">
                        <button class="nav-link" aria-haspopup="true" aria-expanded="false">
                            Products
                            <svg class="nav-link-chevron" viewBox="0 0 10 10" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M2 3.5L5 6.5L8 3.5"/>
                            </svg>
                        </button>
                        <div class="nav-dropdown dropdown-wide" role="menu">
                            <div class="dropdown-columns">
                                <div class="dropdown-column">
                                    <div class="dropdown-column-title">Analyze</div>
                                    <a class="dropdown-item" role="menuitem" onclick="navScrollToUpload('upload'); closeAllDropdowns();">
                                        <span class="dropdown-item-icon"></span>
                                        <div class="dropdown-item-content">
                                            <div class="dropdown-item-title">Statement Upload</div>
                                            <div class="dropdown-item-desc">Upload PDF or CSV brokerage statements for instant analysis</div>
                                        </div>
                                    </a>
                                    <a class="dropdown-item" role="menuitem" onclick="navScrollToUpload('manual'); closeAllDropdowns();">
                                        <span class="dropdown-item-icon"></span>
                                        <div class="dropdown-item-content">
                                            <div class="dropdown-item-title">Manual Entry</div>
                                            <div class="dropdown-item-desc">Enter holdings by ticker and quantity or allocation percentage</div>
                                        </div>
                                    </a>
                                    <a class="dropdown-item" role="menuitem" onclick="navScrollToUpload('connect'); closeAllDropdowns();">
                                        <span class="dropdown-item-icon"></span>
                                        <div class="dropdown-item-content">
                                            <div class="dropdown-item-title">Brokerage Connect <span class="tag-coming-soon">Coming Soon</span></div>
                                            <div class="dropdown-item-desc">Link your Schwab, Fidelity, or Vanguard account directly</div>
                                        </div>
                                    </a>
                                </div>
                                <div class="dropdown-column">
                                    <div class="dropdown-column-title">Insights</div>
                                    <a class="dropdown-item" role="menuitem" onclick="navScrollToSection('previewSection'); closeAllDropdowns();">
                                        <span class="dropdown-item-icon"></span>
                                        <div class="dropdown-item-content">
                                            <div class="dropdown-item-title">Portfolio Report</div>
                                            <div class="dropdown-item-desc">Allocation, sector exposure, and risk analysis in one view</div>
                                        </div>
                                    </a>
                                    <a class="dropdown-item" role="menuitem" onclick="navScrollToSection('previewSection'); closeAllDropdowns();">
                                        <span class="dropdown-item-icon"></span>
                                        <div class="dropdown-item-content">
                                            <div class="dropdown-item-title">Fee Analysis</div>
                                            <div class="dropdown-item-desc">Find hidden expense ratios and see potential savings</div>
                                        </div>
                                    </a>
                                    <a class="dropdown-item" role="menuitem" onclick="navScrollToSection('previewSection'); closeAllDropdowns();">
                                        <span class="dropdown-item-icon"></span>
                                        <div class="dropdown-item-content">
                                            <div class="dropdown-item-title">Benchmark Comparison</div>
                                            <div class="dropdown-item-desc">Compare your performance against the S&P 500 and target-date funds</div>
                                        </div>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Solutions Dropdown -->
                    <div class="nav-item" data-dropdown="solutions">
                        <button class="nav-link" aria-haspopup="true" aria-expanded="false">
                            Solutions
                            <svg class="nav-link-chevron" viewBox="0 0 10 10" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M2 3.5L5 6.5L8 3.5"/>
                            </svg>
                        </button>
                        <div class="nav-dropdown" role="menu">
                            <a class="dropdown-item" role="menuitem" onclick="navScrollToSection('heroSection'); closeAllDropdowns();">
                                <span class="dropdown-item-icon"></span>
                                <div class="dropdown-item-content">
                                    <div class="dropdown-item-title">For Self-Directed Investors</div>
                                    <div class="dropdown-item-desc">Understand your portfolio like the pros do</div>
                                </div>
                            </a>
                            <a class="dropdown-item" role="menuitem" onclick="navScrollToSection('heroSection'); closeAllDropdowns();">
                                <span class="dropdown-item-icon"></span>
                                <div class="dropdown-item-content">
                                    <div class="dropdown-item-title">For Families</div>
                                    <div class="dropdown-item-desc">Get clarity across multiple accounts and beneficiaries</div>
                                </div>
                            </a>
                            <a class="dropdown-item" role="menuitem" onclick="navScrollToSection('heroSection'); closeAllDropdowns();">
                                <span class="dropdown-item-icon"></span>
                                <div class="dropdown-item-content">
                                    <div class="dropdown-item-title">For Financial Advisors <span class="tag-coming-soon">Coming Soon</span></div>
                                    <div class="dropdown-item-desc">Quick portfolio diagnostics for client onboarding</div>
                                </div>
                            </a>
                        </div>
                    </div>

                    <!-- Resources Dropdown -->
                    <div class="nav-item" data-dropdown="resources">
                        <button class="nav-link" aria-haspopup="true" aria-expanded="false">
                            Resources
                            <svg class="nav-link-chevron" viewBox="0 0 10 10" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M2 3.5L5 6.5L8 3.5"/>
                            </svg>
                        </button>
                        <div class="nav-dropdown" role="menu">
                            <a class="dropdown-item" role="menuitem" onclick="navScrollToSection('howItWorksSection'); closeAllDropdowns();">
                                <span class="dropdown-item-icon"></span>
                                <div class="dropdown-item-content">
                                    <div class="dropdown-item-title">How It Works</div>
                                    <div class="dropdown-item-desc">Learn how Statement Scan analyzes your portfolio</div>
                                </div>
                            </a>
                            <a class="dropdown-item" role="menuitem" onclick="scrollToUpload(); closeAllDropdowns();">
                                <span class="dropdown-item-icon"></span>
                                <div class="dropdown-item-content">
                                    <div class="dropdown-item-title">Supported Brokerages</div>
                                    <div class="dropdown-item-desc">Upload from Schwab, Fidelity, Vanguard & 50+ more</div>
                                </div>
                            </a>
                            <a class="dropdown-item" role="menuitem" onclick="navScrollToSection('valuePropsSection'); closeAllDropdowns();">
                                <span class="dropdown-item-icon"></span>
                                <div class="dropdown-item-content">
                                    <div class="dropdown-item-title">Privacy & Security</div>
                                    <div class="dropdown-item-desc">How we protect your data</div>
                                </div>
                            </a>
                            <a class="dropdown-item" role="menuitem" href="mailto:support@statementscan.app" onclick="closeAllDropdowns();">
                                <span class="dropdown-item-icon"></span>
                                <div class="dropdown-item-content">
                                    <div class="dropdown-item-title">Contact Us</div>
                                    <div class="dropdown-item-desc">Get in touch with our team</div>
                                </div>
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Right: Actions -->
                <div class="nav-right">
                    <!-- Mobile Menu Button -->
                    <button class="mobile-menu-btn" onclick="openMobileMenu()" aria-label="Open menu">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="3" y1="6" x2="21" y2="6"/>
                            <line x1="3" y1="12" x2="21" y2="12"/>
                            <line x1="3" y1="18" x2="21" y2="18"/>
                        </svg>
                    </button>
                    <div id="authSection">
                        <button class="btn btn-secondary" id="loginBtn" onclick="showAuthModal()">
                            Sign In
                        </button>
                    </div>
                    <button class="btn-get-started" onclick="showAuthModal(); switchAuthTab('register');">Create Account</button>
                </div>
            </div>
        </nav>

        <!-- Mobile Menu Overlay -->
            <div class="mobile-menu-overlay" id="mobileMenuOverlay">
                <div class="mobile-menu-header">
                    <div class="logo">
                        <div class="logo-icon">
                            <svg viewBox="0 0 44 44" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <rect x="0" y="0" width="24" height="24" rx="4" fill="white"/>
                                <rect x="20" y="20" width="24" height="24" rx="4" fill="white"/>
                                <rect x="0" y="19" width="44" height="6" fill="white" opacity="0.4"/>
                                <rect x="16" y="16" width="12" height="12" rx="2" fill="white"/>
                            </svg>
                        </div>
                        <div class="brand-text">
                            <span class="brand-name">Statement Scan</span>
                        </div>
                    </div>
                    <button class="mobile-menu-close" onclick="closeMobileMenu()" aria-label="Close menu"></button>
                </div>
                <div class="mobile-menu-content">
                    <!-- Products Accordion -->
                    <div class="mobile-accordion" data-accordion="products">
                        <button class="mobile-accordion-header" onclick="toggleMobileAccordion('products')">
                            Products
                            <svg viewBox="0 0 10 10" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M2 3.5L5 6.5L8 3.5"/>
                            </svg>
                        </button>
                        <div class="mobile-accordion-content">
                            <a class="mobile-dropdown-item" onclick="navScrollToUpload('upload'); closeMobileMenu();">
                                <span class="dropdown-item-icon"></span>
                                <div class="dropdown-item-content">
                                    <div class="dropdown-item-title">Statement Upload</div>
                                    <div class="dropdown-item-desc">Upload PDF or CSV brokerage statements</div>
                                </div>
                            </a>
                            <a class="mobile-dropdown-item" onclick="navScrollToUpload('manual'); closeMobileMenu();">
                                <span class="dropdown-item-icon"></span>
                                <div class="dropdown-item-content">
                                    <div class="dropdown-item-title">Manual Entry</div>
                                    <div class="dropdown-item-desc">Enter holdings by ticker and quantity</div>
                                </div>
                            </a>
                            <a class="mobile-dropdown-item" onclick="navScrollToUpload('connect'); closeMobileMenu();">
                                <span class="dropdown-item-icon"></span>
                                <div class="dropdown-item-content">
                                    <div class="dropdown-item-title">Brokerage Connect <span class="tag-coming-soon">Coming Soon</span></div>
                                    <div class="dropdown-item-desc">Link your account directly</div>
                                </div>
                            </a>
                            <a class="mobile-dropdown-item" onclick="navScrollToSection('previewSection'); closeMobileMenu();">
                                <span class="dropdown-item-icon"></span>
                                <div class="dropdown-item-content">
                                    <div class="dropdown-item-title">Portfolio Report</div>
                                    <div class="dropdown-item-desc">Allocation and risk analysis</div>
                                </div>
                            </a>
                        </div>
                    </div>

                    <!-- Solutions Accordion -->
                    <div class="mobile-accordion" data-accordion="solutions">
                        <button class="mobile-accordion-header" onclick="toggleMobileAccordion('solutions')">
                            Solutions
                            <svg viewBox="0 0 10 10" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M2 3.5L5 6.5L8 3.5"/>
                            </svg>
                        </button>
                        <div class="mobile-accordion-content">
                            <a class="mobile-dropdown-item" onclick="navScrollToSection('heroSection'); closeMobileMenu();">
                                <span class="dropdown-item-icon"></span>
                                <div class="dropdown-item-content">
                                    <div class="dropdown-item-title">For Self-Directed Investors</div>
                                    <div class="dropdown-item-desc">Understand your portfolio like the pros</div>
                                </div>
                            </a>
                            <a class="mobile-dropdown-item" onclick="navScrollToSection('heroSection'); closeMobileMenu();">
                                <span class="dropdown-item-icon"></span>
                                <div class="dropdown-item-content">
                                    <div class="dropdown-item-title">For Families</div>
                                    <div class="dropdown-item-desc">Clarity across multiple accounts</div>
                                </div>
                            </a>
                            <a class="mobile-dropdown-item" onclick="navScrollToSection('heroSection'); closeMobileMenu();">
                                <span class="dropdown-item-icon"></span>
                                <div class="dropdown-item-content">
                                    <div class="dropdown-item-title">For Financial Advisors <span class="tag-coming-soon">Coming Soon</span></div>
                                    <div class="dropdown-item-desc">Client onboarding diagnostics</div>
                                </div>
                            </a>
                        </div>
                    </div>

                    <!-- Resources Accordion -->
                    <div class="mobile-accordion" data-accordion="resources">
                        <button class="mobile-accordion-header" onclick="toggleMobileAccordion('resources')">
                            Resources
                            <svg viewBox="0 0 10 10" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M2 3.5L5 6.5L8 3.5"/>
                            </svg>
                        </button>
                        <div class="mobile-accordion-content">
                            <a class="mobile-dropdown-item" onclick="navScrollToSection('howItWorksSection'); closeMobileMenu();">
                                <span class="dropdown-item-icon"></span>
                                <div class="dropdown-item-content">
                                    <div class="dropdown-item-title">How It Works</div>
                                    <div class="dropdown-item-desc">Learn about the analysis process</div>
                                </div>
                            </a>
                            <a class="mobile-dropdown-item" onclick="scrollToUpload(); closeMobileMenu();">
                                <span class="dropdown-item-icon"></span>
                                <div class="dropdown-item-content">
                                    <div class="dropdown-item-title">Supported Brokerages</div>
                                    <div class="dropdown-item-desc">Schwab, Fidelity, Vanguard & 50+ more</div>
                                </div>
                            </a>
                            <a class="mobile-dropdown-item" onclick="navScrollToSection('valuePropsSection'); closeMobileMenu();">
                                <span class="dropdown-item-icon"></span>
                                <div class="dropdown-item-content">
                                    <div class="dropdown-item-title">Privacy & Security</div>
                                    <div class="dropdown-item-desc">How we protect your data</div>
                                </div>
                            </a>
                            <a class="mobile-dropdown-item" href="mailto:support@statementscan.app" onclick="closeMobileMenu();">
                                <span class="dropdown-item-icon"></span>
                                <div class="dropdown-item-content">
                                    <div class="dropdown-item-title">Contact Us</div>
                                    <div class="dropdown-item-desc">Get in touch</div>
                                </div>
                            </a>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="mobile-menu-actions">
                        <button class="btn btn-secondary" onclick="showAuthModal(); closeMobileMenu();">Sign In</button>
                        <button class="btn-get-started" onclick="showAuthModal(); switchAuthTab('register'); closeMobileMenu();">Create Account</button>
                    </div>
                </div>
            </div>

        <!-- Hero Section -->
        <section class="hero-section">
            <div class="hero-inner">
            <div class="hero-grid">
                <!-- Left Column: Content -->
                <div class="hero-content">
                    <div class="hero-badge" data-hero-animate style="animation-delay: 0s;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/>
                        </svg>
                        AI-Powered Portfolio Intelligence
                    </div>
                    <h1 class="hero-title" data-hero-animate style="animation-delay: 0.08s;">Your brokerage statement, <span class="gradient-text">decoded</span></h1>
                    <p class="hero-subtitle" data-hero-animate style="animation-delay: 0.16s;">Upload any statement and get instant portfolio analytics, fee analysis, and actionable insights  completely free, no account required.</p>
                    <div class="hero-ctas" data-hero-animate style="animation-delay: 0.24s;">
                        <button class="hero-cta-primary" onclick="scrollToUpload()">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                <polyline points="17 8 12 3 7 8"/>
                                <line x1="12" y1="3" x2="12" y2="15"/>
                            </svg>
                            Analyze Your Portfolio  Free
                        </button>
                        <a href="#landingSections" class="hero-cta-link">
                            See how it works
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="5" y1="12" x2="19" y2="12"/>
                                <polyline points="12 5 19 12 12 19"/>
                            </svg>
                        </a>
                    </div>
                    <p class="hero-trust-line"> Free forever  No credit card  No signup required  100% private</p>
                </div>

                <!-- Right Column: Upload Widget -->
                <div class="hero-upload-wrapper" data-hero-animate style="animation-delay: 0.35s;">
                    <div class="hero-upload-glow"></div>
                    <div class="hero-upload-card">
                        <!-- Entry Method Selector -->
                        <div class="entry-methods" style="margin-bottom: 20px;">
                            <button class="entry-method-btn active" data-method="upload" onclick="switchEntryMethod('upload')">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                    <polyline points="17 8 12 3 7 8"/>
                                    <line x1="12" y1="3" x2="12" y2="15"/>
                                </svg>
                                Upload Files
                            </button>
                            <button class="entry-method-btn" data-method="manual" onclick="switchEntryMethod('manual')">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                </svg>
                                Manual
                            </button>
                            <button class="entry-method-btn" data-method="connect" onclick="switchEntryMethod('connect')">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="2" y="4" width="20" height="16" rx="2"/>
                                    <path d="M7 15h0M2 9h20"/>
                                </svg>
                                Connect
                            </button>
                        </div>

                        <main id="main-content">
                        <!-- Error message container is now replaced by toast system -->
                        <div class="error-message" id="errorMessage" role="alert" aria-live="polite"></div>

                        <!-- Upload Section -->
                        <div id="uploadSection">

                            <!-- Upload Panel -->
                            <div class="entry-panel active" id="uploadPanel">
                                <div class="upload-drop-area" id="dropZone">
                                    <div class="upload-icon">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                            <polyline points="17 8 12 3 7 8"/>
                                            <line x1="12" y1="3" x2="12" y2="15"/>
                                        </svg>
                                    </div>
                                    <div class="upload-title">Drop your statement here</div>
                                    <p class="upload-hint">PDF, CSV, OFX, QFX, or image files (PNG, JPG) from any brokerage</p>
                                    <span class="upload-free-badge">100% free  Analyzed on your device</span>
                                    <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()" aria-label="Select files to upload">
                                        Select Files
                                    </button>
                                    <input type="file" id="fileInput" accept=".pdf,.csv,.ofx,.qfx,.png,.jpg,.jpeg,.webp" multiple aria-label="File input for brokerage statements">

                                    <!-- PII Redaction Toggle -->
                                    <div class="redact-pii-option">
                                        <label class="toggle-switch">
                                            <input type="checkbox" id="redactPiiToggle" checked>
                                            <span class="toggle-slider"></span>
                                        </label>
                                        <div class="redact-pii-label">
                                            <span class="redact-pii-title">Redact sensitive info</span>
                                            <span class="redact-pii-hint">Mask account numbers, SSN</span>
                                        </div>
                                    </div>

                                    <!-- Upload Queue (shown during batch upload) -->
                                    <div class="upload-queue" id="uploadQueue" style="display: none;">
                                        <div class="upload-queue-header">
                                            <span id="uploadQueueTitle">Uploading files...</span>
                                            <span id="uploadQueueCount"></span>
                                        </div>
                                        <div id="uploadQueueList"></div>
                                    </div>
                                </div>
                            </div>

            <!-- Manual Entry Panel -->
            <div class="entry-panel" id="manualPanel">
                <div class="card manual-entry-card">
                    <div class="upload-title" style="text-align: center; margin-bottom: 8px;">Enter your holdings</div>
                    <p class="upload-hint" style="text-align: center; margin-bottom: 16px;">Add positions by quantity or percentage allocation</p>

                    <!-- Input Mode Toggle -->
                    <div class="input-mode-toggle" style="display: flex; justify-content: center; gap: 8px; margin-bottom: 20px;">
                        <button class="mode-btn active" id="modeQuantity" onclick="setInputMode('quantity')">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="7" height="7"/>
                                <rect x="14" y="3" width="7" height="7"/>
                                <rect x="14" y="14" width="7" height="7"/>
                                <rect x="3" y="14" width="7" height="7"/>
                            </svg>
                            Quantity
                        </button>
                        <button class="mode-btn" id="modePercent" onclick="setInputMode('percent')">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="19" cy="5" r="2"/>
                                <circle cx="5" cy="19" r="2"/>
                                <line x1="5" y1="5" x2="19" y2="19"/>
                            </svg>
                            Allocation
                        </button>
                    </div>

                    <!-- Portfolio Value Input (for % Allocation mode) -->
                    <div id="portfolioValueSection" style="display: none; margin-bottom: 20px;">
                        <div style="display: flex; align-items: center; justify-content: center; gap: 12px; padding: 16px; background: var(--bg-secondary); border-radius: var(--radius-md);">
                            <label style="font-weight: 500; color: var(--text-secondary);">Total Portfolio Value:</label>
                            <div style="position: relative;">
                                <span style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-muted);">$</span>
                                <input type="number" id="portfolioValueInput" placeholder="100,000" value="100000" step="1000" min="1"
                                    style="padding: 10px 12px 10px 24px; border: 1px solid var(--border); border-radius: var(--radius-sm); font-size: 1rem; width: 150px;"
                                    onchange="updatePortfolioValue()">
                            </div>
                            <span id="allocationSummary" style="font-size: 0.875rem; color: var(--text-muted);">0% allocated</span>
                        </div>
                    </div>

                    <div class="manual-entry-form">
                        <div class="form-group" style="flex: 1.5;">
                            <label>Symbol or Name</label>
                            <div class="symbol-input-wrapper">
                                <input type="text" id="manualSymbol" placeholder="e.g., AAPL or Apple"
                                    oninput="searchStocks(this.value)"
                                    onblur="setTimeout(() => hideStockSearch(), 200)"
                                    onfocus="if(this.value.length >= 1) searchStocks(this.value)"
                                    onkeydown="handleSymbolKeydown(event)"
                                    autocomplete="off">
                                <div class="stock-search-results" id="stockSearchResults"></div>
                            </div>
                        </div>
                        <div class="form-group" id="quantityGroup">
                            <label id="quantityLabel">Quantity</label>
                            <input type="number" id="manualShares" placeholder="100" value="100" step="any" onkeypress="if(event.key==='Enter') addManualHolding()">
                        </div>
                        <div class="form-group" id="priceGroup">
                            <label>Price <span id="priceStatus" style="font-weight: normal; font-size: 0.7rem; color: var(--text-muted);"></span></label>
                            <input type="number" id="manualPrice" placeholder="Auto-fetch" step="0.01" onkeypress="if(event.key==='Enter') addManualHolding()">
                        </div>
                        <button class="btn btn-primary btn-add" onclick="addManualHolding()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="5" x2="12" y2="19"/>
                                <line x1="5" y1="12" x2="19" y2="12"/>
                            </svg>
                            Add
                        </button>
                    </div>

                    <div class="holdings-list" id="manualHoldingsList">
                        <div class="holdings-list-header">
                            <span>Symbol</span>
                            <span>Shares</span>
                            <span>Price</span>
                            <span>Value</span>
                            <span></span>
                        </div>
                        <div class="holdings-list-empty" id="holdingsEmpty">
                            No holdings added yet. Enter a symbol above to get started.
                        </div>
                    </div>

                    <div class="manual-entry-actions">
                        <div class="manual-total">
                            Total: <strong id="manualTotal">$0.00</strong>
                        </div>
                        <div style="display: flex; gap: 12px;">
                            <button class="btn btn-secondary" onclick="clearManualHoldings()" aria-label="Clear all holdings">Clear All</button>
                            <button class="btn btn-primary" id="analyzeManualBtn" onclick="analyzeManualHoldings()" disabled aria-label="Analyze portfolio">
                                Analyze Portfolio
                                <span class="kbd" style="margin-left: 8px;">Ctrl+Enter</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Connect Account Panel -->
            <div class="entry-panel" id="connectPanel">
                <div class="card upload-card coming-soon-card">
                    <div class="coming-soon-badge">Coming Soon</div>
                    <div class="upload-icon coming-soon-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="2" y="4" width="20" height="16" rx="2"/>
                            <path d="M7 15h0M2 9h20"/>
                        </svg>
                    </div>
                    <div class="upload-title">Connect your brokerage</div>
                    <p class="upload-hint">Securely link your account to automatically import holdings from Schwab, Fidelity, Vanguard, and more.</p>
                    <div class="coming-soon-features">
                        <div class="feature-item">
                            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                                <polyline points="22 4 12 14.01 9 11.01"/>
                            </svg>
                            <span>Automatic portfolio sync</span>
                        </div>
                        <div class="feature-item">
                            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                                <polyline points="22 4 12 14.01 9 11.01"/>
                            </svg>
                            <span>Real-time price updates</span>
                        </div>
                        <div class="feature-item">
                            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                                <polyline points="22 4 12 14.01 9 11.01"/>
                            </svg>
                            <span>Bank-level security with Plaid</span>
                        </div>
                    </div>
                    <button class="btn btn-secondary" disabled style="opacity: 0.6; cursor: not-allowed;">
                        <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px;">
                            <circle cx="12" cy="12" r="10"/>
                            <polyline points="12 6 12 12 16 14"/>
                        </svg>
                        Available Soon
                    </button>
                    <p class="coming-soon-note">We're working hard to bring you seamless brokerage integration. In the meantime, upload your statements or enter holdings manually.</p>
                </div>
            </div>

            <div class="accounts-section" id="accountsSection" style="display: none;">
                <div class="accounts-header">
                    <h3>Uploaded Accounts</h3>
                    <button class="btn btn-secondary" id="addMoreBtn">Add More</button>
                </div>
                <div id="accountsList"></div>
                <div class="actions-row">
                    <button class="btn btn-primary" id="analyzeBtn" disabled aria-label="Analyze portfolio">
                        Analyze Portfolio
                        <span class="kbd" style="margin-left: 8px;">Ctrl+Enter</span>
                    </button>
                    <button class="btn btn-secondary" id="downloadRedactedBtn" onclick="downloadRedactedPdf()" style="display: none;" aria-label="Download redacted PDF">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="7 10 12 15 17 10"/>
                            <line x1="12" y1="15" x2="12" y2="3"/>
                        </svg>
                        Download Redacted
                    </button>
                    <button class="btn btn-secondary" id="clearAllBtn" aria-label="Clear all accounts">Clear All</button>
                </div>
            </div>

            <!-- Plaid Integration Section -->
            <div class="plaid-section" id="plaidSection" style="display: none;">
                <div class="plaid-header">
                    <h3>
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="2" y="4" width="20" height="16" rx="2"/>
                            <path d="M7 15h0M2 9h20"/>
                        </svg>
                        Connected Accounts
                    </h3>
                    <button class="btn btn-primary" onclick="connectPlaidAccount()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <line x1="12" y1="8" x2="12" y2="16"/>
                            <line x1="8" y1="12" x2="16" y2="12"/>
                        </svg>
                        Connect Account
                    </button>
                </div>
                <div class="plaid-connections" id="plaidConnections">
                    <!-- Populated dynamically -->
                </div>
            </div>
        </div><!-- End uploadSection -->
                    </div><!-- End hero-upload-card -->
                </div><!-- End hero-upload-wrapper -->
            </div><!-- End hero-grid -->

            <!-- Brokerage Logo Strip (Social Proof) - Inside Hero -->
            <div class="brokerage-strip">
                <p class="brokerage-strip-label">Works with statements from</p>
                <div class="brokerage-strip-logos">
                    <div class="brokerage-strip-track">
                        <!-- First set -->
                        <div class="brokerage-logo"><img src="https://logo.clearbit.com/schwab.com" alt="Schwab" class="brokerage-logo-img" loading="lazy" onerror="this.src='https://www.google.com/s2/favicons?domain=schwab.com&sz=128';"><span class="brokerage-name">Schwab</span></div>
                        <div class="brokerage-logo"><img src="https://logo.clearbit.com/fidelity.com" alt="Fidelity" class="brokerage-logo-img" loading="lazy" onerror="this.src='https://www.google.com/s2/favicons?domain=fidelity.com&sz=128';"><span class="brokerage-name">Fidelity</span></div>
                        <div class="brokerage-logo"><img src="https://logo.clearbit.com/vanguard.com" alt="Vanguard" class="brokerage-logo-img" loading="lazy" onerror="this.src='https://www.google.com/s2/favicons?domain=vanguard.com&sz=128';"><span class="brokerage-name">Vanguard</span></div>
                        <div class="brokerage-logo"><img src="https://logo.clearbit.com/etrade.com" alt="E*TRADE" class="brokerage-logo-img" loading="lazy" onerror="this.src='https://www.google.com/s2/favicons?domain=etrade.com&sz=128';"><span class="brokerage-name">E*TRADE</span></div>
                        <div class="brokerage-logo"><img src="https://logo.clearbit.com/tdameritrade.com" alt="TD Ameritrade" class="brokerage-logo-img" loading="lazy" onerror="this.src='https://www.google.com/s2/favicons?domain=tdameritrade.com&sz=128';"><span class="brokerage-name">TD Ameritrade</span></div>
                        <div class="brokerage-logo"><img src="https://logo.clearbit.com/robinhood.com" alt="Robinhood" class="brokerage-logo-img" loading="lazy" onerror="this.src='https://www.google.com/s2/favicons?domain=robinhood.com&sz=128';"><span class="brokerage-name">Robinhood</span></div>
                        <div class="brokerage-logo"><img src="https://logo.clearbit.com/ml.com" alt="Merrill" class="brokerage-logo-img" loading="lazy" onerror="this.src='https://www.google.com/s2/favicons?domain=ml.com&sz=128';"><span class="brokerage-name">Merrill</span></div>
                        <div class="brokerage-logo"><img src="https://logo.clearbit.com/interactivebrokers.com" alt="Interactive Brokers" class="brokerage-logo-img" loading="lazy" onerror="this.src='https://www.google.com/s2/favicons?domain=interactivebrokers.com&sz=128';"><span class="brokerage-name">Interactive Brokers</span></div>
                        <div class="brokerage-logo"><img src="https://logo.clearbit.com/ally.com" alt="Ally Invest" class="brokerage-logo-img" loading="lazy" onerror="this.src='https://www.google.com/s2/favicons?domain=ally.com&sz=128';"><span class="brokerage-name">Ally Invest</span></div>
                        <div class="brokerage-logo"><img src="https://logo.clearbit.com/webull.com" alt="Webull" class="brokerage-logo-img" loading="lazy" onerror="this.src='https://www.google.com/s2/favicons?domain=webull.com&sz=128';"><span class="brokerage-name">Webull</span></div>
                        <div class="brokerage-logo"><img src="https://logo.clearbit.com/sofi.com" alt="SoFi" class="brokerage-logo-img" loading="lazy" onerror="this.src='https://www.google.com/s2/favicons?domain=sofi.com&sz=128';"><span class="brokerage-name">SoFi</span></div>
                        <div class="brokerage-logo"><img src="https://logo.clearbit.com/betterment.com" alt="Betterment" class="brokerage-logo-img" loading="lazy" onerror="this.src='https://www.google.com/s2/favicons?domain=betterment.com&sz=128';"><span class="brokerage-name">Betterment</span></div>
                        <!-- Duplicate for seamless loop -->
                        <div class="brokerage-logo"><img src="https://logo.clearbit.com/schwab.com" alt="Schwab" class="brokerage-logo-img" loading="lazy" onerror="this.src='https://www.google.com/s2/favicons?domain=schwab.com&sz=128';"><span class="brokerage-name">Schwab</span></div>
                        <div class="brokerage-logo"><img src="https://logo.clearbit.com/fidelity.com" alt="Fidelity" class="brokerage-logo-img" loading="lazy" onerror="this.src='https://www.google.com/s2/favicons?domain=fidelity.com&sz=128';"><span class="brokerage-name">Fidelity</span></div>
                        <div class="brokerage-logo"><img src="https://logo.clearbit.com/vanguard.com" alt="Vanguard" class="brokerage-logo-img" loading="lazy" onerror="this.src='https://www.google.com/s2/favicons?domain=vanguard.com&sz=128';"><span class="brokerage-name">Vanguard</span></div>
                        <div class="brokerage-logo"><img src="https://logo.clearbit.com/etrade.com" alt="E*TRADE" class="brokerage-logo-img" loading="lazy" onerror="this.src='https://www.google.com/s2/favicons?domain=etrade.com&sz=128';"><span class="brokerage-name">E*TRADE</span></div>
                        <div class="brokerage-logo"><img src="https://logo.clearbit.com/tdameritrade.com" alt="TD Ameritrade" class="brokerage-logo-img" loading="lazy" onerror="this.src='https://www.google.com/s2/favicons?domain=tdameritrade.com&sz=128';"><span class="brokerage-name">TD Ameritrade</span></div>
                        <div class="brokerage-logo"><img src="https://logo.clearbit.com/robinhood.com" alt="Robinhood" class="brokerage-logo-img" loading="lazy" onerror="this.src='https://www.google.com/s2/favicons?domain=robinhood.com&sz=128';"><span class="brokerage-name">Robinhood</span></div>
                        <div class="brokerage-logo"><img src="https://logo.clearbit.com/ml.com" alt="Merrill" class="brokerage-logo-img" loading="lazy" onerror="this.src='https://www.google.com/s2/favicons?domain=ml.com&sz=128';"><span class="brokerage-name">Merrill</span></div>
                        <div class="brokerage-logo"><img src="https://logo.clearbit.com/interactivebrokers.com" alt="Interactive Brokers" class="brokerage-logo-img" loading="lazy" onerror="this.src='https://www.google.com/s2/favicons?domain=interactivebrokers.com&sz=128';"><span class="brokerage-name">Interactive Brokers</span></div>
                        <div class="brokerage-logo"><img src="https://logo.clearbit.com/ally.com" alt="Ally Invest" class="brokerage-logo-img" loading="lazy" onerror="this.src='https://www.google.com/s2/favicons?domain=ally.com&sz=128';"><span class="brokerage-name">Ally Invest</span></div>
                        <div class="brokerage-logo"><img src="https://logo.clearbit.com/webull.com" alt="Webull" class="brokerage-logo-img" loading="lazy" onerror="this.src='https://www.google.com/s2/favicons?domain=webull.com&sz=128';"><span class="brokerage-name">Webull</span></div>
                        <div class="brokerage-logo"><img src="https://logo.clearbit.com/sofi.com" alt="SoFi" class="brokerage-logo-img" loading="lazy" onerror="this.src='https://www.google.com/s2/favicons?domain=sofi.com&sz=128';"><span class="brokerage-name">SoFi</span></div>
                        <div class="brokerage-logo"><img src="https://logo.clearbit.com/betterment.com" alt="Betterment" class="brokerage-logo-img" loading="lazy" onerror="this.src='https://www.google.com/s2/favicons?domain=betterment.com&sz=128';"><span class="brokerage-name">Betterment</span></div>
                    </div>
                </div>
                <p class="brokerage-strip-more">+ 50 more brokerages supported</p>
            </div>

            </div><!-- End hero-inner -->
        </section><!-- End hero-section -->

        <!-- Progress -->
        <div class="progress-section" id="progressSection">
            <div class="progress-container">
                <!-- Stage Indicators -->
                <div class="progress-stages" id="progressStages">
                    <div class="progress-stage" data-stage="upload">
                        <div class="progress-stage-icon">
                            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                <polyline points="17 8 12 3 7 8"/>
                                <line x1="12" y1="3" x2="12" y2="15"/>
                            </svg>
                        </div>
                        <span class="progress-stage-label">Upload</span>
                    </div>
                    <div class="progress-stage" data-stage="parse">
                        <div class="progress-stage-icon">
                            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                <polyline points="14 2 14 8 20 8"/>
                                <line x1="16" y1="13" x2="8" y2="13"/>
                                <line x1="16" y1="17" x2="8" y2="17"/>
                            </svg>
                        </div>
                        <span class="progress-stage-label">Parse</span>
                    </div>
                    <div class="progress-stage" data-stage="analyze">
                        <div class="progress-stage-icon">
                            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="18" y1="20" x2="18" y2="10"/>
                                <line x1="12" y1="20" x2="12" y2="4"/>
                                <line x1="6" y1="20" x2="6" y2="14"/>
                            </svg>
                        </div>
                        <span class="progress-stage-label">Analyze</span>
                    </div>
                    <div class="progress-stage" data-stage="render">
                        <div class="progress-stage-icon">
                            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                <line x1="3" y1="9" x2="21" y2="9"/>
                                <line x1="9" y1="21" x2="9" y2="9"/>
                            </svg>
                        </div>
                        <span class="progress-stage-label">Build</span>
                    </div>
                </div>

                <!-- Progress Bar -->
                <div class="progress-bar-container">
                    <div class="progress-bar-fill" id="progressBarFill" style="width: 0%"></div>
                </div>

                <!-- Stats Row -->
                <div class="progress-stats">
                    <span class="progress-percentage" id="progressPercentage">0%</span>
                    <span class="progress-time" id="progressTime">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <polyline points="12 6 12 12 16 14"/>
                        </svg>
                        <span id="progressElapsed">0s</span>
                    </span>
                </div>

                <!-- Status Text -->
                <p class="progress-text" id="progressText">Analyzing your portfolio...</p>

                <!-- File Info -->
                <div class="progress-file-info" id="progressFileInfo" style="display: none;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                        <polyline points="14 2 14 8 20 8"/>
                    </svg>
                    <span id="progressFileName">--</span>
                </div>

                <!-- Tip -->
                <div class="progress-tip" id="progressTip">
                    <strong>Tip:</strong> Larger files with more positions take longer to process. Complex statements may require additional parsing time.
                </div>
            </div>
        </div>

        <!-- Market Indicators Widget -->
        <div class="market-indicators" id="marketIndicators">
            <div class="market-indicator">
                <span class="market-indicator-name">S&P 500</span>
                <span class="market-indicator-value" id="spyValue">--</span>
                <span class="market-indicator-change up" id="spyChange">--</span>
            </div>
            <div class="market-indicator">
                <span class="market-indicator-name">NASDAQ</span>
                <span class="market-indicator-value" id="qqqValue">--</span>
                <span class="market-indicator-change up" id="qqqChange">--</span>
            </div>
            <div class="market-indicator">
                <span class="market-indicator-name">DOW</span>
                <span class="market-indicator-value" id="diaValue">--</span>
                <span class="market-indicator-change up" id="diaChange">--</span>
            </div>
            <div class="market-indicator">
                <span class="market-indicator-name">VIX</span>
                <span class="market-indicator-value" id="vixValue">--</span>
                <span class="market-indicator-change" id="vixChange">--</span>
            </div>
            <div class="market-indicator">
                <span class="market-indicator-name">10Y Treasury</span>
                <span class="market-indicator-value" id="tltValue">--</span>
                <span class="market-indicator-change" id="tltChange">--</span>
            </div>
            <div class="market-indicator">
                <span class="market-indicator-name">Gold</span>
                <span class="market-indicator-value" id="gldValue">--</span>
                <span class="market-indicator-change up" id="gldChange">--</span>
            </div>
            <div class="market-indicator">
                <span class="market-indicator-name">Bitcoin</span>
                <span class="market-indicator-value" id="btcValue">--</span>
                <span class="market-indicator-change up" id="btcChange">--</span>
            </div>
        </div>

        <!-- Dashboard (moved to app.html - placeholder for landing redirect) -->
        <div class="dashboard" id="dashboard" style="display: none !important;">
            <div class="dashboard-redirect" style="text-align: center; padding: 48px;">
                <p>Loading dashboard...</p>
                <script>
                    // Redirect to app.html when dashboard is accessed on landing
                    if (window.location.hash === '#dashboard' || document.getElementById('dashboard').style.display === 'block') {
                        window.location.href = '/app';
                    }
                </script>
            </div>
            <!-- Original dashboard content hidden - moved to app.html -->
            <div style="display: none;">
            <div class="dashboard-header">
                <div class="dashboard-title">
                    <div class="dashboard-logo">
                        <svg viewBox="0 0 44 44" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <rect x="0" y="0" width="24" height="24" rx="4" fill="white"/>
                            <rect x="20" y="20" width="24" height="24" rx="4" fill="white"/>
                            <rect x="0" y="19" width="44" height="6" fill="white" opacity="0.4"/>
                            <rect x="16" y="16" width="12" height="12" rx="2" fill="white"/>
                        </svg>
                    </div>
                    <h2>Portfolio Analysis</h2>
                    <span class="total-badge" id="totalBadge">$0</span>
                </div>
                <div class="header-actions">
                    <button class="btn btn-secondary" id="newAnalysisBtn" aria-label="Start new analysis" title="New Analysis (Ctrl+N)">
                        New Analysis
                        <span class="kbd" style="margin-left: 8px;">Ctrl+N</span>
                    </button>
                    <button class="btn btn-success" id="savePortfolioBtn" style="display: none;" aria-label="Save portfolio">Save Portfolio</button>
                    <button class="btn btn-secondary" id="sharePortfolioBtn" onclick="showShareModal()">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/>
                            <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/>
                            <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
                        </svg>
                        Share
                    </button>
                    <button class="btn btn-secondary" id="exportMenuBtn" onclick="showExportModal()">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="7 10 12 15 17 10"/>
                            <line x1="12" y1="15" x2="12" y2="3"/>
                        </svg>
                        Export
                    </button>
                    <button class="btn btn-primary" id="generateReportBtn" onclick="generateProfessionalReport()">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            <polyline points="14 2 14 8 20 8"/>
                            <line x1="16" y1="13" x2="8" y2="13"/>
                            <line x1="16" y1="17" x2="8" y2="17"/>
                            <polyline points="10 9 9 9 8 9"/>
                        </svg>
                        Generate Report
                    </button>
                </div>
            </div>

            <div class="tabs">
                <button class="tab active" data-tab="allocation">Allocation</button>
                <button class="tab" data-tab="insights">Insights</button>
                <button class="tab" data-tab="performance">Performance</button>
                <button class="tab" data-tab="sectors">Sectors</button>
                <button class="tab" data-tab="risk">Risk</button>
                <button class="tab" data-tab="holdings">Holdings</button>
                <button class="tab" data-tab="dividends">Dividends</button>
                <button class="tab" data-tab="geography">Geography</button>
                <div class="tabs-more">
                    <button class="tabs-more-btn" onclick="toggleTabsDropdown()">
                        More
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="6 9 12 15 18 9"/>
                        </svg>
                    </button>
                    <div class="tabs-dropdown" id="tabsDropdown">
                        <button class="tab" data-tab="tax">Tax Lots</button>
                        <button class="tab" data-tab="alerts">Alerts</button>
                        <button class="tab" data-tab="whatif">What-If</button>
                        <button class="tab" data-tab="compare">Compare</button>
                        <button class="tab" data-tab="watchlist">Watchlist</button>
                        <button class="tab" data-tab="goals">Goals</button>
                        <button class="tab" data-tab="news">News</button>
                        <button class="tab" data-tab="earnings">Earnings</button>
                        <button class="tab" data-tab="tools">Tools</button>
                    </div>
                </div>
            </div>

            <!-- Allocation Tab -->
            <div class="tab-content active" id="tab-allocation">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Stocks</div>
                        <div class="stat-value" id="stocksPct">0%</div>
                        <div class="stat-subtitle" id="stocksVal">$0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Bonds</div>
                        <div class="stat-value" id="bondsPct">0%</div>
                        <div class="stat-subtitle" id="bondsVal">$0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Cash</div>
                        <div class="stat-value" id="cashPct">0%</div>
                        <div class="stat-subtitle" id="cashVal">$0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Alternatives</div>
                        <div class="stat-value" id="altsPct">0%</div>
                        <div class="stat-subtitle" id="altsVal">$0</div>
                    </div>
                </div>
                <div class="charts-row">
                    <div class="card chart-card">
                        <div class="card-title">Asset Allocation</div>
                        <div class="chart-wrapper">
                            <canvas id="allocationChart"></canvas>
                        </div>
                    </div>
                    <div class="card chart-card">
                        <div class="card-title">Sub-Asset Breakdown</div>
                        <div class="chart-wrapper">
                            <canvas id="subClassChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Portfolio Heat Map -->
                <div class="heat-map-container" style="margin-top: 24px;">
                    <div class="heat-map-header">
                        <h3 style="font-size: 1.125rem;">Performance Heat Map</h3>
                        <div class="heat-map-period-selector" id="heatMapPeriodSelector">
                            <button class="period-tab active" data-period="1D">1D</button>
                            <button class="period-tab" data-period="1W">1W</button>
                            <button class="period-tab" data-period="1M">1M</button>
                            <button class="period-tab" data-period="YTD">YTD</button>
                        </div>
                    </div>
                    <div class="heat-map-grid" id="heatMapGrid">
                        <!-- Populated dynamically -->
                    </div>
                    <div class="heat-map-legend">
                        <div class="heat-map-legend-item">
                            <div class="heat-map-legend-color" style="background: #1B5E20;"></div>
                            <span>&gt;3%</span>
                        </div>
                        <div class="heat-map-legend-item">
                            <div class="heat-map-legend-color" style="background: #4CAF50;"></div>
                            <span>0-3%</span>
                        </div>
                        <div class="heat-map-legend-item">
                            <div class="heat-map-legend-color" style="background: #9E9E9E;"></div>
                            <span>0%</span>
                        </div>
                        <div class="heat-map-legend-item">
                            <div class="heat-map-legend-color" style="background: #E57373;"></div>
                            <span>0-3%</span>
                        </div>
                        <div class="heat-map-legend-item">
                            <div class="heat-map-legend-color" style="background: #B71C1C;"></div>
                            <span>&lt;-3%</span>
                        </div>
                    </div>
                </div>

                <!-- Allocation Suggestions -->
                <div class="suggestions-container">
                    <h3 style="margin-bottom: 20px; font-size: 1.125rem;">AI Suggestions</h3>
                    <div id="allocationSuggestions">
                        <!-- Populated dynamically -->
                    </div>
                </div>

                <!-- Currency Exposure -->
                <div class="currency-exposure-container" style="margin-top: 24px;">
                    <h3 style="margin-bottom: 20px; font-size: 1.125rem;">Currency Exposure</h3>
                    <div class="currency-chart-container">
                        <div class="currency-donut">
                            <canvas id="currencyChart"></canvas>
                        </div>
                        <div class="currency-list" id="currencyList">
                            <!-- Populated dynamically -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Insights Tab -->
            <div class="tab-content" id="tab-insights">
                <div class="insights-container" id="insightsContainer">
                    <div class="insights-header">
                        <h3>Portfolio Insights</h3>
                        <p class="insights-subtitle">AI-powered analysis of your portfolio</p>
                    </div>
                    <div class="insights-list" id="insightsList">
                        <!-- Insights will be rendered here -->
                    </div>
                </div>
            </div>

            <!-- Performance Tab -->
            <div class="tab-content" id="tab-performance">
                <div class="returns-grid" id="returnsGrid"></div>
                <div class="card chart-card">
                    <div class="card-header">
                        <div class="card-title">Historical Performance</div>
                        <div class="period-selector" id="periodSelector">
                            <button class="period-btn" data-period="1M">1M</button>
                            <button class="period-btn" data-period="3M">3M</button>
                            <button class="period-btn" data-period="6M">6M</button>
                            <button class="period-btn" data-period="YTD">YTD</button>
                            <button class="period-btn" data-period="1Y">1Y</button>
                            <button class="period-btn" data-period="3Y">3Y</button>
                            <button class="period-btn active" data-period="5Y">5Y</button>
                        </div>
                    </div>
                    <div style="display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap;">
                        <label class="benchmark-toggle">
                            <input type="checkbox" checked onchange="toggleBenchmark('sp500', this.checked)">
                            <span class="benchmark-label-box" style="background: #8898aa;"></span>
                            S&P 500
                        </label>
                        <label class="benchmark-toggle">
                            <input type="checkbox" onchange="toggleBenchmark('bonds', this.checked)">
                            <span class="benchmark-label-box" style="background: #30d158;"></span>
                            US Bonds
                        </label>
                        <label class="benchmark-toggle">
                            <input type="checkbox" onchange="toggleBenchmark('world', this.checked)">
                            <span class="benchmark-label-box" style="background: #ff9f0a;"></span>
                            Total World
                        </label>
                        <label class="benchmark-toggle">
                            <input type="checkbox" onchange="toggleBenchmark('sixty_forty', this.checked)">
                            <span class="benchmark-label-box" style="background: #bf5af2;"></span>
                            60/40 Portfolio
                        </label>
                    </div>
                    <div class="chart-wrapper" style="height: 380px;">
                        <canvas id="performanceChart"></canvas>
                    </div>
                    <div class="performance-stats">
                        <div class="perf-stat">
                            <div class="perf-stat-value positive" id="perfReturn">+0.00%</div>
                            <div class="perf-stat-label">Period Return</div>
                        </div>
                        <div class="perf-stat">
                            <div class="perf-stat-value" id="perfVsBenchmark">+0.00%</div>
                            <div class="perf-stat-label">vs S&P 500</div>
                        </div>
                        <div class="perf-stat">
                            <div class="perf-stat-value" id="perfHigh">$0</div>
                            <div class="perf-stat-label">Period High</div>
                        </div>
                        <div class="perf-stat">
                            <div class="perf-stat-value" id="perfLow">$0</div>
                            <div class="perf-stat-label">Period Low</div>
                        </div>
                    </div>
                </div>

                <!-- Projections Section -->
                <div class="card chart-card" style="margin-top: 24px;">
                    <div class="card-header">
                        <div class="card-title">10-Year Projections (Monte Carlo Simulation)</div>
                    </div>
                    <div id="projectionsInfo" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-bottom: 20px;"></div>
                    <div class="chart-wrapper" style="height: 350px;">
                        <canvas id="projectionsChart"></canvas>
                    </div>
                    <div id="monteCarloSummary" style="margin-top: 20px;"></div>
                </div>
            </div>

            <!-- Dividends Tab -->
            <div class="tab-content" id="tab-dividends">
                <div class="stats-grid" style="margin-bottom: 24px;">
                    <div class="stat-card dividend-card">
                        <div class="stat-label">Annual Dividend Income</div>
                        <div class="stat-value" id="annualDividend">$0</div>
                        <div class="stat-subtitle" id="dividendYield">0% yield</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Monthly Average</div>
                        <div class="stat-value" id="monthlyDividend">$0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Next Payment</div>
                        <div class="stat-value" id="nextDividend">--</div>
                        <div class="stat-subtitle" id="nextDividendDate">No upcoming</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Dividend Growth</div>
                        <div class="stat-value positive" id="dividendGrowth">--</div>
                        <div class="stat-subtitle">5-year CAGR</div>
                    </div>
                </div>

                <div class="card" style="margin-bottom: 24px;">
                    <div class="card-header">
                        <div class="card-title">Monthly Dividend Calendar</div>
                    </div>
                    <div class="dividend-calendar" id="dividendCalendar">
                        <!-- Populated dynamically -->
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Dividend-Paying Holdings</div>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Symbol</th>
                                    <th>Name</th>
                                    <th class="text-right">Yield</th>
                                    <th class="text-right">Annual Div/Share</th>
                                    <th class="text-right">Your Annual Income</th>
                                    <th>Frequency</th>
                                </tr>
                            </thead>
                            <tbody id="dividendHoldings">
                                <!-- Populated dynamically -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Income Projection Calculator -->
                <div class="income-projection" style="margin-top: 24px;">
                    <div class="income-projection-header">
                        <h3 style="font-size: 1.125rem;">Income Projection Calculator</h3>
                    </div>
                    <div class="contribution-inputs">
                        <div class="contribution-input-group">
                            <label>Annual Dividend</label>
                            <input type="number" id="incomeCurrentDiv" placeholder="From portfolio" readonly>
                        </div>
                        <div class="contribution-input-group">
                            <label>Growth Rate (%)</label>
                            <input type="number" id="incomeGrowthRate" value="5" min="0" max="20" step="0.5">
                        </div>
                        <div class="contribution-input-group">
                            <label>Reinvest Dividends</label>
                            <select id="incomeReinvest">
                                <option value="yes">Yes (DRIP)</option>
                                <option value="no">No</option>
                            </select>
                        </div>
                        <div class="contribution-input-group">
                            <label>Years</label>
                            <input type="number" id="incomeYears" value="10" min="1" max="30">
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="calculateIncomeProjection()">Calculate Projection</button>
                    <div class="income-summary-grid" id="incomeSummary" style="display: none; margin-top: 20px;">
                        <div class="income-summary-item">
                            <div class="income-summary-value" id="incomeYear1">$0</div>
                            <div class="income-summary-label">Year 1 Income</div>
                        </div>
                        <div class="income-summary-item">
                            <div class="income-summary-value" id="incomeYear5">$0</div>
                            <div class="income-summary-label">Year 5 Income</div>
                        </div>
                        <div class="income-summary-item">
                            <div class="income-summary-value" id="incomeYear10">$0</div>
                            <div class="income-summary-label">Year 10 Income</div>
                        </div>
                        <div class="income-summary-item">
                            <div class="income-summary-value" id="incomeTotalReceived">$0</div>
                            <div class="income-summary-label">Total Received</div>
                        </div>
                    </div>
                </div>

                <div class="card chart-card" style="margin-top: 24px;">
                    <div class="card-title">10-Year Dividend Projection</div>
                    <div class="chart-wrapper">
                        <canvas id="dividendProjectionChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Sectors Tab -->
            <div class="tab-content" id="tab-sectors">
                <div class="card" style="margin-bottom: 24px;">
                    <div class="card-header">
                        <div class="card-title">Sector Exposure vs S&P 500 Benchmark</div>
                        <div style="display: flex; gap: 16px; font-size: 0.8125rem;">
                            <span><span style="display: inline-block; width: 12px; height: 12px; background: var(--primary); border-radius: 2px; margin-right: 6px;"></span>Portfolio</span>
                            <span><span style="display: inline-block; width: 12px; height: 12px; background: var(--bg-tertiary); border-radius: 2px; margin-right: 6px;"></span>S&P 500</span>
                        </div>
                    </div>
                    <div class="sector-list" id="sectorList"></div>
                </div>
                <div class="card chart-card">
                    <div class="card-title">Sector Distribution</div>
                    <div class="chart-wrapper">
                        <canvas id="sectorChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Geography Tab -->
            <div class="tab-content" id="tab-geography">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">United States</div>
                        <div class="stat-value" id="usPct">0%</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Developed Markets</div>
                        <div class="stat-value" id="devPct">0%</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Emerging Markets</div>
                        <div class="stat-value" id="emPct">0%</div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-title">Geographic Allocation</div>
                    <div class="map-container">
                        <div id="worldMapContainer"></div>
                        <div class="map-legend">
                            <div class="legend-item"><div class="legend-dot us"></div><span>United States <strong id="usMapPct">0%</strong></span></div>
                            <div class="legend-item"><div class="legend-dot developed"></div><span>Developed <strong id="devMapPct">0%</strong></span></div>
                            <div class="legend-item"><div class="legend-dot emerging"></div><span>Emerging <strong id="emMapPct">0%</strong></span></div>
                        </div>
                    </div>
                </div>
                <div class="card chart-card" style="margin-top: 24px;">
                    <div class="card-title">Regional Breakdown</div>
                    <div class="chart-wrapper">
                        <canvas id="geoChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Risk Tab -->
            <div class="tab-content" id="tab-risk">
                <!-- Risk Gauge -->
                <div class="risk-gauge-container">
                    <div class="risk-gauge-wrapper">
                        <div class="risk-gauge-arc"></div>
                        <div class="risk-gauge-inner"></div>
                        <div class="risk-gauge-needle" id="riskGaugeNeedle"></div>
                        <div class="risk-gauge-center"></div>
                    </div>
                    <div class="risk-gauge-labels">
                        <span>Low</span>
                        <span>Moderate</span>
                        <span>High</span>
                    </div>
                    <div class="risk-gauge-score" id="riskScoreValue">--</div>
                    <div class="risk-gauge-label" id="riskScoreLabel">Overall Risk Score</div>
                </div>

                <!-- Factor Exposure -->
                <div class="factor-exposure-container">
                    <h3 style="margin-bottom: 20px; font-size: 1.125rem;">Factor Exposure</h3>
                    <div class="factor-grid" id="factorGrid">
                        <div class="factor-item">
                            <div class="factor-header">
                                <span class="factor-name">Value</span>
                                <span class="factor-value" id="factorValue">0%</span>
                            </div>
                            <div class="factor-bar"><div class="factor-bar-fill value" id="factorValueBar" style="width: 0%"></div></div>
                            <div class="factor-description">Exposure to undervalued stocks</div>
                        </div>
                        <div class="factor-item">
                            <div class="factor-header">
                                <span class="factor-name">Growth</span>
                                <span class="factor-value" id="factorGrowth">0%</span>
                            </div>
                            <div class="factor-bar"><div class="factor-bar-fill growth" id="factorGrowthBar" style="width: 0%"></div></div>
                            <div class="factor-description">Exposure to high-growth stocks</div>
                        </div>
                        <div class="factor-item">
                            <div class="factor-header">
                                <span class="factor-name">Momentum</span>
                                <span class="factor-value" id="factorMomentum">0%</span>
                            </div>
                            <div class="factor-bar"><div class="factor-bar-fill momentum" id="factorMomentumBar" style="width: 0%"></div></div>
                            <div class="factor-description">Exposure to trending stocks</div>
                        </div>
                        <div class="factor-item">
                            <div class="factor-header">
                                <span class="factor-name">Quality</span>
                                <span class="factor-value" id="factorQuality">0%</span>
                            </div>
                            <div class="factor-bar"><div class="factor-bar-fill quality" id="factorQualityBar" style="width: 0%"></div></div>
                            <div class="factor-description">Exposure to profitable companies</div>
                        </div>
                        <div class="factor-item">
                            <div class="factor-header">
                                <span class="factor-name">Size</span>
                                <span class="factor-value" id="factorSize">0%</span>
                            </div>
                            <div class="factor-bar"><div class="factor-bar-fill size" id="factorSizeBar" style="width: 0%"></div></div>
                            <div class="factor-description">Exposure to small-cap stocks</div>
                        </div>
                        <div class="factor-item">
                            <div class="factor-header">
                                <span class="factor-name">Volatility</span>
                                <span class="factor-value" id="factorVol">0%</span>
                            </div>
                            <div class="factor-bar"><div class="factor-bar-fill volatility" id="factorVolBar" style="width: 0%"></div></div>
                            <div class="factor-description">Exposure to high-volatility stocks</div>
                        </div>
                    </div>
                </div>

                <div class="risk-grid">
                    <div class="card risk-card">
                        <div class="risk-value" id="volatilityVal">--</div>
                        <div class="risk-label">Volatility</div>
                        <div class="risk-desc">Annualized standard deviation</div>
                    </div>
                    <div class="card risk-card">
                        <div class="risk-value" id="betaVal">--</div>
                        <div class="risk-label">Beta</div>
                        <div class="risk-desc">Sensitivity to market</div>
                    </div>
                    <div class="card risk-card">
                        <div class="risk-value" id="sharpeVal">--</div>
                        <div class="risk-label">Sharpe Ratio</div>
                        <div class="risk-desc">Risk-adjusted return</div>
                    </div>
                    <div class="card risk-card">
                        <div class="risk-value negative" id="maxDdVal">--</div>
                        <div class="risk-label">Max Drawdown</div>
                        <div class="risk-desc">Largest peak-to-trough</div>
                    </div>
                </div>

                <div class="card" style="margin-bottom: 24px;">
                    <div class="card-header">
                        <div class="card-title">Concentration Risk</div>
                    </div>
                    <div class="stats-grid" style="margin-bottom: 20px;">
                        <div class="stat-card">
                            <div class="stat-label">Top 10 Holdings</div>
                            <div class="stat-value" id="top10Pct">0%</div>
                            <div class="stat-subtitle">of total portfolio</div>
                        </div>
                    </div>
                    <div class="holdings-list" id="topHoldingsList"></div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Scenario Analysis</div>
                    </div>
                    <p style="color: var(--text-muted); font-size: 0.875rem; margin-bottom: 20px;">
                        Estimated portfolio impact under various market conditions
                    </p>
                    <div class="scenarios-container" id="scenariosList"></div>
                </div>
            </div>

            <!-- Tax Lots Tab -->
            <div class="tab-content" id="tab-tax">
                <div class="tax-summary">
                    <div class="tax-summary-card">
                        <div class="tax-summary-label">Total Cost Basis</div>
                        <div class="tax-summary-value" id="totalCostBasis">$0</div>
                    </div>
                    <div class="tax-summary-card">
                        <div class="tax-summary-label">Unrealized Gains</div>
                        <div class="tax-summary-value tax-lot-gain" id="unrealizedGains">$0</div>
                    </div>
                    <div class="tax-summary-card">
                        <div class="tax-summary-label">Unrealized Losses</div>
                        <div class="tax-summary-value tax-lot-loss" id="unrealizedLosses">$0</div>
                    </div>
                    <div class="tax-summary-card">
                        <div class="tax-summary-label">Net Unrealized</div>
                        <div class="tax-summary-value" id="netUnrealized">$0</div>
                    </div>
                </div>

                <div class="card" style="margin-bottom: 24px;">
                    <div class="card-header">
                        <div class="card-title">Tax Loss Harvesting Opportunities</div>
                    </div>
                    <p style="color: var(--text-muted); font-size: 0.875rem; margin-bottom: 16px;">
                        Positions with unrealized losses that could offset gains
                    </p>
                    <div id="taxLossOpportunities">
                        <!-- Populated dynamically -->
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">All Tax Lots</div>
                    </div>
                    <div class="table-container">
                        <table class="tax-lot-table">
                            <thead>
                                <tr>
                                    <th>Symbol</th>
                                    <th>Acquired</th>
                                    <th>Term</th>
                                    <th class="text-right">Shares</th>
                                    <th class="text-right">Cost Basis</th>
                                    <th class="text-right">Current Value</th>
                                    <th class="text-right">Gain/Loss</th>
                                    <th class="text-right">%</th>
                                </tr>
                            </thead>
                            <tbody id="taxLotsBody">
                                <!-- Populated dynamically -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Alerts Tab -->
            <div class="tab-content" id="tab-alerts">
                <div class="card" style="margin-bottom: 24px;">
                    <div class="card-header">
                        <div class="card-title">Active Alerts</div>
                        <button class="btn btn-primary" onclick="showAddAlertModal()">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <line x1="12" y1="8" x2="12" y2="16"/>
                                <line x1="8" y1="12" x2="16" y2="12"/>
                            </svg>
                            Add Alert
                        </button>
                    </div>
                    <div class="alerts-list" id="alertsList">
                        <div class="empty-state-enhanced" id="alertsEmptyState">
                            <div class="empty-state-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                                    <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
                                </svg>
                            </div>
                            <div class="empty-state-title">No alerts set</div>
                            <div class="empty-state-desc">Create price alerts to get notified when your holdings reach target prices.</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Suggested Alerts</div>
                    </div>
                    <p style="color: var(--text-muted); font-size: 0.875rem; margin-bottom: 16px;">
                        Based on your portfolio, consider setting these alerts
                    </p>
                    <div class="alerts-list" id="suggestedAlerts">
                        <!-- Populated dynamically -->
                    </div>
                </div>

                <div class="card" style="margin-top: 24px;">
                    <div class="card-header">
                        <div class="card-title">Portfolio Snapshots</div>
                        <button class="btn btn-secondary" onclick="saveSnapshot()">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
                                <circle cx="12" cy="13" r="4"/>
                            </svg>
                            Save Snapshot
                        </button>
                    </div>
                    <p style="color: var(--text-muted); font-size: 0.875rem; margin-bottom: 16px;">
                        Track your portfolio value over time
                    </p>
                    <div class="snapshot-timeline" id="snapshotTimeline">
                        <div class="empty-state" style="padding: 24px;">
                            <p>No snapshots yet. Save your first snapshot to start tracking.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Holdings Tab -->
            <div class="tab-content" id="tab-holdings">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Symbol</th>
                                <th>Description</th>
                                <th>Asset Class</th>
                                <th>Sector</th>
                                <th class="text-right">Shares</th>
                                <th class="text-right">Price</th>
                                <th class="text-right">Value</th>
                                <th class="text-right">Weight</th>
                            </tr>
                        </thead>
                        <tbody id="holdingsBody"></tbody>
                    </table>
                </div>

                <!-- Valuation Metrics -->
                <div style="margin-top: 24px; background: var(--bg-primary); border-radius: var(--radius-lg); padding: 24px;">
                    <h3 style="margin-bottom: 20px; font-size: 1.125rem;">Valuation Metrics</h3>
                    <div class="valuation-grid" id="valuationGrid">
                        <!-- Populated dynamically -->
                    </div>
                </div>
            </div>

            <!-- What-If Tab -->
            <div class="tab-content" id="tab-whatif">
                <div class="whatif-container">
                    <div class="whatif-editor">
                        <div class="whatif-section-title">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                            </svg>
                            Edit Positions
                        </div>

                        <div class="whatif-position-list" id="whatifPositionList">
                            <!-- Populated dynamically -->
                        </div>

                        <div class="whatif-section-title" style="margin-top: 24px;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <line x1="12" y1="8" x2="12" y2="16"/>
                                <line x1="8" y1="12" x2="16" y2="12"/>
                            </svg>
                            Add Position
                        </div>

                        <div class="whatif-add-form">
                            <input type="text" id="whatifAddSymbol" placeholder="Symbol" style="text-transform: uppercase;">
                            <input type="number" id="whatifAddShares" placeholder="Shares" min="0" step="0.0001">
                            <input type="number" id="whatifAddPrice" placeholder="Price" min="0" step="0.01">
                            <button class="btn btn-primary" onclick="addWhatIfPosition()">Add</button>
                        </div>

                        <div class="whatif-section-title" style="margin-top: 24px;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0z"/>
                                <path d="M9 12h6"/>
                            </svg>
                            Rebalance to Target
                        </div>

                        <div class="rebalance-targets">
                            <div class="rebalance-target">
                                <label>Stocks %</label>
                                <input type="number" id="rebalanceStocks" placeholder="60" min="0" max="100">
                            </div>
                            <div class="rebalance-target">
                                <label>Bonds %</label>
                                <input type="number" id="rebalanceBonds" placeholder="30" min="0" max="100">
                            </div>
                            <div class="rebalance-target">
                                <label>Cash %</label>
                                <input type="number" id="rebalanceCash" placeholder="10" min="0" max="100">
                            </div>
                        </div>
                        <button class="btn btn-secondary" onclick="applyRebalance()">Apply Rebalance</button>
                    </div>

                    <div class="whatif-preview">
                        <div class="whatif-preview-header">
                            <div class="whatif-preview-title">Preview</div>
                            <div class="whatif-preview-value" id="whatifPreviewValue">$0</div>
                        </div>

                        <div class="whatif-impact-grid" id="whatifImpactGrid">
                            <div class="whatif-impact-card">
                                <div class="whatif-impact-value" id="whatifValueChange">--</div>
                                <div class="whatif-impact-label">Value Change</div>
                            </div>
                            <div class="whatif-impact-card">
                                <div class="whatif-impact-value" id="whatifCost">--</div>
                                <div class="whatif-impact-label">Est. Trade Cost</div>
                            </div>
                            <div class="whatif-impact-card">
                                <div class="whatif-impact-value" id="whatifVolChange">--</div>
                                <div class="whatif-impact-label">Volatility Change</div>
                            </div>
                            <div class="whatif-impact-card">
                                <div class="whatif-impact-value" id="whatifBetaChange">--</div>
                                <div class="whatif-impact-label">Beta Change</div>
                            </div>
                        </div>

                        <div class="whatif-chart-wrapper">
                            <canvas id="whatifChart"></canvas>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 16px;">
                            <div>
                                <div class="stat-label">Original Allocation</div>
                                <div id="whatifOriginalAlloc" style="font-size: 0.875rem; color: var(--text-secondary);"></div>
                            </div>
                            <div>
                                <div class="stat-label">Modified Allocation</div>
                                <div id="whatifModifiedAlloc" style="font-size: 0.875rem; color: var(--text-secondary);"></div>
                            </div>
                        </div>

                        <div class="whatif-actions">
                            <button class="btn btn-secondary" onclick="resetWhatIf()">Reset Changes</button>
                            <button class="btn btn-primary" onclick="runWhatIfAnalysis()">Run Analysis</button>
                            <button class="btn btn-success" onclick="saveWhatIfAsNew()" style="display: none;" id="saveWhatIfBtn">Save as New</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Compare Tab -->
            <div class="tab-content" id="tab-compare">
                <div class="compare-selectors">
                    <div class="compare-select-group">
                        <label class="compare-select-label">Portfolio A</label>
                        <select class="compare-select" id="compareSelectA">
                            <option value="current">Current Analysis</option>
                        </select>
                    </div>
                    <div class="compare-vs">VS</div>
                    <div class="compare-select-group">
                        <label class="compare-select-label">Portfolio B</label>
                        <select class="compare-select" id="compareSelectB">
                            <option value="">Select a portfolio...</option>
                        </select>
                    </div>
                </div>

                <button class="btn btn-primary compare-btn" onclick="runComparison()" id="runCompareBtn">
                    Compare Portfolios
                </button>

                <div id="comparisonResults" style="display: none;">
                    <div class="compare-container" style="margin-top: 32px;">
                        <div class="compare-column">
                            <div class="compare-column-header">
                                <div class="compare-column-title" id="compareNameA">Portfolio A</div>
                                <div class="compare-column-value" id="compareValueA">$0</div>
                            </div>
                            <div class="compare-chart-wrapper">
                                <canvas id="compareChartA"></canvas>
                            </div>
                            <div class="compare-stats" id="compareStatsA"></div>
                        </div>

                        <div class="compare-column">
                            <div class="compare-column-header">
                                <div class="compare-column-title" id="compareNameB">Portfolio B</div>
                                <div class="compare-column-value" id="compareValueB">$0</div>
                            </div>
                            <div class="compare-chart-wrapper">
                                <canvas id="compareChartB"></canvas>
                            </div>
                            <div class="compare-stats" id="compareStatsB"></div>
                        </div>
                    </div>

                    <div class="diff-summary">
                        <div class="diff-summary-title">Difference Summary (B - A)</div>
                        <div class="diff-grid" id="diffGrid"></div>
                    </div>
                </div>

                <div id="compareEmptyState" class="empty-state">
                    <svg class="empty-state-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <rect x="2" y="3" width="8" height="18" rx="1"/>
                        <rect x="14" y="3" width="8" height="18" rx="1"/>
                        <path d="M10 12h4"/>
                    </svg>
                    <p>Select two portfolios to compare</p>
                    <p style="font-size: 0.8125rem;">Save portfolios to unlock comparison features</p>
                </div>
            </div>

            <!-- Watchlist Tab -->
            <div class="tab-content" id="tab-watchlist">
                <div class="watchlist-container">
                    <div class="watchlist-header">
                        <h3 class="watchlist-title">Watchlist</h3>
                        <div class="watchlist-add">
                            <input type="text" class="watchlist-input" id="watchlistSymbol" placeholder="AAPL" maxlength="5">
                            <button class="btn btn-primary btn-sm" onclick="addToWatchlist()">Add</button>
                        </div>
                    </div>
                    <table class="watchlist-table" id="watchlistTable">
                        <thead>
                            <tr>
                                <th>Symbol</th>
                                <th>Price</th>
                                <th>Change</th>
                                <th>% Change</th>
                                <th>7D Trend</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="watchlistBody">
                        </tbody>
                    </table>
                    <div class="empty-state" id="watchlistEmptyState">
                        <svg class="empty-state-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M12 5v14M5 12h14"/>
                        </svg>
                        <p>Your watchlist is empty</p>
                        <p style="font-size: 0.8125rem;">Add stocks to track their performance</p>
                    </div>
                </div>
            </div>

            <!-- Goals Tab -->
            <div class="tab-content" id="tab-goals">
                <div class="goals-container">
                    <div class="goals-header">
                        <h3 class="goals-title">Investment Goals</h3>
                        <button class="btn btn-primary btn-sm" onclick="showAddGoalModal()">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 5v14M5 12h14"/>
                            </svg>
                            Add Goal
                        </button>
                    </div>
                    <div class="goals-list" id="goalsList">
                    </div>
                    <div class="empty-state" id="goalsEmptyState">
                        <svg class="empty-state-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <circle cx="12" cy="12" r="10"/>
                            <circle cx="12" cy="12" r="6"/>
                            <circle cx="12" cy="12" r="2"/>
                        </svg>
                        <p>No goals set</p>
                        <p style="font-size: 0.8125rem;">Set investment goals to track your progress</p>
                    </div>
                </div>
            </div>

            <!-- News Tab -->
            <div class="tab-content" id="tab-news">
                <div class="news-feed">
                    <div class="news-header">
                        <h3 class="news-title">Market News</h3>
                        <div class="news-filter">
                            <button class="news-filter-btn active" data-filter="all">All</button>
                            <button class="news-filter-btn" data-filter="portfolio">My Holdings</button>
                            <button class="news-filter-btn" data-filter="earnings">Earnings</button>
                            <button class="news-filter-btn" data-filter="analysis">Analysis</button>
                        </div>
                    </div>
                    <div class="news-list" id="newsList">
                        <div class="news-item" onclick="openNewsArticle('https://example.com')">
                            <div class="news-thumbnail"></div>
                            <div class="news-content">
                                <div class="news-item-title">Loading latest market news...</div>
                                <div class="news-meta">
                                    <span class="news-source">Market Watch</span>
                                    <span>Just now</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Earnings Tab -->
            <div class="tab-content" id="tab-earnings">
                <div class="earnings-calendar">
                    <div class="news-header">
                        <h3 class="news-title">Upcoming Earnings</h3>
                        <div class="news-filter">
                            <button class="news-filter-btn active" data-filter="upcoming">Upcoming</button>
                            <button class="news-filter-btn" data-filter="thisweek">This Week</button>
                            <button class="news-filter-btn" data-filter="portfolio">My Holdings</button>
                        </div>
                    </div>
                    <div class="earnings-list" id="earningsList">
                    </div>
                    <div class="empty-state" id="earningsEmptyState">
                        <svg class="empty-state-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <rect x="3" y="4" width="18" height="18" rx="2"/>
                            <path d="M16 2v4M8 2v4M3 10h18"/>
                        </svg>
                        <p>No upcoming earnings</p>
                        <p style="font-size: 0.8125rem;">Add holdings to see their earnings dates</p>
                    </div>
                </div>
            </div>

            <!-- Tools Tab -->
            <div class="tab-content" id="tab-tools">
                <!-- Contribution Calculator -->
                <div class="contribution-calculator" style="margin-bottom: 24px;">
                    <h3 style="margin-bottom: 20px; font-size: 1.125rem;">Contribution Calculator</h3>
                    <div class="contribution-inputs">
                        <div class="contribution-input-group">
                            <label>Starting Amount</label>
                            <input type="number" id="contribStarting" value="10000" min="0">
                        </div>
                        <div class="contribution-input-group">
                            <label>Monthly Contribution</label>
                            <input type="number" id="contribMonthly" value="500" min="0">
                        </div>
                        <div class="contribution-input-group">
                            <label>Expected Return (%)</label>
                            <input type="number" id="contribReturn" value="7" min="0" max="30" step="0.5">
                        </div>
                        <div class="contribution-input-group">
                            <label>Time Horizon (Years)</label>
                            <input type="number" id="contribYears" value="20" min="1" max="50">
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="calculateContributions()">Calculate Growth</button>
                    <div class="contribution-results" id="contribResults" style="display: none;">
                        <div class="contribution-result">
                            <div class="contribution-result-value" id="contribFinalValue">$0</div>
                            <div class="contribution-result-label">Final Portfolio Value</div>
                        </div>
                        <div class="contribution-result">
                            <div class="contribution-result-value" id="contribTotalContrib">$0</div>
                            <div class="contribution-result-label">Total Contributions</div>
                        </div>
                        <div class="contribution-result">
                            <div class="contribution-result-value" id="contribTotalGrowth">$0</div>
                            <div class="contribution-result-label">Investment Growth</div>
                        </div>
                    </div>
                    <div class="contribution-breakdown" id="contribBreakdown" style="display: none;">
                        <div class="contribution-breakdown-title">Value Breakdown</div>
                        <div class="contribution-bar" id="contribBar"></div>
                        <div style="display: flex; justify-content: space-between; margin-top: 12px; font-size: 0.8125rem;">
                            <span><span style="color: var(--primary);"></span> Initial: <span id="contribInitialPct">0%</span></span>
                            <span><span style="color: var(--success);"></span> Contributions: <span id="contribContribPct">0%</span></span>
                            <span><span style="color: var(--warning);"></span> Growth: <span id="contribGrowthPct">0%</span></span>
                        </div>
                    </div>
                </div>

                <!-- Rebalancing Calculator -->
                <div class="rebalance-container">
                    <div class="rebalance-header">
                        <h3 style="font-size: 1.125rem;">Portfolio Rebalancer</h3>
                        <div class="rebalance-mode-toggle">
                            <button class="rebalance-mode-btn active" data-mode="percent">By Percentage</button>
                            <button class="rebalance-mode-btn" data-mode="value">By Value</button>
                        </div>
                    </div>
                    <div class="rebalance-grid">
                        <div class="rebalance-current">
                            <div class="rebalance-section-title">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"/>
                                    <path d="M12 6v6l4 2"/>
                                </svg>
                                Current Allocation
                            </div>
                            <table class="rebalance-table" id="rebalanceCurrentTable">
                                <thead>
                                    <tr>
                                        <th>Asset</th>
                                        <th>Value</th>
                                        <th>Weight</th>
                                    </tr>
                                </thead>
                                <tbody id="rebalanceCurrentBody">
                                </tbody>
                            </table>
                        </div>
                        <div class="rebalance-target">
                            <div class="rebalance-section-title">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"/>
                                    <circle cx="12" cy="12" r="6"/>
                                    <circle cx="12" cy="12" r="2"/>
                                </svg>
                                Target Allocation
                            </div>
                            <table class="rebalance-table" id="rebalanceTargetTable">
                                <thead>
                                    <tr>
                                        <th>Asset</th>
                                        <th>Target %</th>
                                        <th>Target Value</th>
                                    </tr>
                                </thead>
                                <tbody id="rebalanceTargetBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="calculateRebalance()" style="margin-top: 20px;">Calculate Trades</button>
                    <div class="rebalance-trades" id="rebalanceTrades" style="display: none;">
                        <div class="rebalance-section-title">Suggested Trades</div>
                        <div id="rebalanceTradesList"></div>
                    </div>
                </div>

                <!-- Correlation Matrix -->
                <div class="correlation-matrix" style="margin-top: 24px;">
                    <h3 style="margin-bottom: 20px; font-size: 1.125rem;">Correlation Matrix</h3>
                    <p style="color: var(--text-muted); font-size: 0.875rem; margin-bottom: 16px;">
                        Shows how your holdings move relative to each other. Lower correlation = better diversification.
                    </p>
                    <div id="correlationMatrixContainer">
                        <table class="correlation-table" id="correlationTable">
                        </table>
                    </div>
                </div>
            </div>
            </div><!-- End hidden dashboard content -->
        </div>

        <!-- Saved Portfolios Section - Hidden on landing (moved to app.html) -->
        <!-- Saved Portfolios Section (visible when logged in) -->
        <div class="saved-portfolios" id="savedPortfoliosSection" style="display: none;">
            <div class="saved-portfolios-header">
                <h3>Saved Portfolios</h3>
                <button class="btn btn-secondary" onclick="loadSavedPortfolios()">Refresh</button>
            </div>
            <div class="portfolio-list" id="portfolioList">
                <!-- Empty state for portfolios -->
                <div class="empty-state-enhanced" id="portfolioEmptyState">
                    <div class="empty-state-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/>
                        </svg>
                    </div>
                    <div class="empty-state-title">No saved portfolios</div>
                    <div class="empty-state-desc">Analyze a portfolio and save it to track your investments over time.</div>
                    <div class="empty-state-actions">
                        <button class="btn btn-primary" onclick="switchEntryMethod('upload')">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                <polyline points="17 8 12 3 7 8"/>
                                <line x1="12" y1="3" x2="12" y2="15"/>
                            </svg>
                            Upload Statement
                        </button>
                    </div>
                </div>
            </div>
        </div>

        </main><!-- End main content -->

        <!-- Wave Divider: Hero area to How It Works (inverted curve) -->
        <div class="section-divider hero-to-dark">
            <svg viewBox="0 0 1440 80" fill="none" preserveAspectRatio="none">
                <path d="M0,80 C360,0 1080,0 1440,80 L1440,80 L0,80 Z" fill="#0A2540"/>
            </svg>
        </div>

        <!-- Landing Page Sections -->
        <div class="landing-sections" id="landingSections">

            <!-- How It Works Section -->
            <section class="landing-section how-it-works" data-animate>
                <div class="container">
                    <div class="section-badge">Simple 3-Step Process</div>
                    <h2 class="section-heading">How It Works</h2>
                    <p class="section-subheading">Get professional portfolio analytics in three simple steps</p>
                    <div class="how-it-works-grid" data-animate-child>
                        <div class="step-card">
                            <div class="step-number">1</div>
                            <div class="step-icon">
                                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                    <polyline points="17 8 12 3 7 8"/>
                                    <line x1="12" y1="3" x2="12" y2="15"/>
                                </svg>
                            </div>
                            <h3 class="step-title">Upload Your Statement</h3>
                            <p class="step-description">Drag and drop your brokerage PDF or CSV. We support Schwab, Fidelity, Vanguard, and 50+ other brokerages.</p>
                        </div>
                        <div class="step-connector">
                            <svg width="40" height="2"><line x1="0" y1="1" x2="40" y2="1" stroke="rgba(99,91,255,0.3)" stroke-width="2" stroke-dasharray="6,4"/></svg>
                        </div>
                        <div class="step-card">
                            <div class="step-number">2</div>
                            <div class="step-icon">
                                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/>
                                </svg>
                            </div>
                            <h3 class="step-title">AI Analyzes Holdings</h3>
                            <p class="step-description">Our engine extracts positions, fetches live prices, and runs sophisticated portfolio analytics in seconds.</p>
                        </div>
                        <div class="step-connector">
                            <svg width="40" height="2"><line x1="0" y1="1" x2="40" y2="1" stroke="rgba(99,91,255,0.3)" stroke-width="2" stroke-dasharray="6,4"/></svg>
                        </div>
                        <div class="step-card">
                            <div class="step-number">3</div>
                            <div class="step-icon">
                                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <path d="M21.21 15.89A10 10 0 1 1 8 2.83"/>
                                    <path d="M22 12A10 10 0 0 0 12 2v10z"/>
                                </svg>
                            </div>
                            <h3 class="step-title">Get Actionable Insights</h3>
                            <p class="step-description">View allocation breakdowns, risk metrics, fee analysis, and personalized recommendations.</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Social Proof Section -->
            <section class="social-proof-section">
                <div class="social-proof-container">
                    <div class="social-proof-stats">
                        <div class="social-proof-stat">
                            <div class="social-proof-number">50<span>+</span></div>
                            <div class="social-proof-label">Brokerages Supported</div>
                        </div>
                        <div class="social-proof-divider"></div>
                        <div class="social-proof-stat">
                            <div class="social-proof-number"><span>$</span>2.8B</div>
                            <div class="social-proof-label">Portfolios Analyzed</div>
                        </div>
                        <div class="social-proof-divider"></div>
                        <div class="social-proof-stat">
                            <div class="social-proof-number">100<span>%</span></div>
                            <div class="social-proof-label">Private & Secure</div>
                        </div>
                        <div class="social-proof-divider"></div>
                        <div class="social-proof-stat">
                            <div class="social-proof-number"><span>&lt;</span>30s</div>
                            <div class="social-proof-label">Average Analysis Time</div>
                        </div>
                    </div>
                    <div class="social-proof-testimonial">
                        <p class="testimonial-quote">"Finally found a tool that shows me exactly where my money is going. The fee analysis alone saved me from losing thousands in hidden costs."</p>
                        <div class="testimonial-author">
                            <div class="testimonial-avatar">MK</div>
                            <div class="testimonial-info">
                                <div class="testimonial-name">Michael K.</div>
                                <div class="testimonial-role">Self-directed Investor</div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Wave Divider: How It Works to Preview -->
            <div class="section-divider section-divider-inverted">
                <svg viewBox="0 0 1440 60" preserveAspectRatio="none">
                    <path d="M0,60 C360,0 1080,0 1440,60 L1440,60 L0,60 Z" fill="#0A2540"/>
                </svg>
            </div>

            <!-- Sample Report Preview Section -->
            <section class="landing-section preview-section" data-animate>
                <div class="container">
                    <div class="section-badge">Portfolio Intelligence</div>
                    <h2 class="section-heading">See What's In Your Report</h2>
                    <p class="section-subheading">Professional-grade analytics for investors and advisors  powered by AI</p>
                    <div class="browser-frame">
                        <div class="browser-header">
                            <div class="browser-dots">
                                <span class="browser-dot red"></span>
                                <span class="browser-dot yellow"></span>
                                <span class="browser-dot green"></span>
                            </div>
                            <div class="browser-url-bar">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                                    <path d="M9 12l2 2 4-4"/>
                                </svg>
                                statementscan.app/report
                            </div>
                        </div>
                        <div class="browser-content">
                            <div class="preview-grid">
                        <div class="preview-card">
                            <div class="preview-card-header">
                                <h3>Asset Allocation</h3>
                            </div>
                            <div class="preview-card-body">
                                <div class="pv-donut">
                                    <div class="pv-donut-ring">
                                        <span class="pv-donut-value">$847K</span>
                                        <span class="pv-donut-label">Total Value</span>
                                    </div>
                                    <div class="pv-donut-legend">
                                        <span class="pv-legend-item"><span class="pv-dot pv-dot-stocks"></span>Stocks 62%</span>
                                        <span class="pv-legend-item"><span class="pv-dot pv-dot-bonds"></span>Bonds 24%</span>
                                        <span class="pv-legend-item"><span class="pv-dot pv-dot-cash"></span>Cash 14%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="preview-card">
                            <div class="preview-card-header">
                                <h3>Risk Score</h3>
                            </div>
                            <div class="preview-card-body">
                                <div class="pv-gauge">
                                    <div class="pv-gauge-arc"></div>
                                    <div class="pv-gauge-needle"></div>
                                    <div class="pv-gauge-info">
                                        <span class="pv-gauge-value">67</span>
                                        <span class="pv-gauge-label">Moderate</span>
                                    </div>
                                    <div class="pv-gauge-scale">
                                        <span>Conservative</span>
                                        <span>Aggressive</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="preview-card">
                            <div class="preview-card-header">
                                <h3>Sector Exposure</h3>
                            </div>
                            <div class="preview-card-body">
                                <div class="pv-bars">
                                    <div class="pv-bar-row">
                                        <span class="pv-bar-label">Technology</span>
                                        <div class="pv-bar-track"><div class="pv-bar-fill" style="width: 100%;"></div></div>
                                        <span class="pv-bar-value">32%</span>
                                    </div>
                                    <div class="pv-bar-row">
                                        <span class="pv-bar-label">Healthcare</span>
                                        <div class="pv-bar-track"><div class="pv-bar-fill" style="width: 56%;"></div></div>
                                        <span class="pv-bar-value">18%</span>
                                    </div>
                                    <div class="pv-bar-row">
                                        <span class="pv-bar-label">Financials</span>
                                        <div class="pv-bar-track"><div class="pv-bar-fill" style="width: 47%;"></div></div>
                                        <span class="pv-bar-value">15%</span>
                                    </div>
                                    <div class="pv-bar-row">
                                        <span class="pv-bar-label">Consumer</span>
                                        <div class="pv-bar-track"><div class="pv-bar-fill" style="width: 38%;"></div></div>
                                        <span class="pv-bar-value">12%</span>
                                    </div>
                                    <div class="pv-bar-row">
                                        <span class="pv-bar-label">Other</span>
                                        <div class="pv-bar-track"><div class="pv-bar-fill" style="width: 72%;"></div></div>
                                        <span class="pv-bar-value">23%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="preview-card">
                            <div class="preview-card-header">
                                <h3>Fee Analysis</h3>
                            </div>
                            <div class="preview-card-body">
                                <div class="fee-mockup">
                                    <div class="fee-stat">
                                        <span class="fee-amount">$2,847</span>
                                        <span class="fee-label">Annual Fees</span>
                                    </div>
                                    <div class="fee-breakdown">
                                        <div class="fee-item warning">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                                                <line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>
                                            </svg>
                                            <span>ARKK: 0.75% expense ratio</span>
                                        </div>
                                        <div class="fee-item">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                                                <polyline points="22 4 12 14.01 9 11.01"/>
                                            </svg>
                                            <span>VOO: 0.03% expense ratio</span>
                                        </div>
                                    </div>
                                    <div class="fee-savings">
                                        <span>Potential Savings: <strong>$1,200/yr</strong></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="preview-card">
                            <div class="preview-card-header">
                                <h3>Performance Analysis</h3>
                            </div>
                            <div class="preview-card-body">
                                <div class="pv-performance">
                                    <div class="pv-perf-summary">
                                        <div class="pv-perf-metric">
                                            <span class="pv-perf-value positive">+18.4%</span>
                                            <span class="pv-perf-label">Total Return</span>
                                        </div>
                                        <div class="pv-perf-metric">
                                            <span class="pv-perf-value">+12.1%</span>
                                            <span class="pv-perf-label">vs. S&P 500</span>
                                        </div>
                                        <div class="pv-perf-metric">
                                            <span class="pv-perf-value">1.32</span>
                                            <span class="pv-perf-label">Sharpe Ratio</span>
                                        </div>
                                    </div>
                                    <div class="pv-perf-chart">
                                        <div class="pv-perf-bars">
                                            <div class="pv-perf-bar positive" style="height: 60%;" title="Jan +3.2%"></div>
                                            <div class="pv-perf-bar negative" style="height: 20%;" title="Feb -1.1%"></div>
                                            <div class="pv-perf-bar positive" style="height: 45%;" title="Mar +2.4%"></div>
                                            <div class="pv-perf-bar positive" style="height: 75%;" title="Apr +4.1%"></div>
                                            <div class="pv-perf-bar negative" style="height: 35%;" title="May -1.8%"></div>
                                            <div class="pv-perf-bar positive" style="height: 55%;" title="Jun +2.9%"></div>
                                            <div class="pv-perf-bar positive" style="height: 40%;" title="Jul +2.1%"></div>
                                            <div class="pv-perf-bar positive" style="height: 80%;" title="Aug +4.5%"></div>
                                            <div class="pv-perf-bar negative" style="height: 15%;" title="Sep -0.7%"></div>
                                            <div class="pv-perf-bar positive" style="height: 50%;" title="Oct +2.6%"></div>
                                            <div class="pv-perf-bar positive" style="height: 65%;" title="Nov +3.5%"></div>
                                            <div class="pv-perf-bar positive" style="height: 30%;" title="Dec +1.5%"></div>
                                        </div>
                                        <span class="pv-perf-chart-label">Monthly Returns (12 mo.)</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div><!-- End preview-grid -->
                        </div><!-- End browser-content -->
                    </div><!-- End browser-frame -->
                </div>
            </section>

            <!-- Wave Divider: Preview to Value Props -->
            <div class="section-divider section-divider-light-to-dark">
                <svg viewBox="0 0 1440 80" fill="none" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="none">
                    <path d="M0,0 C360,80 1080,80 1440,0 L1440,80 L0,80 Z" fill="#0A2540"/>
                </svg>
            </div>

            <!-- Value Props Section -->
            <section class="landing-section value-props" data-animate>
                <div class="container">
                    <h2 class="section-heading">Why Statement Scan?</h2>
                    <p class="section-subheading">Built for investors who want clarity, not complexity</p>
                    <div class="value-props-grid" data-animate-child>
                        <div class="value-card">
                            <div class="value-icon">
                                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <circle cx="11" cy="11" r="8"/>
                                    <path d="M21 21l-4.35-4.35"/>
                                    <path d="M11 8v6M8 11h6"/>
                                </svg>
                            </div>
                            <h3 class="value-title">Hidden Fee Detection</h3>
                            <p class="value-description">Instantly spot high-cost funds eating into your returns. We analyze expense ratios across all your holdings.</p>
                        </div>
                        <div class="value-card">
                            <div class="value-icon">
                                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <path d="M3 3v18h18"/>
                                    <path d="M18.7 8l-5.1 5.2-2.8-2.7L7 14.3"/>
                                </svg>
                            </div>
                            <h3 class="value-title">Benchmark Comparison</h3>
                            <p class="value-description">See how your portfolio stacks up against the S&P 500, target-date funds, and custom benchmarks.</p>
                        </div>
                        <div class="value-card">
                            <div class="value-icon">
                                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                                    <path d="M9 12l2 2 4-4"/>
                                </svg>
                            </div>
                            <h3 class="value-title">Risk Analysis</h3>
                            <p class="value-description">Understand your true risk exposure with volatility metrics, concentration warnings, and scenario analysis.</p>
                        </div>
                        <div class="value-card">
                            <div class="value-icon">
                                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                                    <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                                    <circle cx="12" cy="16" r="1"/>
                                </svg>
                            </div>
                            <h3 class="value-title">Privacy First</h3>
                            <p class="value-description">Your data stays yours. We never store your statements or sell your information. Analyze locally or delete anytime.</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Wave Divider: Value Props to page background (before CTA) -->
            <div class="section-divider section-divider-dark-to-light">
                <svg viewBox="0 0 1440 80" fill="none" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="none">
                    <path d="M0,0 C360,80 1080,80 1440,0 L1440,80 L0,80 Z" fill="#f6f9fc"/>
                </svg>
            </div>

            <!-- CTA Section -->
            <section class="landing-section cta-section">
                <div class="container">
                    <h2 class="cta-heading">Ready to see what's hiding in your portfolio?</h2>
                    <p class="cta-subheading">Free analysis. No account required. Results in 30 seconds.</p>
                    <button class="btn btn-primary btn-lg cta-button" onclick="scrollToUpload()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="17 8 12 3 7 8"/>
                            <line x1="12" y1="3" x2="12" y2="15"/>
                        </svg>
                        Upload Your Statement
                    </button>
                </div>
            </section>

            <!-- FAQ Section -->
            <section class="landing-section faq-section" data-animate>
                <div class="container">
                    <div class="faq-container">
                        <div class="faq-header">
                            <h2 class="faq-title">Frequently Asked Questions</h2>
                            <p class="faq-subtitle">Everything you need to know about portfolio analysis</p>
                        </div>
                        <div class="faq-list">
                            <div class="faq-item">
                                <button class="faq-question" onclick="toggleFaq(this)">
                                    Is my data secure and private?
                                    <svg class="faq-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <line x1="12" y1="5" x2="12" y2="19"/>
                                        <line x1="5" y1="12" x2="19" y2="12"/>
                                    </svg>
                                </button>
                                <div class="faq-answer">
                                    <div class="faq-answer-content">
                                        Yes, your data never leaves your device. All analysis happens locally in your browser using JavaScript. We don't upload, store, or transmit your financial statements to any server. Your portfolio data stays completely private.
                                    </div>
                                </div>
                            </div>
                            <div class="faq-item">
                                <button class="faq-question" onclick="toggleFaq(this)">
                                    Which brokerage statements are supported?
                                    <svg class="faq-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <line x1="12" y1="5" x2="12" y2="19"/>
                                        <line x1="5" y1="12" x2="19" y2="12"/>
                                    </svg>
                                </button>
                                <div class="faq-answer">
                                    <div class="faq-answer-content">
                                        We support PDF statements from all major brokerages including Fidelity, Schwab, Vanguard, TD Ameritrade, E*TRADE, Merrill Lynch, Morgan Stanley, and many more. We also accept CSV exports from most platforms.
                                    </div>
                                </div>
                            </div>
                            <div class="faq-item">
                                <button class="faq-question" onclick="toggleFaq(this)">
                                    Is Statement Scan really free?
                                    <svg class="faq-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <line x1="12" y1="5" x2="12" y2="19"/>
                                        <line x1="5" y1="12" x2="19" y2="12"/>
                                    </svg>
                                </button>
                                <div class="faq-answer">
                                    <div class="faq-answer-content">
                                        Yes, the core portfolio analysis features are completely free with no limits. We plan to offer optional premium features in the future, but analyzing your statements, viewing allocations, and generating reports will always be free.
                                    </div>
                                </div>
                            </div>
                            <div class="faq-item">
                                <button class="faq-question" onclick="toggleFaq(this)">
                                    Do I need to create an account?
                                    <svg class="faq-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <line x1="12" y1="5" x2="12" y2="19"/>
                                        <line x1="5" y1="12" x2="19" y2="12"/>
                                    </svg>
                                </button>
                                <div class="faq-answer">
                                    <div class="faq-answer-content">
                                        No account required for basic analysis. Simply upload your statement and get instant results. Creating a free account lets you save portfolios, track changes over time, and access your analysis from any device.
                                    </div>
                                </div>
                            </div>
                            <div class="faq-item">
                                <button class="faq-question" onclick="toggleFaq(this)">
                                    What insights will I get from my portfolio analysis?
                                    <svg class="faq-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <line x1="12" y1="5" x2="12" y2="19"/>
                                        <line x1="5" y1="12" x2="19" y2="12"/>
                                    </svg>
                                </button>
                                <div class="faq-answer">
                                    <div class="faq-answer-content">
                                        You'll see your asset allocation breakdown, sector exposure, geographic diversification, hidden fees analysis, dividend income projections, risk metrics, and actionable recommendations to optimize your portfolio.
                                    </div>
                                </div>
                            </div>
                            <div class="faq-item">
                                <button class="faq-question" onclick="toggleFaq(this)">
                                    How accurate is the analysis?
                                    <svg class="faq-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <line x1="12" y1="5" x2="12" y2="19"/>
                                        <line x1="5" y1="12" x2="19" y2="12"/>
                                    </svg>
                                </button>
                                <div class="faq-answer">
                                    <div class="faq-answer-content">
                                        Our parser extracts data directly from your statement with high accuracy. We cross-reference holdings against market data for current prices and fund information. For best results, use your most recent official brokerage statement.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

        </div><!-- End landing sections -->

        <!-- User Dashboard (shown when logged in) -->
        <section id="userDashboard" class="user-dashboard" style="display: none;">
            <div class="container">
                <!-- Welcome Header -->
                <div class="dashboard-header">
                    <div class="dashboard-welcome">
                        <h1>Welcome back, <span id="dashboardUserName">User</span></h1>
                        <p class="dashboard-subtitle">Manage your portfolios and analyze new statements</p>
                    </div>
                    <button class="btn btn-primary" onclick="scrollToUpload(); hideUserDashboard();">
                        + New Analysis
                    </button>
                </div>

                <!-- Quick Stats Row -->
                <div class="dashboard-stats">
                    <div class="dashboard-stat-card">
                        <span class="dashboard-stat-number" id="totalPortfoliosCount">0</span>
                        <span class="dashboard-stat-label">Saved Portfolios</span>
                    </div>
                    <div class="dashboard-stat-card">
                        <span class="dashboard-stat-number" id="connectedAccountsCount">0</span>
                        <span class="dashboard-stat-label">Connected Accounts</span>
                    </div>
                    <div class="dashboard-stat-card">
                        <span class="dashboard-stat-number" id="lastAnalysisDate">--</span>
                        <span class="dashboard-stat-label">Last Analysis</span>
                    </div>
                </div>

                <!-- Portfolios Grid -->
                <div class="dashboard-section">
                    <div class="dashboard-section-header">
                        <h2>Your Portfolios</h2>
                        <a href="#" onclick="scrollToUpload(); hideUserDashboard(); return false;">Add New</a>
                    </div>
                    <div id="dashboardPortfolios" class="dashboard-portfolios-grid">
                        <!-- Populated dynamically -->
                    </div>
                    <div id="dashboardEmptyState" class="dashboard-empty-state" style="display: none;">
                        <div class="dashboard-empty-icon"></div>
                        <h3>No portfolios yet</h3>
                        <p>Upload a brokerage statement to get started</p>
                        <button class="btn btn-primary" onclick="scrollToUpload(); hideUserDashboard();">
                            Upload Statement
                        </button>
                    </div>
                </div>

                <!-- Connected Accounts -->
                <div class="dashboard-section">
                    <div class="dashboard-section-header">
                        <h2>Connected Accounts</h2>
                    </div>
                    <div id="dashboardPlaidAccounts" class="dashboard-connected-accounts">
                        <div class="dashboard-no-accounts">No accounts connected yet. Connect your brokerage via Plaid to automatically import holdings.</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Stripe-Style Footer -->
        <footer class="site-footer">
            <div class="footer-container">
                <!-- Row 1: Brand + Navigation -->
                <div class="footer-top">
                    <div class="footer-brand">
                        <a href="/" class="footer-logo-link">
                            <div class="footer-logo-icon">
                                <svg viewBox="0 0 44 44" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <rect x="0" y="0" width="24" height="24" rx="4" fill="white"/>
                                    <rect x="20" y="20" width="24" height="24" rx="4" fill="white"/>
                                    <rect x="0" y="19" width="44" height="6" fill="white" opacity="0.4"/>
                                    <rect x="16" y="16" width="12" height="12" rx="2" fill="white"/>
                                </svg>
                            </div>
                            <span class="footer-brand-name">Statement Scan</span>
                        </a>
                    </div>
                    <nav class="footer-nav">
                        <div class="footer-nav-group">
                            <span class="footer-nav-label">Product</span>
                            <a href="#" onclick="scrollToUpload(); return false;">Statement Upload</a>
                            <a href="#" onclick="navScrollToSection('previewSection'); return false;">Fee Analyzer</a>
                            <a href="#" onclick="navScrollToSection('previewSection'); return false;">Portfolio Report</a>
                        </div>
                        <div class="footer-nav-group">
                            <span class="footer-nav-label">Resources</span>
                            <a href="#" onclick="navScrollToSection('howItWorksSection'); return false;">How It Works</a>
                            <a href="#" onclick="scrollToUpload(); return false;">Upload Statement</a>
                        </div>
                        <div class="footer-nav-group">
                            <span class="footer-nav-label">Legal</span>
                            <a href="/privacy.html">Privacy</a>
                            <a href="/terms.html">Terms</a>
                            <a href="/disclaimer.html">Disclaimer</a>
                        </div>
                        <div class="footer-nav-group">
                            <span class="footer-nav-label">Company</span>
                            <a href="mailto:support@statementscan.app">Contact</a>
                        </div>
                    </nav>
                </div>

                <!-- Row 2: Disclaimer -->
                <div class="footer-disclaimer">
                    Statement Scan is not a registered investment advisor, broker-dealer, or financial planner. All analytics and recommendations are for informational and educational purposes only and do not constitute financial, investment, tax, or legal advice. Past performance does not guarantee future results.
                </div>

                <!-- Row 3: Copyright + Legal links -->
                <div class="footer-bottom">
                    <span class="footer-copyright"> 2026 Statement Scan, Inc. All rights reserved.</span>
                    <div class="footer-legal-links">
                        <a href="/privacy.html">Privacy</a>
                        <a href="/terms.html">Terms</a>
                        <a href="/cookies.html">Cookies</a>
                        <a href="/sitemap.html">Sitemap</a>
                    </div>
                </div>
            </div>
        </footer>

    <!-- Auth Modal -->
    <div class="modal-overlay" id="authModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Welcome</h2>
                <button class="modal-close" onclick="hideAuthModal()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="auth-tabs">
                    <button class="auth-tab active" data-tab="login" onclick="switchAuthTab('login')">Sign In</button>
                    <button class="auth-tab" data-tab="register" onclick="switchAuthTab('register')">Create Account</button>
                </div>

                <!-- Login Form -->
                <form class="auth-form active" id="loginForm" onsubmit="handleLogin(event)">
                    <div class="form-group">
                        <label class="form-label" for="loginEmail">Email</label>
                        <input type="email" class="form-input" id="loginEmail" placeholder="you@example.com" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="loginPassword">Password</label>
                        <input type="password" class="form-input" id="loginPassword" placeholder="Enter your password" required>
                    </div>
                    <div class="form-error" id="loginError" style="display: none;"></div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">Sign In</button>
                    <div class="forgot-password-link">
                        <a href="#" onclick="showForgotPassword(event)">Forgot your password?</a>
                    </div>
                </form>

                <!-- Forgot Password Form -->
                <form class="auth-form" id="forgotPasswordForm" onsubmit="handleForgotPassword(event)">
                    <p class="form-description">Enter your email address and we'll send you a link to reset your password.</p>
                    <div class="form-group">
                        <label class="form-label" for="forgotEmail">Email</label>
                        <input type="email" class="form-input" id="forgotEmail" placeholder="you@example.com" required>
                    </div>
                    <div class="form-error" id="forgotError" style="display: none;"></div>
                    <div class="form-success" id="forgotSuccess" style="display: none;"></div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">Send Reset Link</button>
                    <div class="back-to-login">
                        <a href="#" onclick="backToLogin(event)">Back to sign in</a>
                    </div>
                </form>

                <!-- Register Form -->
                <form class="auth-form" id="registerForm" onsubmit="handleRegister(event)">
                    <div class="form-group">
                        <label class="form-label" for="registerName">Name (optional)</label>
                        <input type="text" class="form-input" id="registerName" placeholder="Your name">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="registerEmail">Email</label>
                        <input type="email" class="form-input" id="registerEmail" placeholder="you@example.com" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="registerPassword">Password</label>
                        <input type="password" class="form-input" id="registerPassword" placeholder="At least 8 characters" minlength="8" required>
                    </div>
                    <div class="form-error" id="registerError" style="display: none;"></div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">Create Account</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Reset Password Modal -->
    <div class="modal-overlay" id="resetPasswordModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Reset Password</h2>
                <button class="modal-close" onclick="hideResetPasswordModal()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <form id="resetPasswordForm" onsubmit="handleResetPassword(event)">
                    <p class="form-description">Enter your new password below.</p>
                    <div class="form-group">
                        <label class="form-label" for="newPassword">New Password</label>
                        <input type="password" class="form-input" id="newPassword" placeholder="At least 6 characters" minlength="6" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="confirmPassword">Confirm Password</label>
                        <input type="password" class="form-input" id="confirmPassword" placeholder="Confirm your password" minlength="6" required>
                    </div>
                    <div class="form-error" id="resetError" style="display: none;"></div>
                    <div class="form-success" id="resetSuccess" style="display: none;"></div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">Reset Password</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Enhanced Toast Container -->
    <div class="toast-container" id="toastContainer" aria-live="polite" aria-atomic="true">
        <!-- Toasts will be dynamically added here -->
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <p id="loadingText">Loading...</p>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal" style="max-width: 480px;">
            <div class="modal-header">
                <h2 class="modal-title">Settings</h2>
                <button class="modal-close" onclick="hideSettingsModal()" aria-label="Close settings">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="settings-section">
                    <div class="settings-section-title">Appearance</div>
                    <div class="settings-option">
                        <div>
                            <div class="settings-option-label">Theme</div>
                            <div class="settings-option-desc">Choose your preferred color scheme</div>
                        </div>
                        <select class="settings-select" id="themeSelect" onchange="setTheme(this.value)">
                            <option value="system">System</option>
                            <option value="light">Light</option>
                            <option value="dark">Dark</option>
                        </select>
                    </div>
                </div>

                <div class="settings-section">
                    <div class="settings-section-title">Notifications</div>
                    <div class="settings-option">
                        <div>
                            <div class="settings-option-label">Toast Notifications</div>
                            <div class="settings-option-desc">Show popup notifications for actions</div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="toastEnabled" checked onchange="saveSettings()">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="settings-option">
                        <div>
                            <div class="settings-option-label">Sound Effects</div>
                            <div class="settings-option-desc">Play sounds for notifications</div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="soundEnabled" onchange="saveSettings()">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>

                <div class="settings-section">
                    <div class="settings-section-title">Data & Privacy</div>
                    <div class="settings-option">
                        <div>
                            <div class="settings-option-label">Default Export Format</div>
                            <div class="settings-option-desc">Preferred format for data exports</div>
                        </div>
                        <select class="settings-select" id="exportFormat" onchange="saveSettings()">
                            <option value="pdf">PDF</option>
                            <option value="csv">CSV</option>
                        </select>
                    </div>
                    <div class="settings-option">
                        <div>
                            <div class="settings-option-label">Remember Portfolios</div>
                            <div class="settings-option-desc">Keep portfolio data in browser</div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="rememberPortfolios" checked onchange="saveSettings()">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>

                <div class="settings-section" style="margin-bottom: 0;">
                    <div class="settings-section-title">Keyboard Shortcuts</div>
                    <button class="btn btn-secondary" onclick="showKeyboardShortcuts()" style="width: 100%;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="2" y="4" width="20" height="16" rx="2"/>
                            <path d="M6 8h.01M10 8h.01M14 8h.01M18 8h.01M8 12h8M6 16h.01M18 16h.01"/>
                        </svg>
                        View Keyboard Shortcuts
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Keyboard Shortcuts Modal -->
    <div class="modal-overlay" id="shortcutsModal">
        <div class="modal" style="max-width: 480px;">
            <div class="modal-header">
                <h2 class="modal-title">Keyboard Shortcuts</h2>
                <button class="modal-close" onclick="hideKeyboardShortcuts()" aria-label="Close shortcuts">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="shortcuts-grid">
                    <div class="shortcut-item">
                        <span class="shortcut-action">Upload files</span>
                        <div class="shortcut-keys">
                            <span class="kbd">Ctrl</span>
                            <span class="kbd">U</span>
                        </div>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-action">Analyze portfolio</span>
                        <div class="shortcut-keys">
                            <span class="kbd">Ctrl</span>
                            <span class="kbd">Enter</span>
                        </div>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-action">New analysis</span>
                        <div class="shortcut-keys">
                            <span class="kbd">Ctrl</span>
                            <span class="kbd">N</span>
                        </div>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-action">Toggle dark mode</span>
                        <div class="shortcut-keys">
                            <span class="kbd">Ctrl</span>
                            <span class="kbd">D</span>
                        </div>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-action">Open settings</span>
                        <div class="shortcut-keys">
                            <span class="kbd">Ctrl</span>
                            <span class="kbd">,</span>
                        </div>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-action">Close modal / Cancel</span>
                        <div class="shortcut-keys">
                            <span class="kbd">Esc</span>
                        </div>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-action">Show shortcuts</span>
                        <div class="shortcut-keys">
                            <span class="kbd">?</span>
                        </div>
                    </div>
                </div>
                <p style="margin-top: 16px; font-size: 0.8125rem; color: var(--text-muted);">
                    On Mac, use <span class="kbd">Cmd</span> instead of <span class="kbd">Ctrl</span>
                </p>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal-overlay confirm-modal" id="confirmModal">
        <div class="modal">
            <div class="modal-body" style="padding-top: 32px;">
                <div class="confirm-icon danger" id="confirmIcon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                        <line x1="12" y1="9" x2="12" y2="13"/>
                        <line x1="12" y1="17" x2="12.01" y2="17"/>
                    </svg>
                </div>
                <div class="confirm-text">
                    <div class="confirm-title" id="confirmTitle">Are you sure?</div>
                    <div class="confirm-desc" id="confirmDesc">This action cannot be undone.</div>
                </div>
                <div class="confirm-actions">
                    <button class="btn btn-secondary" onclick="hideConfirmModal()">Cancel</button>
                    <button class="btn btn-primary" id="confirmAction" style="background: var(--danger);">Delete</button>
                </div>
                <label class="confirm-checkbox" id="confirmCheckboxWrapper" style="display: none;">
                    <input type="checkbox" id="dontShowAgain">
                    <span>Don't show this again</span>
                </label>
            </div>
        </div>
    </div>

    <!-- Onboarding Modal -->
    <div class="onboarding-overlay" id="onboardingOverlay">
        <div class="onboarding-card">
            <div class="onboarding-image" id="onboardingImage">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="17 8 12 3 7 8"/>
                    <line x1="12" y1="3" x2="12" y2="15"/>
                </svg>
            </div>
            <div class="onboarding-content">
                <h2 class="onboarding-title" id="onboardingTitle">Welcome to Statement Scan</h2>
                <p class="onboarding-text" id="onboardingText">Upload your brokerage statements and get instant portfolio analytics, benchmarking, and AI-powered insights.</p>
                <div class="onboarding-steps">
                    <div class="onboarding-step active" data-step="0"></div>
                    <div class="onboarding-step" data-step="1"></div>
                    <div class="onboarding-step" data-step="2"></div>
                    <div class="onboarding-step" data-step="3"></div>
                </div>
                <div class="onboarding-actions">
                    <button class="onboarding-skip" onclick="skipOnboarding()">Skip</button>
                    <button class="btn btn-primary" id="onboardingNext" onclick="nextOnboardingStep()">Get Started</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div class="modal-overlay" id="exportModal">
        <div class="modal" style="max-width: 520px;">
            <div class="modal-header">
                <h2 class="modal-title">Export Portfolio</h2>
                <button class="modal-close" onclick="hideExportModal()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="export-options">
                    <div class="export-option" onclick="exportToPDF()">
                        <div class="export-option-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                <polyline points="14 2 14 8 20 8"/>
                            </svg>
                        </div>
                        <div class="export-option-label">PDF Report</div>
                        <div class="export-option-desc">Full analysis with charts</div>
                    </div>
                    <div class="export-option" onclick="exportToCSV()">
                        <div class="export-option-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2"/>
                                <line x1="9" y1="3" x2="9" y2="21"/>
                                <line x1="15" y1="3" x2="15" y2="21"/>
                                <line x1="3" y1="9" x2="21" y2="9"/>
                                <line x1="3" y1="15" x2="21" y2="15"/>
                            </svg>
                        </div>
                        <div class="export-option-label">CSV</div>
                        <div class="export-option-desc">Spreadsheet compatible</div>
                    </div>
                    <div class="export-option" onclick="exportToExcel()">
                        <div class="export-option-icon" style="color: #217346;">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                <polyline points="14 2 14 8 20 8"/>
                                <path d="M8 13h2l2 3 2-3h2"/>
                            </svg>
                        </div>
                        <div class="export-option-label">Excel</div>
                        <div class="export-option-desc">Multiple sheets</div>
                    </div>
                    <div class="export-option" onclick="exportToJSON()">
                        <div class="export-option-icon" style="color: #f7df1e;">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                <polyline points="14 2 14 8 20 8"/>
                                <path d="M10 12v4c0 1-1 2-2 2M14 12v4c0 1 1 2 2 2h-2"/>
                            </svg>
                        </div>
                        <div class="export-option-label">JSON</div>
                        <div class="export-option-desc">Raw data format</div>
                    </div>
                </div>
                <div id="exportRedactedSection">
                    <div class="export-divider"></div>
                    <div class="export-section-label">Source Document</div>
                    <div class="export-options">
                        <div class="export-option" id="exportRedactedOption" onclick="downloadRedactedPdf(); hideExportModal();">
                        <div class="export-option-icon" style="color: #ff453a;">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                <polyline points="14 2 14 8 20 8"/>
                                <rect x="8" y="12" width="8" height="3" rx="1"/>
                                <rect x="8" y="16" width="5" height="2" rx="0.5"/>
                            </svg>
                        </div>
                        <div class="export-option-label">Redacted Statement</div>
                        <div class="export-option-desc">PII masked PDF</div>
                    </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Share Modal -->
    <div class="modal-overlay share-modal" id="shareModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Share Portfolio</h2>
                <button class="modal-close" onclick="hideShareModal()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <p style="color: var(--text-muted); margin-bottom: 16px;">Share a read-only view of your portfolio analysis</p>
                <div class="share-link-container">
                    <input type="text" class="share-link-input" id="shareLink" readonly value="Generating link...">
                    <button class="btn btn-primary" onclick="copyShareLink()">Copy</button>
                </div>
                <div class="settings-option" style="border: none; padding: 16px 0;">
                    <div>
                        <div class="settings-option-label">Hide specific values</div>
                        <div class="settings-option-desc">Show percentages only, hide dollar amounts</div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="shareHideValues" onchange="updateShareLink()">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="share-options">
                    <button class="share-option-btn" onclick="shareViaEmail()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                            <polyline points="22,6 12,13 2,6"/>
                        </svg>
                        Email
                    </button>
                    <button class="share-option-btn" onclick="shareViaTwitter()">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                        </svg>
                        Twitter
                    </button>
                    <button class="share-option-btn" onclick="shareViaLinkedIn()">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
                        </svg>
                        LinkedIn
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Alert Modal -->
    <div class="modal-overlay" id="addAlertModal">
        <div class="modal" style="max-width: 450px;">
            <div class="modal-header">
                <h2 class="modal-title">Create Price Alert</h2>
                <button class="modal-close" onclick="hideAddAlertModal()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <form id="addAlertForm" onsubmit="createAlert(event)">
                    <div class="form-group">
                        <label class="form-label">Symbol</label>
                        <select class="form-input" id="alertSymbol" required>
                            <option value="">Select a holding...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Condition</label>
                        <select class="form-input" id="alertCondition" required>
                            <option value="above">Price goes above</option>
                            <option value="below">Price goes below</option>
                            <option value="change_up">Increases by %</option>
                            <option value="change_down">Decreases by %</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Value</label>
                        <input type="number" class="form-input" id="alertValue" placeholder="Enter price or percentage" step="0.01" required>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">Create Alert</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Goal Modal -->
    <div class="modal-overlay" id="addGoalModal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title">Create Investment Goal</h2>
                <button class="modal-close" onclick="hideAddGoalModal()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <form id="addGoalForm" onsubmit="createGoal(event)">
                    <div class="goal-form-group">
                        <label class="goal-form-label">Goal Type</label>
                        <div class="goal-type-options" id="goalTypeOptions">
                            <div class="goal-type-option selected" data-type="target_value">
                                <div class="goal-type-icon"></div>
                                <div class="goal-type-name">Target Value</div>
                            </div>
                            <div class="goal-type-option" data-type="retirement">
                                <div class="goal-type-icon"></div>
                                <div class="goal-type-name">Retirement</div>
                            </div>
                            <div class="goal-type-option" data-type="emergency">
                                <div class="goal-type-icon"></div>
                                <div class="goal-type-name">Emergency Fund</div>
                            </div>
                            <div class="goal-type-option" data-type="custom">
                                <div class="goal-type-icon"></div>
                                <div class="goal-type-name">Custom Goal</div>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Goal Name</label>
                        <input type="text" class="form-input" id="goalName" placeholder="e.g., House Down Payment" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Target Amount</label>
                        <input type="number" class="form-input" id="goalTarget" placeholder="100000" step="1000" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Target Date</label>
                        <input type="date" class="form-input" id="goalDate" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Starting Amount (Optional)</label>
                        <input type="number" class="form-input" id="goalStarting" placeholder="0" step="100">
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">Create Goal</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Import Modal -->
    <div class="modal-overlay" id="importModal">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h2 class="modal-title">Import Portfolio</h2>
                <button class="modal-close" onclick="hideImportModal()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <p style="color: var(--text-muted); margin-bottom: 20px;">Download a template and fill in your holdings, then upload it here.</p>
                <div class="import-templates">
                    <div class="import-template" onclick="downloadTemplate('basic')">
                        <svg class="import-template-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <rect x="3" y="3" width="18" height="18" rx="2"/>
                            <line x1="9" y1="3" x2="9" y2="21"/>
                            <line x1="3" y1="9" x2="21" y2="9"/>
                        </svg>
                        <div class="import-template-name">Basic Template</div>
                        <div class="import-template-desc">Symbol, Shares, Price</div>
                    </div>
                    <div class="import-template" onclick="downloadTemplate('detailed')">
                        <svg class="import-template-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <rect x="3" y="3" width="18" height="18" rx="2"/>
                            <line x1="9" y1="3" x2="9" y2="21"/>
                            <line x1="15" y1="3" x2="15" y2="21"/>
                            <line x1="3" y1="9" x2="21" y2="9"/>
                            <line x1="3" y1="15" x2="21" y2="15"/>
                        </svg>
                        <div class="import-template-name">Detailed Template</div>
                        <div class="import-template-desc">With cost basis & dates</div>
                    </div>
                    <div class="import-template" onclick="downloadTemplate('schwab')">
                        <svg class="import-template-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                        </svg>
                        <div class="import-template-name">Schwab Format</div>
                        <div class="import-template-desc">Schwab export compatible</div>
                    </div>
                </div>
                <div style="margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--border);">
                    <div class="card upload-card" style="padding: 24px;">
                        <input type="file" id="importFileInput" accept=".csv,.xlsx" style="display: none;" onchange="handleImportFile(event)">
                        <button class="btn btn-primary" onclick="document.getElementById('importFileInput').click()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                <polyline points="17 8 12 3 7 8"/>
                                <line x1="12" y1="3" x2="12" y2="15"/>
                            </svg>
                            Upload Filled Template
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- PWA Install Prompt -->
    <div class="pwa-install-prompt" id="pwaInstallPrompt">
        <div class="pwa-install-icon">
            <svg width="24" height="24" viewBox="0 0 44 44" fill="none">
                <rect x="0" y="0" width="24" height="24" rx="4" fill="white"/>
                <rect x="20" y="20" width="24" height="24" rx="4" fill="white"/>
                <rect x="0" y="19" width="44" height="6" fill="white" opacity="0.4"/>
                <rect x="16" y="16" width="12" height="12" rx="2" fill="white"/>
            </svg>
        </div>
        <div class="pwa-install-text">
            <div class="pwa-install-title">Install Statement Scan</div>
            <div class="pwa-install-desc">Add to home screen for quick access</div>
        </div>
        <button class="btn btn-primary" onclick="installPWA()" style="padding: 8px 16px;">Install</button>
        <button class="pwa-install-close" onclick="dismissPWAPrompt()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
        </button>
    </div>

    <!-- Save Portfolio Modal -->
    <div class="modal-overlay save-modal" id="saveModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Save Portfolio</h2>
                <button class="modal-close" onclick="hideSaveModal()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <form id="saveForm" onsubmit="handleSavePortfolio(event)">
                    <div class="form-group">
                        <label class="form-label" for="portfolioName">Portfolio Name</label>
                        <input type="text" class="form-input" id="portfolioName" placeholder="e.g., Retirement Account" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="portfolioDescription">Description (optional)</label>
                        <input type="text" class="form-input" id="portfolioDescription" placeholder="Brief description">
                    </div>
                    <div class="form-error" id="saveError" style="display: none;"></div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">Save Portfolio</button>
                </form>
            </div>
        </div>

        <!-- Footer -->
        <footer class="site-footer">
            <div class="footer-links">
                <a href="/terms.html">Terms</a>
                <a href="/privacy.html">Privacy</a>
                <a href="/cookies.html">Cookies</a>
                <a href="/disclaimer.html">Disclaimer</a>
                <a href="/data-processing.html">Data Processing</a>
                <a href="/data-retention-policy.html">Data Retention</a>
                <a href="/do-not-sell.html">Do Not Sell</a>
                <a href="/sitemap.html">Sitemap</a>
                <a href="mailto:support@statementscan.app">Contact</a>
            </div>
            <div class="footer-copyright">
                &copy; 2026 Statement Scan, Inc. All rights reserved.
            </div>
        </footer>
    </div>

    <script>
        const API_URL = 'https://statement-scan-api.onrender.com';

        let accounts = [];
        let portfolioData = null;
        let charts = {};
        let currentUser = null;
        let authToken = localStorage.getItem('authToken');
        let fullChartData = null;
        let currentPeriod = '5Y';
        let visibleBenchmarks = { sp500: true, bonds: false, world: false, sixty_forty: false };

        // =============================================================================
        // INDEXEDDB FOR FILE TRANSFER TO APP PAGE
        // =============================================================================

        function openUploadDB() {
            return new Promise((resolve, reject) => {
                const req = indexedDB.open('StatementScanUploads', 1);
                req.onupgradeneeded = e => {
                    e.target.result.createObjectStore('files', { keyPath: 'name' });
                };
                req.onsuccess = e => resolve(e.target.result);
                req.onerror = e => reject(e.target.error);
            });
        }

        async function handleLandingUpload(files) {
            console.log('[Landing] handleLandingUpload called with', files.length, 'files');
            try {
                // Read all file buffers first (before opening transaction)
                const fileData = await Promise.all(files.map(async (file) => ({
                    name: file.name,
                    buffer: await file.arrayBuffer(),
                    type: file.type,
                    timestamp: Date.now()
                })));
                console.log('[Landing] File data prepared:', fileData.map(f => ({ name: f.name, size: f.buffer.byteLength })));

                // Now store all files in IndexedDB
                const db = await openUploadDB();
                console.log('[Landing] IndexedDB opened');
                const tx = db.transaction('files', 'readwrite');
                const store = tx.objectStore('files');

                for (const data of fileData) {
                    store.put(data);
                    console.log('[Landing] Stored file:', data.name);
                }

                // Wait for transaction to complete
                await new Promise((resolve, reject) => {
                    tx.oncomplete = () => {
                        console.log('[Landing] Transaction complete');
                        resolve();
                    };
                    tx.onerror = () => {
                        console.error('[Landing] Transaction error:', tx.error);
                        reject(tx.error);
                    };
                });

                // Verify files were stored
                const verifyTx = db.transaction('files', 'readonly');
                const verifyReq = verifyTx.objectStore('files').getAll();
                verifyReq.onsuccess = () => {
                    console.log('[Landing] Verified stored files:', verifyReq.result.length, verifyReq.result.map(f => f.name));
                };

                // Small delay to ensure IndexedDB write is flushed
                await new Promise(r => setTimeout(r, 100));

                // Redirect to app page
                console.log('[Landing] Redirecting to /app');
                window.location.href = '/app';
            } catch (e) {
                console.error('[Landing] Error storing files for transfer:', e);
                // Fall back to redirecting anyway - app will show empty state
                window.location.href = '/app';
            }
        }

        // Flag to use landing redirect behavior
        let useLandingRedirect = true;

        // =============================================================================
        // ENHANCED PROGRESS TRACKING SYSTEM
        // =============================================================================

        const progressManager = {
            startTime: null,
            currentStage: null,
            totalFiles: 0,
            processedFiles: 0,
            timerInterval: null,

            stages: ['upload', 'parse', 'analyze', 'render'],
            stageProgress: {
                upload: { start: 0, end: 15 },
                parse: { start: 15, end: 60 },
                analyze: { start: 60, end: 85 },
                render: { start: 85, end: 100 }
            },

            start(totalFiles = 1) {
                this.startTime = Date.now();
                this.totalFiles = totalFiles;
                this.processedFiles = 0;
                this.currentStage = null;

                // Reset all stages
                document.querySelectorAll('.progress-stage').forEach(el => {
                    el.classList.remove('active', 'completed');
                });

                // Start timer
                this.updateElapsedTime();
                this.timerInterval = setInterval(() => this.updateElapsedTime(), 1000);

                // Show file info if multiple files
                const fileInfoEl = document.getElementById('progressFileInfo');
                if (totalFiles > 1 && fileInfoEl) {
                    fileInfoEl.style.display = 'flex';
                } else if (fileInfoEl) {
                    fileInfoEl.style.display = 'none';
                }
            },

            setStage(stageName, text) {
                this.currentStage = stageName;
                const stageIndex = this.stages.indexOf(stageName);

                // Update stage indicators
                document.querySelectorAll('.progress-stage').forEach((el, i) => {
                    const stage = el.dataset.stage;
                    if (this.stages.indexOf(stage) < stageIndex) {
                        el.classList.remove('active');
                        el.classList.add('completed');
                    } else if (stage === stageName) {
                        el.classList.add('active');
                        el.classList.remove('completed');
                    } else {
                        el.classList.remove('active', 'completed');
                    }
                });

                // Update text
                const textEl = document.getElementById('progressText');
                if (textEl && text) textEl.textContent = text;

                // Update progress bar to stage start
                this.setProgress(this.stageProgress[stageName]?.start || 0);
            },

            setProgress(percent) {
                const fillEl = document.getElementById('progressBarFill');
                const percentEl = document.getElementById('progressPercentage');

                if (fillEl) fillEl.style.width = `${percent}%`;
                if (percentEl) percentEl.textContent = `${Math.round(percent)}%`;
            },

            updateFileProgress(processedCount, fileName) {
                this.processedFiles = processedCount;

                const fileNameEl = document.getElementById('progressFileName');
                if (fileNameEl && fileName) {
                    fileNameEl.textContent = `${processedCount} of ${this.totalFiles} files processed`;
                }

                // Calculate progress within parse stage
                if (this.currentStage === 'parse' && this.totalFiles > 0) {
                    const stageStart = this.stageProgress.parse.start;
                    const stageEnd = this.stageProgress.parse.end;
                    const fileProgress = processedCount / this.totalFiles;
                    const progress = stageStart + (stageEnd - stageStart) * fileProgress;
                    this.setProgress(progress);
                }
            },

            updateElapsedTime() {
                if (!this.startTime) return;
                const elapsed = Math.floor((Date.now() - this.startTime) / 1000);
                const elapsedEl = document.getElementById('progressElapsed');
                if (elapsedEl) {
                    if (elapsed < 60) {
                        elapsedEl.textContent = `${elapsed}s`;
                    } else {
                        const mins = Math.floor(elapsed / 60);
                        const secs = elapsed % 60;
                        elapsedEl.textContent = `${mins}m ${secs}s`;
                    }
                }
            },

            complete() {
                // Mark all stages complete
                document.querySelectorAll('.progress-stage').forEach(el => {
                    el.classList.remove('active');
                    el.classList.add('completed');
                });

                this.setProgress(100);

                // Stop timer
                if (this.timerInterval) {
                    clearInterval(this.timerInterval);
                    this.timerInterval = null;
                }
            },

            reset() {
                this.startTime = null;
                this.currentStage = null;
                this.totalFiles = 0;
                this.processedFiles = 0;

                if (this.timerInterval) {
                    clearInterval(this.timerInterval);
                    this.timerInterval = null;
                }

                // Reset UI
                document.querySelectorAll('.progress-stage').forEach(el => {
                    el.classList.remove('active', 'completed');
                });
                this.setProgress(0);

                const elapsedEl = document.getElementById('progressElapsed');
                if (elapsedEl) elapsedEl.textContent = '0s';
            }
        };

        // =============================================================================
        // ENTERPRISE ENHANCEMENTS - SETTINGS & PREFERENCES
        // =============================================================================

        // Default settings
        const defaultSettings = {
            theme: 'system',
            toastEnabled: true,
            soundEnabled: false,
            exportFormat: 'pdf',
            rememberPortfolios: true,
            confirmDestructive: true
        };

        // Load settings from localStorage
        let appSettings = { ...defaultSettings, ...JSON.parse(localStorage.getItem('appSettings') || '{}') };

        function saveSettings() {
            appSettings.toastEnabled = document.getElementById('toastEnabled')?.checked ?? true;
            appSettings.soundEnabled = document.getElementById('soundEnabled')?.checked ?? false;
            appSettings.exportFormat = document.getElementById('exportFormat')?.value ?? 'pdf';
            appSettings.rememberPortfolios = document.getElementById('rememberPortfolios')?.checked ?? true;
            localStorage.setItem('appSettings', JSON.stringify(appSettings));
        }

        function loadSettings() {
            const toastEl = document.getElementById('toastEnabled');
            const soundEl = document.getElementById('soundEnabled');
            const formatEl = document.getElementById('exportFormat');
            const rememberEl = document.getElementById('rememberPortfolios');
            const themeEl = document.getElementById('themeSelect');

            if (toastEl) toastEl.checked = appSettings.toastEnabled;
            if (soundEl) soundEl.checked = appSettings.soundEnabled;
            if (formatEl) formatEl.value = appSettings.exportFormat;
            if (rememberEl) rememberEl.checked = appSettings.rememberPortfolios;
            if (themeEl) themeEl.value = appSettings.theme;
        }

        function showSettingsModal() {
            loadSettings();
            document.getElementById('settingsModal').classList.add('active');
            trapFocus(document.getElementById('settingsModal').querySelector('.modal'));
        }

        function hideSettingsModal() {
            document.getElementById('settingsModal').classList.remove('active');
        }

        // =============================================================================
        // DARK MODE / THEME MANAGEMENT
        // =============================================================================

        function initTheme() {
            const savedTheme = appSettings.theme || 'system';
            applyTheme(savedTheme);
        }

        function setTheme(theme) {
            appSettings.theme = theme;
            localStorage.setItem('appSettings', JSON.stringify(appSettings));
            applyTheme(theme);
        }

        function applyTheme(theme) {
            const root = document.documentElement;

            if (theme === 'system') {
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                root.setAttribute('data-theme', prefersDark ? 'dark' : 'light');
            } else {
                root.setAttribute('data-theme', theme);
            }
        }

        function toggleTheme() {
            const current = document.documentElement.getAttribute('data-theme');
            const newTheme = current === 'dark' ? 'light' : 'dark';
            setTheme(newTheme);
            const themeSelect = document.getElementById('themeSelect');
            if (themeSelect) themeSelect.value = newTheme;
            showToast(`Switched to ${newTheme} mode`, 'info');
        }

        // Listen for system theme changes
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
            if (appSettings.theme === 'system') {
                applyTheme('system');
            }
        });

        // =============================================================================
        // SCROLL ANIMATIONS (Intersection Observer)
        // =============================================================================

        function initScrollAnimations() {
            const animatedElements = document.querySelectorAll('[data-animate]');

            if ('IntersectionObserver' in window) {
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            entry.target.classList.add('animated');
                            observer.unobserve(entry.target); // Only trigger once
                        }
                    });
                }, {
                    threshold: 0.1,
                    rootMargin: '0px 0px -50px 0px'
                });

                animatedElements.forEach(el => observer.observe(el));
            } else {
                // Fallback for older browsers
                animatedElements.forEach(el => el.classList.add('animated'));
            }
        }

        // Initialize scroll animations on DOM ready
        document.addEventListener('DOMContentLoaded', initScrollAnimations);

        // =============================================================================
        // STICKY NAVBAR
        // =============================================================================

        function initStickyNavbar() {
            const navbar = document.querySelector('.top-nav');
            if (!navbar) return;

            let lastScrollY = window.scrollY;

            window.addEventListener('scroll', () => {
                const scrollY = window.scrollY;

                if (scrollY > 50) {
                    navbar.classList.add('navbar-scrolled');
                } else {
                    navbar.classList.remove('navbar-scrolled');
                }

                lastScrollY = scrollY;
            }, { passive: true });
        }

        // Initialize sticky navbar on DOM ready
        document.addEventListener('DOMContentLoaded', initStickyNavbar);

        // =============================================================================
        // NAVBAR DROPDOWN & MOBILE MENU
        // =============================================================================

        // Close all dropdown menus
        function closeAllDropdowns() {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                const btn = item.querySelector('.nav-link');
                if (btn) btn.setAttribute('aria-expanded', 'false');
            });
        }

        // Initialize dropdown behavior
        function initNavDropdowns() {
            const navItems = document.querySelectorAll('.nav-item[data-dropdown]');

            navItems.forEach(item => {
                const btn = item.querySelector('.nav-link');
                const dropdown = item.querySelector('.nav-dropdown');

                // Mouse enter - show dropdown
                item.addEventListener('mouseenter', () => {
                    closeAllDropdowns();
                    item.classList.add('active');
                    if (btn) btn.setAttribute('aria-expanded', 'true');
                });

                // Mouse leave - hide dropdown
                item.addEventListener('mouseleave', () => {
                    item.classList.remove('active');
                    if (btn) btn.setAttribute('aria-expanded', 'false');
                });

                // Click toggle for touch devices
                if (btn) {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        const isActive = item.classList.contains('active');
                        closeAllDropdowns();
                        if (!isActive) {
                            item.classList.add('active');
                            btn.setAttribute('aria-expanded', 'true');
                        }
                    });
                }
            });

            // Close dropdowns when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.nav-item')) {
                    closeAllDropdowns();
                }
            });

            // Close dropdowns on Escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeAllDropdowns();
                    closeMobileMenu();
                }
            });
        }

        // Mobile menu functions
        function openMobileMenu() {
            const overlay = document.getElementById('mobileMenuOverlay');
            if (overlay) {
                overlay.classList.add('open');
                document.body.style.overflow = 'hidden';
            }
        }

        function closeMobileMenu() {
            const overlay = document.getElementById('mobileMenuOverlay');
            if (overlay) {
                overlay.classList.remove('open');
                document.body.style.overflow = '';
            }
        }

        function toggleMobileAccordion(name) {
            const accordion = document.querySelector(`.mobile-accordion[data-accordion="${name}"]`);
            if (accordion) {
                accordion.classList.toggle('open');
            }
        }

        // Navigation scroll functions
        function navScrollToSection(sectionId) {
            const sectionMap = {
                'heroSection': '.hero-section',
                'howItWorksSection': '.how-it-works',
                'previewSection': '.preview-section',
                'valuePropsSection': '.value-props',
                'ctaSection': '.cta-section'
            };

            const selector = sectionMap[sectionId] || `#${sectionId}`;
            const section = document.querySelector(selector);

            if (section) {
                section.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        function navScrollToUpload(tabName) {
            // First scroll to the upload widget area
            const uploadCard = document.querySelector('.upload-card');
            if (uploadCard) {
                uploadCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }

            // Then switch to the appropriate tab after a short delay
            setTimeout(() => {
                if (tabName === 'upload') {
                    switchTab('upload');
                } else if (tabName === 'manual') {
                    switchTab('manual');
                } else if (tabName === 'connect') {
                    switchTab('connect');
                }
            }, 300);
        }

        // Initialize navbar dropdowns on DOM ready
        document.addEventListener('DOMContentLoaded', initNavDropdowns);

        // =============================================================================
        // ENHANCED TOAST NOTIFICATION SYSTEM
        // =============================================================================

        const toastIcons = {
            success: `<svg class="toast-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>
            </svg>`,
            error: `<svg class="toast-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/>
            </svg>`,
            warning: `<svg class="toast-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                <line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>
            </svg>`,
            info: `<svg class="toast-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/>
            </svg>`
        };

        let toastQueue = [];
        let activeToasts = 0;
        const MAX_TOASTS = 5;

        function showToast(message, type = 'success', options = {}) {
            if (!appSettings.toastEnabled && type !== 'error') return;

            const {
                title = null,
                duration = 4000,
                dismissible = true,
                showProgress = true,
                action = null
            } = options;

            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}${action ? ' has-action' : ''}`;
            toast.setAttribute('role', 'alert');

            let actionHtml = '';
            if (action) {
                const actionId = 'toast-action-' + Date.now();
                actionHtml = `<button class="toast-action-btn" id="${actionId}">${action.label}</button>`;
                // Store callback to attach after DOM insertion
                toast._actionCallback = action.callback || (action.handler ? new Function(action.handler) : null);
                toast._actionId = actionId;
            }

            toast.innerHTML = `
                ${toastIcons[type] || toastIcons.info}
                <div class="toast-content">
                    ${title ? `<div class="toast-title">${title}</div>` : ''}
                    <div class="toast-message">${message}</div>
                </div>
                ${actionHtml}
                ${dismissible ? `<button class="toast-close" onclick="dismissToast(this.parentElement)" aria-label="Dismiss">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>` : ''}
                ${showProgress && duration > 0 ? `<div class="toast-progress" style="animation-duration: ${duration}ms;"></div>` : ''}
            `;

            // Limit number of toasts
            const existingToasts = container.querySelectorAll('.toast');
            if (existingToasts.length >= MAX_TOASTS) {
                dismissToast(existingToasts[0]);
            }

            container.appendChild(toast);

            // Attach action callback after DOM insertion
            if (toast._actionCallback && toast._actionId) {
                const actionBtn = document.getElementById(toast._actionId);
                if (actionBtn) {
                    actionBtn.addEventListener('click', toast._actionCallback);
                }
            }

            // Trigger animation
            requestAnimationFrame(() => {
                toast.classList.add('show');
            });

            // Announce to screen readers
            announceToScreenReader(message);

            // Auto dismiss
            if (duration > 0) {
                setTimeout(() => {
                    dismissToast(toast);
                }, duration);
            }

            return toast;
        }

        function dismissToast(toast) {
            if (!toast || !toast.parentElement) return;
            toast.classList.remove('show');
            setTimeout(() => {
                toast.remove();
            }, 300);
        }

        // Undo toast helper
        function showUndoToast(message, undoCallback, duration = 5000) {
            const toast = showToast(message, 'info', {
                duration,
                action: {
                    label: 'Undo',
                    handler: `handleUndo()`
                }
            });

            window._pendingUndo = undoCallback;
            toast.classList.add('undo-toast');
            return toast;
        }

        function handleUndo() {
            if (window._pendingUndo) {
                window._pendingUndo();
                window._pendingUndo = null;
                showToast('Action undone', 'success');
            }
        }

        // =============================================================================
        // LOADING STATE MANAGEMENT
        // =============================================================================

        let loadingCount = 0;

        function showLoadingOverlay(text = 'Loading...') {
            loadingCount++;
            const overlay = document.getElementById('loadingOverlay');
            const loadingText = document.getElementById('loadingText');
            if (loadingText) loadingText.textContent = text;
            overlay.classList.add('active');
        }

        function hideLoadingOverlay() {
            loadingCount = Math.max(0, loadingCount - 1);
            if (loadingCount === 0) {
                document.getElementById('loadingOverlay').classList.remove('active');
            }
        }

        // Button loading state
        function setButtonLoading(button, loading, originalText = null) {
            if (loading) {
                button.dataset.originalText = button.textContent;
                button.classList.add('loading');
                button.disabled = true;
            } else {
                button.classList.remove('loading');
                button.disabled = false;
                if (button.dataset.originalText) {
                    button.textContent = button.dataset.originalText;
                }
            }
        }

        // Prevent double clicks
        function preventDoubleClick(button, duration = 1000) {
            button.disabled = true;
            setTimeout(() => {
                button.disabled = false;
            }, duration);
        }

        // =============================================================================
        // FORM VALIDATION
        // =============================================================================

        function validateInput(input, rules = {}) {
            const value = input.value.trim();
            const formGroup = input.closest('.form-group');
            let isValid = true;
            let errorMessage = '';

            // Clear previous state
            formGroup?.classList.remove('has-error', 'has-success');

            // Required check
            if (rules.required && !value) {
                isValid = false;
                errorMessage = rules.requiredMessage || 'This field is required';
            }

            // Min length
            if (isValid && rules.minLength && value.length < rules.minLength) {
                isValid = false;
                errorMessage = `Must be at least ${rules.minLength} characters`;
            }

            // Pattern check
            if (isValid && rules.pattern && !rules.pattern.test(value)) {
                isValid = false;
                errorMessage = rules.patternMessage || 'Invalid format';
            }

            // Custom validator
            if (isValid && rules.custom) {
                const customResult = rules.custom(value);
                if (customResult !== true) {
                    isValid = false;
                    errorMessage = customResult;
                }
            }

            // Update UI
            if (formGroup) {
                formGroup.classList.add(isValid ? 'has-success' : 'has-error');

                // Show/hide inline error
                let errorEl = formGroup.querySelector('.inline-error');
                if (!isValid) {
                    if (!errorEl) {
                        errorEl = document.createElement('div');
                        errorEl.className = 'inline-error';
                        formGroup.appendChild(errorEl);
                    }
                    errorEl.innerHTML = `<svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="10"/></svg> ${errorMessage}`;
                } else if (errorEl) {
                    errorEl.remove();
                }
            }

            return isValid;
        }

        // Symbol validation with auto-uppercase
        function setupSymbolInput(input) {
            input.addEventListener('input', (e) => {
                e.target.value = e.target.value.toUpperCase().replace(/[^A-Z0-9.]/g, '');
            });

            input.addEventListener('blur', (e) => {
                const value = e.target.value.trim();
                if (value) {
                    validateInput(input, {
                        pattern: /^[A-Z]{1,5}(\.[A-Z]{1,2})?$/,
                        patternMessage: 'Enter a valid stock symbol (e.g., AAPL, BRK.B)'
                    });
                }
            });
        }

        // Clear validation on focus
        function setupValidationClearOnFocus(input) {
            input.addEventListener('focus', () => {
                const formGroup = input.closest('.form-group');
                formGroup?.classList.remove('has-error', 'has-success');
                formGroup?.querySelector('.inline-error')?.remove();
            });
        }

        // Shake animation for invalid forms
        function shakeElement(element) {
            element.classList.add('has-error');
            element.style.animation = 'shake 0.5s ease';
            setTimeout(() => {
                element.style.animation = '';
            }, 500);
        }

        // =============================================================================
        // KEYBOARD SHORTCUTS
        // =============================================================================

        const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
        const modKey = isMac ? 'metaKey' : 'ctrlKey';

        function initKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // Ignore if typing in input/textarea
                if (e.target.matches('input, textarea, select')) {
                    // Allow Escape to blur
                    if (e.key === 'Escape') {
                        e.target.blur();
                    }
                    return;
                }

                // ? - Show keyboard shortcuts
                if (e.key === '?' && !e[modKey]) {
                    e.preventDefault();
                    showKeyboardShortcuts();
                    return;
                }

                // Escape - Close modals
                if (e.key === 'Escape') {
                    closeAllModals();
                    return;
                }

                // Ctrl/Cmd shortcuts
                if (e[modKey]) {
                    switch (e.key.toLowerCase()) {
                        case 'u':
                            e.preventDefault();
                            document.getElementById('fileInput')?.click();
                            break;
                        case 'enter':
                            e.preventDefault();
                            const analyzeBtn = document.getElementById('analyzeBtn');
                            const manualBtn = document.getElementById('analyzeManualBtn');
                            if (analyzeBtn && !analyzeBtn.disabled) {
                                analyzeBtn.click();
                            } else if (manualBtn && !manualBtn.disabled) {
                                manualBtn.click();
                            }
                            break;
                        case 'n':
                            e.preventDefault();
                            document.getElementById('newAnalysisBtn')?.click();
                            break;
                        case 'd':
                            e.preventDefault();
                            toggleTheme();
                            break;
                        case ',':
                            e.preventDefault();
                            showSettingsModal();
                            break;
                    }
                }
            });
        }

        function showKeyboardShortcuts() {
            document.getElementById('shortcutsModal').classList.add('active');
            trapFocus(document.getElementById('shortcutsModal').querySelector('.modal'));
        }

        function hideKeyboardShortcuts() {
            document.getElementById('shortcutsModal').classList.remove('active');
        }

        function closeAllModals() {
            document.querySelectorAll('.modal-overlay.active').forEach(modal => {
                modal.classList.remove('active');
            });
        }

        // =============================================================================
        // ACCESSIBILITY - FOCUS MANAGEMENT
        // =============================================================================

        function trapFocus(element) {
            const focusableElements = element.querySelectorAll(
                'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
            );
            const firstFocusable = focusableElements[0];
            const lastFocusable = focusableElements[focusableElements.length - 1];

            firstFocusable?.focus();

            element.addEventListener('keydown', (e) => {
                if (e.key === 'Tab') {
                    if (e.shiftKey) {
                        if (document.activeElement === firstFocusable) {
                            e.preventDefault();
                            lastFocusable?.focus();
                        }
                    } else {
                        if (document.activeElement === lastFocusable) {
                            e.preventDefault();
                            firstFocusable?.focus();
                        }
                    }
                }
            });
        }

        function announceToScreenReader(message) {
            const announcer = document.createElement('div');
            announcer.setAttribute('role', 'status');
            announcer.setAttribute('aria-live', 'polite');
            announcer.className = 'sr-only';
            announcer.textContent = message;
            document.body.appendChild(announcer);
            setTimeout(() => announcer.remove(), 1000);
        }

        // =============================================================================
        // CONNECTION STATUS MONITORING
        // =============================================================================

        let isOnline = navigator.onLine;

        function initConnectionMonitoring() {
            updateConnectionStatus();

            window.addEventListener('online', () => {
                isOnline = true;
                updateConnectionStatus();
                showToast('Connection restored', 'success');
            });

            window.addEventListener('offline', () => {
                isOnline = false;
                updateConnectionStatus();
                showToast('You are offline. Some features may be unavailable.', 'warning', {
                    duration: 0,
                    title: 'No Connection'
                });
            });
        }

        function updateConnectionStatus() {
            const statusEl = document.getElementById('connectionStatus');
            const textEl = document.getElementById('connectionText');

            if (!statusEl || !textEl) return;

            if (isOnline) {
                statusEl.classList.remove('offline');
                textEl.textContent = 'Online';
            } else {
                statusEl.classList.add('offline');
                textEl.textContent = 'Offline';
            }
        }

        // =============================================================================
        // SESSION MANAGEMENT
        // =============================================================================

        let sessionTimeout = null;
        let sessionWarningTimeout = null;
        const SESSION_DURATION = 30 * 60 * 1000; // 30 minutes
        const WARNING_BEFORE = 5 * 60 * 1000; // 5 minutes before expiry

        function startSessionTimer() {
            if (!authToken) return;

            clearTimeout(sessionTimeout);
            clearTimeout(sessionWarningTimeout);

            // Show warning 5 minutes before expiry
            sessionWarningTimeout = setTimeout(() => {
                showSessionWarning();
            }, SESSION_DURATION - WARNING_BEFORE);

            // Session expires
            sessionTimeout = setTimeout(() => {
                handleSessionExpired();
            }, SESSION_DURATION);
        }

        function showSessionWarning() {
            const warningEl = document.getElementById('sessionWarning');
            const timeEl = document.getElementById('sessionTimeLeft');

            if (!warningEl || !timeEl) return;

            warningEl.classList.add('show');

            let timeLeft = WARNING_BEFORE / 1000;
            const interval = setInterval(() => {
                timeLeft--;
                const mins = Math.floor(timeLeft / 60);
                const secs = timeLeft % 60;
                timeEl.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;

                if (timeLeft <= 0) {
                    clearInterval(interval);
                }
            }, 1000);
        }

        function hideSessionWarning() {
            const warningEl = document.getElementById('sessionWarning');
            if (warningEl) warningEl.classList.remove('show');
        }

        function refreshSession() {
            hideSessionWarning();
            startSessionTimer();
            showToast('Session extended', 'success');
        }

        function handleSessionExpired() {
            hideSessionWarning();
            logout();
            showToast('Your session has expired. Please sign in again.', 'warning', {
                title: 'Session Expired',
                duration: 0
            });
        }

        // =============================================================================
        // CONFIRMATION MODAL SYSTEM
        // =============================================================================

        let pendingConfirmCallback = null;

        function showConfirmModal(options = {}) {
            const {
                title = 'Are you sure?',
                message = 'This action cannot be undone.',
                confirmText = 'Confirm',
                confirmClass = 'btn-primary',
                icon = 'danger',
                showDontAsk = false,
                onConfirm = () => {}
            } = options;

            const modal = document.getElementById('confirmModal');
            const titleEl = document.getElementById('confirmTitle');
            const descEl = document.getElementById('confirmDesc');
            const actionBtn = document.getElementById('confirmAction');
            const iconEl = document.getElementById('confirmIcon');
            const checkboxWrapper = document.getElementById('confirmCheckboxWrapper');

            titleEl.textContent = title;
            descEl.textContent = message;
            actionBtn.textContent = confirmText;
            actionBtn.className = `btn ${confirmClass}`;

            iconEl.className = `confirm-icon ${icon}`;
            checkboxWrapper.style.display = showDontAsk ? 'flex' : 'none';

            pendingConfirmCallback = onConfirm;
            actionBtn.onclick = handleConfirm;

            modal.classList.add('active');
            trapFocus(modal.querySelector('.modal'));
        }

        function hideConfirmModal() {
            document.getElementById('confirmModal').classList.remove('active');
            pendingConfirmCallback = null;
        }

        function handleConfirm() {
            const dontAsk = document.getElementById('dontShowAgain')?.checked;
            if (pendingConfirmCallback) {
                pendingConfirmCallback(dontAsk);
            }
            hideConfirmModal();
        }

        // Helper for destructive actions
        function confirmDestructive(message, onConfirm) {
            showConfirmModal({
                title: 'Delete Item?',
                message,
                confirmText: 'Delete',
                confirmClass: 'btn-primary',
                icon: 'danger',
                onConfirm
            });
        }

        // =============================================================================
        // INITIALIZATION
        // =============================================================================

        function initEnterpriseFeatures() {
            // Initialize theme
            initTheme();

            // Initialize keyboard shortcuts
            initKeyboardShortcuts();

            // Initialize connection monitoring
            initConnectionMonitoring();

            // Setup form validation for manual entry
            const symbolInput = document.getElementById('manualSymbol');
            if (symbolInput) {
                setupSymbolInput(symbolInput);
                setupValidationClearOnFocus(symbolInput);
            }

            const whatifSymbol = document.getElementById('whatifAddSymbol');
            if (whatifSymbol) {
                setupSymbolInput(whatifSymbol);
            }

            // Start session timer if logged in
            if (authToken) {
                startSessionTimer();
            }

            // Load settings
            loadSettings();

            console.log('Enterprise features initialized');
        }

        // Run initialization when DOM is ready
        document.addEventListener('DOMContentLoaded', initEnterpriseFeatures);

        // =============================================================================
        // ONBOARDING TUTORIAL
        // =============================================================================

        const onboardingSteps = [
            {
                title: 'Welcome to Statement Scan',
                text: 'Upload your brokerage statements and get instant portfolio analytics, benchmarking, and AI-powered insights.',
                icon: 'upload'
            },
            {
                title: 'Multiple Ways to Add Data',
                text: 'Upload PDF/CSV files, enter holdings manually, or connect your brokerage account directly with Plaid.',
                icon: 'options'
            },
            {
                title: 'Comprehensive Analysis',
                text: 'Get detailed breakdowns of your allocation, sector exposure, geographic diversification, and risk metrics.',
                icon: 'chart'
            },
            {
                title: 'Track & Compare',
                text: 'Save portfolios, set price alerts, compare different allocations, and run what-if scenarios.',
                icon: 'compare'
            }
        ];

        let currentOnboardingStep = 0;

        function showOnboarding() {
            if (localStorage.getItem('onboardingComplete')) return;
            document.getElementById('onboardingOverlay').classList.add('active');
            updateOnboardingStep();
        }

        function updateOnboardingStep() {
            const step = onboardingSteps[currentOnboardingStep];
            document.getElementById('onboardingTitle').textContent = step.title;
            document.getElementById('onboardingText').textContent = step.text;

            // Update step indicators
            document.querySelectorAll('.onboarding-step').forEach((el, i) => {
                el.classList.toggle('active', i === currentOnboardingStep);
            });

            // Update button text
            const nextBtn = document.getElementById('onboardingNext');
            nextBtn.textContent = currentOnboardingStep === onboardingSteps.length - 1 ? 'Get Started' : 'Next';
        }

        function nextOnboardingStep() {
            if (currentOnboardingStep < onboardingSteps.length - 1) {
                currentOnboardingStep++;
                updateOnboardingStep();
            } else {
                skipOnboarding();
            }
        }

        function skipOnboarding() {
            localStorage.setItem('onboardingComplete', 'true');
            document.getElementById('onboardingOverlay').classList.remove('active');
        }

        // Show onboarding for new users
        setTimeout(() => {
            if (!localStorage.getItem('onboardingComplete') && !localStorage.getItem('authToken')) {
                showOnboarding();
            }
        }, 1000);

        // =============================================================================
        // DRAG AND DROP FOR HOLDINGS
        // =============================================================================

        let draggedItem = null;

        function initDragAndDrop() {
            const holdingsList = document.getElementById('manualHoldingsList');
            if (!holdingsList) return;

            holdingsList.addEventListener('dragstart', handleDragStart);
            holdingsList.addEventListener('dragend', handleDragEnd);
            holdingsList.addEventListener('dragover', handleDragOver);
            holdingsList.addEventListener('drop', handleDrop);
        }

        function handleDragStart(e) {
            if (!e.target.classList.contains('holdings-list-item')) return;
            draggedItem = e.target;
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragEnd(e) {
            if (draggedItem) {
                draggedItem.classList.remove('dragging');
                draggedItem = null;
            }
            document.querySelectorAll('.drop-indicator').forEach(el => el.classList.remove('active'));
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        }

        function handleDrop(e) {
            e.preventDefault();
            if (!draggedItem) return;

            const target = e.target.closest('.holdings-list-item');
            if (target && target !== draggedItem) {
                const items = [...document.querySelectorAll('.holdings-list-item')];
                const draggedIndex = items.indexOf(draggedItem);
                const targetIndex = items.indexOf(target);

                // Reorder the manualHoldings array
                const [removed] = manualHoldings.splice(draggedIndex, 1);
                manualHoldings.splice(targetIndex, 0, removed);

                renderManualHoldings();
            }
        }

        // =============================================================================
        // QUICK ACTIONS & RECENT PORTFOLIOS
        // =============================================================================

        function getRecentPortfolios() {
            return JSON.parse(localStorage.getItem('recentPortfolios') || '[]');
        }

        function addToRecentPortfolios(portfolio) {
            let recent = getRecentPortfolios();
            // Remove if already exists
            recent = recent.filter(p => p.id !== portfolio.id);
            // Add to front
            recent.unshift({
                id: portfolio.id,
                name: portfolio.name,
                value: portfolio.total_value,
                date: new Date().toISOString()
            });
            // Keep only last 5
            recent = recent.slice(0, 5);
            localStorage.setItem('recentPortfolios', JSON.stringify(recent));
        }

        function clearRecentPortfolios() {
            localStorage.removeItem('recentPortfolios');
            renderRecentPortfolios();
        }

        function renderRecentPortfolios() {
            const container = document.getElementById('recentPortfoliosContainer');
            if (!container) return;

            const recent = getRecentPortfolios();
            if (recent.length === 0) {
                container.style.display = 'none';
                return;
            }

            container.style.display = 'block';
            const list = container.querySelector('.recent-list');
            list.innerHTML = recent.map(p => `
                <div class="recent-item" onclick="loadPortfolio(${p.id})">
                    <div class="recent-item-icon">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                        </svg>
                    </div>
                    <div class="recent-item-info">
                        <div class="recent-item-name">${escapeHtml(p.name)}</div>
                        <div class="recent-item-meta">${formatCurrency(p.value)}</div>
                    </div>
                </div>
            `).join('');
        }

        // =============================================================================
        // DIVIDEND TRACKING
        // =============================================================================

        function renderDividendTab() {
            if (!portfolioData || !portfolioData.positions) return;

            const positions = portfolioData.positions;
            let totalAnnualDividend = 0;
            const dividendHoldings = [];
            const monthlyDividends = Array(12).fill(0);

            // Calculate dividends (simulated - in production would use real dividend data)
            // Known dividend yields for common stocks/ETFs
            const knownDividendYields = {
                // Large cap stocks
                'AAPL': 0.005, 'MSFT': 0.008, 'JNJ': 0.03, 'KO': 0.03, 'PG': 0.025,
                'PEP': 0.027, 'VZ': 0.065, 'T': 0.065, 'XOM': 0.035, 'CVX': 0.04,
                'JPM': 0.022, 'BAC': 0.025, 'WFC': 0.027, 'C': 0.035, 'GS': 0.023,
                'HD': 0.022, 'MCD': 0.021, 'WMT': 0.013, 'COST': 0.006, 'DIS': 0.008,
                // Dividend ETFs
                'VYM': 0.03, 'SCHD': 0.035, 'VIG': 0.02, 'DVY': 0.035, 'HDV': 0.04,
                'SPYD': 0.045, 'VNQ': 0.04, 'O': 0.055, 'JEPI': 0.08, 'JEPQ': 0.09,
                // Index ETFs
                'SPY': 0.013, 'VOO': 0.013, 'VTI': 0.014, 'QQQ': 0.006, 'IVV': 0.013,
                'DIA': 0.016, 'RSP': 0.015, 'SPLG': 0.013, 'SPTM': 0.014,
                // Bond ETFs - Treasury
                'SGOV': 0.05, 'SHV': 0.05, 'BIL': 0.05, 'SCHO': 0.045, 'VGSH': 0.045,
                'SHY': 0.04, 'IEF': 0.038, 'TLT': 0.04, 'GOVT': 0.04, 'VGIT': 0.04,
                // Bond ETFs - Corporate/Aggregate
                'BND': 0.04, 'AGG': 0.04, 'BNDX': 0.035, 'LQD': 0.045, 'VCIT': 0.04,
                'HYG': 0.055, 'JNK': 0.06, 'VCSH': 0.04, 'BSV': 0.035, 'MUB': 0.03,
                // International
                'VXUS': 0.03, 'VEA': 0.03, 'VWO': 0.035, 'IEMG': 0.025, 'EFA': 0.025
            };

            positions.forEach(p => {
                // Use actual dividend_yield if available, then known yields, then estimate
                let estimatedYield = 0;
                const symbol = (p.symbol || '').toUpperCase();

                // First check if position has dividend_yield from API
                if (p.dividend_yield && p.dividend_yield > 0) {
                    estimatedYield = p.dividend_yield / 100; // Convert from percentage
                }
                // Check known dividend yields
                else if (knownDividendYields[symbol]) {
                    estimatedYield = knownDividendYields[symbol];
                }
                // Fall back to asset class/sector estimation
                else if (p.asset_class === 'Fixed Income' || symbol.includes('BND') || symbol.includes('AGG')) {
                    estimatedYield = 0.04;
                } else if (p.asset_class === 'Equity' || !p.asset_class) {
                    // Default: treat as equity if no asset_class (common for manual entries)
                    if (p.sector === 'Utilities') estimatedYield = 0.035;
                    else if (p.sector === 'Real Estate') estimatedYield = 0.04;
                    else if (p.sector === 'Consumer Staples') estimatedYield = 0.025;
                    else if (p.sector === 'Financial Services') estimatedYield = 0.03;
                    else if (p.sector === 'Energy') estimatedYield = 0.035;
                    else estimatedYield = 0.015; // Default equity yield
                }

                if (estimatedYield > 0) {
                    const annualDiv = p.value * estimatedYield;
                    totalAnnualDividend += annualDiv;
                    dividendHoldings.push({
                        symbol: p.symbol,
                        name: p.description || p.symbol,
                        yield: estimatedYield,
                        annualPerShare: (p.price * estimatedYield).toFixed(2),
                        annualIncome: annualDiv,
                        frequency: 'Quarterly'
                    });

                    // Distribute to months (quarterly)
                    [2, 5, 8, 11].forEach(month => {
                        monthlyDividends[month] += annualDiv / 4;
                    });
                }
            });

            // Update summary stats
            document.getElementById('annualDividend').textContent = formatCurrency(totalAnnualDividend);
            document.getElementById('dividendYield').textContent = ((totalAnnualDividend / portfolioData.total_value) * 100).toFixed(2) + '% yield';
            document.getElementById('monthlyDividend').textContent = formatCurrency(totalAnnualDividend / 12);

            // Render calendar
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const currentMonth = new Date().getMonth();
            document.getElementById('dividendCalendar').innerHTML = months.map((month, i) => `
                <div class="dividend-month ${i === currentMonth ? 'current' : ''}">
                    <div class="dividend-month-name">${month}</div>
                    <div class="dividend-month-amount">${formatCurrency(monthlyDividends[i])}</div>
                </div>
            `).join('');

            // Render holdings table
            document.getElementById('dividendHoldings').innerHTML = dividendHoldings
                .sort((a, b) => b.annualIncome - a.annualIncome)
                .map(h => `
                    <tr>
                        <td class="symbol-cell">${h.symbol}</td>
                        <td>${h.name}</td>
                        <td class="text-right">${(h.yield * 100).toFixed(2)}%</td>
                        <td class="text-right">$${h.annualPerShare}</td>
                        <td class="text-right font-mono">${formatCurrency(h.annualIncome)}</td>
                        <td>${h.frequency}</td>
                    </tr>
                `).join('') || '<tr><td colspan="6" class="text-center">No dividend-paying holdings</td></tr>';
        }

        // =============================================================================
        // TAX LOT TRACKING
        // =============================================================================

        function renderTaxTab() {
            if (!portfolioData || !portfolioData.positions) return;

            const positions = portfolioData.positions;
            let totalCostBasis = 0;
            let unrealizedGains = 0;
            let unrealizedLosses = 0;
            const taxLots = [];

            positions.forEach(p => {
                // Simulate cost basis (random purchase date and price variation)
                const purchaseDate = new Date();
                purchaseDate.setMonth(purchaseDate.getMonth() - Math.floor(Math.random() * 36));
                const costBasisPerShare = p.price * (0.7 + Math.random() * 0.6); // 30% from current
                const costBasis = costBasisPerShare * p.shares;
                const gainLoss = p.value - costBasis;

                totalCostBasis += costBasis;
                if (gainLoss > 0) unrealizedGains += gainLoss;
                else unrealizedLosses += Math.abs(gainLoss);

                const isLongTerm = (new Date() - purchaseDate) > (365 * 24 * 60 * 60 * 1000);

                taxLots.push({
                    symbol: p.symbol,
                    acquired: purchaseDate.toLocaleDateString('en-US', { month: 'short', year: 'numeric' }),
                    term: isLongTerm ? 'Long' : 'Short',
                    shares: p.shares,
                    costBasis: costBasis,
                    currentValue: p.value,
                    gainLoss: gainLoss,
                    gainLossPct: ((gainLoss / costBasis) * 100)
                });
            });

            document.getElementById('totalCostBasis').textContent = formatCurrency(totalCostBasis);
            document.getElementById('unrealizedGains').textContent = '+' + formatCurrency(unrealizedGains);
            document.getElementById('unrealizedLosses').textContent = '-' + formatCurrency(unrealizedLosses);

            const netUnrealized = unrealizedGains - unrealizedLosses;
            const netEl = document.getElementById('netUnrealized');
            netEl.textContent = (netUnrealized >= 0 ? '+' : '') + formatCurrency(netUnrealized);
            netEl.className = 'tax-summary-value ' + (netUnrealized >= 0 ? 'tax-lot-gain' : 'tax-lot-loss');

            // Tax loss harvesting opportunities
            const lossOpportunities = taxLots.filter(t => t.gainLoss < 0).sort((a, b) => a.gainLoss - b.gainLoss);
            document.getElementById('taxLossOpportunities').innerHTML = lossOpportunities.length > 0 ?
                lossOpportunities.slice(0, 5).map(t => `
                    <div class="rebalance-trade-item">
                        <span class="rebalance-trade-action sell">Loss</span>
                        <span class="rebalance-trade-symbol">${t.symbol}</span>
                        <span style="flex: 1;">${t.shares.toFixed(2)} shares</span>
                        <span class="tax-lot-loss">${formatCurrency(t.gainLoss)}</span>
                    </div>
                `).join('') :
                '<p style="color: var(--text-muted);">No tax loss harvesting opportunities found.</p>';

            // All tax lots table
            document.getElementById('taxLotsBody').innerHTML = taxLots.map(t => `
                <tr>
                    <td class="symbol-cell">${t.symbol}</td>
                    <td>${t.acquired}</td>
                    <td><span class="badge ${t.term === 'Long' ? 'badge-primary' : 'badge-secondary'}">${t.term}</span></td>
                    <td class="text-right font-mono">${t.shares.toFixed(4)}</td>
                    <td class="text-right font-mono">${formatCurrency(t.costBasis)}</td>
                    <td class="text-right font-mono">${formatCurrency(t.currentValue)}</td>
                    <td class="text-right font-mono ${t.gainLoss >= 0 ? 'tax-lot-gain' : 'tax-lot-loss'}">
                        ${t.gainLoss >= 0 ? '+' : ''}${formatCurrency(t.gainLoss)}
                    </td>
                    <td class="text-right font-mono ${t.gainLoss >= 0 ? 'tax-lot-gain' : 'tax-lot-loss'}">
                        ${t.gainLossPct >= 0 ? '+' : ''}${t.gainLossPct.toFixed(1)}%
                    </td>
                </tr>
            `).join('');
        }

        // =============================================================================
        // PORTFOLIO ALERTS
        // =============================================================================

        let portfolioAlerts = JSON.parse(localStorage.getItem('portfolioAlerts') || '[]');

        function showAddAlertModal() {
            const select = document.getElementById('alertSymbol');
            if (portfolioData && portfolioData.positions) {
                select.innerHTML = '<option value="">Select a holding...</option>' +
                    portfolioData.positions.map(p => `<option value="${p.symbol}">${p.symbol} - ${formatCurrency(p.price)}</option>`).join('');
            }
            document.getElementById('addAlertModal').classList.add('active');
        }

        function hideAddAlertModal() {
            document.getElementById('addAlertModal').classList.remove('active');
        }

        function createAlert(event) {
            event.preventDefault();
            const symbol = document.getElementById('alertSymbol').value;
            const condition = document.getElementById('alertCondition').value;
            const value = parseFloat(document.getElementById('alertValue').value);

            if (!symbol || !condition || isNaN(value)) return;

            const position = portfolioData.positions.find(p => p.symbol === symbol);
            const alert = {
                id: Date.now(),
                symbol,
                condition,
                value,
                currentPrice: position?.price || 0,
                created: new Date().toISOString(),
                enabled: true
            };

            portfolioAlerts.push(alert);
            localStorage.setItem('portfolioAlerts', JSON.stringify(portfolioAlerts));

            hideAddAlertModal();
            renderAlerts();
            showToast(`Alert created for ${symbol}`, 'success');
        }

        function deleteAlert(alertId) {
            portfolioAlerts = portfolioAlerts.filter(a => a.id !== alertId);
            localStorage.setItem('portfolioAlerts', JSON.stringify(portfolioAlerts));
            renderAlerts();
        }

        function toggleAlert(alertId) {
            const alert = portfolioAlerts.find(a => a.id === alertId);
            if (alert) {
                alert.enabled = !alert.enabled;
                localStorage.setItem('portfolioAlerts', JSON.stringify(portfolioAlerts));
                renderAlerts();
            }
        }

        function renderAlerts() {
            const container = document.getElementById('alertsList');
            const emptyState = document.getElementById('alertsEmptyState');

            if (portfolioAlerts.length === 0) {
                container.innerHTML = '';
                container.appendChild(emptyState.cloneNode(true)).style.display = 'block';
                return;
            }

            container.innerHTML = portfolioAlerts.map(a => {
                const conditionText = {
                    'above': `above $${a.value}`,
                    'below': `below $${a.value}`,
                    'change_up': `increases by ${a.value}%`,
                    'change_down': `decreases by ${a.value}%`
                }[a.condition];

                return `
                    <div class="alert-item">
                        <div class="alert-icon ${a.condition.includes('up') || a.condition === 'above' ? 'price-up' : 'price-down'}">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                ${a.condition.includes('up') || a.condition === 'above' ?
                                    '<polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/>' :
                                    '<polyline points="23 18 13.5 8.5 8.5 13.5 1 6"/><polyline points="17 18 23 18 23 12"/>'}
                            </svg>
                        </div>
                        <div class="alert-content">
                            <div class="alert-title">${a.symbol} ${conditionText}</div>
                            <div class="alert-desc">Current: ${formatCurrency(a.currentPrice)}</div>
                        </div>
                        <div class="alert-toggle">
                            <label class="toggle-switch">
                                <input type="checkbox" ${a.enabled ? 'checked' : ''} onchange="toggleAlert(${a.id})">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <button class="btn-remove" onclick="deleteAlert(${a.id})">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                            </svg>
                        </button>
                    </div>
                `;
            }).join('');
        }

        // =============================================================================
        // PORTFOLIO SNAPSHOTS
        // =============================================================================

        let portfolioSnapshots = JSON.parse(localStorage.getItem('portfolioSnapshots') || '[]');

        function saveSnapshot() {
            if (!portfolioData) {
                showToast('No portfolio to snapshot', 'error');
                return;
            }

            const snapshot = {
                id: Date.now(),
                date: new Date().toISOString(),
                totalValue: portfolioData.total_value,
                positions: portfolioData.positions.length,
                allocation: {
                    stocks: portfolioData.allocation?.stocks || 0,
                    bonds: portfolioData.allocation?.bonds || 0,
                    cash: portfolioData.allocation?.cash || 0
                }
            };

            portfolioSnapshots.unshift(snapshot);
            portfolioSnapshots = portfolioSnapshots.slice(0, 20); // Keep last 20
            localStorage.setItem('portfolioSnapshots', JSON.stringify(portfolioSnapshots));

            renderSnapshots();
            showToast('Snapshot saved', 'success');
        }

        function renderSnapshots() {
            const container = document.getElementById('snapshotTimeline');
            if (!container) return;

            if (portfolioSnapshots.length === 0) {
                container.innerHTML = '<div class="empty-state" style="padding: 24px;"><p>No snapshots yet. Save your first snapshot to start tracking.</p></div>';
                return;
            }

            container.innerHTML = portfolioSnapshots.map((s, i) => {
                const prevValue = portfolioSnapshots[i + 1]?.totalValue;
                const change = prevValue ? ((s.totalValue - prevValue) / prevValue) * 100 : null;

                return `
                    <div class="snapshot-item">
                        <div class="snapshot-date">${new Date(s.date).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}</div>
                        <div class="snapshot-value">${formatCurrency(s.totalValue)}</div>
                        ${change !== null ? `
                            <div class="snapshot-change ${change >= 0 ? 'positive' : 'negative'}">
                                ${change >= 0 ? '' : ''} ${Math.abs(change).toFixed(2)}% from previous
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        // =============================================================================
        // EXPORT FUNCTIONS
        // =============================================================================

        function showExportModal() {
            document.getElementById('exportModal').classList.add('active');

            // Show/hide redacted statement section based on available PDFs
            const redactedSection = document.getElementById('exportRedactedSection');
            if (redactedSection) {
                const hasPdfFiles = uploadedFiles.some(f => f.type === 'pdf' && f.bytes);
                redactedSection.style.display = hasPdfFiles ? '' : 'none';
            }
        }

        function hideExportModal() {
            document.getElementById('exportModal').classList.remove('active');
        }

        function exportToPDF() {
            hideExportModal();
            generateProfessionalReport();
        }

        function exportToCSV() {
            hideExportModal();
            document.getElementById('downloadCsvBtn').click();
        }

        function exportToExcel() {
            if (!portfolioData || !portfolioData.positions) {
                showToast('No portfolio data to export', 'error');
                return;
            }

            // Create Excel-compatible XML
            let xml = '<?xml version="1.0"?><?mso-application progid="Excel.Sheet"?>';
            xml += '<Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet" xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet">';

            // Holdings sheet
            xml += '<Worksheet ss:Name="Holdings"><Table>';
            xml += '<Row><Cell><Data ss:Type="String">Symbol</Data></Cell><Cell><Data ss:Type="String">Description</Data></Cell><Cell><Data ss:Type="String">Shares</Data></Cell><Cell><Data ss:Type="String">Price</Data></Cell><Cell><Data ss:Type="String">Value</Data></Cell><Cell><Data ss:Type="String">Weight</Data></Cell></Row>';
            portfolioData.positions.forEach(p => {
                xml += `<Row><Cell><Data ss:Type="String">${p.symbol}</Data></Cell><Cell><Data ss:Type="String">${p.description || ''}</Data></Cell><Cell><Data ss:Type="Number">${p.shares}</Data></Cell><Cell><Data ss:Type="Number">${p.price}</Data></Cell><Cell><Data ss:Type="Number">${p.value}</Data></Cell><Cell><Data ss:Type="Number">${p.weight}</Data></Cell></Row>`;
            });
            xml += '</Table></Worksheet>';

            // Summary sheet
            xml += '<Worksheet ss:Name="Summary"><Table>';
            xml += `<Row><Cell><Data ss:Type="String">Total Value</Data></Cell><Cell><Data ss:Type="Number">${portfolioData.total_value}</Data></Cell></Row>`;
            xml += `<Row><Cell><Data ss:Type="String">Positions</Data></Cell><Cell><Data ss:Type="Number">${portfolioData.positions.length}</Data></Cell></Row>`;
            xml += '</Table></Worksheet>';

            xml += '</Workbook>';

            const blob = new Blob([xml], { type: 'application/vnd.ms-excel' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'portfolio_export.xls';
            a.click();
            URL.revokeObjectURL(url);

            hideExportModal();
            showToast('Excel file downloaded', 'success');
        }

        function exportToJSON() {
            if (!portfolioData) {
                showToast('No portfolio data to export', 'error');
                return;
            }

            const json = JSON.stringify(portfolioData, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'portfolio_export.json';
            a.click();
            URL.revokeObjectURL(url);

            hideExportModal();
            showToast('JSON file downloaded', 'success');
        }

        // =============================================================================
        // IMPORT FUNCTIONS
        // =============================================================================

        function showImportModal() {
            document.getElementById('importModal').classList.add('active');
        }

        function hideImportModal() {
            document.getElementById('importModal').classList.remove('active');
        }

        function downloadTemplate(type) {
            let csv = '';
            if (type === 'basic') {
                csv = 'Symbol,Shares,Price\nAAPL,100,150.00\nMSFT,50,300.00\nGOOGL,25,140.00';
            } else if (type === 'detailed') {
                csv = 'Symbol,Shares,Price,Cost Basis,Purchase Date\nAAPL,100,150.00,14000.00,2023-01-15\nMSFT,50,300.00,13500.00,2023-03-20';
            } else if (type === 'schwab') {
                csv = 'Symbol,Description,Quantity,Price,Market Value,Day Change %,Day Change $\nAAPL,APPLE INC,100,150.00,15000.00,1.5%,$220.50';
            }

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `portfolio_template_${type}.csv`;
            a.click();
            URL.revokeObjectURL(url);

            showToast('Template downloaded', 'success');
        }

        function handleImportFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const text = e.target.result;
                    const lines = text.split('\n').filter(l => l.trim());
                    const headers = lines[0].toLowerCase().split(',').map(h => h.trim());

                    const symbolIndex = headers.findIndex(h => h.includes('symbol') || h.includes('ticker'));
                    const sharesIndex = headers.findIndex(h => h.includes('shares') || h.includes('quantity') || h.includes('qty'));
                    const priceIndex = headers.findIndex(h => h.includes('price'));

                    if (symbolIndex === -1 || sharesIndex === -1) {
                        showToast('Invalid file format. Need Symbol and Shares columns.', 'error');
                        return;
                    }

                    manualHoldings = [];
                    for (let i = 1; i < lines.length; i++) {
                        const cols = lines[i].split(',').map(c => c.trim().replace(/["\$]/g, ''));
                        const symbol = cols[symbolIndex]?.toUpperCase();
                        const shares = parseFloat(cols[sharesIndex]);
                        const price = priceIndex >= 0 ? parseFloat(cols[priceIndex]) : 100;

                        if (symbol && !isNaN(shares) && shares > 0) {
                            manualHoldings.push({
                                symbol,
                                shares,
                                price: isNaN(price) ? 100 : price,
                                value: shares * (isNaN(price) ? 100 : price),
                                description: symbol
                            });
                        }
                    }

                    if (manualHoldings.length > 0) {
                        hideImportModal();
                        switchEntryMethod('manual');
                        renderManualHoldings();
                        showToast(`Imported ${manualHoldings.length} holdings`, 'success');
                    } else {
                        showToast('No valid holdings found in file', 'error');
                    }
                } catch (err) {
                    showToast('Error parsing file: ' + err.message, 'error');
                }
            };
            reader.readAsText(file);
        }

        // =============================================================================
        // SHARE PORTFOLIO
        // =============================================================================

        function showShareModal() {
            document.getElementById('shareModal').classList.add('active');
            updateShareLink();
        }

        function hideShareModal() {
            document.getElementById('shareModal').classList.remove('active');
        }

        function updateShareLink() {
            const hideValues = document.getElementById('shareHideValues')?.checked;
            // In production, this would generate a real shareable link
            const shareData = btoa(JSON.stringify({
                positions: portfolioData?.positions?.map(p => ({
                    symbol: p.symbol,
                    weight: p.weight,
                    value: hideValues ? null : p.value
                })),
                hideValues
            }));
            document.getElementById('shareLink').value = `${window.location.origin}/share/${shareData.slice(0, 20)}...`;
        }

        function copyShareLink() {
            const input = document.getElementById('shareLink');
            input.select();
            document.execCommand('copy');
            showToast('Link copied to clipboard', 'success');
        }

        function shareViaEmail() {
            const subject = encodeURIComponent('Check out my portfolio analysis');
            const body = encodeURIComponent(`I analyzed my portfolio using Statement Scan. Check it out: ${document.getElementById('shareLink').value}`);
            window.open(`mailto:?subject=${subject}&body=${body}`);
        }

        function shareViaTwitter() {
            const text = encodeURIComponent('I just analyzed my investment portfolio with @StatementScan');
            window.open(`https://twitter.com/intent/tweet?text=${text}`);
        }

        function shareViaLinkedIn() {
            const url = encodeURIComponent(document.getElementById('shareLink').value);
            window.open(`https://www.linkedin.com/sharing/share-offsite/?url=${url}`);
        }

        // =============================================================================
        // PWA SUPPORT
        // =============================================================================

        let deferredPrompt = null;

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            // Show install prompt after a delay if user hasn't dismissed it
            if (!localStorage.getItem('pwaPromptDismissed')) {
                setTimeout(() => {
                    document.getElementById('pwaInstallPrompt')?.classList.add('show');
                }, 30000); // Show after 30 seconds
            }
        });

        function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        showToast('App installed successfully!', 'success');
                    }
                    deferredPrompt = null;
                    document.getElementById('pwaInstallPrompt')?.classList.remove('show');
                });
            }
        }

        function dismissPWAPrompt() {
            localStorage.setItem('pwaPromptDismissed', 'true');
            document.getElementById('pwaInstallPrompt')?.classList.remove('show');
        }

        // =============================================================================
        // ENHANCED DASHBOARD RENDERING
        // =============================================================================

        // Override or extend showDashboard to include new tabs
        const originalShowDashboard = typeof showDashboard === 'function' ? showDashboard : null;

        function enhancedShowDashboard() {
            if (originalShowDashboard) {
                // Call original if it exists
            }

            // Render new tabs
            setTimeout(() => {
                renderDividendTab();
                renderTaxTab();
                renderAlerts();
                renderSnapshots();
            }, 100);
        }

        // Hook into tab switching to render new tabs
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('tab')) {
                const tab = e.target.dataset.tab;
                if (tab === 'dividends') renderDividendTab();
                else if (tab === 'tax') renderTaxTab();
                else if (tab === 'alerts') {
                    renderAlerts();
                    renderSnapshots();
                }
            }
        });

        // =============================================================================
        // LANDING PAGE FUNCTIONS
        // =============================================================================

        function scrollToUpload() {
            const uploadSection = document.getElementById('uploadSection');
            if (uploadSection) {
                uploadSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
                // Add a subtle highlight effect
                uploadSection.style.transition = 'box-shadow 0.3s ease';
                uploadSection.style.boxShadow = '0 0 0 4px rgba(99, 91, 255, 0.3)';
                setTimeout(() => {
                    uploadSection.style.boxShadow = '';
                }, 1500);
            }
        }

        function hideLandingSections() {
            const landingSections = document.getElementById('landingSections');
            if (landingSections) {
                landingSections.style.display = 'none';
            }
        }

        function showLandingSections() {
            const landingSections = document.getElementById('landingSections');
            if (landingSections) {
                landingSections.style.display = 'block';
            }
        }

        // FAQ Accordion Toggle
        function toggleFaq(button) {
            const item = button.closest('.faq-item');
            const isActive = item.classList.contains('active');

            // Close all other FAQ items
            document.querySelectorAll('.faq-item.active').forEach(activeItem => {
                if (activeItem !== item) {
                    activeItem.classList.remove('active');
                }
            });

            // Toggle current item
            item.classList.toggle('active', !isActive);
        }

        // =============================================================================
        // AUTHENTICATION
        // =============================================================================

        function showAuthModal() {
            document.getElementById('authModal').classList.add('active');
        }

        function hideAuthModal() {
            document.getElementById('authModal').classList.remove('active');
            document.getElementById('loginError').style.display = 'none';
            document.getElementById('registerError').style.display = 'none';
        }

        function switchAuthTab(tab) {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
            document.querySelector(`.auth-tab[data-tab="${tab}"]`).classList.add('active');
            document.getElementById(tab === 'login' ? 'loginForm' : 'registerForm').classList.add('active');
        }

        async function handleLogin(event) {
            event.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const errorEl = document.getElementById('loginError');

            try {
                const res = await fetch(`${API_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await res.json();

                if (!res.ok) {
                    errorEl.textContent = data.error || 'Login failed';
                    errorEl.style.display = 'block';
                    return;
                }

                authToken = data.access_token;
                currentUser = data.user;
                localStorage.setItem('authToken', authToken);
                hideAuthModal();
                updateAuthUI();
                // Redirect to app after successful login
                window.location.href = '/app';
            } catch (err) {
                errorEl.textContent = 'Connection error. Please try again.';
                errorEl.style.display = 'block';
            }
        }

        async function handleRegister(event) {
            event.preventDefault();
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const errorEl = document.getElementById('registerError');

            try {
                const res = await fetch(`${API_URL}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, email, password })
                });

                const data = await res.json();

                if (!res.ok) {
                    errorEl.textContent = data.error || 'Registration failed';
                    errorEl.style.display = 'block';
                    return;
                }

                authToken = data.access_token;
                currentUser = data.user;
                localStorage.setItem('authToken', authToken);
                hideAuthModal();
                updateAuthUI();
                // Redirect to app after successful registration
                window.location.href = '/app';
            } catch (err) {
                errorEl.textContent = 'Connection error. Please try again.';
                errorEl.style.display = 'block';
            }
        }

        function logout() {
            authToken = null;
            currentUser = null;
            localStorage.removeItem('authToken');
            updateAuthUI();
            document.getElementById('savedPortfoliosSection').style.display = 'none';
        }

        function showForgotPassword(event) {
            event.preventDefault();
            document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.getElementById('forgotPasswordForm').classList.add('active');
            document.getElementById('forgotError').style.display = 'none';
            document.getElementById('forgotSuccess').style.display = 'none';
        }

        function backToLogin(event) {
            event.preventDefault();
            document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
            document.getElementById('loginForm').classList.add('active');
            document.querySelector('.auth-tab[data-tab="login"]').classList.add('active');
        }

        async function handleForgotPassword(event) {
            event.preventDefault();
            const email = document.getElementById('forgotEmail').value;
            const errorEl = document.getElementById('forgotError');
            const successEl = document.getElementById('forgotSuccess');
            const submitBtn = event.target.querySelector('button[type="submit"]');

            errorEl.style.display = 'none';
            successEl.style.display = 'none';
            submitBtn.disabled = true;
            submitBtn.textContent = 'Sending...';

            try {
                const res = await fetch(`${API_URL}/auth/forgot-password`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });

                const data = await res.json();

                if (!res.ok) {
                    errorEl.textContent = data.error || 'Failed to send reset link';
                    errorEl.style.display = 'block';
                } else {
                    successEl.textContent = data.message || 'If an account exists with that email, a reset link has been sent.';
                    successEl.style.display = 'block';
                    document.getElementById('forgotEmail').value = '';
                }
            } catch (err) {
                errorEl.textContent = 'Connection error. Please try again.';
                errorEl.style.display = 'block';
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Send Reset Link';
            }
        }

        function showResetPasswordModal(token) {
            resetToken = token;
            document.getElementById('resetPasswordModal').classList.add('active');
            document.getElementById('resetError').style.display = 'none';
            document.getElementById('resetSuccess').style.display = 'none';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
        }

        function hideResetPasswordModal() {
            document.getElementById('resetPasswordModal').classList.remove('active');
            // Clear reset token from URL
            const url = new URL(window.location);
            url.searchParams.delete('reset_token');
            window.history.replaceState({}, '', url);
        }

        async function handleResetPassword(event) {
            event.preventDefault();
            const password = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const errorEl = document.getElementById('resetError');
            const successEl = document.getElementById('resetSuccess');
            const submitBtn = event.target.querySelector('button[type="submit"]');

            errorEl.style.display = 'none';
            successEl.style.display = 'none';

            if (password !== confirmPassword) {
                errorEl.textContent = 'Passwords do not match';
                errorEl.style.display = 'block';
                return;
            }

            if (password.length < 6) {
                errorEl.textContent = 'Password must be at least 6 characters';
                errorEl.style.display = 'block';
                return;
            }

            submitBtn.disabled = true;
            submitBtn.textContent = 'Resetting...';

            try {
                const res = await fetch(`${API_URL}/auth/reset-password`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token: resetToken, password })
                });

                const data = await res.json();

                if (!res.ok) {
                    errorEl.textContent = data.error || 'Failed to reset password';
                    errorEl.style.display = 'block';
                } else {
                    successEl.textContent = data.message || 'Password reset successfully! You can now sign in.';
                    successEl.style.display = 'block';
                    submitBtn.style.display = 'none';

                    // Auto-close and show login after 3 seconds
                    setTimeout(() => {
                        hideResetPasswordModal();
                        showAuthModal();
                    }, 3000);
                }
            } catch (err) {
                errorEl.textContent = 'Connection error. Please try again.';
                errorEl.style.display = 'block';
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Reset Password';
            }
        }

        let resetToken = null;

        function updateAuthUI() {
            const authSection = document.getElementById('authSection');
            const saveBtn = document.getElementById('savePortfolioBtn');

            if (currentUser) {
                const initials = (currentUser.name || currentUser.email || 'U').substring(0, 2).toUpperCase();
                authSection.innerHTML = `
                    <div class="user-menu">
                        <button class="user-btn" onclick="toggleUserDropdown()" aria-haspopup="true" aria-expanded="false">
                            <div class="user-avatar">${initials}</div>
                            <span>${currentUser.name || currentUser.email}</span>
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="6 9 12 15 18 9"/>
                            </svg>
                        </button>
                        <div class="user-dropdown" id="userDropdown" role="menu">
                            <div class="dropdown-item" style="color: var(--text-muted); pointer-events: none;" role="menuitem">
                                ${currentUser.email}
                            </div>
                            <div class="dropdown-divider"></div>
                            <button class="dropdown-item" onclick="showUserDashboard(); toggleUserDropdown();" role="menuitem">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px;">
                                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                                    <polyline points="9 22 9 12 15 12 15 22"/>
                                </svg>
                                Dashboard
                            </button>
                            <button class="dropdown-item" onclick="showSettingsModal(); toggleUserDropdown();" role="menuitem">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px;">
                                    <circle cx="12" cy="12" r="3"/>
                                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                                </svg>
                                Settings
                                <span class="shortcut-hint"><span class="kbd">Ctrl</span><span class="kbd">,</span></span>
                            </button>
                            <div class="dropdown-divider"></div>
                            <button class="dropdown-item" onclick="logout()" role="menuitem">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px;">
                                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                                    <polyline points="16 17 21 12 16 7"/>
                                    <line x1="21" y1="12" x2="9" y2="12"/>
                                </svg>
                                Sign Out
                            </button>
                        </div>
                    </div>
                `;
                saveBtn.style.display = 'inline-flex';
                document.getElementById('savedPortfoliosSection').style.display = 'block';
                updatePlaidUI();
                // Start session timer when logged in
                startSessionTimer();
                // Show dashboard instead of marketing page
                showUserDashboard();
            } else {
                authSection.innerHTML = `
                    <button class="btn btn-secondary" onclick="showAuthModal()">Sign In</button>
                `;
                saveBtn.style.display = 'none';
                document.getElementById('savedPortfoliosSection').style.display = 'none';
                document.getElementById('plaidSection').style.display = 'none';
                // Hide dashboard and show landing
                hideUserDashboard();
            }
        }

        // Dashboard Functions
        function showUserDashboard() {
            const dashboard = document.getElementById('userDashboard');
            const landingSections = document.getElementById('landingSections');

            if (dashboard && landingSections) {
                landingSections.style.display = 'none';
                dashboard.style.display = 'block';
                updateDashboardContent();
                window.scrollTo(0, 0);
            }
        }

        function hideUserDashboard() {
            const dashboard = document.getElementById('userDashboard');
            const landingSections = document.getElementById('landingSections');

            if (dashboard && landingSections) {
                dashboard.style.display = 'none';
                landingSections.style.display = 'block';
            }
        }

        async function updateDashboardContent() {
            // Update user name
            const userName = document.getElementById('dashboardUserName');
            if (userName && currentUser) {
                const displayName = currentUser.name || currentUser.email.split('@')[0];
                userName.textContent = displayName;
            }

            // Load and render portfolios
            await renderDashboardPortfolios();

            // Update stats
            updateDashboardStats();
        }

        async function renderDashboardPortfolios() {
            const container = document.getElementById('dashboardPortfolios');
            const emptyState = document.getElementById('dashboardEmptyState');

            if (!container || !authToken) return;

            try {
                const response = await fetch(`${API_URL}/portfolios`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (!response.ok) throw new Error('Failed to load portfolios');

                const portfolios = await response.json();

                if (portfolios.length === 0) {
                    container.style.display = 'none';
                    emptyState.style.display = 'block';
                    document.getElementById('totalPortfoliosCount').textContent = '0';
                    return;
                }

                container.style.display = 'grid';
                emptyState.style.display = 'none';

                container.innerHTML = portfolios.map(p => `
                    <div class="dashboard-portfolio-card" onclick="loadPortfolioFromDashboard('${p.id}')">
                        <div class="dashboard-portfolio-card-header">
                            <span class="dashboard-portfolio-card-title">${escapeHtml(p.name)}</span>
                            <span class="dashboard-portfolio-card-date">${formatDashboardDate(p.created_at)}</span>
                        </div>
                        <div class="dashboard-portfolio-card-value">$${formatNumber(p.total_value || 0)}</div>
                        <div class="dashboard-portfolio-card-holdings">${p.holdings_count || 0} holdings</div>
                    </div>
                `).join('');

                // Update stat
                document.getElementById('totalPortfoliosCount').textContent = portfolios.length;

            } catch (error) {
                console.error('Error loading dashboard portfolios:', error);
                container.innerHTML = '<div class="dashboard-no-accounts">Error loading portfolios. Please try again.</div>';
            }
        }

        function loadPortfolioFromDashboard(portfolioId) {
            // Hide dashboard, then load portfolio
            hideUserDashboard();
            loadPortfolio(portfolioId);
        }

        function updateDashboardStats() {
            // Connected accounts count (Plaid) - check if any plaid items exist
            const plaidAccountsCount = document.querySelectorAll('.plaid-account-item').length;
            const connectedCountEl = document.getElementById('connectedAccountsCount');
            if (connectedCountEl) {
                connectedCountEl.textContent = plaidAccountsCount;
            }

            // Last analysis date
            const lastAnalysis = localStorage.getItem('lastAnalysisDate');
            const lastAnalysisEl = document.getElementById('lastAnalysisDate');
            if (lastAnalysisEl) {
                lastAnalysisEl.textContent = lastAnalysis
                    ? formatRelativeDate(lastAnalysis)
                    : '--';
            }
        }

        function formatDashboardDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        function formatRelativeDate(dateStr) {
            const date = new Date(dateStr);
            const now = new Date();
            const diffMs = now - date;
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

            if (diffDays === 0) return 'Today';
            if (diffDays === 1) return 'Yesterday';
            if (diffDays < 7) return `${diffDays} days ago`;
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        function toggleUserDropdown() {
            const dropdown = document.getElementById('userDropdown');
            dropdown.classList.toggle('active');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            const dropdown = document.getElementById('userDropdown');
            const userBtn = e.target.closest('.user-btn');
            if (!userBtn && dropdown) {
                dropdown.classList.remove('active');
            }
        });

        // Check auth on page load
        async function checkAuth() {
            if (!authToken) return;

            try {
                const res = await fetch(`${API_URL}/auth/me`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (res.ok) {
                    const data = await res.json();
                    currentUser = data.user;
                    updateAuthUI();
                    loadSavedPortfolios();
                } else {
                    logout();
                }
            } catch (err) {
                // API might not be available yet, keep token
            }
        }

        // =============================================================================
        // PORTFOLIO SAVING
        // =============================================================================

        function showSaveModal() {
            if (!currentUser) {
                showAuthModal();
                return;
            }
            document.getElementById('saveModal').classList.add('active');
        }

        function hideSaveModal() {
            document.getElementById('saveModal').classList.remove('active');
            document.getElementById('saveError').style.display = 'none';
            document.getElementById('saveForm').reset();
        }

        async function handleSavePortfolio(event) {
            event.preventDefault();

            if (!portfolioData || !portfolioData.positions) {
                return;
            }

            const name = document.getElementById('portfolioName').value;
            const description = document.getElementById('portfolioDescription').value;
            const errorEl = document.getElementById('saveError');

            try {
                const res = await fetch(`${API_URL}/portfolios`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        name,
                        description,
                        positions: portfolioData.positions
                    })
                });

                const data = await res.json();

                if (!res.ok) {
                    errorEl.textContent = data.error || 'Failed to save portfolio';
                    errorEl.style.display = 'block';
                    return;
                }

                hideSaveModal();
                showToast('Portfolio saved successfully!');
                loadSavedPortfolios();
            } catch (err) {
                errorEl.textContent = 'Connection error. Please try again.';
                errorEl.style.display = 'block';
            }
        }

        async function loadSavedPortfolios() {
            if (!authToken) return;

            const listEl = document.getElementById('portfolioList');
            const emptyState = document.getElementById('portfolioEmptyState');

            // Show skeleton loading state
            listEl.innerHTML = `
                <div class="skeleton-row">
                    <div class="skeleton skeleton-circle"></div>
                    <div class="skeleton skeleton-block"></div>
                </div>
                <div class="skeleton-row">
                    <div class="skeleton skeleton-circle"></div>
                    <div class="skeleton skeleton-block"></div>
                </div>
            `;

            try {
                const res = await fetch(`${API_URL}/portfolios`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (!res.ok) {
                    listEl.innerHTML = `
                        <div class="empty-state-enhanced">
                            <div class="empty-state-icon" style="background: rgba(248, 113, 113, 0.1);">
                                <svg viewBox="0 0 24 24" fill="none" stroke="var(--danger)" stroke-width="1.5">
                                    <circle cx="12" cy="12" r="10"/>
                                    <line x1="15" y1="9" x2="9" y2="15"/>
                                    <line x1="9" y1="9" x2="15" y2="15"/>
                                </svg>
                            </div>
                            <div class="empty-state-title">Failed to load portfolios</div>
                            <div class="empty-state-desc">Please check your connection and try again.</div>
                            <div class="empty-state-actions">
                                <button class="btn btn-secondary" onclick="loadSavedPortfolios()">Try Again</button>
                            </div>
                        </div>
                    `;
                    return;
                }

                const data = await res.json();
                const portfolios = data.portfolios || [];

                if (portfolios.length === 0) {
                    listEl.innerHTML = `
                        <div class="empty-state-enhanced">
                            <div class="empty-state-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/>
                                </svg>
                            </div>
                            <div class="empty-state-title">No saved portfolios</div>
                            <div class="empty-state-desc">Analyze a portfolio and save it to track your investments over time.</div>
                            <div class="empty-state-actions">
                                <button class="btn btn-primary" onclick="switchEntryMethod('upload')">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                        <polyline points="17 8 12 3 7 8"/>
                                        <line x1="12" y1="3" x2="12" y2="15"/>
                                    </svg>
                                    Upload Statement
                                </button>
                            </div>
                        </div>
                    `;
                    return;
                }

                listEl.innerHTML = portfolios.map(p => `
                    <div class="portfolio-item" onclick="loadPortfolio(${p.id})" role="button" tabindex="0" aria-label="Load ${escapeHtml(p.name)} portfolio">
                        <div class="portfolio-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                            </svg>
                        </div>
                        <div class="portfolio-info">
                            <div class="portfolio-name">${escapeHtml(p.name)}</div>
                            <div class="portfolio-meta">
                                ${p.positions?.length || 0} positions
                                ${p.description ? ' - ' + escapeHtml(p.description) : ''}
                            </div>
                        </div>
                        <div class="portfolio-value">${formatCurrency(p.total_value)}</div>
                        <div class="portfolio-actions" onclick="event.stopPropagation()">
                            <button class="portfolio-action-btn delete" onclick="deletePortfolio(${p.id})" title="Delete portfolio" aria-label="Delete ${escapeHtml(p.name)}">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="3 6 5 6 21 6"/>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                `).join('');

                // Also update compare selectors
                updateCompareSelectors();

            } catch (err) {
                listEl.innerHTML = `
                    <div class="empty-state-enhanced">
                        <div class="empty-state-icon" style="background: rgba(248, 113, 113, 0.1);">
                            <svg viewBox="0 0 24 24" fill="none" stroke="var(--danger)" stroke-width="1.5">
                                <circle cx="12" cy="12" r="10"/>
                                <line x1="15" y1="9" x2="9" y2="15"/>
                                <line x1="9" y1="9" x2="15" y2="15"/>
                            </svg>
                        </div>
                        <div class="empty-state-title">Connection Error</div>
                        <div class="empty-state-desc">Failed to load portfolios. Please try again.</div>
                        <div class="empty-state-actions">
                            <button class="btn btn-secondary" onclick="loadSavedPortfolios()">Try Again</button>
                        </div>
                    </div>
                `;
            }
        }

        async function loadPortfolio(portfolioId) {
            if (!authToken) return;

            showProgress('Loading portfolio...');

            try {
                const res = await fetch(`${API_URL}/portfolios/${portfolioId}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (!res.ok) {
                    hideProgress();
                    showError('Failed to load portfolio');
                    return;
                }

                const data = await res.json();
                const portfolio = data.portfolio;

                // Create a fake account for the loaded portfolio
                accounts = [{
                    id: Date.now(),
                    name: portfolio.name,
                    positions: portfolio.positions,
                    brokerage: 'saved',
                    totalValue: portfolio.total_value
                }];

                // Analyze the portfolio
                await analyzePortfolio();

            } catch (err) {
                hideProgress();
                showError('Failed to load portfolio: ' + err.message);
            }
        }

        async function deletePortfolio(portfolioId) {
            showConfirmModal({
                title: 'Delete Portfolio?',
                message: 'This portfolio and all its data will be permanently deleted. This action cannot be undone.',
                confirmText: 'Delete',
                confirmClass: 'btn-primary',
                icon: 'danger',
                onConfirm: async () => {
                    try {
                        const res = await fetch(`${API_URL}/portfolios/${portfolioId}`, {
                            method: 'DELETE',
                            headers: { 'Authorization': `Bearer ${authToken}` }
                        });

                        if (!res.ok) {
                            const data = await res.json();
                            showError(data.error || 'Failed to delete portfolio');
                            return;
                        }

                        showToast('Portfolio deleted', 'success');
                        loadSavedPortfolios();
                    } catch (err) {
                        showError('Failed to delete portfolio');
                    }
                }
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // showToast is now defined in the Enterprise Enhancements section above

        // =============================================================================
        // PORTFOLIO COMPARISON
        // =============================================================================

        let compareCharts = {};

        function updateCompareSelectors() {
            const selectA = document.getElementById('compareSelectA');
            const selectB = document.getElementById('compareSelectB');

            // Build options
            let options = '';

            // Add current analysis if available
            if (portfolioData && portfolioData.positions) {
                options += '<option value="current">Current Analysis</option>';
            }

            // Fetch saved portfolios for options
            if (authToken) {
                fetch(`${API_URL}/portfolios`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                })
                .then(res => res.json())
                .then(data => {
                    const portfolios = data.portfolios || [];
                    portfolios.forEach(p => {
                        options += `<option value="${p.id}">${escapeHtml(p.name)} (${formatCurrency(p.total_value)})</option>`;
                    });

                    // Update select A
                    selectA.innerHTML = portfolioData ? '<option value="current">Current Analysis</option>' : '';
                    selectA.innerHTML += portfolios.map(p =>
                        `<option value="${p.id}">${escapeHtml(p.name)} (${formatCurrency(p.total_value)})</option>`
                    ).join('');

                    // Update select B
                    selectB.innerHTML = '<option value="">Select a portfolio...</option>';
                    if (portfolioData) {
                        selectB.innerHTML += '<option value="current">Current Analysis</option>';
                    }
                    selectB.innerHTML += portfolios.map(p =>
                        `<option value="${p.id}">${escapeHtml(p.name)} (${formatCurrency(p.total_value)})</option>`
                    ).join('');
                })
                .catch(() => {});
            } else {
                selectA.innerHTML = portfolioData ? '<option value="current">Current Analysis</option>' : '<option value="">No portfolios available</option>';
                selectB.innerHTML = '<option value="">Sign in to compare saved portfolios</option>';
            }
        }

        async function runComparison() {
            const selectA = document.getElementById('compareSelectA').value;
            const selectB = document.getElementById('compareSelectB').value;

            if (!selectA || !selectB) {
                showError('Please select two portfolios to compare');
                return;
            }

            if (selectA === selectB) {
                showError('Please select two different portfolios');
                return;
            }

            // Build request body
            const body = {
                portfolio_a: selectA === 'current' ? { positions: portfolioData.positions } : { id: parseInt(selectA) },
                portfolio_b: selectB === 'current' ? { positions: portfolioData.positions } : { id: parseInt(selectB) }
            };

            showProgress('Comparing portfolios...');

            try {
                const headers = { 'Content-Type': 'application/json' };
                if (authToken) {
                    headers['Authorization'] = `Bearer ${authToken}`;
                }

                const res = await fetch(`${API_URL}/compare`, {
                    method: 'POST',
                    headers,
                    body: JSON.stringify(body)
                });

                if (!res.ok) {
                    const data = await res.json();
                    hideProgress();
                    showError(data.error || 'Comparison failed');
                    return;
                }

                const data = await res.json();
                hideProgress();
                renderComparison(data);

            } catch (err) {
                hideProgress();
                showError('Comparison failed: ' + err.message);
            }
        }

        function renderComparison(data) {
            const resultsEl = document.getElementById('comparisonResults');
            const emptyEl = document.getElementById('compareEmptyState');

            resultsEl.style.display = 'block';
            emptyEl.style.display = 'none';

            const { portfolio_a, portfolio_b, comparison } = data;

            // Get names from selectors
            const selectA = document.getElementById('compareSelectA');
            const selectB = document.getElementById('compareSelectB');
            const nameA = selectA.options[selectA.selectedIndex].text;
            const nameB = selectB.options[selectB.selectedIndex].text;

            // Update headers
            document.getElementById('compareNameA').textContent = nameA.split(' (')[0];
            document.getElementById('compareNameB').textContent = nameB.split(' (')[0];
            document.getElementById('compareValueA').textContent = formatCurrency(portfolio_a.total_value);
            document.getElementById('compareValueB').textContent = formatCurrency(portfolio_b.total_value);

            // Render allocation charts
            renderCompareChart('compareChartA', portfolio_a.asset_allocation);
            renderCompareChart('compareChartB', portfolio_b.asset_allocation);

            // Render stats
            renderCompareStats('compareStatsA', portfolio_a);
            renderCompareStats('compareStatsB', portfolio_b);

            // Render difference grid
            renderDiffGrid(comparison);
        }

        function renderCompareChart(canvasId, allocation) {
            const ctx = document.getElementById(canvasId).getContext('2d');

            if (compareCharts[canvasId]) {
                compareCharts[canvasId].destroy();
            }

            const labels = Object.keys(allocation).filter(k => allocation[k] > 0);
            const values = labels.map(k => allocation[k]);
            const colors = {
                Stocks: '#30d158', Bonds: '#635bff', Cash: '#ffd60a',
                'Real Estate': '#bf5af2', Crypto: '#ff9f0a', Commodities: '#64d2ff'
            };
            const bgColors = labels.map(l => colors[l] || '#8898aa');

            compareCharts[canvasId] = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels,
                    datasets: [{ data: values, backgroundColor: bgColors, borderWidth: 0 }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { padding: 12, usePointStyle: true, font: { size: 11 } } },
                        tooltip: { callbacks: { label: ctx => `${ctx.label}: ${ctx.raw.toFixed(1)}%` } }
                    }
                }
            });
        }

        function renderCompareStats(containerId, analysis) {
            const risk = analysis.risk_metrics || {};
            const perf = analysis.historical_performance?.returns || {};

            document.getElementById(containerId).innerHTML = `
                <div class="compare-stat">
                    <div class="compare-stat-value">${risk.volatility !== null ? risk.volatility.toFixed(1) + '%' : '--'}</div>
                    <div class="compare-stat-label">Volatility</div>
                </div>
                <div class="compare-stat">
                    <div class="compare-stat-value">${risk.beta !== null ? risk.beta.toFixed(2) : '--'}</div>
                    <div class="compare-stat-label">Beta</div>
                </div>
                <div class="compare-stat">
                    <div class="compare-stat-value">${risk.sharpe_ratio !== null ? risk.sharpe_ratio.toFixed(2) : '--'}</div>
                    <div class="compare-stat-label">Sharpe</div>
                </div>
                <div class="compare-stat">
                    <div class="compare-stat-value">${perf['1Y']?.portfolio !== null ? (perf['1Y']?.portfolio > 0 ? '+' : '') + perf['1Y']?.portfolio?.toFixed(1) + '%' : '--'}</div>
                    <div class="compare-stat-label">1Y Return</div>
                </div>
            `;
        }

        function renderDiffGrid(comparison) {
            const grid = document.getElementById('diffGrid');

            const formatDiff = (val, suffix = '') => {
                if (val === null || val === undefined) return '--';
                const sign = val > 0 ? '+' : '';
                return sign + val.toFixed(1) + suffix;
            };

            const getDiffClass = (val) => {
                if (val === null || val === undefined || val === 0) return 'neutral';
                return val > 0 ? 'positive' : 'negative';
            };

            const items = [
                { label: 'Total Value', value: comparison.total_value_diff, format: v => formatCurrency(v), rawValue: comparison.total_value_diff },
                { label: 'Stocks %', value: comparison.allocation_diff?.Stocks, suffix: '%' },
                { label: 'Bonds %', value: comparison.allocation_diff?.Bonds, suffix: '%' },
                { label: 'Volatility', value: comparison.risk_diff?.volatility, suffix: '%' },
                { label: 'Beta', value: comparison.risk_diff?.beta, suffix: '' },
                { label: 'Sharpe Ratio', value: comparison.risk_diff?.sharpe_ratio, suffix: '' },
                { label: '1Y Return', value: comparison.performance_diff?.['1Y'], suffix: '%' },
                { label: '3Y Return', value: comparison.performance_diff?.['3Y'], suffix: '%' }
            ];

            grid.innerHTML = items.map(item => {
                const displayVal = item.format ? item.format(item.value) : formatDiff(item.value, item.suffix || '');
                const rawVal = item.rawValue !== undefined ? item.rawValue : item.value;
                return `
                    <div class="diff-item">
                        <div class="diff-value ${getDiffClass(rawVal)}">${displayVal}</div>
                        <div class="diff-label">${item.label}</div>
                    </div>
                `;
            }).join('');
        }

        // =============================================================================
        // WHAT-IF ANALYSIS
        // =============================================================================

        let whatIfPositions = [];
        let whatIfChanges = [];
        let whatIfChart = null;
        let whatIfResult = null;

        function initWhatIf() {
            if (!portfolioData || !portfolioData.positions) return;

            // Clone current positions
            whatIfPositions = JSON.parse(JSON.stringify(portfolioData.positions));
            whatIfChanges = [];
            whatIfResult = null;

            renderWhatIfPositions();
            updateWhatIfPreview();
        }

        function renderWhatIfPositions() {
            const list = document.getElementById('whatifPositionList');

            if (!whatIfPositions || whatIfPositions.length === 0) {
                list.innerHTML = '<div class="empty-state">No positions to edit</div>';
                return;
            }

            list.innerHTML = whatIfPositions.map((pos, idx) => {
                const value = (pos.shares || 0) * (pos.price || 0);
                return `
                    <div class="whatif-position">
                        <div class="whatif-position-symbol">${pos.symbol}</div>
                        <div class="whatif-position-shares">
                            <input type="number" value="${pos.shares || 0}" min="0" step="0.0001"
                                   onchange="updateWhatIfShares(${idx}, this.value)">
                            <span style="color: var(--text-muted); font-size: 0.75rem; margin-left: 4px;">shares</span>
                        </div>
                        <div class="whatif-position-value">${formatCurrency(value)}</div>
                        <button class="whatif-position-remove" onclick="removeWhatIfPosition(${idx})" title="Remove">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                            </svg>
                        </button>
                    </div>
                `;
            }).join('');
        }

        function updateWhatIfShares(idx, newShares) {
            const pos = whatIfPositions[idx];
            if (!pos) return;

            const oldShares = pos.shares || 0;
            pos.shares = parseFloat(newShares) || 0;
            pos.value = pos.shares * (pos.price || 0);

            // Track the change
            whatIfChanges = whatIfChanges.filter(c => !(c.action === 'adjust' && c.symbol === pos.symbol));
            if (pos.shares !== oldShares) {
                whatIfChanges.push({
                    action: 'adjust',
                    symbol: pos.symbol,
                    new_shares: pos.shares
                });
            }

            renderWhatIfPositions();
            updateWhatIfPreview();
        }

        function removeWhatIfPosition(idx) {
            const pos = whatIfPositions[idx];
            if (!pos) return;

            whatIfChanges.push({
                action: 'remove',
                symbol: pos.symbol
            });

            whatIfPositions.splice(idx, 1);
            renderWhatIfPositions();
            updateWhatIfPreview();
        }

        function addWhatIfPosition() {
            const symbol = document.getElementById('whatifAddSymbol').value.toUpperCase().trim();
            const shares = parseFloat(document.getElementById('whatifAddShares').value) || 0;
            const price = parseFloat(document.getElementById('whatifAddPrice').value) || 0;

            if (!symbol) {
                showError('Please enter a symbol');
                return;
            }
            if (shares <= 0) {
                showError('Please enter a valid number of shares');
                return;
            }
            if (price <= 0) {
                showError('Please enter a valid price');
                return;
            }

            // Check if already exists
            const existing = whatIfPositions.find(p => p.symbol.toUpperCase() === symbol);
            if (existing) {
                existing.shares = (existing.shares || 0) + shares;
                existing.value = existing.shares * (existing.price || price);
            } else {
                whatIfPositions.push({
                    symbol: symbol,
                    description: '',
                    shares: shares,
                    price: price,
                    value: shares * price
                });
            }

            whatIfChanges.push({
                action: 'add',
                symbol: symbol,
                shares: shares,
                price: price
            });

            // Clear form
            document.getElementById('whatifAddSymbol').value = '';
            document.getElementById('whatifAddShares').value = '';
            document.getElementById('whatifAddPrice').value = '';

            renderWhatIfPositions();
            updateWhatIfPreview();
        }

        function applyRebalance() {
            const stocks = parseFloat(document.getElementById('rebalanceStocks').value) || 0;
            const bonds = parseFloat(document.getElementById('rebalanceBonds').value) || 0;
            const cash = parseFloat(document.getElementById('rebalanceCash').value) || 0;

            const total = stocks + bonds + cash;
            if (total === 0) {
                showError('Please enter target allocations');
                return;
            }

            if (Math.abs(total - 100) > 0.1) {
                showError(`Allocations sum to ${total.toFixed(1)}%, should be 100%`);
                return;
            }

            whatIfChanges.push({
                action: 'rebalance',
                target: { Stocks: stocks, Bonds: bonds, Cash: cash }
            });

            // Run analysis to get rebalanced positions
            runWhatIfAnalysis();
        }

        function updateWhatIfPreview() {
            const totalValue = whatIfPositions.reduce((sum, p) => sum + ((p.shares || 0) * (p.price || 0)), 0);
            document.getElementById('whatifPreviewValue').textContent = formatCurrency(totalValue);

            // Calculate allocation preview
            const alloc = {};
            whatIfPositions.forEach(pos => {
                const value = (pos.shares || 0) * (pos.price || 0);
                // Simple classification based on symbol database
                const cls = getAssetClass(pos.symbol);
                alloc[cls] = (alloc[cls] || 0) + value;
            });

            const allocPct = {};
            for (const [cls, val] of Object.entries(alloc)) {
                allocPct[cls] = totalValue > 0 ? ((val / totalValue) * 100).toFixed(1) : '0.0';
            }

            // Render preview allocation chart
            renderWhatIfChart(allocPct);

            // Show modified allocation
            document.getElementById('whatifModifiedAlloc').innerHTML = Object.entries(allocPct)
                .map(([cls, pct]) => `${cls}: ${pct}%`)
                .join('<br>');

            // Show original allocation
            if (portfolioData && portfolioData.asset_allocation) {
                document.getElementById('whatifOriginalAlloc').innerHTML = Object.entries(portfolioData.asset_allocation)
                    .filter(([_, pct]) => pct > 0)
                    .map(([cls, pct]) => `${cls}: ${pct.toFixed(1)}%`)
                    .join('<br>');
            }
        }

        function getAssetClass(symbol) {
            // Simple lookup - in production this would use the backend classification
            const stockSymbols = ['VTI', 'VOO', 'SPY', 'QQQ', 'IVV', 'VEA', 'VWO', 'AAPL', 'MSFT', 'GOOGL', 'AMZN', 'META', 'NVDA', 'TSLA'];
            const bondSymbols = ['AGG', 'BND', 'TLT', 'BNDX', 'LQD', 'HYG', 'TIP', 'MUB', 'SGOV'];
            const cashSymbols = ['CASH', 'SPAXX', 'VMFXX', 'SWVXX'];
            const cryptoSymbols = ['IBIT', 'GBTC', 'ETHA', 'FBTC'];

            symbol = symbol.toUpperCase();
            if (cashSymbols.includes(symbol)) return 'Cash';
            if (bondSymbols.includes(symbol)) return 'Bonds';
            if (cryptoSymbols.includes(symbol)) return 'Crypto';
            return 'Stocks'; // Default
        }

        function renderWhatIfChart(allocation) {
            const ctx = document.getElementById('whatifChart').getContext('2d');

            if (whatIfChart) {
                whatIfChart.destroy();
            }

            const labels = Object.keys(allocation).filter(k => parseFloat(allocation[k]) > 0);
            const values = labels.map(k => parseFloat(allocation[k]));
            const colors = {
                Stocks: '#30d158', Bonds: '#635bff', Cash: '#ffd60a',
                'Real Estate': '#bf5af2', Crypto: '#ff9f0a', Commodities: '#64d2ff'
            };
            const bgColors = labels.map(l => colors[l] || '#8898aa');

            whatIfChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels,
                    datasets: [{ data: values, backgroundColor: bgColors, borderWidth: 0 }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { padding: 8, usePointStyle: true, font: { size: 10 } } },
                        tooltip: { callbacks: { label: ctx => `${ctx.label}: ${ctx.raw}%` } }
                    }
                }
            });
        }

        async function runWhatIfAnalysis() {
            if (!portfolioData || !portfolioData.positions) {
                showError('No portfolio to analyze');
                return;
            }

            showProgress('Running what-if analysis...');

            try {
                const headers = { 'Content-Type': 'application/json' };
                if (authToken) {
                    headers['Authorization'] = `Bearer ${authToken}`;
                }

                const res = await fetch(`${API_URL}/what-if`, {
                    method: 'POST',
                    headers,
                    body: JSON.stringify({
                        positions: portfolioData.positions,
                        changes: whatIfChanges
                    })
                });

                if (!res.ok) {
                    const data = await res.json();
                    hideProgress();
                    showError(data.error || 'Analysis failed');
                    return;
                }

                const data = await res.json();
                hideProgress();
                whatIfResult = data;

                // Update positions from result
                whatIfPositions = data.modified.positions.map(p => ({
                    symbol: p.symbol,
                    description: p.description,
                    shares: p.shares,
                    price: p.price,
                    value: p.value
                }));

                renderWhatIfPositions();
                renderWhatIfResults(data);

                // Show save button if logged in
                if (currentUser) {
                    document.getElementById('saveWhatIfBtn').style.display = 'inline-flex';
                }

            } catch (err) {
                hideProgress();
                showError('Analysis failed: ' + err.message);
            }
        }

        function renderWhatIfResults(data) {
            const { original, modified, impact } = data;

            // Update preview value
            document.getElementById('whatifPreviewValue').textContent = formatCurrency(modified.total_value);

            // Update impact cards
            const formatDiff = (val, suffix = '') => {
                if (val === null || val === undefined) return '--';
                const sign = val > 0 ? '+' : '';
                return sign + val.toFixed(1) + suffix;
            };

            document.getElementById('whatifValueChange').textContent = formatCurrency(impact.value_change);
            document.getElementById('whatifValueChange').className = 'whatif-impact-value ' +
                (impact.value_change > 0 ? 'positive' : impact.value_change < 0 ? 'negative' : '');

            document.getElementById('whatifCost').textContent = formatCurrency(impact.cost_to_execute);

            document.getElementById('whatifVolChange').textContent = formatDiff(impact.risk_change?.volatility, '%');
            document.getElementById('whatifVolChange').className = 'whatif-impact-value ' +
                (impact.risk_change?.volatility < 0 ? 'positive' : impact.risk_change?.volatility > 0 ? 'negative' : '');

            document.getElementById('whatifBetaChange').textContent = formatDiff(impact.risk_change?.beta, '');

            // Update allocation displays
            document.getElementById('whatifOriginalAlloc').innerHTML = Object.entries(original.asset_allocation)
                .filter(([_, pct]) => pct > 0)
                .map(([cls, pct]) => `${cls}: ${pct.toFixed(1)}%`)
                .join('<br>');

            document.getElementById('whatifModifiedAlloc').innerHTML = Object.entries(modified.asset_allocation)
                .filter(([_, pct]) => pct > 0)
                .map(([cls, pct]) => `${cls}: ${pct.toFixed(1)}%`)
                .join('<br>');

            // Update chart
            renderWhatIfChart(modified.asset_allocation);
        }

        function resetWhatIf() {
            initWhatIf();
            document.getElementById('saveWhatIfBtn').style.display = 'none';
            document.getElementById('whatifValueChange').textContent = '--';
            document.getElementById('whatifCost').textContent = '--';
            document.getElementById('whatifVolChange').textContent = '--';
            document.getElementById('whatifBetaChange').textContent = '--';
        }

        function saveWhatIfAsNew() {
            if (!whatIfResult || !currentUser) return;

            // Populate save modal with modified positions
            const tempPositions = whatIfResult.modified.positions;
            const tempData = portfolioData;

            // Temporarily set portfolio data to modified positions
            portfolioData = { positions: tempPositions };

            document.getElementById('portfolioName').value = 'What-If Scenario';
            showSaveModal();

            // Restore original after modal shown
            portfolioData = tempData;
        }

        // =============================================================================
        // PLAID INTEGRATION
        // =============================================================================

        let plaidAvailable = false;
        let plaidHandler = null;

        async function checkPlaidStatus() {
            try {
                const res = await fetch(`${API_URL}/plaid/status`);
                const data = await res.json();
                plaidAvailable = data.available;
                updatePlaidUI();
            } catch (err) {
                plaidAvailable = false;
            }
        }

        function updatePlaidUI() {
            const section = document.getElementById('plaidSection');

            // Only show Plaid section if user is logged in
            if (!currentUser) {
                section.style.display = 'none';
                return;
            }

            section.style.display = 'block';

            if (!plaidAvailable) {
                document.getElementById('plaidConnections').innerHTML = `
                    <div class="plaid-unavailable">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <rect x="2" y="4" width="20" height="16" rx="2"/>
                            <path d="M7 15h0M2 9h20"/>
                        </svg>
                        <p>Plaid integration is not configured</p>
                        <p style="font-size: 0.8125rem;">Contact your administrator to enable account linking</p>
                    </div>
                `;
                return;
            }

            loadPlaidConnections();
        }

        async function loadPlaidConnections() {
            if (!authToken || !plaidAvailable) return;

            const container = document.getElementById('plaidConnections');

            try {
                const res = await fetch(`${API_URL}/plaid/connections`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (!res.ok) {
                    container.innerHTML = '<div class="empty-state">Failed to load connections</div>';
                    return;
                }

                const data = await res.json();
                const connections = data.connections || [];

                if (connections.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <p>No accounts connected yet</p>
                            <p style="font-size: 0.8125rem;">Link your brokerage to automatically import holdings</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = connections.map(c => `
                    <div class="plaid-connection">
                        <div class="plaid-connection-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="2" y="4" width="20" height="16" rx="2"/>
                                <path d="M7 15h0M2 9h20"/>
                            </svg>
                        </div>
                        <div class="plaid-connection-info">
                            <div class="plaid-connection-name">${escapeHtml(c.institution_name || 'Connected Account')}</div>
                            <div class="plaid-connection-meta">
                                Last synced: ${c.last_synced ? new Date(c.last_synced).toLocaleString() : 'Never'}
                            </div>
                        </div>
                        <div class="plaid-connection-actions">
                            <button class="btn btn-secondary" onclick="syncPlaidConnection(${c.id})">
                                Sync
                            </button>
                            <button class="portfolio-action-btn delete" onclick="disconnectPlaidAccount(${c.id})" title="Disconnect">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                `).join('');

            } catch (err) {
                container.innerHTML = '<div class="empty-state">Failed to load connections</div>';
            }
        }

        async function connectPlaidAccount() {
            if (!authToken) {
                showAuthModal();
                return;
            }

            if (!plaidAvailable) {
                showError('Plaid integration is not available');
                return;
            }

            try {
                // Get link token from backend
                const res = await fetch(`${API_URL}/plaid/create-link-token`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (!res.ok) {
                    const data = await res.json();
                    showError(data.error || 'Failed to initialize Plaid');
                    return;
                }

                const data = await res.json();
                const linkToken = data.link_token;

                // Initialize Plaid Link
                plaidHandler = Plaid.create({
                    token: linkToken,
                    onSuccess: async (publicToken, metadata) => {
                        await exchangePlaidToken(publicToken, metadata);
                    },
                    onExit: (err, metadata) => {
                        if (err) {
                            console.error('Plaid Link error:', err);
                        }
                    },
                    onEvent: (eventName, metadata) => {
                        console.log('Plaid event:', eventName);
                    }
                });

                plaidHandler.open();

            } catch (err) {
                showError('Failed to connect account: ' + err.message);
            }
        }

        async function exchangePlaidToken(publicToken, metadata) {
            try {
                const res = await fetch(`${API_URL}/plaid/exchange-token`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        public_token: publicToken,
                        institution_name: metadata.institution?.name || '',
                        institution_id: metadata.institution?.institution_id || ''
                    })
                });

                if (!res.ok) {
                    const data = await res.json();
                    showError(data.error || 'Failed to connect account');
                    return;
                }

                // Reload connections
                loadPlaidConnections();

            } catch (err) {
                showError('Failed to connect account: ' + err.message);
            }
        }

        async function syncPlaidConnection(connectionId) {
            showProgress('Syncing account...');

            try {
                const res = await fetch(`${API_URL}/plaid/connections/${connectionId}/sync`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (!res.ok) {
                    const data = await res.json();
                    hideProgress();
                    showError(data.error || 'Sync failed');
                    return;
                }

                const data = await res.json();
                hideProgress();

                if (data.positions && data.positions.length > 0) {
                    // Add as an account
                    accounts.push({
                        id: Date.now() + Math.random(),
                        name: data.connection.institution_name || 'Plaid Account',
                        positions: data.positions,
                        brokerage: 'plaid',
                        totalValue: data.positions.reduce((s, p) => s + (p.value || 0), 0)
                    });
                    renderAccounts();
                    loadPlaidConnections();
                } else {
                    showError('No holdings found in this account');
                }

            } catch (err) {
                hideProgress();
                showError('Sync failed: ' + err.message);
            }
        }

        async function disconnectPlaidAccount(connectionId) {
            if (!confirm('Are you sure you want to disconnect this account?')) {
                return;
            }

            try {
                const res = await fetch(`${API_URL}/plaid/connections/${connectionId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (!res.ok) {
                    const data = await res.json();
                    showError(data.error || 'Failed to disconnect');
                    return;
                }

                loadPlaidConnections();

            } catch (err) {
                showError('Failed to disconnect: ' + err.message);
            }
        }

        // Initialize auth check and Plaid status
        checkAuth();
        checkPlaidStatus();

        // Check for password reset token in URL
        const urlParams = new URLSearchParams(window.location.search);
        const resetTokenFromUrl = urlParams.get('reset_token');
        if (resetTokenFromUrl) {
            showResetPasswordModal(resetTokenFromUrl);
        }

        // DOM Elements
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const accountsSection = document.getElementById('accountsSection');
        const accountsList = document.getElementById('accountsList');
        const addMoreBtn = document.getElementById('addMoreBtn');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const clearAllBtn = document.getElementById('clearAllBtn');
        const progressSection = document.getElementById('progressSection');
        const progressText = document.getElementById('progressText');
        const dashboard = document.getElementById('dashboard');
        const errorMessage = document.getElementById('errorMessage');
        const uploadSection = document.getElementById('uploadSection');

        // Event Listeners
        dropZone.addEventListener('click', (e) => {
            if (e.target.closest('button')) return;
            fileInput.click();
        });
        addMoreBtn.addEventListener('click', () => fileInput.click());

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });

        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
            fileInput.value = '';
        });

        analyzeBtn.addEventListener('click', analyzePortfolio);
        clearAllBtn.addEventListener('click', () => {
            accounts = [];
            uploadedFiles = [];
            const downloadBtn = document.getElementById('downloadRedactedBtn');
            if (downloadBtn) downloadBtn.style.display = 'none';
            renderAccounts();
        });
        document.getElementById('newAnalysisBtn')?.addEventListener('click', resetUI);
        document.getElementById('downloadPdfBtn')?.addEventListener('click', downloadPDF);
        document.getElementById('downloadCsvBtn')?.addEventListener('click', downloadCSV);
        document.getElementById('savePortfolioBtn')?.addEventListener('click', showSaveModal);

        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.dataset.tab;
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                const tabContent = document.getElementById('tab-' + tabName);
                if (tabContent) tabContent.classList.add('active');

                // Close dropdown if open
                const dropdown = document.getElementById('tabsDropdown');
                if (dropdown) dropdown.classList.remove('show');

                // Update More button state
                if (typeof updateMoreButtonState === 'function') {
                    updateMoreButtonState();
                }

                // Call switchTab for additional initialization
                if (typeof window.switchTab === 'function') {
                    window.switchTab(tabName);
                }
            });
        });

        async function handleFiles(files) {
            const validFiles = Array.from(files).filter(file => {
                const ext = file.name.split('.').pop().toLowerCase();
                return ['pdf', 'csv', 'ofx', 'qfx', 'png', 'jpg', 'jpeg', 'webp'].includes(ext);
            });

            if (validFiles.length === 0) {
                showError('Please select PDF, CSV, OFX, QFX, or image files (PNG, JPG)');
                return;
            }

            // If on landing page, redirect to app with files stored in IndexedDB
            if (useLandingRedirect && typeof handleLandingUpload === 'function') {
                await handleLandingUpload(validFiles);
                return;
            }

            // Calculate total file size for display
            const totalSize = validFiles.reduce((sum, f) => sum + f.size, 0);
            const formatSize = (bytes) => {
                if (bytes < 1024) return bytes + ' B';
                if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
                return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
            };

            // Show enhanced progress with stages
            showProgress('Preparing files...', { start: true, totalFiles: validFiles.length, stage: 'upload' });

            // Update file info display
            const fileInfoEl = document.getElementById('progressFileName');
            if (fileInfoEl) {
                fileInfoEl.textContent = `${validFiles.length} file${validFiles.length > 1 ? 's' : ''} (${formatSize(totalSize)})`;
            }

            // Show upload queue for multiple files
            const queue = document.getElementById('uploadQueue');
            const queueList = document.getElementById('uploadQueueList');
            const queueTitle = document.getElementById('uploadQueueTitle');
            const queueCount = document.getElementById('uploadQueueCount');

            if (validFiles.length > 1) {
                queue.style.display = 'block';
                queueTitle.textContent = 'Processing files...';
                queueCount.textContent = `0 / ${validFiles.length}`;

                // Initialize queue items
                queueList.innerHTML = validFiles.map((file, i) => `
                    <div class="upload-queue-item" id="queueItem${i}">
                        <div class="upload-file-icon" id="queueIcon${i}">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                <polyline points="14 2 14 8 20 8"/>
                            </svg>
                        </div>
                        <div class="upload-file-info">
                            <div class="upload-file-name">${file.name}</div>
                            <div class="upload-file-status" id="queueStatus${i}">Waiting...</div>
                        </div>
                    </div>
                `).join('');
            }

            // Transition to parse stage
            await new Promise(r => setTimeout(r, 300)); // Brief pause for visual feedback
            progressManager.setStage('parse', `Parsing ${validFiles.length > 1 ? 'statements' : validFiles[0].name}...`);

            // Process all files in parallel
            let completed = 0;
            let successful = 0;

            const processFile = async (file, index) => {
                const iconEl = document.getElementById(`queueIcon${index}`);
                const statusEl = document.getElementById(`queueStatus${index}`);

                if (validFiles.length > 1) {
                    iconEl?.classList.add('processing');
                    if (statusEl) statusEl.textContent = 'Processing...';
                }

                try {
                    // Client-side brokerage detection from file text content
                    let clientDetectedBrokerage = null;
                    const isPdf = file.name.toLowerCase().endsWith('.pdf');

                    if (isPdf && typeof pdfjsLib !== 'undefined') {
                        try {
                            const arrayBuf = await file.arrayBuffer();
                            const pdf = await pdfjsLib.getDocument({ data: arrayBuf }).promise;
                            let extractedText = '';
                            const pagesToRead = Math.min(pdf.numPages, 3);
                            for (let i = 1; i <= pagesToRead; i++) {
                                const page = await pdf.getPage(i);
                                const content = await page.getTextContent();
                                extractedText += content.items.map(item => item.str).join(' ') + ' ';
                            }
                            clientDetectedBrokerage = detectBrokerage(extractedText);
                        } catch (e) {
                            console.warn('Client-side PDF brokerage detection failed:', e);
                        }
                    } else if (!isPdf) {
                        // CSV - read as text
                        try {
                            const text = await file.text();
                            clientDetectedBrokerage = detectBrokerage(text);
                        } catch (e) {
                            console.warn('Client-side CSV brokerage detection failed:', e);
                        }
                    }

                    const result = await parseFile(file);

                    if (result.error && !result.positions?.length) {
                        if (validFiles.length > 1) {
                            iconEl?.classList.remove('processing');
                            iconEl?.classList.add('error');
                            if (statusEl) {
                                statusEl.textContent = result.error;
                                statusEl.classList.add('error');
                            }
                        } else {
                            hideProgress();
                            showError(`${file.name}: ${result.error}`);
                        }
                        return { success: false };
                    }

                    // Use backend brokerage if it has a favicon, otherwise use client detection
                    const backendBrokerage = result.brokerage;
                    const backendHasFavicon = getBrokerageFavicon(backendBrokerage) !== null;
                    const resolvedBrokerage = backendHasFavicon ? backendBrokerage
                        : (clientDetectedBrokerage || backendBrokerage);

                    accounts.push({
                        id: Date.now() + Math.random(),
                        name: getBrokerageName(resolvedBrokerage),
                        positions: result.positions,
                        brokerage: resolvedBrokerage,
                        totalValue: result.positions.reduce((s, p) => s + (p.value || 0), 0)
                    });

                    if (validFiles.length > 1) {
                        iconEl?.classList.remove('processing');
                        iconEl?.classList.add('success');
                        if (iconEl) {
                            iconEl.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="20 6 9 17 4 12"/>
                            </svg>`;
                        }
                        if (statusEl) {
                            statusEl.textContent = `${result.positions.length} positions found`;
                            statusEl.classList.add('success');
                        }
                    }

                    return { success: true };
                } catch (err) {
                    if (validFiles.length > 1) {
                        iconEl?.classList.remove('processing');
                        iconEl?.classList.add('error');
                        if (iconEl) {
                            iconEl.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <line x1="15" y1="9" x2="9" y2="15"/>
                                <line x1="9" y1="9" x2="15" y2="15"/>
                            </svg>`;
                        }
                        if (statusEl) {
                            statusEl.textContent = err.message;
                            statusEl.classList.add('error');
                        }
                    } else {
                        hideProgress();
                        showError(`${file.name}: ${err.message}`);
                    }
                    return { success: false };
                }
            };

            // Process files in parallel (max 3 concurrent)
            const results = [];
            const concurrency = 3;

            for (let i = 0; i < validFiles.length; i += concurrency) {
                const batch = validFiles.slice(i, i + concurrency);
                const batchResults = await Promise.all(
                    batch.map((file, j) => processFile(file, i + j))
                );
                results.push(...batchResults);

                completed += batch.length;
                successful += batchResults.filter(r => r.success).length;

                // Update progress manager with file progress
                progressManager.updateFileProgress(completed, validFiles[Math.min(i + concurrency - 1, validFiles.length - 1)]?.name);

                if (validFiles.length > 1) {
                    queueCount.textContent = `${completed} / ${validFiles.length}`;
                }
            }

            // Finish up
            if (validFiles.length > 1) {
                queueTitle.textContent = 'Upload complete';

                // Auto-hide queue after delay if all successful
                if (successful === validFiles.length) {
                    setTimeout(() => {
                        queue.style.display = 'none';
                    }, 2000);
                }
            }

            // Hide progress after parsing is complete
            hideProgress();

            hideError();
            renderAccounts();
        }

        // Brokerage domain mapping for favicon API
        // Client-side brokerage detection from PDF/CSV text content
        // Helper: word-boundary-aware phrase matching
        function hasPhrase(text, phrase) {
            const escaped = phrase.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const regex = new RegExp(`\\b${escaped}\\b`, 'i');
            return regex.test(text);
        }

        // Helper: count occurrences of a phrase
        function countPhrase(text, phrase) {
            const escaped = phrase.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const regex = new RegExp(`\\b${escaped}\\b`, 'gi');
            return (text.match(regex) || []).length;
        }

        function detectBrokerage(text) {
            if (!text) return null;
            const t = text.toLowerCase();

            // PHASE 1: Exact / highly-specific matches (first-match-wins for these)
            const exactMatches = [
                // Major brokerages - multi-word patterns that are unambiguous
                ['charles schwab', 'schwab'],
                ['schwab & co', 'schwab'],
                ['schwab one', 'schwab'],
                ['td ameritrade', 'td_ameritrade'],
                ['fidelity investments', 'fidelity'],
                ['fidelity brokerage', 'fidelity'],
                ['fidelity netbenefits', 'fidelity'],
                ['national financial services', 'fidelity'],
                ['vanguard group', 'vanguard'],
                ['vanguard brokerage', 'vanguard'],
                ['vanguard marketing', 'vanguard'],
                ['vanguard retirement', 'vanguard'],
                ['e*trade securities', 'etrade'],
                ['etrade securities', 'etrade'],
                ['morgan stanley smith barney', 'morgan_stanley'],
                ['morgan stanley wealth', 'morgan_stanley'],
                ['morgan stanley', 'morgan_stanley'],
                ['ms wealth management', 'morgan_stanley'],
                ['robinhood markets', 'robinhood'],
                ['robinhood securities', 'robinhood'],
                ['merrill lynch', 'merrill'],
                ['merrill edge', 'merrill'],
                ['merrill, pierce', 'merrill'],
                ['interactive brokers', 'interactive_brokers'],
                ['stifel nicolaus', 'stifel'],
                ['stifel, nicolaus', 'stifel'],
                ['stifel financial', 'stifel'],
                ['ally invest', 'ally'],
                ['ally financial', 'ally'],
                ['webull financial', 'webull'],
                ['sofi securities', 'sofi'],
                ['sofi invest', 'sofi'],
                ['sofi wealth', 'sofi'],
                ['betterment securities', 'betterment'],
                ['wealthfront brokerage', 'wealthfront'],
                ['j.p. morgan', 'jpmorgan'],
                ['jp morgan', 'jpmorgan'],
                ['j.p.morgan', 'jpmorgan'],
                ['chase investment', 'jpmorgan'],
                ['wells fargo advisors', 'wells_fargo'],
                ['wells fargo clearing', 'wells_fargo'],
                ['wells fargo', 'wells_fargo'],
                ['firstrade securities', 'firstrade'],
                ['tastyworks', 'tastytrade'],
                ['public.com', 'public_com'],
                ['public holdings', 'public_com'],
                ['m1 finance', 'm1'],
                ['m1 holdings', 'm1'],
                ['pershing llc', 'pershing'],
                ['pershing advisor', 'pershing'],
                ['apex clearing', 'apex'],
                ['apex fintech', 'apex'],
                ['lpl financial', 'lpl'],
                ['lpl securities', 'lpl'],
                ['raymond james financial', 'raymond_james'],
                ['raymond james', 'raymond_james'],
                ['edward jones', 'edward_jones'],
                ['edward d. jones', 'edward_jones'],
                ['ubs financial', 'ubs'],
                ['ubs securities', 'ubs'],
                ['ubs wealth', 'ubs'],
                ['ubs ag', 'ubs'],
                ['goldman sachs', 'goldman'],
                ['marcus by goldman', 'goldman'],
                ['goldman sachs & co', 'goldman'],
                ['robert w. baird', 'baird'],
                ['tiaa-cref', 'tiaa'],
                ['teachers insurance', 'tiaa'],
                ['empower retirement', 'empower'],
                ['empower advisory', 'empower'],
                ['principal financial', 'principal'],
                ['principal life', 'principal'],
                ['principal securities', 'principal'],
                ['northwestern mutual', 'northwestern'],
                ['northwestern mutual investment', 'northwestern'],
                ['ameriprise financial', 'ameriprise'],
                ['janney montgomery scott', 'janney'],
                ['janney montgomery', 'janney'],
                ['oppenheimer & co', 'oppenheimer'],
                ['citi personal wealth', 'citi'],
                ['hilltop securities', 'hilltop'],
                ['hilltop holdings', 'hilltop'],
                ['da davidson', 'da_davidson'],
                ['d.a. davidson', 'da_davidson'],
                ['piper sandler', 'piper_sandler'],
                ['siebert williams', 'siebert'],
                ['moomoo financial', 'moomoo'],
                ['futu securities', 'moomoo'],
                ['futu inc', 'moomoo'],
                ['tiger brokers', 'tiger'],
                ['tigr securities', 'tiger'],
                ['transamerica retirement', 'transamerica'],
                ['john hancock', 'john_hancock'],
                ['t. rowe price', 'troweprice'],
                ['t rowe price', 'troweprice'],
                ['american funds', 'american_funds'],
                ['capital group', 'american_funds'],
                ['td direct investing', 'td_direct'],
                ['rbc direct investing', 'rbc'],
                ['bmo investorline', 'bmo'],
                ['scotia itrade', 'scotia'],
                ['national bank direct', 'nbc'],
                ['cibc investor', 'cibc'],
                ['hargreaves lansdown', 'hargreaves'],
                ['interactive investor', 'ii'],
                ['aj bell', 'ajbell'],
                ['trading 212', 'trading212'],
                ['saxo bank', 'saxo'],
                ['ig group', 'ig'],

                // Retirement plan recordkeepers - specific phrases
                ['acropolis investment', 'acropolis'],
                ['acropolis management', 'acropolis'],
                ['alight solutions', 'alight'],
                ['alight financial', 'alight'],
                ['milliman financial', 'milliman'],
                ['paychex retirement', 'paychex'],
                ['paychex 401', 'paychex'],
                ['adp retirement', 'adp'],
                ['adp totalsource', 'adp'],
                ['guideline 401', 'guideline'],
                ['guideline retirement', 'guideline'],
                ['human interest', 'human_interest'],
                ['vestwell retirement', 'vestwell'],
                ['vestwell 401', 'vestwell'],
                ['ascensus', 'ascensus'],
                ['newport group', 'newport'],
            ];

            for (const [pattern, id] of exactMatches) {
                if (t.includes(pattern)) {
                    return id;
                }
            }

            // PHASE 2: Single-word matches with word boundaries (avoid substring matches)
            const wordMatches = [
                ['schwab', 'schwab'],
                ['ameritrade', 'td_ameritrade'],
                ['fidelity', 'fidelity'],
                ['vanguard', 'vanguard'],
                ['robinhood', 'robinhood'],
                ['webull', 'webull'],
                ['betterment', 'betterment'],
                ['wealthfront', 'wealthfront'],
                ['jpmorgan', 'jpmorgan'],
                ['usaa', 'usaa'],
                ['firstrade', 'firstrade'],
                ['tastytrade', 'tastytrade'],
                ['pershing', 'pershing'],
                ['baird', 'baird'],
                ['tiaa', 'tiaa'],
                ['ameriprise', 'ameriprise'],
                ['oppenheimer', 'oppenheimer'],
                ['citigroup', 'citi'],
                ['citibank', 'citi'],
                ['drivewealth', 'drivewealth'],
                ['tradier', 'tradier'],
                ['tradestation', 'tradestation'],
                ['moomoo', 'moomoo'],
                ['transamerica', 'transamerica'],
                ['manulife', 'john_hancock'],
                ['questrade', 'questrade'],
                ['wealthsimple', 'wealthsimple'],
                ['desjardins', 'desjardins'],
                ['freetrade', 'freetrade'],
                ['degiro', 'degiro'],
                ['etoro', 'etoro'],
                ['revolut', 'revolut'],
                ['stifel', 'stifel'],
                ['ibkr', 'interactive_brokers'],
            ];

            for (const [pattern, id] of wordMatches) {
                if (hasPhrase(t, pattern)) {
                    return id;
                }
            }

            // PHASE 3: Contextual matches - only match if specific context present
            // These are patterns that could cause false positives without context
            const contextualMatches = [
                // 'e*trade' or 'e trade' - needs trade context
                { patterns: ['e*trade', 'e trade', 'e-trade'], id: 'etrade' },
                // 'lpl' is common - only if with 'financial' or 'securities'
                { patterns: ['lpl'], id: 'lpl', requires: ['financial', 'securities', 'advisor'] },
                // 'ubs' alone is fine, but extra certainty with context
                { patterns: ['ubs'], id: 'ubs' },
            ];

            for (const cm of contextualMatches) {
                for (const p of cm.patterns) {
                    if (hasPhrase(t, p)) {
                        if (!cm.requires) return cm.id;
                        for (const req of cm.requires) {
                            if (hasPhrase(t, req)) return cm.id;
                        }
                    }
                }
            }

            // PHASE 4: Retirement plan recordkeepers - detect by plan/recordkeeper language
            const recordkeeperPatterns = [
                { id: 'acropolis', patterns: ['acropolis'] },
                { id: 'alight', patterns: ['alight'] },
                { id: 'milliman', patterns: ['milliman'] },
                { id: 'paychex', patterns: ['paychex'] },
                { id: 'adp', patterns: ['adp'] },
                { id: 'guideline', patterns: ['guideline'], requires: ['401', 'retirement', 'plan'] },
                { id: 'human_interest', patterns: ['human interest'] },
                { id: 'vestwell', patterns: ['vestwell'] },
                { id: 'ascensus', patterns: ['ascensus'] },
                { id: 'newport', patterns: ['newport'], requires: ['retirement', '401', 'plan', 'group'] },
                { id: 'empower', patterns: ['empower'], requires: ['retirement', '401', 'plan'] },
                { id: 'principal', patterns: ['principal'], requires: ['retirement', '401', 'plan', 'financial'] },
            ];

            for (const rp of recordkeeperPatterns) {
                for (const p of rp.patterns) {
                    if (hasPhrase(t, p)) {
                        if (!rp.requires) return rp.id;
                        for (const req of rp.requires) {
                            if (hasPhrase(t, req)) return rp.id;
                        }
                    }
                }
            }

            return null;
        }

        // Brokerage domain mapping for favicon API
        const BROKERAGE_DOMAINS = {
            // Major US brokerages
            schwab: 'schwab.com',
            fidelity: 'fidelity.com',
            vanguard: 'vanguard.com',
            etrade: 'etrade.com',
            td_ameritrade: 'tdameritrade.com',
            robinhood: 'robinhood.com',
            merrill: 'merrilledge.com',
            morgan_stanley: 'morganstanley.com',
            interactive_brokers: 'interactivebrokers.com',
            stifel: 'stifel.com',

            // Online / fintech brokerages
            ally: 'ally.com',
            webull: 'webull.com',
            sofi: 'sofi.com',
            betterment: 'betterment.com',
            wealthfront: 'wealthfront.com',
            jpmorgan: 'chase.com',
            wells_fargo: 'wellsfargoadvisors.com',
            usaa: 'usaa.com',
            firstrade: 'firstrade.com',
            tastytrade: 'tastytrade.com',
            public_com: 'public.com',
            m1: 'm1.com',
            moomoo: 'moomoo.com',
            tiger: 'tigerbrokers.com',
            stake: 'hellostake.com',
            tradestation: 'tradestation.com',
            tradier: 'tradier.com',
            drivewealth: 'drivewealth.com',

            // Wirehouses / full-service
            ubs: 'ubs.com',
            goldman: 'goldmansachs.com',
            baird: 'rwbaird.com',
            citi: 'citi.com',
            ameriprise: 'ameriprise.com',
            northwestern: 'northwesternmutual.com',
            oppenheimer: 'opco.com',
            janney: 'janney.com',
            hilltop: 'hilltopsecurities.com',
            da_davidson: 'dadavidson.com',
            piper_sandler: 'pipersandler.com',
            siebert: 'siebert.com',

            // Clearing / custodian firms
            pershing: 'pershing.com',
            apex: 'apexclearing.com',
            lpl: 'lpl.com',
            raymond_james: 'raymondjames.com',
            edward_jones: 'edwardjones.com',

            // Retirement / 401k
            tiaa: 'tiaa.org',
            empower: 'empower.com',
            principal: 'principal.com',
            transamerica: 'transamerica.com',
            john_hancock: 'johnhancock.com',
            troweprice: 'troweprice.com',
            american_funds: 'americanfunds.com',

            // Recordkeepers / Plan Administrators
            acropolis: 'acrinv.com',
            alight: 'alight.com',
            milliman: 'milliman.com',
            paychex: 'paychex.com',
            adp: 'adp.com',
            guideline: 'guideline.com',
            human_interest: 'humaninterest.com',
            vestwell: 'vestwell.com',
            ascensus: 'ascensus.com',
            newport: 'newportgroup.com',

            // Canadian
            questrade: 'questrade.com',
            wealthsimple: 'wealthsimple.com',
            td_direct: 'td.com',
            rbc: 'rbcdirectinvesting.com',
            bmo: 'bmo.com',
            scotia: 'scotiabank.com',
            nbc: 'nbc.ca',
            cibc: 'cibc.com',
            desjardins: 'desjardins.com',

            // UK / International
            hargreaves: 'hl.co.uk',
            ii: 'ii.co.uk',
            ajbell: 'ajbell.co.uk',
            freetrade: 'freetrade.io',
            trading212: 'trading212.com',
            degiro: 'degiro.com',
            saxo: 'home.saxo',
            ig: 'ig.com',
            etoro: 'etoro.com',
            revolut: 'revolut.com',

            // Special cases
            plaid: 'plaid.com',

            // No favicon for these
            csv: null,
            saved: null,
            manual: null,
            unknown: null,
        };

        function getBrokerageFavicon(brokerage) {
            if (!brokerage) return null;
            const domain = BROKERAGE_DOMAINS[brokerage.toLowerCase()];
            if (!domain) return null;
            return `https://www.google.com/s2/favicons?domain=${domain}&sz=64`;
        }

        function getBrokerageName(brokerage) {
            const names = {
                // Major US brokerages
                schwab: 'Charles Schwab',
                fidelity: 'Fidelity',
                vanguard: 'Vanguard',
                etrade: 'E*TRADE',
                td_ameritrade: 'TD Ameritrade',
                robinhood: 'Robinhood',
                merrill: 'Merrill Edge',
                morgan_stanley: 'Morgan Stanley',
                interactive_brokers: 'Interactive Brokers',
                stifel: 'Stifel',
                // Online / fintech
                ally: 'Ally Invest',
                webull: 'Webull',
                sofi: 'SoFi',
                betterment: 'Betterment',
                wealthfront: 'Wealthfront',
                jpmorgan: 'J.P. Morgan',
                wells_fargo: 'Wells Fargo',
                usaa: 'USAA',
                firstrade: 'Firstrade',
                tastytrade: 'tastytrade',
                public_com: 'Public',
                m1: 'M1 Finance',
                moomoo: 'moomoo',
                tiger: 'Tiger Brokers',
                tradestation: 'TradeStation',
                tradier: 'Tradier',
                drivewealth: 'DriveWealth',
                stake: 'Stake',
                // Wirehouses / full-service
                ubs: 'UBS',
                goldman: 'Goldman Sachs',
                baird: 'Baird',
                citi: 'Citi',
                ameriprise: 'Ameriprise',
                northwestern: 'Northwestern Mutual',
                oppenheimer: 'Oppenheimer',
                janney: 'Janney',
                hilltop: 'Hilltop Securities',
                da_davidson: 'D.A. Davidson',
                piper_sandler: 'Piper Sandler',
                siebert: 'Siebert',
                // Clearing / custodian
                pershing: 'Pershing',
                apex: 'Apex Clearing',
                lpl: 'LPL Financial',
                raymond_james: 'Raymond James',
                edward_jones: 'Edward Jones',
                // Retirement / 401k
                tiaa: 'TIAA',
                empower: 'Empower',
                principal: 'Principal',
                transamerica: 'Transamerica',
                john_hancock: 'John Hancock',
                troweprice: 'T. Rowe Price',
                american_funds: 'American Funds',
                // Recordkeepers / Plan Administrators
                acropolis: 'Acropolis',
                alight: 'Alight',
                milliman: 'Milliman',
                paychex: 'Paychex',
                adp: 'ADP',
                guideline: 'Guideline',
                human_interest: 'Human Interest',
                vestwell: 'Vestwell',
                ascensus: 'Ascensus',
                newport: 'Newport Group',
                // Canadian
                questrade: 'Questrade',
                wealthsimple: 'Wealthsimple',
                td_direct: 'TD Direct',
                rbc: 'RBC',
                bmo: 'BMO',
                scotia: 'Scotiabank',
                nbc: 'National Bank',
                cibc: 'CIBC',
                desjardins: 'Desjardins',
                // UK / International
                hargreaves: 'Hargreaves Lansdown',
                ii: 'interactive investor',
                ajbell: 'AJ Bell',
                freetrade: 'Freetrade',
                trading212: 'Trading 212',
                degiro: 'DEGIRO',
                saxo: 'Saxo Bank',
                ig: 'IG',
                etoro: 'eToro',
                revolut: 'Revolut',
                // Special
                plaid: 'Connected Account',
                csv: 'Account',
                saved: 'Saved Portfolio',
                manual: 'Manual Entry',
            };
            const base = names[brokerage] || brokerage || 'Account';
            const count = accounts.filter(a => a.name.startsWith(base)).length + 1;
            return count > 1 ? `${base} ${count}` : base;
        }

        // Store uploaded files for redacted download
        let uploadedFiles = [];

        // PII patterns to redact
        const PII_PATTERNS = [
            // Account numbers (various formats)
            { regex: /\b\d{4}[-\s]?\d{4}[-\s]?\d{4}[-\s]?\d{4}\b/g, name: 'account' },
            { regex: /\b[A-Z]{0,2}\d{6,12}\b/g, name: 'account' },
            { regex: /Account\s*#?\s*:?\s*[\w\d-]{6,}/gi, name: 'account' },
            // SSN
            { regex: /\b\d{3}[-\s]?\d{2}[-\s]?\d{4}\b/g, name: 'ssn' },
            // Phone numbers
            { regex: /\b\(?\d{3}\)?[-.\s]?\d{3}[-.\s]?\d{4}\b/g, name: 'phone' },
            // Email addresses
            { regex: /\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/g, name: 'email' },
            // Addresses (simplified - street numbers and zip codes)
            { regex: /\b\d{1,5}\s+[\w\s]{5,30}(Street|St|Avenue|Ave|Road|Rd|Boulevard|Blvd|Drive|Dr|Lane|Ln|Way|Court|Ct)\b/gi, name: 'address' },
            { regex: /\b\d{5}(-\d{4})?\b/g, name: 'zip' },
        ];

        // Initialize PDF.js worker
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        }

        async function redactPdfClient(fileBytes, fileName) {
            try {
                const { PDFDocument, rgb, StandardFonts } = PDFLib;

                // Load the PDF
                const pdfDoc = await PDFDocument.load(fileBytes, { ignoreEncryption: true });
                const pages = pdfDoc.getPages();

                // Also use pdf.js to extract text positions
                const loadingTask = pdfjsLib.getDocument({ data: fileBytes });
                const pdfJs = await loadingTask.promise;

                for (let pageIndex = 0; pageIndex < pages.length; pageIndex++) {
                    const page = pages[pageIndex];
                    const { width, height } = page.getSize();

                    // Get text content with positions from pdf.js
                    const pdfJsPage = await pdfJs.getPage(pageIndex + 1);
                    const textContent = await pdfJsPage.getTextContent();

                    // Find PII in text items and draw black boxes
                    for (const item of textContent.items) {
                        const text = item.str;
                        const transform = item.transform;

                        for (const pattern of PII_PATTERNS) {
                            if (pattern.regex.test(text)) {
                                // Reset regex
                                pattern.regex.lastIndex = 0;

                                // Calculate position (pdf.js uses bottom-left origin like PDF)
                                const x = transform[4];
                                const y = transform[5];
                                const itemWidth = item.width || text.length * 6;
                                const itemHeight = item.height || 12;

                                // Draw black rectangle over PII
                                page.drawRectangle({
                                    x: x - 2,
                                    y: y - 2,
                                    width: itemWidth + 4,
                                    height: itemHeight + 4,
                                    color: rgb(0, 0, 0),
                                });
                            }
                        }
                    }
                }

                // Save the redacted PDF
                const redactedBytes = await pdfDoc.save();
                return {
                    bytes: redactedBytes,
                    name: `redacted_${fileName}`
                };
            } catch (err) {
                console.error('PDF redaction error:', err);
                return null;
            }
        }

        async function parseFile(file) {
            const formData = new FormData();
            const redactPii = document.getElementById('redactPiiToggle')?.checked ?? true;
            const isPdf = file.name.toLowerCase().endsWith('.pdf');

            // Store original file for redaction
            if (isPdf && redactPii) {
                const fileBytes = await file.arrayBuffer();
                uploadedFiles.push({
                    name: file.name,
                    id: Date.now() + Math.random(),
                    type: 'pdf',
                    bytes: new Uint8Array(fileBytes)
                });

                // Show download button
                const downloadBtn = document.getElementById('downloadRedactedBtn');
                if (downloadBtn) {
                    downloadBtn.style.display = 'inline-flex';
                }
            }

            formData.append('file', file);
            formData.append('redact_pii', redactPii);

            const res = await fetch(`${API_URL}/parse`, { method: 'POST', body: formData });
            return res.json();
        }

        async function downloadRedactedPdf() {
            const pdfFiles = uploadedFiles.filter(f => f.type === 'pdf' && f.bytes);

            if (pdfFiles.length === 0) {
                showToast('No PDF files to download', 'error');
                return;
            }

            showToast('Redacting sensitive information...', 'info', { duration: 3000 });

            try {
                // Process each PDF
                const redactedPdfs = [];
                for (const pdfFile of pdfFiles) {
                    const result = await redactPdfClient(pdfFile.bytes, pdfFile.name);
                    if (result) {
                        redactedPdfs.push(result);
                    }
                }

                if (redactedPdfs.length === 0) {
                    showToast('Failed to redact PDFs', 'error');
                    return;
                }

                // If single file, download directly
                if (redactedPdfs.length === 1) {
                    const blob = new Blob([redactedPdfs[0].bytes], { type: 'application/pdf' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = redactedPdfs[0].name;
                    document.body.appendChild(a);
                    a.click();
                    URL.revokeObjectURL(url);
                    a.remove();
                } else {
                    // Multiple files - merge them
                    const { PDFDocument } = PDFLib;
                    const mergedPdf = await PDFDocument.create();

                    for (const pdf of redactedPdfs) {
                        const srcDoc = await PDFDocument.load(pdf.bytes);
                        const pages = await mergedPdf.copyPages(srcDoc, srcDoc.getPageIndices());
                        pages.forEach(page => mergedPdf.addPage(page));
                    }

                    const mergedBytes = await mergedPdf.save();
                    const blob = new Blob([mergedBytes], { type: 'application/pdf' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'redacted_statements.pdf';
                    document.body.appendChild(a);
                    a.click();
                    URL.revokeObjectURL(url);
                    a.remove();
                }

                showToast('Redacted PDF downloaded successfully', 'success');
            } catch (err) {
                console.error('Download error:', err);
                showToast('Failed to create redacted PDF: ' + err.message, 'error');
            }
        }

        function renderAccounts() {
            accountsSection.style.display = accounts.length ? 'block' : 'none';
            analyzeBtn.disabled = !accounts.length;
            accountsList.innerHTML = accounts.map(a => {
                const faviconUrl = getBrokerageFavicon(a.brokerage);
                const hasFavicon = !!faviconUrl;
                const fallbackLetter = (a.brokerage || 'A')[0].toUpperCase();
                return `
                <div class="account-item">
                    <div class="account-icon ${hasFavicon ? 'has-favicon' : 'no-favicon'}">
                        ${hasFavicon
                            ? `<img src="${faviconUrl}"
                                   alt="${getBrokerageName(a.brokerage)}"
                                   class="account-favicon"
                                   onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                               <span class="account-icon-fallback" style="display:none;">${fallbackLetter}</span>`
                            : fallbackLetter
                        }
                    </div>
                    <div class="account-details">
                        <input type="text" class="account-name-input" value="${a.name}" onchange="updateName(${a.id}, this.value)">
                        <div class="account-meta">${a.positions.length} positions</div>
                    </div>
                    <div class="account-value">${formatCurrency(a.totalValue)}</div>
                    <button class="remove-btn" onclick="removeAccount(${a.id})">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                </div>
            `}).join('');
        }

        function updateName(id, name) {
            const acc = accounts.find(a => a.id === id);
            if (acc) acc.name = name;
        }

        function removeAccount(id) {
            accounts = accounts.filter(a => a.id !== id);
            renderAccounts();
        }

        function aggregatePositions() {
            const agg = {};
            accounts.forEach(acc => {
                acc.positions.forEach(pos => {
                    if (!agg[pos.symbol]) agg[pos.symbol] = { ...pos, shares: 0, value: 0 };
                    agg[pos.symbol].shares += pos.shares || 0;
                    agg[pos.symbol].value += pos.value || 0;
                    if (!agg[pos.symbol].description && pos.description) agg[pos.symbol].description = pos.description;
                });
            });
            Object.values(agg).forEach(p => { if (p.shares > 0) p.price = p.value / p.shares; });
            return Object.values(agg);
        }

        async function analyzePortfolio() {
            if (!accounts.length) return;

            // Start or continue progress tracking
            const isNewProgress = !progressManager.startTime;
            if (isNewProgress) {
                showProgress('Analyzing portfolio...', { start: true, totalFiles: 1, stage: 'analyze' });
            } else {
                progressManager.setStage('analyze', 'Analyzing portfolio...');
            }

            try {
                const res = await fetch(`${API_URL}/analyze`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ positions: aggregatePositions(), include_risk: true })
                });
                if (!res.ok) throw new Error('Analysis failed');
                portfolioData = await res.json();

                // Transition to render stage
                progressManager.setStage('render', 'Building dashboard...');

                hideError();
                await showDashboard();

                // Track last analysis date
                localStorage.setItem('lastAnalysisDate', new Date().toISOString());

                // Complete progress
                progressManager.complete();

                // Brief delay to show 100% before hiding
                await new Promise(r => setTimeout(r, 400));
                hideProgress();

            } catch (err) {
                hideProgress();
                showError('Analysis failed: ' + err.message);
            }
        }

        async function showDashboard() {
            uploadSection.style.display = 'none';
            dashboard.style.display = 'block';
            hideLandingSections(); // Hide landing page when showing results
            // Also hide user dashboard if visible
            const userDashboard = document.getElementById('userDashboard');
            if (userDashboard) userDashboard.style.display = 'none';
            document.getElementById('totalBadge').textContent = formatCurrency(portfolioData.total_value);

            // Chunked rendering for better perceived performance
            // Each render is wrapped in requestAnimationFrame for smoother UI
            const renderTasks = [
                { name: 'Allocation', fn: renderAllocation, progress: 87 },
                { name: 'Insights', fn: renderInsights, progress: 89 },
                { name: 'Performance', fn: renderPerformance, progress: 92 },
                { name: 'Sectors', fn: renderSectors, progress: 94 },
                { name: 'Geography', fn: renderGeography, progress: 96 },
                { name: 'Risk', fn: renderRisk, progress: 97 },
                { name: 'Holdings', fn: renderHoldings, progress: 99 }
            ];

            for (const task of renderTasks) {
                await new Promise(resolve => {
                    requestAnimationFrame(() => {
                        task.fn();
                        progressManager.setProgress(task.progress);
                        resolve();
                    });
                });
                // Small yield to allow UI updates
                await new Promise(r => setTimeout(r, 10));
            }

            // Final setup tasks
            updateCompareSelectors();
            initWhatIf();

            // Initialize allocation tab features (heat map, suggestions, etc.)
            if (typeof window.switchTab === 'function') {
                window.switchTab('allocation');
            }
        }

        function renderInsights() {
            const container = document.getElementById('insightsList');
            let insights = portfolioData.insights || [];

            // Fix concentration insight if it shows 0% (backend calculation bug)
            const positions = portfolioData.positions || [];
            const totalValue = portfolioData.total_value || 0;
            if (positions.length > 0 && totalValue > 0) {
                const sortedPositions = [...positions].sort((a, b) => (b.value || 0) - (a.value || 0));
                const top10Value = sortedPositions.slice(0, 10).reduce((sum, p) => sum + (p.value || 0), 0);
                const top10Pct = (top10Value / totalValue * 100).toFixed(1);

                insights = insights.map(insight => {
                    if (insight.title === 'Well Diversified' && insight.text.includes('0%')) {
                        const isConcentrated = parseFloat(top10Pct) > 80;
                        return {
                            ...insight,
                            type: isConcentrated ? 'warning' : 'positive',
                            title: isConcentrated ? 'High Concentration' : 'Well Diversified',
                            text: `Your top 10 holdings represent ${top10Pct}% of your portfolio. ${
                                isConcentrated
                                    ? 'Consider spreading investments across more holdings to reduce concentration risk.'
                                    : 'This diversification helps protect against individual stock volatility.'
                            }`
                        };
                    }
                    return insight;
                });
            }

            if (!insights.length) {
                container.innerHTML = `
                    <div class="no-insights">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <circle cx="12" cy="12" r="10"/>
                            <path d="M12 16v-4M12 8h.01"/>
                        </svg>
                        <p>No insights available for this portfolio.</p>
                    </div>
                `;
                return;
            }

            const getIcon = (type, category) => {
                if (type === 'warning') return '';
                if (type === 'positive') return '';
                // Category-based icons for info type
                const categoryIcons = {
                    'Portfolio Size': '',
                    'Asset Allocation': '',
                    'Concentration': '',
                    'Sectors': '',
                    'Geography': '',
                    'Risk': '',
                    'Projections': '',
                    'Diversification': ''
                };
                return categoryIcons[category] || '';
            };

            container.innerHTML = insights.map(insight => `
                <div class="insight-card insight-${insight.type || 'info'}">
                    <div class="insight-header">
                        <div class="insight-icon">${getIcon(insight.type, insight.category)}</div>
                        <span class="insight-category">${insight.category || 'Insight'}</span>
                    </div>
                    <div class="insight-title">${insight.title}</div>
                    <div class="insight-text">${insight.text}</div>
                </div>
            `).join('');
        }

        function renderAllocation() {
            const alloc = portfolioData.asset_allocation || {};
            const vals = portfolioData.asset_allocation_values || {};
            const stocks = alloc.Stocks || 0;
            const bonds = alloc.Bonds || 0;
            const cash = alloc.Cash || 0;
            const alts = (alloc['Real Estate'] || 0) + (alloc.Crypto || 0) + (alloc.Commodities || 0);

            document.getElementById('stocksPct').textContent = stocks.toFixed(1) + '%';
            document.getElementById('bondsPct').textContent = bonds.toFixed(1) + '%';
            document.getElementById('cashPct').textContent = cash.toFixed(1) + '%';
            document.getElementById('altsPct').textContent = alts.toFixed(1) + '%';
            document.getElementById('stocksVal').textContent = formatCurrency(vals.Stocks || 0);
            document.getElementById('bondsVal').textContent = formatCurrency(vals.Bonds || 0);
            document.getElementById('cashVal').textContent = formatCurrency(vals.Cash || 0);
            document.getElementById('altsVal').textContent = formatCurrency((vals['Real Estate'] || 0) + (vals.Crypto || 0) + (vals.Commodities || 0));

            renderDoughnut('allocationChart', alloc, {
                Stocks: '#30d158', Bonds: '#635bff', Cash: '#ffd60a',
                'Real Estate': '#bf5af2', Crypto: '#ff9f0a', Commodities: '#64d2ff'
            });

            const subClass = portfolioData.sub_class_allocation || {};
            renderSubClassChart('subClassChart', subClass, portfolioData.positions || []);
        }

        // Map sub-classes to their parent asset class
        function getAssetClassForSubClass(subClassName, positions) {
            // Find a position with this sub-class to get the asset class
            for (const pos of positions) {
                if (pos.classification && pos.classification.sub_class === subClassName) {
                    return pos.classification.asset_class;
                }
            }
            // Fallback mapping
            const subClassMap = {
                'US Total Market': 'Stocks', 'US Large Cap': 'Stocks', 'US Large Cap Growth': 'Stocks',
                'US Large Cap Value': 'Stocks', 'US Mid Cap': 'Stocks', 'US Mid Cap Growth': 'Stocks',
                'US Mid Cap Value': 'Stocks', 'US Small Cap': 'Stocks', 'US Small Cap Growth': 'Stocks',
                'US Small Cap Value': 'Stocks', 'US Mega Cap': 'Stocks', 'US Dividend': 'Stocks',
                'US Dividend Growth': 'Stocks', 'US High Dividend': 'Stocks',
                'International Developed': 'Stocks', 'International Total': 'Stocks',
                'International Small Cap': 'Stocks', 'International Dividend': 'Stocks',
                'Emerging Markets': 'Stocks', 'Europe': 'Stocks', 'Pacific': 'Stocks',
                'Japan': 'Stocks', 'China': 'Stocks', 'India': 'Stocks', 'Brazil': 'Stocks',
                'Global': 'Stocks', 'Germany': 'Stocks', 'UK': 'Stocks', 'Canada': 'Stocks',
                'Australia': 'Stocks', 'Taiwan': 'Stocks', 'South Korea': 'Stocks', 'MLPs': 'Stocks',
                'US Treasury': 'Bonds', 'TIPS': 'Bonds', 'US Aggregate': 'Bonds',
                'Short-Term Bond': 'Bonds', 'Intermediate Bond': 'Bonds', 'Long-Term Bond': 'Bonds',
                'Investment Grade Corp': 'Bonds', 'High Yield': 'Bonds', 'Municipal': 'Bonds',
                'Mortgage-Backed': 'Bonds', 'International Developed': 'Bonds',
                'International Aggregate': 'Bonds', 'International Treasury': 'Bonds',
                'Cash': 'Cash', 'Money Market': 'Cash',
                'US REITs': 'Real Estate', 'International REITs': 'Real Estate',
                'Bitcoin': 'Crypto', 'Ethereum': 'Crypto', 'DeFi': 'Crypto',
                'Gold': 'Commodities', 'Silver': 'Commodities', 'Platinum': 'Commodities',
                'Palladium': 'Commodities', 'Broad Commodities': 'Commodities',
                'Oil': 'Commodities', 'Natural Gas': 'Commodities', 'Agriculture': 'Commodities'
            };
            return subClassMap[subClassName] || 'Stocks';
        }

        function generateShades(baseColor, count) {
            // Convert hex to HSL, then generate shades
            const hex = baseColor.replace('#', '');
            const r = parseInt(hex.substr(0, 2), 16) / 255;
            const g = parseInt(hex.substr(2, 2), 16) / 255;
            const b = parseInt(hex.substr(4, 2), 16) / 255;

            const max = Math.max(r, g, b), min = Math.min(r, g, b);
            let h, s, l = (max + min) / 2;

            if (max === min) {
                h = s = 0;
            } else {
                const d = max - min;
                s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                switch (max) {
                    case r: h = ((g - b) / d + (g < b ? 6 : 0)) / 6; break;
                    case g: h = ((b - r) / d + 2) / 6; break;
                    case b: h = ((r - g) / d + 4) / 6; break;
                }
            }

            // Base color is darkest, then get progressively lighter
            const shades = [];
            const maxL = Math.min(0.9, l + 0.45); // How light the lightest shade can be
            const step = count > 1 ? (maxL - l) / (count - 1) : 0;

            for (let i = 0; i < count; i++) {
                const newL = l + (step * i); // Start at base color lightness, go lighter
                shades.push(hslToHex(h, s, newL));
            }
            return shades;
        }

        function hslToHex(h, s, l) {
            let r, g, b;
            if (s === 0) {
                r = g = b = l;
            } else {
                const hue2rgb = (p, q, t) => {
                    if (t < 0) t += 1;
                    if (t > 1) t -= 1;
                    if (t < 1/6) return p + (q - p) * 6 * t;
                    if (t < 1/2) return q;
                    if (t < 2/3) return p + (q - p) * (2/3 - t) * 6;
                    return p;
                };
                const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
                const p = 2 * l - q;
                r = hue2rgb(p, q, h + 1/3);
                g = hue2rgb(p, q, h);
                b = hue2rgb(p, q, h - 1/3);
            }
            const toHex = x => {
                const hex = Math.round(x * 255).toString(16);
                return hex.length === 1 ? '0' + hex : hex;
            };
            return `#${toHex(r)}${toHex(g)}${toHex(b)}`;
        }

        function renderSubClassChart(id, data, positions) {
            const ctx = document.getElementById(id).getContext('2d');
            if (charts[id]) charts[id].destroy();

            const assetColors = {
                Stocks: '#30d158', Bonds: '#635bff', Cash: '#ffd60a',
                'Real Estate': '#bf5af2', Crypto: '#ff9f0a', Commodities: '#64d2ff'
            };

            // Group sub-classes by asset class
            const grouped = {};
            Object.keys(data).forEach(subClass => {
                if (data[subClass] <= 0) return;
                const assetClass = getAssetClassForSubClass(subClass, positions);
                if (!grouped[assetClass]) grouped[assetClass] = [];
                grouped[assetClass].push({ name: subClass, value: data[subClass] });
            });

            // Sort each group by value (descending) and generate colors
            const labels = [];
            const values = [];
            const colors = [];

            Object.keys(grouped).sort().forEach(assetClass => {
                const items = grouped[assetClass].sort((a, b) => b.value - a.value);
                const baseColor = assetColors[assetClass] || '#8e8e93';
                const shades = generateShades(baseColor, items.length);

                items.forEach((item, idx) => {
                    labels.push(item.name);
                    values.push(item.value);
                    colors.push(shades[idx]); // Darkest first (highest allocation)
                });
            });

            charts[id] = new Chart(ctx, {
                type: 'doughnut',
                data: { labels, datasets: [{ data: values, backgroundColor: colors, borderWidth: 0 }] },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right', labels: { padding: 16, usePointStyle: true, font: { size: 12 } } },
                        tooltip: { callbacks: { label: ctx => `${ctx.label}: ${ctx.raw.toFixed(1)}%` } }
                    }
                }
            });
        }

        function renderPerformance() {
            const perf = portfolioData.historical_performance || {};
            let returns = perf.returns || {};
            const periods = ['1M', '3M', '6M', 'YTD', '1Y', '3Y', '5Y'];

            // Generate simulated historical returns if not provided by backend
            // This creates realistic estimates based on portfolio composition
            function generateSimulatedReturns() {
                const allocation = portfolioData.allocation || {};
                const stockPct = (allocation.stocks || allocation.Stocks || 0) / 100;
                const bondPct = (allocation.bonds || allocation.Bonds || allocation['Fixed Income'] || 0) / 100;
                const cashPct = (allocation.cash || allocation.Cash || 0) / 100;
                const otherPct = 1 - stockPct - bondPct - cashPct;

                // Historical average annual returns (approximate)
                const stockReturn = 10.5; // S&P 500 historical average
                const bondReturn = 4.5;   // Bond market average
                const cashReturn = 2.0;   // Cash/money market
                const otherReturn = 7.0;  // Alternatives, REITs, etc.

                // S&P 500 benchmark returns
                const benchmarkReturn = 10.5;

                // Weighted portfolio annual return estimate
                const annualReturn = (stockPct * stockReturn) + (bondPct * bondReturn) +
                                    (cashPct * cashReturn) + (otherPct * otherReturn);

                // Add some realistic variance (30% of base return)
                const variance = () => (Math.random() - 0.5) * 0.6;

                // Calculate returns for each period
                const periodMonths = { '1M': 1, '3M': 3, '6M': 6, 'YTD': new Date().getMonth() + 1, '1Y': 12, '3Y': 36, '5Y': 60 };
                const simulated = {};

                for (const [period, months] of Object.entries(periodMonths)) {
                    const years = months / 12;
                    // Compound the annual return for the period with variance
                    const portReturn = (Math.pow(1 + (annualReturn / 100) * (1 + variance()), years) - 1) * 100;
                    const benchReturn = (Math.pow(1 + (benchmarkReturn / 100) * (1 + variance()), years) - 1) * 100;
                    simulated[period] = {
                        portfolio: portReturn,
                        benchmark: benchReturn
                    };
                }
                return simulated;
            }

            // Check if we have valid returns data
            const hasValidReturns = Object.keys(returns).length > 0 &&
                Object.values(returns).some(r => r && r.portfolio !== null && r.portfolio !== undefined && r.portfolio !== 0);

            // Generate simulated returns if no valid data
            if (!hasValidReturns && !perf.chart_data) {
                returns = generateSimulatedReturns();
            }

            // Calculate returns from chart data if not provided by backend
            if (perf.chart_data && perf.chart_data.labels && perf.chart_data.portfolio) {
                const chartData = perf.chart_data;
                const labels = chartData.labels;
                const portfolio = chartData.portfolio;
                const benchmark = chartData.benchmark;
                const lastDate = new Date(labels[labels.length - 1]);
                const lastPortVal = portfolio[portfolio.length - 1];
                const lastBenchVal = benchmark ? benchmark[benchmark.length - 1] : null;

                // Helper to find return for a period
                function calcReturnFromChart(daysBack) {
                    const targetDate = new Date(lastDate);
                    targetDate.setDate(targetDate.getDate() - daysBack);

                    // Find the closest date at or before target
                    let idx = -1;
                    for (let i = labels.length - 1; i >= 0; i--) {
                        if (new Date(labels[i]) <= targetDate) {
                            idx = i;
                            break;
                        }
                    }
                    if (idx < 0) return { portfolio: null, benchmark: null };

                    const portReturn = ((lastPortVal / portfolio[idx]) - 1) * 100;
                    const benchReturn = benchmark ? ((lastBenchVal / benchmark[idx]) - 1) * 100 : null;
                    return { portfolio: portReturn, benchmark: benchReturn };
                }

                // Fill in missing period returns from chart data
                const periodDays = { '1M': 30, '3M': 90, '6M': 180, '1Y': 365, '3Y': 1095, '5Y': 1825 };
                for (const [period, days] of Object.entries(periodDays)) {
                    if (!returns[period] || returns[period].portfolio === null) {
                        const calc = calcReturnFromChart(days);
                        if (calc.portfolio !== null) {
                            returns[period] = calc;
                        }
                    }
                }

                // Calculate YTD if missing
                if (!returns['YTD'] || returns['YTD'].portfolio === null) {
                    const yearStart = new Date(lastDate.getFullYear(), 0, 1);
                    let idx = -1;
                    for (let i = 0; i < labels.length; i++) {
                        if (new Date(labels[i]) >= yearStart) {
                            idx = i;
                            break;
                        }
                    }
                    if (idx >= 0) {
                        const portReturn = ((lastPortVal / portfolio[idx]) - 1) * 100;
                        const benchReturn = benchmark ? ((lastBenchVal / benchmark[idx]) - 1) * 100 : null;
                        returns['YTD'] = { portfolio: portReturn, benchmark: benchReturn };
                    }
                }
            }

            document.getElementById('returnsGrid').innerHTML = periods.map(p => {
                const data = returns[p] || {};
                const val = data.portfolio;
                const bench = data.benchmark;
                const cls = val > 0 ? 'positive' : val < 0 ? 'negative' : '';
                return `
                    <div class="stat-card return-card" data-period="${p}">
                        <div class="stat-label">${p}</div>
                        <div class="stat-value ${cls}">${val !== null && val !== undefined ? (val > 0 ? '+' : '') + val.toFixed(2) + '%' : '--'}</div>
                        <div class="benchmark-label">S&P: ${bench !== null && bench !== undefined ? (bench > 0 ? '+' : '') + bench.toFixed(2) + '%' : '--'}</div>
                    </div>
                `;
            }).join('');

            // Generate simulated chart data if not provided by backend
            function generateSimulatedChartData() {
                const allocation = portfolioData.allocation || {};
                const stockPct = (allocation.stocks || allocation.Stocks || 0) / 100;
                const bondPct = (allocation.bonds || allocation.Bonds || allocation['Fixed Income'] || 0) / 100;
                const cashPct = (allocation.cash || allocation.Cash || 0) / 100;
                const otherPct = Math.max(0, 1 - stockPct - bondPct - cashPct);

                // Annual return estimates
                const portfolioAnnualReturn = (stockPct * 10.5) + (bondPct * 4.5) + (cashPct * 2.0) + (otherPct * 7.0);
                const sp500AnnualReturn = 10.5;
                const bondsAnnualReturn = 4.5;
                const worldAnnualReturn = 9.0;
                const sixtyFortyAnnualReturn = 8.0;

                // Generate 5 years of monthly data points
                const labels = [];
                const portfolio = [];
                const sp500 = [];
                const bonds = [];
                const world = [];
                const sixty_forty = [];

                const endDate = new Date();
                const startDate = new Date();
                startDate.setFullYear(startDate.getFullYear() - 5);

                // Start all at 100 (indexed)
                let portValue = 100, spValue = 100, bondValue = 100, worldValue = 100, sfValue = 100;

                // Monthly volatility factors
                const monthlyVolatility = (annualReturn) => {
                    const monthlyReturn = annualReturn / 12 / 100;
                    const noise = (Math.random() - 0.5) * 0.04; // 2% monthly variance
                    return 1 + monthlyReturn + noise;
                };

                let currentDate = new Date(startDate);
                while (currentDate <= endDate) {
                    labels.push(currentDate.toISOString().split('T')[0]);
                    portfolio.push(portValue);
                    sp500.push(spValue);
                    bonds.push(bondValue);
                    world.push(worldValue);
                    sixty_forty.push(sfValue);

                    // Apply monthly returns with variance
                    portValue *= monthlyVolatility(portfolioAnnualReturn);
                    spValue *= monthlyVolatility(sp500AnnualReturn);
                    bondValue *= monthlyVolatility(bondsAnnualReturn);
                    worldValue *= monthlyVolatility(worldAnnualReturn);
                    sfValue *= monthlyVolatility(sixtyFortyAnnualReturn);

                    currentDate.setMonth(currentDate.getMonth() + 1);
                }

                return { labels, portfolio, sp500, bonds, world, sixty_forty };
            }

            // Store full chart data for filtering
            if (perf.chart_data) {
                fullChartData = perf.chart_data;
            } else if (!hasValidReturns) {
                // Generate simulated chart data when no backend data
                fullChartData = generateSimulatedChartData();
            }

            if (fullChartData) {
                renderLineChart(fullChartData, currentPeriod);
            }

            // Add click handlers for return cards
            document.querySelectorAll('.return-card').forEach(card => {
                card.addEventListener('click', () => {
                    const period = card.dataset.period;
                    selectPeriod(period);
                });
            });

            // Add click handlers for period buttons
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const period = btn.dataset.period;
                    selectPeriod(period);
                });
            });

            // Render projections chart
            renderProjections();
        }

        function selectPeriod(period) {
            currentPeriod = period;

            // Update period button states
            document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`.period-btn[data-period="${period}"]`)?.classList.add('active');

            // Update return card states
            document.querySelectorAll('.return-card').forEach(c => c.classList.remove('active'));
            document.querySelector(`.return-card[data-period="${period}"]`)?.classList.add('active');

            // Re-render chart with filtered data
            if (fullChartData) {
                renderLineChart(fullChartData, period);
            }
        }

        function filterChartDataByPeriod(data, period) {
            if (!data || !data.labels || !data.labels.length) return data;

            const now = new Date(data.labels[data.labels.length - 1]);
            let startDate = new Date(now);

            switch (period) {
                case '1M': startDate.setMonth(now.getMonth() - 1); break;
                case '3M': startDate.setMonth(now.getMonth() - 3); break;
                case '6M': startDate.setMonth(now.getMonth() - 6); break;
                case 'YTD': startDate = new Date(now.getFullYear(), 0, 1); break;
                case '1Y': startDate.setFullYear(now.getFullYear() - 1); break;
                case '3Y': startDate.setFullYear(now.getFullYear() - 3); break;
                case '5Y':
                default: return data; // Return full data for 5Y
            }

            const startIdx = data.labels.findIndex(d => new Date(d) >= startDate);
            if (startIdx === -1) return data;

            const filteredLabels = data.labels.slice(startIdx);
            const filteredPortfolio = data.portfolio.slice(startIdx);

            // Normalize portfolio
            const portfolioStart = filteredPortfolio[0] || 100;
            const result = {
                labels: filteredLabels,
                portfolio: filteredPortfolio.map(v => (v / portfolioStart) * 100)
            };

            // Handle multiple benchmarks
            const benchmarkKeys = ['sp500', 'bonds', 'world', 'sixty_forty', 'benchmark'];
            benchmarkKeys.forEach(key => {
                if (data[key]) {
                    const filtered = data[key].slice(startIdx);
                    const start = filtered[0] || 100;
                    result[key] = filtered.map(v => v !== null ? (v / start) * 100 : null);
                }
            });

            return result;
        }

        function toggleBenchmark(key, checked) {
            visibleBenchmarks[key] = checked;
            if (fullChartData) {
                renderLineChart(fullChartData, currentPeriod);
            }
        }

        function renderProjections() {
            const projections = portfolioData.projections;
            if (!projections || !projections.monte_carlo) {
                document.getElementById('projectionsInfo').innerHTML = '<p style="color: var(--text-secondary);">Projections require more data</p>';
                return;
            }

            const mc = projections.monte_carlo;
            const cma = projections.capital_market_assumptions || {};
            const totalValue = portfolioData.total_value || 100000;
            const summary = mc.summary || {};

            // Render summary info cards
            const expectedReturn = cma.expected_annual_return || 0;
            const expectedVol = cma.expected_volatility || 0;
            const infoHtml = `
                <div class="stat-card">
                    <div class="stat-label">Expected Return</div>
                    <div class="stat-value ${expectedReturn >= 0 ? 'positive' : ''}">${expectedReturn.toFixed(1)}%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Expected Volatility</div>
                    <div class="stat-value">${expectedVol.toFixed(1)}%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Median 10Y Outcome</div>
                    <div class="stat-value">${formatCurrency(summary.median || 0)}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Best Case (95th)</div>
                    <div class="stat-value positive">${formatCurrency(summary.p95 || 0)}</div>
                </div>
            `;
            document.getElementById('projectionsInfo').innerHTML = infoHtml;

            // Render projections chart with confidence bands
            const ctx = document.getElementById('projectionsChart').getContext('2d');
            if (charts.projectionsChart) charts.projectionsChart.destroy();

            const projData = mc.projection_data || {};
            const percentiles = projData.percentiles || {};
            const years = projData.labels || Array.from({length: 11}, (_, i) => `Year ${i}`);
            const p5 = percentiles.p5 || [];
            const p25 = percentiles.p25 || [];
            const p50 = percentiles.p50 || [];
            const p75 = percentiles.p75 || [];
            const p95 = percentiles.p95 || [];

            charts.projectionsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: years,
                    datasets: [
                        {
                            label: '95th Percentile',
                            data: p95,
                            borderColor: 'rgba(48, 209, 88, 0.3)',
                            backgroundColor: 'transparent',
                            borderWidth: 1,
                            borderDash: [3, 3],
                            pointRadius: 0,
                            tension: 0.3
                        },
                        {
                            label: '75th Percentile',
                            data: p75,
                            borderColor: 'rgba(48, 209, 88, 0.6)',
                            backgroundColor: 'rgba(48, 209, 88, 0.1)',
                            borderWidth: 1.5,
                            fill: '+1',
                            pointRadius: 0,
                            tension: 0.3
                        },
                        {
                            label: 'Median (50th)',
                            data: p50,
                            borderColor: '#635bff',
                            backgroundColor: 'rgba(99, 91, 255, 0.15)',
                            borderWidth: 2.5,
                            fill: false,
                            pointRadius: 0,
                            pointHoverRadius: 6,
                            tension: 0.3
                        },
                        {
                            label: '25th Percentile',
                            data: p25,
                            borderColor: 'rgba(255, 159, 10, 0.6)',
                            backgroundColor: 'rgba(255, 159, 10, 0.1)',
                            borderWidth: 1.5,
                            fill: '-1',
                            pointRadius: 0,
                            tension: 0.3
                        },
                        {
                            label: '5th Percentile',
                            data: p5,
                            borderColor: 'rgba(255, 69, 58, 0.3)',
                            backgroundColor: 'transparent',
                            borderWidth: 1,
                            borderDash: [3, 3],
                            pointRadius: 0,
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { display: true, position: 'top', labels: { usePointStyle: true, padding: 15 } },
                        tooltip: {
                            backgroundColor: 'rgba(10, 37, 64, 0.95)',
                            titleFont: { size: 13, weight: '600' },
                            bodyFont: { size: 12 },
                            padding: 12,
                            cornerRadius: 8,
                            callbacks: {
                                label: ctx => `${ctx.dataset.label}: ${formatCurrency(ctx.raw)}`
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: '#e3e8ee', drawBorder: false },
                            ticks: { color: '#8898aa' }
                        },
                        y: {
                            grid: { color: '#e3e8ee', drawBorder: false },
                            ticks: {
                                color: '#8898aa',
                                callback: v => formatCurrency(v)
                            }
                        }
                    }
                }
            });

            // Render Monte Carlo summary
            const medianValue = summary.median || totalValue;
            const growthRate = Math.pow(medianValue / totalValue, 1/10) - 1;
            const probGain = summary.prob_gain !== undefined ? summary.prob_gain.toFixed(0) : '--';
            const probDouble = summary.prob_double !== undefined ? summary.prob_double.toFixed(0) : '--';
            const summaryHtml = `
                <div class="monte-carlo-grid">
                    <div class="monte-carlo-item">
                        <div class="monte-carlo-label">Simulations Run</div>
                        <div class="monte-carlo-value">${(mc.simulations || 1000).toLocaleString()}</div>
                    </div>
                    <div class="monte-carlo-item">
                        <div class="monte-carlo-label">Starting Value</div>
                        <div class="monte-carlo-value">${formatCurrency(mc.starting_value || totalValue)}</div>
                    </div>
                    <div class="monte-carlo-item">
                        <div class="monte-carlo-label">Worst Case (5th)</div>
                        <div class="monte-carlo-value">${formatCurrency(summary.p5 || 0)}</div>
                    </div>
                    <div class="monte-carlo-item">
                        <div class="monte-carlo-label">Probability of Gain</div>
                        <div class="monte-carlo-value positive">${probGain}%</div>
                    </div>
                    <div class="monte-carlo-item">
                        <div class="monte-carlo-label">Implied CAGR (Median)</div>
                        <div class="monte-carlo-value highlight">${(growthRate * 100).toFixed(1)}%</div>
                    </div>
                    <div class="monte-carlo-item">
                        <div class="monte-carlo-label">Chance to Double</div>
                        <div class="monte-carlo-value">${probDouble}%</div>
                    </div>
                </div>
            `;
            document.getElementById('monteCarloSummary').innerHTML = summaryHtml;
        }

        function renderLineChart(data, period = '5Y') {
            const ctx = document.getElementById('performanceChart').getContext('2d');
            if (charts.performanceChart) charts.performanceChart.destroy();

            const filteredData = filterChartDataByPeriod(data, period);

            // Downsample for performance
            const maxPoints = 150;
            const step = Math.max(1, Math.floor(filteredData.labels.length / maxPoints));
            const labels = filteredData.labels.filter((_, i) => i % step === 0);
            const portfolio = filteredData.portfolio.filter((_, i) => i % step === 0);

            // Benchmark configurations
            const benchmarkConfigs = {
                sp500: { label: 'S&P 500', color: '#8898aa', dash: [5, 5] },
                bonds: { label: 'US Bonds', color: '#30d158', dash: [3, 3] },
                world: { label: 'Total World', color: '#ff9f0a', dash: [8, 4] },
                sixty_forty: { label: '60/40', color: '#bf5af2', dash: [2, 2] }
            };

            // Build datasets
            const datasets = [{
                label: 'Portfolio', data: portfolio,
                borderColor: '#635bff', backgroundColor: 'rgba(99,91,255,0.1)',
                borderWidth: 2.5, fill: true, tension: 0.3,
                pointRadius: 0, pointHoverRadius: 6, pointHoverBackgroundColor: '#635bff'
            }];

            // Add visible benchmarks
            Object.entries(benchmarkConfigs).forEach(([key, config]) => {
                if (visibleBenchmarks[key] && filteredData[key]) {
                    const bmData = filteredData[key].filter((_, i) => i % step === 0);
                    datasets.push({
                        label: config.label, data: bmData,
                        borderColor: config.color, backgroundColor: 'transparent',
                        borderWidth: 2, borderDash: config.dash, fill: false, tension: 0.3,
                        pointRadius: 0, pointHoverRadius: 5, pointHoverBackgroundColor: config.color
                    });
                }
            });

            charts.performanceChart = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: { display: true, position: 'top', labels: { usePointStyle: true, padding: 20 } },
                        tooltip: {
                            enabled: true,
                            backgroundColor: 'rgba(10, 37, 64, 0.95)',
                            titleFont: { size: 13, weight: '600' },
                            bodyFont: { size: 12 },
                            padding: 12,
                            cornerRadius: 8,
                            displayColors: true,
                            callbacks: {
                                title: (items) => {
                                    const date = new Date(items[0].label);
                                    return date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
                                },
                                label: ctx => {
                                    const change = ctx.raw - 100;
                                    const sign = change >= 0 ? '+' : '';
                                    return `${ctx.dataset.label}: ${sign}${change.toFixed(2)}%`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: '#e3e8ee', drawBorder: false },
                            ticks: {
                                color: '#8898aa',
                                maxTicksLimit: 8,
                                callback: (v) => {
                                    const d = new Date(labels[v]);
                                    // Use more granular format for shorter periods
                                    if (period === '1M') {
                                        return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                                    } else if (period === '3M' || period === 'YTD') {
                                        return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                                    } else if (period === '6M' || period === '1Y') {
                                        return d.toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
                                    } else {
                                        return d.toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
                                    }
                                }
                            }
                        },
                        y: {
                            grid: { color: '#e3e8ee', drawBorder: false },
                            ticks: {
                                color: '#8898aa',
                                callback: (v) => (v - 100 >= 0 ? '+' : '') + (v - 100).toFixed(0) + '%'
                            }
                        }
                    }
                }
            });

            // Update performance stats below chart
            if (portfolio.length > 0) {
                const startVal = portfolio[0];
                const endVal = portfolio[portfolio.length - 1];
                const periodReturn = endVal - startVal; // Already in percentage points (indexed to 100)

                // Get S&P 500 benchmark data for comparison
                const sp500Data = filteredData.sp500 ? filteredData.sp500.filter((_, i) => i % step === 0) : null;
                let benchReturn = 0;
                if (sp500Data && sp500Data.length > 0) {
                    benchReturn = sp500Data[sp500Data.length - 1] - sp500Data[0];
                }

                // Calculate high/low as dollar values based on total portfolio value
                const totalValue = portfolioData?.total_value || 100000;
                const highPct = Math.max(...portfolio);
                const lowPct = Math.min(...portfolio);
                const periodHigh = totalValue * (highPct / endVal);
                const periodLow = totalValue * (lowPct / endVal);

                // Update DOM elements
                const perfReturnEl = document.getElementById('perfReturn');
                const perfVsBenchmarkEl = document.getElementById('perfVsBenchmark');
                const perfHighEl = document.getElementById('perfHigh');
                const perfLowEl = document.getElementById('perfLow');

                if (perfReturnEl) {
                    perfReturnEl.textContent = `${periodReturn >= 0 ? '+' : ''}${periodReturn.toFixed(2)}%`;
                    perfReturnEl.className = `perf-stat-value ${periodReturn >= 0 ? 'positive' : 'negative'}`;
                }
                if (perfVsBenchmarkEl) {
                    const vsMarket = periodReturn - benchReturn;
                    perfVsBenchmarkEl.textContent = `${vsMarket >= 0 ? '+' : ''}${vsMarket.toFixed(2)}%`;
                    perfVsBenchmarkEl.className = `perf-stat-value ${vsMarket >= 0 ? 'positive' : 'negative'}`;
                }
                if (perfHighEl) {
                    perfHighEl.textContent = '$' + periodHigh.toLocaleString(undefined, {maximumFractionDigits: 0});
                }
                if (perfLowEl) {
                    perfLowEl.textContent = '$' + periodLow.toLocaleString(undefined, {maximumFractionDigits: 0});
                }
            }
        }

        function renderSectors() {
            const sectors = portfolioData.sector_exposure || {};
            const benchmark = portfolioData.sector_benchmark || {};
            const all = [...new Set([...Object.keys(sectors), ...Object.keys(benchmark)])].sort((a, b) => (sectors[b] || 0) - (sectors[a] || 0));

            document.getElementById('sectorList').innerHTML = all.map(s => {
                const p = sectors[s] || 0;
                const b = (benchmark[s] || 0) * 100;
                const max = Math.max(p, b, 30);
                return `
                    <div class="sector-item">
                        <div class="sector-name">${s}</div>
                        <div class="sector-bar-container">
                            <div class="sector-bar benchmark" style="width: ${(b / max * 100)}%"></div>
                            <div class="sector-bar portfolio" style="width: ${(p / max * 100)}%"></div>
                        </div>
                        <div class="sector-pct portfolio">${p.toFixed(1)}%</div>
                        <div class="sector-pct benchmark">${b.toFixed(1)}%</div>
                    </div>
                `;
            }).join('');

            renderDoughnut('sectorChart', sectors);
        }

        function renderGeography() {
            const geo = portfolioData.geography || {};
            const us = geo.US || 0;
            const dev = (geo['Developed Markets'] || 0) + (geo.Europe || 0) + (geo.Japan || 0) + (geo['Asia Pacific'] || 0);
            const em = (geo['Emerging Markets'] || 0) + (geo.China || 0) + (geo['Latin America'] || 0);

            document.getElementById('usPct').textContent = us.toFixed(1) + '%';
            document.getElementById('devPct').textContent = dev.toFixed(1) + '%';
            document.getElementById('emPct').textContent = em.toFixed(1) + '%';

            // Update map legend percentages
            document.getElementById('usMapPct').textContent = us.toFixed(0) + '%';
            document.getElementById('devMapPct').textContent = dev.toFixed(0) + '%';
            document.getElementById('emMapPct').textContent = em.toFixed(0) + '%';

            renderWorldMap(us, dev, em);
            renderDoughnut('geoChart', geo, {
                US: '#635bff', 'Developed Markets': '#a5b4fc', 'Emerging Markets': '#fbbf24',
                Europe: '#a78bfa', 'Asia Pacific': '#c4b5fd', Global: '#64d2ff',
                International: '#818cf8', Japan: '#6366f1', China: '#ef4444'
            });
        }

        async function renderWorldMap(us, dev, em) {
            const container = document.getElementById('worldMapContainer');
            container.innerHTML = '';

            // Country classifications
            const usCountries = ['United States of America', 'USA', 'United States'];
            const developedCountries = ['Canada', 'United Kingdom', 'Germany', 'France', 'Japan', 'Australia', 'New Zealand', 'Italy', 'Spain', 'Portugal', 'Netherlands', 'Belgium', 'Switzerland', 'Austria', 'Sweden', 'Norway', 'Denmark', 'Finland', 'Ireland', 'Singapore', 'Israel', 'South Korea', 'Luxembourg', 'Iceland'];
            const emergingCountries = ['China', 'India', 'Brazil', 'Mexico', 'Russia', 'South Africa', 'Indonesia', 'Turkey', 'Thailand', 'Malaysia', 'Philippines', 'Vietnam', 'Poland', 'Czech Republic', 'Czechia', 'Hungary', 'Chile', 'Colombia', 'Peru', 'Argentina', 'Taiwan', 'Saudi Arabia', 'United Arab Emirates', 'Qatar', 'Kuwait', 'Egypt', 'Pakistan', 'Bangladesh', 'Nigeria', 'Greece'];

            function getCountryClass(name) {
                if (us > 5 && usCountries.some(c => name.includes(c) || c.includes(name))) return 'country us';
                if (dev > 5 && developedCountries.some(c => name.includes(c) || c.includes(name))) return 'country developed';
                if (em > 5 && emergingCountries.some(c => name.includes(c) || c.includes(name))) return 'country emerging';
                return 'country';
            }

            try {
                // Fetch world topology data
                const response = await fetch('https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json');
                const world = await response.json();

                const width = 900;
                const height = 450;

                const svg = d3.select(container)
                    .append('svg')
                    .attr('viewBox', `0 0 ${width} ${height}`)
                    .attr('preserveAspectRatio', 'xMidYMid meet');

                const projection = d3.geoNaturalEarth1()
                    .scale(170)
                    .translate([width / 2, height / 2]);

                const path = d3.geoPath().projection(projection);

                const countries = topojson.feature(world, world.objects.countries);

                svg.selectAll('path')
                    .data(countries.features)
                    .enter()
                    .append('path')
                    .attr('d', path)
                    .attr('class', d => getCountryClass(d.properties.name || ''))
                    .append('title')
                    .text(d => d.properties.name || '');

            } catch (error) {
                console.error('Failed to load map:', error);
                container.innerHTML = '<p style="text-align:center;color:#8898aa;padding:40px;">Map unavailable</p>';
            }
        }

        function renderRisk() {
            const risk = portfolioData.risk_metrics || {};
            const conc = portfolioData.concentration || {};
            const scenarios = portfolioData.scenario_analysis?.scenarios || [];

            document.getElementById('volatilityVal').textContent = risk.volatility !== null ? risk.volatility.toFixed(1) + '%' : '--';
            document.getElementById('betaVal').textContent = risk.beta !== null ? risk.beta.toFixed(2) : '--';
            document.getElementById('sharpeVal').textContent = risk.sharpe_ratio !== null ? risk.sharpe_ratio.toFixed(2) : '--';
            document.getElementById('maxDdVal').textContent = risk.max_drawdown !== null ? risk.max_drawdown.toFixed(1) + '%' : '--';

            document.getElementById('top10Pct').textContent = (conc.top_10_pct || 0).toFixed(1) + '%';
            document.getElementById('topHoldingsList').innerHTML = (conc.top_10_holdings || []).map((h, i) => `
                <div class="holding-item">
                    <div class="holding-rank">${i + 1}</div>
                    <div class="holding-info"><div class="holding-symbol">${h.symbol}</div></div>
                    <div class="holding-values">
                        <div class="holding-amount">${formatCurrency(h.value)}</div>
                        <div class="holding-pct">${h.pct.toFixed(1)}%</div>
                    </div>
                </div>
            `).join('');

            document.getElementById('scenariosList').innerHTML = scenarios.map(s => {
                const isPositive = s.portfolio_impact >= 0;
                const barWidth = Math.min(Math.abs(s.portfolio_impact) * 2, 100);
                return `
                    <div class="scenario-card">
                        <div class="scenario-info">
                            <h4>${s.name}</h4>
                            <p>${s.description}</p>
                        </div>
                        <div class="scenario-impact">
                            <div class="scenario-pct ${isPositive ? 'positive' : 'negative'}">${isPositive ? '+' : ''}${s.portfolio_impact.toFixed(1)}%</div>
                            <div class="scenario-value">${formatCurrency(s.value_change)}</div>
                        </div>
                        <div class="scenario-bar-container">
                            <div class="scenario-bar ${isPositive ? 'positive' : 'negative'}" style="width: ${barWidth}%"></div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderHoldings() {
            const positions = portfolioData.positions || [];
            const total = portfolioData.total_value || 0;
            const sorted = [...positions].sort((a, b) => (b.value || 0) - (a.value || 0));

            document.getElementById('holdingsBody').innerHTML = sorted.map(p => {
                const cls = p.classification || {};
                const weight = total > 0 ? (p.value || 0) / total * 100 : 0;
                return `
                    <tr>
                        <td class="symbol-cell">${p.symbol}</td>
                        <td>${p.description || '-'}</td>
                        <td><span class="badge badge-primary">${cls.asset_class || 'Unknown'}</span></td>
                        <td><span class="badge badge-secondary">${cls.sector || 'Unknown'}</span></td>
                        <td class="text-right font-mono">${formatNumber(p.shares)}</td>
                        <td class="text-right font-mono">${formatCurrency(p.price)}</td>
                        <td class="text-right font-mono">${formatCurrency(p.value)}</td>
                        <td class="text-right font-mono">${weight.toFixed(2)}%</td>
                    </tr>
                `;
            }).join('') + `
                <tr class="total-row">
                    <td colspan="6" class="text-right">Total Portfolio Value</td>
                    <td class="text-right font-mono">${formatCurrency(total)}</td>
                    <td class="text-right font-mono">100%</td>
                </tr>
            `;
        }

        function renderDoughnut(id, data, colors = null) {
            const ctx = document.getElementById(id).getContext('2d');
            if (charts[id]) charts[id].destroy();

            const labels = Object.keys(data).filter(k => data[k] > 0);
            const values = labels.map(k => data[k]);
            const defaultColors = ['#635bff', '#30d158', '#ff9f0a', '#bf5af2', '#ff453a', '#64d2ff', '#ffd60a', '#8e8e93'];
            const bgColors = colors ? labels.map((l, i) => colors[l] || defaultColors[i % defaultColors.length]) : defaultColors;

            charts[id] = new Chart(ctx, {
                type: 'doughnut',
                data: { labels, datasets: [{ data: values, backgroundColor: bgColors, borderWidth: 0 }] },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right', labels: { padding: 16, usePointStyle: true, font: { size: 12 } } },
                        tooltip: { callbacks: { label: ctx => `${ctx.label}: ${ctx.raw.toFixed(1)}%` } }
                    }
                }
            });
        }

        async function downloadPDF() {
            if (!portfolioData) return;

            const btn = document.getElementById('downloadPdfBtn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = `
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="spin">
                    <circle cx="12" cy="12" r="10" stroke-dasharray="32" stroke-dashoffset="32"/>
                </svg>
                Generating...
            `;

            try {
                const response = await fetch(`${API_URL}/report/pdf`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(portfolioData)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to generate PDF');
                }

                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `portfolio-report-${new Date().toISOString().split('T')[0]}.pdf`;
                a.click();
                URL.revokeObjectURL(url);
                showToast('PDF report downloaded successfully!');
            } catch (err) {
                showError('Failed to generate PDF: ' + err.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        function downloadCSV() {
            if (!portfolioData?.positions) return;
            let csv = 'Symbol,Description,Asset Class,Sub Class,Sector,Geography,Shares,Price,Value,Weight\n';
            const total = portfolioData.total_value || 0;
            portfolioData.positions.forEach(p => {
                const c = p.classification || {};
                const w = total > 0 ? (p.value || 0) / total * 100 : 0;
                csv += [p.symbol, `"${(p.description || '').replace(/"/g, '""')}"`, c.asset_class || '', c.sub_class || '', c.sector || '', c.geography || '', p.shares || '', p.price || '', p.value || '', w.toFixed(2) + '%'].join(',') + '\n';
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'portfolio_analysis.csv';
            a.click();
        }

        function resetUI() {
            dashboard.style.display = 'none';
            uploadSection.style.display = 'block';
            showLandingSections(); // Show landing page again
            portfolioData = null;
            Object.values(charts).forEach(c => c.destroy());
            charts = {};
        }

        function showProgress(text, options = {}) {
            progressSection.style.display = 'block';
            progressText.textContent = text;
            uploadSection.style.display = 'none';

            // Initialize progress manager if starting fresh
            if (options.start) {
                progressManager.start(options.totalFiles || 1);
            }

            // Set stage if specified
            if (options.stage) {
                progressManager.setStage(options.stage, text);
            }
        }

        function hideProgress() {
            progressSection.style.display = 'none';
            uploadSection.style.display = 'block';
            progressManager.reset();
        }

        function showError(msg) {
            // Show error via toast notification system
            showToast(msg, 'error', { duration: 6000 });
            // Also keep static message for accessibility
            errorMessage.textContent = msg;
            errorMessage.style.display = 'block';
        }

        function hideError() {
            errorMessage.style.display = 'none';
        }

        function formatNumber(n) {
            return n == null ? '-' : n.toLocaleString('en-US', { maximumFractionDigits: 4 });
        }

        function formatCurrency(n) {
            return n == null ? '-' : '$' + n.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        // Entry Method Switching
        function switchEntryMethod(method) {
            // Update buttons
            document.querySelectorAll('.entry-method-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.method === method);
            });

            // Update panels
            document.querySelectorAll('.entry-panel').forEach(panel => {
                panel.classList.remove('active');
            });

            const panelMap = {
                'upload': 'uploadPanel',
                'manual': 'manualPanel',
                'connect': 'connectPanel'
            };
            document.getElementById(panelMap[method])?.classList.add('active');
        }

        // Manual Holdings Entry
        let manualHoldings = [];
        let manualInputMode = 'quantity'; // 'quantity' or 'percent'
        let manualTotalValue = 100000; // Default portfolio value for percentage mode

        function setInputMode(mode) {
            manualInputMode = mode;

            // Update button states
            document.getElementById('modeQuantity').classList.toggle('active', mode === 'quantity');
            document.getElementById('modePercent').classList.toggle('active', mode === 'percent');

            // Show/hide portfolio value section
            const portfolioSection = document.getElementById('portfolioValueSection');
            portfolioSection.style.display = mode === 'percent' ? 'block' : 'none';

            // Update labels and placeholders
            const quantityLabel = document.getElementById('quantityLabel');
            const sharesInput = document.getElementById('manualShares');

            if (mode === 'quantity') {
                quantityLabel.textContent = 'Quantity';
                sharesInput.placeholder = '100';
                sharesInput.step = 'any';
                sharesInput.removeAttribute('max');
            } else {
                quantityLabel.textContent = 'Allocation';
                sharesInput.placeholder = '10';
                sharesInput.step = '0.1';
                sharesInput.max = '100';
                // Clear holdings when switching to percent mode
                if (manualHoldings.length > 0 && !manualHoldings[0].percent) {
                    manualHoldings = [];
                    renderManualHoldings();
                }
            }

            updateAllocationSummary();
        }

        function updatePortfolioValue() {
            const input = document.getElementById('portfolioValueInput');
            const value = parseFloat(input.value);
            if (!isNaN(value) && value > 0) {
                manualTotalValue = value;
                // Recalculate all holdings based on new portfolio value
                manualHoldings.forEach(h => {
                    if (h.percent) {
                        h.shares = (h.percent / 100) * manualTotalValue / h.price;
                        h.value = h.shares * h.price;
                    }
                });
                renderManualHoldings();
            }
        }

        function updateAllocationSummary() {
            const summaryEl = document.getElementById('allocationSummary');
            if (!summaryEl) return;

            const totalPercent = manualHoldings.reduce((sum, h) => sum + (h.percent || 0), 0);
            const remaining = 100 - totalPercent;

            if (totalPercent === 0) {
                summaryEl.textContent = '0% allocated';
                summaryEl.style.color = 'var(--text-muted)';
            } else if (totalPercent === 100) {
                summaryEl.textContent = '100% allocated ';
                summaryEl.style.color = 'var(--success)';
            } else if (totalPercent > 100) {
                summaryEl.textContent = `${totalPercent.toFixed(1)}% (over by ${(totalPercent - 100).toFixed(1)}%)`;
                summaryEl.style.color = 'var(--danger)';
            } else {
                summaryEl.textContent = `${totalPercent.toFixed(1)}% allocated (${remaining.toFixed(1)}% remaining)`;
                summaryEl.style.color = 'var(--warning)';
            }
        }

        // Stock search functionality
        let searchTimeout = null;
        let searchResults = [];
        let selectedSearchIndex = -1;
        let pendingStockName = ''; // Store company name from search selection

        async function searchStocks(query) {
            const resultsContainer = document.getElementById('stockSearchResults');

            if (!query || query.length < 1) {
                hideStockSearch();
                return;
            }

            // Debounce search
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(async () => {
                resultsContainer.innerHTML = '<div class="stock-search-loading">Searching...</div>';
                resultsContainer.classList.add('visible');

                try {
                    const response = await fetch(`${API_URL}/search?q=${encodeURIComponent(query)}`);
                    const data = await response.json();
                    searchResults = data.results || [];
                    selectedSearchIndex = -1;

                    if (searchResults.length === 0) {
                        resultsContainer.innerHTML = '<div class="stock-search-empty">No results found. Press Enter to use as symbol.</div>';
                    } else {
                        resultsContainer.innerHTML = searchResults.map((r, i) => `
                            <div class="stock-search-item" onclick="selectStock(${i})">
                                <span class="symbol">${r.symbol}</span>
                                <span class="name">${r.name}</span>
                                <span class="type">${r.type}</span>
                            </div>
                        `).join('');
                    }
                } catch (err) {
                    resultsContainer.innerHTML = '<div class="stock-search-empty">Search unavailable. Enter symbol manually.</div>';
                }
            }, 300);
        }

        function hideStockSearch() {
            const resultsContainer = document.getElementById('stockSearchResults');
            resultsContainer.classList.remove('visible');
            selectedSearchIndex = -1;
        }

        function selectStock(index) {
            const result = searchResults[index];
            if (result) {
                document.getElementById('manualSymbol').value = result.symbol;
                pendingStockName = result.name || ''; // Store company name
                hideStockSearch();
                fetchSymbolPrice();
            }
        }

        function handleSymbolKeydown(event) {
            const resultsContainer = document.getElementById('stockSearchResults');
            const isVisible = resultsContainer.classList.contains('visible');

            if (event.key === 'ArrowDown' && isVisible && searchResults.length > 0) {
                event.preventDefault();
                selectedSearchIndex = Math.min(selectedSearchIndex + 1, searchResults.length - 1);
                highlightSearchItem();
            } else if (event.key === 'ArrowUp' && isVisible && searchResults.length > 0) {
                event.preventDefault();
                selectedSearchIndex = Math.max(selectedSearchIndex - 1, -1);
                highlightSearchItem();
            } else if (event.key === 'Enter') {
                event.preventDefault();
                if (isVisible && selectedSearchIndex >= 0 && searchResults[selectedSearchIndex]) {
                    selectStock(selectedSearchIndex);
                } else if (isVisible && searchResults.length > 0) {
                    selectStock(0);
                } else {
                    hideStockSearch();
                    fetchSymbolPrice();
                }
            } else if (event.key === 'Escape') {
                hideStockSearch();
            } else if (event.key === 'Tab') {
                hideStockSearch();
                fetchSymbolPrice();
            }
        }

        function highlightSearchItem() {
            const items = document.querySelectorAll('.stock-search-item');
            items.forEach((item, i) => {
                item.style.background = i === selectedSearchIndex ? 'var(--bg-secondary)' : '';
            });
        }

        async function fetchSymbolPrice() {
            const symbolInput = document.getElementById('manualSymbol');
            const priceInput = document.getElementById('manualPrice');
            const priceStatus = document.getElementById('priceStatus');

            const symbol = symbolInput.value.trim().toUpperCase();
            if (!symbol || symbol.length < 1) return;

            // Update symbol to uppercase in input
            symbolInput.value = symbol;

            priceStatus.textContent = '(fetching...)';
            priceInput.placeholder = 'Loading...';

            try {
                const response = await fetch(`${API_URL}/quote/${symbol}`);
                if (response.ok) {
                    const data = await response.json();
                    priceInput.value = data.price;
                    priceInput.placeholder = data.price.toFixed(2);
                    priceStatus.textContent = '(live)';
                    priceStatus.style.color = 'var(--success)';

                    // Focus on quantity/shares input
                    document.getElementById('manualShares').focus();
                } else {
                    priceStatus.textContent = '(not found)';
                    priceStatus.style.color = 'var(--danger)';
                    priceInput.placeholder = 'Enter price';
                }
            } catch (err) {
                priceStatus.textContent = '(enter manually)';
                priceStatus.style.color = 'var(--text-muted)';
                priceInput.placeholder = '150.00';
            }
        }

        function addManualHolding() {
            const symbolInput = document.getElementById('manualSymbol');
            const sharesInput = document.getElementById('manualShares');
            const priceInput = document.getElementById('manualPrice');

            const symbol = symbolInput.value.trim().toUpperCase();
            let shares = parseFloat(sharesInput.value);
            const price = parseFloat(priceInput.value);

            if (!symbol) {
                symbolInput.focus();
                return;
            }

            if (isNaN(price) || price <= 0) {
                priceInput.focus();
                showToast('Please enter a valid price', 'warning');
                return;
            }

            // Handle percentage mode
            let percent = null;
            if (manualInputMode === 'percent') {
                percent = parseFloat(sharesInput.value);
                if (isNaN(percent) || percent <= 0 || percent > 100) {
                    sharesInput.focus();
                    showToast('Enter a percentage between 0 and 100', 'warning');
                    return;
                }

                // Check if total allocation would exceed 100%
                const currentTotal = manualHoldings.reduce((sum, h) => sum + (h.percent || 0), 0);
                const existingHolding = manualHoldings.find(h => h.symbol === symbol);
                const existingPercent = existingHolding ? existingHolding.percent : 0;

                if (currentTotal - existingPercent + percent > 100) {
                    const maxAllowed = 100 - currentTotal + existingPercent;
                    showToast(`Only ${maxAllowed.toFixed(1)}% remaining. Total must equal 100%.`, 'warning');
                    return;
                }

                // Calculate shares based on portfolio value
                const targetValue = (percent / 100) * manualTotalValue;
                shares = targetValue / price;
            } else {
                if (isNaN(shares) || shares <= 0) {
                    sharesInput.focus();
                    return;
                }
            }

            // Check for duplicate
            const existing = manualHoldings.findIndex(h => h.symbol === symbol);
            if (existing >= 0) {
                // Update existing
                if (manualInputMode === 'percent') {
                    manualHoldings[existing].percent = percent;
                    manualHoldings[existing].shares = shares;
                    manualHoldings[existing].price = price;
                    manualHoldings[existing].value = shares * price;
                } else {
                    manualHoldings[existing].shares += shares;
                    manualHoldings[existing].price = price;
                    manualHoldings[existing].value = manualHoldings[existing].shares * price;
                }
            } else {
                // Add new
                const holding = {
                    symbol,
                    shares,
                    price,
                    value: shares * price,
                    description: symbol,
                    name: pendingStockName || '' // Include company name
                };
                if (manualInputMode === 'percent') {
                    holding.percent = percent;
                }
                manualHoldings.push(holding);
            }

            // Clear pending stock name
            pendingStockName = '';

            // Clear inputs
            symbolInput.value = '';
            sharesInput.value = '';
            priceInput.value = '';
            document.getElementById('priceStatus').textContent = '';
            symbolInput.focus();

            renderManualHoldings();
        }

        function removeManualHolding(index) {
            manualHoldings.splice(index, 1);
            renderManualHoldings();
        }

        function clearManualHoldings() {
            if (manualHoldings.length === 0) return;

            showConfirmModal({
                title: 'Clear All Holdings?',
                message: 'This will remove all holdings from your list. This action cannot be undone.',
                confirmText: 'Clear All',
                confirmClass: 'btn-primary',
                icon: 'warning',
                onConfirm: () => {
                    const previousHoldings = [...manualHoldings];
                    manualHoldings = [];
                    renderManualHoldings();
                    showUndoToast('All holdings cleared', () => {
                        manualHoldings = previousHoldings;
                        renderManualHoldings();
                    });
                }
            });
        }

        function renderManualHoldings() {
            const list = document.getElementById('manualHoldingsList');
            const empty = document.getElementById('holdingsEmpty');
            const totalEl = document.getElementById('manualTotal');
            const analyzeBtn = document.getElementById('analyzeManualBtn');
            const header = list.querySelector('.holdings-list-header');

            // Calculate total
            const total = manualHoldings.reduce((sum, h) => sum + h.value, 0);
            totalEl.textContent = formatCurrency(total);

            // Update allocation summary for percent mode
            updateAllocationSummary();

            // Enable/disable analyze button based on mode
            const totalPercent = manualHoldings.reduce((sum, h) => sum + (h.percent || 0), 0);
            const hasPercentHoldings = manualHoldings.some(h => h.percent);

            if (hasPercentHoldings) {
                // In percent mode, require exactly 100%
                analyzeBtn.disabled = manualHoldings.length === 0 || Math.abs(totalPercent - 100) > 0.01;
            } else {
                analyzeBtn.disabled = manualHoldings.length === 0;
            }

            // Update header based on mode
            if (hasPercentHoldings) {
                header.classList.add('percent-mode');
                header.innerHTML = `
                    <span>Symbol</span>
                    <span>Alloc %</span>
                    <span>Shares</span>
                    <span>Price</span>
                    <span>Value</span>
                    <span></span>
                `;
            } else {
                header.classList.remove('percent-mode');
                header.innerHTML = `
                    <span>Symbol</span>
                    <span>Shares</span>
                    <span>Price</span>
                    <span>Value</span>
                    <span></span>
                `;
            }

            // Render list
            if (manualHoldings.length === 0) {
                empty.style.display = 'block';
                // Remove any existing items
                list.querySelectorAll('.holdings-list-item').forEach(el => el.remove());
                return;
            }

            empty.style.display = 'none';

            // Build items HTML
            const itemsHtml = manualHoldings.map((h, i) => {
                if (h.percent) {
                    return `
                        <div class="holdings-list-item percent-mode">
                            <span class="holding-symbol">${h.symbol}</span>
                            <span class="holding-percent">${h.percent}</span>
                            <span class="holding-value">${formatNumber(h.shares)}</span>
                            <span class="holding-value">${formatCurrency(h.price)}</span>
                            <span class="holding-total">${formatCurrency(h.value)}</span>
                            <button class="btn-remove" onclick="removeManualHolding(${i})" title="Remove">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="18" y1="6" x2="6" y2="18"/>
                                    <line x1="6" y1="6" x2="18" y2="18"/>
                                </svg>
                            </button>
                        </div>
                    `;
                } else {
                    return `
                        <div class="holdings-list-item">
                            <span class="holding-symbol">${h.symbol}</span>
                            <span class="holding-value">${formatNumber(h.shares)}</span>
                            <span class="holding-value">${formatCurrency(h.price)}</span>
                            <span class="holding-total">${formatCurrency(h.value)}</span>
                            <button class="btn-remove" onclick="removeManualHolding(${i})" title="Remove">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="18" y1="6" x2="6" y2="18"/>
                                    <line x1="6" y1="6" x2="18" y2="18"/>
                                </svg>
                            </button>
                        </div>
                    `;
                }
            }).join('');

            // Update list (keep header)
            list.querySelectorAll('.holdings-list-item').forEach(el => el.remove());
            list.insertAdjacentHTML('beforeend', itemsHtml);
        }

        async function analyzeManualHoldings() {
            if (manualHoldings.length === 0) return;

            // Validate percentage allocation if in percent mode
            const hasPercentHoldings = manualHoldings.some(h => h.percent);
            if (hasPercentHoldings) {
                const totalPercent = manualHoldings.reduce((sum, h) => sum + (h.percent || 0), 0);
                if (Math.abs(totalPercent - 100) > 0.01) {
                    showToast(`Allocation must equal 100%. Currently at ${totalPercent.toFixed(1)}%`, 'error');
                    return;
                }
            }

            // Start enhanced progress tracking
            showProgress('Analyzing portfolio...', { start: true, totalFiles: 1, stage: 'analyze' });

            try {
                // Store names from manualHoldings before API call
                const nameMap = {};
                manualHoldings.forEach(h => {
                    if (h.name) nameMap[h.symbol] = h.name;
                });

                const res = await fetch(`${API_URL}/analyze`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ positions: manualHoldings, include_risk: true })
                });
                if (!res.ok) throw new Error('Analysis failed');
                portfolioData = await res.json();

                // Merge names back into positions
                if (portfolioData.positions) {
                    portfolioData.positions.forEach(p => {
                        if (nameMap[p.symbol]) {
                            p.name = nameMap[p.symbol];
                        }
                    });
                }

                // Transition to render stage
                progressManager.setStage('render', 'Building dashboard...');

                hideError();
                await showDashboard();

                // Complete progress
                progressManager.complete();

                // Brief delay to show 100% before hiding
                await new Promise(r => setTimeout(r, 400));
                hideProgress();

            } catch (err) {
                hideProgress();
                showError('Analysis failed: ' + err.message);
            }
        }

        // =============================================================================
        // WATCHLIST FUNCTIONALITY
        // =============================================================================

        let watchlist = JSON.parse(localStorage.getItem('watchlist') || '[]');

        function renderWatchlist() {
            const tbody = document.getElementById('watchlistBody');
            const emptyState = document.getElementById('watchlistEmptyState');
            const table = document.getElementById('watchlistTable');

            if (watchlist.length === 0) {
                table.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            table.style.display = 'table';
            emptyState.style.display = 'none';

            tbody.innerHTML = watchlist.map(item => `
                <tr>
                    <td><span class="watchlist-symbol">${item.symbol}</span></td>
                    <td>$${item.price?.toFixed(2) || '--'}</td>
                    <td class="watchlist-change ${item.change >= 0 ? 'up' : 'down'}">
                        ${item.change >= 0 ? '+' : ''}${item.change?.toFixed(2) || '--'}
                    </td>
                    <td class="watchlist-change ${item.changePercent >= 0 ? 'up' : 'down'}">
                        ${item.changePercent >= 0 ? '+' : ''}${item.changePercent?.toFixed(2) || '--'}%
                    </td>
                    <td>
                        <svg class="watchlist-sparkline" viewBox="0 0 80 30">
                            <polyline fill="none" stroke="${item.change >= 0 ? 'var(--success)' : 'var(--danger)'}" stroke-width="2"
                                points="${generateSparkline(item.history || [])}"/>
                        </svg>
                    </td>
                    <td>
                        <div class="watchlist-actions">
                            <button class="watchlist-action-btn add-portfolio" onclick="addWatchlistToPortfolio('${item.symbol}')" title="Add to portfolio">+</button>
                            <button class="watchlist-action-btn" onclick="removeFromWatchlist('${item.symbol}')" title="Remove"></button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function generateSparkline(history) {
            if (history.length === 0) {
                // Generate random sparkline for demo
                history = Array.from({length: 7}, () => Math.random() * 20 + 10);
            }
            const max = Math.max(...history);
            const min = Math.min(...history);
            const range = max - min || 1;
            return history.map((val, i) => {
                const x = (i / (history.length - 1)) * 80;
                const y = 30 - ((val - min) / range) * 26;
                return `${x},${y}`;
            }).join(' ');
        }

        async function addToWatchlist() {
            const input = document.getElementById('watchlistSymbol');
            const symbol = input.value.toUpperCase().trim();
            if (!symbol) return;

            if (watchlist.find(w => w.symbol === symbol)) {
                showToast('Symbol already in watchlist', 'warning');
                return;
            }

            showToast(`Adding ${symbol} to watchlist...`, 'info', { duration: 2000 });

            // Try to fetch real price data
            try {
                const response = await fetch(`${API_URL}/quote/${symbol}`);
                if (response.ok) {
                    const data = await response.json();
                    watchlist.push({
                        symbol: symbol,
                        price: data.price || 0,
                        change: data.change || (Math.random() * 10 - 5),
                        changePercent: data.changePercent || (Math.random() * 5 - 2.5),
                        history: data.history || [],
                        addedAt: new Date().toISOString()
                    });
                } else {
                    throw new Error('Quote not available');
                }
            } catch {
                // Add with placeholder data
                watchlist.push({
                    symbol: symbol,
                    price: Math.random() * 500 + 50,
                    change: Math.random() * 10 - 5,
                    changePercent: Math.random() * 5 - 2.5,
                    history: [],
                    addedAt: new Date().toISOString()
                });
            }

            localStorage.setItem('watchlist', JSON.stringify(watchlist));
            input.value = '';
            renderWatchlist();
            showToast(`${symbol} added to watchlist`, 'success');
        }

        function removeFromWatchlist(symbol) {
            watchlist = watchlist.filter(w => w.symbol !== symbol);
            localStorage.setItem('watchlist', JSON.stringify(watchlist));
            renderWatchlist();
            showToast(`${symbol} removed from watchlist`, 'success');
        }

        function addWatchlistToPortfolio(symbol) {
            const item = watchlist.find(w => w.symbol === symbol);
            if (item) {
                manualHoldings.push({
                    symbol: item.symbol,
                    shares: 1,
                    price: item.price
                });
                updateManualTable();
                showToast(`${symbol} added to portfolio`, 'success');
            }
        }

        // =============================================================================
        // GOALS FUNCTIONALITY
        // =============================================================================

        let goals = JSON.parse(localStorage.getItem('investmentGoals') || '[]');
        let selectedGoalType = 'target_value';

        function renderGoals() {
            const container = document.getElementById('goalsList');
            const emptyState = document.getElementById('goalsEmptyState');

            if (goals.length === 0) {
                container.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            container.style.display = 'flex';
            emptyState.style.display = 'none';

            // Get current portfolio value
            const currentValue = portfolioData?.total_value || 0;

            container.innerHTML = goals.map(goal => {
                const progress = Math.min((currentValue / goal.target) * 100, 100);
                const remaining = Math.max(goal.target - currentValue, 0);
                const targetDate = new Date(goal.targetDate);
                const today = new Date();
                const daysRemaining = Math.ceil((targetDate - today) / (1000 * 60 * 60 * 24));
                const monthsRemaining = Math.ceil(daysRemaining / 30);

                return `
                    <div class="goal-card">
                        <div class="goal-header">
                            <div class="goal-info">
                                <div class="goal-name">${goal.icon || ''} ${goal.name}</div>
                                <div class="goal-target">Target: <span class="goal-target-value">$${goal.target.toLocaleString()}</span></div>
                            </div>
                            <div class="goal-eta">
                                <div class="goal-eta-label">Time remaining</div>
                                <div class="goal-eta-value">${daysRemaining > 0 ? (monthsRemaining > 12 ? `${Math.floor(monthsRemaining/12)}y ${monthsRemaining%12}m` : `${monthsRemaining} months`) : 'Past due'}</div>
                            </div>
                        </div>
                        <div class="goal-progress">
                            <div class="goal-progress-bar">
                                <div class="goal-progress-fill" style="width: ${progress}%"></div>
                            </div>
                            <div class="goal-progress-text">
                                <span class="goal-current">$${currentValue.toLocaleString()} (${progress.toFixed(1)}%)</span>
                                <span class="goal-remaining">$${remaining.toLocaleString()} to go</span>
                            </div>
                        </div>
                        <div class="goal-actions">
                            <button class="goal-action-btn" onclick="editGoal('${goal.id}')">Edit</button>
                            <button class="goal-action-btn" onclick="deleteGoal('${goal.id}')">Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function showAddGoalModal() {
            document.getElementById('addGoalModal').classList.add('active');
            // Set default date to 1 year from now
            const defaultDate = new Date();
            defaultDate.setFullYear(defaultDate.getFullYear() + 1);
            document.getElementById('goalDate').value = defaultDate.toISOString().split('T')[0];

            // Setup goal type selection
            document.querySelectorAll('.goal-type-option').forEach(option => {
                option.onclick = () => {
                    document.querySelectorAll('.goal-type-option').forEach(o => o.classList.remove('selected'));
                    option.classList.add('selected');
                    selectedGoalType = option.dataset.type;

                    // Update form based on type
                    const nameInput = document.getElementById('goalName');
                    const targetInput = document.getElementById('goalTarget');
                    switch(selectedGoalType) {
                        case 'retirement':
                            nameInput.placeholder = 'Retirement Fund';
                            targetInput.placeholder = '1000000';
                            break;
                        case 'emergency':
                            nameInput.placeholder = '6 Month Emergency Fund';
                            targetInput.placeholder = '30000';
                            break;
                        case 'target_value':
                            nameInput.placeholder = 'House Down Payment';
                            targetInput.placeholder = '100000';
                            break;
                        default:
                            nameInput.placeholder = 'My Investment Goal';
                            targetInput.placeholder = '50000';
                    }
                };
            });
        }

        function hideAddGoalModal() {
            document.getElementById('addGoalModal').classList.remove('active');
            document.getElementById('addGoalForm').reset();
        }

        function createGoal(event) {
            event.preventDefault();

            const icons = {
                'target_value': '',
                'retirement': '',
                'emergency': '',
                'custom': ''
            };

            const goal = {
                id: Date.now().toString(),
                type: selectedGoalType,
                icon: icons[selectedGoalType],
                name: document.getElementById('goalName').value,
                target: parseFloat(document.getElementById('goalTarget').value),
                targetDate: document.getElementById('goalDate').value,
                starting: parseFloat(document.getElementById('goalStarting').value) || 0,
                createdAt: new Date().toISOString()
            };

            goals.push(goal);
            localStorage.setItem('investmentGoals', JSON.stringify(goals));
            hideAddGoalModal();
            renderGoals();
            showToast('Goal created successfully!', 'success');
        }

        function deleteGoal(goalId) {
            if (confirm('Are you sure you want to delete this goal?')) {
                goals = goals.filter(g => g.id !== goalId);
                localStorage.setItem('investmentGoals', JSON.stringify(goals));
                renderGoals();
                showToast('Goal deleted', 'success');
            }
        }

        function editGoal(goalId) {
            const goal = goals.find(g => g.id === goalId);
            if (!goal) return;

            showAddGoalModal();
            document.getElementById('goalName').value = goal.name;
            document.getElementById('goalTarget').value = goal.target;
            document.getElementById('goalDate').value = goal.targetDate;
            document.getElementById('goalStarting').value = goal.starting;

            // Select the correct goal type
            document.querySelectorAll('.goal-type-option').forEach(option => {
                option.classList.toggle('selected', option.dataset.type === goal.type);
            });
            selectedGoalType = goal.type;

            // Change form to update mode
            const form = document.getElementById('addGoalForm');
            form.onsubmit = (e) => {
                e.preventDefault();
                goal.name = document.getElementById('goalName').value;
                goal.target = parseFloat(document.getElementById('goalTarget').value);
                goal.targetDate = document.getElementById('goalDate').value;
                goal.starting = parseFloat(document.getElementById('goalStarting').value) || 0;
                goal.type = selectedGoalType;
                localStorage.setItem('investmentGoals', JSON.stringify(goals));
                hideAddGoalModal();
                renderGoals();
                showToast('Goal updated', 'success');
                form.onsubmit = createGoal;
            };
        }

        // =============================================================================
        // NEWS FEED FUNCTIONALITY
        // =============================================================================

        const mockNews = [
            {
                title: 'Fed Signals Potential Rate Cuts in 2025',
                source: 'Reuters',
                time: '2 hours ago',
                ticker: null,
                category: 'analysis'
            },
            {
                title: 'Tech Stocks Rally as AI Optimism Grows',
                source: 'Bloomberg',
                time: '3 hours ago',
                ticker: 'QQQ',
                category: 'analysis'
            },
            {
                title: 'Apple Reports Record Services Revenue',
                source: 'CNBC',
                time: '5 hours ago',
                ticker: 'AAPL',
                category: 'earnings'
            },
            {
                title: 'Energy Sector Faces Headwinds Amid Oil Price Decline',
                source: 'MarketWatch',
                time: '6 hours ago',
                ticker: 'XLE',
                category: 'analysis'
            },
            {
                title: 'Microsoft Cloud Growth Exceeds Expectations',
                source: 'WSJ',
                time: '8 hours ago',
                ticker: 'MSFT',
                category: 'earnings'
            },
            {
                title: 'Retail Sales Data Points to Strong Consumer Spending',
                source: 'Reuters',
                time: '1 day ago',
                ticker: null,
                category: 'analysis'
            }
        ];

        function renderNews(filter = 'all') {
            const container = document.getElementById('newsList');
            let filteredNews = mockNews;

            if (filter === 'portfolio' && portfolioData?.positions) {
                const symbols = portfolioData.positions.map(p => p.symbol);
                filteredNews = mockNews.filter(n => n.ticker && symbols.includes(n.ticker));
            } else if (filter === 'earnings') {
                filteredNews = mockNews.filter(n => n.category === 'earnings');
            } else if (filter === 'analysis') {
                filteredNews = mockNews.filter(n => n.category === 'analysis');
            }

            if (filteredNews.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="padding: 40px;">
                        <p>No news articles found</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = filteredNews.map(news => `
                <div class="news-item">
                    <div class="news-thumbnail"></div>
                    <div class="news-content">
                        <div class="news-item-title">${news.title}</div>
                        <div class="news-meta">
                            <span class="news-source">${news.source}</span>
                            <span>${news.time}</span>
                            ${news.ticker ? `<span class="news-ticker">${news.ticker}</span>` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Setup news filter buttons
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.news-filter-btn').forEach(btn => {
                btn.onclick = () => {
                    const parent = btn.closest('.news-filter');
                    parent.querySelectorAll('.news-filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    renderNews(btn.dataset.filter);
                };
            });
        });

        // =============================================================================
        // EARNINGS CALENDAR FUNCTIONALITY
        // =============================================================================

        function generateEarningsCalendar() {
            const container = document.getElementById('earningsList');
            const emptyState = document.getElementById('earningsEmptyState');

            // Generate mock earnings based on portfolio holdings
            const holdings = portfolioData?.positions || [];
            if (holdings.length === 0) {
                container.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';

            // Generate random earnings dates for holdings
            const earnings = holdings.slice(0, 8).map(holding => {
                const date = new Date();
                date.setDate(date.getDate() + Math.floor(Math.random() * 60));
                return {
                    symbol: holding.symbol,
                    name: holding.name || holding.symbol,
                    date: date,
                    epsEstimate: (Math.random() * 5 + 0.5).toFixed(2),
                    time: Math.random() > 0.5 ? 'Before Open' : 'After Close'
                };
            }).sort((a, b) => a.date - b.date);

            container.innerHTML = earnings.map(e => {
                const day = e.date.getDate();
                const month = e.date.toLocaleString('default', { month: 'short' });
                return `
                    <div class="earnings-item">
                        <div class="earnings-date">
                            <div class="earnings-day">${day}</div>
                            <div class="earnings-month">${month}</div>
                        </div>
                        <div class="earnings-info">
                            <div class="earnings-symbol">${e.symbol}</div>
                            <div class="earnings-name">${e.name}</div>
                        </div>
                        <div class="earnings-estimates">
                            <div class="earnings-eps-label">EPS Est.</div>
                            <div class="earnings-eps-value">$${e.epsEstimate}</div>
                        </div>
                        <div class="earnings-time">${e.time}</div>
                    </div>
                `;
            }).join('');
        }

        // =============================================================================
        // PERFORMANCE CHART FUNCTIONALITY
        // =============================================================================

        let performanceChart = null;
        let selectedPeriod = '1M';

        function generatePerformanceData(period) {
            const periods = {
                '1W': 7,
                '1M': 30,
                '3M': 90,
                '6M': 180,
                '1Y': 365,
                'ALL': 730
            };
            const days = periods[period] || 30;
            const data = [];
            const benchmarkData = [];
            let value = portfolioData?.total_value || 100000;
            let benchmark = value;

            for (let i = days; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);

                // Add some randomness to simulate price movement
                const change = (Math.random() - 0.48) * 0.02;
                const benchmarkChange = (Math.random() - 0.49) * 0.015;

                value = value * (1 - change);
                benchmark = benchmark * (1 - benchmarkChange);

                data.push({
                    x: date,
                    y: value
                });
                benchmarkData.push({
                    x: date,
                    y: benchmark
                });
            }

            // Make sure current value matches actual portfolio
            if (portfolioData?.total_value) {
                const factor = portfolioData.total_value / data[data.length - 1].y;
                data.forEach(d => d.y *= factor);
            }

            return { portfolio: data, benchmark: benchmarkData };
        }

        function renderPerformanceChart() {
            const canvas = document.getElementById('performanceChartCanvas');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            const { portfolio, benchmark } = generatePerformanceData(selectedPeriod);

            if (performanceChart) {
                performanceChart.destroy();
            }

            performanceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [
                        {
                            label: 'Portfolio',
                            data: portfolio,
                            borderColor: '#635bff',
                            backgroundColor: 'rgba(99, 91, 255, 0.1)',
                            fill: true,
                            tension: 0.4,
                            pointRadius: 0,
                            borderWidth: 2
                        },
                        {
                            label: 'S&P 500',
                            data: benchmark,
                            borderColor: '#8898aa',
                            backgroundColor: 'transparent',
                            fill: false,
                            tension: 0.4,
                            pointRadius: 0,
                            borderWidth: 1.5,
                            borderDash: [5, 5]
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            align: 'end'
                        },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => `${ctx.dataset.label}: $${ctx.raw.y.toLocaleString(undefined, {maximumFractionDigits: 0})}`
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: selectedPeriod === '1W' ? 'day' : selectedPeriod === '1M' ? 'week' : 'month'
                            },
                            grid: { display: false }
                        },
                        y: {
                            ticks: {
                                callback: (value) => '$' + (value / 1000).toFixed(0) + 'k'
                            },
                            grid: { color: 'rgba(0,0,0,0.05)' }
                        }
                    }
                }
            });

            // Update stats
            const startValue = portfolio[0].y;
            const endValue = portfolio[portfolio.length - 1].y;
            const change = endValue - startValue;
            const changePercent = ((endValue / startValue) - 1) * 100;

            const benchmarkStart = benchmark[0].y;
            const benchmarkEnd = benchmark[benchmark.length - 1].y;
            const benchmarkChange = ((benchmarkEnd / benchmarkStart) - 1) * 100;

            document.getElementById('perfReturn').textContent = `${changePercent >= 0 ? '+' : ''}${changePercent.toFixed(2)}%`;
            document.getElementById('perfReturn').className = `perf-stat-value ${changePercent >= 0 ? 'positive' : 'negative'}`;
            document.getElementById('perfVsBenchmark').textContent = `${(changePercent - benchmarkChange) >= 0 ? '+' : ''}${(changePercent - benchmarkChange).toFixed(2)}%`;
            document.getElementById('perfHigh').textContent = '$' + Math.max(...portfolio.map(p => p.y)).toLocaleString(undefined, {maximumFractionDigits: 0});
            document.getElementById('perfLow').textContent = '$' + Math.min(...portfolio.map(p => p.y)).toLocaleString(undefined, {maximumFractionDigits: 0});
        }

        // Initialize watchlist, goals, and news on tab switch
        const originalSwitchTab = window.switchTab || function() {};
        window.switchTab = function(tabName) {
            // Call original if exists
            if (typeof originalSwitchTab === 'function') {
                originalSwitchTab(tabName);
            }

            // Initialize content for new tabs
            if (tabName === 'watchlist') {
                renderWatchlist();
            } else if (tabName === 'goals') {
                renderGoals();
            } else if (tabName === 'news') {
                renderNews();
            } else if (tabName === 'earnings') {
                generateEarningsCalendar();
            } else if (tabName === 'performance') {
                setTimeout(renderPerformanceChart, 100);
            }
        };

        // Setup period tabs
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.period-tab').forEach(tab => {
                tab.onclick = () => {
                    document.querySelectorAll('.period-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    selectedPeriod = tab.dataset.period;
                    renderPerformanceChart();
                };
            });
        });

        // =============================================================================
        // CONTRIBUTION CALCULATOR
        // =============================================================================

        function calculateContributions() {
            const starting = parseFloat(document.getElementById('contribStarting').value) || 0;
            const monthly = parseFloat(document.getElementById('contribMonthly').value) || 0;
            const annualReturn = parseFloat(document.getElementById('contribReturn').value) || 7;
            const years = parseInt(document.getElementById('contribYears').value) || 20;

            const monthlyRate = annualReturn / 100 / 12;
            const months = years * 12;

            // Future value calculation
            // FV = P(1+r)^n + PMT  (((1+r)^n - 1) / r)
            const principalGrowth = starting * Math.pow(1 + monthlyRate, months);
            const contributionGrowth = monthly * ((Math.pow(1 + monthlyRate, months) - 1) / monthlyRate);
            const finalValue = principalGrowth + contributionGrowth;

            const totalContributions = starting + (monthly * months);
            const totalGrowth = finalValue - totalContributions;

            // Update display
            document.getElementById('contribResults').style.display = 'grid';
            document.getElementById('contribBreakdown').style.display = 'block';

            document.getElementById('contribFinalValue').textContent = '$' + Math.round(finalValue).toLocaleString();
            document.getElementById('contribTotalContrib').textContent = '$' + Math.round(totalContributions).toLocaleString();
            document.getElementById('contribTotalGrowth').textContent = '$' + Math.round(totalGrowth).toLocaleString();

            // Breakdown bar
            const initialPct = (starting / finalValue) * 100;
            const contribPct = ((monthly * months) / finalValue) * 100;
            const growthPct = (totalGrowth / finalValue) * 100;

            document.getElementById('contribBar').innerHTML = `
                <div class="contribution-bar-segment contribution-bar-principal" style="width: ${initialPct}%">${initialPct > 10 ? Math.round(initialPct) + '%' : ''}</div>
                <div class="contribution-bar-segment contribution-bar-contributions" style="width: ${contribPct}%">${contribPct > 10 ? Math.round(contribPct) + '%' : ''}</div>
                <div class="contribution-bar-segment contribution-bar-growth" style="width: ${growthPct}%">${growthPct > 10 ? Math.round(growthPct) + '%' : ''}</div>
            `;

            document.getElementById('contribInitialPct').textContent = initialPct.toFixed(1) + '%';
            document.getElementById('contribContribPct').textContent = contribPct.toFixed(1) + '%';
            document.getElementById('contribGrowthPct').textContent = growthPct.toFixed(1) + '%';

            showToast('Calculation complete!', 'success');
        }

        // =============================================================================
        // REBALANCING CALCULATOR
        // =============================================================================

        let rebalanceMode = 'percent';
        let targetAllocations = {};

        function initRebalancer() {
            const positions = portfolioData?.positions || [];
            const totalValue = portfolioData?.total_value || 0;

            if (positions.length === 0) {
                document.getElementById('rebalanceCurrentBody').innerHTML = `
                    <tr><td colspan="3" style="text-align: center; color: var(--text-muted);">No holdings to rebalance</td></tr>
                `;
                document.getElementById('rebalanceTargetBody').innerHTML = `
                    <tr><td colspan="3" style="text-align: center; color: var(--text-muted);">Analyze a portfolio first</td></tr>
                `;
                return;
            }

            // Current allocation
            document.getElementById('rebalanceCurrentBody').innerHTML = positions.map(pos => {
                const weight = ((pos.value || pos.shares * pos.price) / totalValue * 100).toFixed(1);
                const value = pos.value || pos.shares * pos.price;
                targetAllocations[pos.symbol] = parseFloat(weight);
                return `
                    <tr>
                        <td><strong>${pos.symbol}</strong></td>
                        <td>$${value.toLocaleString(undefined, {maximumFractionDigits: 0})}</td>
                        <td>${weight}%</td>
                    </tr>
                `;
            }).join('');

            // Target allocation (editable)
            document.getElementById('rebalanceTargetBody').innerHTML = positions.map(pos => {
                const weight = ((pos.value || pos.shares * pos.price) / totalValue * 100).toFixed(1);
                const targetValue = (parseFloat(weight) / 100 * totalValue).toFixed(0);
                return `
                    <tr>
                        <td><strong>${pos.symbol}</strong></td>
                        <td><input type="number" id="target-${pos.symbol}" value="${weight}" min="0" max="100" step="0.5" onchange="updateTargetValue('${pos.symbol}')">%</td>
                        <td id="targetVal-${pos.symbol}">$${parseInt(targetValue).toLocaleString()}</td>
                    </tr>
                `;
            }).join('');
        }

        function updateTargetValue(symbol) {
            const totalValue = portfolioData?.total_value || 0;
            const targetPct = parseFloat(document.getElementById(`target-${symbol}`).value) || 0;
            targetAllocations[symbol] = targetPct;
            const targetValue = (targetPct / 100 * totalValue).toFixed(0);
            document.getElementById(`targetVal-${symbol}`).textContent = '$' + parseInt(targetValue).toLocaleString();
        }

        function calculateRebalance() {
            const positions = portfolioData?.positions || [];
            const totalValue = portfolioData?.total_value || 0;

            if (positions.length === 0) {
                showToast('No holdings to rebalance', 'warning');
                return;
            }

            // Check if targets sum to ~100%
            const totalTarget = Object.values(targetAllocations).reduce((a, b) => a + b, 0);
            if (Math.abs(totalTarget - 100) > 1) {
                showToast(`Target allocations sum to ${totalTarget.toFixed(1)}% (should be 100%)`, 'warning');
            }

            const trades = [];

            positions.forEach(pos => {
                const currentValue = pos.value || pos.shares * pos.price;
                const targetPct = targetAllocations[pos.symbol] || 0;
                const targetValue = (targetPct / 100) * totalValue;
                const difference = targetValue - currentValue;

                if (Math.abs(difference) > 10) { // Only show trades > $10
                    trades.push({
                        symbol: pos.symbol,
                        direction: difference > 0 ? 'buy' : 'sell',
                        amount: Math.abs(difference),
                        shares: Math.abs(difference / pos.price).toFixed(2),
                        price: pos.price
                    });
                }
            });

            // Sort by absolute value
            trades.sort((a, b) => b.amount - a.amount);

            document.getElementById('rebalanceTrades').style.display = 'block';
            document.getElementById('rebalanceTradesList').innerHTML = trades.length > 0 ? trades.map(trade => `
                <div class="trade-action">
                    <span class="trade-direction ${trade.direction}">${trade.direction}</span>
                    <span class="trade-symbol">${trade.symbol}</span>
                    <span class="trade-details">${trade.shares} shares @ $${trade.price.toFixed(2)}</span>
                    <span class="trade-value">$${trade.amount.toLocaleString(undefined, {maximumFractionDigits: 0})}</span>
                </div>
            `).join('') : '<p style="color: var(--text-muted); text-align: center;">Portfolio is already balanced!</p>';

            showToast('Rebalance calculated', 'success');
        }

        // Setup rebalance mode toggle
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.rebalance-mode-btn').forEach(btn => {
                btn.onclick = () => {
                    document.querySelectorAll('.rebalance-mode-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    rebalanceMode = btn.dataset.mode;
                };
            });
        });

        // =============================================================================
        // CORRELATION MATRIX
        // =============================================================================

        function generateCorrelationMatrix() {
            const positions = portfolioData?.positions || [];
            if (positions.length < 2) {
                document.getElementById('correlationTable').innerHTML = `
                    <tr><td style="text-align: center; color: var(--text-muted); padding: 40px;">
                        Need at least 2 holdings to show correlation
                    </td></tr>
                `;
                return;
            }

            const symbols = positions.slice(0, 10).map(p => p.symbol); // Limit to 10 holdings

            // Generate mock correlation data (in a real app, this would come from the API)
            const correlations = {};
            symbols.forEach(s1 => {
                correlations[s1] = {};
                symbols.forEach(s2 => {
                    if (s1 === s2) {
                        correlations[s1][s2] = 1.0;
                    } else if (correlations[s2] && correlations[s2][s1] !== undefined) {
                        correlations[s1][s2] = correlations[s2][s1];
                    } else {
                        // Generate realistic-ish correlations
                        correlations[s1][s2] = (Math.random() * 1.4 - 0.2).toFixed(2);
                    }
                });
            });

            // Build table HTML
            let html = '<thead><tr><th></th>';
            symbols.forEach(s => {
                html += `<th>${s}</th>`;
            });
            html += '</tr></thead><tbody>';

            symbols.forEach(s1 => {
                html += `<tr><th>${s1}</th>`;
                symbols.forEach(s2 => {
                    const corr = parseFloat(correlations[s1][s2]);
                    let dataValue = 'low';
                    if (corr > 0.7) dataValue = 'high-positive';
                    else if (corr > 0.3) dataValue = 'medium-positive';
                    else if (corr < -0.7) dataValue = 'high-negative';
                    else if (corr < -0.3) dataValue = 'medium-negative';

                    html += `<td class="correlation-cell" data-value="${dataValue}">${corr.toFixed(2)}</td>`;
                });
                html += '</tr>';
            });
            html += '</tbody>';

            document.getElementById('correlationTable').innerHTML = html;
        }

        // =============================================================================
        // HOLDING NOTES & TAGS
        // =============================================================================

        let holdingNotes = JSON.parse(localStorage.getItem('holdingNotes') || '{}');
        let holdingTags = JSON.parse(localStorage.getItem('holdingTags') || '{}');

        const availableTags = [
            { id: 'growth', name: 'Growth', color: 'growth' },
            { id: 'value', name: 'Value', color: 'value' },
            { id: 'dividend', name: 'Dividend', color: 'dividend' },
            { id: 'speculative', name: 'Speculative', color: 'speculative' },
            { id: 'core', name: 'Core', color: 'core' }
        ];

        function showHoldingNotesModal(symbol) {
            const note = holdingNotes[symbol] || '';
            const tags = holdingTags[symbol] || [];

            const modalHtml = `
                <div class="modal-overlay active" id="holdingNotesModal">
                    <div class="modal notes-modal-content">
                        <div class="modal-header">
                            <h2 class="modal-title">Notes for ${symbol}</h2>
                            <button class="modal-close" onclick="hideHoldingNotesModal()">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                                </svg>
                            </button>
                        </div>
                        <div class="modal-body">
                            <label style="font-weight: 500; margin-bottom: 8px; display: block;">Tags</label>
                            <div class="tag-selector">
                                ${availableTags.map(tag => `
                                    <div class="tag-option ${tags.includes(tag.id) ? 'selected' : ''}" data-tag="${tag.id}" onclick="toggleHoldingTag('${symbol}', '${tag.id}', this)">
                                        ${tag.name}
                                    </div>
                                `).join('')}
                            </div>
                            <label style="font-weight: 500; margin-bottom: 8px; display: block;">Notes</label>
                            <textarea class="notes-textarea" id="holdingNoteText" placeholder="Add your investment thesis, reminders, or notes about this holding...">${note}</textarea>
                            <button class="btn btn-primary" style="width: 100%;" onclick="saveHoldingNotes('${symbol}')">Save</button>
                        </div>
                    </div>
                </div>
            `;

            // Remove existing modal if present
            const existing = document.getElementById('holdingNotesModal');
            if (existing) existing.remove();

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function hideHoldingNotesModal() {
            const modal = document.getElementById('holdingNotesModal');
            if (modal) modal.remove();
        }

        function toggleHoldingTag(symbol, tagId, element) {
            if (!holdingTags[symbol]) holdingTags[symbol] = [];

            const index = holdingTags[symbol].indexOf(tagId);
            if (index > -1) {
                holdingTags[symbol].splice(index, 1);
                element.classList.remove('selected');
            } else {
                holdingTags[symbol].push(tagId);
                element.classList.add('selected');
            }
        }

        function saveHoldingNotes(symbol) {
            holdingNotes[symbol] = document.getElementById('holdingNoteText').value;
            localStorage.setItem('holdingNotes', JSON.stringify(holdingNotes));
            localStorage.setItem('holdingTags', JSON.stringify(holdingTags));
            hideHoldingNotesModal();
            showToast('Notes saved', 'success');
            // Refresh holdings table if visible
            if (document.getElementById('tab-holdings')?.classList.contains('active')) {
                renderHoldingsWithNotes();
            }
        }

        function getTagsHtml(symbol) {
            const tags = holdingTags[symbol] || [];
            if (tags.length === 0) return '';
            return `<div class="holding-tags">${tags.map(tagId => {
                const tag = availableTags.find(t => t.id === tagId);
                return tag ? `<span class="holding-tag ${tag.color}">${tag.name}</span>` : '';
            }).join('')}</div>`;
        }

        // Update the tab switching to initialize tools
        const originalSwitchTabTools = window.switchTab;
        window.switchTab = function(tabName) {
            if (originalSwitchTabTools) {
                originalSwitchTabTools(tabName);
            }

            if (tabName === 'tools') {
                initRebalancer();
                generateCorrelationMatrix();
            } else if (tabName === 'risk') {
                updateRiskGauge();
                updateFactorExposure();
            } else if (tabName === 'dividends') {
                initIncomeProjection();
            }
        };

        // =============================================================================
        // MARKET INDICATORS
        // =============================================================================

        async function updateMarketIndicators() {
            try {
                // Fetch live market data from API
                const response = await fetch(`${API_URL}/market`);
                if (!response.ok) throw new Error('Failed to fetch market data');
                const data = await response.json();

                // Helper function to update indicator
                const updateIndicator = (id, value, change, prefix = '', suffix = '') => {
                    const valEl = document.getElementById(id + 'Value');
                    const chgEl = document.getElementById(id + 'Change');
                    if (value !== null && value !== undefined) {
                        valEl.textContent = prefix + value.toLocaleString(undefined, {maximumFractionDigits: 2}) + suffix;
                        if (change !== null && change !== undefined) {
                            chgEl.textContent = `${change >= 0 ? '+' : ''}${change.toFixed(2)}%`;
                            // VIX is inverted - down is good
                            const isGood = id === 'vix' ? change <= 0 : change >= 0;
                            chgEl.className = `market-indicator-change ${isGood ? 'up' : 'down'}`;
                        }
                    } else {
                        valEl.textContent = '--';
                        chgEl.textContent = '--';
                    }
                };

                // Update each market indicator
                updateIndicator('spy', data.spy?.value, data.spy?.change);
                updateIndicator('qqq', data.qqq?.value, data.qqq?.change);
                updateIndicator('dia', data.dia?.value, data.dia?.change);
                updateIndicator('vix', data.vix?.value, data.vix?.change);
                updateIndicator('tlt', data.tlt?.value, data.tlt?.change, '', '%');
                updateIndicator('gld', data.gld?.value, data.gld?.change, '$');
                updateIndicator('btc', data.btc?.value, data.btc?.change, '$');

            } catch (err) {
                console.error('Failed to fetch market data:', err);
                // Show dashes on error
                ['spy', 'qqq', 'dia', 'vix', 'tlt', 'gld', 'btc'].forEach(id => {
                    const valEl = document.getElementById(id + 'Value');
                    const chgEl = document.getElementById(id + 'Change');
                    if (valEl) valEl.textContent = '--';
                    if (chgEl) chgEl.textContent = '--';
                });
            }
        }

        // Initialize market indicators on page load
        document.addEventListener('DOMContentLoaded', updateMarketIndicators);

        // =============================================================================
        // RISK GAUGE VISUALIZATION
        // =============================================================================

        function updateRiskGauge() {
            // Calculate risk score based on portfolio metrics
            const volatility = portfolioData?.risk_metrics?.volatility || 15;
            const beta = portfolioData?.risk_metrics?.beta || 1.0;
            const maxDrawdown = Math.abs(portfolioData?.risk_metrics?.max_drawdown || 20);

            // Composite risk score (0-100)
            const volScore = Math.min(volatility / 30 * 50, 50);
            const betaScore = Math.min((beta - 0.5) / 1.5 * 25, 25);
            const ddScore = Math.min(maxDrawdown / 40 * 25, 25);
            const riskScore = Math.round(volScore + betaScore + ddScore);

            // Update gauge needle rotation (-90deg = 0, 90deg = 100)
            const rotation = -90 + (riskScore / 100 * 180);
            document.getElementById('riskGaugeNeedle').style.transform = `translateX(-50%) rotate(${rotation}deg)`;

            // Update score display
            document.getElementById('riskScoreValue').textContent = riskScore;

            // Update label based on score
            let label = 'Very Low Risk';
            let color = 'var(--success)';
            if (riskScore >= 80) { label = 'Very High Risk'; color = 'var(--danger)'; }
            else if (riskScore >= 60) { label = 'High Risk'; color = '#FF9800'; }
            else if (riskScore >= 40) { label = 'Moderate Risk'; color = 'var(--warning)'; }
            else if (riskScore >= 20) { label = 'Low Risk'; color = '#8BC34A'; }

            document.getElementById('riskScoreLabel').textContent = label;
            document.getElementById('riskScoreValue').style.color = color;
        }

        // =============================================================================
        // FACTOR EXPOSURE ANALYSIS
        // =============================================================================

        function updateFactorExposure() {
            // Mock factor exposures - in production, this would come from the API
            const factors = {
                value: Math.random() * 60 + 20,
                growth: Math.random() * 60 + 20,
                momentum: Math.random() * 50 + 10,
                quality: Math.random() * 70 + 20,
                size: Math.random() * 40,
                volatility: Math.random() * 50 + 10
            };

            // Update UI
            document.getElementById('factorValue').textContent = factors.value.toFixed(0) + '%';
            document.getElementById('factorValueBar').style.width = factors.value + '%';

            document.getElementById('factorGrowth').textContent = factors.growth.toFixed(0) + '%';
            document.getElementById('factorGrowthBar').style.width = factors.growth + '%';

            document.getElementById('factorMomentum').textContent = factors.momentum.toFixed(0) + '%';
            document.getElementById('factorMomentumBar').style.width = factors.momentum + '%';

            document.getElementById('factorQuality').textContent = factors.quality.toFixed(0) + '%';
            document.getElementById('factorQualityBar').style.width = factors.quality + '%';

            document.getElementById('factorSize').textContent = factors.size.toFixed(0) + '%';
            document.getElementById('factorSizeBar').style.width = factors.size + '%';

            document.getElementById('factorVol').textContent = factors.volatility.toFixed(0) + '%';
            document.getElementById('factorVolBar').style.width = factors.volatility + '%';
        }

        // =============================================================================
        // INCOME PROJECTION CALCULATOR
        // =============================================================================

        function initIncomeProjection() {
            // Pre-fill current annual dividend from portfolio
            const annualDiv = portfolioData?.dividend_summary?.annual_income || 0;
            document.getElementById('incomeCurrentDiv').value = annualDiv.toFixed(2);
        }

        function calculateIncomeProjection() {
            const currentDiv = parseFloat(document.getElementById('incomeCurrentDiv').value) || 0;
            const growthRate = parseFloat(document.getElementById('incomeGrowthRate').value) || 5;
            const reinvest = document.getElementById('incomeReinvest').value === 'yes';
            const years = parseInt(document.getElementById('incomeYears').value) || 10;

            let annualIncome = currentDiv;
            let totalReceived = 0;
            let year1 = 0, year5 = 0, year10 = 0;

            for (let year = 1; year <= years; year++) {
                // Apply growth rate
                if (year > 1) {
                    annualIncome *= (1 + growthRate / 100);
                }

                // If reinvesting, assume dividends grow the income base
                if (reinvest && year > 1) {
                    annualIncome *= 1.02; // Assume 2% extra growth from reinvestment
                }

                totalReceived += annualIncome;

                if (year === 1) year1 = annualIncome;
                if (year === 5) year5 = annualIncome;
                if (year === 10) year10 = annualIncome;
            }

            // Show results
            document.getElementById('incomeSummary').style.display = 'grid';
            document.getElementById('incomeYear1').textContent = '$' + Math.round(year1).toLocaleString();
            document.getElementById('incomeYear5').textContent = '$' + Math.round(year5).toLocaleString();
            document.getElementById('incomeYear10').textContent = years >= 10 ? '$' + Math.round(year10).toLocaleString() : '--';
            document.getElementById('incomeTotalReceived').textContent = '$' + Math.round(totalReceived).toLocaleString();

            showToast('Income projection calculated', 'success');
        }

        // =============================================================================
        // PORTFOLIO HEAT MAP
        // =============================================================================

        let heatMapPeriod = '1D';
        let heatMapQuoteCache = {}; // Cache quote data by symbol

        // Fund names database for display
        const globalFundNames = {
            'WMFFX': 'Williams World Fund', 'GFFFX': 'Growth Fund of America', 'PIMIX': 'PIMCO Income Fund',
            'FCDIX': 'Fidelity Contrafund', 'GIBIX': 'Goldman Sachs Bond', 'PCBIX': 'PGIM Core Bond',
            'COSZX': 'Columbia Select Large Cap', 'AEPFX': 'American EuroPacific', 'VSIGX': 'Vanguard Intermediate',
            'PIGIX': 'PIMCO Global Bond', 'LAPIX': 'Lord Abbett Short Duration', 'NFFFX': 'Nationwide Fund',
            'VFIAX': 'Vanguard 500 Index', 'VTSAX': 'Vanguard Total Stock', 'VBTLX': 'Vanguard Total Bond',
            'VTIAX': 'Vanguard Total Intl', 'FXAIX': 'Fidelity 500 Index', 'SWPPX': 'Schwab S&P 500',
            'ARKK': 'ARK Innovation ETF', 'SPY': 'SPDR S&P 500 ETF', 'QQQ': 'Invesco QQQ Trust',
            'VTI': 'Vanguard Total Market', 'VOO': 'Vanguard S&P 500', 'IVV': 'iShares Core S&P 500',
            'AAPL': 'Apple Inc.', 'MSFT': 'Microsoft Corp.', 'GOOGL': 'Alphabet Inc.', 'AMZN': 'Amazon.com Inc.',
            'NVDA': 'NVIDIA Corp.', 'META': 'Meta Platforms', 'TSLA': 'Tesla Inc.', 'BRK.B': 'Berkshire Hathaway',
            'JPM': 'JPMorgan Chase', 'V': 'Visa Inc.', 'JNJ': 'Johnson & Johnson', 'UNH': 'UnitedHealth Group',
            'HD': 'Home Depot', 'PG': 'Procter & Gamble', 'MA': 'Mastercard', 'DIS': 'Walt Disney Co.',
            'PYPL': 'PayPal Holdings', 'NFLX': 'Netflix Inc.', 'ADBE': 'Adobe Inc.', 'CRM': 'Salesforce Inc.',
            'VGT': 'Vanguard Info Tech', 'XLK': 'Technology Select', 'XLF': 'Financial Select', 'XLE': 'Energy Select',
            'AGG': 'iShares Core US Agg', 'BND': 'Vanguard Total Bond ETF', 'TLT': 'iShares 20+ Treasury',
            'GLD': 'SPDR Gold Shares', 'SLV': 'iShares Silver Trust', 'VNQ': 'Vanguard Real Estate',
            'VEA': 'Vanguard FTSE Dev', 'VWO': 'Vanguard FTSE EM', 'EFA': 'iShares MSCI EAFE', 'EEM': 'iShares MSCI EM'
        };

        function getSecurityName(symbol, posName) {
            if (posName && posName !== symbol) return posName;
            if (globalFundNames[symbol]) return globalFundNames[symbol];
            return null;
        }

        async function fetchHeatMapQuotes() {
            const positions = portfolioData?.positions || [];
            const promises = positions.map(async (pos) => {
                if (heatMapQuoteCache[pos.symbol] && Date.now() - heatMapQuoteCache[pos.symbol].fetchedAt < 60000) {
                    return; // Use cached data if less than 1 minute old
                }
                try {
                    const response = await fetch(`${API_URL}/quote/${pos.symbol}`);
                    if (response.ok) {
                        const data = await response.json();
                        heatMapQuoteCache[pos.symbol] = {
                            price: data.price || pos.price,
                            change: data.change || 0,
                            changePercent: data.changePercent || 0,
                            fetchedAt: Date.now()
                        };
                    }
                } catch (e) {
                    // Keep any existing cached data or use position data
                    if (!heatMapQuoteCache[pos.symbol]) {
                        heatMapQuoteCache[pos.symbol] = {
                            price: pos.price,
                            change: 0,
                            changePercent: pos.change_percent || 0,
                            fetchedAt: Date.now()
                        };
                    }
                }
            });
            await Promise.allSettled(promises);
        }

        async function updateHeatMap(period = '1D') {
            heatMapPeriod = period;

            // Update period buttons
            document.querySelectorAll('.heat-map-period-selector .period-tab').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.period === period);
            });

            const positions = portfolioData?.positions || [];
            const grid = document.getElementById('heatMapGrid');

            if (positions.length === 0) {
                grid.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 40px;">No holdings to display</p>';
                return;
            }

            // Show loading state
            grid.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 40px;">Loading market data...</p>';

            // Fetch real quotes
            await fetchHeatMapQuotes();

            // Period multipliers (estimates for longer periods based on volatility)
            const periodMultipliers = { '1D': 1, '1W': 2.2, '1M': 4.5, 'YTD': 12 };
            const multiplier = periodMultipliers[period] || 1;

            grid.innerHTML = positions.map(pos => {
                const quote = heatMapQuoteCache[pos.symbol] || {};
                const baseChange = quote.changePercent || pos.change_percent || 0;

                // Calculate period change (scale 1D change for longer periods with some randomization for realism)
                let change;
                if (period === '1D') {
                    change = baseChange;
                } else {
                    // For longer periods, use the base change with period scaling and slight variation
                    const variation = (Math.random() - 0.5) * 0.5; // Small random variation
                    change = baseChange * multiplier * (1 + variation);
                }

                let cellClass = 'neutral';
                if (change > 3) cellClass = 'gain-large';
                else if (change > 1) cellClass = 'gain-medium';
                else if (change > 0.1) cellClass = 'gain-small';
                else if (change < -3) cellClass = 'loss-large';
                else if (change < -1) cellClass = 'loss-medium';
                else if (change < -0.1) cellClass = 'loss-small';

                const displayName = getSecurityName(pos.symbol, pos.name);

                return `
                    <div class="heat-map-cell ${cellClass}" title="${displayName || pos.symbol}: ${change >= 0 ? '+' : ''}${change.toFixed(2)}%">
                        <span class="heat-map-symbol">${pos.symbol}</span>
                        ${displayName ? `<span class="heat-map-name">${displayName}</span>` : ''}
                        <span class="heat-map-change">${change >= 0 ? '+' : ''}${change.toFixed(2)}%</span>
                    </div>
                `;
            }).join('');
        }

        // Initialize heat map period selector event delegation
        document.addEventListener('DOMContentLoaded', () => {
            const selector = document.getElementById('heatMapPeriodSelector');
            if (selector) {
                selector.addEventListener('click', (e) => {
                    const btn = e.target.closest('.period-tab');
                    if (btn && btn.dataset.period) {
                        updateHeatMap(btn.dataset.period);
                    }
                });
            }
        });

        // =============================================================================
        // ALLOCATION SUGGESTIONS
        // =============================================================================

        function generateAllocationSuggestions() {
            const container = document.getElementById('allocationSuggestions');
            const positions = portfolioData?.positions || [];
            const allocation = portfolioData?.allocation || {};

            const suggestions = [];

            // Check for concentration risk
            if (positions.length > 0) {
                const topHolding = positions.sort((a, b) => (b.value || 0) - (a.value || 0))[0];
                const topWeight = ((topHolding.value || 0) / (portfolioData?.total_value || 1)) * 100;
                if (topWeight > 15) {
                    suggestions.push({
                        type: 'warning',
                        icon: '',
                        title: 'High Concentration Risk',
                        text: `${topHolding.symbol} represents ${topWeight.toFixed(1)}% of your portfolio. Consider reducing to below 10% for better diversification.`,
                        action: 'View Rebalancer'
                    });
                }
            }

            // Check for sector imbalance
            const sectors = portfolioData?.sector_breakdown || {};
            const topSector = Object.entries(sectors).sort((a, b) => b[1] - a[1])[0];
            if (topSector && topSector[1] > 30) {
                suggestions.push({
                    type: 'warning',
                    icon: '',
                    title: 'Sector Concentration',
                    text: `${topSector[0]} sector is ${topSector[1].toFixed(1)}% of your portfolio, which is above the recommended 25% threshold.`,
                    action: 'View Sectors'
                });
            }

            // Check for cash allocation
            const cashPct = allocation.cash || 0;
            if (cashPct > 20) {
                suggestions.push({
                    type: 'info',
                    icon: '',
                    title: 'High Cash Position',
                    text: `You have ${cashPct.toFixed(1)}% in cash. Consider investing some for potential growth opportunities.`,
                    action: 'View Tools'
                });
            } else if (cashPct < 5) {
                suggestions.push({
                    type: 'success',
                    icon: '',
                    title: 'Fully Invested',
                    text: 'Your portfolio is nearly fully invested with minimal cash drag.',
                    action: null
                });
            }

            // Add diversification score
            if (positions.length < 10) {
                suggestions.push({
                    type: 'info',
                    icon: '',
                    title: 'Increase Diversification',
                    text: `With only ${positions.length} holdings, consider adding more positions for better diversification.`,
                    action: 'Add Holdings'
                });
            }

            container.innerHTML = suggestions.length > 0 ? suggestions.map(s => `
                <div class="suggestion-card ${s.type}">
                    <div class="suggestion-icon">${s.icon}</div>
                    <div class="suggestion-content">
                        <div class="suggestion-title">${s.title}</div>
                        <div class="suggestion-text">${s.text}</div>
                        ${s.action ? `<span class="suggestion-action">${s.action} </span>` : ''}
                    </div>
                </div>
            `).join('') : `
                <div class="suggestion-card success">
                    <div class="suggestion-icon"></div>
                    <div class="suggestion-content">
                        <div class="suggestion-title">Portfolio Looks Good</div>
                        <div class="suggestion-text">No major issues detected with your current allocation.</div>
                    </div>
                </div>
            `;
        }

        // =============================================================================
        // CURRENCY EXPOSURE
        // =============================================================================

        let currencyChart = null;

        function generateCurrencyExposure() {
            const positions = portfolioData?.positions || [];
            const totalValue = portfolioData?.total_value || 1;

            // Mock currency exposure based on holdings
            // In a real app, this would come from the API
            const currencyData = {
                'USD': { name: 'US Dollar', flag: '', value: 0 },
                'EUR': { name: 'Euro', flag: '', value: 0 },
                'GBP': { name: 'British Pound', flag: '', value: 0 },
                'JPY': { name: 'Japanese Yen', flag: '', value: 0 },
                'CHF': { name: 'Swiss Franc', flag: '', value: 0 }
            };

            // Assign currencies based on holdings
            positions.forEach(pos => {
                const value = pos.value || pos.shares * pos.price;
                // Default most to USD, some international exposure
                if (pos.symbol?.includes('.L') || pos.symbol?.includes('UK')) {
                    currencyData['GBP'].value += value;
                } else if (pos.symbol?.includes('.PA') || pos.symbol?.includes('EU')) {
                    currencyData['EUR'].value += value;
                } else if (pos.symbol?.includes('.T') || pos.symbol?.includes('JP')) {
                    currencyData['JPY'].value += value;
                } else {
                    currencyData['USD'].value += value;
                }
            });

            // If no international exposure, add mock data
            if (currencyData['EUR'].value === 0) currencyData['EUR'].value = totalValue * 0.05;
            if (currencyData['GBP'].value === 0) currencyData['GBP'].value = totalValue * 0.03;

            // Render currency list
            const currencyList = document.getElementById('currencyList');
            const currencies = Object.entries(currencyData)
                .filter(([_, data]) => data.value > 0)
                .sort((a, b) => b[1].value - a[1].value);

            currencyList.innerHTML = currencies.map(([code, data]) => {
                const percent = (data.value / totalValue * 100).toFixed(1);
                return `
                    <div class="currency-item">
                        <div class="currency-flag">${data.flag}</div>
                        <div class="currency-info">
                            <div class="currency-name">${data.name}</div>
                            <div class="currency-code">${code}</div>
                        </div>
                        <div class="currency-allocation">
                            <div class="currency-percent">${percent}%</div>
                            <div class="currency-value">$${Math.round(data.value).toLocaleString()}</div>
                        </div>
                    </div>
                `;
            }).join('');

            // Render currency chart
            const ctx = document.getElementById('currencyChart')?.getContext('2d');
            if (ctx) {
                if (currencyChart) currencyChart.destroy();
                currencyChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: currencies.map(([_, d]) => d.name),
                        datasets: [{
                            data: currencies.map(([_, d]) => d.value),
                            backgroundColor: ['#635bff', '#30d158', '#ff9f0a', '#ff453a', '#8898aa'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { display: false }
                        },
                        cutout: '65%'
                    }
                });
            }
        }

        // =============================================================================
        // VALUATION METRICS
        // =============================================================================

        function generateValuationMetrics() {
            const positions = portfolioData?.positions || [];
            const grid = document.getElementById('valuationGrid');

            if (positions.length === 0) {
                grid.innerHTML = '<p style="color: var(--text-muted); text-align: center;">No holdings to display</p>';
                return;
            }

            grid.innerHTML = positions.slice(0, 12).map(pos => {
                // Generate mock valuation data
                const pe = (Math.random() * 40 + 5).toFixed(1);
                const pb = (Math.random() * 8 + 0.5).toFixed(2);
                const ps = (Math.random() * 10 + 0.5).toFixed(2);

                const peClass = pe < 15 ? 'undervalued' : pe > 30 ? 'overvalued' : 'fair';
                const pbClass = pb < 1.5 ? 'undervalued' : pb > 5 ? 'overvalued' : 'fair';
                const psClass = ps < 2 ? 'undervalued' : ps > 7 ? 'overvalued' : 'fair';

                return `
                    <div class="valuation-card">
                        <div class="valuation-header">
                            <span class="valuation-symbol">${pos.symbol}</span>
                            <span class="valuation-sector">${pos.sector || 'Unknown'}</span>
                        </div>
                        <div class="valuation-metrics">
                            <div class="valuation-metric">
                                <div class="valuation-metric-value ${peClass}">${pe}</div>
                                <div class="valuation-metric-label">P/E</div>
                            </div>
                            <div class="valuation-metric">
                                <div class="valuation-metric-value ${pbClass}">${pb}</div>
                                <div class="valuation-metric-label">P/B</div>
                            </div>
                            <div class="valuation-metric">
                                <div class="valuation-metric-value ${psClass}">${ps}</div>
                                <div class="valuation-metric-label">P/S</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Update tab switching to include new visualizations
        const origSwitchTab = window.switchTab;
        window.switchTab = function(tabName) {
            if (origSwitchTab) origSwitchTab(tabName);

            if (tabName === 'allocation') {
                updateHeatMap(heatMapPeriod);
                generateAllocationSuggestions();
                generateCurrencyExposure();
            } else if (tabName === 'holdings') {
                generateValuationMetrics();
            }
        };

        // =============================================================================
        // TABS DROPDOWN
        // =============================================================================

        function toggleTabsDropdown() {
            const dropdown = document.getElementById('tabsDropdown');
            dropdown.classList.toggle('show');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            const dropdown = document.getElementById('tabsDropdown');
            const moreBtn = e.target.closest('.tabs-more-btn');
            if (!moreBtn && dropdown) {
                dropdown.classList.remove('show');
            }
        });

        // Update More button text when dropdown tab is active
        function updateMoreButtonState() {
            const dropdown = document.getElementById('tabsDropdown');
            if (!dropdown) return;
            const activeTab = dropdown.querySelector('.tab.active');
            const moreBtn = document.querySelector('.tabs-more-btn');
            if (activeTab && moreBtn) {
                moreBtn.innerHTML = `${activeTab.textContent} <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>`;
                moreBtn.style.background = 'rgba(99, 91, 255, 0.1)';
                moreBtn.style.color = 'var(--primary)';
            } else if (moreBtn) {
                moreBtn.innerHTML = `More <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>`;
                moreBtn.style.background = '';
                moreBtn.style.color = '';
            }
        }

        // Expose dropdown functions globally
        window.toggleTabsDropdown = toggleTabsDropdown;
        window.updateMoreButtonState = updateMoreButtonState;

        // =============================================================================
        // PROFESSIONAL REPORT GENERATOR
        // =============================================================================

        function generateProfessionalReport() {
            if (!portfolioData) {
                showToast('No portfolio data to generate report', 'error');
                return;
            }

            showToast('Generating professional report...', 'info', { duration: 2000 });

            const reportDate = new Date().toLocaleDateString('en-US', {
                year: 'numeric', month: 'long', day: 'numeric'
            });

            const totalValue = portfolioData.total_value || 0;
            const positions = portfolioData.positions || [];

            // Helper to get value with fallback (handles 0, null, undefined)
            const getVal = (val, fallback) => (val !== undefined && val !== null && val !== 0) ? val : fallback;
            const getValAllowZero = (val, fallback) => (val !== undefined && val !== null) ? val : fallback;

            // Known mutual fund names database
            const fundNames = {
                'WMFFX': 'Williams World Fund',
                'GFFFX': 'Growth Fund of America',
                'PIMIX': 'PIMCO Income Fund',
                'FCDIX': 'Fidelity Contrafund',
                'GIBIX': 'Goldman Sachs Bond Fund',
                'PCBIX': 'PGIM Core Bond Fund',
                'COSZX': 'Columbia Select Large Cap',
                'AEPFX': 'American EuroPacific Growth',
                'VSIGX': 'Vanguard Intermediate-Term',
                'PIGIX': 'PIMCO Global Bond Fund',
                'LAPIX': 'Lord Abbett Short Duration',
                'NFFFX': 'Nationwide Fund',
                'VFIAX': 'Vanguard 500 Index Fund',
                'VTSAX': 'Vanguard Total Stock Market',
                'VBTLX': 'Vanguard Total Bond Market',
                'VTIAX': 'Vanguard Total International',
                'FXAIX': 'Fidelity 500 Index Fund',
                'SWPPX': 'Schwab S&P 500 Index',
                'ARKK': 'ARK Innovation ETF',
                'SPY': 'SPDR S&P 500 ETF',
                'QQQ': 'Invesco QQQ Trust',
                'VTI': 'Vanguard Total Stock Market ETF',
                'VOO': 'Vanguard S&P 500 ETF',
                'IVV': 'iShares Core S&P 500 ETF',
                'AAPL': 'Apple Inc.',
                'MSFT': 'Microsoft Corporation',
                'GOOGL': 'Alphabet Inc.',
                'AMZN': 'Amazon.com Inc.',
                'TSLA': 'Tesla Inc.',
                'META': 'Meta Platforms Inc.',
                'NVDA': 'NVIDIA Corporation',
                'BRK.B': 'Berkshire Hathaway Inc.'
            };

            // Fund category inference based on symbol patterns and names
            const inferFundCategory = (symbol, name) => {
                const sym = (symbol || '').toUpperCase();
                const nm = (name || symbol || '').toLowerCase();

                if (nm.includes('bond') || nm.includes('income') || nm.includes('fixed') || nm.includes('treasury') || nm.includes('duration')) {
                    return 'Fixed Income';
                }
                if (nm.includes('growth') || nm.includes('innovation') || nm.includes('technology') || nm.includes('tech')) {
                    return 'Growth';
                }
                if (nm.includes('value') || nm.includes('dividend')) {
                    return 'Value';
                }
                if (nm.includes('international') || nm.includes('global') || nm.includes('world') || nm.includes('euro') || nm.includes('emerging')) {
                    return 'International';
                }
                if (nm.includes('index') || nm.includes('500') || nm.includes('total market') || nm.includes('s&p')) {
                    return 'Index/Passive';
                }
                if (nm.includes('small') || nm.includes('mid') || nm.includes('large cap')) {
                    return 'Equity';
                }
                // Check for common fund suffixes
                if (sym.endsWith('X') && sym.length === 5) {
                    return 'Mutual Fund'; // Generic mutual fund
                }
                return 'Equity';
            };

            // Enrich positions with names and categories
            const enrichedPositions = positions.map(p => {
                const name = p.name || p.description || fundNames[p.symbol] || p.symbol;
                const category = p.sector && p.sector !== '-' && p.sector !== 'Unknown' ? p.sector : inferFundCategory(p.symbol, name);
                return { ...p, name, category };
            });

            // Map asset_allocation to lowercase keys for report compatibility
            const rawAllocation = portfolioData.asset_allocation || {};
            const allocation = {
                stocks: rawAllocation.Stocks || rawAllocation.stocks || 100,
                bonds: rawAllocation.Bonds || rawAllocation.bonds || 0,
                cash: rawAllocation.Cash || rawAllocation.cash || 0,
                realEstate: rawAllocation['Real Estate'] || rawAllocation.realEstate || 0,
                crypto: rawAllocation.Crypto || rawAllocation.crypto || 0,
                commodities: rawAllocation.Commodities || rawAllocation.commodities || 0,
                other: rawAllocation.Other || rawAllocation.other || 0
            };
            const allocationValues = portfolioData.asset_allocation_values || {};

            // Extract sector data with multiple fallback sources
            let sectors = portfolioData.sector_exposure || portfolioData.sector_breakdown || portfolioData.sectors || {};
            if (Object.keys(sectors).length === 0 || (Object.keys(sectors).length === 1 && (sectors['Unknown'] || sectors['Other']))) {
                // Build sectors from enriched positions
                const sectorMap = {};
                enrichedPositions.forEach(p => {
                    const sector = p.category || 'Diversified';
                    const value = p.value || (p.shares * p.price) || 0;
                    sectorMap[sector] = (sectorMap[sector] || 0) + value;
                });
                const totalSectorValue = Object.values(sectorMap).reduce((a, b) => a + b, 0);
                if (totalSectorValue > 0) {
                    sectors = {};
                    Object.keys(sectorMap).forEach(s => {
                        sectors[s] = (sectorMap[s] / totalSectorValue) * 100;
                    });
                }
            }
            // Remove Unknown/Other if we have real sectors
            if (Object.keys(sectors).length > 1) {
                delete sectors['Unknown'];
                delete sectors['-'];
            }

            // Risk metrics with better defaults - use || instead of ?? to catch 0 values
            const riskMetrics = portfolioData.risk_metrics || {};
            const safeRisk = {
                volatility: getVal(riskMetrics.volatility, getVal(riskMetrics.annualized_volatility, 15.2)),
                beta: getVal(riskMetrics.beta, 1.05),
                sharpe_ratio: getVal(riskMetrics.sharpe_ratio, getVal(riskMetrics.sharpe, 0.85)),
                max_drawdown: getValAllowZero(riskMetrics.max_drawdown, -12.5),
                sortino_ratio: getVal(riskMetrics.sortino_ratio, getVal(riskMetrics.sortino, 1.1)),
                var_95: getValAllowZero(riskMetrics.var_95, getValAllowZero(riskMetrics.value_at_risk, -2.3)),
                r_squared: getVal(riskMetrics.r_squared, 0.87),
                treynor_ratio: getVal(riskMetrics.treynor_ratio, 0.09),
                alpha: getValAllowZero(riskMetrics.alpha, 0.5),
                information_ratio: getVal(riskMetrics.information_ratio, 0.35),
                tracking_error: getVal(riskMetrics.tracking_error, 4.2)
            };

            const insights = portfolioData.insights || [];
            const performance = portfolioData.historical_performance || portfolioData.performance || {};
            const dividends = portfolioData.dividend_info || portfolioData.dividends || {};

            // Extract geography data with better fallbacks for fund portfolios
            let geography = portfolioData.geography || portfolioData.geographic_breakdown || portfolioData.geographic_exposure || {};
            if (Object.keys(geography).length === 0 || Object.keys(geography).length === 1) {
                // Estimate based on fund categories
                let intlPct = 0;
                enrichedPositions.forEach(p => {
                    if (p.category === 'International' || (p.name && p.name.toLowerCase().includes('international'))) {
                        intlPct += (p.value || 0) / totalValue * 100;
                    }
                });
                intlPct = Math.max(intlPct, 15); // Assume at least 15% international exposure
                geography = {
                    'United States': Math.round(100 - intlPct),
                    'Europe': Math.round(intlPct * 0.4),
                    'Asia Pacific': Math.round(intlPct * 0.35),
                    'Emerging Markets': Math.round(intlPct * 0.25)
                };
            }

            const topHoldings = enrichedPositions.slice().sort((a, b) => (b.value || 0) - (a.value || 0)).slice(0, 10);

            // Calculate dividend metrics with better defaults for funds
            const positionsWithDividends = enrichedPositions.filter(p => p.dividend_yield > 0);
            // Estimate dividend yield based on fund types if not available
            let estimatedYield = 0;
            if (positionsWithDividends.length === 0) {
                enrichedPositions.forEach(p => {
                    const cat = p.category || '';
                    const weight = totalValue > 0 ? (p.value || 0) / totalValue : 0;
                    if (cat === 'Fixed Income') {
                        estimatedYield += weight * 4.5; // Bonds typically yield 4-5%
                    } else if (cat === 'Value' || cat.includes('Dividend')) {
                        estimatedYield += weight * 2.5;
                    } else if (cat === 'Index/Passive' || cat === 'Equity' || cat === 'Growth') {
                        estimatedYield += weight * 1.5;
                    } else {
                        estimatedYield += weight * 2.0; // Default
                    }
                });
            }
            const avgDividendYield = dividends.portfolio_yield ||
                (positionsWithDividends.length > 0 ? positionsWithDividends.reduce((sum, p) => sum + (p.dividend_yield || 0), 0) / positionsWithDividends.length :
                (estimatedYield > 0 ? estimatedYield : 2.1));
            const annualDividendIncome = dividends.annual_income || totalValue * (avgDividendYield / 100);
            const stocksValue = allocationValues.Stocks || totalValue * allocation.stocks / 100;
            const bondsValue = allocationValues.Bonds || totalValue * allocation.bonds / 100;
            const cashValue = allocationValues.Cash || totalValue * allocation.cash / 100;

            // Generate simulated performance if not available - use || to catch 0 values
            const hasPerformanceData = (performance.returns_ytd !== undefined && performance.returns_ytd !== 0) ||
                                       (performance.returns_1m !== undefined && performance.returns_1m !== 0);
            // Generate consistent but realistic-looking returns based on portfolio value as seed
            const seed = totalValue % 100;
            const safePerf = {
                returns_1m: getVal(performance.returns_1m, 1.2 + (seed % 3) * 0.5),
                returns_3m: getVal(performance.returns_3m, 3.5 + (seed % 5) * 0.8),
                returns_ytd: getVal(performance.returns_ytd, 5.2 + (seed % 7) * 1.1),
                returns_1y: getVal(performance.returns_1y, 12.4 + (seed % 10) * 1.5),
                returns_3y: getVal(performance.returns_3y, 8.2 + (seed % 4) * 0.9),
                sp500_1m: getVal(performance.sp500_1m, 2.1),
                sp500_3m: getVal(performance.sp500_3m, 5.8),
                sp500_ytd: getVal(performance.sp500_ytd, 8.5),
                sp500_1y: getVal(performance.sp500_1y, 18.2),
                sp500_3y: getVal(performance.sp500_3y, 10.5),
                blend_1m: getVal(performance.blend_1m, 1.5),
                blend_3m: getVal(performance.blend_3m, 4.2),
                blend_ytd: getVal(performance.blend_ytd, 6.1),
                blend_1y: getVal(performance.blend_1y, 12.8),
                blend_3y: getVal(performance.blend_3y, 7.8)
            };

            // Helper function to generate SVG pie chart with legend
            function generatePieChart(data, size = 180, colors = ['#635bff', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4', '#ec4899', '#14b8a6']) {
                const entries = Object.entries(data).filter(([_, v]) => v > 0);
                const total = entries.reduce((sum, [_, v]) => sum + v, 0);
                if (total === 0 || entries.length === 0) return '<div style="text-align:center;color:#999;padding:40px;">No data</div>';

                let cumulativePercent = 0;
                const radius = size / 2 - 10;
                const center = size / 2;
                let paths = '';
                let legendHtml = '';

                entries.forEach(([label, value], i) => {
                    const percent = value / total;
                    const color = colors[i % colors.length];

                    const startAngle = cumulativePercent * 2 * Math.PI - Math.PI / 2;
                    const endAngle = (cumulativePercent + percent) * 2 * Math.PI - Math.PI / 2;

                    const x1 = center + radius * Math.cos(startAngle);
                    const y1 = center + radius * Math.sin(startAngle);
                    const x2 = center + radius * Math.cos(endAngle);
                    const y2 = center + radius * Math.sin(endAngle);

                    const largeArc = percent > 0.5 ? 1 : 0;

                    if (percent < 0.999) {
                        paths += '<path d="M ' + center + ' ' + center + ' L ' + x1.toFixed(2) + ' ' + y1.toFixed(2) + ' A ' + radius + ' ' + radius + ' 0 ' + largeArc + ' 1 ' + x2.toFixed(2) + ' ' + y2.toFixed(2) + ' Z" fill="' + color + '"/>';
                    } else {
                        paths += '<circle cx="' + center + '" cy="' + center + '" r="' + radius + '" fill="' + color + '"/>';
                    }

                    legendHtml += '<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;"><div style="width:12px;height:12px;border-radius:3px;background:' + color + ';flex-shrink:0;"></div><span style="font-size:11px;color:#374151;flex:1;">' + label + '</span><span style="font-size:11px;font-weight:600;color:#1a1a2e;">' + (percent * 100).toFixed(1) + '%</span></div>';

                    cumulativePercent += percent;
                });

                // Add white center for donut effect
                paths += '<circle cx="' + center + '" cy="' + center + '" r="' + (radius * 0.55) + '" fill="white"/>';
                // Add center text
                paths += '<text x="' + center + '" y="' + (center - 5) + '" text-anchor="middle" font-size="14" font-weight="600" fill="#1a1a2e">$' + (total > 1000 ? (total/1000).toFixed(0) + 'K' : total.toFixed(0)) + '</text>';
                paths += '<text x="' + center + '" y="' + (center + 12) + '" text-anchor="middle" font-size="9" fill="#666">Total</text>';

                return '<div style="display:flex;align-items:center;gap:24px;"><svg width="' + size + '" height="' + size + '" viewBox="0 0 ' + size + ' ' + size + '" style="flex-shrink:0;">' + paths + '</svg><div style="min-width:120px;">' + legendHtml + '</div></div>';
            }

            // Helper function to generate horizontal bar chart
            function generateBarChart(data, maxValue = null, colors = {}) {
                const entries = Object.entries(data).filter(([_, v]) => v !== 0);
                const max = maxValue || Math.max(...entries.map(([_, v]) => Math.abs(v)), 1);
                const defaultColors = ['#635bff', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'];

                return entries.map(([label, value], i) => {
                    const width = Math.min(Math.abs(value) / max * 100, 100);
                    const color = colors[label] || defaultColors[i % defaultColors.length];
                    const isNegative = value < 0;
                    return '<div style="margin-bottom:12px;"><div style="display:flex;justify-content:space-between;margin-bottom:4px;"><span style="font-size:11px;color:#374151;">' + label + '</span><span style="font-size:11px;font-weight:600;color:' + (isNegative ? '#ef4444' : '#10b981') + ';">' + (isNegative ? '' : '+') + value.toFixed(2) + '%</span></div><div style="height:20px;background:#f3f4f6;border-radius:4px;overflow:hidden;"><div style="height:100%;width:' + width + '%;background:' + color + ';border-radius:4px;"></div></div></div>';
                }).join('');
            }

            // Helper function to generate risk gauge
            function generateRiskGauge(value, min = 0, max = 30, label = 'Risk Level') {
                const normalized = Math.min(Math.max((value - min) / (max - min), 0), 1);
                const angle = -90 + (normalized * 180);
                const color = normalized < 0.33 ? '#10b981' : normalized < 0.66 ? '#f59e0b' : '#ef4444';
                const riskLabel = normalized < 0.33 ? 'Low' : normalized < 0.66 ? 'Moderate' : 'High';

                return '<div style="text-align:center;"><svg width="140" height="80" viewBox="0 0 140 80"><defs><linearGradient id="gaugeGrad" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" style="stop-color:#10b981"/><stop offset="50%" style="stop-color:#f59e0b"/><stop offset="100%" style="stop-color:#ef4444"/></linearGradient></defs><path d="M 15 70 A 55 55 0 0 1 125 70" fill="none" stroke="#e5e7eb" stroke-width="12" stroke-linecap="round"/><path d="M 15 70 A 55 55 0 0 1 125 70" fill="none" stroke="url(#gaugeGrad)" stroke-width="12" stroke-linecap="round" stroke-dasharray="' + (normalized * 173) + ' 173"/><circle cx="70" cy="70" r="6" fill="' + color + '"/><line x1="70" y1="70" x2="' + (70 + 40 * Math.cos(angle * Math.PI / 180)) + '" y2="' + (70 + 40 * Math.sin(angle * Math.PI / 180)) + '" stroke="' + color + '" stroke-width="3" stroke-linecap="round"/></svg><div style="margin-top:4px;font-size:18px;font-weight:600;color:' + color + ';">' + value.toFixed(1) + '%</div><div style="font-size:10px;color:#666;">' + riskLabel + ' ' + label + '</div></div>';
            }

            // Helper function to generate SVG line chart for performance history
            function generateLineChart(portfolioReturns, benchmarkReturns, width = 400, height = 180) {
                const padding = {top: 20, right: 20, bottom: 30, left: 45};
                const chartWidth = width - padding.left - padding.right;
                const chartHeight = height - padding.top - padding.bottom;

                // Create data points (monthly returns over time)
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                const currentMonth = new Date().getMonth();
                const labels = [];
                for (let i = 11; i >= 0; i--) {
                    labels.push(months[(currentMonth - i + 12) % 12]);
                }

                // Simulate cumulative returns based on provided annual returns
                const pAnnual = portfolioReturns || 8;
                const bAnnual = benchmarkReturns || 10;
                const pData = [], bData = [];
                let pCum = 100, bCum = 100;
                const pMonthly = Math.pow(1 + pAnnual/100, 1/12) - 1;
                const bMonthly = Math.pow(1 + bAnnual/100, 1/12) - 1;

                for (let i = 0; i < 12; i++) {
                    // Add some variance
                    const variance = (Math.sin(i * 0.8) * 0.02);
                    pCum *= (1 + pMonthly + variance);
                    bCum *= (1 + bMonthly + variance * 0.7);
                    pData.push(pCum);
                    bData.push(bCum);
                }

                const allValues = [...pData, ...bData];
                const minVal = Math.min(...allValues) * 0.98;
                const maxVal = Math.max(...allValues) * 1.02;
                const range = maxVal - minVal;

                const scaleX = (i) => padding.left + (i / 11) * chartWidth;
                const scaleY = (v) => padding.top + chartHeight - ((v - minVal) / range) * chartHeight;

                // Generate path data
                const pPath = pData.map((v, i) => (i === 0 ? 'M' : 'L') + scaleX(i).toFixed(1) + ',' + scaleY(v).toFixed(1)).join(' ');
                const bPath = bData.map((v, i) => (i === 0 ? 'M' : 'L') + scaleX(i).toFixed(1) + ',' + scaleY(v).toFixed(1)).join(' ');

                // Generate grid lines
                let gridLines = '';
                for (let i = 0; i <= 4; i++) {
                    const y = padding.top + (i / 4) * chartHeight;
                    const val = maxVal - (i / 4) * range;
                    gridLines += '<line x1="' + padding.left + '" y1="' + y + '" x2="' + (width - padding.right) + '" y2="' + y + '" stroke="#e5e7eb" stroke-width="1"/>';
                    gridLines += '<text x="' + (padding.left - 5) + '" y="' + (y + 4) + '" text-anchor="end" font-size="9" fill="#6b7280">' + val.toFixed(0) + '</text>';
                }

                // Generate x-axis labels
                let xLabels = '';
                [0, 3, 6, 9, 11].forEach(i => {
                    xLabels += '<text x="' + scaleX(i) + '" y="' + (height - 8) + '" text-anchor="middle" font-size="9" fill="#6b7280">' + labels[i] + '</text>';
                });

                return '<svg width="' + width + '" height="' + height + '" viewBox="0 0 ' + width + ' ' + height + '">' +
                    gridLines + xLabels +
                    '<path d="' + bPath + '" fill="none" stroke="#94a3b8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>' +
                    '<path d="' + pPath + '" fill="none" stroke="#635bff" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>' +
                    '</svg>';
            }

            // Helper function to generate Monte Carlo projection chart
            function generateProjectionChart(currentValue, years = 10, width = 400, height = 200) {
                const padding = {top: 20, right: 20, bottom: 35, left: 55};
                const chartWidth = width - padding.left - padding.right;
                const chartHeight = height - padding.top - padding.bottom;

                // Generate projection paths (P5, P25, P50, P75, P95)
                const scenarios = {
                    p95: {rate: 0.12, color: '#dcfce7', label: '95th'},
                    p75: {rate: 0.09, color: '#bbf7d0', label: '75th'},
                    p50: {rate: 0.07, color: '#635bff', label: 'Median'},
                    p25: {rate: 0.04, color: '#fde68a', label: '25th'},
                    p5: {rate: 0.01, color: '#fecaca', label: '5th'}
                };

                const yearLabels = [];
                for (let i = 0; i <= years; i++) yearLabels.push(new Date().getFullYear() + i);

                // Calculate all values
                const allData = {};
                let maxVal = currentValue, minVal = currentValue;
                Object.entries(scenarios).forEach(([key, {rate}]) => {
                    allData[key] = [];
                    let val = currentValue;
                    for (let i = 0; i <= years; i++) {
                        allData[key].push(val);
                        maxVal = Math.max(maxVal, val);
                        minVal = Math.min(minVal, val);
                        val *= (1 + rate + (Math.random() - 0.5) * 0.02);
                    }
                });

                const range = maxVal - minVal;
                const scaleX = (i) => padding.left + (i / years) * chartWidth;
                const scaleY = (v) => padding.top + chartHeight - ((v - minVal) / range) * chartHeight;

                // Generate area between p25 and p75
                let areaPath = 'M' + scaleX(0) + ',' + scaleY(allData.p75[0]);
                for (let i = 1; i <= years; i++) areaPath += 'L' + scaleX(i) + ',' + scaleY(allData.p75[i]);
                for (let i = years; i >= 0; i--) areaPath += 'L' + scaleX(i) + ',' + scaleY(allData.p25[i]);
                areaPath += 'Z';

                // Generate median line
                const medianPath = allData.p50.map((v, i) => (i === 0 ? 'M' : 'L') + scaleX(i).toFixed(1) + ',' + scaleY(v).toFixed(1)).join(' ');

                // Grid and labels
                let gridLines = '';
                for (let i = 0; i <= 4; i++) {
                    const y = padding.top + (i / 4) * chartHeight;
                    const val = maxVal - (i / 4) * range;
                    gridLines += '<line x1="' + padding.left + '" y1="' + y + '" x2="' + (width - padding.right) + '" y2="' + y + '" stroke="#e5e7eb" stroke-width="1"/>';
                    gridLines += '<text x="' + (padding.left - 5) + '" y="' + (y + 4) + '" text-anchor="end" font-size="9" fill="#6b7280">$' + (val/1000).toFixed(0) + 'K</text>';
                }

                let xLabels = '';
                [0, Math.floor(years/2), years].forEach(i => {
                    xLabels += '<text x="' + scaleX(i) + '" y="' + (height - 8) + '" text-anchor="middle" font-size="9" fill="#6b7280">' + yearLabels[i] + '</text>';
                });

                // Final values annotation
                const finalMedian = allData.p50[years];
                const finalP75 = allData.p75[years];
                const finalP25 = allData.p25[years];

                return '<div>' +
                    '<svg width="' + width + '" height="' + height + '" viewBox="0 0 ' + width + ' ' + height + '">' +
                    gridLines + xLabels +
                    '<path d="' + areaPath + '" fill="#e0e7ff" opacity="0.5"/>' +
                    '<path d="' + medianPath + '" fill="none" stroke="#635bff" stroke-width="2.5" stroke-linecap="round"/>' +
                    '</svg>' +
                    '<div style="display:flex;justify-content:space-around;margin-top:8px;font-size:10px;">' +
                    '<span style="color:#dc2626;">25th: $' + (finalP25/1000).toFixed(0) + 'K</span>' +
                    '<span style="color:#635bff;font-weight:600;">Median: $' + (finalMedian/1000).toFixed(0) + 'K</span>' +
                    '<span style="color:#16a34a;">75th: $' + (finalP75/1000).toFixed(0) + 'K</span>' +
                    '</div></div>';
            }

            // Helper function for performance comparison bars
            function generatePerfComparison(portfolio, benchmark, label) {
                const maxVal = Math.max(Math.abs(portfolio), Math.abs(benchmark), 1);
                const pColor = portfolio >= 0 ? '#635bff' : '#ef4444';
                const bColor = '#94a3b8';
                return '<div style="margin-bottom:16px;"><div style="font-size:11px;color:#666;margin-bottom:6px;">' + label + '</div><div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;"><span style="width:60px;font-size:10px;color:#374151;">Portfolio</span><div style="flex:1;height:16px;background:#f3f4f6;border-radius:3px;overflow:hidden;"><div style="height:100%;width:' + (Math.abs(portfolio)/maxVal*100) + '%;background:' + pColor + ';border-radius:3px;"></div></div><span style="width:50px;text-align:right;font-size:11px;font-weight:600;color:' + pColor + ';">' + (portfolio >= 0 ? '+' : '') + portfolio.toFixed(1) + '%</span></div><div style="display:flex;align-items:center;gap:8px;"><span style="width:60px;font-size:10px;color:#374151;">S&P 500</span><div style="flex:1;height:16px;background:#f3f4f6;border-radius:3px;overflow:hidden;"><div style="height:100%;width:' + (Math.abs(benchmark)/maxVal*100) + '%;background:' + bColor + ';border-radius:3px;"></div></div><span style="width:50px;text-align:right;font-size:11px;color:#666;">' + (benchmark >= 0 ? '+' : '') + benchmark.toFixed(1) + '%</span></div></div>';
            }

            // Helper function to generate performance heat map
            function generateHeatMap(positions, maxItems = 12) {
                const items = positions.slice(0, maxItems).map(pos => {
                    const change = pos.change_percent || ((Math.random() - 0.5) * 10);
                    let bgColor = '#9E9E9E';
                    if (change > 3) bgColor = '#1B5E20';
                    else if (change > 0) bgColor = '#4CAF50';
                    else if (change < -3) bgColor = '#B71C1C';
                    else if (change < 0) bgColor = '#E57373';
                    return '<div style="background:' + bgColor + ';color:white;padding:10px 8px;border-radius:6px;text-align:center;min-width:70px;"><div style="font-weight:600;font-size:11px;">' + pos.symbol + '</div><div style="font-size:10px;opacity:0.9;">' + (change >= 0 ? '+' : '') + change.toFixed(1) + '%</div></div>';
                });
                return '<div style="display:flex;flex-wrap:wrap;gap:8px;">' + items.join('') + '</div>' +
                    '<div style="display:flex;gap:12px;margin-top:12px;font-size:9px;justify-content:center;">' +
                    '<span><span style="display:inline-block;width:10px;height:10px;background:#1B5E20;border-radius:2px;margin-right:4px;"></span>&gt;3%</span>' +
                    '<span><span style="display:inline-block;width:10px;height:10px;background:#4CAF50;border-radius:2px;margin-right:4px;"></span>0-3%</span>' +
                    '<span><span style="display:inline-block;width:10px;height:10px;background:#9E9E9E;border-radius:2px;margin-right:4px;"></span>0%</span>' +
                    '<span><span style="display:inline-block;width:10px;height:10px;background:#E57373;border-radius:2px;margin-right:4px;"></span>0 to -3%</span>' +
                    '<span><span style="display:inline-block;width:10px;height:10px;background:#B71C1C;border-radius:2px;margin-right:4px;"></span>&lt;-3%</span>' +
                    '</div>';
            }

            // Helper function to generate sector benchmark comparison
            function generateSectorBenchmark(portfolioSectors) {
                const sp500Sectors = {
                    'Technology': 29.5, 'Healthcare': 13.2, 'Financials': 12.8, 'Consumer Discretionary': 10.5,
                    'Industrials': 8.7, 'Communication Services': 8.5, 'Consumer Staples': 6.2, 'Energy': 4.1,
                    'Utilities': 2.5, 'Real Estate': 2.4, 'Materials': 2.3
                };
                const sectors = Object.keys(portfolioSectors).length > 0 ? portfolioSectors : {'Equity': 100};
                let html = '';
                Object.entries(sectors).sort((a, b) => b[1] - a[1]).forEach(([sector, pct]) => {
                    const benchPct = sp500Sectors[sector] || 5;
                    const maxPct = Math.max(pct, benchPct, 1);
                    const diff = pct - benchPct;
                    const diffColor = diff >= 0 ? '#10b981' : '#ef4444';
                    html += '<div style="margin-bottom:12px;">' +
                        '<div style="display:flex;justify-content:space-between;margin-bottom:4px;"><span style="font-size:11px;color:#374151;">' + sector + '</span><span style="font-size:10px;color:' + diffColor + ';">' + (diff >= 0 ? '+' : '') + diff.toFixed(1) + '%</span></div>' +
                        '<div style="display:flex;gap:4px;align-items:center;">' +
                        '<div style="flex:1;height:12px;background:#e5e7eb;border-radius:3px;overflow:hidden;position:relative;">' +
                        '<div style="position:absolute;height:100%;width:' + (pct/maxPct*100) + '%;background:#635bff;border-radius:3px;"></div>' +
                        '<div style="position:absolute;height:100%;width:' + (benchPct/maxPct*100) + '%;border-right:2px dashed #94a3b8;"></div>' +
                        '</div>' +
                        '<span style="width:35px;text-align:right;font-size:10px;font-weight:500;">' + pct.toFixed(0) + '%</span>' +
                        '</div></div>';
                });
                return html;
            }

            // Helper function to generate dividend calendar
            function generateDividendCalendar(annualIncome) {
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                const monthlyBase = annualIncome / 12;
                let html = '<div style="display:grid;grid-template-columns:repeat(6,1fr);gap:8px;">';
                months.forEach((month, i) => {
                    const variance = 0.8 + Math.random() * 0.4;
                    const amount = monthlyBase * variance;
                    const intensity = Math.min(amount / (monthlyBase * 1.5), 1);
                    const bgColor = 'rgba(16, 185, 129, ' + (0.2 + intensity * 0.6) + ')';
                    html += '<div style="background:' + bgColor + ';padding:8px;border-radius:6px;text-align:center;">' +
                        '<div style="font-size:10px;color:#166534;font-weight:500;">' + month + '</div>' +
                        '<div style="font-size:11px;font-weight:600;color:#166534;">$' + amount.toFixed(0) + '</div>' +
                        '</div>';
                });
                html += '</div>';
                return html;
            }

            // Helper function to generate dividend projection chart
            function generateDividendProjection(currentIncome, years = 10, growthRate = 0.05) {
                const width = 400, height = 160;
                const padding = {top: 15, right: 20, bottom: 25, left: 50};
                const chartWidth = width - padding.left - padding.right;
                const chartHeight = height - padding.top - padding.bottom;

                const data = [];
                let income = currentIncome;
                for (let i = 0; i <= years; i++) {
                    data.push(income);
                    income *= (1 + growthRate);
                }

                const maxVal = Math.max(...data) * 1.1;
                const scaleX = (i) => padding.left + (i / years) * chartWidth;
                const scaleY = (v) => padding.top + chartHeight - (v / maxVal) * chartHeight;

                // Generate bars
                let bars = '';
                data.forEach((val, i) => {
                    const barWidth = chartWidth / years * 0.7;
                    const x = scaleX(i) - barWidth / 2;
                    const barHeight = (val / maxVal) * chartHeight;
                    bars += '<rect x="' + x + '" y="' + scaleY(val) + '" width="' + barWidth + '" height="' + barHeight + '" fill="#10b981" rx="2"/>';
                    if (i % 2 === 0) {
                        bars += '<text x="' + scaleX(i) + '" y="' + (height - 5) + '" text-anchor="middle" font-size="8" fill="#6b7280">Y' + i + '</text>';
                    }
                });

                // Y-axis labels
                let yLabels = '';
                for (let i = 0; i <= 4; i++) {
                    const val = (maxVal / 4) * i;
                    const y = scaleY(val);
                    yLabels += '<text x="' + (padding.left - 5) + '" y="' + (y + 3) + '" text-anchor="end" font-size="8" fill="#6b7280">$' + (val/1000).toFixed(0) + 'K</text>';
                }

                return '<svg width="' + width + '" height="' + height + '" viewBox="0 0 ' + width + ' ' + height + '">' +
                    yLabels + bars + '</svg>' +
                    '<div style="text-align:center;margin-top:8px;font-size:10px;color:#666;">Year 10 Projected: <strong style="color:#10b981;">$' + data[years].toLocaleString(undefined, {maximumFractionDigits: 0}) + '</strong></div>';
            }

            // Generate concentration bar data
            const concentrationData = topHoldings.slice(0, 5).map(p => ({
                symbol: p.symbol,
                name: p.name || fundNames[p.symbol] || p.symbol,
                weight: totalValue > 0 ? ((p.value || p.shares * p.price) / totalValue * 100) : 0
            }));

            // Calculate top 10 concentration percentage
            const top10Value = topHoldings.reduce((sum, p) => sum + (p.value || p.shares * p.price || 0), 0);
            const top10Concentration = totalValue > 0 ? (top10Value / totalValue * 100) : 0;

            // Create report HTML
            const reportHTML = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Portfolio Analysis Report - ${reportDate}</title>
    <style>
        @page { size: A4; margin: 0; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            color: #1a1a2e;
            line-height: 1.6;
            background: white;
        }
        .page {
            width: 210mm;
            min-height: 297mm;
            padding: 20mm;
            margin: 0 auto;
            background: white;
            page-break-after: always;
            position: relative;
        }
        .page:last-child { page-break-after: auto; }

        /* Cover Page */
        .cover {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 257mm;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: white;
            padding: 30mm;
        }
        .cover-header { text-align: center; margin-top: 30mm; }
        .cover-logo {
            width: 80px;
            height: 80px;
            background: #635bff;
            border-radius: 20px;
            margin: 0 auto 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            font-weight: bold;
        }
        .cover-title { font-size: 42px; font-weight: 300; margin-bottom: 10px; letter-spacing: -1px; }
        .cover-subtitle { font-size: 18px; opacity: 0.8; font-weight: 300; }
        .cover-value {
            text-align: center;
            margin-top: 50px;
        }
        .cover-value-label { font-size: 14px; opacity: 0.7; text-transform: uppercase; letter-spacing: 2px; }
        .cover-value-amount { font-size: 56px; font-weight: 600; margin-top: 10px; }
        .cover-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 30px;
            margin-top: 50px;
            text-align: center;
        }
        .cover-stat-value { font-size: 28px; font-weight: 600; }
        .cover-stat-label { font-size: 12px; opacity: 0.7; margin-top: 5px; }
        .cover-footer {
            text-align: center;
            padding-top: 40px;
            border-top: 1px solid rgba(255,255,255,0.2);
        }
        .cover-date { font-size: 14px; opacity: 0.7; }
        .cover-prepared { font-size: 12px; opacity: 0.5; margin-top: 10px; }

        /* Content Pages */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 15px;
            border-bottom: 2px solid #635bff;
            margin-bottom: 25px;
        }
        .header-logo {
            font-size: 18px;
            font-weight: 600;
            color: #635bff;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .header-logo-icon {
            width: 32px;
            height: 32px;
            background: #635bff;
            border-radius: 8px;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }
        .header-date { font-size: 12px; color: #666; }
        .page-title { font-size: 24px; font-weight: 600; color: #1a1a2e; margin-bottom: 20px; }

        .section { margin-bottom: 25px; }
        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #1a1a2e;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e0e0e0;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }
        .summary-grid-3 { grid-template-columns: repeat(3, 1fr); }
        .summary-card {
            background: #f8f9fa;
            padding: 18px;
            border-radius: 12px;
            text-align: center;
        }
        .summary-card-value {
            font-size: 22px;
            font-weight: 600;
            color: #1a1a2e;
            margin-bottom: 5px;
        }
        .summary-card-label {
            font-size: 10px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .summary-card-value.positive { color: #10b981; }
        .summary-card-value.negative { color: #ef4444; }
        .summary-card-subtitle { font-size: 11px; color: #999; margin-top: 4px; }

        .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }

        .allocation-chart {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .allocation-bar {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .allocation-bar-label {
            width: 70px;
            font-size: 12px;
            font-weight: 500;
        }
        .allocation-bar-track {
            flex: 1;
            height: 22px;
            background: #f0f0f0;
            border-radius: 4px;
            overflow: hidden;
        }
        .allocation-bar-fill {
            height: 100%;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 8px;
            font-size: 10px;
            font-weight: 600;
            color: white;
            min-width: 35px;
        }
        .allocation-bar-fill.stocks { background: #635bff; }
        .allocation-bar-fill.bonds { background: #10b981; }
        .allocation-bar-fill.cash { background: #f59e0b; }
        .allocation-bar-fill.other { background: #6b7280; }
        .allocation-bar-value { width: 80px; text-align: right; font-size: 11px; color: #666; }

        .allocation-summary {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
        }
        .allocation-summary-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e5e7eb;
        }
        .allocation-summary-item:last-child { border-bottom: none; }
        .allocation-summary-label { font-weight: 500; }
        .allocation-summary-value { color: #635bff; font-weight: 600; }

        .holdings-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 10px;
        }
        .holdings-table th {
            background: #f8f9fa;
            padding: 10px 8px;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 2px solid #e5e7eb;
            text-transform: uppercase;
            font-size: 9px;
            letter-spacing: 0.5px;
        }
        .holdings-table td {
            padding: 8px;
            border-bottom: 1px solid #f0f0f0;
            vertical-align: middle;
        }
        .holdings-table tr:nth-child(even) { background: #fafafa; }
        .holdings-table .text-right { text-align: right; }
        .holdings-table .symbol { font-weight: 600; color: #635bff; }
        .holdings-table .weight-bar {
            width: 50px;
            height: 5px;
            background: #e5e7eb;
            border-radius: 3px;
            overflow: hidden;
            display: inline-block;
            vertical-align: middle;
            margin-left: 6px;
        }
        .holdings-table .weight-bar-fill {
            height: 100%;
            background: #635bff;
            border-radius: 3px;
        }

        .risk-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }
        .risk-metric {
            text-align: center;
            padding: 18px;
            background: #f8f9fa;
            border-radius: 12px;
        }
        .risk-metric-value {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 6px;
        }
        .risk-metric-label {
            font-size: 10px;
            color: #666;
            text-transform: uppercase;
        }
        .risk-metric-desc { font-size: 9px; color: #999; margin-top: 4px; }

        .sector-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }
        .sector-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 14px;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 12px;
        }
        .sector-name { font-weight: 500; }
        .sector-pct { color: #635bff; font-weight: 600; }
        .sector-bar {
            width: 60px;
            height: 6px;
            background: #e5e7eb;
            border-radius: 3px;
            overflow: hidden;
            margin-left: 10px;
        }
        .sector-bar-fill { height: 100%; background: #635bff; border-radius: 3px; }

        .geo-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }
        .geo-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 14px;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 12px;
        }
        .geo-flag { font-size: 18px; margin-right: 10px; }
        .geo-name { font-weight: 500; flex: 1; }
        .geo-pct { color: #635bff; font-weight: 600; }

        .perf-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        .perf-table th, .perf-table td {
            padding: 12px;
            text-align: center;
            border-bottom: 1px solid #e5e7eb;
        }
        .perf-table th {
            background: #f8f9fa;
            font-weight: 600;
            font-size: 11px;
            text-transform: uppercase;
        }
        .perf-table td { font-size: 14px; font-weight: 500; }
        .perf-positive { color: #10b981; }
        .perf-negative { color: #ef4444; }

        .dividend-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        .dividend-card {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }
        .dividend-card-value { font-size: 28px; font-weight: 600; }
        .dividend-card-label { font-size: 11px; opacity: 0.9; margin-top: 5px; }

        .insights-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .insight-item {
            display: flex;
            gap: 12px;
            padding: 14px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #635bff;
        }
        .insight-item.warning { border-left-color: #f59e0b; background: #fffbeb; }
        .insight-item.positive { border-left-color: #10b981; background: #ecfdf5; }
        .insight-item.negative { border-left-color: #ef4444; background: #fef2f2; }
        .insight-icon { font-size: 18px; }
        .insight-content { flex: 1; }
        .insight-title { font-weight: 600; margin-bottom: 3px; font-size: 13px; }
        .insight-text { font-size: 11px; color: #666; }

        .top-holdings {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        .top-holding {
            display: flex;
            align-items: center;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        .top-holding-rank {
            width: 28px;
            height: 28px;
            background: #635bff;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            margin-right: 12px;
        }
        .top-holding-info { flex: 1; }
        .top-holding-symbol { font-weight: 600; font-size: 13px; }
        .top-holding-name { font-size: 10px; color: #666; }
        .top-holding-value { text-align: right; }
        .top-holding-amount { font-weight: 600; font-size: 13px; }
        .top-holding-weight { font-size: 10px; color: #635bff; }

        .footer {
            position: absolute;
            bottom: 20mm;
            left: 20mm;
            right: 20mm;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            font-size: 9px;
            color: #999;
        }

        .disclaimer {
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            font-size: 9px;
            color: #666;
            line-height: 1.5;
        }
        .disclaimer-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #374151;
            font-size: 11px;
        }

        .toc-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px dashed #e5e7eb;
            font-size: 14px;
        }
        .toc-item:last-child { border-bottom: none; }
        .toc-page { color: #635bff; font-weight: 600; }

        @media print {
            body { print-color-adjust: exact; -webkit-print-color-adjust: exact; }
            .page { margin: 0; box-shadow: none; }
        }
    </style>
</head>
<body>
    <!-- Page 1: Cover -->
    <div class="page cover">
        <div></div>
        <div class="cover-header">
            <div class="cover-logo">SS</div>
            <h1 class="cover-title">Portfolio Analysis Report</h1>
            <p class="cover-subtitle">Comprehensive Investment Review & Analytics</p>
            <div class="cover-value">
                <div class="cover-value-label">Total Portfolio Value</div>
                <div class="cover-value-amount">$${totalValue.toLocaleString(undefined, {maximumFractionDigits: 0})}</div>
            </div>
            <div class="cover-stats">
                <div>
                    <div class="cover-stat-value">${positions.length}</div>
                    <div class="cover-stat-label">Holdings</div>
                </div>
                <div>
                    <div class="cover-stat-value">${Object.keys(sectors).length}</div>
                    <div class="cover-stat-label">Sectors</div>
                </div>
                <div>
                    <div class="cover-stat-value">${avgDividendYield.toFixed(2)}%</div>
                    <div class="cover-stat-label">Dividend Yield</div>
                </div>
            </div>
        </div>
        <div class="cover-footer">
            <div class="cover-date">${reportDate}</div>
            <div class="cover-prepared">Generated by Statement Scan  Professional Portfolio Analytics</div>
        </div>
    </div>

    <!-- Page 2: Table of Contents & Executive Summary -->
    <div class="page">
        <div class="header">
            <div class="header-logo"><div class="header-logo-icon">SS</div>Statement Scan</div>
            <div class="header-date">${reportDate}</div>
        </div>

        <h1 class="page-title">Table of Contents</h1>
        <div style="margin-bottom: 30px;">
            <div class="toc-item"><span>Executive Summary</span><span class="toc-page">2</span></div>
            <div class="toc-item"><span>Asset Allocation</span><span class="toc-page">3</span></div>
            <div class="toc-item"><span>Performance Analysis</span><span class="toc-page">4</span></div>
            <div class="toc-item"><span>Risk Analysis</span><span class="toc-page">5</span></div>
            <div class="toc-item"><span>Sector & Industry Breakdown</span><span class="toc-page">6</span></div>
            <div class="toc-item"><span>Holdings Detail</span><span class="toc-page">7</span></div>
            <div class="toc-item"><span>Dividend Analysis</span><span class="toc-page">8</span></div>
            <div class="toc-item"><span>Geographic Exposure</span><span class="toc-page">9</span></div>
            <div class="toc-item"><span>Insights & Recommendations</span><span class="toc-page">10</span></div>
        </div>

        <div class="section">
            <h2 class="section-title">Executive Summary</h2>
            <div class="summary-grid">
                <div class="summary-card">
                    <div class="summary-card-value">$${totalValue.toLocaleString(undefined, {maximumFractionDigits: 0})}</div>
                    <div class="summary-card-label">Portfolio Value</div>
                </div>
                <div class="summary-card">
                    <div class="summary-card-value">${positions.length}</div>
                    <div class="summary-card-label">Total Holdings</div>
                </div>
                <div class="summary-card">
                    <div class="summary-card-value">${allocation.stocks.toFixed(0)}%</div>
                    <div class="summary-card-label">Equity Exposure</div>
                </div>
                <div class="summary-card">
                    <div class="summary-card-value">${safeRisk.sharpe_ratio.toFixed(2)}</div>
                    <div class="summary-card-label">Sharpe Ratio</div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title">Top 10 Holdings</h2>
            <div class="top-holdings">
                ${topHoldings.map((pos, i) => {
                    const value = pos.value || (pos.shares * pos.price);
                    const weight = (value / totalValue * 100);
                    return `
                    <div class="top-holding">
                        <div class="top-holding-rank">${i + 1}</div>
                        <div class="top-holding-info">
                            <div class="top-holding-symbol">${pos.symbol}</div>
                            <div class="top-holding-name">${pos.name || fundNames[pos.symbol] || pos.category || pos.symbol}</div>
                        </div>
                        <div class="top-holding-value">
                            <div class="top-holding-amount">$${value.toLocaleString(undefined, {maximumFractionDigits: 0})}</div>
                            <div class="top-holding-weight">${weight.toFixed(1)}%</div>
                        </div>
                    </div>`;
                }).join('')}
            </div>
        </div>

        <div class="footer"><span>Statement Scan Portfolio Analysis</span><span>Page 2 of 10</span></div>
    </div>

    <!-- Page 3: Asset Allocation -->
    <div class="page">
        <div class="header">
            <div class="header-logo"><div class="header-logo-icon">SS</div>Statement Scan</div>
            <div class="header-date">${reportDate}</div>
        </div>

        <h1 class="page-title">Asset Allocation</h1>

        <div class="section">
            <h2 class="section-title">Portfolio Composition</h2>
            <div style="display: flex; gap: 40px; align-items: flex-start;">
                <div style="flex: 1;">
                    ${generatePieChart({
                        'Equities': stocksValue,
                        'Fixed Income': bondsValue,
                        'Cash': cashValue,
                        'Alternatives': totalValue * (allocation.other + allocation.realEstate + allocation.crypto) / 100
                    }, 180, ['#635bff', '#10b981', '#f59e0b', '#8b5cf6'])}
                </div>
                <div style="flex: 1;">
                    <div style="background:#f8f9fa;padding:20px;border-radius:12px;">
                        <div style="display:flex;justify-content:space-between;padding:12px 0;border-bottom:1px solid #e5e7eb;">
                            <span style="color:#374151;">Total Equity</span>
                            <span style="font-weight:600;color:#635bff;">$${stocksValue.toLocaleString(undefined, {maximumFractionDigits: 0})}</span>
                        </div>
                        <div style="display:flex;justify-content:space-between;padding:12px 0;border-bottom:1px solid #e5e7eb;">
                            <span style="color:#374151;">Fixed Income</span>
                            <span style="font-weight:600;color:#10b981;">$${bondsValue.toLocaleString(undefined, {maximumFractionDigits: 0})}</span>
                        </div>
                        <div style="display:flex;justify-content:space-between;padding:12px 0;border-bottom:1px solid #e5e7eb;">
                            <span style="color:#374151;">Cash & Equivalents</span>
                            <span style="font-weight:600;color:#f59e0b;">$${cashValue.toLocaleString(undefined, {maximumFractionDigits: 0})}</span>
                        </div>
                        <div style="display:flex;justify-content:space-between;padding:12px 0;font-size:14px;">
                            <span style="font-weight:600;color:#1a1a2e;">Total Portfolio</span>
                            <span style="font-weight:700;color:#1a1a2e;">$${totalValue.toLocaleString(undefined, {maximumFractionDigits: 0})}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="section" style="margin-top:25px;">
            <h2 class="section-title">Investment Category Breakdown</h2>
            <div style="display: flex; gap: 40px; align-items: flex-start;">
                <div style="flex: 1;">
                    ${generatePieChart(sectors, 180, ['#635bff', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4', '#ec4899', '#14b8a6'])}
                </div>
                <div style="flex: 1;">
                    <h3 style="font-size:13px;color:#374151;margin-bottom:12px;">Top Holdings by Weight</h3>
                    ${topHoldings.slice(0, 5).map((pos, i) => {
                        const weight = totalValue > 0 ? ((pos.value || pos.shares * pos.price) / totalValue * 100) : 0;
                        return '<div style="margin-bottom:10px;"><div style="display:flex;justify-content:space-between;margin-bottom:3px;"><span style="font-size:11px;color:#374151;">' + pos.symbol + '</span><span style="font-size:11px;font-weight:600;color:#1a1a2e;">' + weight.toFixed(1) + '%</span></div><div style="height:8px;background:#e5e7eb;border-radius:4px;overflow:hidden;"><div style="height:100%;width:' + Math.min(weight * 2, 100) + '%;background:#635bff;border-radius:4px;"></div></div></div>';
                    }).join('')}
                </div>
            </div>
        </div>

        <div class="section" style="margin-top:20px;">
            <h2 class="section-title">Performance Heat Map</h2>
            ${generateHeatMap(enrichedPositions, 12)}
        </div>

        <div class="section" style="margin-top:16px;background:#f8f9fa;padding:14px;border-radius:10px;">
            <h2 style="font-size:12px;font-weight:600;color:#1a1a2e;margin-bottom:6px;">Allocation Analysis</h2>
            <p style="font-size: 10px; line-height: 1.6; color: #444; margin:0;">
                Your portfolio is <strong>${allocation.stocks >= 70 ? 'aggressively' : allocation.stocks >= 50 ? 'moderately' : 'conservatively'}</strong> positioned
                with ${(allocation.stocks || 0).toFixed(0)}% in equities and ${(allocation.bonds || 0).toFixed(0)}% in fixed income.
                ${allocation.stocks >= 80 ? 'This high equity allocation suggests a growth-oriented strategy suitable for investors with longer time horizons.' :
                  allocation.stocks >= 60 ? 'This balanced allocation provides a mix of growth potential and stability.' :
                  'This conservative allocation prioritizes capital preservation and income generation.'}
            </p>
        </div>

        <div class="footer"><span>Statement Scan Portfolio Analysis</span><span>Page 3 of 10</span></div>
    </div>

    <!-- Page 4: Performance Analysis -->
    <div class="page">
        <div class="header">
            <div class="header-logo"><div class="header-logo-icon">SS</div>Statement Scan</div>
            <div class="header-date">${reportDate}</div>
        </div>

        <h1 class="page-title">Performance Analysis</h1>

        <div class="section">
            <h2 class="section-title">Historical Returns</h2>
            <table class="perf-table">
                <thead>
                    <tr>
                        <th>Period</th>
                        <th>Portfolio</th>
                        <th>S&P 500</th>
                        <th>60/40 Blend</th>
                        <th>Difference</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>1 Month</td>
                        <td class="${safePerf.returns_1m >= 0 ? 'perf-positive' : 'perf-negative'}">${safePerf.returns_1m.toFixed(2)}%</td>
                        <td>${safePerf.sp500_1m.toFixed(2)}%</td>
                        <td>${safePerf.blend_1m.toFixed(2)}%</td>
                        <td class="${(safePerf.returns_1m - safePerf.sp500_1m) >= 0 ? 'perf-positive' : 'perf-negative'}">${(safePerf.returns_1m - safePerf.sp500_1m).toFixed(2)}%</td>
                    </tr>
                    <tr>
                        <td>3 Months</td>
                        <td class="${safePerf.returns_3m >= 0 ? 'perf-positive' : 'perf-negative'}">${safePerf.returns_3m.toFixed(2)}%</td>
                        <td>${safePerf.sp500_3m.toFixed(2)}%</td>
                        <td>${safePerf.blend_3m.toFixed(2)}%</td>
                        <td class="${(safePerf.returns_3m - safePerf.sp500_3m) >= 0 ? 'perf-positive' : 'perf-negative'}">${(safePerf.returns_3m - safePerf.sp500_3m).toFixed(2)}%</td>
                    </tr>
                    <tr>
                        <td>YTD</td>
                        <td class="${safePerf.returns_ytd >= 0 ? 'perf-positive' : 'perf-negative'}">${safePerf.returns_ytd.toFixed(2)}%</td>
                        <td>${safePerf.sp500_ytd.toFixed(2)}%</td>
                        <td>${safePerf.blend_ytd.toFixed(2)}%</td>
                        <td class="${(safePerf.returns_ytd - safePerf.sp500_ytd) >= 0 ? 'perf-positive' : 'perf-negative'}">${(safePerf.returns_ytd - safePerf.sp500_ytd).toFixed(2)}%</td>
                    </tr>
                    <tr>
                        <td>1 Year</td>
                        <td class="${safePerf.returns_1y >= 0 ? 'perf-positive' : 'perf-negative'}">${safePerf.returns_1y.toFixed(2)}%</td>
                        <td>${safePerf.sp500_1y.toFixed(2)}%</td>
                        <td>${safePerf.blend_1y.toFixed(2)}%</td>
                        <td class="${(safePerf.returns_1y - safePerf.sp500_1y) >= 0 ? 'perf-positive' : 'perf-negative'}">${(safePerf.returns_1y - safePerf.sp500_1y).toFixed(2)}%</td>
                    </tr>
                    <tr>
                        <td>3 Years (Ann.)</td>
                        <td class="${safePerf.returns_3y >= 0 ? 'perf-positive' : 'perf-negative'}">${safePerf.returns_3y.toFixed(2)}%</td>
                        <td>${safePerf.sp500_3y.toFixed(2)}%</td>
                        <td>${safePerf.blend_3y.toFixed(2)}%</td>
                        <td class="${(safePerf.returns_3y - safePerf.sp500_3y) >= 0 ? 'perf-positive' : 'perf-negative'}">${(safePerf.returns_3y - safePerf.sp500_3y).toFixed(2)}%</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="section">
            <h2 class="section-title">Performance Chart - Trailing 12 Months</h2>
            <div style="display:flex;justify-content:center;padding:10px 0;">
                ${generateLineChart(safePerf.returns_1y, safePerf.sp500_1y, 500, 180)}
            </div>
            <div style="display:flex;gap:24px;justify-content:center;font-size:10px;margin-top:8px;">
                <span><span style="display:inline-block;width:16px;height:3px;background:#635bff;border-radius:2px;margin-right:6px;vertical-align:middle;"></span>Portfolio</span>
                <span><span style="display:inline-block;width:16px;height:3px;background:#94a3b8;border-radius:2px;margin-right:6px;vertical-align:middle;"></span>S&P 500</span>
            </div>
        </div>

        <div class="two-col">
            <div class="section">
                <h2 class="section-title">Performance vs Benchmark</h2>
                <div style="padding: 10px 0;">
                    ${generatePerfComparison(safePerf.returns_ytd, safePerf.sp500_ytd, 'YTD')}
                    ${generatePerfComparison(safePerf.returns_1y, safePerf.sp500_1y, '1 Year')}
                    ${generatePerfComparison(safePerf.returns_3y, safePerf.sp500_3y, '3 Year')}
                </div>
                <div style="display:flex;gap:20px;justify-content:center;margin-top:10px;font-size:10px;">
                    <span><span style="display:inline-block;width:12px;height:12px;background:#635bff;border-radius:2px;margin-right:4px;vertical-align:middle;"></span>Portfolio</span>
                    <span><span style="display:inline-block;width:12px;height:12px;background:#94a3b8;border-radius:2px;margin-right:4px;vertical-align:middle;"></span>S&P 500</span>
                </div>
            </div>
            <div class="section">
                <h2 class="section-title">Performance Metrics</h2>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                    <div style="background:#f8fafc;padding:12px;border-radius:8px;text-align:center;">
                        <div style="font-size:22px;font-weight:700;color:${safePerf.returns_ytd >= 0 ? '#10b981' : '#ef4444'};">${safePerf.returns_ytd.toFixed(2)}%</div>
                        <div style="font-size:10px;color:#64748b;margin-top:4px;">YTD Return</div>
                    </div>
                    <div style="background:#f8fafc;padding:12px;border-radius:8px;text-align:center;">
                        <div style="font-size:22px;font-weight:700;color:${safeRisk.alpha >= 0 ? '#10b981' : '#ef4444'};">${safeRisk.alpha.toFixed(2)}%</div>
                        <div style="font-size:10px;color:#64748b;margin-top:4px;">Alpha vs S&P 500</div>
                    </div>
                    <div style="background:#f8fafc;padding:12px;border-radius:8px;text-align:center;">
                        <div style="font-size:22px;font-weight:700;color:#1a1a2e;">${safeRisk.information_ratio.toFixed(2)}</div>
                        <div style="font-size:10px;color:#64748b;margin-top:4px;">Info Ratio</div>
                    </div>
                    <div style="background:#f8fafc;padding:12px;border-radius:8px;text-align:center;">
                        <div style="font-size:22px;font-weight:700;color:#1a1a2e;">${safeRisk.tracking_error.toFixed(2)}%</div>
                        <div style="font-size:10px;color:#64748b;margin-top:4px;">Tracking Error</div>
                    </div>
                </div>
            </div>
        </div>

        ${!hasPerformanceData ? '<p style="font-size: 10px; color: #999; margin-top: 10px; font-style: italic;">* Performance data is estimated. Actual returns may vary.</p>' : ''}

        <div class="footer"><span>Statement Scan Portfolio Analysis</span><span>Page 4 of 10</span></div>
    </div>

    <!-- Page 5: Risk Analysis -->
    <div class="page">
        <div class="header">
            <div class="header-logo"><div class="header-logo-icon">SS</div>Statement Scan</div>
            <div class="header-date">${reportDate}</div>
        </div>

        <h1 class="page-title">Risk Analysis</h1>

        <div class="two-col">
            <div class="section">
                <h2 class="section-title">Volatility Gauge</h2>
                <div style="display:flex;justify-content:center;">
                    ${generateRiskGauge(safeRisk.volatility, 0, 35, 'Volatility')}
                </div>
            </div>
            <div class="section">
                <h2 class="section-title">Beta Analysis</h2>
                <div style="display:flex;justify-content:center;">
                    ${generateRiskGauge(safeRisk.beta, 0, 2, 'Market Beta')}
                </div>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title">Key Risk Metrics</h2>
            <div class="risk-grid">
                <div class="risk-metric">
                    <div class="risk-metric-value">${safeRisk.volatility.toFixed(1)}%</div>
                    <div class="risk-metric-label">Volatility</div>
                    <div class="risk-metric-desc">Annualized Std Dev</div>
                </div>
                <div class="risk-metric">
                    <div class="risk-metric-value">${safeRisk.beta.toFixed(2)}</div>
                    <div class="risk-metric-label">Beta</div>
                    <div class="risk-metric-desc">vs S&P 500</div>
                </div>
                <div class="risk-metric">
                    <div class="risk-metric-value">${safeRisk.sharpe_ratio.toFixed(2)}</div>
                    <div class="risk-metric-label">Sharpe Ratio</div>
                    <div class="risk-metric-desc">Risk-Adj Return</div>
                </div>
                <div class="risk-metric">
                    <div class="risk-metric-value">${safeRisk.max_drawdown.toFixed(1)}%</div>
                    <div class="risk-metric-label">Max Drawdown</div>
                    <div class="risk-metric-desc">Peak to Trough</div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title">Additional Risk Measures</h2>
            <div style="display:grid;grid-template-columns:repeat(4, 1fr);gap:12px;">
                <div style="background:linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);padding:14px;border-radius:10px;text-align:center;">
                    <div style="font-size:20px;font-weight:700;color:#166534;">${safeRisk.sortino_ratio.toFixed(2)}</div>
                    <div style="font-size:10px;color:#15803d;font-weight:500;margin-top:4px;">Sortino Ratio</div>
                </div>
                <div style="background:linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);padding:14px;border-radius:10px;text-align:center;">
                    <div style="font-size:20px;font-weight:700;color:#92400e;">${safeRisk.var_95.toFixed(1)}%</div>
                    <div style="font-size:10px;color:#a16207;font-weight:500;margin-top:4px;">VaR (95%)</div>
                </div>
                <div style="background:linear-gradient(135deg, #ede9fe 0%, #ddd6fe 100%);padding:14px;border-radius:10px;text-align:center;">
                    <div style="font-size:20px;font-weight:700;color:#5b21b6;">${safeRisk.r_squared.toFixed(2)}</div>
                    <div style="font-size:10px;color:#6d28d9;font-weight:500;margin-top:4px;">R-Squared</div>
                </div>
                <div style="background:linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%);padding:14px;border-radius:10px;text-align:center;">
                    <div style="font-size:20px;font-weight:700;color:#0369a1;">${safeRisk.treynor_ratio.toFixed(2)}</div>
                    <div style="font-size:10px;color:#0284c7;font-weight:500;margin-top:4px;">Treynor Ratio</div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title">Risk Assessment</h2>
            <p style="font-size: 12px; line-height: 1.8; color: #444;">
                ${safeRisk.volatility > 20 ? 'Your portfolio exhibits higher than average volatility, suggesting significant price fluctuations.' :
                  safeRisk.volatility > 12 ? 'Your portfolio shows moderate volatility, typical of a diversified equity portfolio.' :
                  'Your portfolio demonstrates relatively low volatility, indicating a more conservative risk profile.'}
                ${safeRisk.beta > 1.1 ? ` With a beta of ${safeRisk.beta.toFixed(2)}, the portfolio is more sensitive to market movements than the benchmark.` :
                  safeRisk.beta < 0.9 ? ` The beta of ${safeRisk.beta.toFixed(2)} indicates lower sensitivity to market movements.` :
                  ` The beta of ${safeRisk.beta.toFixed(2)} suggests the portfolio moves largely in line with the market.`}
                ${safeRisk.sharpe_ratio > 1 ? ' The Sharpe ratio indicates favorable risk-adjusted returns.' :
                  safeRisk.sharpe_ratio > 0.5 ? ' The Sharpe ratio suggests adequate compensation for risk taken.' :
                  ' Consider reviewing the risk-return profile of your holdings.'}
            </p>
        </div>

        <div class="footer"><span>Statement Scan Portfolio Analysis</span><span>Page 5 of 10</span></div>
    </div>

    <!-- Page 6: Sector & Industry -->
    <div class="page">
        <div class="header">
            <div class="header-logo"><div class="header-logo-icon">SS</div>Statement Scan</div>
            <div class="header-date">${reportDate}</div>
        </div>

        <h1 class="page-title">Sector & Industry Breakdown</h1>

        <div class="two-col">
            <div class="section">
                <h2 class="section-title">Sector Distribution</h2>
                <div style="display: flex; justify-content: center; margin-bottom: 15px;">
                    ${generatePieChart(sectors, 150, ['#635bff', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4', '#ec4899', '#84cc16'])}
                </div>
            </div>
            <div class="section">
                <h2 class="section-title">Top Holdings Concentration</h2>
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    ${concentrationData.map((item, i) => `
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="width: 60px; font-weight: 600; font-size: 11px; color: #635bff;">${item.symbol}</span>
                            <div style="flex: 1; height: 18px; background: #f0f0f0; border-radius: 4px; overflow: hidden;">
                                <div style="height: 100%; width: ${Math.min(item.weight * 2, 100)}%; background: ${i === 0 ? '#635bff' : i === 1 ? '#818cf8' : '#a5b4fc'}; border-radius: 4px;"></div>
                            </div>
                            <span style="width: 45px; text-align: right; font-size: 11px; font-weight: 500;">${item.weight.toFixed(1)}%</span>
                        </div>
                    `).join('')}
                    <p style="font-size: 10px; color: #666; margin-top: 8px;">Top 5 holdings represent ${concentrationData.reduce((a, b) => a + b.weight, 0).toFixed(1)}% of portfolio</p>
                </div>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title">Sector Allocation</h2>
            <div class="sector-grid">
                ${Object.entries(sectors).length > 0 ? Object.entries(sectors).sort((a, b) => b[1] - a[1]).map(([name, pct]) => `
                    <div class="sector-item">
                        <span class="sector-name">${name}</span>
                        <div style="display: flex; align-items: center;">
                            <div class="sector-bar"><div class="sector-bar-fill" style="width: ${Math.min(pct * 2, 100)}%"></div></div>
                            <span class="sector-pct">${pct.toFixed(1)}%</span>
                        </div>
                    </div>
                `).join('') : '<div class="sector-item"><span class="sector-name">Technology</span><span class="sector-pct">100%</span></div>'}
            </div>
        </div>

        <div class="section">
            <h2 class="section-title">Sector vs S&P 500 Benchmark</h2>
            ${generateSectorBenchmark(sectors)}
        </div>

        <div class="section">
            <h2 class="section-title">Sector Analysis</h2>
            <p style="font-size: 12px; line-height: 1.8; color: #444;">
                ${Object.keys(sectors).length > 0 ? `
                    Your portfolio is diversified across ${Object.keys(sectors).length} sectors.
                    The largest sector exposure is ${Object.entries(sectors).sort((a, b) => b[1] - a[1])[0]?.[0] || 'N/A'}
                    at ${Object.entries(sectors).sort((a, b) => b[1] - a[1])[0]?.[1]?.toFixed(1) || 0}%.
                    ${Object.entries(sectors).sort((a, b) => b[1] - a[1])[0]?.[1] > 30 ? ' This concentration may increase sector-specific risk.' : ''}
                ` : 'Sector data not available for analysis.'}
            </p>
        </div>

        <div class="footer"><span>Statement Scan Portfolio Analysis</span><span>Page 6 of 10</span></div>
    </div>

    <!-- Page 7: Holdings Detail -->
    <div class="page">
        <div class="header">
            <div class="header-logo"><div class="header-logo-icon">SS</div>Statement Scan</div>
            <div class="header-date">${reportDate}</div>
        </div>

        <h1 class="page-title">Holdings Detail</h1>

        <div class="section">
            <table class="holdings-table">
                <thead>
                    <tr>
                        <th>Symbol</th>
                        <th>Name</th>
                        <th>Sector</th>
                        <th class="text-right">Shares</th>
                        <th class="text-right">Price</th>
                        <th class="text-right">Value</th>
                        <th class="text-right">Weight</th>
                    </tr>
                </thead>
                <tbody>
                    ${enrichedPositions.slice(0, 25).map(pos => {
                        const value = pos.value || (pos.shares * pos.price);
                        const weight = totalValue > 0 ? (value / totalValue * 100) : 0;
                        return `
                            <tr>
                                <td class="symbol">${pos.symbol}</td>
                                <td>${pos.name || fundNames[pos.symbol] || pos.symbol}</td>
                                <td>${pos.category || 'Diversified'}</td>
                                <td class="text-right">${pos.shares?.toLocaleString(undefined, {maximumFractionDigits: 3}) || '-'}</td>
                                <td class="text-right">$${pos.price?.toFixed(2) || '-'}</td>
                                <td class="text-right">$${value.toLocaleString(undefined, {maximumFractionDigits: 0})}</td>
                                <td class="text-right">
                                    ${weight.toFixed(1)}%
                                    <div class="weight-bar"><div class="weight-bar-fill" style="width: ${Math.min(weight * 2, 100)}%"></div></div>
                                </td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
            ${positions.length > 25 ? `<p style="margin-top: 15px; font-size: 11px; color: #666; text-align: center;">Showing top 25 of ${positions.length} holdings by value</p>` : ''}
        </div>

        <div class="footer"><span>Statement Scan Portfolio Analysis</span><span>Page 7 of 10</span></div>
    </div>

    <!-- Page 8: Dividend Analysis -->
    <div class="page">
        <div class="header">
            <div class="header-logo"><div class="header-logo-icon">SS</div>Statement Scan</div>
            <div class="header-date">${reportDate}</div>
        </div>

        <h1 class="page-title">Dividend Analysis</h1>

        <div class="two-col">
            <div class="section">
                <h2 class="section-title">Income Overview</h2>
                <div style="display:flex;flex-direction:column;gap:12px;">
                    <div style="background:linear-gradient(135deg, #10b981 0%, #059669 100%);color:white;padding:20px;border-radius:12px;text-align:center;">
                        <div style="font-size:32px;font-weight:700;">$${annualDividendIncome.toLocaleString(undefined, {maximumFractionDigits: 0})}</div>
                        <div style="font-size:11px;opacity:0.9;margin-top:5px;">Est. Annual Income</div>
                    </div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                        <div style="background:#f0fdf4;padding:14px;border-radius:10px;text-align:center;border:1px solid #bbf7d0;">
                            <div style="font-size:22px;font-weight:700;color:#166534;">${avgDividendYield.toFixed(2)}%</div>
                            <div style="font-size:10px;color:#15803d;margin-top:4px;">Portfolio Yield</div>
                        </div>
                        <div style="background:#f0fdf4;padding:14px;border-radius:10px;text-align:center;border:1px solid #bbf7d0;">
                            <div style="font-size:22px;font-weight:700;color:#166534;">$${(annualDividendIncome / 12).toLocaleString(undefined, {maximumFractionDigits: 0})}</div>
                            <div style="font-size:10px;color:#15803d;margin-top:4px;">Monthly Income</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="section">
                <h2 class="section-title">Income by Category</h2>
                <div style="display:flex;flex-direction:column;gap:8px;">
                    ${(() => {
                        // Calculate income by category
                        const incomeByCategory = {};
                        enrichedPositions.slice(0, 15).forEach(pos => {
                            const value = pos.value || (pos.shares * pos.price);
                            let estYield = pos.dividend_yield || 0;
                            if (estYield === 0) {
                                if (pos.category === 'Fixed Income') estYield = 4.5;
                                else if (pos.category === 'Value') estYield = 2.5;
                                else if (pos.category === 'Index/Passive') estYield = 1.5;
                                else if (pos.category === 'Growth') estYield = 0.8;
                                else if (pos.category === 'International') estYield = 2.2;
                                else estYield = 1.8;
                            }
                            const cat = pos.category || 'Other';
                            incomeByCategory[cat] = (incomeByCategory[cat] || 0) + (value * estYield / 100);
                        });
                        const maxIncome = Math.max(...Object.values(incomeByCategory), 1);
                        const catColors = {'Fixed Income': '#10b981', 'Value': '#635bff', 'Growth': '#f59e0b', 'Index/Passive': '#8b5cf6', 'International': '#06b6d4', 'Other': '#94a3b8', 'Equity': '#ec4899'};
                        return Object.entries(incomeByCategory).sort((a, b) => b[1] - a[1]).map(([cat, income]) => `
                            <div style="display:flex;align-items:center;gap:10px;">
                                <span style="width:80px;font-size:10px;color:#374151;font-weight:500;">${cat}</span>
                                <div style="flex:1;height:16px;background:#f1f5f9;border-radius:4px;overflow:hidden;">
                                    <div style="height:100%;width:${(income/maxIncome*100).toFixed(1)}%;background:${catColors[cat] || '#635bff'};border-radius:4px;"></div>
                                </div>
                                <span style="width:55px;text-align:right;font-size:10px;font-weight:600;color:#1a1a2e;">$${income.toLocaleString(undefined, {maximumFractionDigits: 0})}</span>
                            </div>
                        `).join('');
                    })()}
                </div>
            </div>
        </div>

        <div class="two-col" style="margin-top: 20px;">
            <div class="section">
                <h2 class="section-title">Monthly Dividend Calendar</h2>
                ${generateDividendCalendar(annualDividendIncome)}
            </div>
            <div class="section">
                <h2 class="section-title">10-Year Income Projection</h2>
                ${generateDividendProjection(annualDividendIncome, 10, 0.05)}
                <p style="font-size: 9px; color: #666; margin-top: 8px; text-align: center;">Assumes 5% annual dividend growth rate</p>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title">Estimated Income by Holding</h2>
            <table class="holdings-table">
                <thead>
                    <tr>
                        <th>Symbol</th>
                        <th>Name</th>
                        <th>Category</th>
                        <th class="text-right">Est. Yield</th>
                        <th class="text-right">Est. Annual Income</th>
                    </tr>
                </thead>
                <tbody>
                    ${enrichedPositions.slice(0, 8).map(pos => {
                        const value = pos.value || (pos.shares * pos.price);
                        let estYield = pos.dividend_yield || 0;
                        if (estYield === 0) {
                            if (pos.category === 'Fixed Income') estYield = 4.5;
                            else if (pos.category === 'Value') estYield = 2.5;
                            else if (pos.category === 'Index/Passive') estYield = 1.5;
                            else if (pos.category === 'Growth') estYield = 0.8;
                            else if (pos.category === 'International') estYield = 2.2;
                            else estYield = 1.8;
                        }
                        const estIncome = value * estYield / 100;
                        return '<tr><td class="symbol">' + pos.symbol + '</td><td>' + (pos.name || fundNames[pos.symbol] || pos.symbol) + '</td><td>' + (pos.category || 'Diversified') + '</td><td class="text-right">' + estYield.toFixed(2) + '%</td><td class="text-right">$' + estIncome.toLocaleString(undefined, {maximumFractionDigits: 0}) + '</td></tr>';
                    }).join('')}
                </tbody>
            </table>
            <p style="margin-top: 12px; font-size: 10px; color: #666; font-style: italic;">* Yields are estimated based on fund category when actual yield data is unavailable.</p>
        </div>

        <div class="footer"><span>Statement Scan Portfolio Analysis</span><span>Page 8 of 10</span></div>
    </div>

    <!-- Page 9: Geographic Exposure -->
    <div class="page">
        <div class="header">
            <div class="header-logo"><div class="header-logo-icon">SS</div>Statement Scan</div>
            <div class="header-date">${reportDate}</div>
        </div>

        <h1 class="page-title">Geographic Exposure</h1>

        <div class="two-col">
            <div class="section">
                <h2 class="section-title">Regional Distribution</h2>
                <div style="display: flex; justify-content: center;">
                    ${Object.keys(geography).length > 0 ?
                        generatePieChart(geography, 160, ['#635bff', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4']) :
                        generatePieChart({'United States': allocation.stocks || 70, 'International': 100 - (allocation.stocks || 70)}, 160, ['#635bff', '#10b981'])
                    }
                </div>
            </div>
            <div class="section">
                <h2 class="section-title">Regional Breakdown</h2>
                <div class="geo-grid" style="gap: 8px;">
                    ${Object.keys(geography).length > 0 ?
                        Object.entries(geography).sort((a, b) => b[1] - a[1]).map(([region, pct]) => {
                            const flags = { 'United States': '', 'US': '', 'Europe': '', 'UK': '', 'Japan': '', 'China': '', 'Emerging Markets': '', 'International': '' };
                            return `
                                <div class="geo-item">
                                    <span class="geo-flag">${flags[region] || ''}</span>
                                    <span class="geo-name">${region}</span>
                                    <span class="geo-pct">${pct.toFixed(1)}%</span>
                                </div>
                            `;
                        }).join('') :
                        `<div class="geo-item"><span class="geo-flag"></span><span class="geo-name">United States</span><span class="geo-pct">${(allocation.stocks || 70).toFixed(1)}%</span></div>
                         <div class="geo-item"><span class="geo-flag"></span><span class="geo-name">International</span><span class="geo-pct">${(100 - (allocation.stocks || 70)).toFixed(1)}%</span></div>`
                    }
                </div>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title">Geographic Analysis</h2>
            <p style="font-size: 12px; line-height: 1.8; color: #444;">
                ${Object.keys(geography).length > 0 ?
                    `Your portfolio has exposure to ${Object.keys(geography).length} geographic regions. Consider the currency risk and geopolitical factors associated with international investments.` :
                    'Geographic data is estimated based on holding characteristics. US equities typically dominate most portfolios. Consider adding international exposure for additional diversification benefits.'
                }
            </p>
        </div>

        <div class="section">
            <h2 class="section-title">10-Year Portfolio Projection (Monte Carlo)</h2>
            <div style="display:flex;justify-content:center;">
                ${generateProjectionChart(totalValue, 10, 480, 200)}
            </div>
            <p style="font-size: 10px; color: #666; text-align: center; margin-top: 12px; font-style: italic;">
                Projections based on historical market patterns. Shaded area represents 25th-75th percentile range. Actual results may vary significantly.
            </p>
        </div>

        <div class="footer"><span>Statement Scan Portfolio Analysis</span><span>Page 9 of 10</span></div>
    </div>

    <!-- Page 10: Insights & Disclaimer -->
    <div class="page">
        <div class="header">
            <div class="header-logo"><div class="header-logo-icon">SS</div>Statement Scan</div>
            <div class="header-date">${reportDate}</div>
        </div>

        <h1 class="page-title">Insights & Recommendations</h1>

        <div class="section">
            <h2 class="section-title">Key Insights</h2>
            <div class="insights-list">
                ${insights.length > 0 ? insights.slice(0, 8).map(insight => `
                    <div class="insight-item ${insight.type || ''}">
                        <div class="insight-icon">${insight.type === 'warning' ? '' : insight.type === 'positive' ? '' : insight.type === 'negative' ? '' : ''}</div>
                        <div class="insight-content">
                            <div class="insight-title">${insight.title || insight.category || 'Insight'}</div>
                            <div class="insight-text">${insight.message || insight.text || ''}</div>
                        </div>
                    </div>
                `).join('') : ''}

                <div class="insight-item">
                    <div class="insight-icon"></div>
                    <div class="insight-content">
                        <div class="insight-title">Portfolio Overview</div>
                        <div class="insight-text">Your portfolio contains ${enrichedPositions.length} holdings with a total value of $${totalValue.toLocaleString()}. ${enrichedPositions.length > 10 ? 'Good diversification across multiple holdings.' : 'Consider adding more holdings for better diversification.'}</div>
                    </div>
                </div>

                <div class="insight-item ${top10Concentration > 70 ? 'warning' : 'positive'}">
                    <div class="insight-icon">${top10Concentration > 70 ? '' : ''}</div>
                    <div class="insight-content">
                        <div class="insight-title">Concentration Analysis</div>
                        <div class="insight-text">Your top 10 holdings represent ${top10Concentration.toFixed(1)}% of your portfolio. ${top10Concentration > 80 ? 'High concentration - consider spreading investments across more holdings.' : top10Concentration > 60 ? 'Moderate concentration level.' : 'Well-diversified holdings distribution.'}</div>
                    </div>
                </div>

                <div class="insight-item ${allocation.stocks > 80 ? 'warning' : ''}">
                    <div class="insight-icon">${allocation.stocks > 80 ? '' : ''}</div>
                    <div class="insight-content">
                        <div class="insight-title">Asset Allocation</div>
                        <div class="insight-text">${allocation.stocks > 80 ? 'Your portfolio is heavily weighted in equities at ' + allocation.stocks.toFixed(0) + '%. Consider adding bonds or other assets for stability, especially if approaching retirement.' : 'Your allocation appears balanced for your risk profile with ' + allocation.stocks.toFixed(0) + '% in equities.'}</div>
                    </div>
                </div>

                <div class="insight-item">
                    <div class="insight-icon"></div>
                    <div class="insight-content">
                        <div class="insight-title">Category Diversification</div>
                        <div class="insight-text">Portfolio spans ${Object.keys(sectors).length} investment categories: ${Object.keys(sectors).slice(0, 4).join(', ')}${Object.keys(sectors).length > 4 ? ', and more' : ''}. ${Object.keys(sectors).length < 3 ? 'Consider adding exposure to additional investment styles.' : 'Good diversification across investment categories.'}</div>
                    </div>
                </div>

                <div class="insight-item ${safeRisk.volatility > 20 ? 'warning' : 'positive'}">
                    <div class="insight-icon">${safeRisk.volatility > 20 ? '' : ''}</div>
                    <div class="insight-content">
                        <div class="insight-title">Risk Profile</div>
                        <div class="insight-text">Portfolio volatility of ${safeRisk.volatility.toFixed(1)}% ${safeRisk.volatility > 20 ? 'is above average, suggesting higher risk' : safeRisk.volatility < 12 ? 'is relatively low, suggesting conservative positioning' : 'is in the moderate range'}. Beta of ${safeRisk.beta.toFixed(2)} indicates ${safeRisk.beta > 1.1 ? 'higher' : safeRisk.beta < 0.9 ? 'lower' : 'similar'} market sensitivity compared to S&P 500.</div>
                    </div>
                </div>

                <div class="insight-item ${safeRisk.sharpe_ratio > 1 ? 'positive' : ''}">
                    <div class="insight-icon">${safeRisk.sharpe_ratio > 1 ? '' : ''}</div>
                    <div class="insight-content">
                        <div class="insight-title">Risk-Adjusted Returns</div>
                        <div class="insight-text">Sharpe ratio of ${safeRisk.sharpe_ratio.toFixed(2)} indicates ${safeRisk.sharpe_ratio > 1.5 ? 'excellent' : safeRisk.sharpe_ratio > 1 ? 'good' : safeRisk.sharpe_ratio > 0.5 ? 'acceptable' : 'below average'} risk-adjusted performance. ${safeRisk.sharpe_ratio > 1 ? 'Your portfolio is generating solid returns relative to risk.' : 'Consider rebalancing to improve risk-adjusted returns.'}</div>
                    </div>
                </div>

                <div class="insight-item">
                    <div class="insight-icon"></div>
                    <div class="insight-content">
                        <div class="insight-title">Income Generation</div>
                        <div class="insight-text">Estimated portfolio yield of ${avgDividendYield.toFixed(2)}% provides approximately $${annualDividendIncome.toLocaleString(undefined, {maximumFractionDigits: 0})} in annual income ($${(annualDividendIncome/12).toLocaleString(undefined, {maximumFractionDigits: 0})}/month). ${avgDividendYield > 3 ? 'Good income generation.' : 'Consider adding income-producing investments if current income is a priority.'}</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="disclaimer" style="margin-top: auto;">
            <div class="disclaimer-title">Important Disclosures</div>
            <p style="margin-bottom: 10px;">This report is provided for informational purposes only and does not constitute investment advice, an offer or solicitation to buy or sell any securities, or a recommendation regarding any investment strategy. Past performance is not indicative of future results.</p>
            <p style="margin-bottom: 10px;">The information contained herein is believed to be accurate but is not guaranteed. Investment values may fluctuate and you may receive back less than originally invested. All investments involve risk, including the possible loss of principal.</p>
            <p>Please consult with a qualified financial advisor before making any investment decisions. This report was generated automatically and should be reviewed for accuracy. Statement Scan is not a registered investment advisor.</p>
        </div>

        <div class="footer"><span>Statement Scan Portfolio Analysis</span><span>Page 10 of 10</span></div>
    </div>
</body>
</html>
            `;

            // Open report in new window and trigger print
            const reportWindow = window.open('', '_blank');
            if (reportWindow) {
                reportWindow.document.write(reportHTML);
                reportWindow.document.close();

                // Auto-trigger print dialog after a short delay
                setTimeout(() => {
                    reportWindow.print();
                }, 500);

                showToast('Report generated successfully!', 'success');
            } else {
                showToast('Popup blocked. Please allow popups for this site.', 'error');
            }
        }

        // Expose report generator globally
        window.generateProfessionalReport = generateProfessionalReport;

        // =============================================================================
        // SERVICE WORKER REGISTRATION
        // =============================================================================

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then((registration) => {
                        console.log('Service Worker registered:', registration.scope);

                        // Check for updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // New content available
                                    showToast('Update available! Refresh to see changes.', 'info', {
                                        title: 'App Update',
                                        action: {
                                            label: 'Refresh',
                                            callback: () => window.location.reload()
                                        },
                                        duration: 0
                                    });
                                }
                            });
                        });
                    })
                    .catch((error) => {
                        console.log('Service Worker registration failed:', error);
                    });
            });
        }
    </script>
</body>
</html>
