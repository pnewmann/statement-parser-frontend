<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Statement Scan - Portfolio Intelligence</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><rect width='32' height='32' rx='6' fill='%23635bff'/><rect x='2' y='2' width='14' height='14' rx='3' fill='white'/><rect x='16' y='16' width='14' height='14' rx='3' fill='white'/><rect x='0' y='13' width='32' height='6' fill='white' opacity='0.4'/><rect x='11' y='11' width='10' height='10' rx='2' fill='white'/></svg>" type="image/svg+xml">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'><rect width='180' height='180' rx='40' fill='%23635bff'/><rect x='22' y='22' width='75' height='75' rx='15' fill='white'/><rect x='83' y='83' width='75' height='75' rx='15' fill='white'/><rect x='0' y='78' width='180' height='24' fill='white' opacity='0.4'/><rect x='67' y='67' width='46' height='46' rx='8' fill='white'/></svg>">
    <meta name="theme-color" content="#635bff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Statement Scan">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://d3js.org/topojson.v3.min.js"></script>
    <script src="https://cdn.plaid.com/link/v2/stable/link-initialize.js"></script>
    <style>
        :root {
            --primary: #635bff;
            --primary-dark: #5851db;
            --primary-light: #7a73ff;
            --success: #30d158;
            --danger: #ff453a;
            --warning: #ffd60a;
            --text-primary: #0a2540;
            --text-secondary: #425466;
            --text-muted: #8898aa;
            --bg-primary: #ffffff;
            --bg-secondary: #f6f9fc;
            --bg-tertiary: #e3e8ee;
            --border: #e3e8ee;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.04);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
            --shadow-lg: 0 8px 24px rgba(0,0,0,0.12);
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 16px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-secondary);
            color: var(--text-primary);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 24px;
        }

        /* Header */
        header {
            margin-bottom: 40px;
        }

        .top-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 28px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-icon {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--primary);
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(99, 91, 255, 0.25);
        }

        .logo-icon svg {
            width: 22px;
            height: 22px;
        }

        .brand-text {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .brand-name {
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: -0.01em;
            line-height: 1.2;
        }

        .brand-tagline {
            font-size: 0.625rem;
            font-weight: 500;
            color: var(--text-muted);
            letter-spacing: 0.04em;
            text-transform: uppercase;
            margin-top: 2px;
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: -0.02em;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 1rem;
            text-align: center;
            max-width: 480px;
            margin: 0 auto;
            line-height: 1.6;
        }

        /* Cards */
        .card {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
            padding: 24px;
            transition: box-shadow 0.2s, transform 0.2s;
        }

        .card:hover {
            box-shadow: var(--shadow-md);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Upload Section */
        .upload-card {
            max-width: 600px;
            margin: 0 auto;
            padding: 48px;
            text-align: center;
        }

        .upload-card.dragover {
            border-color: var(--primary);
            background: rgba(99, 91, 255, 0.04);
        }

        .upload-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 24px;
            background: var(--bg-secondary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .upload-icon svg {
            width: 28px;
            height: 28px;
            color: var(--primary);
        }

        .upload-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .upload-hint {
            color: var(--text-muted);
            font-size: 0.875rem;
            margin-bottom: 24px;
        }

        #fileInput {
            display: none;
        }

        /* Multi-file Upload Queue */
        .upload-queue {
            margin-top: 24px;
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            overflow: hidden;
            max-height: 300px;
            overflow-y: auto;
        }

        .upload-queue-header {
            padding: 12px 16px;
            background: var(--bg-secondary);
            font-size: 0.8125rem;
            font-weight: 600;
            color: var(--text-secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
        }

        .upload-queue-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            border-top: 1px solid var(--border);
            gap: 12px;
        }

        .upload-queue-item:first-of-type {
            border-top: none;
        }

        .upload-file-icon {
            width: 36px;
            height: 36px;
            background: var(--bg-secondary);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .upload-file-icon svg {
            width: 18px;
            height: 18px;
            color: var(--primary);
        }

        .upload-file-icon.success {
            background: #dcfce7;
        }

        .upload-file-icon.success svg {
            color: var(--success);
        }

        .upload-file-icon.error {
            background: #fee2e2;
        }

        .upload-file-icon.error svg {
            color: #ef4444;
        }

        .upload-file-icon.processing {
            background: #e0e7ff;
        }

        .upload-file-info {
            flex: 1;
            min-width: 0;
        }

        .upload-file-name {
            font-weight: 500;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .upload-file-status {
            font-size: 0.8125rem;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .upload-file-status.success {
            color: var(--success);
        }

        .upload-file-status.error {
            color: #ef4444;
        }

        .upload-progress-bar {
            width: 100%;
            height: 4px;
            background: var(--bg-tertiary);
            border-radius: 2px;
            margin-top: 6px;
            overflow: hidden;
        }

        .upload-progress-fill {
            height: 100%;
            background: var(--primary);
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        .upload-summary {
            display: flex;
            gap: 16px;
            margin-top: 16px;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            justify-content: center;
        }

        .upload-summary-stat {
            text-align: center;
        }

        .upload-summary-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .upload-summary-value.success {
            color: var(--success);
        }

        .upload-summary-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Entry Method Selector */
        .entry-methods {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 24px;
            padding: 6px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }

        .entry-method-btn {
            flex: 1;
            padding: 12px 16px;
            border: none;
            background: transparent;
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .entry-method-btn:hover {
            color: var(--text-primary);
        }

        .entry-method-btn.active {
            background: var(--bg-primary);
            color: var(--primary);
            box-shadow: var(--shadow-sm);
        }

        .entry-method-btn svg {
            width: 18px;
            height: 18px;
        }

        .entry-panel {
            display: none;
        }

        .entry-panel.active {
            display: block;
        }

        /* Manual Entry */
        .manual-entry-card {
            max-width: 700px;
            margin: 0 auto;
            padding: 32px;
        }

        .manual-entry-form {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .manual-entry-form .form-group {
            flex: 1;
            min-width: 120px;
        }

        .manual-entry-form label {
            display: block;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .manual-entry-form input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 0.9375rem;
            background: var(--bg-primary);
            transition: border-color 0.2s;
        }

        .manual-entry-form input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .manual-entry-form input::placeholder {
            color: var(--text-muted);
        }

        .manual-entry-form .btn-add {
            align-self: flex-end;
            padding: 10px 20px;
        }

        .holdings-list {
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            overflow: hidden;
            margin-bottom: 24px;
        }

        .holdings-list-header {
            display: grid;
            grid-template-columns: 2fr 1.5fr 1.5fr 1.5fr auto;
            gap: 12px;
            padding: 12px 16px;
            background: var(--bg-secondary);
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .holdings-list-empty {
            padding: 48px 24px;
            text-align: center;
            color: var(--text-muted);
        }

        .holdings-list-item {
            display: grid;
            grid-template-columns: 2fr 1.5fr 1.5fr 1.5fr auto;
            gap: 12px;
            padding: 14px 16px;
            border-top: 1px solid var(--border);
            align-items: center;
        }

        .holdings-list-item:first-of-type {
            border-top: none;
        }

        .holding-symbol {
            font-weight: 600;
            color: var(--text-primary);
        }

        .holding-value {
            color: var(--text-secondary);
        }

        .holding-total {
            font-weight: 600;
            color: var(--success);
        }

        .btn-remove {
            width: 32px;
            height: 32px;
            padding: 0;
            border: none;
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .btn-remove:hover {
            background: #fee2e2;
            color: #ef4444;
        }

        .manual-entry-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .manual-total {
            font-size: 1rem;
            color: var(--text-secondary);
        }

        .manual-total strong {
            color: var(--text-primary);
            font-size: 1.25rem;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 10px 18px;
            font-size: 0.875rem;
            font-weight: 600;
            border-radius: var(--radius-md);
            border: none;
            cursor: pointer;
            transition: all 0.15s ease;
            text-decoration: none;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-secondary {
            background: var(--bg-primary);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--bg-secondary);
            border-color: var(--text-muted);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Account List */
        .accounts-section {
            margin-top: 32px;
        }

        .accounts-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .accounts-header h3 {
            font-size: 1rem;
            font-weight: 600;
        }

        .account-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            margin-bottom: 8px;
        }

        .account-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.875rem;
        }

        .account-details {
            flex: 1;
        }

        .account-name-input {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 8px 12px;
            font-size: 0.9375rem;
            color: var(--text-primary);
            font-family: inherit;
        }

        .account-name-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 91, 255, 0.1);
        }

        .account-meta {
            color: var(--text-muted);
            font-size: 0.8125rem;
            margin-top: 4px;
        }

        .account-value {
            font-weight: 600;
            font-size: 1.125rem;
            color: var(--success);
        }

        .remove-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 8px;
            border-radius: var(--radius-sm);
            transition: all 0.15s;
        }

        .remove-btn:hover {
            background: rgba(255, 69, 58, 0.1);
            color: var(--danger);
        }

        .actions-row {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        /* Progress */
        .progress-section {
            display: none;
            text-align: center;
            padding: 80px 40px;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 24px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .spin {
            animation: spin 1s linear infinite;
        }

        .progress-text {
            color: var(--text-secondary);
            font-size: 1rem;
        }

        /* Error */
        .error-message {
            background: rgba(255, 69, 58, 0.08);
            border: 1px solid rgba(255, 69, 58, 0.2);
            color: var(--danger);
            padding: 16px 20px;
            border-radius: var(--radius-md);
            margin-bottom: 24px;
            display: none;
            font-size: 0.9375rem;
        }

        /* Dashboard */
        .dashboard {
            display: none;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .dashboard-title {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .dashboard-logo {
            width: 44px;
            height: 44px;
            background: var(--primary);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(99, 91, 255, 0.25);
        }

        .dashboard-logo svg {
            width: 28px;
            height: 28px;
        }

        .dashboard-title h2 {
            font-size: 1.75rem;
            font-weight: 700;
        }

        .total-badge {
            background: linear-gradient(135deg, var(--success) 0%, #28a745 100%);
            color: white;
            padding: 8px 20px;
            border-radius: 100px;
            font-weight: 600;
            font-size: 1.125rem;
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 4px;
            background: var(--bg-primary);
            padding: 4px;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
            margin-bottom: 32px;
            overflow-x: auto;
        }

        .tab {
            padding: 12px 20px;
            font-size: 0.9375rem;
            font-weight: 500;
            color: var(--text-secondary);
            background: transparent;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.15s;
            white-space: nowrap;
        }

        .tab:hover {
            color: var(--text-primary);
            background: var(--bg-secondary);
        }

        .tab.active {
            background: var(--primary);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Insights Section */
        .insights-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .insights-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .insights-header h3 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .insights-subtitle {
            color: var(--text-muted);
            font-size: 0.9375rem;
        }

        .insights-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .insight-card {
            background: var(--bg-primary);
            border-radius: var(--radius-md);
            padding: 20px 24px;
            border: 1px solid var(--border);
            border-left: 4px solid var(--primary);
            transition: box-shadow 0.2s ease, transform 0.2s ease;
        }

        .insight-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            transform: translateY(-2px);
        }

        .insight-card.insight-warning {
            border-left-color: var(--warning);
            background: linear-gradient(to right, rgba(255, 214, 10, 0.05), transparent);
        }

        .insight-card.insight-positive {
            border-left-color: var(--success);
            background: linear-gradient(to right, rgba(48, 209, 88, 0.05), transparent);
        }

        .insight-card.insight-info {
            border-left-color: var(--primary);
        }

        .insight-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .insight-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }

        .insight-warning .insight-icon {
            background: rgba(255, 214, 10, 0.15);
        }

        .insight-positive .insight-icon {
            background: rgba(48, 209, 88, 0.15);
        }

        .insight-info .insight-icon {
            background: rgba(99, 91, 255, 0.15);
        }

        .insight-category {
            font-size: 0.6875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            background: var(--bg-secondary);
            padding: 4px 8px;
            border-radius: 4px;
        }

        .insight-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 6px;
        }

        .insight-text {
            font-size: 0.9375rem;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .no-insights {
            text-align: center;
            padding: 48px 24px;
            color: var(--text-muted);
        }

        .no-insights svg {
            width: 48px;
            height: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: var(--bg-primary);
            border-radius: var(--radius-md);
            padding: 20px;
            border: 1px solid var(--border);
        }

        .stat-label {
            font-size: 0.8125rem;
            font-weight: 500;
            color: var(--text-muted);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .stat-value.positive {
            color: var(--success);
        }

        .stat-value.negative {
            color: var(--danger);
        }

        .stat-subtitle {
            font-size: 0.8125rem;
            color: var(--text-muted);
            margin-top: 4px;
        }

        /* Charts */
        .chart-card {
            margin-bottom: 24px;
        }

        .chart-wrapper {
            position: relative;
            height: 320px;
        }

        .charts-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 24px;
            margin-bottom: 24px;
        }

        /* Performance Returns */
        .period-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .period-btn {
            padding: 10px 20px;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-secondary);
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.15s;
        }

        .period-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .period-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .returns-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-bottom: 32px;
        }

        .return-card {
            text-align: center;
            padding: 20px 16px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .return-card:hover {
            border-color: var(--primary);
        }

        .return-card.active {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 91, 255, 0.1);
        }

        .return-card .stat-value {
            font-size: 1.5rem;
        }

        .benchmark-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 8px;
        }

        /* World Map */
        .map-container {
            position: relative;
            padding: 24px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
        }

        #worldMapContainer {
            width: 100%;
            max-width: 900px;
            margin: 0 auto;
        }

        #worldMapContainer svg {
            width: 100%;
            height: auto;
            display: block;
        }

        .country {
            fill: #dce3eb;
            stroke: #fff;
            stroke-width: 0.4;
            transition: fill 0.2s;
        }

        .country:hover {
            opacity: 0.85;
        }

        .country.us { fill: var(--primary); }
        .country.developed { fill: #a5b4fc; }
        .country.emerging { fill: #fbbf24; }

        .map-legend {
            display: flex;
            justify-content: center;
            gap: 32px;
            margin-top: 24px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9375rem;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .legend-dot {
            width: 14px;
            height: 14px;
            border-radius: 4px;
        }

        .legend-dot.us { background: var(--primary); }
        .legend-dot.developed { background: #a5b4fc; }
        .legend-dot.emerging { background: #fbbf24; }

        /* Scenario Analysis */
        .scenarios-container {
            display: grid;
            gap: 16px;
        }

        .scenario-card {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 16px;
            align-items: center;
        }

        .scenario-info h4 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .scenario-info p {
            font-size: 0.8125rem;
            color: var(--text-muted);
        }

        .scenario-impact {
            text-align: right;
        }

        .scenario-pct {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .scenario-pct.positive { color: var(--success); }
        .scenario-pct.negative { color: var(--danger); }

        .scenario-value {
            font-size: 0.8125rem;
            color: var(--text-muted);
        }

        .scenario-bar-container {
            grid-column: 1 / -1;
            height: 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }

        .scenario-bar {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .scenario-bar.positive { background: var(--success); }
        .scenario-bar.negative { background: var(--danger); }

        /* Sector Comparison */
        .sector-list {
            display: grid;
            gap: 16px;
        }

        .sector-item {
            display: grid;
            grid-template-columns: 140px 1fr 70px 70px;
            gap: 16px;
            align-items: center;
        }

        .sector-name {
            font-size: 0.9375rem;
            font-weight: 500;
        }

        .sector-bar-container {
            position: relative;
            height: 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
            overflow: hidden;
        }

        .sector-bar {
            position: absolute;
            height: 100%;
            border-radius: 4px;
        }

        .sector-bar.portfolio {
            background: var(--primary);
            z-index: 2;
        }

        .sector-bar.benchmark {
            background: var(--bg-tertiary);
            z-index: 1;
        }

        .sector-pct {
            font-size: 0.875rem;
            text-align: right;
            font-weight: 500;
            font-variant-numeric: tabular-nums;
        }

        .sector-pct.portfolio { color: var(--primary); }
        .sector-pct.benchmark { color: var(--text-muted); }

        /* Risk Cards */
        .risk-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px;
            margin-bottom: 32px;
        }

        .risk-card {
            text-align: center;
            padding: 28px 20px;
        }

        .risk-value {
            font-size: 2.25rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .risk-label {
            font-size: 0.9375rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .risk-desc {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* Holdings Table */
        .table-container {
            overflow-x: auto;
            border-radius: var(--radius-md);
            border: 1px solid var(--border);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9375rem;
        }

        th, td {
            padding: 14px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        th {
            background: var(--bg-secondary);
            font-weight: 600;
            font-size: 0.8125rem;
            text-transform: uppercase;
            letter-spacing: 0.03em;
            color: var(--text-secondary);
        }

        tbody tr:hover {
            background: var(--bg-secondary);
        }

        tbody tr:last-child td {
            border-bottom: none;
        }

        .text-right {
            text-align: right;
        }

        .font-mono {
            font-variant-numeric: tabular-nums;
        }

        .symbol-cell {
            font-weight: 600;
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 100px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .badge-primary {
            background: rgba(99, 91, 255, 0.1);
            color: var(--primary);
        }

        .badge-secondary {
            background: var(--bg-secondary);
            color: var(--text-secondary);
        }

        .total-row {
            background: var(--bg-secondary);
            font-weight: 600;
        }

        /* Top Holdings */
        .holdings-list {
            display: grid;
            gap: 12px;
        }

        .holding-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }

        .holding-item:last-child {
            border-bottom: none;
        }

        .holding-rank {
            width: 28px;
            height: 28px;
            background: var(--bg-secondary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8125rem;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .holding-info {
            flex: 1;
        }

        .holding-symbol {
            font-weight: 600;
        }

        .holding-values {
            text-align: right;
        }

        .holding-amount {
            font-weight: 600;
        }

        .holding-pct {
            font-size: 0.8125rem;
            color: var(--text-muted);
        }

        /* Footer */
        footer {
            text-align: center;
            padding: 40px 0;
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 24px 16px;
            }

            h1 {
                font-size: 1.75rem;
            }

            .upload-card {
                padding: 32px 24px;
            }

            .charts-row {
                grid-template-columns: 1fr;
            }

            .sector-item {
                grid-template-columns: 100px 1fr 60px 60px;
                gap: 8px;
            }

            .tabs {
                padding: 3px;
            }

            .tab {
                padding: 10px 14px;
                font-size: 0.875rem;
            }

            .insights-container {
                padding: 0;
            }

            .insights-header {
                margin-bottom: 24px;
            }

            .insights-header h3 {
                font-size: 1.25rem;
            }

            .insight-card {
                padding: 16px 18px;
            }

            .insight-icon {
                width: 28px;
                height: 28px;
                font-size: 0.875rem;
            }

            .insight-title {
                font-size: 0.9375rem;
            }

            .insight-text {
                font-size: 0.875rem;
            }
        }

        /* Auth Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(10, 37, 64, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            width: 100%;
            max-width: 400px;
            margin: 24px;
            transform: translateY(20px);
            transition: transform 0.2s;
        }

        .modal-overlay.active .modal {
            transform: translateY(0);
        }

        .modal-header {
            padding: 24px 24px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 8px;
            border-radius: var(--radius-sm);
            transition: all 0.15s;
        }

        .modal-close:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .modal-body {
            padding: 24px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            font-size: 0.9375rem;
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: inherit;
            transition: all 0.15s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 91, 255, 0.1);
        }

        .form-input::placeholder {
            color: var(--text-muted);
        }

        .form-error {
            color: var(--danger);
            font-size: 0.8125rem;
            margin-top: 8px;
        }

        .auth-tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
            margin-bottom: 24px;
        }

        .auth-tab {
            flex: 1;
            padding: 12px;
            font-size: 0.9375rem;
            font-weight: 500;
            color: var(--text-muted);
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            transition: all 0.15s;
        }

        .auth-tab:hover {
            color: var(--text-primary);
        }

        .auth-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        .forgot-password-link {
            text-align: center;
            margin-top: 16px;
        }

        .forgot-password-link a,
        .back-to-login a {
            color: var(--primary);
            text-decoration: none;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .forgot-password-link a:hover,
        .back-to-login a:hover {
            text-decoration: underline;
        }

        .back-to-login {
            text-align: center;
            margin-top: 16px;
        }

        .form-description {
            color: var(--text-muted);
            font-size: 0.875rem;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .form-success {
            color: var(--success);
            font-size: 0.875rem;
            margin-top: 8px;
            padding: 12px;
            background: rgba(48, 209, 88, 0.1);
            border-radius: var(--radius-sm);
        }

        /* User Menu */
        .user-menu {
            position: relative;
        }

        .user-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-primary);
            transition: all 0.15s;
        }

        .user-btn:hover {
            border-color: var(--primary);
        }

        .user-avatar {
            width: 28px;
            height: 28px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.75rem;
        }

        .user-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-md);
            min-width: 200px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.15s;
            z-index: 100;
        }

        .user-dropdown.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-item {
            display: block;
            width: 100%;
            padding: 12px 16px;
            font-size: 0.875rem;
            color: var(--text-primary);
            background: none;
            border: none;
            text-align: left;
            cursor: pointer;
            transition: background 0.15s;
        }

        .dropdown-item:hover {
            background: var(--bg-secondary);
        }

        .dropdown-divider {
            height: 1px;
            background: var(--border);
            margin: 4px 0;
        }

        /* Saved Portfolios */
        .saved-portfolios {
            margin-top: 32px;
        }

        .saved-portfolios-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .saved-portfolios-header h3 {
            font-size: 1rem;
            font-weight: 600;
        }

        .portfolio-list {
            display: grid;
            gap: 12px;
        }

        .portfolio-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.15s;
        }

        .portfolio-item:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow-sm);
        }

        .portfolio-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .portfolio-info {
            flex: 1;
        }

        .portfolio-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .portfolio-meta {
            font-size: 0.8125rem;
            color: var(--text-muted);
        }

        .portfolio-value {
            font-weight: 600;
            color: var(--success);
        }

        .portfolio-actions {
            display: flex;
            gap: 8px;
        }

        .portfolio-action-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 8px;
            border-radius: var(--radius-sm);
            transition: all 0.15s;
        }

        .portfolio-action-btn:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .portfolio-action-btn.delete:hover {
            background: rgba(255, 69, 58, 0.1);
            color: var(--danger);
        }

        /* Save Portfolio Modal */
        .save-modal .modal {
            max-width: 450px;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
        }

        .empty-state-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 16px;
            color: var(--text-muted);
        }

        /* Compare Tab */
        .compare-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }

        @media (max-width: 900px) {
            .compare-container {
                grid-template-columns: 1fr;
            }
        }

        .compare-selectors {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 16px;
            align-items: end;
            margin-bottom: 32px;
        }

        @media (max-width: 768px) {
            .compare-selectors {
                grid-template-columns: 1fr;
            }
        }

        .compare-select-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .compare-select-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .compare-select {
            padding: 12px 16px;
            font-size: 0.9375rem;
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            background: var(--bg-primary);
            color: var(--text-primary);
            cursor: pointer;
            font-family: inherit;
        }

        .compare-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 91, 255, 0.1);
        }

        .compare-vs {
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: var(--text-muted);
            padding-bottom: 12px;
        }

        .compare-column {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 24px;
        }

        .compare-column-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }

        .compare-column-title {
            font-size: 1.125rem;
            font-weight: 600;
        }

        .compare-column-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--success);
        }

        .compare-chart-wrapper {
            height: 200px;
            margin-bottom: 20px;
        }

        .compare-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .compare-stat {
            text-align: center;
            padding: 12px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
        }

        .compare-stat-value {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .compare-stat-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        /* Difference Summary */
        .diff-summary {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 24px;
            margin-top: 24px;
        }

        .diff-summary-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-secondary);
        }

        .diff-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
        }

        .diff-item {
            text-align: center;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
        }

        .diff-value {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .diff-value.positive {
            color: var(--success);
        }

        .diff-value.negative {
            color: var(--danger);
        }

        .diff-value.neutral {
            color: var(--text-muted);
        }

        .diff-label {
            font-size: 0.8125rem;
            color: var(--text-muted);
        }

        .compare-btn {
            margin-top: 16px;
        }

        /* What-If Tab */
        .whatif-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }

        @media (max-width: 900px) {
            .whatif-container {
                grid-template-columns: 1fr;
            }
        }

        .whatif-editor {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 24px;
        }

        .whatif-section-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .whatif-position-list {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .whatif-position {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            margin-bottom: 8px;
        }

        .whatif-position-symbol {
            font-weight: 600;
            min-width: 60px;
        }

        .whatif-position-shares {
            flex: 1;
        }

        .whatif-position-shares input {
            width: 80px;
            padding: 8px 12px;
            font-size: 0.875rem;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            background: var(--bg-primary);
            text-align: right;
            font-family: inherit;
        }

        .whatif-position-shares input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .whatif-position-value {
            min-width: 90px;
            text-align: right;
            font-weight: 500;
            color: var(--text-muted);
        }

        .whatif-position-remove {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 4px;
            border-radius: var(--radius-sm);
            transition: all 0.15s;
        }

        .whatif-position-remove:hover {
            background: rgba(255, 69, 58, 0.1);
            color: var(--danger);
        }

        .whatif-add-form {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr auto;
            gap: 12px;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            margin-bottom: 20px;
        }

        @media (max-width: 600px) {
            .whatif-add-form {
                grid-template-columns: 1fr 1fr;
            }
        }

        .whatif-add-form input {
            padding: 10px 12px;
            font-size: 0.875rem;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            background: var(--bg-primary);
            font-family: inherit;
        }

        .whatif-add-form input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .whatif-add-form button {
            padding: 10px 16px;
        }

        /* Rebalance Section */
        .rebalance-targets {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }

        @media (max-width: 600px) {
            .rebalance-targets {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .rebalance-target {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .rebalance-target label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .rebalance-target input {
            padding: 8px 12px;
            font-size: 0.875rem;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            background: var(--bg-primary);
            text-align: center;
            font-family: inherit;
        }

        .rebalance-target input:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* What-If Preview */
        .whatif-preview {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 24px;
        }

        .whatif-preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .whatif-preview-title {
            font-size: 1rem;
            font-weight: 600;
        }

        .whatif-preview-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--success);
        }

        .whatif-impact-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .whatif-impact-card {
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            text-align: center;
        }

        .whatif-impact-value {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .whatif-impact-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .whatif-chart-wrapper {
            height: 180px;
            margin-bottom: 16px;
        }

        .whatif-actions {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        /* Plaid Integration */
        .plaid-section {
            margin-top: 32px;
            padding-top: 32px;
            border-top: 1px solid var(--border);
        }

        .plaid-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .plaid-header h3 {
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .plaid-connections {
            display: grid;
            gap: 12px;
        }

        .plaid-connection {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
        }

        .plaid-connection-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #00d4aa 0%, #00a884 100%);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .plaid-connection-info {
            flex: 1;
        }

        .plaid-connection-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .plaid-connection-meta {
            font-size: 0.8125rem;
            color: var(--text-muted);
        }

        .plaid-connection-actions {
            display: flex;
            gap: 8px;
        }

        .plaid-unavailable {
            text-align: center;
            padding: 32px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            color: var(--text-muted);
        }

        .plaid-unavailable svg {
            width: 48px;
            height: 48px;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        /* Benchmark Toggles */
        .benchmark-toggle {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.8125rem;
            cursor: pointer;
            padding: 6px 12px;
            background: var(--bg-secondary);
            border-radius: var(--radius-sm);
            transition: all 0.15s;
        }

        .benchmark-toggle:hover {
            background: var(--bg-tertiary);
        }

        .benchmark-toggle input {
            display: none;
        }

        .benchmark-label-box {
            width: 12px;
            height: 12px;
            border-radius: 2px;
            opacity: 0.4;
            transition: opacity 0.15s;
        }

        .benchmark-toggle input:checked + .benchmark-label-box {
            opacity: 1;
        }

        /* Projections */
        .projection-stat {
            text-align: center;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
        }

        .projection-stat-value {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .projection-stat-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .monte-carlo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .monte-carlo-item {
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
        }

        .monte-carlo-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .monte-carlo-value {
            font-size: 1.125rem;
            font-weight: 600;
        }

        .monte-carlo-value.positive { color: var(--success); }
        .monte-carlo-value.highlight { color: var(--primary); }

        /* Toast Notifications */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            padding: 16px 24px;
            border-radius: var(--radius-md);
            color: white;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: var(--shadow-lg);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 2000;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast.success {
            background: var(--success);
        }

        .toast.error {
            background: var(--danger);
        }

        .toast svg {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }

        /* Footer */
        .site-footer {
            margin-top: 48px;
            padding: 24px 0;
            border-top: 1px solid var(--border);
            text-align: center;
            color: var(--text-muted);
            font-size: 0.8125rem;
        }

        .footer-links {
            display: flex;
            justify-content: center;
            gap: 24px;
            margin-bottom: 12px;
        }

        .footer-links a {
            color: var(--text-secondary);
            text-decoration: none;
            transition: color 0.2s;
        }

        .footer-links a:hover {
            color: var(--primary);
        }

        .footer-copyright {
            color: var(--text-muted);
        }

        /* ========== MOBILE OPTIMIZATIONS ========== */
        @media (max-width: 480px) {
            body {
                font-size: 14px;
            }

            .container {
                padding: 16px 12px;
            }

            /* Logo & Header */
            .top-nav {
                margin-bottom: 20px;
            }

            .logo {
                gap: 8px;
            }

            .logo-icon {
                width: 32px;
                height: 32px;
                border-radius: 6px;
            }

            .logo-icon svg {
                width: 18px;
                height: 18px;
            }

            .brand-name {
                font-size: 1rem;
            }

            .brand-tagline {
                font-size: 0.5625rem;
            }

            .subtitle {
                font-size: 0.875rem;
                padding: 0 8px;
            }

            /* Entry Method Tabs */
            .entry-methods {
                flex-direction: column;
                gap: 4px;
                padding: 4px;
            }

            .entry-method-btn {
                padding: 10px 12px;
                font-size: 0.8125rem;
            }

            .entry-method-btn svg {
                width: 16px;
                height: 16px;
            }

            /* Upload Card */
            .upload-card {
                padding: 24px 16px !important;
            }

            .upload-icon {
                width: 48px;
                height: 48px;
                margin-bottom: 16px;
            }

            .upload-icon svg {
                width: 24px;
                height: 24px;
            }

            .upload-title {
                font-size: 1.1rem;
            }

            .upload-hint {
                font-size: 0.8125rem;
            }

            /* Manual Entry Form */
            .manual-entry-card {
                padding: 20px 16px !important;
            }

            .manual-entry-form {
                flex-direction: column;
                gap: 12px;
            }

            .manual-entry-form .form-group {
                min-width: 100%;
            }

            .manual-entry-form .btn-add {
                width: 100%;
            }

            /* Holdings List */
            .holdings-list-header {
                display: none;
            }

            .holdings-list-item {
                grid-template-columns: 1fr auto;
                gap: 8px;
            }

            .holdings-list-item .holding-symbol {
                grid-column: 1;
            }

            .holdings-list-item .btn-remove {
                grid-column: 2;
                grid-row: 1 / 3;
            }

            .holdings-list-item .holding-value {
                font-size: 0.8125rem;
            }

            .holdings-list-item .holding-total {
                font-size: 0.875rem;
            }

            .holdings-list-item::before {
                display: none;
            }

            .manual-entry-actions {
                flex-direction: column;
                gap: 16px;
            }

            .manual-entry-actions .manual-total {
                text-align: center;
            }

            .manual-entry-actions > div {
                width: 100%;
                display: flex;
                gap: 8px;
            }

            .manual-entry-actions > div .btn {
                flex: 1;
            }

            /* Dashboard Header */
            .dashboard-header {
                flex-direction: column;
                align-items: stretch;
                gap: 12px;
            }

            .dashboard-title {
                justify-content: center;
                flex-wrap: wrap;
            }

            .dashboard-logo {
                width: 36px;
                height: 36px;
                border-radius: 8px;
            }

            .dashboard-logo svg {
                width: 22px;
                height: 22px;
            }

            .dashboard-title h2 {
                font-size: 1.25rem;
            }

            .total-badge {
                padding: 6px 14px;
                font-size: 1rem;
            }

            .header-actions {
                justify-content: center;
                flex-wrap: wrap;
            }

            .header-actions .btn {
                font-size: 0.8125rem;
                padding: 8px 12px;
            }

            /* Tabs - Horizontal scroll */
            .tabs {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
                flex-wrap: nowrap;
                justify-content: flex-start;
                padding: 4px;
                margin: 0 -12px;
                padding-left: 12px;
                padding-right: 12px;
            }

            .tabs::-webkit-scrollbar {
                display: none;
            }

            .tab {
                flex-shrink: 0;
                padding: 8px 12px;
                font-size: 0.8125rem;
                white-space: nowrap;
            }

            /* Stats Grid */
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }

            .stat-card {
                padding: 14px;
            }

            .stat-label {
                font-size: 0.6875rem;
            }

            .stat-value {
                font-size: 1.25rem;
            }

            .stat-sub {
                font-size: 0.75rem;
            }

            /* Charts */
            .chart-wrapper {
                height: 250px !important;
            }

            .charts-row {
                gap: 16px;
            }

            .chart-card {
                padding: 16px;
            }

            .card-title {
                font-size: 0.9375rem;
            }

            /* Returns Grid */
            .returns-grid {
                grid-template-columns: repeat(4, 1fr) !important;
                gap: 6px;
            }

            .return-card {
                padding: 10px 6px;
            }

            .return-card .stat-label {
                font-size: 0.625rem;
            }

            .return-card .stat-value {
                font-size: 0.9375rem;
            }

            .benchmark-label {
                font-size: 0.625rem;
            }

            /* Benchmark Toggles */
            .benchmark-toggles {
                flex-wrap: wrap;
                gap: 6px;
            }

            .benchmark-toggle {
                padding: 4px 8px;
                font-size: 0.75rem;
            }

            /* Period Buttons */
            .period-buttons {
                gap: 4px;
            }

            .period-btn {
                padding: 6px 10px;
                font-size: 0.75rem;
            }

            /* Projections */
            #projectionsInfo {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 8px;
            }

            .monte-carlo-grid {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 8px;
            }

            .monte-carlo-item {
                padding: 12px;
            }

            .monte-carlo-label {
                font-size: 0.6875rem;
            }

            .monte-carlo-value {
                font-size: 0.9375rem;
            }

            /* Sectors */
            .sector-item {
                grid-template-columns: 1fr !important;
                gap: 6px;
                padding: 12px 0;
            }

            .sector-name {
                font-weight: 600;
            }

            .sector-bar-container {
                order: 3;
            }

            .sector-pct {
                display: inline;
            }

            .sector-pct.benchmark {
                margin-left: 12px;
                color: var(--text-muted);
            }

            /* Geography */
            .map-container {
                flex-direction: column;
            }

            #worldMapContainer {
                min-height: 200px;
            }

            .map-legend {
                flex-direction: row;
                flex-wrap: wrap;
                justify-content: center;
                gap: 12px;
                padding: 12px 0;
            }

            /* Risk Metrics */
            .risk-grid {
                grid-template-columns: repeat(2, 1fr) !important;
            }

            /* Holdings Table */
            .holdings-table th,
            .holdings-table td {
                padding: 10px 8px;
                font-size: 0.8125rem;
            }

            .holdings-table th:nth-child(2),
            .holdings-table td:nth-child(2) {
                display: none;
            }

            /* What-If */
            .whatif-add-form {
                grid-template-columns: 1fr !important;
            }

            /* Compare */
            .compare-container {
                flex-direction: column;
            }

            .compare-side {
                min-width: 100%;
            }

            /* Accounts Section */
            .account-item {
                flex-wrap: wrap;
                gap: 8px;
            }

            .account-details {
                flex: 1;
                min-width: calc(100% - 60px);
            }

            .account-value {
                order: 4;
                width: 100%;
                text-align: left;
                padding-left: 44px;
            }

            /* Upload Queue */
            .upload-queue {
                max-height: 200px;
            }

            .upload-queue-item {
                padding: 10px 12px;
            }

            .upload-file-icon {
                width: 32px;
                height: 32px;
            }

            .upload-file-name {
                font-size: 0.875rem;
            }

            .upload-file-status {
                font-size: 0.75rem;
            }

            /* Buttons */
            .btn {
                padding: 10px 16px;
                font-size: 0.875rem;
            }

            .actions-row {
                flex-direction: column;
                gap: 8px;
            }

            .actions-row .btn {
                width: 100%;
            }

            /* Cards */
            .card {
                padding: 16px;
                border-radius: 12px;
            }

            /* Modal */
            .modal {
                margin: 12px;
                max-height: calc(100vh - 24px);
                overflow-y: auto;
            }

            .modal-header {
                padding: 16px 16px 0;
            }

            .modal-body {
                padding: 16px;
            }

            /* Toast */
            .toast {
                left: 12px;
                right: 12px;
                bottom: 12px;
                transform: none;
                max-width: none;
            }
        }

        /* Tablet adjustments */
        @media (min-width: 481px) and (max-width: 768px) {
            .entry-methods {
                max-width: 100%;
            }

            .manual-entry-form {
                flex-wrap: wrap;
            }

            .manual-entry-form .form-group {
                flex: 1 1 calc(50% - 6px);
                min-width: calc(50% - 6px);
            }

            .manual-entry-form .btn-add {
                flex: 1 1 100%;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .returns-grid {
                grid-template-columns: repeat(4, 1fr) !important;
            }

            .dashboard-title h2 {
                font-size: 1.5rem;
            }
        }

        /* ========== DARK MODE SUPPORT ========== */
        :root[data-theme="dark"] {
            --primary: #7a73ff;
            --primary-dark: #635bff;
            --primary-light: #9d97ff;
            --success: #34d399;
            --danger: #f87171;
            --warning: #fbbf24;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --bg-primary: #1e293b;
            --bg-secondary: #0f172a;
            --bg-tertiary: #334155;
            --border: #334155;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.2);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.3);
            --shadow-lg: 0 8px 24px rgba(0,0,0,0.4);
        }

        :root[data-theme="dark"] body {
            background: var(--bg-secondary);
        }

        :root[data-theme="dark"] .country {
            fill: #475569;
        }

        :root[data-theme="dark"] .upload-file-icon.success {
            background: rgba(52, 211, 153, 0.2);
        }

        :root[data-theme="dark"] .upload-file-icon.error {
            background: rgba(248, 113, 113, 0.2);
        }

        /* Theme toggle button */
        .theme-toggle {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            color: var(--text-secondary);
        }

        .theme-toggle:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .theme-toggle svg {
            width: 18px;
            height: 18px;
        }

        .theme-toggle .sun-icon { display: none; }
        .theme-toggle .moon-icon { display: block; }

        :root[data-theme="dark"] .theme-toggle .sun-icon { display: block; }
        :root[data-theme="dark"] .theme-toggle .moon-icon { display: none; }

        /* Smooth theme transition */
        body, .card, .modal, .btn, input, select, .toast {
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }

        /* ========== ENHANCED TOAST SYSTEM ========== */
        .toast-container {
            position: fixed;
            bottom: 24px;
            right: 24px;
            display: flex;
            flex-direction: column-reverse;
            gap: 12px;
            z-index: 2000;
            pointer-events: none;
        }

        .toast {
            position: relative;
            padding: 16px 48px 16px 20px;
            border-radius: var(--radius-md);
            color: white;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: var(--shadow-lg);
            transform: translateX(120%);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: auto;
            max-width: 400px;
            overflow: hidden;
        }

        .toast.show {
            transform: translateX(0);
            opacity: 1;
        }

        .toast.success { background: var(--success); }
        .toast.error { background: var(--danger); }
        .toast.warning { background: #f59e0b; }
        .toast.info { background: var(--primary); }

        .toast-icon {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            margin-bottom: 2px;
        }

        .toast-message {
            font-size: 0.875rem;
            opacity: 0.95;
        }

        .toast-close {
            position: absolute;
            top: 50%;
            right: 12px;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            padding: 4px;
            border-radius: var(--radius-sm);
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .toast-close:hover {
            opacity: 1;
        }

        .toast-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            background: rgba(255,255,255,0.4);
            border-radius: 0 0 var(--radius-md) var(--radius-md);
            animation: toast-progress linear forwards;
        }

        @keyframes toast-progress {
            from { width: 100%; }
            to { width: 0%; }
        }

        /* ========== LOADING STATES & SKELETON LOADERS ========== */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(10, 37, 64, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1500;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
        }

        .loading-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        :root[data-theme="dark"] .loading-overlay {
            background: rgba(0, 0, 0, 0.7);
        }

        .loading-content {
            background: var(--bg-primary);
            padding: 32px 48px;
            border-radius: var(--radius-lg);
            text-align: center;
            box-shadow: var(--shadow-lg);
        }

        .loading-content .spinner {
            margin: 0 auto 16px;
        }

        .skeleton {
            background: linear-gradient(90deg, var(--bg-secondary) 25%, var(--bg-tertiary) 50%, var(--bg-secondary) 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
            border-radius: var(--radius-sm);
        }

        @keyframes skeleton-loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .skeleton-text {
            height: 1em;
            margin-bottom: 0.5em;
        }

        .skeleton-text:last-child {
            width: 60%;
        }

        .skeleton-card {
            height: 120px;
            margin-bottom: 16px;
        }

        .skeleton-row {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
        }

        .skeleton-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
        }

        .skeleton-block {
            flex: 1;
            height: 40px;
        }

        /* Button loading state */
        .btn.loading {
            position: relative;
            color: transparent !important;
            pointer-events: none;
        }

        .btn.loading::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            border: 2px solid transparent;
            border-top-color: currentColor;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
        }

        .btn-primary.loading::after { border-top-color: white; }
        .btn-secondary.loading::after { border-top-color: var(--primary); }

        /* ========== FORM VALIDATION STYLES ========== */
        .form-group.has-error .form-input,
        .manual-entry-form .form-group.has-error input {
            border-color: var(--danger);
            animation: shake 0.5s ease;
        }

        .form-group.has-success .form-input,
        .manual-entry-form .form-group.has-success input {
            border-color: var(--success);
        }

        .form-group .validation-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            width: 18px;
            height: 18px;
        }

        .form-group.has-error .validation-icon { color: var(--danger); }
        .form-group.has-success .validation-icon { color: var(--success); }

        .form-input-wrapper {
            position: relative;
        }

        .form-input-wrapper .form-input {
            padding-right: 40px;
        }

        .inline-error {
            color: var(--danger);
            font-size: 0.75rem;
            margin-top: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }
        }

        /* ========== KEYBOARD SHORTCUT HINTS ========== */
        .kbd {
            display: inline-block;
            padding: 2px 6px;
            font-size: 0.6875rem;
            font-family: ui-monospace, monospace;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 4px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            margin-left: 8px;
            color: var(--text-muted);
        }

        .shortcut-hint {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-left: auto;
        }

        /* Shortcuts Help Modal */
        .shortcuts-grid {
            display: grid;
            gap: 12px;
        }

        .shortcut-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border-radius: var(--radius-sm);
        }

        .shortcut-action {
            color: var(--text-primary);
            font-weight: 500;
        }

        .shortcut-keys {
            display: flex;
            gap: 4px;
        }

        /* ========== ACCESSIBILITY IMPROVEMENTS ========== */
        .skip-link {
            position: absolute;
            top: -100px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary);
            color: white;
            padding: 12px 24px;
            border-radius: var(--radius-md);
            z-index: 9999;
            font-weight: 600;
            transition: top 0.2s;
            text-decoration: none;
        }

        .skip-link:focus {
            top: 16px;
        }

        /* Focus visible styles */
        *:focus-visible {
            outline: 2px solid var(--primary);
            outline-offset: 2px;
        }

        .btn:focus-visible {
            box-shadow: 0 0 0 3px rgba(99, 91, 255, 0.3);
        }

        /* Screen reader only text */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* Reduced motion preference */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* ========== CONNECTION STATUS INDICATOR ========== */
        .connection-status {
            position: fixed;
            bottom: 16px;
            left: 16px;
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: var(--radius-md);
            font-size: 0.75rem;
            font-weight: 500;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            box-shadow: var(--shadow-sm);
            z-index: 100;
            opacity: 0.8;
            transition: opacity 0.2s;
        }

        .connection-status:hover {
            opacity: 1;
        }

        .connection-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
        }

        .connection-status.offline .connection-dot {
            background: var(--danger);
        }

        .connection-status.offline {
            color: var(--danger);
        }

        /* Session timeout warning */
        .session-warning {
            position: fixed;
            top: 16px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--warning);
            color: #1a1a1a;
            padding: 12px 24px;
            border-radius: var(--radius-md);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 1900;
            box-shadow: var(--shadow-lg);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }

        .session-warning.show {
            opacity: 1;
            visibility: visible;
        }

        /* ========== SETTINGS PANEL ========== */
        .settings-section {
            margin-bottom: 24px;
        }

        .settings-section-title {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-bottom: 12px;
        }

        .settings-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }

        .settings-option:last-child {
            border-bottom: none;
        }

        .settings-option-label {
            font-weight: 500;
            color: var(--text-primary);
        }

        .settings-option-desc {
            font-size: 0.8125rem;
            color: var(--text-muted);
            margin-top: 2px;
        }

        /* Toggle switch */
        .toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-tertiary);
            border-radius: 24px;
            transition: 0.3s;
        }

        .toggle-slider::before {
            content: '';
            position: absolute;
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background: white;
            border-radius: 50%;
            transition: 0.3s;
        }

        .toggle-switch input:checked + .toggle-slider {
            background: var(--primary);
        }

        .toggle-switch input:checked + .toggle-slider::before {
            transform: translateX(20px);
        }

        .toggle-switch input:focus-visible + .toggle-slider {
            box-shadow: 0 0 0 3px rgba(99, 91, 255, 0.3);
        }

        /* Select dropdown for settings */
        .settings-select {
            padding: 8px 32px 8px 12px;
            font-size: 0.875rem;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            background: var(--bg-primary);
            color: var(--text-primary);
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%238898aa' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
        }

        .settings-select:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* ========== CONFIRMATION MODAL ========== */
        .confirm-modal .modal {
            max-width: 380px;
        }

        .confirm-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 16px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .confirm-icon.danger {
            background: rgba(248, 113, 113, 0.15);
            color: var(--danger);
        }

        .confirm-icon.warning {
            background: rgba(251, 191, 36, 0.15);
            color: #f59e0b;
        }

        .confirm-text {
            text-align: center;
            margin-bottom: 24px;
        }

        .confirm-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .confirm-desc {
            color: var(--text-muted);
            font-size: 0.9375rem;
        }

        .confirm-actions {
            display: flex;
            gap: 12px;
        }

        .confirm-actions .btn {
            flex: 1;
        }

        .confirm-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 16px;
            font-size: 0.8125rem;
            color: var(--text-muted);
        }

        /* ========== IMPROVED EMPTY STATES ========== */
        .empty-state-enhanced {
            text-align: center;
            padding: 48px 24px;
        }

        .empty-state-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 24px;
            background: var(--bg-secondary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: empty-bounce 2s ease-in-out infinite;
        }

        @keyframes empty-bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }

        .empty-state-icon svg {
            width: 40px;
            height: 40px;
            color: var(--text-muted);
        }

        .empty-state-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .empty-state-desc {
            color: var(--text-muted);
            margin-bottom: 24px;
            max-width: 320px;
            margin-left: auto;
            margin-right: auto;
        }

        .empty-state-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
        }

        /* ========== UNDO TOAST ========== */
        .undo-toast {
            background: var(--text-primary);
        }

        .undo-toast .btn-undo {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 4px 12px;
            border-radius: var(--radius-sm);
            font-weight: 600;
            cursor: pointer;
            margin-left: 12px;
        }

        .undo-toast .btn-undo:hover {
            background: rgba(255,255,255,0.3);
        }

        /* Mobile adjustments for new components */
        @media (max-width: 480px) {
            .toast-container {
                left: 12px;
                right: 12px;
                bottom: 12px;
            }

            .toast {
                max-width: none;
            }

            .shortcuts-grid {
                gap: 8px;
            }

            .shortcut-item {
                padding: 10px 12px;
            }

            .settings-option {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .confirm-actions {
                flex-direction: column;
            }
        }

        /* ========== ONBOARDING TUTORIAL ========== */
        .onboarding-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(10, 37, 64, 0.85);
            z-index: 3000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }

        .onboarding-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        :root[data-theme="dark"] .onboarding-overlay {
            background: rgba(0, 0, 0, 0.9);
        }

        .onboarding-card {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            max-width: 480px;
            width: 90%;
            overflow: hidden;
            animation: onboarding-enter 0.4s ease;
        }

        @keyframes onboarding-enter {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .onboarding-image {
            height: 200px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .onboarding-image svg {
            width: 80px;
            height: 80px;
            opacity: 0.9;
        }

        .onboarding-content {
            padding: 32px;
            text-align: center;
        }

        .onboarding-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 12px;
            color: var(--text-primary);
        }

        .onboarding-text {
            color: var(--text-secondary);
            margin-bottom: 24px;
            line-height: 1.6;
        }

        .onboarding-steps {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 24px;
        }

        .onboarding-step {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            transition: all 0.3s;
        }

        .onboarding-step.active {
            width: 24px;
            border-radius: 4px;
            background: var(--primary);
        }

        .onboarding-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .onboarding-skip {
            color: var(--text-muted);
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.875rem;
            padding: 8px 16px;
        }

        .onboarding-skip:hover {
            color: var(--text-primary);
        }

        /* Spotlight highlight for tutorial */
        .spotlight {
            position: fixed;
            z-index: 2999;
            pointer-events: none;
        }

        .spotlight-hole {
            position: absolute;
            border-radius: var(--radius-md);
            box-shadow: 0 0 0 9999px rgba(10, 37, 64, 0.85);
            transition: all 0.4s ease;
        }

        :root[data-theme="dark"] .spotlight-hole {
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.9);
        }

        .spotlight-tooltip {
            position: absolute;
            background: var(--bg-primary);
            border-radius: var(--radius-md);
            padding: 16px 20px;
            box-shadow: var(--shadow-lg);
            max-width: 300px;
            pointer-events: auto;
        }

        .spotlight-tooltip::before {
            content: '';
            position: absolute;
            width: 12px;
            height: 12px;
            background: var(--bg-primary);
            transform: rotate(45deg);
        }

        .spotlight-tooltip.top::before {
            bottom: -6px;
            left: 50%;
            margin-left: -6px;
        }

        .spotlight-tooltip.bottom::before {
            top: -6px;
            left: 50%;
            margin-left: -6px;
        }

        /* ========== ANIMATED TRANSITIONS ========== */
        .view-transition {
            animation: view-fade-in 0.3s ease;
        }

        @keyframes view-fade-in {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .tab-content {
            animation: none;
        }

        .tab-content.active {
            animation: tab-slide-in 0.3s ease;
        }

        @keyframes tab-slide-in {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .card-enter {
            animation: card-pop-in 0.3s ease;
        }

        @keyframes card-pop-in {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .stagger-enter > * {
            opacity: 0;
            animation: stagger-fade-in 0.4s ease forwards;
        }

        .stagger-enter > *:nth-child(1) { animation-delay: 0.05s; }
        .stagger-enter > *:nth-child(2) { animation-delay: 0.1s; }
        .stagger-enter > *:nth-child(3) { animation-delay: 0.15s; }
        .stagger-enter > *:nth-child(4) { animation-delay: 0.2s; }
        .stagger-enter > *:nth-child(5) { animation-delay: 0.25s; }
        .stagger-enter > *:nth-child(6) { animation-delay: 0.3s; }

        @keyframes stagger-fade-in {
            to {
                opacity: 1;
            }
        }

        /* ========== DRAG AND DROP ========== */
        .draggable {
            cursor: grab;
            transition: transform 0.15s, box-shadow 0.15s;
        }

        .draggable:active {
            cursor: grabbing;
        }

        .draggable.dragging {
            opacity: 0.8;
            transform: scale(1.02);
            box-shadow: var(--shadow-lg);
            z-index: 100;
        }

        .drag-handle {
            cursor: grab;
            color: var(--text-muted);
            padding: 4px;
            margin-right: 8px;
        }

        .drag-handle:hover {
            color: var(--text-secondary);
        }

        .drop-zone {
            transition: all 0.2s;
        }

        .drop-zone.drag-over {
            background: rgba(99, 91, 255, 0.05);
            border-color: var(--primary);
        }

        .drop-indicator {
            height: 2px;
            background: var(--primary);
            border-radius: 1px;
            margin: 4px 0;
            opacity: 0;
            transition: opacity 0.15s;
        }

        .drop-indicator.active {
            opacity: 1;
        }

        /* ========== QUICK ACTIONS & RECENT ========== */
        .quick-actions {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .quick-action-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 100px;
            font-size: 0.8125rem;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.15s;
        }

        .quick-action-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .quick-action-btn svg {
            width: 14px;
            height: 14px;
        }

        .recent-section {
            margin-bottom: 32px;
        }

        .recent-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .recent-title {
            font-size: 0.8125rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .recent-clear {
            font-size: 0.75rem;
            color: var(--text-muted);
            background: none;
            border: none;
            cursor: pointer;
        }

        .recent-clear:hover {
            color: var(--primary);
        }

        .recent-list {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .recent-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 14px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.15s;
        }

        .recent-item:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow-sm);
        }

        .recent-item-icon {
            width: 32px;
            height: 32px;
            background: var(--bg-secondary);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
        }

        .recent-item-info {
            flex: 1;
        }

        .recent-item-name {
            font-weight: 500;
            color: var(--text-primary);
        }

        .recent-item-meta {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* ========== DIVIDEND TRACKING ========== */
        .dividend-card {
            background: linear-gradient(135deg, var(--success) 0%, #28a745 100%);
            color: white;
            border: none;
        }

        .dividend-card .stat-label {
            color: rgba(255,255,255,0.8);
        }

        .dividend-card .stat-value {
            color: white;
        }

        .dividend-calendar {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }

        .dividend-month {
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            text-align: center;
        }

        .dividend-month-name {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .dividend-month-amount {
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--success);
        }

        .dividend-month.current {
            border: 2px solid var(--primary);
        }

        /* ========== TAX LOT TRACKING ========== */
        .tax-lot-table {
            font-size: 0.875rem;
        }

        .tax-lot-table th {
            font-size: 0.75rem;
        }

        .tax-lot-gain {
            color: var(--success);
            font-weight: 600;
        }

        .tax-lot-loss {
            color: var(--danger);
            font-weight: 600;
        }

        .tax-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .tax-summary-card {
            padding: 20px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            text-align: center;
        }

        .tax-summary-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .tax-summary-value {
            font-size: 1.5rem;
            font-weight: 700;
        }

        /* ========== REBALANCING ========== */
        .rebalance-visual {
            display: flex;
            gap: 24px;
            align-items: center;
            margin-bottom: 24px;
        }

        .rebalance-pie {
            width: 150px;
            height: 150px;
            flex-shrink: 0;
        }

        .rebalance-trades {
            flex: 1;
        }

        .rebalance-trade-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            margin-bottom: 8px;
        }

        .rebalance-trade-action {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .rebalance-trade-action.buy {
            background: rgba(48, 209, 88, 0.15);
            color: var(--success);
        }

        .rebalance-trade-action.sell {
            background: rgba(255, 69, 58, 0.15);
            color: var(--danger);
        }

        .rebalance-trade-symbol {
            font-weight: 600;
            min-width: 60px;
        }

        .rebalance-trade-amount {
            flex: 1;
            text-align: right;
            color: var(--text-secondary);
        }

        /* ========== PORTFOLIO ALERTS ========== */
        .alerts-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .alert-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
        }

        .alert-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .alert-icon.price-up {
            background: rgba(48, 209, 88, 0.15);
            color: var(--success);
        }

        .alert-icon.price-down {
            background: rgba(255, 69, 58, 0.15);
            color: var(--danger);
        }

        .alert-content {
            flex: 1;
        }

        .alert-title {
            font-weight: 600;
            margin-bottom: 2px;
        }

        .alert-desc {
            font-size: 0.8125rem;
            color: var(--text-muted);
        }

        .alert-toggle {
            flex-shrink: 0;
        }

        .add-alert-form {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr auto;
            gap: 12px;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            margin-top: 16px;
        }

        /* ========== HISTORICAL SNAPSHOTS ========== */
        .snapshot-timeline {
            position: relative;
            padding-left: 24px;
        }

        .snapshot-timeline::before {
            content: '';
            position: absolute;
            left: 8px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--border);
        }

        .snapshot-item {
            position: relative;
            padding: 16px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            margin-bottom: 16px;
            margin-left: 16px;
        }

        .snapshot-item::before {
            content: '';
            position: absolute;
            left: -24px;
            top: 20px;
            width: 12px;
            height: 12px;
            background: var(--primary);
            border-radius: 50%;
            border: 3px solid var(--bg-primary);
        }

        .snapshot-date {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .snapshot-value {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .snapshot-change {
            font-size: 0.875rem;
        }

        /* ========== EXPORT OPTIONS ========== */
        .export-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
        }

        .export-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            padding: 24px 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.15s;
        }

        .export-option:hover {
            border-color: var(--primary);
            background: var(--bg-primary);
        }

        .export-option-icon {
            width: 48px;
            height: 48px;
            background: var(--bg-primary);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
        }

        .export-option-label {
            font-weight: 600;
            color: var(--text-primary);
        }

        .export-option-desc {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-align: center;
        }

        /* ========== IMPORT TEMPLATES ========== */
        .import-templates {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .import-template {
            padding: 20px;
            background: var(--bg-primary);
            border: 1px dashed var(--border);
            border-radius: var(--radius-md);
            text-align: center;
            cursor: pointer;
            transition: all 0.15s;
        }

        .import-template:hover {
            border-color: var(--primary);
            border-style: solid;
        }

        .import-template-icon {
            width: 40px;
            height: 40px;
            margin: 0 auto 12px;
            color: var(--text-muted);
        }

        .import-template-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .import-template-desc {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* ========== PRINT STYLES ========== */
        @media print {
            .top-nav,
            .theme-toggle,
            .connection-status,
            .session-warning,
            .toast-container,
            .tabs,
            .header-actions,
            .btn,
            footer {
                display: none !important;
            }

            body {
                background: white;
                color: black;
            }

            .container {
                max-width: 100%;
                padding: 0;
            }

            .card {
                box-shadow: none;
                border: 1px solid #ddd;
                break-inside: avoid;
            }

            .chart-wrapper {
                height: 250px !important;
            }

            .tab-content {
                display: block !important;
                page-break-before: always;
            }

            .tab-content:first-child {
                page-break-before: avoid;
            }

            .print-header {
                display: block !important;
                text-align: center;
                margin-bottom: 24px;
                padding-bottom: 16px;
                border-bottom: 2px solid #333;
            }

            .print-footer {
                display: block !important;
                text-align: center;
                margin-top: 24px;
                padding-top: 16px;
                border-top: 1px solid #ddd;
                font-size: 0.75rem;
            }
        }

        .print-header,
        .print-footer {
            display: none;
        }

        /* ========== SHARE PORTFOLIO ========== */
        .share-modal .modal {
            max-width: 500px;
        }

        .share-link-container {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .share-link-input {
            flex: 1;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            font-family: monospace;
            font-size: 0.875rem;
            color: var(--text-primary);
        }

        .share-options {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 20px;
        }

        .share-option-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 16px 24px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.15s;
            color: var(--text-primary);
        }

        .share-option-btn:hover {
            border-color: var(--primary);
        }

        .share-option-btn svg {
            width: 24px;
            height: 24px;
        }

        /* ========== PWA INSTALL PROMPT ========== */
        .pwa-install-prompt {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 16px;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .pwa-install-prompt.show {
            opacity: 1;
            visibility: visible;
        }

        .pwa-install-icon {
            width: 48px;
            height: 48px;
            background: var(--primary);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .pwa-install-text {
            flex: 1;
        }

        .pwa-install-title {
            font-weight: 600;
            margin-bottom: 2px;
        }

        .pwa-install-desc {
            font-size: 0.8125rem;
            color: var(--text-muted);
        }

        .pwa-install-close {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 4px;
        }

        /* ========== PORTFOLIO COMPARISON ========== */
        .comparison-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }

        .comparison-panel {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            padding: 24px;
            border: 1px solid var(--border);
        }

        .comparison-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }

        .comparison-panel-title {
            font-weight: 600;
            font-size: 1rem;
        }

        .comparison-select {
            padding: 8px 12px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            background: var(--bg-secondary);
            font-size: 0.875rem;
            min-width: 200px;
        }

        .comparison-metrics {
            display: grid;
            gap: 16px;
        }

        .comparison-metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px dashed var(--border);
        }

        .comparison-metric:last-child {
            border-bottom: none;
        }

        .comparison-metric-label {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .comparison-metric-value {
            font-weight: 600;
            font-size: 1rem;
        }

        .comparison-diff {
            text-align: center;
            padding: 24px;
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            margin-top: 24px;
        }

        .comparison-diff-title {
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text-secondary);
        }

        .comparison-diff-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
        }

        .diff-item {
            text-align: center;
        }

        .diff-value {
            font-size: 1.25rem;
            font-weight: 700;
        }

        .diff-value.positive { color: var(--success); }
        .diff-value.negative { color: var(--danger); }

        .diff-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 4px;
        }

        /* ========== PERFORMANCE CHART ========== */
        .performance-chart-container {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            padding: 24px;
            margin-bottom: 24px;
        }

        .performance-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .performance-title {
            font-weight: 600;
            font-size: 1.125rem;
        }

        .performance-period-tabs {
            display: flex;
            gap: 8px;
        }

        .period-tab {
            padding: 6px 12px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            background: var(--bg-secondary);
            font-size: 0.8125rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .period-tab:hover {
            border-color: var(--primary);
        }

        .period-tab.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .performance-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }

        .perf-stat {
            text-align: center;
        }

        .perf-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .perf-stat-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 4px;
        }

        /* ========== NEWS FEED ========== */
        .news-feed {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            padding: 24px;
        }

        .news-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .news-title {
            font-weight: 600;
            font-size: 1.125rem;
        }

        .news-filter {
            display: flex;
            gap: 8px;
        }

        .news-filter-btn {
            padding: 4px 10px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            background: var(--bg-secondary);
            font-size: 0.75rem;
            cursor: pointer;
        }

        .news-filter-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .news-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
            max-height: 500px;
            overflow-y: auto;
        }

        .news-item {
            display: flex;
            gap: 16px;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.2s;
        }

        .news-item:hover {
            transform: translateX(4px);
            box-shadow: var(--shadow-sm);
        }

        .news-thumbnail {
            width: 80px;
            height: 60px;
            border-radius: var(--radius-sm);
            background: var(--bg-tertiary);
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            font-size: 1.5rem;
        }

        .news-content {
            flex: 1;
            min-width: 0;
        }

        .news-item-title {
            font-weight: 500;
            font-size: 0.9375rem;
            margin-bottom: 4px;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .news-meta {
            display: flex;
            gap: 12px;
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .news-source {
            font-weight: 500;
            color: var(--primary);
        }

        .news-ticker {
            background: var(--bg-tertiary);
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 500;
        }

        /* ========== WATCHLIST ========== */
        .watchlist-container {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            padding: 24px;
        }

        .watchlist-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .watchlist-title {
            font-weight: 600;
            font-size: 1.125rem;
        }

        .watchlist-add {
            display: flex;
            gap: 8px;
        }

        .watchlist-input {
            padding: 8px 12px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            font-size: 0.875rem;
            width: 120px;
            text-transform: uppercase;
        }

        .watchlist-table {
            width: 100%;
            border-collapse: collapse;
        }

        .watchlist-table th {
            text-align: left;
            padding: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--border);
        }

        .watchlist-table td {
            padding: 12px;
            border-bottom: 1px solid var(--border);
        }

        .watchlist-table tr:last-child td {
            border-bottom: none;
        }

        .watchlist-symbol {
            font-weight: 600;
            color: var(--primary);
        }

        .watchlist-change {
            font-weight: 500;
        }

        .watchlist-change.up { color: var(--success); }
        .watchlist-change.down { color: var(--danger); }

        .watchlist-sparkline {
            width: 80px;
            height: 30px;
        }

        .watchlist-actions {
            display: flex;
            gap: 8px;
        }

        .watchlist-action-btn {
            padding: 4px 8px;
            border-radius: 4px;
            border: none;
            background: var(--bg-secondary);
            cursor: pointer;
            font-size: 0.75rem;
        }

        .watchlist-action-btn:hover {
            background: var(--bg-tertiary);
        }

        .watchlist-action-btn.add-portfolio {
            background: var(--primary);
            color: white;
        }

        /* ========== GOAL TRACKING ========== */
        .goals-container {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            padding: 24px;
        }

        .goals-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .goals-title {
            font-weight: 600;
            font-size: 1.125rem;
        }

        .goals-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .goal-card {
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            padding: 20px;
        }

        .goal-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .goal-info {
            flex: 1;
        }

        .goal-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .goal-target {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .goal-target-value {
            font-weight: 600;
            color: var(--primary);
        }

        .goal-eta {
            text-align: right;
        }

        .goal-eta-label {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .goal-eta-value {
            font-weight: 600;
            color: var(--text-primary);
        }

        .goal-progress {
            margin-bottom: 12px;
        }

        .goal-progress-bar {
            height: 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            overflow: hidden;
        }

        .goal-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--primary-light));
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .goal-progress-text {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 0.8125rem;
        }

        .goal-current {
            font-weight: 600;
        }

        .goal-remaining {
            color: var(--text-muted);
        }

        .goal-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px dashed var(--border);
        }

        .goal-action-btn {
            padding: 6px 12px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            background: var(--bg-primary);
            font-size: 0.8125rem;
            cursor: pointer;
        }

        .goal-action-btn:hover {
            border-color: var(--primary);
        }

        /* Add Goal Modal */
        .goal-form-group {
            margin-bottom: 16px;
        }

        .goal-form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 6px;
        }

        .goal-type-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .goal-type-option {
            padding: 16px;
            border: 2px solid var(--border);
            border-radius: var(--radius-md);
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }

        .goal-type-option:hover {
            border-color: var(--primary-light);
        }

        .goal-type-option.selected {
            border-color: var(--primary);
            background: rgba(99, 91, 255, 0.05);
        }

        .goal-type-icon {
            font-size: 1.5rem;
            margin-bottom: 8px;
        }

        .goal-type-name {
            font-weight: 500;
            font-size: 0.875rem;
        }

        /* ========== ADVANCED RISK METRICS ========== */
        .risk-metrics-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .risk-metric-card {
            background: var(--bg-primary);
            border-radius: var(--radius-md);
            padding: 20px;
            text-align: center;
            border: 1px solid var(--border);
        }

        .risk-metric-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .risk-metric-value.good { color: var(--success); }
        .risk-metric-value.moderate { color: var(--warning); }
        .risk-metric-value.poor { color: var(--danger); }

        .risk-metric-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .risk-metric-desc {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .risk-gauge {
            position: relative;
            width: 120px;
            height: 60px;
            margin: 0 auto 12px;
        }

        .risk-gauge-bg {
            position: absolute;
            width: 120px;
            height: 60px;
            border-radius: 60px 60px 0 0;
            background: linear-gradient(90deg, var(--success) 0%, var(--warning) 50%, var(--danger) 100%);
            overflow: hidden;
        }

        .risk-gauge-mask {
            position: absolute;
            bottom: 0;
            left: 10px;
            right: 10px;
            height: 50px;
            background: var(--bg-primary);
            border-radius: 50px 50px 0 0;
        }

        .risk-gauge-needle {
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 4px;
            height: 50px;
            background: var(--text-primary);
            transform-origin: bottom center;
            border-radius: 2px;
            transition: transform 0.5s ease;
        }

        /* ========== CORRELATION MATRIX ========== */
        .correlation-matrix {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            padding: 24px;
            overflow-x: auto;
        }

        .correlation-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8125rem;
        }

        .correlation-table th,
        .correlation-table td {
            padding: 8px 12px;
            text-align: center;
            min-width: 60px;
        }

        .correlation-table th {
            font-weight: 600;
            background: var(--bg-secondary);
        }

        .correlation-cell {
            border-radius: 4px;
            font-weight: 500;
        }

        .correlation-cell[data-value="high-positive"] { background: rgba(48, 209, 88, 0.3); }
        .correlation-cell[data-value="medium-positive"] { background: rgba(48, 209, 88, 0.15); }
        .correlation-cell[data-value="low"] { background: var(--bg-secondary); }
        .correlation-cell[data-value="medium-negative"] { background: rgba(255, 69, 58, 0.15); }
        .correlation-cell[data-value="high-negative"] { background: rgba(255, 69, 58, 0.3); }

        /* ========== EARNINGS CALENDAR ========== */
        .earnings-calendar {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            padding: 24px;
        }

        .earnings-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .earnings-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
        }

        .earnings-date {
            text-align: center;
            min-width: 60px;
        }

        .earnings-day {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .earnings-month {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .earnings-info {
            flex: 1;
        }

        .earnings-symbol {
            font-weight: 600;
            margin-bottom: 2px;
        }

        .earnings-name {
            font-size: 0.8125rem;
            color: var(--text-secondary);
        }

        .earnings-estimates {
            text-align: right;
        }

        .earnings-eps-label {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .earnings-eps-value {
            font-weight: 600;
        }

        .earnings-time {
            font-size: 0.75rem;
            color: var(--text-muted);
            padding: 4px 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
        }

        @media (max-width: 768px) {
            .comparison-container {
                grid-template-columns: 1fr;
            }

            .comparison-diff-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .performance-stats {
                grid-template-columns: repeat(2, 1fr);
            }

            .risk-metrics-grid {
                grid-template-columns: 1fr;
            }

            .goal-type-options {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Skip to main content link for accessibility -->
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <!-- Connection Status Indicator -->
    <div class="connection-status" id="connectionStatus" aria-live="polite">
        <span class="connection-dot"></span>
        <span id="connectionText">Online</span>
    </div>

    <!-- Session Timeout Warning -->
    <div class="session-warning" id="sessionWarning" role="alert">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <polyline points="12 6 12 12 16 14"/>
        </svg>
        <span>Your session will expire in <strong id="sessionTimeLeft">5:00</strong></span>
        <button class="btn btn-secondary" onclick="refreshSession()" style="padding: 6px 12px; font-size: 0.8125rem;">
            Extend Session
        </button>
    </div>

    <div class="container">
        <header>
            <nav class="top-nav">
                <div class="logo">
                    <div class="logo-icon">
                        <!-- Paul Rand-inspired logo: Bold geometric "S" with scan line -->
                        <svg viewBox="0 0 44 44" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <!-- Abstract S formed by two offset squares with negative space -->
                            <rect x="0" y="0" width="24" height="24" rx="4" fill="white"/>
                            <rect x="20" y="20" width="24" height="24" rx="4" fill="white"/>
                            <!-- Scan line cutting through - the key action element -->
                            <rect x="0" y="19" width="44" height="6" fill="white" opacity="0.4"/>
                            <!-- Central diamond connector -->
                            <rect x="16" y="16" width="12" height="12" rx="2" fill="white" transform="rotate(0 22 22)"/>
                        </svg>
                    </div>
                    <div class="brand-text">
                        <span class="brand-name">Statement Scan</span>
                        <span class="brand-tagline">Portfolio Intelligence</span>
                    </div>
                </div>
                <div style="display: flex; align-items: center; gap: 12px;">
                    <!-- Theme Toggle -->
                    <button class="theme-toggle" id="themeToggle" onclick="toggleTheme()" aria-label="Toggle dark mode" title="Toggle theme (Ctrl+D)">
                        <svg class="sun-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="5"/>
                            <line x1="12" y1="1" x2="12" y2="3"/>
                            <line x1="12" y1="21" x2="12" y2="23"/>
                            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
                            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
                            <line x1="1" y1="12" x2="3" y2="12"/>
                            <line x1="21" y1="12" x2="23" y2="12"/>
                            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
                            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
                        </svg>
                        <svg class="moon-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </button>
                    <div id="authSection">
                        <button class="btn btn-secondary" id="loginBtn" onclick="showAuthModal()">
                            Sign In
                        </button>
                    </div>
                </div>
            </nav>
            <p class="subtitle">Upload your brokerage statements and get instant portfolio analytics, benchmarking, and projections.</p>
        </header>

        <main id="main-content">
        <!-- Error message container is now replaced by toast system -->
        <div class="error-message" id="errorMessage" role="alert" aria-live="polite"></div>

        <!-- Upload Section -->
        <div id="uploadSection">
            <!-- Entry Method Selector -->
            <div class="entry-methods">
                <button class="entry-method-btn active" data-method="upload" onclick="switchEntryMethod('upload')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="17 8 12 3 7 8"/>
                        <line x1="12" y1="3" x2="12" y2="15"/>
                    </svg>
                    Upload Files
                </button>
                <button class="entry-method-btn" data-method="manual" onclick="switchEntryMethod('manual')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                    </svg>
                    Enter Manually
                </button>
                <button class="entry-method-btn" data-method="connect" onclick="switchEntryMethod('connect')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="2" y="4" width="20" height="16" rx="2"/>
                        <path d="M7 15h0M2 9h20"/>
                    </svg>
                    Connect Account
                </button>
            </div>

            <!-- Upload Panel -->
            <div class="entry-panel active" id="uploadPanel">
                <div class="card upload-card" id="dropZone">
                    <div class="upload-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="17 8 12 3 7 8"/>
                            <line x1="12" y1="3" x2="12" y2="15"/>
                        </svg>
                    </div>
                    <div class="upload-title">Upload brokerage statements</div>
                    <p class="upload-hint">Drag and drop multiple PDF or CSV files at once, or click to browse</p>
                    <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()" aria-label="Select files to upload">
                        Select Files
                        <span class="kbd" style="margin-left: 8px;">Ctrl+U</span>
                    </button>
                    <input type="file" id="fileInput" accept=".pdf,.csv" multiple aria-label="File input for brokerage statements">

                    <!-- Upload Queue (shown during batch upload) -->
                    <div class="upload-queue" id="uploadQueue" style="display: none;">
                        <div class="upload-queue-header">
                            <span id="uploadQueueTitle">Uploading files...</span>
                            <span id="uploadQueueCount"></span>
                        </div>
                        <div id="uploadQueueList"></div>
                    </div>
                </div>
            </div>

            <!-- Manual Entry Panel -->
            <div class="entry-panel" id="manualPanel">
                <div class="card manual-entry-card">
                    <div class="upload-title" style="text-align: center; margin-bottom: 8px;">Enter your holdings</div>
                    <p class="upload-hint" style="text-align: center; margin-bottom: 24px;">Add each position with its symbol, shares, and price per share</p>

                    <div class="manual-entry-form">
                        <div class="form-group" style="flex: 1.5;">
                            <label>Symbol</label>
                            <input type="text" id="manualSymbol" placeholder="e.g., AAPL" onkeypress="if(event.key==='Enter') addManualHolding()">
                        </div>
                        <div class="form-group">
                            <label>Shares</label>
                            <input type="number" id="manualShares" placeholder="100" step="any" onkeypress="if(event.key==='Enter') addManualHolding()">
                        </div>
                        <div class="form-group">
                            <label>Price</label>
                            <input type="number" id="manualPrice" placeholder="150.00" step="0.01" onkeypress="if(event.key==='Enter') addManualHolding()">
                        </div>
                        <button class="btn btn-primary btn-add" onclick="addManualHolding()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="5" x2="12" y2="19"/>
                                <line x1="5" y1="12" x2="19" y2="12"/>
                            </svg>
                            Add
                        </button>
                    </div>

                    <div class="holdings-list" id="manualHoldingsList">
                        <div class="holdings-list-header">
                            <span>Symbol</span>
                            <span>Shares</span>
                            <span>Price</span>
                            <span>Value</span>
                            <span></span>
                        </div>
                        <div class="holdings-list-empty" id="holdingsEmpty">
                            No holdings added yet. Enter a symbol above to get started.
                        </div>
                    </div>

                    <div class="manual-entry-actions">
                        <div class="manual-total">
                            Total: <strong id="manualTotal">$0.00</strong>
                        </div>
                        <div style="display: flex; gap: 12px;">
                            <button class="btn btn-secondary" onclick="clearManualHoldings()" aria-label="Clear all holdings">Clear All</button>
                            <button class="btn btn-primary" id="analyzeManualBtn" onclick="analyzeManualHoldings()" disabled aria-label="Analyze portfolio">
                                Analyze Portfolio
                                <span class="kbd" style="margin-left: 8px;">Ctrl+Enter</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Connect Account Panel -->
            <div class="entry-panel" id="connectPanel">
                <div class="card upload-card">
                    <div class="upload-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="2" y="4" width="20" height="16" rx="2"/>
                            <path d="M7 15h0M2 9h20"/>
                        </svg>
                    </div>
                    <div class="upload-title">Connect your brokerage</div>
                    <p class="upload-hint">Securely link your account to automatically import holdings</p>
                    <button class="btn btn-primary" onclick="connectPlaidAccount()">
                        Connect with Plaid
                    </button>
                </div>
            </div>

            <div class="accounts-section" id="accountsSection" style="display: none;">
                <div class="accounts-header">
                    <h3>Uploaded Accounts</h3>
                    <button class="btn btn-secondary" id="addMoreBtn">Add More</button>
                </div>
                <div id="accountsList"></div>
                <div class="actions-row">
                    <button class="btn btn-primary" id="analyzeBtn" disabled aria-label="Analyze portfolio">
                        Analyze Portfolio
                        <span class="kbd" style="margin-left: 8px;">Ctrl+Enter</span>
                    </button>
                    <button class="btn btn-secondary" id="clearAllBtn" aria-label="Clear all accounts">Clear All</button>
                </div>
            </div>

            <!-- Plaid Integration Section -->
            <div class="plaid-section" id="plaidSection" style="display: none;">
                <div class="plaid-header">
                    <h3>
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="2" y="4" width="20" height="16" rx="2"/>
                            <path d="M7 15h0M2 9h20"/>
                        </svg>
                        Connected Accounts
                    </h3>
                    <button class="btn btn-primary" onclick="connectPlaidAccount()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <line x1="12" y1="8" x2="12" y2="16"/>
                            <line x1="8" y1="12" x2="16" y2="12"/>
                        </svg>
                        Connect Account
                    </button>
                </div>
                <div class="plaid-connections" id="plaidConnections">
                    <!-- Populated dynamically -->
                </div>
            </div>
        </div>

        <!-- Progress -->
        <div class="progress-section" id="progressSection">
            <div class="spinner"></div>
            <p class="progress-text" id="progressText">Analyzing your portfolio...</p>
        </div>

        <!-- Dashboard -->
        <div class="dashboard" id="dashboard">
            <div class="dashboard-header">
                <div class="dashboard-title">
                    <div class="dashboard-logo">
                        <svg viewBox="0 0 44 44" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <rect x="0" y="0" width="24" height="24" rx="4" fill="white"/>
                            <rect x="20" y="20" width="24" height="24" rx="4" fill="white"/>
                            <rect x="0" y="19" width="44" height="6" fill="white" opacity="0.4"/>
                            <rect x="16" y="16" width="12" height="12" rx="2" fill="white"/>
                        </svg>
                    </div>
                    <h2>Portfolio Analysis</h2>
                    <span class="total-badge" id="totalBadge">$0</span>
                </div>
                <div class="header-actions">
                    <button class="btn btn-secondary" id="newAnalysisBtn" aria-label="Start new analysis" title="New Analysis (Ctrl+N)">
                        New Analysis
                        <span class="kbd" style="margin-left: 8px;">Ctrl+N</span>
                    </button>
                    <button class="btn btn-success" id="savePortfolioBtn" style="display: none;" aria-label="Save portfolio">Save Portfolio</button>
                    <button class="btn btn-secondary" id="sharePortfolioBtn" onclick="showShareModal()">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/>
                            <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/>
                            <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
                        </svg>
                        Share
                    </button>
                    <button class="btn btn-secondary" id="exportMenuBtn" onclick="showExportModal()">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="7 10 12 15 17 10"/>
                            <line x1="12" y1="15" x2="12" y2="3"/>
                        </svg>
                        Export
                    </button>
                    <button class="btn btn-secondary" id="printBtn" onclick="window.print()">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="6 9 6 2 18 2 18 9"/>
                            <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/>
                            <rect x="6" y="14" width="12" height="8"/>
                        </svg>
                        Print
                    </button>
                </div>
            </div>

            <div class="tabs">
                <button class="tab active" data-tab="allocation">Allocation</button>
                <button class="tab" data-tab="insights">Insights</button>
                <button class="tab" data-tab="performance">Performance</button>
                <button class="tab" data-tab="dividends">Dividends</button>
                <button class="tab" data-tab="sectors">Sectors</button>
                <button class="tab" data-tab="geography">Geography</button>
                <button class="tab" data-tab="risk">Risk</button>
                <button class="tab" data-tab="tax">Tax Lots</button>
                <button class="tab" data-tab="holdings">Holdings</button>
                <button class="tab" data-tab="alerts">Alerts</button>
                <button class="tab" data-tab="whatif">What-If</button>
                <button class="tab" data-tab="compare">Compare</button>
                <button class="tab" data-tab="watchlist">Watchlist</button>
                <button class="tab" data-tab="goals">Goals</button>
                <button class="tab" data-tab="news">News</button>
                <button class="tab" data-tab="earnings">Earnings</button>
            </div>

            <!-- Allocation Tab -->
            <div class="tab-content active" id="tab-allocation">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Stocks</div>
                        <div class="stat-value" id="stocksPct">0%</div>
                        <div class="stat-subtitle" id="stocksVal">$0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Bonds</div>
                        <div class="stat-value" id="bondsPct">0%</div>
                        <div class="stat-subtitle" id="bondsVal">$0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Cash</div>
                        <div class="stat-value" id="cashPct">0%</div>
                        <div class="stat-subtitle" id="cashVal">$0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Alternatives</div>
                        <div class="stat-value" id="altsPct">0%</div>
                        <div class="stat-subtitle" id="altsVal">$0</div>
                    </div>
                </div>
                <div class="charts-row">
                    <div class="card chart-card">
                        <div class="card-title">Asset Allocation</div>
                        <div class="chart-wrapper">
                            <canvas id="allocationChart"></canvas>
                        </div>
                    </div>
                    <div class="card chart-card">
                        <div class="card-title">Sub-Asset Breakdown</div>
                        <div class="chart-wrapper">
                            <canvas id="subClassChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Insights Tab -->
            <div class="tab-content" id="tab-insights">
                <div class="insights-container" id="insightsContainer">
                    <div class="insights-header">
                        <h3>Portfolio Insights</h3>
                        <p class="insights-subtitle">AI-powered analysis of your portfolio</p>
                    </div>
                    <div class="insights-list" id="insightsList">
                        <!-- Insights will be rendered here -->
                    </div>
                </div>
            </div>

            <!-- Performance Tab -->
            <div class="tab-content" id="tab-performance">
                <div class="returns-grid" id="returnsGrid"></div>
                <div class="card chart-card">
                    <div class="card-header">
                        <div class="card-title">Historical Performance</div>
                        <div class="period-selector" id="periodSelector">
                            <button class="period-btn" data-period="1M">1M</button>
                            <button class="period-btn" data-period="3M">3M</button>
                            <button class="period-btn" data-period="6M">6M</button>
                            <button class="period-btn" data-period="YTD">YTD</button>
                            <button class="period-btn" data-period="1Y">1Y</button>
                            <button class="period-btn" data-period="3Y">3Y</button>
                            <button class="period-btn active" data-period="5Y">5Y</button>
                        </div>
                    </div>
                    <div style="display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap;">
                        <label class="benchmark-toggle">
                            <input type="checkbox" checked onchange="toggleBenchmark('sp500', this.checked)">
                            <span class="benchmark-label-box" style="background: #8898aa;"></span>
                            S&P 500
                        </label>
                        <label class="benchmark-toggle">
                            <input type="checkbox" onchange="toggleBenchmark('bonds', this.checked)">
                            <span class="benchmark-label-box" style="background: #30d158;"></span>
                            US Bonds
                        </label>
                        <label class="benchmark-toggle">
                            <input type="checkbox" onchange="toggleBenchmark('world', this.checked)">
                            <span class="benchmark-label-box" style="background: #ff9f0a;"></span>
                            Total World
                        </label>
                        <label class="benchmark-toggle">
                            <input type="checkbox" onchange="toggleBenchmark('sixty_forty', this.checked)">
                            <span class="benchmark-label-box" style="background: #bf5af2;"></span>
                            60/40 Portfolio
                        </label>
                    </div>
                    <div class="chart-wrapper" style="height: 380px;">
                        <canvas id="performanceChart"></canvas>
                    </div>
                    <div class="performance-stats">
                        <div class="perf-stat">
                            <div class="perf-stat-value positive" id="perfReturn">+0.00%</div>
                            <div class="perf-stat-label">Period Return</div>
                        </div>
                        <div class="perf-stat">
                            <div class="perf-stat-value" id="perfVsBenchmark">+0.00%</div>
                            <div class="perf-stat-label">vs S&P 500</div>
                        </div>
                        <div class="perf-stat">
                            <div class="perf-stat-value" id="perfHigh">$0</div>
                            <div class="perf-stat-label">Period High</div>
                        </div>
                        <div class="perf-stat">
                            <div class="perf-stat-value" id="perfLow">$0</div>
                            <div class="perf-stat-label">Period Low</div>
                        </div>
                    </div>
                </div>

                <!-- Projections Section -->
                <div class="card chart-card" style="margin-top: 24px;">
                    <div class="card-header">
                        <div class="card-title">10-Year Projections (Monte Carlo Simulation)</div>
                    </div>
                    <div id="projectionsInfo" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-bottom: 20px;"></div>
                    <div class="chart-wrapper" style="height: 350px;">
                        <canvas id="projectionsChart"></canvas>
                    </div>
                    <div id="monteCarloSummary" style="margin-top: 20px;"></div>
                </div>
            </div>

            <!-- Dividends Tab -->
            <div class="tab-content" id="tab-dividends">
                <div class="stats-grid" style="margin-bottom: 24px;">
                    <div class="stat-card dividend-card">
                        <div class="stat-label">Annual Dividend Income</div>
                        <div class="stat-value" id="annualDividend">$0</div>
                        <div class="stat-subtitle" id="dividendYield">0% yield</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Monthly Average</div>
                        <div class="stat-value" id="monthlyDividend">$0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Next Payment</div>
                        <div class="stat-value" id="nextDividend">--</div>
                        <div class="stat-subtitle" id="nextDividendDate">No upcoming</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Dividend Growth</div>
                        <div class="stat-value positive" id="dividendGrowth">--</div>
                        <div class="stat-subtitle">5-year CAGR</div>
                    </div>
                </div>

                <div class="card" style="margin-bottom: 24px;">
                    <div class="card-header">
                        <div class="card-title">Monthly Dividend Calendar</div>
                    </div>
                    <div class="dividend-calendar" id="dividendCalendar">
                        <!-- Populated dynamically -->
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Dividend-Paying Holdings</div>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Symbol</th>
                                    <th>Name</th>
                                    <th class="text-right">Yield</th>
                                    <th class="text-right">Annual Div/Share</th>
                                    <th class="text-right">Your Annual Income</th>
                                    <th>Frequency</th>
                                </tr>
                            </thead>
                            <tbody id="dividendHoldings">
                                <!-- Populated dynamically -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="card chart-card" style="margin-top: 24px;">
                    <div class="card-title">10-Year Dividend Projection</div>
                    <div class="chart-wrapper">
                        <canvas id="dividendProjectionChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Sectors Tab -->
            <div class="tab-content" id="tab-sectors">
                <div class="card" style="margin-bottom: 24px;">
                    <div class="card-header">
                        <div class="card-title">Sector Exposure vs S&P 500 Benchmark</div>
                        <div style="display: flex; gap: 16px; font-size: 0.8125rem;">
                            <span><span style="display: inline-block; width: 12px; height: 12px; background: var(--primary); border-radius: 2px; margin-right: 6px;"></span>Portfolio</span>
                            <span><span style="display: inline-block; width: 12px; height: 12px; background: var(--bg-tertiary); border-radius: 2px; margin-right: 6px;"></span>S&P 500</span>
                        </div>
                    </div>
                    <div class="sector-list" id="sectorList"></div>
                </div>
                <div class="card chart-card">
                    <div class="card-title">Sector Distribution</div>
                    <div class="chart-wrapper">
                        <canvas id="sectorChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Geography Tab -->
            <div class="tab-content" id="tab-geography">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">United States</div>
                        <div class="stat-value" id="usPct">0%</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Developed Markets</div>
                        <div class="stat-value" id="devPct">0%</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Emerging Markets</div>
                        <div class="stat-value" id="emPct">0%</div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-title">Geographic Allocation</div>
                    <div class="map-container">
                        <div id="worldMapContainer"></div>
                        <div class="map-legend">
                            <div class="legend-item"><div class="legend-dot us"></div><span>United States <strong id="usMapPct">0%</strong></span></div>
                            <div class="legend-item"><div class="legend-dot developed"></div><span>Developed <strong id="devMapPct">0%</strong></span></div>
                            <div class="legend-item"><div class="legend-dot emerging"></div><span>Emerging <strong id="emMapPct">0%</strong></span></div>
                        </div>
                    </div>
                </div>
                <div class="card chart-card" style="margin-top: 24px;">
                    <div class="card-title">Regional Breakdown</div>
                    <div class="chart-wrapper">
                        <canvas id="geoChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Risk Tab -->
            <div class="tab-content" id="tab-risk">
                <div class="risk-grid">
                    <div class="card risk-card">
                        <div class="risk-value" id="volatilityVal">--</div>
                        <div class="risk-label">Volatility</div>
                        <div class="risk-desc">Annualized standard deviation</div>
                    </div>
                    <div class="card risk-card">
                        <div class="risk-value" id="betaVal">--</div>
                        <div class="risk-label">Beta</div>
                        <div class="risk-desc">Sensitivity to market</div>
                    </div>
                    <div class="card risk-card">
                        <div class="risk-value" id="sharpeVal">--</div>
                        <div class="risk-label">Sharpe Ratio</div>
                        <div class="risk-desc">Risk-adjusted return</div>
                    </div>
                    <div class="card risk-card">
                        <div class="risk-value negative" id="maxDdVal">--</div>
                        <div class="risk-label">Max Drawdown</div>
                        <div class="risk-desc">Largest peak-to-trough</div>
                    </div>
                </div>

                <div class="card" style="margin-bottom: 24px;">
                    <div class="card-header">
                        <div class="card-title">Concentration Risk</div>
                    </div>
                    <div class="stats-grid" style="margin-bottom: 20px;">
                        <div class="stat-card">
                            <div class="stat-label">Top 10 Holdings</div>
                            <div class="stat-value" id="top10Pct">0%</div>
                            <div class="stat-subtitle">of total portfolio</div>
                        </div>
                    </div>
                    <div class="holdings-list" id="topHoldingsList"></div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Scenario Analysis</div>
                    </div>
                    <p style="color: var(--text-muted); font-size: 0.875rem; margin-bottom: 20px;">
                        Estimated portfolio impact under various market conditions
                    </p>
                    <div class="scenarios-container" id="scenariosList"></div>
                </div>
            </div>

            <!-- Tax Lots Tab -->
            <div class="tab-content" id="tab-tax">
                <div class="tax-summary">
                    <div class="tax-summary-card">
                        <div class="tax-summary-label">Total Cost Basis</div>
                        <div class="tax-summary-value" id="totalCostBasis">$0</div>
                    </div>
                    <div class="tax-summary-card">
                        <div class="tax-summary-label">Unrealized Gains</div>
                        <div class="tax-summary-value tax-lot-gain" id="unrealizedGains">$0</div>
                    </div>
                    <div class="tax-summary-card">
                        <div class="tax-summary-label">Unrealized Losses</div>
                        <div class="tax-summary-value tax-lot-loss" id="unrealizedLosses">$0</div>
                    </div>
                    <div class="tax-summary-card">
                        <div class="tax-summary-label">Net Unrealized</div>
                        <div class="tax-summary-value" id="netUnrealized">$0</div>
                    </div>
                </div>

                <div class="card" style="margin-bottom: 24px;">
                    <div class="card-header">
                        <div class="card-title">Tax Loss Harvesting Opportunities</div>
                    </div>
                    <p style="color: var(--text-muted); font-size: 0.875rem; margin-bottom: 16px;">
                        Positions with unrealized losses that could offset gains
                    </p>
                    <div id="taxLossOpportunities">
                        <!-- Populated dynamically -->
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">All Tax Lots</div>
                    </div>
                    <div class="table-container">
                        <table class="tax-lot-table">
                            <thead>
                                <tr>
                                    <th>Symbol</th>
                                    <th>Acquired</th>
                                    <th>Term</th>
                                    <th class="text-right">Shares</th>
                                    <th class="text-right">Cost Basis</th>
                                    <th class="text-right">Current Value</th>
                                    <th class="text-right">Gain/Loss</th>
                                    <th class="text-right">%</th>
                                </tr>
                            </thead>
                            <tbody id="taxLotsBody">
                                <!-- Populated dynamically -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Alerts Tab -->
            <div class="tab-content" id="tab-alerts">
                <div class="card" style="margin-bottom: 24px;">
                    <div class="card-header">
                        <div class="card-title">Active Alerts</div>
                        <button class="btn btn-primary" onclick="showAddAlertModal()">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <line x1="12" y1="8" x2="12" y2="16"/>
                                <line x1="8" y1="12" x2="16" y2="12"/>
                            </svg>
                            Add Alert
                        </button>
                    </div>
                    <div class="alerts-list" id="alertsList">
                        <div class="empty-state-enhanced" id="alertsEmptyState">
                            <div class="empty-state-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                                    <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
                                </svg>
                            </div>
                            <div class="empty-state-title">No alerts set</div>
                            <div class="empty-state-desc">Create price alerts to get notified when your holdings reach target prices.</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Suggested Alerts</div>
                    </div>
                    <p style="color: var(--text-muted); font-size: 0.875rem; margin-bottom: 16px;">
                        Based on your portfolio, consider setting these alerts
                    </p>
                    <div class="alerts-list" id="suggestedAlerts">
                        <!-- Populated dynamically -->
                    </div>
                </div>

                <div class="card" style="margin-top: 24px;">
                    <div class="card-header">
                        <div class="card-title">Portfolio Snapshots</div>
                        <button class="btn btn-secondary" onclick="saveSnapshot()">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
                                <circle cx="12" cy="13" r="4"/>
                            </svg>
                            Save Snapshot
                        </button>
                    </div>
                    <p style="color: var(--text-muted); font-size: 0.875rem; margin-bottom: 16px;">
                        Track your portfolio value over time
                    </p>
                    <div class="snapshot-timeline" id="snapshotTimeline">
                        <div class="empty-state" style="padding: 24px;">
                            <p>No snapshots yet. Save your first snapshot to start tracking.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Holdings Tab -->
            <div class="tab-content" id="tab-holdings">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Symbol</th>
                                <th>Description</th>
                                <th>Asset Class</th>
                                <th>Sector</th>
                                <th class="text-right">Shares</th>
                                <th class="text-right">Price</th>
                                <th class="text-right">Value</th>
                                <th class="text-right">Weight</th>
                            </tr>
                        </thead>
                        <tbody id="holdingsBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- What-If Tab -->
            <div class="tab-content" id="tab-whatif">
                <div class="whatif-container">
                    <div class="whatif-editor">
                        <div class="whatif-section-title">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                            </svg>
                            Edit Positions
                        </div>

                        <div class="whatif-position-list" id="whatifPositionList">
                            <!-- Populated dynamically -->
                        </div>

                        <div class="whatif-section-title" style="margin-top: 24px;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <line x1="12" y1="8" x2="12" y2="16"/>
                                <line x1="8" y1="12" x2="16" y2="12"/>
                            </svg>
                            Add Position
                        </div>

                        <div class="whatif-add-form">
                            <input type="text" id="whatifAddSymbol" placeholder="Symbol" style="text-transform: uppercase;">
                            <input type="number" id="whatifAddShares" placeholder="Shares" min="0" step="0.0001">
                            <input type="number" id="whatifAddPrice" placeholder="Price" min="0" step="0.01">
                            <button class="btn btn-primary" onclick="addWhatIfPosition()">Add</button>
                        </div>

                        <div class="whatif-section-title" style="margin-top: 24px;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0z"/>
                                <path d="M9 12h6"/>
                            </svg>
                            Rebalance to Target
                        </div>

                        <div class="rebalance-targets">
                            <div class="rebalance-target">
                                <label>Stocks %</label>
                                <input type="number" id="rebalanceStocks" placeholder="60" min="0" max="100">
                            </div>
                            <div class="rebalance-target">
                                <label>Bonds %</label>
                                <input type="number" id="rebalanceBonds" placeholder="30" min="0" max="100">
                            </div>
                            <div class="rebalance-target">
                                <label>Cash %</label>
                                <input type="number" id="rebalanceCash" placeholder="10" min="0" max="100">
                            </div>
                        </div>
                        <button class="btn btn-secondary" onclick="applyRebalance()">Apply Rebalance</button>
                    </div>

                    <div class="whatif-preview">
                        <div class="whatif-preview-header">
                            <div class="whatif-preview-title">Preview</div>
                            <div class="whatif-preview-value" id="whatifPreviewValue">$0</div>
                        </div>

                        <div class="whatif-impact-grid" id="whatifImpactGrid">
                            <div class="whatif-impact-card">
                                <div class="whatif-impact-value" id="whatifValueChange">--</div>
                                <div class="whatif-impact-label">Value Change</div>
                            </div>
                            <div class="whatif-impact-card">
                                <div class="whatif-impact-value" id="whatifCost">--</div>
                                <div class="whatif-impact-label">Est. Trade Cost</div>
                            </div>
                            <div class="whatif-impact-card">
                                <div class="whatif-impact-value" id="whatifVolChange">--</div>
                                <div class="whatif-impact-label">Volatility Change</div>
                            </div>
                            <div class="whatif-impact-card">
                                <div class="whatif-impact-value" id="whatifBetaChange">--</div>
                                <div class="whatif-impact-label">Beta Change</div>
                            </div>
                        </div>

                        <div class="whatif-chart-wrapper">
                            <canvas id="whatifChart"></canvas>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 16px;">
                            <div>
                                <div class="stat-label">Original Allocation</div>
                                <div id="whatifOriginalAlloc" style="font-size: 0.875rem; color: var(--text-secondary);"></div>
                            </div>
                            <div>
                                <div class="stat-label">Modified Allocation</div>
                                <div id="whatifModifiedAlloc" style="font-size: 0.875rem; color: var(--text-secondary);"></div>
                            </div>
                        </div>

                        <div class="whatif-actions">
                            <button class="btn btn-secondary" onclick="resetWhatIf()">Reset Changes</button>
                            <button class="btn btn-primary" onclick="runWhatIfAnalysis()">Run Analysis</button>
                            <button class="btn btn-success" onclick="saveWhatIfAsNew()" style="display: none;" id="saveWhatIfBtn">Save as New</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Compare Tab -->
            <div class="tab-content" id="tab-compare">
                <div class="compare-selectors">
                    <div class="compare-select-group">
                        <label class="compare-select-label">Portfolio A</label>
                        <select class="compare-select" id="compareSelectA">
                            <option value="current">Current Analysis</option>
                        </select>
                    </div>
                    <div class="compare-vs">VS</div>
                    <div class="compare-select-group">
                        <label class="compare-select-label">Portfolio B</label>
                        <select class="compare-select" id="compareSelectB">
                            <option value="">Select a portfolio...</option>
                        </select>
                    </div>
                </div>

                <button class="btn btn-primary compare-btn" onclick="runComparison()" id="runCompareBtn">
                    Compare Portfolios
                </button>

                <div id="comparisonResults" style="display: none;">
                    <div class="compare-container" style="margin-top: 32px;">
                        <div class="compare-column">
                            <div class="compare-column-header">
                                <div class="compare-column-title" id="compareNameA">Portfolio A</div>
                                <div class="compare-column-value" id="compareValueA">$0</div>
                            </div>
                            <div class="compare-chart-wrapper">
                                <canvas id="compareChartA"></canvas>
                            </div>
                            <div class="compare-stats" id="compareStatsA"></div>
                        </div>

                        <div class="compare-column">
                            <div class="compare-column-header">
                                <div class="compare-column-title" id="compareNameB">Portfolio B</div>
                                <div class="compare-column-value" id="compareValueB">$0</div>
                            </div>
                            <div class="compare-chart-wrapper">
                                <canvas id="compareChartB"></canvas>
                            </div>
                            <div class="compare-stats" id="compareStatsB"></div>
                        </div>
                    </div>

                    <div class="diff-summary">
                        <div class="diff-summary-title">Difference Summary (B - A)</div>
                        <div class="diff-grid" id="diffGrid"></div>
                    </div>
                </div>

                <div id="compareEmptyState" class="empty-state">
                    <svg class="empty-state-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <rect x="2" y="3" width="8" height="18" rx="1"/>
                        <rect x="14" y="3" width="8" height="18" rx="1"/>
                        <path d="M10 12h4"/>
                    </svg>
                    <p>Select two portfolios to compare</p>
                    <p style="font-size: 0.8125rem;">Save portfolios to unlock comparison features</p>
                </div>
            </div>

            <!-- Watchlist Tab -->
            <div class="tab-content" id="tab-watchlist">
                <div class="watchlist-container">
                    <div class="watchlist-header">
                        <h3 class="watchlist-title">Watchlist</h3>
                        <div class="watchlist-add">
                            <input type="text" class="watchlist-input" id="watchlistSymbol" placeholder="AAPL" maxlength="5">
                            <button class="btn btn-primary btn-sm" onclick="addToWatchlist()">Add</button>
                        </div>
                    </div>
                    <table class="watchlist-table" id="watchlistTable">
                        <thead>
                            <tr>
                                <th>Symbol</th>
                                <th>Price</th>
                                <th>Change</th>
                                <th>% Change</th>
                                <th>7D Trend</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="watchlistBody">
                        </tbody>
                    </table>
                    <div class="empty-state" id="watchlistEmptyState">
                        <svg class="empty-state-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M12 5v14M5 12h14"/>
                        </svg>
                        <p>Your watchlist is empty</p>
                        <p style="font-size: 0.8125rem;">Add stocks to track their performance</p>
                    </div>
                </div>
            </div>

            <!-- Goals Tab -->
            <div class="tab-content" id="tab-goals">
                <div class="goals-container">
                    <div class="goals-header">
                        <h3 class="goals-title">Investment Goals</h3>
                        <button class="btn btn-primary btn-sm" onclick="showAddGoalModal()">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 5v14M5 12h14"/>
                            </svg>
                            Add Goal
                        </button>
                    </div>
                    <div class="goals-list" id="goalsList">
                    </div>
                    <div class="empty-state" id="goalsEmptyState">
                        <svg class="empty-state-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <circle cx="12" cy="12" r="10"/>
                            <circle cx="12" cy="12" r="6"/>
                            <circle cx="12" cy="12" r="2"/>
                        </svg>
                        <p>No goals set</p>
                        <p style="font-size: 0.8125rem;">Set investment goals to track your progress</p>
                    </div>
                </div>
            </div>

            <!-- News Tab -->
            <div class="tab-content" id="tab-news">
                <div class="news-feed">
                    <div class="news-header">
                        <h3 class="news-title">Market News</h3>
                        <div class="news-filter">
                            <button class="news-filter-btn active" data-filter="all">All</button>
                            <button class="news-filter-btn" data-filter="portfolio">My Holdings</button>
                            <button class="news-filter-btn" data-filter="earnings">Earnings</button>
                            <button class="news-filter-btn" data-filter="analysis">Analysis</button>
                        </div>
                    </div>
                    <div class="news-list" id="newsList">
                        <div class="news-item" onclick="openNewsArticle('https://example.com')">
                            <div class="news-thumbnail"></div>
                            <div class="news-content">
                                <div class="news-item-title">Loading latest market news...</div>
                                <div class="news-meta">
                                    <span class="news-source">Market Watch</span>
                                    <span>Just now</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Earnings Tab -->
            <div class="tab-content" id="tab-earnings">
                <div class="earnings-calendar">
                    <div class="news-header">
                        <h3 class="news-title">Upcoming Earnings</h3>
                        <div class="news-filter">
                            <button class="news-filter-btn active" data-filter="upcoming">Upcoming</button>
                            <button class="news-filter-btn" data-filter="thisweek">This Week</button>
                            <button class="news-filter-btn" data-filter="portfolio">My Holdings</button>
                        </div>
                    </div>
                    <div class="earnings-list" id="earningsList">
                    </div>
                    <div class="empty-state" id="earningsEmptyState">
                        <svg class="empty-state-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <rect x="3" y="4" width="18" height="18" rx="2"/>
                            <path d="M16 2v4M8 2v4M3 10h18"/>
                        </svg>
                        <p>No upcoming earnings</p>
                        <p style="font-size: 0.8125rem;">Add holdings to see their earnings dates</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Saved Portfolios Section (visible when logged in) -->
        <div class="saved-portfolios" id="savedPortfoliosSection" style="display: none;">
            <div class="saved-portfolios-header">
                <h3>Saved Portfolios</h3>
                <button class="btn btn-secondary" onclick="loadSavedPortfolios()">Refresh</button>
            </div>
            <div class="portfolio-list" id="portfolioList">
                <!-- Empty state for portfolios -->
                <div class="empty-state-enhanced" id="portfolioEmptyState">
                    <div class="empty-state-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/>
                        </svg>
                    </div>
                    <div class="empty-state-title">No saved portfolios</div>
                    <div class="empty-state-desc">Analyze a portfolio and save it to track your investments over time.</div>
                    <div class="empty-state-actions">
                        <button class="btn btn-primary" onclick="switchEntryMethod('upload')">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                <polyline points="17 8 12 3 7 8"/>
                                <line x1="12" y1="3" x2="12" y2="15"/>
                            </svg>
                            Upload Statement
                        </button>
                    </div>
                </div>
            </div>
        </div>

        </main><!-- End main content -->

        <footer>
            <p>Supports Schwab, Fidelity, Vanguard, and most major brokerage statements</p>
        </footer>
    </div>

    <!-- Auth Modal -->
    <div class="modal-overlay" id="authModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Welcome</h2>
                <button class="modal-close" onclick="hideAuthModal()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="auth-tabs">
                    <button class="auth-tab active" data-tab="login" onclick="switchAuthTab('login')">Sign In</button>
                    <button class="auth-tab" data-tab="register" onclick="switchAuthTab('register')">Create Account</button>
                </div>

                <!-- Login Form -->
                <form class="auth-form active" id="loginForm" onsubmit="handleLogin(event)">
                    <div class="form-group">
                        <label class="form-label" for="loginEmail">Email</label>
                        <input type="email" class="form-input" id="loginEmail" placeholder="you@example.com" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="loginPassword">Password</label>
                        <input type="password" class="form-input" id="loginPassword" placeholder="Enter your password" required>
                    </div>
                    <div class="form-error" id="loginError" style="display: none;"></div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">Sign In</button>
                    <div class="forgot-password-link">
                        <a href="#" onclick="showForgotPassword(event)">Forgot your password?</a>
                    </div>
                </form>

                <!-- Forgot Password Form -->
                <form class="auth-form" id="forgotPasswordForm" onsubmit="handleForgotPassword(event)">
                    <p class="form-description">Enter your email address and we'll send you a link to reset your password.</p>
                    <div class="form-group">
                        <label class="form-label" for="forgotEmail">Email</label>
                        <input type="email" class="form-input" id="forgotEmail" placeholder="you@example.com" required>
                    </div>
                    <div class="form-error" id="forgotError" style="display: none;"></div>
                    <div class="form-success" id="forgotSuccess" style="display: none;"></div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">Send Reset Link</button>
                    <div class="back-to-login">
                        <a href="#" onclick="backToLogin(event)">Back to sign in</a>
                    </div>
                </form>

                <!-- Register Form -->
                <form class="auth-form" id="registerForm" onsubmit="handleRegister(event)">
                    <div class="form-group">
                        <label class="form-label" for="registerName">Name (optional)</label>
                        <input type="text" class="form-input" id="registerName" placeholder="Your name">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="registerEmail">Email</label>
                        <input type="email" class="form-input" id="registerEmail" placeholder="you@example.com" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="registerPassword">Password</label>
                        <input type="password" class="form-input" id="registerPassword" placeholder="At least 8 characters" minlength="8" required>
                    </div>
                    <div class="form-error" id="registerError" style="display: none;"></div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">Create Account</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Reset Password Modal -->
    <div class="modal-overlay" id="resetPasswordModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Reset Password</h2>
                <button class="modal-close" onclick="hideResetPasswordModal()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <form id="resetPasswordForm" onsubmit="handleResetPassword(event)">
                    <p class="form-description">Enter your new password below.</p>
                    <div class="form-group">
                        <label class="form-label" for="newPassword">New Password</label>
                        <input type="password" class="form-input" id="newPassword" placeholder="At least 6 characters" minlength="6" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="confirmPassword">Confirm Password</label>
                        <input type="password" class="form-input" id="confirmPassword" placeholder="Confirm your password" minlength="6" required>
                    </div>
                    <div class="form-error" id="resetError" style="display: none;"></div>
                    <div class="form-success" id="resetSuccess" style="display: none;"></div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">Reset Password</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Enhanced Toast Container -->
    <div class="toast-container" id="toastContainer" aria-live="polite" aria-atomic="true">
        <!-- Toasts will be dynamically added here -->
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <p id="loadingText">Loading...</p>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal" style="max-width: 480px;">
            <div class="modal-header">
                <h2 class="modal-title">Settings</h2>
                <button class="modal-close" onclick="hideSettingsModal()" aria-label="Close settings">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="settings-section">
                    <div class="settings-section-title">Appearance</div>
                    <div class="settings-option">
                        <div>
                            <div class="settings-option-label">Theme</div>
                            <div class="settings-option-desc">Choose your preferred color scheme</div>
                        </div>
                        <select class="settings-select" id="themeSelect" onchange="setTheme(this.value)">
                            <option value="system">System</option>
                            <option value="light">Light</option>
                            <option value="dark">Dark</option>
                        </select>
                    </div>
                </div>

                <div class="settings-section">
                    <div class="settings-section-title">Notifications</div>
                    <div class="settings-option">
                        <div>
                            <div class="settings-option-label">Toast Notifications</div>
                            <div class="settings-option-desc">Show popup notifications for actions</div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="toastEnabled" checked onchange="saveSettings()">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="settings-option">
                        <div>
                            <div class="settings-option-label">Sound Effects</div>
                            <div class="settings-option-desc">Play sounds for notifications</div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="soundEnabled" onchange="saveSettings()">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>

                <div class="settings-section">
                    <div class="settings-section-title">Data & Privacy</div>
                    <div class="settings-option">
                        <div>
                            <div class="settings-option-label">Default Export Format</div>
                            <div class="settings-option-desc">Preferred format for data exports</div>
                        </div>
                        <select class="settings-select" id="exportFormat" onchange="saveSettings()">
                            <option value="pdf">PDF</option>
                            <option value="csv">CSV</option>
                        </select>
                    </div>
                    <div class="settings-option">
                        <div>
                            <div class="settings-option-label">Remember Portfolios</div>
                            <div class="settings-option-desc">Keep portfolio data in browser</div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="rememberPortfolios" checked onchange="saveSettings()">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>

                <div class="settings-section" style="margin-bottom: 0;">
                    <div class="settings-section-title">Keyboard Shortcuts</div>
                    <button class="btn btn-secondary" onclick="showKeyboardShortcuts()" style="width: 100%;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="2" y="4" width="20" height="16" rx="2"/>
                            <path d="M6 8h.01M10 8h.01M14 8h.01M18 8h.01M8 12h8M6 16h.01M18 16h.01"/>
                        </svg>
                        View Keyboard Shortcuts
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Keyboard Shortcuts Modal -->
    <div class="modal-overlay" id="shortcutsModal">
        <div class="modal" style="max-width: 480px;">
            <div class="modal-header">
                <h2 class="modal-title">Keyboard Shortcuts</h2>
                <button class="modal-close" onclick="hideKeyboardShortcuts()" aria-label="Close shortcuts">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="shortcuts-grid">
                    <div class="shortcut-item">
                        <span class="shortcut-action">Upload files</span>
                        <div class="shortcut-keys">
                            <span class="kbd">Ctrl</span>
                            <span class="kbd">U</span>
                        </div>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-action">Analyze portfolio</span>
                        <div class="shortcut-keys">
                            <span class="kbd">Ctrl</span>
                            <span class="kbd">Enter</span>
                        </div>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-action">New analysis</span>
                        <div class="shortcut-keys">
                            <span class="kbd">Ctrl</span>
                            <span class="kbd">N</span>
                        </div>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-action">Toggle dark mode</span>
                        <div class="shortcut-keys">
                            <span class="kbd">Ctrl</span>
                            <span class="kbd">D</span>
                        </div>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-action">Open settings</span>
                        <div class="shortcut-keys">
                            <span class="kbd">Ctrl</span>
                            <span class="kbd">,</span>
                        </div>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-action">Close modal / Cancel</span>
                        <div class="shortcut-keys">
                            <span class="kbd">Esc</span>
                        </div>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-action">Show shortcuts</span>
                        <div class="shortcut-keys">
                            <span class="kbd">?</span>
                        </div>
                    </div>
                </div>
                <p style="margin-top: 16px; font-size: 0.8125rem; color: var(--text-muted);">
                    On Mac, use <span class="kbd">Cmd</span> instead of <span class="kbd">Ctrl</span>
                </p>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal-overlay confirm-modal" id="confirmModal">
        <div class="modal">
            <div class="modal-body" style="padding-top: 32px;">
                <div class="confirm-icon danger" id="confirmIcon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                        <line x1="12" y1="9" x2="12" y2="13"/>
                        <line x1="12" y1="17" x2="12.01" y2="17"/>
                    </svg>
                </div>
                <div class="confirm-text">
                    <div class="confirm-title" id="confirmTitle">Are you sure?</div>
                    <div class="confirm-desc" id="confirmDesc">This action cannot be undone.</div>
                </div>
                <div class="confirm-actions">
                    <button class="btn btn-secondary" onclick="hideConfirmModal()">Cancel</button>
                    <button class="btn btn-primary" id="confirmAction" style="background: var(--danger);">Delete</button>
                </div>
                <label class="confirm-checkbox" id="confirmCheckboxWrapper" style="display: none;">
                    <input type="checkbox" id="dontShowAgain">
                    <span>Don't show this again</span>
                </label>
            </div>
        </div>
    </div>

    <!-- Onboarding Modal -->
    <div class="onboarding-overlay" id="onboardingOverlay">
        <div class="onboarding-card">
            <div class="onboarding-image" id="onboardingImage">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="17 8 12 3 7 8"/>
                    <line x1="12" y1="3" x2="12" y2="15"/>
                </svg>
            </div>
            <div class="onboarding-content">
                <h2 class="onboarding-title" id="onboardingTitle">Welcome to Statement Scan</h2>
                <p class="onboarding-text" id="onboardingText">Upload your brokerage statements and get instant portfolio analytics, benchmarking, and AI-powered insights.</p>
                <div class="onboarding-steps">
                    <div class="onboarding-step active" data-step="0"></div>
                    <div class="onboarding-step" data-step="1"></div>
                    <div class="onboarding-step" data-step="2"></div>
                    <div class="onboarding-step" data-step="3"></div>
                </div>
                <div class="onboarding-actions">
                    <button class="onboarding-skip" onclick="skipOnboarding()">Skip</button>
                    <button class="btn btn-primary" id="onboardingNext" onclick="nextOnboardingStep()">Get Started</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div class="modal-overlay" id="exportModal">
        <div class="modal" style="max-width: 520px;">
            <div class="modal-header">
                <h2 class="modal-title">Export Portfolio</h2>
                <button class="modal-close" onclick="hideExportModal()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="export-options">
                    <div class="export-option" onclick="exportToPDF()">
                        <div class="export-option-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                <polyline points="14 2 14 8 20 8"/>
                            </svg>
                        </div>
                        <div class="export-option-label">PDF Report</div>
                        <div class="export-option-desc">Full analysis with charts</div>
                    </div>
                    <div class="export-option" onclick="exportToCSV()">
                        <div class="export-option-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2"/>
                                <line x1="9" y1="3" x2="9" y2="21"/>
                                <line x1="15" y1="3" x2="15" y2="21"/>
                                <line x1="3" y1="9" x2="21" y2="9"/>
                                <line x1="3" y1="15" x2="21" y2="15"/>
                            </svg>
                        </div>
                        <div class="export-option-label">CSV</div>
                        <div class="export-option-desc">Spreadsheet compatible</div>
                    </div>
                    <div class="export-option" onclick="exportToExcel()">
                        <div class="export-option-icon" style="color: #217346;">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                <polyline points="14 2 14 8 20 8"/>
                                <path d="M8 13h2l2 3 2-3h2"/>
                            </svg>
                        </div>
                        <div class="export-option-label">Excel</div>
                        <div class="export-option-desc">Multiple sheets</div>
                    </div>
                    <div class="export-option" onclick="exportToJSON()">
                        <div class="export-option-icon" style="color: #f7df1e;">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                <polyline points="14 2 14 8 20 8"/>
                                <path d="M10 12v4c0 1-1 2-2 2M14 12v4c0 1 1 2 2 2h-2"/>
                            </svg>
                        </div>
                        <div class="export-option-label">JSON</div>
                        <div class="export-option-desc">Raw data format</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Share Modal -->
    <div class="modal-overlay share-modal" id="shareModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Share Portfolio</h2>
                <button class="modal-close" onclick="hideShareModal()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <p style="color: var(--text-muted); margin-bottom: 16px;">Share a read-only view of your portfolio analysis</p>
                <div class="share-link-container">
                    <input type="text" class="share-link-input" id="shareLink" readonly value="Generating link...">
                    <button class="btn btn-primary" onclick="copyShareLink()">Copy</button>
                </div>
                <div class="settings-option" style="border: none; padding: 16px 0;">
                    <div>
                        <div class="settings-option-label">Hide specific values</div>
                        <div class="settings-option-desc">Show percentages only, hide dollar amounts</div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="shareHideValues" onchange="updateShareLink()">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="share-options">
                    <button class="share-option-btn" onclick="shareViaEmail()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                            <polyline points="22,6 12,13 2,6"/>
                        </svg>
                        Email
                    </button>
                    <button class="share-option-btn" onclick="shareViaTwitter()">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                        </svg>
                        Twitter
                    </button>
                    <button class="share-option-btn" onclick="shareViaLinkedIn()">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
                        </svg>
                        LinkedIn
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Alert Modal -->
    <div class="modal-overlay" id="addAlertModal">
        <div class="modal" style="max-width: 450px;">
            <div class="modal-header">
                <h2 class="modal-title">Create Price Alert</h2>
                <button class="modal-close" onclick="hideAddAlertModal()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <form id="addAlertForm" onsubmit="createAlert(event)">
                    <div class="form-group">
                        <label class="form-label">Symbol</label>
                        <select class="form-input" id="alertSymbol" required>
                            <option value="">Select a holding...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Condition</label>
                        <select class="form-input" id="alertCondition" required>
                            <option value="above">Price goes above</option>
                            <option value="below">Price goes below</option>
                            <option value="change_up">Increases by %</option>
                            <option value="change_down">Decreases by %</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Value</label>
                        <input type="number" class="form-input" id="alertValue" placeholder="Enter price or percentage" step="0.01" required>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">Create Alert</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Goal Modal -->
    <div class="modal-overlay" id="addGoalModal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title">Create Investment Goal</h2>
                <button class="modal-close" onclick="hideAddGoalModal()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <form id="addGoalForm" onsubmit="createGoal(event)">
                    <div class="goal-form-group">
                        <label class="goal-form-label">Goal Type</label>
                        <div class="goal-type-options" id="goalTypeOptions">
                            <div class="goal-type-option selected" data-type="target_value">
                                <div class="goal-type-icon"></div>
                                <div class="goal-type-name">Target Value</div>
                            </div>
                            <div class="goal-type-option" data-type="retirement">
                                <div class="goal-type-icon"></div>
                                <div class="goal-type-name">Retirement</div>
                            </div>
                            <div class="goal-type-option" data-type="emergency">
                                <div class="goal-type-icon"></div>
                                <div class="goal-type-name">Emergency Fund</div>
                            </div>
                            <div class="goal-type-option" data-type="custom">
                                <div class="goal-type-icon"></div>
                                <div class="goal-type-name">Custom Goal</div>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Goal Name</label>
                        <input type="text" class="form-input" id="goalName" placeholder="e.g., House Down Payment" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Target Amount</label>
                        <input type="number" class="form-input" id="goalTarget" placeholder="100000" step="1000" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Target Date</label>
                        <input type="date" class="form-input" id="goalDate" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Starting Amount (Optional)</label>
                        <input type="number" class="form-input" id="goalStarting" placeholder="0" step="100">
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">Create Goal</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Import Modal -->
    <div class="modal-overlay" id="importModal">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h2 class="modal-title">Import Portfolio</h2>
                <button class="modal-close" onclick="hideImportModal()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <p style="color: var(--text-muted); margin-bottom: 20px;">Download a template and fill in your holdings, then upload it here.</p>
                <div class="import-templates">
                    <div class="import-template" onclick="downloadTemplate('basic')">
                        <svg class="import-template-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <rect x="3" y="3" width="18" height="18" rx="2"/>
                            <line x1="9" y1="3" x2="9" y2="21"/>
                            <line x1="3" y1="9" x2="21" y2="9"/>
                        </svg>
                        <div class="import-template-name">Basic Template</div>
                        <div class="import-template-desc">Symbol, Shares, Price</div>
                    </div>
                    <div class="import-template" onclick="downloadTemplate('detailed')">
                        <svg class="import-template-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <rect x="3" y="3" width="18" height="18" rx="2"/>
                            <line x1="9" y1="3" x2="9" y2="21"/>
                            <line x1="15" y1="3" x2="15" y2="21"/>
                            <line x1="3" y1="9" x2="21" y2="9"/>
                            <line x1="3" y1="15" x2="21" y2="15"/>
                        </svg>
                        <div class="import-template-name">Detailed Template</div>
                        <div class="import-template-desc">With cost basis & dates</div>
                    </div>
                    <div class="import-template" onclick="downloadTemplate('schwab')">
                        <svg class="import-template-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                        </svg>
                        <div class="import-template-name">Schwab Format</div>
                        <div class="import-template-desc">Schwab export compatible</div>
                    </div>
                </div>
                <div style="margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--border);">
                    <div class="card upload-card" style="padding: 24px;">
                        <input type="file" id="importFileInput" accept=".csv,.xlsx" style="display: none;" onchange="handleImportFile(event)">
                        <button class="btn btn-primary" onclick="document.getElementById('importFileInput').click()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                <polyline points="17 8 12 3 7 8"/>
                                <line x1="12" y1="3" x2="12" y2="15"/>
                            </svg>
                            Upload Filled Template
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- PWA Install Prompt -->
    <div class="pwa-install-prompt" id="pwaInstallPrompt">
        <div class="pwa-install-icon">
            <svg width="24" height="24" viewBox="0 0 44 44" fill="none">
                <rect x="0" y="0" width="24" height="24" rx="4" fill="white"/>
                <rect x="20" y="20" width="24" height="24" rx="4" fill="white"/>
                <rect x="0" y="19" width="44" height="6" fill="white" opacity="0.4"/>
                <rect x="16" y="16" width="12" height="12" rx="2" fill="white"/>
            </svg>
        </div>
        <div class="pwa-install-text">
            <div class="pwa-install-title">Install Statement Scan</div>
            <div class="pwa-install-desc">Add to home screen for quick access</div>
        </div>
        <button class="btn btn-primary" onclick="installPWA()" style="padding: 8px 16px;">Install</button>
        <button class="pwa-install-close" onclick="dismissPWAPrompt()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
        </button>
    </div>

    <!-- Save Portfolio Modal -->
    <div class="modal-overlay save-modal" id="saveModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Save Portfolio</h2>
                <button class="modal-close" onclick="hideSaveModal()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <form id="saveForm" onsubmit="handleSavePortfolio(event)">
                    <div class="form-group">
                        <label class="form-label" for="portfolioName">Portfolio Name</label>
                        <input type="text" class="form-input" id="portfolioName" placeholder="e.g., Retirement Account" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="portfolioDescription">Description (optional)</label>
                        <input type="text" class="form-input" id="portfolioDescription" placeholder="Brief description">
                    </div>
                    <div class="form-error" id="saveError" style="display: none;"></div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">Save Portfolio</button>
                </form>
            </div>
        </div>

        <!-- Footer -->
        <footer class="site-footer">
            <div class="footer-links">
                <a href="/privacy.html">Privacy Policy</a>
                <a href="/data-retention-policy.html">Data Policy</a>
                <a href="mailto:pnewmann@gmail.com">Contact</a>
            </div>
            <div class="footer-copyright">
                &copy; 2025 Statement Scan. All rights reserved.
            </div>
        </footer>
    </div>

    <script>
        const API_URL = 'https://statement-scan-api.onrender.com';

        let accounts = [];
        let portfolioData = null;
        let charts = {};
        let currentUser = null;
        let authToken = localStorage.getItem('authToken');

        // =============================================================================
        // ENTERPRISE ENHANCEMENTS - SETTINGS & PREFERENCES
        // =============================================================================

        // Default settings
        const defaultSettings = {
            theme: 'system',
            toastEnabled: true,
            soundEnabled: false,
            exportFormat: 'pdf',
            rememberPortfolios: true,
            confirmDestructive: true
        };

        // Load settings from localStorage
        let appSettings = { ...defaultSettings, ...JSON.parse(localStorage.getItem('appSettings') || '{}') };

        function saveSettings() {
            appSettings.toastEnabled = document.getElementById('toastEnabled')?.checked ?? true;
            appSettings.soundEnabled = document.getElementById('soundEnabled')?.checked ?? false;
            appSettings.exportFormat = document.getElementById('exportFormat')?.value ?? 'pdf';
            appSettings.rememberPortfolios = document.getElementById('rememberPortfolios')?.checked ?? true;
            localStorage.setItem('appSettings', JSON.stringify(appSettings));
        }

        function loadSettings() {
            const toastEl = document.getElementById('toastEnabled');
            const soundEl = document.getElementById('soundEnabled');
            const formatEl = document.getElementById('exportFormat');
            const rememberEl = document.getElementById('rememberPortfolios');
            const themeEl = document.getElementById('themeSelect');

            if (toastEl) toastEl.checked = appSettings.toastEnabled;
            if (soundEl) soundEl.checked = appSettings.soundEnabled;
            if (formatEl) formatEl.value = appSettings.exportFormat;
            if (rememberEl) rememberEl.checked = appSettings.rememberPortfolios;
            if (themeEl) themeEl.value = appSettings.theme;
        }

        function showSettingsModal() {
            loadSettings();
            document.getElementById('settingsModal').classList.add('active');
            trapFocus(document.getElementById('settingsModal').querySelector('.modal'));
        }

        function hideSettingsModal() {
            document.getElementById('settingsModal').classList.remove('active');
        }

        // =============================================================================
        // DARK MODE / THEME MANAGEMENT
        // =============================================================================

        function initTheme() {
            const savedTheme = appSettings.theme || 'system';
            applyTheme(savedTheme);
        }

        function setTheme(theme) {
            appSettings.theme = theme;
            localStorage.setItem('appSettings', JSON.stringify(appSettings));
            applyTheme(theme);
        }

        function applyTheme(theme) {
            const root = document.documentElement;

            if (theme === 'system') {
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                root.setAttribute('data-theme', prefersDark ? 'dark' : 'light');
            } else {
                root.setAttribute('data-theme', theme);
            }
        }

        function toggleTheme() {
            const current = document.documentElement.getAttribute('data-theme');
            const newTheme = current === 'dark' ? 'light' : 'dark';
            setTheme(newTheme);
            const themeSelect = document.getElementById('themeSelect');
            if (themeSelect) themeSelect.value = newTheme;
            showToast(`Switched to ${newTheme} mode`, 'info');
        }

        // Listen for system theme changes
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
            if (appSettings.theme === 'system') {
                applyTheme('system');
            }
        });

        // =============================================================================
        // ENHANCED TOAST NOTIFICATION SYSTEM
        // =============================================================================

        const toastIcons = {
            success: `<svg class="toast-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>
            </svg>`,
            error: `<svg class="toast-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/>
            </svg>`,
            warning: `<svg class="toast-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                <line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>
            </svg>`,
            info: `<svg class="toast-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/>
            </svg>`
        };

        let toastQueue = [];
        let activeToasts = 0;
        const MAX_TOASTS = 5;

        function showToast(message, type = 'success', options = {}) {
            if (!appSettings.toastEnabled && type !== 'error') return;

            const {
                title = null,
                duration = 4000,
                dismissible = true,
                showProgress = true,
                action = null
            } = options;

            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.setAttribute('role', 'alert');

            let actionHtml = '';
            if (action) {
                actionHtml = `<button class="btn-undo" onclick="${action.handler}">${action.label}</button>`;
            }

            toast.innerHTML = `
                ${toastIcons[type] || toastIcons.info}
                <div class="toast-content">
                    ${title ? `<div class="toast-title">${title}</div>` : ''}
                    <div class="toast-message">${message}</div>
                </div>
                ${actionHtml}
                ${dismissible ? `<button class="toast-close" onclick="dismissToast(this.parentElement)" aria-label="Dismiss">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>` : ''}
                ${showProgress && duration > 0 ? `<div class="toast-progress" style="animation-duration: ${duration}ms;"></div>` : ''}
            `;

            // Limit number of toasts
            const existingToasts = container.querySelectorAll('.toast');
            if (existingToasts.length >= MAX_TOASTS) {
                dismissToast(existingToasts[0]);
            }

            container.appendChild(toast);

            // Trigger animation
            requestAnimationFrame(() => {
                toast.classList.add('show');
            });

            // Announce to screen readers
            announceToScreenReader(message);

            // Auto dismiss
            if (duration > 0) {
                setTimeout(() => {
                    dismissToast(toast);
                }, duration);
            }

            return toast;
        }

        function dismissToast(toast) {
            if (!toast || !toast.parentElement) return;
            toast.classList.remove('show');
            setTimeout(() => {
                toast.remove();
            }, 300);
        }

        // Undo toast helper
        function showUndoToast(message, undoCallback, duration = 5000) {
            const toast = showToast(message, 'info', {
                duration,
                action: {
                    label: 'Undo',
                    handler: `handleUndo()`
                }
            });

            window._pendingUndo = undoCallback;
            toast.classList.add('undo-toast');
            return toast;
        }

        function handleUndo() {
            if (window._pendingUndo) {
                window._pendingUndo();
                window._pendingUndo = null;
                showToast('Action undone', 'success');
            }
        }

        // =============================================================================
        // LOADING STATE MANAGEMENT
        // =============================================================================

        let loadingCount = 0;

        function showLoadingOverlay(text = 'Loading...') {
            loadingCount++;
            const overlay = document.getElementById('loadingOverlay');
            const loadingText = document.getElementById('loadingText');
            if (loadingText) loadingText.textContent = text;
            overlay.classList.add('active');
        }

        function hideLoadingOverlay() {
            loadingCount = Math.max(0, loadingCount - 1);
            if (loadingCount === 0) {
                document.getElementById('loadingOverlay').classList.remove('active');
            }
        }

        // Button loading state
        function setButtonLoading(button, loading, originalText = null) {
            if (loading) {
                button.dataset.originalText = button.textContent;
                button.classList.add('loading');
                button.disabled = true;
            } else {
                button.classList.remove('loading');
                button.disabled = false;
                if (button.dataset.originalText) {
                    button.textContent = button.dataset.originalText;
                }
            }
        }

        // Prevent double clicks
        function preventDoubleClick(button, duration = 1000) {
            button.disabled = true;
            setTimeout(() => {
                button.disabled = false;
            }, duration);
        }

        // =============================================================================
        // FORM VALIDATION
        // =============================================================================

        function validateInput(input, rules = {}) {
            const value = input.value.trim();
            const formGroup = input.closest('.form-group');
            let isValid = true;
            let errorMessage = '';

            // Clear previous state
            formGroup?.classList.remove('has-error', 'has-success');

            // Required check
            if (rules.required && !value) {
                isValid = false;
                errorMessage = rules.requiredMessage || 'This field is required';
            }

            // Min length
            if (isValid && rules.minLength && value.length < rules.minLength) {
                isValid = false;
                errorMessage = `Must be at least ${rules.minLength} characters`;
            }

            // Pattern check
            if (isValid && rules.pattern && !rules.pattern.test(value)) {
                isValid = false;
                errorMessage = rules.patternMessage || 'Invalid format';
            }

            // Custom validator
            if (isValid && rules.custom) {
                const customResult = rules.custom(value);
                if (customResult !== true) {
                    isValid = false;
                    errorMessage = customResult;
                }
            }

            // Update UI
            if (formGroup) {
                formGroup.classList.add(isValid ? 'has-success' : 'has-error');

                // Show/hide inline error
                let errorEl = formGroup.querySelector('.inline-error');
                if (!isValid) {
                    if (!errorEl) {
                        errorEl = document.createElement('div');
                        errorEl.className = 'inline-error';
                        formGroup.appendChild(errorEl);
                    }
                    errorEl.innerHTML = `<svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="10"/></svg> ${errorMessage}`;
                } else if (errorEl) {
                    errorEl.remove();
                }
            }

            return isValid;
        }

        // Symbol validation with auto-uppercase
        function setupSymbolInput(input) {
            input.addEventListener('input', (e) => {
                e.target.value = e.target.value.toUpperCase().replace(/[^A-Z0-9.]/g, '');
            });

            input.addEventListener('blur', (e) => {
                const value = e.target.value.trim();
                if (value) {
                    validateInput(input, {
                        pattern: /^[A-Z]{1,5}(\.[A-Z]{1,2})?$/,
                        patternMessage: 'Enter a valid stock symbol (e.g., AAPL, BRK.B)'
                    });
                }
            });
        }

        // Clear validation on focus
        function setupValidationClearOnFocus(input) {
            input.addEventListener('focus', () => {
                const formGroup = input.closest('.form-group');
                formGroup?.classList.remove('has-error', 'has-success');
                formGroup?.querySelector('.inline-error')?.remove();
            });
        }

        // Shake animation for invalid forms
        function shakeElement(element) {
            element.classList.add('has-error');
            element.style.animation = 'shake 0.5s ease';
            setTimeout(() => {
                element.style.animation = '';
            }, 500);
        }

        // =============================================================================
        // KEYBOARD SHORTCUTS
        // =============================================================================

        const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
        const modKey = isMac ? 'metaKey' : 'ctrlKey';

        function initKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // Ignore if typing in input/textarea
                if (e.target.matches('input, textarea, select')) {
                    // Allow Escape to blur
                    if (e.key === 'Escape') {
                        e.target.blur();
                    }
                    return;
                }

                // ? - Show keyboard shortcuts
                if (e.key === '?' && !e[modKey]) {
                    e.preventDefault();
                    showKeyboardShortcuts();
                    return;
                }

                // Escape - Close modals
                if (e.key === 'Escape') {
                    closeAllModals();
                    return;
                }

                // Ctrl/Cmd shortcuts
                if (e[modKey]) {
                    switch (e.key.toLowerCase()) {
                        case 'u':
                            e.preventDefault();
                            document.getElementById('fileInput')?.click();
                            break;
                        case 'enter':
                            e.preventDefault();
                            const analyzeBtn = document.getElementById('analyzeBtn');
                            const manualBtn = document.getElementById('analyzeManualBtn');
                            if (analyzeBtn && !analyzeBtn.disabled) {
                                analyzeBtn.click();
                            } else if (manualBtn && !manualBtn.disabled) {
                                manualBtn.click();
                            }
                            break;
                        case 'n':
                            e.preventDefault();
                            document.getElementById('newAnalysisBtn')?.click();
                            break;
                        case 'd':
                            e.preventDefault();
                            toggleTheme();
                            break;
                        case ',':
                            e.preventDefault();
                            showSettingsModal();
                            break;
                    }
                }
            });
        }

        function showKeyboardShortcuts() {
            document.getElementById('shortcutsModal').classList.add('active');
            trapFocus(document.getElementById('shortcutsModal').querySelector('.modal'));
        }

        function hideKeyboardShortcuts() {
            document.getElementById('shortcutsModal').classList.remove('active');
        }

        function closeAllModals() {
            document.querySelectorAll('.modal-overlay.active').forEach(modal => {
                modal.classList.remove('active');
            });
        }

        // =============================================================================
        // ACCESSIBILITY - FOCUS MANAGEMENT
        // =============================================================================

        function trapFocus(element) {
            const focusableElements = element.querySelectorAll(
                'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
            );
            const firstFocusable = focusableElements[0];
            const lastFocusable = focusableElements[focusableElements.length - 1];

            firstFocusable?.focus();

            element.addEventListener('keydown', (e) => {
                if (e.key === 'Tab') {
                    if (e.shiftKey) {
                        if (document.activeElement === firstFocusable) {
                            e.preventDefault();
                            lastFocusable?.focus();
                        }
                    } else {
                        if (document.activeElement === lastFocusable) {
                            e.preventDefault();
                            firstFocusable?.focus();
                        }
                    }
                }
            });
        }

        function announceToScreenReader(message) {
            const announcer = document.createElement('div');
            announcer.setAttribute('role', 'status');
            announcer.setAttribute('aria-live', 'polite');
            announcer.className = 'sr-only';
            announcer.textContent = message;
            document.body.appendChild(announcer);
            setTimeout(() => announcer.remove(), 1000);
        }

        // =============================================================================
        // CONNECTION STATUS MONITORING
        // =============================================================================

        let isOnline = navigator.onLine;

        function initConnectionMonitoring() {
            updateConnectionStatus();

            window.addEventListener('online', () => {
                isOnline = true;
                updateConnectionStatus();
                showToast('Connection restored', 'success');
            });

            window.addEventListener('offline', () => {
                isOnline = false;
                updateConnectionStatus();
                showToast('You are offline. Some features may be unavailable.', 'warning', {
                    duration: 0,
                    title: 'No Connection'
                });
            });
        }

        function updateConnectionStatus() {
            const statusEl = document.getElementById('connectionStatus');
            const textEl = document.getElementById('connectionText');

            if (isOnline) {
                statusEl.classList.remove('offline');
                textEl.textContent = 'Online';
            } else {
                statusEl.classList.add('offline');
                textEl.textContent = 'Offline';
            }
        }

        // =============================================================================
        // SESSION MANAGEMENT
        // =============================================================================

        let sessionTimeout = null;
        let sessionWarningTimeout = null;
        const SESSION_DURATION = 30 * 60 * 1000; // 30 minutes
        const WARNING_BEFORE = 5 * 60 * 1000; // 5 minutes before expiry

        function startSessionTimer() {
            if (!authToken) return;

            clearTimeout(sessionTimeout);
            clearTimeout(sessionWarningTimeout);

            // Show warning 5 minutes before expiry
            sessionWarningTimeout = setTimeout(() => {
                showSessionWarning();
            }, SESSION_DURATION - WARNING_BEFORE);

            // Session expires
            sessionTimeout = setTimeout(() => {
                handleSessionExpired();
            }, SESSION_DURATION);
        }

        function showSessionWarning() {
            const warningEl = document.getElementById('sessionWarning');
            const timeEl = document.getElementById('sessionTimeLeft');

            warningEl.classList.add('show');

            let timeLeft = WARNING_BEFORE / 1000;
            const interval = setInterval(() => {
                timeLeft--;
                const mins = Math.floor(timeLeft / 60);
                const secs = timeLeft % 60;
                timeEl.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;

                if (timeLeft <= 0) {
                    clearInterval(interval);
                }
            }, 1000);
        }

        function hideSessionWarning() {
            document.getElementById('sessionWarning').classList.remove('show');
        }

        function refreshSession() {
            hideSessionWarning();
            startSessionTimer();
            showToast('Session extended', 'success');
        }

        function handleSessionExpired() {
            hideSessionWarning();
            logout();
            showToast('Your session has expired. Please sign in again.', 'warning', {
                title: 'Session Expired',
                duration: 0
            });
        }

        // =============================================================================
        // CONFIRMATION MODAL SYSTEM
        // =============================================================================

        let pendingConfirmCallback = null;

        function showConfirmModal(options = {}) {
            const {
                title = 'Are you sure?',
                message = 'This action cannot be undone.',
                confirmText = 'Confirm',
                confirmClass = 'btn-primary',
                icon = 'danger',
                showDontAsk = false,
                onConfirm = () => {}
            } = options;

            const modal = document.getElementById('confirmModal');
            const titleEl = document.getElementById('confirmTitle');
            const descEl = document.getElementById('confirmDesc');
            const actionBtn = document.getElementById('confirmAction');
            const iconEl = document.getElementById('confirmIcon');
            const checkboxWrapper = document.getElementById('confirmCheckboxWrapper');

            titleEl.textContent = title;
            descEl.textContent = message;
            actionBtn.textContent = confirmText;
            actionBtn.className = `btn ${confirmClass}`;

            iconEl.className = `confirm-icon ${icon}`;
            checkboxWrapper.style.display = showDontAsk ? 'flex' : 'none';

            pendingConfirmCallback = onConfirm;
            actionBtn.onclick = handleConfirm;

            modal.classList.add('active');
            trapFocus(modal.querySelector('.modal'));
        }

        function hideConfirmModal() {
            document.getElementById('confirmModal').classList.remove('active');
            pendingConfirmCallback = null;
        }

        function handleConfirm() {
            const dontAsk = document.getElementById('dontShowAgain')?.checked;
            if (pendingConfirmCallback) {
                pendingConfirmCallback(dontAsk);
            }
            hideConfirmModal();
        }

        // Helper for destructive actions
        function confirmDestructive(message, onConfirm) {
            showConfirmModal({
                title: 'Delete Item?',
                message,
                confirmText: 'Delete',
                confirmClass: 'btn-primary',
                icon: 'danger',
                onConfirm
            });
        }

        // =============================================================================
        // INITIALIZATION
        // =============================================================================

        function initEnterpriseFeatures() {
            // Initialize theme
            initTheme();

            // Initialize keyboard shortcuts
            initKeyboardShortcuts();

            // Initialize connection monitoring
            initConnectionMonitoring();

            // Setup form validation for manual entry
            const symbolInput = document.getElementById('manualSymbol');
            if (symbolInput) {
                setupSymbolInput(symbolInput);
                setupValidationClearOnFocus(symbolInput);
            }

            const whatifSymbol = document.getElementById('whatifAddSymbol');
            if (whatifSymbol) {
                setupSymbolInput(whatifSymbol);
            }

            // Start session timer if logged in
            if (authToken) {
                startSessionTimer();
            }

            // Load settings
            loadSettings();

            console.log('Enterprise features initialized');
        }

        // Run initialization when DOM is ready
        document.addEventListener('DOMContentLoaded', initEnterpriseFeatures);

        // =============================================================================
        // ONBOARDING TUTORIAL
        // =============================================================================

        const onboardingSteps = [
            {
                title: 'Welcome to Statement Scan',
                text: 'Upload your brokerage statements and get instant portfolio analytics, benchmarking, and AI-powered insights.',
                icon: 'upload'
            },
            {
                title: 'Multiple Ways to Add Data',
                text: 'Upload PDF/CSV files, enter holdings manually, or connect your brokerage account directly with Plaid.',
                icon: 'options'
            },
            {
                title: 'Comprehensive Analysis',
                text: 'Get detailed breakdowns of your allocation, sector exposure, geographic diversification, and risk metrics.',
                icon: 'chart'
            },
            {
                title: 'Track & Compare',
                text: 'Save portfolios, set price alerts, compare different allocations, and run what-if scenarios.',
                icon: 'compare'
            }
        ];

        let currentOnboardingStep = 0;

        function showOnboarding() {
            if (localStorage.getItem('onboardingComplete')) return;
            document.getElementById('onboardingOverlay').classList.add('active');
            updateOnboardingStep();
        }

        function updateOnboardingStep() {
            const step = onboardingSteps[currentOnboardingStep];
            document.getElementById('onboardingTitle').textContent = step.title;
            document.getElementById('onboardingText').textContent = step.text;

            // Update step indicators
            document.querySelectorAll('.onboarding-step').forEach((el, i) => {
                el.classList.toggle('active', i === currentOnboardingStep);
            });

            // Update button text
            const nextBtn = document.getElementById('onboardingNext');
            nextBtn.textContent = currentOnboardingStep === onboardingSteps.length - 1 ? 'Get Started' : 'Next';
        }

        function nextOnboardingStep() {
            if (currentOnboardingStep < onboardingSteps.length - 1) {
                currentOnboardingStep++;
                updateOnboardingStep();
            } else {
                skipOnboarding();
            }
        }

        function skipOnboarding() {
            localStorage.setItem('onboardingComplete', 'true');
            document.getElementById('onboardingOverlay').classList.remove('active');
        }

        // Show onboarding for new users
        setTimeout(() => {
            if (!localStorage.getItem('onboardingComplete') && !localStorage.getItem('authToken')) {
                showOnboarding();
            }
        }, 1000);

        // =============================================================================
        // DRAG AND DROP FOR HOLDINGS
        // =============================================================================

        let draggedItem = null;

        function initDragAndDrop() {
            const holdingsList = document.getElementById('manualHoldingsList');
            if (!holdingsList) return;

            holdingsList.addEventListener('dragstart', handleDragStart);
            holdingsList.addEventListener('dragend', handleDragEnd);
            holdingsList.addEventListener('dragover', handleDragOver);
            holdingsList.addEventListener('drop', handleDrop);
        }

        function handleDragStart(e) {
            if (!e.target.classList.contains('holdings-list-item')) return;
            draggedItem = e.target;
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragEnd(e) {
            if (draggedItem) {
                draggedItem.classList.remove('dragging');
                draggedItem = null;
            }
            document.querySelectorAll('.drop-indicator').forEach(el => el.classList.remove('active'));
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        }

        function handleDrop(e) {
            e.preventDefault();
            if (!draggedItem) return;

            const target = e.target.closest('.holdings-list-item');
            if (target && target !== draggedItem) {
                const items = [...document.querySelectorAll('.holdings-list-item')];
                const draggedIndex = items.indexOf(draggedItem);
                const targetIndex = items.indexOf(target);

                // Reorder the manualHoldings array
                const [removed] = manualHoldings.splice(draggedIndex, 1);
                manualHoldings.splice(targetIndex, 0, removed);

                renderManualHoldings();
            }
        }

        // =============================================================================
        // QUICK ACTIONS & RECENT PORTFOLIOS
        // =============================================================================

        function getRecentPortfolios() {
            return JSON.parse(localStorage.getItem('recentPortfolios') || '[]');
        }

        function addToRecentPortfolios(portfolio) {
            let recent = getRecentPortfolios();
            // Remove if already exists
            recent = recent.filter(p => p.id !== portfolio.id);
            // Add to front
            recent.unshift({
                id: portfolio.id,
                name: portfolio.name,
                value: portfolio.total_value,
                date: new Date().toISOString()
            });
            // Keep only last 5
            recent = recent.slice(0, 5);
            localStorage.setItem('recentPortfolios', JSON.stringify(recent));
        }

        function clearRecentPortfolios() {
            localStorage.removeItem('recentPortfolios');
            renderRecentPortfolios();
        }

        function renderRecentPortfolios() {
            const container = document.getElementById('recentPortfoliosContainer');
            if (!container) return;

            const recent = getRecentPortfolios();
            if (recent.length === 0) {
                container.style.display = 'none';
                return;
            }

            container.style.display = 'block';
            const list = container.querySelector('.recent-list');
            list.innerHTML = recent.map(p => `
                <div class="recent-item" onclick="loadPortfolio(${p.id})">
                    <div class="recent-item-icon">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                        </svg>
                    </div>
                    <div class="recent-item-info">
                        <div class="recent-item-name">${escapeHtml(p.name)}</div>
                        <div class="recent-item-meta">${formatCurrency(p.value)}</div>
                    </div>
                </div>
            `).join('');
        }

        // =============================================================================
        // DIVIDEND TRACKING
        // =============================================================================

        function renderDividendTab() {
            if (!portfolioData || !portfolioData.positions) return;

            const positions = portfolioData.positions;
            let totalAnnualDividend = 0;
            const dividendHoldings = [];
            const monthlyDividends = Array(12).fill(0);

            // Calculate dividends (simulated - in production would use real dividend data)
            positions.forEach(p => {
                // Estimate dividend yield based on sector (simplified)
                let estimatedYield = 0;
                if (p.asset_class === 'Equity') {
                    if (p.sector === 'Utilities') estimatedYield = 0.035;
                    else if (p.sector === 'Real Estate') estimatedYield = 0.04;
                    else if (p.sector === 'Consumer Staples') estimatedYield = 0.025;
                    else if (p.sector === 'Financial Services') estimatedYield = 0.03;
                    else if (p.sector === 'Energy') estimatedYield = 0.035;
                    else estimatedYield = 0.015;
                } else if (p.asset_class === 'Fixed Income') {
                    estimatedYield = 0.045;
                }

                if (estimatedYield > 0) {
                    const annualDiv = p.value * estimatedYield;
                    totalAnnualDividend += annualDiv;
                    dividendHoldings.push({
                        symbol: p.symbol,
                        name: p.description || p.symbol,
                        yield: estimatedYield,
                        annualPerShare: (p.price * estimatedYield).toFixed(2),
                        annualIncome: annualDiv,
                        frequency: 'Quarterly'
                    });

                    // Distribute to months (quarterly)
                    [2, 5, 8, 11].forEach(month => {
                        monthlyDividends[month] += annualDiv / 4;
                    });
                }
            });

            // Update summary stats
            document.getElementById('annualDividend').textContent = formatCurrency(totalAnnualDividend);
            document.getElementById('dividendYield').textContent = ((totalAnnualDividend / portfolioData.total_value) * 100).toFixed(2) + '% yield';
            document.getElementById('monthlyDividend').textContent = formatCurrency(totalAnnualDividend / 12);

            // Render calendar
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const currentMonth = new Date().getMonth();
            document.getElementById('dividendCalendar').innerHTML = months.map((month, i) => `
                <div class="dividend-month ${i === currentMonth ? 'current' : ''}">
                    <div class="dividend-month-name">${month}</div>
                    <div class="dividend-month-amount">${formatCurrency(monthlyDividends[i])}</div>
                </div>
            `).join('');

            // Render holdings table
            document.getElementById('dividendHoldings').innerHTML = dividendHoldings
                .sort((a, b) => b.annualIncome - a.annualIncome)
                .map(h => `
                    <tr>
                        <td class="symbol-cell">${h.symbol}</td>
                        <td>${h.name}</td>
                        <td class="text-right">${(h.yield * 100).toFixed(2)}%</td>
                        <td class="text-right">$${h.annualPerShare}</td>
                        <td class="text-right font-mono">${formatCurrency(h.annualIncome)}</td>
                        <td>${h.frequency}</td>
                    </tr>
                `).join('') || '<tr><td colspan="6" class="text-center">No dividend-paying holdings</td></tr>';
        }

        // =============================================================================
        // TAX LOT TRACKING
        // =============================================================================

        function renderTaxTab() {
            if (!portfolioData || !portfolioData.positions) return;

            const positions = portfolioData.positions;
            let totalCostBasis = 0;
            let unrealizedGains = 0;
            let unrealizedLosses = 0;
            const taxLots = [];

            positions.forEach(p => {
                // Simulate cost basis (random purchase date and price variation)
                const purchaseDate = new Date();
                purchaseDate.setMonth(purchaseDate.getMonth() - Math.floor(Math.random() * 36));
                const costBasisPerShare = p.price * (0.7 + Math.random() * 0.6); // 30% from current
                const costBasis = costBasisPerShare * p.shares;
                const gainLoss = p.value - costBasis;

                totalCostBasis += costBasis;
                if (gainLoss > 0) unrealizedGains += gainLoss;
                else unrealizedLosses += Math.abs(gainLoss);

                const isLongTerm = (new Date() - purchaseDate) > (365 * 24 * 60 * 60 * 1000);

                taxLots.push({
                    symbol: p.symbol,
                    acquired: purchaseDate.toLocaleDateString('en-US', { month: 'short', year: 'numeric' }),
                    term: isLongTerm ? 'Long' : 'Short',
                    shares: p.shares,
                    costBasis: costBasis,
                    currentValue: p.value,
                    gainLoss: gainLoss,
                    gainLossPct: ((gainLoss / costBasis) * 100)
                });
            });

            document.getElementById('totalCostBasis').textContent = formatCurrency(totalCostBasis);
            document.getElementById('unrealizedGains').textContent = '+' + formatCurrency(unrealizedGains);
            document.getElementById('unrealizedLosses').textContent = '-' + formatCurrency(unrealizedLosses);

            const netUnrealized = unrealizedGains - unrealizedLosses;
            const netEl = document.getElementById('netUnrealized');
            netEl.textContent = (netUnrealized >= 0 ? '+' : '') + formatCurrency(netUnrealized);
            netEl.className = 'tax-summary-value ' + (netUnrealized >= 0 ? 'tax-lot-gain' : 'tax-lot-loss');

            // Tax loss harvesting opportunities
            const lossOpportunities = taxLots.filter(t => t.gainLoss < 0).sort((a, b) => a.gainLoss - b.gainLoss);
            document.getElementById('taxLossOpportunities').innerHTML = lossOpportunities.length > 0 ?
                lossOpportunities.slice(0, 5).map(t => `
                    <div class="rebalance-trade-item">
                        <span class="rebalance-trade-action sell">Loss</span>
                        <span class="rebalance-trade-symbol">${t.symbol}</span>
                        <span style="flex: 1;">${t.shares.toFixed(2)} shares</span>
                        <span class="tax-lot-loss">${formatCurrency(t.gainLoss)}</span>
                    </div>
                `).join('') :
                '<p style="color: var(--text-muted);">No tax loss harvesting opportunities found.</p>';

            // All tax lots table
            document.getElementById('taxLotsBody').innerHTML = taxLots.map(t => `
                <tr>
                    <td class="symbol-cell">${t.symbol}</td>
                    <td>${t.acquired}</td>
                    <td><span class="badge ${t.term === 'Long' ? 'badge-primary' : 'badge-secondary'}">${t.term}</span></td>
                    <td class="text-right font-mono">${t.shares.toFixed(4)}</td>
                    <td class="text-right font-mono">${formatCurrency(t.costBasis)}</td>
                    <td class="text-right font-mono">${formatCurrency(t.currentValue)}</td>
                    <td class="text-right font-mono ${t.gainLoss >= 0 ? 'tax-lot-gain' : 'tax-lot-loss'}">
                        ${t.gainLoss >= 0 ? '+' : ''}${formatCurrency(t.gainLoss)}
                    </td>
                    <td class="text-right font-mono ${t.gainLoss >= 0 ? 'tax-lot-gain' : 'tax-lot-loss'}">
                        ${t.gainLossPct >= 0 ? '+' : ''}${t.gainLossPct.toFixed(1)}%
                    </td>
                </tr>
            `).join('');
        }

        // =============================================================================
        // PORTFOLIO ALERTS
        // =============================================================================

        let portfolioAlerts = JSON.parse(localStorage.getItem('portfolioAlerts') || '[]');

        function showAddAlertModal() {
            const select = document.getElementById('alertSymbol');
            if (portfolioData && portfolioData.positions) {
                select.innerHTML = '<option value="">Select a holding...</option>' +
                    portfolioData.positions.map(p => `<option value="${p.symbol}">${p.symbol} - ${formatCurrency(p.price)}</option>`).join('');
            }
            document.getElementById('addAlertModal').classList.add('active');
        }

        function hideAddAlertModal() {
            document.getElementById('addAlertModal').classList.remove('active');
        }

        function createAlert(event) {
            event.preventDefault();
            const symbol = document.getElementById('alertSymbol').value;
            const condition = document.getElementById('alertCondition').value;
            const value = parseFloat(document.getElementById('alertValue').value);

            if (!symbol || !condition || isNaN(value)) return;

            const position = portfolioData.positions.find(p => p.symbol === symbol);
            const alert = {
                id: Date.now(),
                symbol,
                condition,
                value,
                currentPrice: position?.price || 0,
                created: new Date().toISOString(),
                enabled: true
            };

            portfolioAlerts.push(alert);
            localStorage.setItem('portfolioAlerts', JSON.stringify(portfolioAlerts));

            hideAddAlertModal();
            renderAlerts();
            showToast(`Alert created for ${symbol}`, 'success');
        }

        function deleteAlert(alertId) {
            portfolioAlerts = portfolioAlerts.filter(a => a.id !== alertId);
            localStorage.setItem('portfolioAlerts', JSON.stringify(portfolioAlerts));
            renderAlerts();
        }

        function toggleAlert(alertId) {
            const alert = portfolioAlerts.find(a => a.id === alertId);
            if (alert) {
                alert.enabled = !alert.enabled;
                localStorage.setItem('portfolioAlerts', JSON.stringify(portfolioAlerts));
                renderAlerts();
            }
        }

        function renderAlerts() {
            const container = document.getElementById('alertsList');
            const emptyState = document.getElementById('alertsEmptyState');

            if (portfolioAlerts.length === 0) {
                container.innerHTML = '';
                container.appendChild(emptyState.cloneNode(true)).style.display = 'block';
                return;
            }

            container.innerHTML = portfolioAlerts.map(a => {
                const conditionText = {
                    'above': `above $${a.value}`,
                    'below': `below $${a.value}`,
                    'change_up': `increases by ${a.value}%`,
                    'change_down': `decreases by ${a.value}%`
                }[a.condition];

                return `
                    <div class="alert-item">
                        <div class="alert-icon ${a.condition.includes('up') || a.condition === 'above' ? 'price-up' : 'price-down'}">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                ${a.condition.includes('up') || a.condition === 'above' ?
                                    '<polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/>' :
                                    '<polyline points="23 18 13.5 8.5 8.5 13.5 1 6"/><polyline points="17 18 23 18 23 12"/>'}
                            </svg>
                        </div>
                        <div class="alert-content">
                            <div class="alert-title">${a.symbol} ${conditionText}</div>
                            <div class="alert-desc">Current: ${formatCurrency(a.currentPrice)}</div>
                        </div>
                        <div class="alert-toggle">
                            <label class="toggle-switch">
                                <input type="checkbox" ${a.enabled ? 'checked' : ''} onchange="toggleAlert(${a.id})">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <button class="btn-remove" onclick="deleteAlert(${a.id})">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                            </svg>
                        </button>
                    </div>
                `;
            }).join('');
        }

        // =============================================================================
        // PORTFOLIO SNAPSHOTS
        // =============================================================================

        let portfolioSnapshots = JSON.parse(localStorage.getItem('portfolioSnapshots') || '[]');

        function saveSnapshot() {
            if (!portfolioData) {
                showToast('No portfolio to snapshot', 'error');
                return;
            }

            const snapshot = {
                id: Date.now(),
                date: new Date().toISOString(),
                totalValue: portfolioData.total_value,
                positions: portfolioData.positions.length,
                allocation: {
                    stocks: portfolioData.allocation?.stocks || 0,
                    bonds: portfolioData.allocation?.bonds || 0,
                    cash: portfolioData.allocation?.cash || 0
                }
            };

            portfolioSnapshots.unshift(snapshot);
            portfolioSnapshots = portfolioSnapshots.slice(0, 20); // Keep last 20
            localStorage.setItem('portfolioSnapshots', JSON.stringify(portfolioSnapshots));

            renderSnapshots();
            showToast('Snapshot saved', 'success');
        }

        function renderSnapshots() {
            const container = document.getElementById('snapshotTimeline');
            if (!container) return;

            if (portfolioSnapshots.length === 0) {
                container.innerHTML = '<div class="empty-state" style="padding: 24px;"><p>No snapshots yet. Save your first snapshot to start tracking.</p></div>';
                return;
            }

            container.innerHTML = portfolioSnapshots.map((s, i) => {
                const prevValue = portfolioSnapshots[i + 1]?.totalValue;
                const change = prevValue ? ((s.totalValue - prevValue) / prevValue) * 100 : null;

                return `
                    <div class="snapshot-item">
                        <div class="snapshot-date">${new Date(s.date).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}</div>
                        <div class="snapshot-value">${formatCurrency(s.totalValue)}</div>
                        ${change !== null ? `
                            <div class="snapshot-change ${change >= 0 ? 'positive' : 'negative'}">
                                ${change >= 0 ? '' : ''} ${Math.abs(change).toFixed(2)}% from previous
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        // =============================================================================
        // EXPORT FUNCTIONS
        // =============================================================================

        function showExportModal() {
            document.getElementById('exportModal').classList.add('active');
        }

        function hideExportModal() {
            document.getElementById('exportModal').classList.remove('active');
        }

        function exportToPDF() {
            hideExportModal();
            document.getElementById('downloadPdfBtn').click();
        }

        function exportToCSV() {
            hideExportModal();
            document.getElementById('downloadCsvBtn').click();
        }

        function exportToExcel() {
            if (!portfolioData || !portfolioData.positions) {
                showToast('No portfolio data to export', 'error');
                return;
            }

            // Create Excel-compatible XML
            let xml = '<?xml version="1.0"?><?mso-application progid="Excel.Sheet"?>';
            xml += '<Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet" xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet">';

            // Holdings sheet
            xml += '<Worksheet ss:Name="Holdings"><Table>';
            xml += '<Row><Cell><Data ss:Type="String">Symbol</Data></Cell><Cell><Data ss:Type="String">Description</Data></Cell><Cell><Data ss:Type="String">Shares</Data></Cell><Cell><Data ss:Type="String">Price</Data></Cell><Cell><Data ss:Type="String">Value</Data></Cell><Cell><Data ss:Type="String">Weight</Data></Cell></Row>';
            portfolioData.positions.forEach(p => {
                xml += `<Row><Cell><Data ss:Type="String">${p.symbol}</Data></Cell><Cell><Data ss:Type="String">${p.description || ''}</Data></Cell><Cell><Data ss:Type="Number">${p.shares}</Data></Cell><Cell><Data ss:Type="Number">${p.price}</Data></Cell><Cell><Data ss:Type="Number">${p.value}</Data></Cell><Cell><Data ss:Type="Number">${p.weight}</Data></Cell></Row>`;
            });
            xml += '</Table></Worksheet>';

            // Summary sheet
            xml += '<Worksheet ss:Name="Summary"><Table>';
            xml += `<Row><Cell><Data ss:Type="String">Total Value</Data></Cell><Cell><Data ss:Type="Number">${portfolioData.total_value}</Data></Cell></Row>`;
            xml += `<Row><Cell><Data ss:Type="String">Positions</Data></Cell><Cell><Data ss:Type="Number">${portfolioData.positions.length}</Data></Cell></Row>`;
            xml += '</Table></Worksheet>';

            xml += '</Workbook>';

            const blob = new Blob([xml], { type: 'application/vnd.ms-excel' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'portfolio_export.xls';
            a.click();
            URL.revokeObjectURL(url);

            hideExportModal();
            showToast('Excel file downloaded', 'success');
        }

        function exportToJSON() {
            if (!portfolioData) {
                showToast('No portfolio data to export', 'error');
                return;
            }

            const json = JSON.stringify(portfolioData, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'portfolio_export.json';
            a.click();
            URL.revokeObjectURL(url);

            hideExportModal();
            showToast('JSON file downloaded', 'success');
        }

        // =============================================================================
        // IMPORT FUNCTIONS
        // =============================================================================

        function showImportModal() {
            document.getElementById('importModal').classList.add('active');
        }

        function hideImportModal() {
            document.getElementById('importModal').classList.remove('active');
        }

        function downloadTemplate(type) {
            let csv = '';
            if (type === 'basic') {
                csv = 'Symbol,Shares,Price\nAAPL,100,150.00\nMSFT,50,300.00\nGOOGL,25,140.00';
            } else if (type === 'detailed') {
                csv = 'Symbol,Shares,Price,Cost Basis,Purchase Date\nAAPL,100,150.00,14000.00,2023-01-15\nMSFT,50,300.00,13500.00,2023-03-20';
            } else if (type === 'schwab') {
                csv = 'Symbol,Description,Quantity,Price,Market Value,Day Change %,Day Change $\nAAPL,APPLE INC,100,150.00,15000.00,1.5%,$220.50';
            }

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `portfolio_template_${type}.csv`;
            a.click();
            URL.revokeObjectURL(url);

            showToast('Template downloaded', 'success');
        }

        function handleImportFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const text = e.target.result;
                    const lines = text.split('\n').filter(l => l.trim());
                    const headers = lines[0].toLowerCase().split(',').map(h => h.trim());

                    const symbolIndex = headers.findIndex(h => h.includes('symbol') || h.includes('ticker'));
                    const sharesIndex = headers.findIndex(h => h.includes('shares') || h.includes('quantity') || h.includes('qty'));
                    const priceIndex = headers.findIndex(h => h.includes('price'));

                    if (symbolIndex === -1 || sharesIndex === -1) {
                        showToast('Invalid file format. Need Symbol and Shares columns.', 'error');
                        return;
                    }

                    manualHoldings = [];
                    for (let i = 1; i < lines.length; i++) {
                        const cols = lines[i].split(',').map(c => c.trim().replace(/["\$]/g, ''));
                        const symbol = cols[symbolIndex]?.toUpperCase();
                        const shares = parseFloat(cols[sharesIndex]);
                        const price = priceIndex >= 0 ? parseFloat(cols[priceIndex]) : 100;

                        if (symbol && !isNaN(shares) && shares > 0) {
                            manualHoldings.push({
                                symbol,
                                shares,
                                price: isNaN(price) ? 100 : price,
                                value: shares * (isNaN(price) ? 100 : price),
                                description: symbol
                            });
                        }
                    }

                    if (manualHoldings.length > 0) {
                        hideImportModal();
                        switchEntryMethod('manual');
                        renderManualHoldings();
                        showToast(`Imported ${manualHoldings.length} holdings`, 'success');
                    } else {
                        showToast('No valid holdings found in file', 'error');
                    }
                } catch (err) {
                    showToast('Error parsing file: ' + err.message, 'error');
                }
            };
            reader.readAsText(file);
        }

        // =============================================================================
        // SHARE PORTFOLIO
        // =============================================================================

        function showShareModal() {
            document.getElementById('shareModal').classList.add('active');
            updateShareLink();
        }

        function hideShareModal() {
            document.getElementById('shareModal').classList.remove('active');
        }

        function updateShareLink() {
            const hideValues = document.getElementById('shareHideValues')?.checked;
            // In production, this would generate a real shareable link
            const shareData = btoa(JSON.stringify({
                positions: portfolioData?.positions?.map(p => ({
                    symbol: p.symbol,
                    weight: p.weight,
                    value: hideValues ? null : p.value
                })),
                hideValues
            }));
            document.getElementById('shareLink').value = `${window.location.origin}/share/${shareData.slice(0, 20)}...`;
        }

        function copyShareLink() {
            const input = document.getElementById('shareLink');
            input.select();
            document.execCommand('copy');
            showToast('Link copied to clipboard', 'success');
        }

        function shareViaEmail() {
            const subject = encodeURIComponent('Check out my portfolio analysis');
            const body = encodeURIComponent(`I analyzed my portfolio using Statement Scan. Check it out: ${document.getElementById('shareLink').value}`);
            window.open(`mailto:?subject=${subject}&body=${body}`);
        }

        function shareViaTwitter() {
            const text = encodeURIComponent('I just analyzed my investment portfolio with @StatementScan');
            window.open(`https://twitter.com/intent/tweet?text=${text}`);
        }

        function shareViaLinkedIn() {
            const url = encodeURIComponent(document.getElementById('shareLink').value);
            window.open(`https://www.linkedin.com/sharing/share-offsite/?url=${url}`);
        }

        // =============================================================================
        // PWA SUPPORT
        // =============================================================================

        let deferredPrompt = null;

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            // Show install prompt after a delay if user hasn't dismissed it
            if (!localStorage.getItem('pwaPromptDismissed')) {
                setTimeout(() => {
                    document.getElementById('pwaInstallPrompt')?.classList.add('show');
                }, 30000); // Show after 30 seconds
            }
        });

        function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        showToast('App installed successfully!', 'success');
                    }
                    deferredPrompt = null;
                    document.getElementById('pwaInstallPrompt')?.classList.remove('show');
                });
            }
        }

        function dismissPWAPrompt() {
            localStorage.setItem('pwaPromptDismissed', 'true');
            document.getElementById('pwaInstallPrompt')?.classList.remove('show');
        }

        // =============================================================================
        // ENHANCED DASHBOARD RENDERING
        // =============================================================================

        // Override or extend showDashboard to include new tabs
        const originalShowDashboard = typeof showDashboard === 'function' ? showDashboard : null;

        function enhancedShowDashboard() {
            if (originalShowDashboard) {
                // Call original if it exists
            }

            // Render new tabs
            setTimeout(() => {
                renderDividendTab();
                renderTaxTab();
                renderAlerts();
                renderSnapshots();
            }, 100);
        }

        // Hook into tab switching to render new tabs
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('tab')) {
                const tab = e.target.dataset.tab;
                if (tab === 'dividends') renderDividendTab();
                else if (tab === 'tax') renderTaxTab();
                else if (tab === 'alerts') {
                    renderAlerts();
                    renderSnapshots();
                }
            }
        });

        // =============================================================================
        // AUTHENTICATION
        // =============================================================================

        function showAuthModal() {
            document.getElementById('authModal').classList.add('active');
        }

        function hideAuthModal() {
            document.getElementById('authModal').classList.remove('active');
            document.getElementById('loginError').style.display = 'none';
            document.getElementById('registerError').style.display = 'none';
        }

        function switchAuthTab(tab) {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
            document.querySelector(`.auth-tab[data-tab="${tab}"]`).classList.add('active');
            document.getElementById(tab === 'login' ? 'loginForm' : 'registerForm').classList.add('active');
        }

        async function handleLogin(event) {
            event.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const errorEl = document.getElementById('loginError');

            try {
                const res = await fetch(`${API_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await res.json();

                if (!res.ok) {
                    errorEl.textContent = data.error || 'Login failed';
                    errorEl.style.display = 'block';
                    return;
                }

                authToken = data.access_token;
                currentUser = data.user;
                localStorage.setItem('authToken', authToken);
                hideAuthModal();
                updateAuthUI();
                loadSavedPortfolios();
            } catch (err) {
                errorEl.textContent = 'Connection error. Please try again.';
                errorEl.style.display = 'block';
            }
        }

        async function handleRegister(event) {
            event.preventDefault();
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const errorEl = document.getElementById('registerError');

            try {
                const res = await fetch(`${API_URL}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, email, password })
                });

                const data = await res.json();

                if (!res.ok) {
                    errorEl.textContent = data.error || 'Registration failed';
                    errorEl.style.display = 'block';
                    return;
                }

                authToken = data.access_token;
                currentUser = data.user;
                localStorage.setItem('authToken', authToken);
                hideAuthModal();
                updateAuthUI();
                loadSavedPortfolios();
            } catch (err) {
                errorEl.textContent = 'Connection error. Please try again.';
                errorEl.style.display = 'block';
            }
        }

        function logout() {
            authToken = null;
            currentUser = null;
            localStorage.removeItem('authToken');
            updateAuthUI();
            document.getElementById('savedPortfoliosSection').style.display = 'none';
        }

        function showForgotPassword(event) {
            event.preventDefault();
            document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.getElementById('forgotPasswordForm').classList.add('active');
            document.getElementById('forgotError').style.display = 'none';
            document.getElementById('forgotSuccess').style.display = 'none';
        }

        function backToLogin(event) {
            event.preventDefault();
            document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
            document.getElementById('loginForm').classList.add('active');
            document.querySelector('.auth-tab[data-tab="login"]').classList.add('active');
        }

        async function handleForgotPassword(event) {
            event.preventDefault();
            const email = document.getElementById('forgotEmail').value;
            const errorEl = document.getElementById('forgotError');
            const successEl = document.getElementById('forgotSuccess');
            const submitBtn = event.target.querySelector('button[type="submit"]');

            errorEl.style.display = 'none';
            successEl.style.display = 'none';
            submitBtn.disabled = true;
            submitBtn.textContent = 'Sending...';

            try {
                const res = await fetch(`${API_URL}/auth/forgot-password`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });

                const data = await res.json();

                if (!res.ok) {
                    errorEl.textContent = data.error || 'Failed to send reset link';
                    errorEl.style.display = 'block';
                } else {
                    successEl.textContent = data.message || 'If an account exists with that email, a reset link has been sent.';
                    successEl.style.display = 'block';
                    document.getElementById('forgotEmail').value = '';
                }
            } catch (err) {
                errorEl.textContent = 'Connection error. Please try again.';
                errorEl.style.display = 'block';
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Send Reset Link';
            }
        }

        function showResetPasswordModal(token) {
            resetToken = token;
            document.getElementById('resetPasswordModal').classList.add('active');
            document.getElementById('resetError').style.display = 'none';
            document.getElementById('resetSuccess').style.display = 'none';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
        }

        function hideResetPasswordModal() {
            document.getElementById('resetPasswordModal').classList.remove('active');
            // Clear reset token from URL
            const url = new URL(window.location);
            url.searchParams.delete('reset_token');
            window.history.replaceState({}, '', url);
        }

        async function handleResetPassword(event) {
            event.preventDefault();
            const password = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const errorEl = document.getElementById('resetError');
            const successEl = document.getElementById('resetSuccess');
            const submitBtn = event.target.querySelector('button[type="submit"]');

            errorEl.style.display = 'none';
            successEl.style.display = 'none';

            if (password !== confirmPassword) {
                errorEl.textContent = 'Passwords do not match';
                errorEl.style.display = 'block';
                return;
            }

            if (password.length < 6) {
                errorEl.textContent = 'Password must be at least 6 characters';
                errorEl.style.display = 'block';
                return;
            }

            submitBtn.disabled = true;
            submitBtn.textContent = 'Resetting...';

            try {
                const res = await fetch(`${API_URL}/auth/reset-password`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token: resetToken, password })
                });

                const data = await res.json();

                if (!res.ok) {
                    errorEl.textContent = data.error || 'Failed to reset password';
                    errorEl.style.display = 'block';
                } else {
                    successEl.textContent = data.message || 'Password reset successfully! You can now sign in.';
                    successEl.style.display = 'block';
                    submitBtn.style.display = 'none';

                    // Auto-close and show login after 3 seconds
                    setTimeout(() => {
                        hideResetPasswordModal();
                        showAuthModal();
                    }, 3000);
                }
            } catch (err) {
                errorEl.textContent = 'Connection error. Please try again.';
                errorEl.style.display = 'block';
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Reset Password';
            }
        }

        let resetToken = null;

        function updateAuthUI() {
            const authSection = document.getElementById('authSection');
            const saveBtn = document.getElementById('savePortfolioBtn');

            if (currentUser) {
                const initials = (currentUser.name || currentUser.email || 'U').substring(0, 2).toUpperCase();
                authSection.innerHTML = `
                    <div class="user-menu">
                        <button class="user-btn" onclick="toggleUserDropdown()" aria-haspopup="true" aria-expanded="false">
                            <div class="user-avatar">${initials}</div>
                            <span>${currentUser.name || currentUser.email}</span>
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="6 9 12 15 18 9"/>
                            </svg>
                        </button>
                        <div class="user-dropdown" id="userDropdown" role="menu">
                            <div class="dropdown-item" style="color: var(--text-muted); pointer-events: none;" role="menuitem">
                                ${currentUser.email}
                            </div>
                            <div class="dropdown-divider"></div>
                            <button class="dropdown-item" onclick="loadSavedPortfolios(); toggleUserDropdown();" role="menuitem">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px;">
                                    <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/>
                                </svg>
                                My Portfolios
                            </button>
                            <button class="dropdown-item" onclick="showSettingsModal(); toggleUserDropdown();" role="menuitem">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px;">
                                    <circle cx="12" cy="12" r="3"/>
                                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                                </svg>
                                Settings
                                <span class="shortcut-hint"><span class="kbd">Ctrl</span><span class="kbd">,</span></span>
                            </button>
                            <div class="dropdown-divider"></div>
                            <button class="dropdown-item" onclick="logout()" role="menuitem">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px;">
                                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                                    <polyline points="16 17 21 12 16 7"/>
                                    <line x1="21" y1="12" x2="9" y2="12"/>
                                </svg>
                                Sign Out
                            </button>
                        </div>
                    </div>
                `;
                saveBtn.style.display = 'inline-flex';
                document.getElementById('savedPortfoliosSection').style.display = 'block';
                updatePlaidUI();
                // Start session timer when logged in
                startSessionTimer();
            } else {
                authSection.innerHTML = `
                    <button class="btn btn-secondary" onclick="showAuthModal()">Sign In</button>
                `;
                saveBtn.style.display = 'none';
                document.getElementById('savedPortfoliosSection').style.display = 'none';
                document.getElementById('plaidSection').style.display = 'none';
            }
        }

        function toggleUserDropdown() {
            const dropdown = document.getElementById('userDropdown');
            dropdown.classList.toggle('active');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            const dropdown = document.getElementById('userDropdown');
            const userBtn = e.target.closest('.user-btn');
            if (!userBtn && dropdown) {
                dropdown.classList.remove('active');
            }
        });

        // Check auth on page load
        async function checkAuth() {
            if (!authToken) return;

            try {
                const res = await fetch(`${API_URL}/auth/me`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (res.ok) {
                    const data = await res.json();
                    currentUser = data.user;
                    updateAuthUI();
                    loadSavedPortfolios();
                } else {
                    logout();
                }
            } catch (err) {
                // API might not be available yet, keep token
            }
        }

        // =============================================================================
        // PORTFOLIO SAVING
        // =============================================================================

        function showSaveModal() {
            if (!currentUser) {
                showAuthModal();
                return;
            }
            document.getElementById('saveModal').classList.add('active');
        }

        function hideSaveModal() {
            document.getElementById('saveModal').classList.remove('active');
            document.getElementById('saveError').style.display = 'none';
            document.getElementById('saveForm').reset();
        }

        async function handleSavePortfolio(event) {
            event.preventDefault();

            if (!portfolioData || !portfolioData.positions) {
                return;
            }

            const name = document.getElementById('portfolioName').value;
            const description = document.getElementById('portfolioDescription').value;
            const errorEl = document.getElementById('saveError');

            try {
                const res = await fetch(`${API_URL}/portfolios`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        name,
                        description,
                        positions: portfolioData.positions
                    })
                });

                const data = await res.json();

                if (!res.ok) {
                    errorEl.textContent = data.error || 'Failed to save portfolio';
                    errorEl.style.display = 'block';
                    return;
                }

                hideSaveModal();
                showToast('Portfolio saved successfully!');
                loadSavedPortfolios();
            } catch (err) {
                errorEl.textContent = 'Connection error. Please try again.';
                errorEl.style.display = 'block';
            }
        }

        async function loadSavedPortfolios() {
            if (!authToken) return;

            const listEl = document.getElementById('portfolioList');
            const emptyState = document.getElementById('portfolioEmptyState');

            // Show skeleton loading state
            listEl.innerHTML = `
                <div class="skeleton-row">
                    <div class="skeleton skeleton-circle"></div>
                    <div class="skeleton skeleton-block"></div>
                </div>
                <div class="skeleton-row">
                    <div class="skeleton skeleton-circle"></div>
                    <div class="skeleton skeleton-block"></div>
                </div>
            `;

            try {
                const res = await fetch(`${API_URL}/portfolios`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (!res.ok) {
                    listEl.innerHTML = `
                        <div class="empty-state-enhanced">
                            <div class="empty-state-icon" style="background: rgba(248, 113, 113, 0.1);">
                                <svg viewBox="0 0 24 24" fill="none" stroke="var(--danger)" stroke-width="1.5">
                                    <circle cx="12" cy="12" r="10"/>
                                    <line x1="15" y1="9" x2="9" y2="15"/>
                                    <line x1="9" y1="9" x2="15" y2="15"/>
                                </svg>
                            </div>
                            <div class="empty-state-title">Failed to load portfolios</div>
                            <div class="empty-state-desc">Please check your connection and try again.</div>
                            <div class="empty-state-actions">
                                <button class="btn btn-secondary" onclick="loadSavedPortfolios()">Try Again</button>
                            </div>
                        </div>
                    `;
                    return;
                }

                const data = await res.json();
                const portfolios = data.portfolios || [];

                if (portfolios.length === 0) {
                    listEl.innerHTML = `
                        <div class="empty-state-enhanced">
                            <div class="empty-state-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/>
                                </svg>
                            </div>
                            <div class="empty-state-title">No saved portfolios</div>
                            <div class="empty-state-desc">Analyze a portfolio and save it to track your investments over time.</div>
                            <div class="empty-state-actions">
                                <button class="btn btn-primary" onclick="switchEntryMethod('upload')">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                        <polyline points="17 8 12 3 7 8"/>
                                        <line x1="12" y1="3" x2="12" y2="15"/>
                                    </svg>
                                    Upload Statement
                                </button>
                            </div>
                        </div>
                    `;
                    return;
                }

                listEl.innerHTML = portfolios.map(p => `
                    <div class="portfolio-item" onclick="loadPortfolio(${p.id})" role="button" tabindex="0" aria-label="Load ${escapeHtml(p.name)} portfolio">
                        <div class="portfolio-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                            </svg>
                        </div>
                        <div class="portfolio-info">
                            <div class="portfolio-name">${escapeHtml(p.name)}</div>
                            <div class="portfolio-meta">
                                ${p.positions?.length || 0} positions
                                ${p.description ? ' - ' + escapeHtml(p.description) : ''}
                            </div>
                        </div>
                        <div class="portfolio-value">${formatCurrency(p.total_value)}</div>
                        <div class="portfolio-actions" onclick="event.stopPropagation()">
                            <button class="portfolio-action-btn delete" onclick="deletePortfolio(${p.id})" title="Delete portfolio" aria-label="Delete ${escapeHtml(p.name)}">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="3 6 5 6 21 6"/>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                `).join('');

                // Also update compare selectors
                updateCompareSelectors();

            } catch (err) {
                listEl.innerHTML = `
                    <div class="empty-state-enhanced">
                        <div class="empty-state-icon" style="background: rgba(248, 113, 113, 0.1);">
                            <svg viewBox="0 0 24 24" fill="none" stroke="var(--danger)" stroke-width="1.5">
                                <circle cx="12" cy="12" r="10"/>
                                <line x1="15" y1="9" x2="9" y2="15"/>
                                <line x1="9" y1="9" x2="15" y2="15"/>
                            </svg>
                        </div>
                        <div class="empty-state-title">Connection Error</div>
                        <div class="empty-state-desc">Failed to load portfolios. Please try again.</div>
                        <div class="empty-state-actions">
                            <button class="btn btn-secondary" onclick="loadSavedPortfolios()">Try Again</button>
                        </div>
                    </div>
                `;
            }
        }

        async function loadPortfolio(portfolioId) {
            if (!authToken) return;

            showProgress('Loading portfolio...');

            try {
                const res = await fetch(`${API_URL}/portfolios/${portfolioId}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (!res.ok) {
                    hideProgress();
                    showError('Failed to load portfolio');
                    return;
                }

                const data = await res.json();
                const portfolio = data.portfolio;

                // Create a fake account for the loaded portfolio
                accounts = [{
                    id: Date.now(),
                    name: portfolio.name,
                    positions: portfolio.positions,
                    brokerage: 'saved',
                    totalValue: portfolio.total_value
                }];

                // Analyze the portfolio
                await analyzePortfolio();

            } catch (err) {
                hideProgress();
                showError('Failed to load portfolio: ' + err.message);
            }
        }

        async function deletePortfolio(portfolioId) {
            showConfirmModal({
                title: 'Delete Portfolio?',
                message: 'This portfolio and all its data will be permanently deleted. This action cannot be undone.',
                confirmText: 'Delete',
                confirmClass: 'btn-primary',
                icon: 'danger',
                onConfirm: async () => {
                    try {
                        const res = await fetch(`${API_URL}/portfolios/${portfolioId}`, {
                            method: 'DELETE',
                            headers: { 'Authorization': `Bearer ${authToken}` }
                        });

                        if (!res.ok) {
                            const data = await res.json();
                            showError(data.error || 'Failed to delete portfolio');
                            return;
                        }

                        showToast('Portfolio deleted', 'success');
                        loadSavedPortfolios();
                    } catch (err) {
                        showError('Failed to delete portfolio');
                    }
                }
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // showToast is now defined in the Enterprise Enhancements section above

        // =============================================================================
        // PORTFOLIO COMPARISON
        // =============================================================================

        let compareCharts = {};

        function updateCompareSelectors() {
            const selectA = document.getElementById('compareSelectA');
            const selectB = document.getElementById('compareSelectB');

            // Build options
            let options = '';

            // Add current analysis if available
            if (portfolioData && portfolioData.positions) {
                options += '<option value="current">Current Analysis</option>';
            }

            // Fetch saved portfolios for options
            if (authToken) {
                fetch(`${API_URL}/portfolios`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                })
                .then(res => res.json())
                .then(data => {
                    const portfolios = data.portfolios || [];
                    portfolios.forEach(p => {
                        options += `<option value="${p.id}">${escapeHtml(p.name)} (${formatCurrency(p.total_value)})</option>`;
                    });

                    // Update select A
                    selectA.innerHTML = portfolioData ? '<option value="current">Current Analysis</option>' : '';
                    selectA.innerHTML += portfolios.map(p =>
                        `<option value="${p.id}">${escapeHtml(p.name)} (${formatCurrency(p.total_value)})</option>`
                    ).join('');

                    // Update select B
                    selectB.innerHTML = '<option value="">Select a portfolio...</option>';
                    if (portfolioData) {
                        selectB.innerHTML += '<option value="current">Current Analysis</option>';
                    }
                    selectB.innerHTML += portfolios.map(p =>
                        `<option value="${p.id}">${escapeHtml(p.name)} (${formatCurrency(p.total_value)})</option>`
                    ).join('');
                })
                .catch(() => {});
            } else {
                selectA.innerHTML = portfolioData ? '<option value="current">Current Analysis</option>' : '<option value="">No portfolios available</option>';
                selectB.innerHTML = '<option value="">Sign in to compare saved portfolios</option>';
            }
        }

        async function runComparison() {
            const selectA = document.getElementById('compareSelectA').value;
            const selectB = document.getElementById('compareSelectB').value;

            if (!selectA || !selectB) {
                showError('Please select two portfolios to compare');
                return;
            }

            if (selectA === selectB) {
                showError('Please select two different portfolios');
                return;
            }

            // Build request body
            const body = {
                portfolio_a: selectA === 'current' ? { positions: portfolioData.positions } : { id: parseInt(selectA) },
                portfolio_b: selectB === 'current' ? { positions: portfolioData.positions } : { id: parseInt(selectB) }
            };

            showProgress('Comparing portfolios...');

            try {
                const headers = { 'Content-Type': 'application/json' };
                if (authToken) {
                    headers['Authorization'] = `Bearer ${authToken}`;
                }

                const res = await fetch(`${API_URL}/compare`, {
                    method: 'POST',
                    headers,
                    body: JSON.stringify(body)
                });

                if (!res.ok) {
                    const data = await res.json();
                    hideProgress();
                    showError(data.error || 'Comparison failed');
                    return;
                }

                const data = await res.json();
                hideProgress();
                renderComparison(data);

            } catch (err) {
                hideProgress();
                showError('Comparison failed: ' + err.message);
            }
        }

        function renderComparison(data) {
            const resultsEl = document.getElementById('comparisonResults');
            const emptyEl = document.getElementById('compareEmptyState');

            resultsEl.style.display = 'block';
            emptyEl.style.display = 'none';

            const { portfolio_a, portfolio_b, comparison } = data;

            // Get names from selectors
            const selectA = document.getElementById('compareSelectA');
            const selectB = document.getElementById('compareSelectB');
            const nameA = selectA.options[selectA.selectedIndex].text;
            const nameB = selectB.options[selectB.selectedIndex].text;

            // Update headers
            document.getElementById('compareNameA').textContent = nameA.split(' (')[0];
            document.getElementById('compareNameB').textContent = nameB.split(' (')[0];
            document.getElementById('compareValueA').textContent = formatCurrency(portfolio_a.total_value);
            document.getElementById('compareValueB').textContent = formatCurrency(portfolio_b.total_value);

            // Render allocation charts
            renderCompareChart('compareChartA', portfolio_a.asset_allocation);
            renderCompareChart('compareChartB', portfolio_b.asset_allocation);

            // Render stats
            renderCompareStats('compareStatsA', portfolio_a);
            renderCompareStats('compareStatsB', portfolio_b);

            // Render difference grid
            renderDiffGrid(comparison);
        }

        function renderCompareChart(canvasId, allocation) {
            const ctx = document.getElementById(canvasId).getContext('2d');

            if (compareCharts[canvasId]) {
                compareCharts[canvasId].destroy();
            }

            const labels = Object.keys(allocation).filter(k => allocation[k] > 0);
            const values = labels.map(k => allocation[k]);
            const colors = {
                Stocks: '#635bff', Bonds: '#30d158', Cash: '#ffd60a',
                'Real Estate': '#bf5af2', Crypto: '#ff9f0a', Commodities: '#64d2ff'
            };
            const bgColors = labels.map(l => colors[l] || '#8898aa');

            compareCharts[canvasId] = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels,
                    datasets: [{ data: values, backgroundColor: bgColors, borderWidth: 0 }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { padding: 12, usePointStyle: true, font: { size: 11 } } },
                        tooltip: { callbacks: { label: ctx => `${ctx.label}: ${ctx.raw.toFixed(1)}%` } }
                    }
                }
            });
        }

        function renderCompareStats(containerId, analysis) {
            const risk = analysis.risk_metrics || {};
            const perf = analysis.historical_performance?.returns || {};

            document.getElementById(containerId).innerHTML = `
                <div class="compare-stat">
                    <div class="compare-stat-value">${risk.volatility !== null ? risk.volatility.toFixed(1) + '%' : '--'}</div>
                    <div class="compare-stat-label">Volatility</div>
                </div>
                <div class="compare-stat">
                    <div class="compare-stat-value">${risk.beta !== null ? risk.beta.toFixed(2) : '--'}</div>
                    <div class="compare-stat-label">Beta</div>
                </div>
                <div class="compare-stat">
                    <div class="compare-stat-value">${risk.sharpe_ratio !== null ? risk.sharpe_ratio.toFixed(2) : '--'}</div>
                    <div class="compare-stat-label">Sharpe</div>
                </div>
                <div class="compare-stat">
                    <div class="compare-stat-value">${perf['1Y']?.portfolio !== null ? (perf['1Y']?.portfolio > 0 ? '+' : '') + perf['1Y']?.portfolio?.toFixed(1) + '%' : '--'}</div>
                    <div class="compare-stat-label">1Y Return</div>
                </div>
            `;
        }

        function renderDiffGrid(comparison) {
            const grid = document.getElementById('diffGrid');

            const formatDiff = (val, suffix = '') => {
                if (val === null || val === undefined) return '--';
                const sign = val > 0 ? '+' : '';
                return sign + val.toFixed(1) + suffix;
            };

            const getDiffClass = (val) => {
                if (val === null || val === undefined || val === 0) return 'neutral';
                return val > 0 ? 'positive' : 'negative';
            };

            const items = [
                { label: 'Total Value', value: comparison.total_value_diff, format: v => formatCurrency(v), rawValue: comparison.total_value_diff },
                { label: 'Stocks %', value: comparison.allocation_diff?.Stocks, suffix: '%' },
                { label: 'Bonds %', value: comparison.allocation_diff?.Bonds, suffix: '%' },
                { label: 'Volatility', value: comparison.risk_diff?.volatility, suffix: '%' },
                { label: 'Beta', value: comparison.risk_diff?.beta, suffix: '' },
                { label: 'Sharpe Ratio', value: comparison.risk_diff?.sharpe_ratio, suffix: '' },
                { label: '1Y Return', value: comparison.performance_diff?.['1Y'], suffix: '%' },
                { label: '3Y Return', value: comparison.performance_diff?.['3Y'], suffix: '%' }
            ];

            grid.innerHTML = items.map(item => {
                const displayVal = item.format ? item.format(item.value) : formatDiff(item.value, item.suffix || '');
                const rawVal = item.rawValue !== undefined ? item.rawValue : item.value;
                return `
                    <div class="diff-item">
                        <div class="diff-value ${getDiffClass(rawVal)}">${displayVal}</div>
                        <div class="diff-label">${item.label}</div>
                    </div>
                `;
            }).join('');
        }

        // =============================================================================
        // WHAT-IF ANALYSIS
        // =============================================================================

        let whatIfPositions = [];
        let whatIfChanges = [];
        let whatIfChart = null;
        let whatIfResult = null;

        function initWhatIf() {
            if (!portfolioData || !portfolioData.positions) return;

            // Clone current positions
            whatIfPositions = JSON.parse(JSON.stringify(portfolioData.positions));
            whatIfChanges = [];
            whatIfResult = null;

            renderWhatIfPositions();
            updateWhatIfPreview();
        }

        function renderWhatIfPositions() {
            const list = document.getElementById('whatifPositionList');

            if (!whatIfPositions || whatIfPositions.length === 0) {
                list.innerHTML = '<div class="empty-state">No positions to edit</div>';
                return;
            }

            list.innerHTML = whatIfPositions.map((pos, idx) => {
                const value = (pos.shares || 0) * (pos.price || 0);
                return `
                    <div class="whatif-position">
                        <div class="whatif-position-symbol">${pos.symbol}</div>
                        <div class="whatif-position-shares">
                            <input type="number" value="${pos.shares || 0}" min="0" step="0.0001"
                                   onchange="updateWhatIfShares(${idx}, this.value)">
                            <span style="color: var(--text-muted); font-size: 0.75rem; margin-left: 4px;">shares</span>
                        </div>
                        <div class="whatif-position-value">${formatCurrency(value)}</div>
                        <button class="whatif-position-remove" onclick="removeWhatIfPosition(${idx})" title="Remove">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                            </svg>
                        </button>
                    </div>
                `;
            }).join('');
        }

        function updateWhatIfShares(idx, newShares) {
            const pos = whatIfPositions[idx];
            if (!pos) return;

            const oldShares = pos.shares || 0;
            pos.shares = parseFloat(newShares) || 0;
            pos.value = pos.shares * (pos.price || 0);

            // Track the change
            whatIfChanges = whatIfChanges.filter(c => !(c.action === 'adjust' && c.symbol === pos.symbol));
            if (pos.shares !== oldShares) {
                whatIfChanges.push({
                    action: 'adjust',
                    symbol: pos.symbol,
                    new_shares: pos.shares
                });
            }

            renderWhatIfPositions();
            updateWhatIfPreview();
        }

        function removeWhatIfPosition(idx) {
            const pos = whatIfPositions[idx];
            if (!pos) return;

            whatIfChanges.push({
                action: 'remove',
                symbol: pos.symbol
            });

            whatIfPositions.splice(idx, 1);
            renderWhatIfPositions();
            updateWhatIfPreview();
        }

        function addWhatIfPosition() {
            const symbol = document.getElementById('whatifAddSymbol').value.toUpperCase().trim();
            const shares = parseFloat(document.getElementById('whatifAddShares').value) || 0;
            const price = parseFloat(document.getElementById('whatifAddPrice').value) || 0;

            if (!symbol) {
                showError('Please enter a symbol');
                return;
            }
            if (shares <= 0) {
                showError('Please enter a valid number of shares');
                return;
            }
            if (price <= 0) {
                showError('Please enter a valid price');
                return;
            }

            // Check if already exists
            const existing = whatIfPositions.find(p => p.symbol.toUpperCase() === symbol);
            if (existing) {
                existing.shares = (existing.shares || 0) + shares;
                existing.value = existing.shares * (existing.price || price);
            } else {
                whatIfPositions.push({
                    symbol: symbol,
                    description: '',
                    shares: shares,
                    price: price,
                    value: shares * price
                });
            }

            whatIfChanges.push({
                action: 'add',
                symbol: symbol,
                shares: shares,
                price: price
            });

            // Clear form
            document.getElementById('whatifAddSymbol').value = '';
            document.getElementById('whatifAddShares').value = '';
            document.getElementById('whatifAddPrice').value = '';

            renderWhatIfPositions();
            updateWhatIfPreview();
        }

        function applyRebalance() {
            const stocks = parseFloat(document.getElementById('rebalanceStocks').value) || 0;
            const bonds = parseFloat(document.getElementById('rebalanceBonds').value) || 0;
            const cash = parseFloat(document.getElementById('rebalanceCash').value) || 0;

            const total = stocks + bonds + cash;
            if (total === 0) {
                showError('Please enter target allocations');
                return;
            }

            if (Math.abs(total - 100) > 0.1) {
                showError(`Allocations sum to ${total.toFixed(1)}%, should be 100%`);
                return;
            }

            whatIfChanges.push({
                action: 'rebalance',
                target: { Stocks: stocks, Bonds: bonds, Cash: cash }
            });

            // Run analysis to get rebalanced positions
            runWhatIfAnalysis();
        }

        function updateWhatIfPreview() {
            const totalValue = whatIfPositions.reduce((sum, p) => sum + ((p.shares || 0) * (p.price || 0)), 0);
            document.getElementById('whatifPreviewValue').textContent = formatCurrency(totalValue);

            // Calculate allocation preview
            const alloc = {};
            whatIfPositions.forEach(pos => {
                const value = (pos.shares || 0) * (pos.price || 0);
                // Simple classification based on symbol database
                const cls = getAssetClass(pos.symbol);
                alloc[cls] = (alloc[cls] || 0) + value;
            });

            const allocPct = {};
            for (const [cls, val] of Object.entries(alloc)) {
                allocPct[cls] = totalValue > 0 ? ((val / totalValue) * 100).toFixed(1) : '0.0';
            }

            // Render preview allocation chart
            renderWhatIfChart(allocPct);

            // Show modified allocation
            document.getElementById('whatifModifiedAlloc').innerHTML = Object.entries(allocPct)
                .map(([cls, pct]) => `${cls}: ${pct}%`)
                .join('<br>');

            // Show original allocation
            if (portfolioData && portfolioData.asset_allocation) {
                document.getElementById('whatifOriginalAlloc').innerHTML = Object.entries(portfolioData.asset_allocation)
                    .filter(([_, pct]) => pct > 0)
                    .map(([cls, pct]) => `${cls}: ${pct.toFixed(1)}%`)
                    .join('<br>');
            }
        }

        function getAssetClass(symbol) {
            // Simple lookup - in production this would use the backend classification
            const stockSymbols = ['VTI', 'VOO', 'SPY', 'QQQ', 'IVV', 'VEA', 'VWO', 'AAPL', 'MSFT', 'GOOGL', 'AMZN', 'META', 'NVDA', 'TSLA'];
            const bondSymbols = ['AGG', 'BND', 'TLT', 'BNDX', 'LQD', 'HYG', 'TIP', 'MUB', 'SGOV'];
            const cashSymbols = ['CASH', 'SPAXX', 'VMFXX', 'SWVXX'];
            const cryptoSymbols = ['IBIT', 'GBTC', 'ETHA', 'FBTC'];

            symbol = symbol.toUpperCase();
            if (cashSymbols.includes(symbol)) return 'Cash';
            if (bondSymbols.includes(symbol)) return 'Bonds';
            if (cryptoSymbols.includes(symbol)) return 'Crypto';
            return 'Stocks'; // Default
        }

        function renderWhatIfChart(allocation) {
            const ctx = document.getElementById('whatifChart').getContext('2d');

            if (whatIfChart) {
                whatIfChart.destroy();
            }

            const labels = Object.keys(allocation).filter(k => parseFloat(allocation[k]) > 0);
            const values = labels.map(k => parseFloat(allocation[k]));
            const colors = {
                Stocks: '#635bff', Bonds: '#30d158', Cash: '#ffd60a',
                'Real Estate': '#bf5af2', Crypto: '#ff9f0a', Commodities: '#64d2ff'
            };
            const bgColors = labels.map(l => colors[l] || '#8898aa');

            whatIfChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels,
                    datasets: [{ data: values, backgroundColor: bgColors, borderWidth: 0 }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { padding: 8, usePointStyle: true, font: { size: 10 } } },
                        tooltip: { callbacks: { label: ctx => `${ctx.label}: ${ctx.raw}%` } }
                    }
                }
            });
        }

        async function runWhatIfAnalysis() {
            if (!portfolioData || !portfolioData.positions) {
                showError('No portfolio to analyze');
                return;
            }

            showProgress('Running what-if analysis...');

            try {
                const headers = { 'Content-Type': 'application/json' };
                if (authToken) {
                    headers['Authorization'] = `Bearer ${authToken}`;
                }

                const res = await fetch(`${API_URL}/what-if`, {
                    method: 'POST',
                    headers,
                    body: JSON.stringify({
                        positions: portfolioData.positions,
                        changes: whatIfChanges
                    })
                });

                if (!res.ok) {
                    const data = await res.json();
                    hideProgress();
                    showError(data.error || 'Analysis failed');
                    return;
                }

                const data = await res.json();
                hideProgress();
                whatIfResult = data;

                // Update positions from result
                whatIfPositions = data.modified.positions.map(p => ({
                    symbol: p.symbol,
                    description: p.description,
                    shares: p.shares,
                    price: p.price,
                    value: p.value
                }));

                renderWhatIfPositions();
                renderWhatIfResults(data);

                // Show save button if logged in
                if (currentUser) {
                    document.getElementById('saveWhatIfBtn').style.display = 'inline-flex';
                }

            } catch (err) {
                hideProgress();
                showError('Analysis failed: ' + err.message);
            }
        }

        function renderWhatIfResults(data) {
            const { original, modified, impact } = data;

            // Update preview value
            document.getElementById('whatifPreviewValue').textContent = formatCurrency(modified.total_value);

            // Update impact cards
            const formatDiff = (val, suffix = '') => {
                if (val === null || val === undefined) return '--';
                const sign = val > 0 ? '+' : '';
                return sign + val.toFixed(1) + suffix;
            };

            document.getElementById('whatifValueChange').textContent = formatCurrency(impact.value_change);
            document.getElementById('whatifValueChange').className = 'whatif-impact-value ' +
                (impact.value_change > 0 ? 'positive' : impact.value_change < 0 ? 'negative' : '');

            document.getElementById('whatifCost').textContent = formatCurrency(impact.cost_to_execute);

            document.getElementById('whatifVolChange').textContent = formatDiff(impact.risk_change?.volatility, '%');
            document.getElementById('whatifVolChange').className = 'whatif-impact-value ' +
                (impact.risk_change?.volatility < 0 ? 'positive' : impact.risk_change?.volatility > 0 ? 'negative' : '');

            document.getElementById('whatifBetaChange').textContent = formatDiff(impact.risk_change?.beta, '');

            // Update allocation displays
            document.getElementById('whatifOriginalAlloc').innerHTML = Object.entries(original.asset_allocation)
                .filter(([_, pct]) => pct > 0)
                .map(([cls, pct]) => `${cls}: ${pct.toFixed(1)}%`)
                .join('<br>');

            document.getElementById('whatifModifiedAlloc').innerHTML = Object.entries(modified.asset_allocation)
                .filter(([_, pct]) => pct > 0)
                .map(([cls, pct]) => `${cls}: ${pct.toFixed(1)}%`)
                .join('<br>');

            // Update chart
            renderWhatIfChart(modified.asset_allocation);
        }

        function resetWhatIf() {
            initWhatIf();
            document.getElementById('saveWhatIfBtn').style.display = 'none';
            document.getElementById('whatifValueChange').textContent = '--';
            document.getElementById('whatifCost').textContent = '--';
            document.getElementById('whatifVolChange').textContent = '--';
            document.getElementById('whatifBetaChange').textContent = '--';
        }

        function saveWhatIfAsNew() {
            if (!whatIfResult || !currentUser) return;

            // Populate save modal with modified positions
            const tempPositions = whatIfResult.modified.positions;
            const tempData = portfolioData;

            // Temporarily set portfolio data to modified positions
            portfolioData = { positions: tempPositions };

            document.getElementById('portfolioName').value = 'What-If Scenario';
            showSaveModal();

            // Restore original after modal shown
            portfolioData = tempData;
        }

        // =============================================================================
        // PLAID INTEGRATION
        // =============================================================================

        let plaidAvailable = false;
        let plaidHandler = null;

        async function checkPlaidStatus() {
            try {
                const res = await fetch(`${API_URL}/plaid/status`);
                const data = await res.json();
                plaidAvailable = data.available;
                updatePlaidUI();
            } catch (err) {
                plaidAvailable = false;
            }
        }

        function updatePlaidUI() {
            const section = document.getElementById('plaidSection');

            // Only show Plaid section if user is logged in
            if (!currentUser) {
                section.style.display = 'none';
                return;
            }

            section.style.display = 'block';

            if (!plaidAvailable) {
                document.getElementById('plaidConnections').innerHTML = `
                    <div class="plaid-unavailable">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <rect x="2" y="4" width="20" height="16" rx="2"/>
                            <path d="M7 15h0M2 9h20"/>
                        </svg>
                        <p>Plaid integration is not configured</p>
                        <p style="font-size: 0.8125rem;">Contact your administrator to enable account linking</p>
                    </div>
                `;
                return;
            }

            loadPlaidConnections();
        }

        async function loadPlaidConnections() {
            if (!authToken || !plaidAvailable) return;

            const container = document.getElementById('plaidConnections');

            try {
                const res = await fetch(`${API_URL}/plaid/connections`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (!res.ok) {
                    container.innerHTML = '<div class="empty-state">Failed to load connections</div>';
                    return;
                }

                const data = await res.json();
                const connections = data.connections || [];

                if (connections.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <p>No accounts connected yet</p>
                            <p style="font-size: 0.8125rem;">Link your brokerage to automatically import holdings</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = connections.map(c => `
                    <div class="plaid-connection">
                        <div class="plaid-connection-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="2" y="4" width="20" height="16" rx="2"/>
                                <path d="M7 15h0M2 9h20"/>
                            </svg>
                        </div>
                        <div class="plaid-connection-info">
                            <div class="plaid-connection-name">${escapeHtml(c.institution_name || 'Connected Account')}</div>
                            <div class="plaid-connection-meta">
                                Last synced: ${c.last_synced ? new Date(c.last_synced).toLocaleString() : 'Never'}
                            </div>
                        </div>
                        <div class="plaid-connection-actions">
                            <button class="btn btn-secondary" onclick="syncPlaidConnection(${c.id})">
                                Sync
                            </button>
                            <button class="portfolio-action-btn delete" onclick="disconnectPlaidAccount(${c.id})" title="Disconnect">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                `).join('');

            } catch (err) {
                container.innerHTML = '<div class="empty-state">Failed to load connections</div>';
            }
        }

        async function connectPlaidAccount() {
            if (!authToken) {
                showAuthModal();
                return;
            }

            if (!plaidAvailable) {
                showError('Plaid integration is not available');
                return;
            }

            try {
                // Get link token from backend
                const res = await fetch(`${API_URL}/plaid/create-link-token`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (!res.ok) {
                    const data = await res.json();
                    showError(data.error || 'Failed to initialize Plaid');
                    return;
                }

                const data = await res.json();
                const linkToken = data.link_token;

                // Initialize Plaid Link
                plaidHandler = Plaid.create({
                    token: linkToken,
                    onSuccess: async (publicToken, metadata) => {
                        await exchangePlaidToken(publicToken, metadata);
                    },
                    onExit: (err, metadata) => {
                        if (err) {
                            console.error('Plaid Link error:', err);
                        }
                    },
                    onEvent: (eventName, metadata) => {
                        console.log('Plaid event:', eventName);
                    }
                });

                plaidHandler.open();

            } catch (err) {
                showError('Failed to connect account: ' + err.message);
            }
        }

        async function exchangePlaidToken(publicToken, metadata) {
            try {
                const res = await fetch(`${API_URL}/plaid/exchange-token`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        public_token: publicToken,
                        institution_name: metadata.institution?.name || '',
                        institution_id: metadata.institution?.institution_id || ''
                    })
                });

                if (!res.ok) {
                    const data = await res.json();
                    showError(data.error || 'Failed to connect account');
                    return;
                }

                // Reload connections
                loadPlaidConnections();

            } catch (err) {
                showError('Failed to connect account: ' + err.message);
            }
        }

        async function syncPlaidConnection(connectionId) {
            showProgress('Syncing account...');

            try {
                const res = await fetch(`${API_URL}/plaid/connections/${connectionId}/sync`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (!res.ok) {
                    const data = await res.json();
                    hideProgress();
                    showError(data.error || 'Sync failed');
                    return;
                }

                const data = await res.json();
                hideProgress();

                if (data.positions && data.positions.length > 0) {
                    // Add as an account
                    accounts.push({
                        id: Date.now() + Math.random(),
                        name: data.connection.institution_name || 'Plaid Account',
                        positions: data.positions,
                        brokerage: 'plaid',
                        totalValue: data.positions.reduce((s, p) => s + (p.value || 0), 0)
                    });
                    renderAccounts();
                    loadPlaidConnections();
                } else {
                    showError('No holdings found in this account');
                }

            } catch (err) {
                hideProgress();
                showError('Sync failed: ' + err.message);
            }
        }

        async function disconnectPlaidAccount(connectionId) {
            if (!confirm('Are you sure you want to disconnect this account?')) {
                return;
            }

            try {
                const res = await fetch(`${API_URL}/plaid/connections/${connectionId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (!res.ok) {
                    const data = await res.json();
                    showError(data.error || 'Failed to disconnect');
                    return;
                }

                loadPlaidConnections();

            } catch (err) {
                showError('Failed to disconnect: ' + err.message);
            }
        }

        // Initialize auth check and Plaid status
        checkAuth();
        checkPlaidStatus();

        // Check for password reset token in URL
        const urlParams = new URLSearchParams(window.location.search);
        const resetTokenFromUrl = urlParams.get('reset_token');
        if (resetTokenFromUrl) {
            showResetPasswordModal(resetTokenFromUrl);
        }

        // DOM Elements
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const accountsSection = document.getElementById('accountsSection');
        const accountsList = document.getElementById('accountsList');
        const addMoreBtn = document.getElementById('addMoreBtn');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const clearAllBtn = document.getElementById('clearAllBtn');
        const progressSection = document.getElementById('progressSection');
        const progressText = document.getElementById('progressText');
        const dashboard = document.getElementById('dashboard');
        const errorMessage = document.getElementById('errorMessage');
        const uploadSection = document.getElementById('uploadSection');

        // Event Listeners
        dropZone.addEventListener('click', (e) => {
            if (e.target.closest('button')) return;
            fileInput.click();
        });
        addMoreBtn.addEventListener('click', () => fileInput.click());

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });

        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
            fileInput.value = '';
        });

        analyzeBtn.addEventListener('click', analyzePortfolio);
        clearAllBtn.addEventListener('click', () => { accounts = []; renderAccounts(); });
        document.getElementById('newAnalysisBtn').addEventListener('click', resetUI);
        document.getElementById('downloadPdfBtn').addEventListener('click', downloadPDF);
        document.getElementById('downloadCsvBtn').addEventListener('click', downloadCSV);
        document.getElementById('savePortfolioBtn').addEventListener('click', showSaveModal);

        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
            });
        });

        async function handleFiles(files) {
            const validFiles = Array.from(files).filter(file => {
                const ext = file.name.split('.').pop().toLowerCase();
                return ['pdf', 'csv'].includes(ext);
            });

            if (validFiles.length === 0) {
                showError('Please select PDF or CSV files');
                return;
            }

            // Show upload queue for multiple files
            const queue = document.getElementById('uploadQueue');
            const queueList = document.getElementById('uploadQueueList');
            const queueTitle = document.getElementById('uploadQueueTitle');
            const queueCount = document.getElementById('uploadQueueCount');

            if (validFiles.length > 1) {
                queue.style.display = 'block';
                queueTitle.textContent = 'Processing files...';
                queueCount.textContent = `0 / ${validFiles.length}`;

                // Initialize queue items
                queueList.innerHTML = validFiles.map((file, i) => `
                    <div class="upload-queue-item" id="queueItem${i}">
                        <div class="upload-file-icon" id="queueIcon${i}">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                <polyline points="14 2 14 8 20 8"/>
                            </svg>
                        </div>
                        <div class="upload-file-info">
                            <div class="upload-file-name">${file.name}</div>
                            <div class="upload-file-status" id="queueStatus${i}">Waiting...</div>
                        </div>
                    </div>
                `).join('');
            }

            // Process all files in parallel
            let completed = 0;
            let successful = 0;

            const processFile = async (file, index) => {
                const iconEl = document.getElementById(`queueIcon${index}`);
                const statusEl = document.getElementById(`queueStatus${index}`);

                if (validFiles.length > 1) {
                    iconEl?.classList.add('processing');
                    if (statusEl) statusEl.textContent = 'Processing...';
                } else {
                    showProgress(`Parsing ${file.name}...`);
                }

                try {
                    const result = await parseFile(file);

                    if (result.error && !result.positions?.length) {
                        if (validFiles.length > 1) {
                            iconEl?.classList.remove('processing');
                            iconEl?.classList.add('error');
                            if (statusEl) {
                                statusEl.textContent = result.error;
                                statusEl.classList.add('error');
                            }
                        } else {
                            hideProgress();
                            showError(`${file.name}: ${result.error}`);
                        }
                        return { success: false };
                    }

                    accounts.push({
                        id: Date.now() + Math.random(),
                        name: getBrokerageName(result.brokerage),
                        positions: result.positions,
                        brokerage: result.brokerage,
                        totalValue: result.positions.reduce((s, p) => s + (p.value || 0), 0)
                    });

                    if (validFiles.length > 1) {
                        iconEl?.classList.remove('processing');
                        iconEl?.classList.add('success');
                        if (iconEl) {
                            iconEl.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="20 6 9 17 4 12"/>
                            </svg>`;
                        }
                        if (statusEl) {
                            statusEl.textContent = `${result.positions.length} positions found`;
                            statusEl.classList.add('success');
                        }
                    }

                    return { success: true };
                } catch (err) {
                    if (validFiles.length > 1) {
                        iconEl?.classList.remove('processing');
                        iconEl?.classList.add('error');
                        if (iconEl) {
                            iconEl.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <line x1="15" y1="9" x2="9" y2="15"/>
                                <line x1="9" y1="9" x2="15" y2="15"/>
                            </svg>`;
                        }
                        if (statusEl) {
                            statusEl.textContent = err.message;
                            statusEl.classList.add('error');
                        }
                    } else {
                        hideProgress();
                        showError(`${file.name}: ${err.message}`);
                    }
                    return { success: false };
                }
            };

            // Process files in parallel (max 3 concurrent)
            const results = [];
            const concurrency = 3;

            for (let i = 0; i < validFiles.length; i += concurrency) {
                const batch = validFiles.slice(i, i + concurrency);
                const batchResults = await Promise.all(
                    batch.map((file, j) => processFile(file, i + j))
                );
                results.push(...batchResults);

                completed += batch.length;
                successful += batchResults.filter(r => r.success).length;

                if (validFiles.length > 1) {
                    queueCount.textContent = `${completed} / ${validFiles.length}`;
                }
            }

            // Finish up
            if (validFiles.length > 1) {
                queueTitle.textContent = 'Upload complete';

                // Auto-hide queue after delay if all successful
                if (successful === validFiles.length) {
                    setTimeout(() => {
                        queue.style.display = 'none';
                    }, 2000);
                }
            } else {
                hideProgress();
            }

            hideError();
            renderAccounts();
        }

        function getBrokerageName(brokerage) {
            const names = { schwab: 'Schwab', fidelity: 'Fidelity', vanguard: 'Vanguard', csv: 'Account' };
            const base = names[brokerage] || 'Account';
            const count = accounts.filter(a => a.name.startsWith(base)).length + 1;
            return count > 1 ? `${base} ${count}` : base;
        }

        async function parseFile(file) {
            const formData = new FormData();
            formData.append('file', file);
            const res = await fetch(`${API_URL}/parse`, { method: 'POST', body: formData });
            return res.json();
        }

        function renderAccounts() {
            accountsSection.style.display = accounts.length ? 'block' : 'none';
            analyzeBtn.disabled = !accounts.length;
            accountsList.innerHTML = accounts.map(a => `
                <div class="account-item">
                    <div class="account-icon">${a.brokerage[0].toUpperCase()}</div>
                    <div class="account-details">
                        <input type="text" class="account-name-input" value="${a.name}" onchange="updateName(${a.id}, this.value)">
                        <div class="account-meta">${a.positions.length} positions</div>
                    </div>
                    <div class="account-value">${formatCurrency(a.totalValue)}</div>
                    <button class="remove-btn" onclick="removeAccount(${a.id})">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                </div>
            `).join('');
        }

        function updateName(id, name) {
            const acc = accounts.find(a => a.id === id);
            if (acc) acc.name = name;
        }

        function removeAccount(id) {
            accounts = accounts.filter(a => a.id !== id);
            renderAccounts();
        }

        function aggregatePositions() {
            const agg = {};
            accounts.forEach(acc => {
                acc.positions.forEach(pos => {
                    if (!agg[pos.symbol]) agg[pos.symbol] = { ...pos, shares: 0, value: 0 };
                    agg[pos.symbol].shares += pos.shares || 0;
                    agg[pos.symbol].value += pos.value || 0;
                    if (!agg[pos.symbol].description && pos.description) agg[pos.symbol].description = pos.description;
                });
            });
            Object.values(agg).forEach(p => { if (p.shares > 0) p.price = p.value / p.shares; });
            return Object.values(agg);
        }

        async function analyzePortfolio() {
            if (!accounts.length) return;
            showProgress('Analyzing portfolio...');
            try {
                const res = await fetch(`${API_URL}/analyze`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ positions: aggregatePositions(), include_risk: true })
                });
                if (!res.ok) throw new Error('Analysis failed');
                portfolioData = await res.json();
                hideProgress();
                hideError();
                showDashboard();
            } catch (err) {
                hideProgress();
                showError('Analysis failed: ' + err.message);
            }
        }

        function showDashboard() {
            uploadSection.style.display = 'none';
            dashboard.style.display = 'block';
            document.getElementById('totalBadge').textContent = formatCurrency(portfolioData.total_value);
            renderAllocation();
            renderInsights();
            renderPerformance();
            renderSectors();
            renderGeography();
            renderRisk();
            renderHoldings();
            updateCompareSelectors();
            initWhatIf();
        }

        function renderInsights() {
            const container = document.getElementById('insightsList');
            const insights = portfolioData.insights || [];

            if (!insights.length) {
                container.innerHTML = `
                    <div class="no-insights">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <circle cx="12" cy="12" r="10"/>
                            <path d="M12 16v-4M12 8h.01"/>
                        </svg>
                        <p>No insights available for this portfolio.</p>
                    </div>
                `;
                return;
            }

            const getIcon = (type, category) => {
                if (type === 'warning') return '';
                if (type === 'positive') return '';
                // Category-based icons for info type
                const categoryIcons = {
                    'Portfolio Size': '',
                    'Asset Allocation': '',
                    'Concentration': '',
                    'Sectors': '',
                    'Geography': '',
                    'Risk': '',
                    'Projections': '',
                    'Diversification': ''
                };
                return categoryIcons[category] || '';
            };

            container.innerHTML = insights.map(insight => `
                <div class="insight-card insight-${insight.type || 'info'}">
                    <div class="insight-header">
                        <div class="insight-icon">${getIcon(insight.type, insight.category)}</div>
                        <span class="insight-category">${insight.category || 'Insight'}</span>
                    </div>
                    <div class="insight-title">${insight.title}</div>
                    <div class="insight-text">${insight.text}</div>
                </div>
            `).join('');
        }

        function renderAllocation() {
            const alloc = portfolioData.asset_allocation || {};
            const vals = portfolioData.asset_allocation_values || {};
            const stocks = alloc.Stocks || 0;
            const bonds = alloc.Bonds || 0;
            const cash = alloc.Cash || 0;
            const alts = (alloc['Real Estate'] || 0) + (alloc.Crypto || 0) + (alloc.Commodities || 0);

            document.getElementById('stocksPct').textContent = stocks.toFixed(1) + '%';
            document.getElementById('bondsPct').textContent = bonds.toFixed(1) + '%';
            document.getElementById('cashPct').textContent = cash.toFixed(1) + '%';
            document.getElementById('altsPct').textContent = alts.toFixed(1) + '%';
            document.getElementById('stocksVal').textContent = formatCurrency(vals.Stocks || 0);
            document.getElementById('bondsVal').textContent = formatCurrency(vals.Bonds || 0);
            document.getElementById('cashVal').textContent = formatCurrency(vals.Cash || 0);
            document.getElementById('altsVal').textContent = formatCurrency((vals['Real Estate'] || 0) + (vals.Crypto || 0) + (vals.Commodities || 0));

            renderDoughnut('allocationChart', alloc, {
                Stocks: '#635bff', Bonds: '#30d158', Cash: '#ffd60a',
                'Real Estate': '#bf5af2', Crypto: '#ff9f0a', Commodities: '#64d2ff'
            });

            const subClass = portfolioData.sub_class_allocation || {};
            renderSubClassChart('subClassChart', subClass, portfolioData.positions || []);
        }

        // Map sub-classes to their parent asset class
        function getAssetClassForSubClass(subClassName, positions) {
            // Find a position with this sub-class to get the asset class
            for (const pos of positions) {
                if (pos.classification && pos.classification.sub_class === subClassName) {
                    return pos.classification.asset_class;
                }
            }
            // Fallback mapping
            const subClassMap = {
                'US Total Market': 'Stocks', 'US Large Cap': 'Stocks', 'US Large Cap Growth': 'Stocks',
                'US Large Cap Value': 'Stocks', 'US Mid Cap': 'Stocks', 'US Mid Cap Growth': 'Stocks',
                'US Mid Cap Value': 'Stocks', 'US Small Cap': 'Stocks', 'US Small Cap Growth': 'Stocks',
                'US Small Cap Value': 'Stocks', 'US Mega Cap': 'Stocks', 'US Dividend': 'Stocks',
                'US Dividend Growth': 'Stocks', 'US High Dividend': 'Stocks',
                'International Developed': 'Stocks', 'International Total': 'Stocks',
                'International Small Cap': 'Stocks', 'International Dividend': 'Stocks',
                'Emerging Markets': 'Stocks', 'Europe': 'Stocks', 'Pacific': 'Stocks',
                'Japan': 'Stocks', 'China': 'Stocks', 'India': 'Stocks', 'Brazil': 'Stocks',
                'Global': 'Stocks', 'Germany': 'Stocks', 'UK': 'Stocks', 'Canada': 'Stocks',
                'Australia': 'Stocks', 'Taiwan': 'Stocks', 'South Korea': 'Stocks', 'MLPs': 'Stocks',
                'US Treasury': 'Bonds', 'TIPS': 'Bonds', 'US Aggregate': 'Bonds',
                'Short-Term Bond': 'Bonds', 'Intermediate Bond': 'Bonds', 'Long-Term Bond': 'Bonds',
                'Investment Grade Corp': 'Bonds', 'High Yield': 'Bonds', 'Municipal': 'Bonds',
                'Mortgage-Backed': 'Bonds', 'International Developed': 'Bonds',
                'International Aggregate': 'Bonds', 'International Treasury': 'Bonds',
                'Cash': 'Cash', 'Money Market': 'Cash',
                'US REITs': 'Real Estate', 'International REITs': 'Real Estate',
                'Bitcoin': 'Crypto', 'Ethereum': 'Crypto', 'DeFi': 'Crypto',
                'Gold': 'Commodities', 'Silver': 'Commodities', 'Platinum': 'Commodities',
                'Palladium': 'Commodities', 'Broad Commodities': 'Commodities',
                'Oil': 'Commodities', 'Natural Gas': 'Commodities', 'Agriculture': 'Commodities'
            };
            return subClassMap[subClassName] || 'Stocks';
        }

        function generateShades(baseColor, count) {
            // Convert hex to HSL, then generate shades
            const hex = baseColor.replace('#', '');
            const r = parseInt(hex.substr(0, 2), 16) / 255;
            const g = parseInt(hex.substr(2, 2), 16) / 255;
            const b = parseInt(hex.substr(4, 2), 16) / 255;

            const max = Math.max(r, g, b), min = Math.min(r, g, b);
            let h, s, l = (max + min) / 2;

            if (max === min) {
                h = s = 0;
            } else {
                const d = max - min;
                s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                switch (max) {
                    case r: h = ((g - b) / d + (g < b ? 6 : 0)) / 6; break;
                    case g: h = ((b - r) / d + 2) / 6; break;
                    case b: h = ((r - g) / d + 4) / 6; break;
                }
            }

            // Base color is darkest, then get progressively lighter
            const shades = [];
            const maxL = Math.min(0.9, l + 0.45); // How light the lightest shade can be
            const step = count > 1 ? (maxL - l) / (count - 1) : 0;

            for (let i = 0; i < count; i++) {
                const newL = l + (step * i); // Start at base color lightness, go lighter
                shades.push(hslToHex(h, s, newL));
            }
            return shades;
        }

        function hslToHex(h, s, l) {
            let r, g, b;
            if (s === 0) {
                r = g = b = l;
            } else {
                const hue2rgb = (p, q, t) => {
                    if (t < 0) t += 1;
                    if (t > 1) t -= 1;
                    if (t < 1/6) return p + (q - p) * 6 * t;
                    if (t < 1/2) return q;
                    if (t < 2/3) return p + (q - p) * (2/3 - t) * 6;
                    return p;
                };
                const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
                const p = 2 * l - q;
                r = hue2rgb(p, q, h + 1/3);
                g = hue2rgb(p, q, h);
                b = hue2rgb(p, q, h - 1/3);
            }
            const toHex = x => {
                const hex = Math.round(x * 255).toString(16);
                return hex.length === 1 ? '0' + hex : hex;
            };
            return `#${toHex(r)}${toHex(g)}${toHex(b)}`;
        }

        function renderSubClassChart(id, data, positions) {
            const ctx = document.getElementById(id).getContext('2d');
            if (charts[id]) charts[id].destroy();

            const assetColors = {
                Stocks: '#635bff', Bonds: '#30d158', Cash: '#ffd60a',
                'Real Estate': '#bf5af2', Crypto: '#ff9f0a', Commodities: '#64d2ff'
            };

            // Group sub-classes by asset class
            const grouped = {};
            Object.keys(data).forEach(subClass => {
                if (data[subClass] <= 0) return;
                const assetClass = getAssetClassForSubClass(subClass, positions);
                if (!grouped[assetClass]) grouped[assetClass] = [];
                grouped[assetClass].push({ name: subClass, value: data[subClass] });
            });

            // Sort each group by value (descending) and generate colors
            const labels = [];
            const values = [];
            const colors = [];

            Object.keys(grouped).sort().forEach(assetClass => {
                const items = grouped[assetClass].sort((a, b) => b.value - a.value);
                const baseColor = assetColors[assetClass] || '#8e8e93';
                const shades = generateShades(baseColor, items.length);

                items.forEach((item, idx) => {
                    labels.push(item.name);
                    values.push(item.value);
                    colors.push(shades[idx]); // Darkest first (highest allocation)
                });
            });

            charts[id] = new Chart(ctx, {
                type: 'doughnut',
                data: { labels, datasets: [{ data: values, backgroundColor: colors, borderWidth: 0 }] },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right', labels: { padding: 16, usePointStyle: true, font: { size: 12 } } },
                        tooltip: { callbacks: { label: ctx => `${ctx.label}: ${ctx.raw.toFixed(1)}%` } }
                    }
                }
            });
        }

        let fullChartData = null;
        let currentPeriod = '5Y';

        function renderPerformance() {
            const perf = portfolioData.historical_performance || {};
            let returns = perf.returns || {};
            const periods = ['1M', '3M', '6M', 'YTD', '1Y', '3Y', '5Y'];

            // Calculate returns from chart data if not provided by backend
            if (perf.chart_data && perf.chart_data.labels && perf.chart_data.portfolio) {
                const chartData = perf.chart_data;
                const labels = chartData.labels;
                const portfolio = chartData.portfolio;
                const benchmark = chartData.benchmark;
                const lastDate = new Date(labels[labels.length - 1]);
                const lastPortVal = portfolio[portfolio.length - 1];
                const lastBenchVal = benchmark ? benchmark[benchmark.length - 1] : null;

                // Helper to find return for a period
                function calcReturnFromChart(daysBack) {
                    const targetDate = new Date(lastDate);
                    targetDate.setDate(targetDate.getDate() - daysBack);

                    // Find the closest date at or before target
                    let idx = -1;
                    for (let i = labels.length - 1; i >= 0; i--) {
                        if (new Date(labels[i]) <= targetDate) {
                            idx = i;
                            break;
                        }
                    }
                    if (idx < 0) return { portfolio: null, benchmark: null };

                    const portReturn = ((lastPortVal / portfolio[idx]) - 1) * 100;
                    const benchReturn = benchmark ? ((lastBenchVal / benchmark[idx]) - 1) * 100 : null;
                    return { portfolio: portReturn, benchmark: benchReturn };
                }

                // Fill in missing period returns from chart data
                const periodDays = { '1M': 30, '3M': 90, '6M': 180, '1Y': 365, '3Y': 1095, '5Y': 1825 };
                for (const [period, days] of Object.entries(periodDays)) {
                    if (!returns[period] || returns[period].portfolio === null) {
                        const calc = calcReturnFromChart(days);
                        if (calc.portfolio !== null) {
                            returns[period] = calc;
                        }
                    }
                }

                // Calculate YTD if missing
                if (!returns['YTD'] || returns['YTD'].portfolio === null) {
                    const yearStart = new Date(lastDate.getFullYear(), 0, 1);
                    let idx = -1;
                    for (let i = 0; i < labels.length; i++) {
                        if (new Date(labels[i]) >= yearStart) {
                            idx = i;
                            break;
                        }
                    }
                    if (idx >= 0) {
                        const portReturn = ((lastPortVal / portfolio[idx]) - 1) * 100;
                        const benchReturn = benchmark ? ((lastBenchVal / benchmark[idx]) - 1) * 100 : null;
                        returns['YTD'] = { portfolio: portReturn, benchmark: benchReturn };
                    }
                }
            }

            document.getElementById('returnsGrid').innerHTML = periods.map(p => {
                const data = returns[p] || {};
                const val = data.portfolio;
                const bench = data.benchmark;
                const cls = val > 0 ? 'positive' : val < 0 ? 'negative' : '';
                return `
                    <div class="stat-card return-card" data-period="${p}">
                        <div class="stat-label">${p}</div>
                        <div class="stat-value ${cls}">${val !== null && val !== undefined ? (val > 0 ? '+' : '') + val.toFixed(2) + '%' : '--'}</div>
                        <div class="benchmark-label">S&P: ${bench !== null && bench !== undefined ? (bench > 0 ? '+' : '') + bench.toFixed(2) + '%' : '--'}</div>
                    </div>
                `;
            }).join('');

            // Store full chart data for filtering
            if (perf.chart_data) {
                fullChartData = perf.chart_data;
                renderLineChart(fullChartData, currentPeriod);
            }

            // Add click handlers for return cards
            document.querySelectorAll('.return-card').forEach(card => {
                card.addEventListener('click', () => {
                    const period = card.dataset.period;
                    selectPeriod(period);
                });
            });

            // Add click handlers for period buttons
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const period = btn.dataset.period;
                    selectPeriod(period);
                });
            });

            // Render projections chart
            renderProjections();
        }

        function selectPeriod(period) {
            currentPeriod = period;

            // Update period button states
            document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`.period-btn[data-period="${period}"]`)?.classList.add('active');

            // Update return card states
            document.querySelectorAll('.return-card').forEach(c => c.classList.remove('active'));
            document.querySelector(`.return-card[data-period="${period}"]`)?.classList.add('active');

            // Re-render chart with filtered data
            if (fullChartData) {
                renderLineChart(fullChartData, period);
            }
        }

        function filterChartDataByPeriod(data, period) {
            if (!data || !data.labels || !data.labels.length) return data;

            const now = new Date(data.labels[data.labels.length - 1]);
            let startDate = new Date(now);

            switch (period) {
                case '1M': startDate.setMonth(now.getMonth() - 1); break;
                case '3M': startDate.setMonth(now.getMonth() - 3); break;
                case '6M': startDate.setMonth(now.getMonth() - 6); break;
                case 'YTD': startDate = new Date(now.getFullYear(), 0, 1); break;
                case '1Y': startDate.setFullYear(now.getFullYear() - 1); break;
                case '3Y': startDate.setFullYear(now.getFullYear() - 3); break;
                case '5Y':
                default: return data; // Return full data for 5Y
            }

            const startIdx = data.labels.findIndex(d => new Date(d) >= startDate);
            if (startIdx === -1) return data;

            const filteredLabels = data.labels.slice(startIdx);
            const filteredPortfolio = data.portfolio.slice(startIdx);

            // Normalize portfolio
            const portfolioStart = filteredPortfolio[0] || 100;
            const result = {
                labels: filteredLabels,
                portfolio: filteredPortfolio.map(v => (v / portfolioStart) * 100)
            };

            // Handle multiple benchmarks
            const benchmarkKeys = ['sp500', 'bonds', 'world', 'sixty_forty', 'benchmark'];
            benchmarkKeys.forEach(key => {
                if (data[key]) {
                    const filtered = data[key].slice(startIdx);
                    const start = filtered[0] || 100;
                    result[key] = filtered.map(v => v !== null ? (v / start) * 100 : null);
                }
            });

            return result;
        }

        // Track which benchmarks are visible
        let visibleBenchmarks = { sp500: true, bonds: false, world: false, sixty_forty: false };

        function toggleBenchmark(key, checked) {
            visibleBenchmarks[key] = checked;
            if (fullChartData) {
                renderLineChart(fullChartData, currentPeriod);
            }
        }

        function renderProjections() {
            const projections = portfolioData.projections;
            if (!projections || !projections.monte_carlo) {
                document.getElementById('projectionsInfo').innerHTML = '<p style="color: var(--text-secondary);">Projections require more data</p>';
                return;
            }

            const mc = projections.monte_carlo;
            const cma = projections.capital_market_assumptions || {};
            const totalValue = portfolioData.total_value || 100000;
            const summary = mc.summary || {};

            // Render summary info cards
            const expectedReturn = cma.expected_annual_return || 0;
            const expectedVol = cma.expected_volatility || 0;
            const infoHtml = `
                <div class="stat-card">
                    <div class="stat-label">Expected Return</div>
                    <div class="stat-value ${expectedReturn >= 0 ? 'positive' : ''}">${expectedReturn.toFixed(1)}%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Expected Volatility</div>
                    <div class="stat-value">${expectedVol.toFixed(1)}%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Median 10Y Outcome</div>
                    <div class="stat-value">${formatCurrency(summary.median || 0)}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Best Case (95th)</div>
                    <div class="stat-value positive">${formatCurrency(summary.p95 || 0)}</div>
                </div>
            `;
            document.getElementById('projectionsInfo').innerHTML = infoHtml;

            // Render projections chart with confidence bands
            const ctx = document.getElementById('projectionsChart').getContext('2d');
            if (charts.projectionsChart) charts.projectionsChart.destroy();

            const projData = mc.projection_data || {};
            const percentiles = projData.percentiles || {};
            const years = projData.labels || Array.from({length: 11}, (_, i) => `Year ${i}`);
            const p5 = percentiles.p5 || [];
            const p25 = percentiles.p25 || [];
            const p50 = percentiles.p50 || [];
            const p75 = percentiles.p75 || [];
            const p95 = percentiles.p95 || [];

            charts.projectionsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: years,
                    datasets: [
                        {
                            label: '95th Percentile',
                            data: p95,
                            borderColor: 'rgba(48, 209, 88, 0.3)',
                            backgroundColor: 'transparent',
                            borderWidth: 1,
                            borderDash: [3, 3],
                            pointRadius: 0,
                            tension: 0.3
                        },
                        {
                            label: '75th Percentile',
                            data: p75,
                            borderColor: 'rgba(48, 209, 88, 0.6)',
                            backgroundColor: 'rgba(48, 209, 88, 0.1)',
                            borderWidth: 1.5,
                            fill: '+1',
                            pointRadius: 0,
                            tension: 0.3
                        },
                        {
                            label: 'Median (50th)',
                            data: p50,
                            borderColor: '#635bff',
                            backgroundColor: 'rgba(99, 91, 255, 0.15)',
                            borderWidth: 2.5,
                            fill: false,
                            pointRadius: 0,
                            pointHoverRadius: 6,
                            tension: 0.3
                        },
                        {
                            label: '25th Percentile',
                            data: p25,
                            borderColor: 'rgba(255, 159, 10, 0.6)',
                            backgroundColor: 'rgba(255, 159, 10, 0.1)',
                            borderWidth: 1.5,
                            fill: '-1',
                            pointRadius: 0,
                            tension: 0.3
                        },
                        {
                            label: '5th Percentile',
                            data: p5,
                            borderColor: 'rgba(255, 69, 58, 0.3)',
                            backgroundColor: 'transparent',
                            borderWidth: 1,
                            borderDash: [3, 3],
                            pointRadius: 0,
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { display: true, position: 'top', labels: { usePointStyle: true, padding: 15 } },
                        tooltip: {
                            backgroundColor: 'rgba(10, 37, 64, 0.95)',
                            titleFont: { size: 13, weight: '600' },
                            bodyFont: { size: 12 },
                            padding: 12,
                            cornerRadius: 8,
                            callbacks: {
                                label: ctx => `${ctx.dataset.label}: ${formatCurrency(ctx.raw)}`
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: '#e3e8ee', drawBorder: false },
                            ticks: { color: '#8898aa' }
                        },
                        y: {
                            grid: { color: '#e3e8ee', drawBorder: false },
                            ticks: {
                                color: '#8898aa',
                                callback: v => formatCurrency(v)
                            }
                        }
                    }
                }
            });

            // Render Monte Carlo summary
            const medianValue = summary.median || totalValue;
            const growthRate = Math.pow(medianValue / totalValue, 1/10) - 1;
            const probGain = summary.prob_gain !== undefined ? summary.prob_gain.toFixed(0) : '--';
            const probDouble = summary.prob_double !== undefined ? summary.prob_double.toFixed(0) : '--';
            const summaryHtml = `
                <div class="monte-carlo-grid">
                    <div class="monte-carlo-item">
                        <div class="monte-carlo-label">Simulations Run</div>
                        <div class="monte-carlo-value">${(mc.simulations || 1000).toLocaleString()}</div>
                    </div>
                    <div class="monte-carlo-item">
                        <div class="monte-carlo-label">Starting Value</div>
                        <div class="monte-carlo-value">${formatCurrency(mc.starting_value || totalValue)}</div>
                    </div>
                    <div class="monte-carlo-item">
                        <div class="monte-carlo-label">Worst Case (5th)</div>
                        <div class="monte-carlo-value">${formatCurrency(summary.p5 || 0)}</div>
                    </div>
                    <div class="monte-carlo-item">
                        <div class="monte-carlo-label">Probability of Gain</div>
                        <div class="monte-carlo-value positive">${probGain}%</div>
                    </div>
                    <div class="monte-carlo-item">
                        <div class="monte-carlo-label">Implied CAGR (Median)</div>
                        <div class="monte-carlo-value highlight">${(growthRate * 100).toFixed(1)}%</div>
                    </div>
                    <div class="monte-carlo-item">
                        <div class="monte-carlo-label">Chance to Double</div>
                        <div class="monte-carlo-value">${probDouble}%</div>
                    </div>
                </div>
            `;
            document.getElementById('monteCarloSummary').innerHTML = summaryHtml;
        }

        function renderLineChart(data, period = '5Y') {
            const ctx = document.getElementById('performanceChart').getContext('2d');
            if (charts.performanceChart) charts.performanceChart.destroy();

            const filteredData = filterChartDataByPeriod(data, period);

            // Downsample for performance
            const maxPoints = 150;
            const step = Math.max(1, Math.floor(filteredData.labels.length / maxPoints));
            const labels = filteredData.labels.filter((_, i) => i % step === 0);
            const portfolio = filteredData.portfolio.filter((_, i) => i % step === 0);

            // Benchmark configurations
            const benchmarkConfigs = {
                sp500: { label: 'S&P 500', color: '#8898aa', dash: [5, 5] },
                bonds: { label: 'US Bonds', color: '#30d158', dash: [3, 3] },
                world: { label: 'Total World', color: '#ff9f0a', dash: [8, 4] },
                sixty_forty: { label: '60/40', color: '#bf5af2', dash: [2, 2] }
            };

            // Build datasets
            const datasets = [{
                label: 'Portfolio', data: portfolio,
                borderColor: '#635bff', backgroundColor: 'rgba(99,91,255,0.1)',
                borderWidth: 2.5, fill: true, tension: 0.3,
                pointRadius: 0, pointHoverRadius: 6, pointHoverBackgroundColor: '#635bff'
            }];

            // Add visible benchmarks
            Object.entries(benchmarkConfigs).forEach(([key, config]) => {
                if (visibleBenchmarks[key] && filteredData[key]) {
                    const bmData = filteredData[key].filter((_, i) => i % step === 0);
                    datasets.push({
                        label: config.label, data: bmData,
                        borderColor: config.color, backgroundColor: 'transparent',
                        borderWidth: 2, borderDash: config.dash, fill: false, tension: 0.3,
                        pointRadius: 0, pointHoverRadius: 5, pointHoverBackgroundColor: config.color
                    });
                }
            });

            charts.performanceChart = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: { display: true, position: 'top', labels: { usePointStyle: true, padding: 20 } },
                        tooltip: {
                            enabled: true,
                            backgroundColor: 'rgba(10, 37, 64, 0.95)',
                            titleFont: { size: 13, weight: '600' },
                            bodyFont: { size: 12 },
                            padding: 12,
                            cornerRadius: 8,
                            displayColors: true,
                            callbacks: {
                                title: (items) => {
                                    const date = new Date(items[0].label);
                                    return date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
                                },
                                label: ctx => {
                                    const change = ctx.raw - 100;
                                    const sign = change >= 0 ? '+' : '';
                                    return `${ctx.dataset.label}: ${sign}${change.toFixed(2)}%`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: '#e3e8ee', drawBorder: false },
                            ticks: {
                                color: '#8898aa',
                                maxTicksLimit: 8,
                                callback: (v) => {
                                    const d = new Date(labels[v]);
                                    // Use more granular format for shorter periods
                                    if (period === '1M') {
                                        return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                                    } else if (period === '3M' || period === 'YTD') {
                                        return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                                    } else if (period === '6M' || period === '1Y') {
                                        return d.toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
                                    } else {
                                        return d.toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
                                    }
                                }
                            }
                        },
                        y: {
                            grid: { color: '#e3e8ee', drawBorder: false },
                            ticks: {
                                color: '#8898aa',
                                callback: (v) => (v - 100 >= 0 ? '+' : '') + (v - 100).toFixed(0) + '%'
                            }
                        }
                    }
                }
            });
        }

        function renderSectors() {
            const sectors = portfolioData.sector_exposure || {};
            const benchmark = portfolioData.sector_benchmark || {};
            const all = [...new Set([...Object.keys(sectors), ...Object.keys(benchmark)])].sort((a, b) => (sectors[b] || 0) - (sectors[a] || 0));

            document.getElementById('sectorList').innerHTML = all.map(s => {
                const p = sectors[s] || 0;
                const b = (benchmark[s] || 0) * 100;
                const max = Math.max(p, b, 30);
                return `
                    <div class="sector-item">
                        <div class="sector-name">${s}</div>
                        <div class="sector-bar-container">
                            <div class="sector-bar benchmark" style="width: ${(b / max * 100)}%"></div>
                            <div class="sector-bar portfolio" style="width: ${(p / max * 100)}%"></div>
                        </div>
                        <div class="sector-pct portfolio">${p.toFixed(1)}%</div>
                        <div class="sector-pct benchmark">${b.toFixed(1)}%</div>
                    </div>
                `;
            }).join('');

            renderDoughnut('sectorChart', sectors);
        }

        function renderGeography() {
            const geo = portfolioData.geography || {};
            const us = geo.US || 0;
            const dev = (geo['Developed Markets'] || 0) + (geo.Europe || 0) + (geo.Japan || 0) + (geo['Asia Pacific'] || 0);
            const em = (geo['Emerging Markets'] || 0) + (geo.China || 0) + (geo['Latin America'] || 0);

            document.getElementById('usPct').textContent = us.toFixed(1) + '%';
            document.getElementById('devPct').textContent = dev.toFixed(1) + '%';
            document.getElementById('emPct').textContent = em.toFixed(1) + '%';

            // Update map legend percentages
            document.getElementById('usMapPct').textContent = us.toFixed(0) + '%';
            document.getElementById('devMapPct').textContent = dev.toFixed(0) + '%';
            document.getElementById('emMapPct').textContent = em.toFixed(0) + '%';

            renderWorldMap(us, dev, em);
            renderDoughnut('geoChart', geo, {
                US: '#635bff', 'Developed Markets': '#a5b4fc', 'Emerging Markets': '#fbbf24',
                Europe: '#a78bfa', 'Asia Pacific': '#c4b5fd', Global: '#64d2ff',
                International: '#818cf8', Japan: '#6366f1', China: '#ef4444'
            });
        }

        async function renderWorldMap(us, dev, em) {
            const container = document.getElementById('worldMapContainer');
            container.innerHTML = '';

            // Country classifications
            const usCountries = ['United States of America', 'USA', 'United States'];
            const developedCountries = ['Canada', 'United Kingdom', 'Germany', 'France', 'Japan', 'Australia', 'New Zealand', 'Italy', 'Spain', 'Portugal', 'Netherlands', 'Belgium', 'Switzerland', 'Austria', 'Sweden', 'Norway', 'Denmark', 'Finland', 'Ireland', 'Singapore', 'Israel', 'South Korea', 'Luxembourg', 'Iceland'];
            const emergingCountries = ['China', 'India', 'Brazil', 'Mexico', 'Russia', 'South Africa', 'Indonesia', 'Turkey', 'Thailand', 'Malaysia', 'Philippines', 'Vietnam', 'Poland', 'Czech Republic', 'Czechia', 'Hungary', 'Chile', 'Colombia', 'Peru', 'Argentina', 'Taiwan', 'Saudi Arabia', 'United Arab Emirates', 'Qatar', 'Kuwait', 'Egypt', 'Pakistan', 'Bangladesh', 'Nigeria', 'Greece'];

            function getCountryClass(name) {
                if (us > 5 && usCountries.some(c => name.includes(c) || c.includes(name))) return 'country us';
                if (dev > 5 && developedCountries.some(c => name.includes(c) || c.includes(name))) return 'country developed';
                if (em > 5 && emergingCountries.some(c => name.includes(c) || c.includes(name))) return 'country emerging';
                return 'country';
            }

            try {
                // Fetch world topology data
                const response = await fetch('https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json');
                const world = await response.json();

                const width = 900;
                const height = 450;

                const svg = d3.select(container)
                    .append('svg')
                    .attr('viewBox', `0 0 ${width} ${height}`)
                    .attr('preserveAspectRatio', 'xMidYMid meet');

                const projection = d3.geoNaturalEarth1()
                    .scale(170)
                    .translate([width / 2, height / 2]);

                const path = d3.geoPath().projection(projection);

                const countries = topojson.feature(world, world.objects.countries);

                svg.selectAll('path')
                    .data(countries.features)
                    .enter()
                    .append('path')
                    .attr('d', path)
                    .attr('class', d => getCountryClass(d.properties.name || ''))
                    .append('title')
                    .text(d => d.properties.name || '');

            } catch (error) {
                console.error('Failed to load map:', error);
                container.innerHTML = '<p style="text-align:center;color:#8898aa;padding:40px;">Map unavailable</p>';
            }
        }

        function renderRisk() {
            const risk = portfolioData.risk_metrics || {};
            const conc = portfolioData.concentration || {};
            const scenarios = portfolioData.scenario_analysis?.scenarios || [];

            document.getElementById('volatilityVal').textContent = risk.volatility !== null ? risk.volatility.toFixed(1) + '%' : '--';
            document.getElementById('betaVal').textContent = risk.beta !== null ? risk.beta.toFixed(2) : '--';
            document.getElementById('sharpeVal').textContent = risk.sharpe_ratio !== null ? risk.sharpe_ratio.toFixed(2) : '--';
            document.getElementById('maxDdVal').textContent = risk.max_drawdown !== null ? risk.max_drawdown.toFixed(1) + '%' : '--';

            document.getElementById('top10Pct').textContent = (conc.top_10_pct || 0).toFixed(1) + '%';
            document.getElementById('topHoldingsList').innerHTML = (conc.top_10_holdings || []).map((h, i) => `
                <div class="holding-item">
                    <div class="holding-rank">${i + 1}</div>
                    <div class="holding-info"><div class="holding-symbol">${h.symbol}</div></div>
                    <div class="holding-values">
                        <div class="holding-amount">${formatCurrency(h.value)}</div>
                        <div class="holding-pct">${h.pct.toFixed(1)}%</div>
                    </div>
                </div>
            `).join('');

            document.getElementById('scenariosList').innerHTML = scenarios.map(s => {
                const isPositive = s.portfolio_impact >= 0;
                const barWidth = Math.min(Math.abs(s.portfolio_impact) * 2, 100);
                return `
                    <div class="scenario-card">
                        <div class="scenario-info">
                            <h4>${s.name}</h4>
                            <p>${s.description}</p>
                        </div>
                        <div class="scenario-impact">
                            <div class="scenario-pct ${isPositive ? 'positive' : 'negative'}">${isPositive ? '+' : ''}${s.portfolio_impact.toFixed(1)}%</div>
                            <div class="scenario-value">${formatCurrency(s.value_change)}</div>
                        </div>
                        <div class="scenario-bar-container">
                            <div class="scenario-bar ${isPositive ? 'positive' : 'negative'}" style="width: ${barWidth}%"></div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderHoldings() {
            const positions = portfolioData.positions || [];
            const total = portfolioData.total_value || 0;
            const sorted = [...positions].sort((a, b) => (b.value || 0) - (a.value || 0));

            document.getElementById('holdingsBody').innerHTML = sorted.map(p => {
                const cls = p.classification || {};
                const weight = total > 0 ? (p.value || 0) / total * 100 : 0;
                return `
                    <tr>
                        <td class="symbol-cell">${p.symbol}</td>
                        <td>${p.description || '-'}</td>
                        <td><span class="badge badge-primary">${cls.asset_class || 'Unknown'}</span></td>
                        <td><span class="badge badge-secondary">${cls.sector || 'Unknown'}</span></td>
                        <td class="text-right font-mono">${formatNumber(p.shares)}</td>
                        <td class="text-right font-mono">${formatCurrency(p.price)}</td>
                        <td class="text-right font-mono">${formatCurrency(p.value)}</td>
                        <td class="text-right font-mono">${weight.toFixed(2)}%</td>
                    </tr>
                `;
            }).join('') + `
                <tr class="total-row">
                    <td colspan="6" class="text-right">Total Portfolio Value</td>
                    <td class="text-right font-mono">${formatCurrency(total)}</td>
                    <td class="text-right font-mono">100%</td>
                </tr>
            `;
        }

        function renderDoughnut(id, data, colors = null) {
            const ctx = document.getElementById(id).getContext('2d');
            if (charts[id]) charts[id].destroy();

            const labels = Object.keys(data).filter(k => data[k] > 0);
            const values = labels.map(k => data[k]);
            const defaultColors = ['#635bff', '#30d158', '#ff9f0a', '#bf5af2', '#ff453a', '#64d2ff', '#ffd60a', '#8e8e93'];
            const bgColors = colors ? labels.map((l, i) => colors[l] || defaultColors[i % defaultColors.length]) : defaultColors;

            charts[id] = new Chart(ctx, {
                type: 'doughnut',
                data: { labels, datasets: [{ data: values, backgroundColor: bgColors, borderWidth: 0 }] },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right', labels: { padding: 16, usePointStyle: true, font: { size: 12 } } },
                        tooltip: { callbacks: { label: ctx => `${ctx.label}: ${ctx.raw.toFixed(1)}%` } }
                    }
                }
            });
        }

        async function downloadPDF() {
            if (!portfolioData) return;

            const btn = document.getElementById('downloadPdfBtn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = `
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="spin">
                    <circle cx="12" cy="12" r="10" stroke-dasharray="32" stroke-dashoffset="32"/>
                </svg>
                Generating...
            `;

            try {
                const response = await fetch(`${API_URL}/report/pdf`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(portfolioData)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to generate PDF');
                }

                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `portfolio-report-${new Date().toISOString().split('T')[0]}.pdf`;
                a.click();
                URL.revokeObjectURL(url);
                showToast('PDF report downloaded successfully!');
            } catch (err) {
                showError('Failed to generate PDF: ' + err.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        function downloadCSV() {
            if (!portfolioData?.positions) return;
            let csv = 'Symbol,Description,Asset Class,Sub Class,Sector,Geography,Shares,Price,Value,Weight\n';
            const total = portfolioData.total_value || 0;
            portfolioData.positions.forEach(p => {
                const c = p.classification || {};
                const w = total > 0 ? (p.value || 0) / total * 100 : 0;
                csv += [p.symbol, `"${(p.description || '').replace(/"/g, '""')}"`, c.asset_class || '', c.sub_class || '', c.sector || '', c.geography || '', p.shares || '', p.price || '', p.value || '', w.toFixed(2) + '%'].join(',') + '\n';
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'portfolio_analysis.csv';
            a.click();
        }

        function resetUI() {
            dashboard.style.display = 'none';
            uploadSection.style.display = 'block';
            portfolioData = null;
            Object.values(charts).forEach(c => c.destroy());
            charts = {};
        }

        function showProgress(text) {
            progressSection.style.display = 'block';
            progressText.textContent = text;
            uploadSection.style.display = 'none';
        }

        function hideProgress() {
            progressSection.style.display = 'none';
            uploadSection.style.display = 'block';
        }

        function showError(msg) {
            // Show error via toast notification system
            showToast(msg, 'error', { duration: 6000 });
            // Also keep static message for accessibility
            errorMessage.textContent = msg;
            errorMessage.style.display = 'block';
        }

        function hideError() {
            errorMessage.style.display = 'none';
        }

        function formatNumber(n) {
            return n == null ? '-' : n.toLocaleString('en-US', { maximumFractionDigits: 4 });
        }

        function formatCurrency(n) {
            return n == null ? '-' : '$' + n.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        // Entry Method Switching
        function switchEntryMethod(method) {
            // Update buttons
            document.querySelectorAll('.entry-method-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.method === method);
            });

            // Update panels
            document.querySelectorAll('.entry-panel').forEach(panel => {
                panel.classList.remove('active');
            });

            const panelMap = {
                'upload': 'uploadPanel',
                'manual': 'manualPanel',
                'connect': 'connectPanel'
            };
            document.getElementById(panelMap[method])?.classList.add('active');
        }

        // Manual Holdings Entry
        let manualHoldings = [];

        function addManualHolding() {
            const symbolInput = document.getElementById('manualSymbol');
            const sharesInput = document.getElementById('manualShares');
            const priceInput = document.getElementById('manualPrice');

            const symbol = symbolInput.value.trim().toUpperCase();
            const shares = parseFloat(sharesInput.value);
            const price = parseFloat(priceInput.value);

            if (!symbol) {
                symbolInput.focus();
                return;
            }
            if (isNaN(shares) || shares <= 0) {
                sharesInput.focus();
                return;
            }
            if (isNaN(price) || price <= 0) {
                priceInput.focus();
                return;
            }

            // Check for duplicate
            const existing = manualHoldings.findIndex(h => h.symbol === symbol);
            if (existing >= 0) {
                // Update existing
                manualHoldings[existing].shares += shares;
                manualHoldings[existing].price = price;
                manualHoldings[existing].value = manualHoldings[existing].shares * price;
            } else {
                // Add new
                manualHoldings.push({
                    symbol,
                    shares,
                    price,
                    value: shares * price,
                    description: symbol
                });
            }

            // Clear inputs
            symbolInput.value = '';
            sharesInput.value = '';
            priceInput.value = '';
            symbolInput.focus();

            renderManualHoldings();
        }

        function removeManualHolding(index) {
            manualHoldings.splice(index, 1);
            renderManualHoldings();
        }

        function clearManualHoldings() {
            if (manualHoldings.length === 0) return;

            showConfirmModal({
                title: 'Clear All Holdings?',
                message: 'This will remove all holdings from your list. This action cannot be undone.',
                confirmText: 'Clear All',
                confirmClass: 'btn-primary',
                icon: 'warning',
                onConfirm: () => {
                    const previousHoldings = [...manualHoldings];
                    manualHoldings = [];
                    renderManualHoldings();
                    showUndoToast('All holdings cleared', () => {
                        manualHoldings = previousHoldings;
                        renderManualHoldings();
                    });
                }
            });
        }

        function renderManualHoldings() {
            const list = document.getElementById('manualHoldingsList');
            const empty = document.getElementById('holdingsEmpty');
            const totalEl = document.getElementById('manualTotal');
            const analyzeBtn = document.getElementById('analyzeManualBtn');

            // Calculate total
            const total = manualHoldings.reduce((sum, h) => sum + h.value, 0);
            totalEl.textContent = formatCurrency(total);

            // Enable/disable analyze button
            analyzeBtn.disabled = manualHoldings.length === 0;

            // Render list
            if (manualHoldings.length === 0) {
                empty.style.display = 'block';
                // Remove any existing items
                list.querySelectorAll('.holdings-list-item').forEach(el => el.remove());
                return;
            }

            empty.style.display = 'none';

            // Build items HTML
            const itemsHtml = manualHoldings.map((h, i) => `
                <div class="holdings-list-item">
                    <span class="holding-symbol">${h.symbol}</span>
                    <span class="holding-value">${formatNumber(h.shares)}</span>
                    <span class="holding-value">${formatCurrency(h.price)}</span>
                    <span class="holding-total">${formatCurrency(h.value)}</span>
                    <button class="btn-remove" onclick="removeManualHolding(${i})" title="Remove">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                </div>
            `).join('');

            // Update list (keep header)
            list.querySelectorAll('.holdings-list-item').forEach(el => el.remove());
            list.insertAdjacentHTML('beforeend', itemsHtml);
        }

        async function analyzeManualHoldings() {
            if (manualHoldings.length === 0) return;

            showProgress('Analyzing portfolio...');
            try {
                const res = await fetch(`${API_URL}/analyze`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ positions: manualHoldings, include_risk: true })
                });
                if (!res.ok) throw new Error('Analysis failed');
                portfolioData = await res.json();
                hideProgress();
                hideError();
                showDashboard();
            } catch (err) {
                hideProgress();
                showError('Analysis failed: ' + err.message);
            }
        }

        // =============================================================================
        // WATCHLIST FUNCTIONALITY
        // =============================================================================

        let watchlist = JSON.parse(localStorage.getItem('watchlist') || '[]');

        function renderWatchlist() {
            const tbody = document.getElementById('watchlistBody');
            const emptyState = document.getElementById('watchlistEmptyState');
            const table = document.getElementById('watchlistTable');

            if (watchlist.length === 0) {
                table.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            table.style.display = 'table';
            emptyState.style.display = 'none';

            tbody.innerHTML = watchlist.map(item => `
                <tr>
                    <td><span class="watchlist-symbol">${item.symbol}</span></td>
                    <td>$${item.price?.toFixed(2) || '--'}</td>
                    <td class="watchlist-change ${item.change >= 0 ? 'up' : 'down'}">
                        ${item.change >= 0 ? '+' : ''}${item.change?.toFixed(2) || '--'}
                    </td>
                    <td class="watchlist-change ${item.changePercent >= 0 ? 'up' : 'down'}">
                        ${item.changePercent >= 0 ? '+' : ''}${item.changePercent?.toFixed(2) || '--'}%
                    </td>
                    <td>
                        <svg class="watchlist-sparkline" viewBox="0 0 80 30">
                            <polyline fill="none" stroke="${item.change >= 0 ? 'var(--success)' : 'var(--danger)'}" stroke-width="2"
                                points="${generateSparkline(item.history || [])}"/>
                        </svg>
                    </td>
                    <td>
                        <div class="watchlist-actions">
                            <button class="watchlist-action-btn add-portfolio" onclick="addWatchlistToPortfolio('${item.symbol}')" title="Add to portfolio">+</button>
                            <button class="watchlist-action-btn" onclick="removeFromWatchlist('${item.symbol}')" title="Remove"></button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function generateSparkline(history) {
            if (history.length === 0) {
                // Generate random sparkline for demo
                history = Array.from({length: 7}, () => Math.random() * 20 + 10);
            }
            const max = Math.max(...history);
            const min = Math.min(...history);
            const range = max - min || 1;
            return history.map((val, i) => {
                const x = (i / (history.length - 1)) * 80;
                const y = 30 - ((val - min) / range) * 26;
                return `${x},${y}`;
            }).join(' ');
        }

        async function addToWatchlist() {
            const input = document.getElementById('watchlistSymbol');
            const symbol = input.value.toUpperCase().trim();
            if (!symbol) return;

            if (watchlist.find(w => w.symbol === symbol)) {
                showToast('Symbol already in watchlist', 'warning');
                return;
            }

            showToast(`Adding ${symbol} to watchlist...`, 'info', { duration: 2000 });

            // Try to fetch real price data
            try {
                const response = await fetch(`${API_URL}/quote/${symbol}`);
                if (response.ok) {
                    const data = await response.json();
                    watchlist.push({
                        symbol: symbol,
                        price: data.price || 0,
                        change: data.change || (Math.random() * 10 - 5),
                        changePercent: data.changePercent || (Math.random() * 5 - 2.5),
                        history: data.history || [],
                        addedAt: new Date().toISOString()
                    });
                } else {
                    throw new Error('Quote not available');
                }
            } catch {
                // Add with placeholder data
                watchlist.push({
                    symbol: symbol,
                    price: Math.random() * 500 + 50,
                    change: Math.random() * 10 - 5,
                    changePercent: Math.random() * 5 - 2.5,
                    history: [],
                    addedAt: new Date().toISOString()
                });
            }

            localStorage.setItem('watchlist', JSON.stringify(watchlist));
            input.value = '';
            renderWatchlist();
            showToast(`${symbol} added to watchlist`, 'success');
        }

        function removeFromWatchlist(symbol) {
            watchlist = watchlist.filter(w => w.symbol !== symbol);
            localStorage.setItem('watchlist', JSON.stringify(watchlist));
            renderWatchlist();
            showToast(`${symbol} removed from watchlist`, 'success');
        }

        function addWatchlistToPortfolio(symbol) {
            const item = watchlist.find(w => w.symbol === symbol);
            if (item) {
                manualHoldings.push({
                    symbol: item.symbol,
                    shares: 1,
                    price: item.price
                });
                updateManualTable();
                showToast(`${symbol} added to portfolio`, 'success');
            }
        }

        // =============================================================================
        // GOALS FUNCTIONALITY
        // =============================================================================

        let goals = JSON.parse(localStorage.getItem('investmentGoals') || '[]');
        let selectedGoalType = 'target_value';

        function renderGoals() {
            const container = document.getElementById('goalsList');
            const emptyState = document.getElementById('goalsEmptyState');

            if (goals.length === 0) {
                container.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            container.style.display = 'flex';
            emptyState.style.display = 'none';

            // Get current portfolio value
            const currentValue = portfolioData?.total_value || 0;

            container.innerHTML = goals.map(goal => {
                const progress = Math.min((currentValue / goal.target) * 100, 100);
                const remaining = Math.max(goal.target - currentValue, 0);
                const targetDate = new Date(goal.targetDate);
                const today = new Date();
                const daysRemaining = Math.ceil((targetDate - today) / (1000 * 60 * 60 * 24));
                const monthsRemaining = Math.ceil(daysRemaining / 30);

                return `
                    <div class="goal-card">
                        <div class="goal-header">
                            <div class="goal-info">
                                <div class="goal-name">${goal.icon || ''} ${goal.name}</div>
                                <div class="goal-target">Target: <span class="goal-target-value">$${goal.target.toLocaleString()}</span></div>
                            </div>
                            <div class="goal-eta">
                                <div class="goal-eta-label">Time remaining</div>
                                <div class="goal-eta-value">${daysRemaining > 0 ? (monthsRemaining > 12 ? `${Math.floor(monthsRemaining/12)}y ${monthsRemaining%12}m` : `${monthsRemaining} months`) : 'Past due'}</div>
                            </div>
                        </div>
                        <div class="goal-progress">
                            <div class="goal-progress-bar">
                                <div class="goal-progress-fill" style="width: ${progress}%"></div>
                            </div>
                            <div class="goal-progress-text">
                                <span class="goal-current">$${currentValue.toLocaleString()} (${progress.toFixed(1)}%)</span>
                                <span class="goal-remaining">$${remaining.toLocaleString()} to go</span>
                            </div>
                        </div>
                        <div class="goal-actions">
                            <button class="goal-action-btn" onclick="editGoal('${goal.id}')">Edit</button>
                            <button class="goal-action-btn" onclick="deleteGoal('${goal.id}')">Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function showAddGoalModal() {
            document.getElementById('addGoalModal').classList.add('active');
            // Set default date to 1 year from now
            const defaultDate = new Date();
            defaultDate.setFullYear(defaultDate.getFullYear() + 1);
            document.getElementById('goalDate').value = defaultDate.toISOString().split('T')[0];

            // Setup goal type selection
            document.querySelectorAll('.goal-type-option').forEach(option => {
                option.onclick = () => {
                    document.querySelectorAll('.goal-type-option').forEach(o => o.classList.remove('selected'));
                    option.classList.add('selected');
                    selectedGoalType = option.dataset.type;

                    // Update form based on type
                    const nameInput = document.getElementById('goalName');
                    const targetInput = document.getElementById('goalTarget');
                    switch(selectedGoalType) {
                        case 'retirement':
                            nameInput.placeholder = 'Retirement Fund';
                            targetInput.placeholder = '1000000';
                            break;
                        case 'emergency':
                            nameInput.placeholder = '6 Month Emergency Fund';
                            targetInput.placeholder = '30000';
                            break;
                        case 'target_value':
                            nameInput.placeholder = 'House Down Payment';
                            targetInput.placeholder = '100000';
                            break;
                        default:
                            nameInput.placeholder = 'My Investment Goal';
                            targetInput.placeholder = '50000';
                    }
                };
            });
        }

        function hideAddGoalModal() {
            document.getElementById('addGoalModal').classList.remove('active');
            document.getElementById('addGoalForm').reset();
        }

        function createGoal(event) {
            event.preventDefault();

            const icons = {
                'target_value': '',
                'retirement': '',
                'emergency': '',
                'custom': ''
            };

            const goal = {
                id: Date.now().toString(),
                type: selectedGoalType,
                icon: icons[selectedGoalType],
                name: document.getElementById('goalName').value,
                target: parseFloat(document.getElementById('goalTarget').value),
                targetDate: document.getElementById('goalDate').value,
                starting: parseFloat(document.getElementById('goalStarting').value) || 0,
                createdAt: new Date().toISOString()
            };

            goals.push(goal);
            localStorage.setItem('investmentGoals', JSON.stringify(goals));
            hideAddGoalModal();
            renderGoals();
            showToast('Goal created successfully!', 'success');
        }

        function deleteGoal(goalId) {
            if (confirm('Are you sure you want to delete this goal?')) {
                goals = goals.filter(g => g.id !== goalId);
                localStorage.setItem('investmentGoals', JSON.stringify(goals));
                renderGoals();
                showToast('Goal deleted', 'success');
            }
        }

        function editGoal(goalId) {
            const goal = goals.find(g => g.id === goalId);
            if (!goal) return;

            showAddGoalModal();
            document.getElementById('goalName').value = goal.name;
            document.getElementById('goalTarget').value = goal.target;
            document.getElementById('goalDate').value = goal.targetDate;
            document.getElementById('goalStarting').value = goal.starting;

            // Select the correct goal type
            document.querySelectorAll('.goal-type-option').forEach(option => {
                option.classList.toggle('selected', option.dataset.type === goal.type);
            });
            selectedGoalType = goal.type;

            // Change form to update mode
            const form = document.getElementById('addGoalForm');
            form.onsubmit = (e) => {
                e.preventDefault();
                goal.name = document.getElementById('goalName').value;
                goal.target = parseFloat(document.getElementById('goalTarget').value);
                goal.targetDate = document.getElementById('goalDate').value;
                goal.starting = parseFloat(document.getElementById('goalStarting').value) || 0;
                goal.type = selectedGoalType;
                localStorage.setItem('investmentGoals', JSON.stringify(goals));
                hideAddGoalModal();
                renderGoals();
                showToast('Goal updated', 'success');
                form.onsubmit = createGoal;
            };
        }

        // =============================================================================
        // NEWS FEED FUNCTIONALITY
        // =============================================================================

        const mockNews = [
            {
                title: 'Fed Signals Potential Rate Cuts in 2025',
                source: 'Reuters',
                time: '2 hours ago',
                ticker: null,
                category: 'analysis'
            },
            {
                title: 'Tech Stocks Rally as AI Optimism Grows',
                source: 'Bloomberg',
                time: '3 hours ago',
                ticker: 'QQQ',
                category: 'analysis'
            },
            {
                title: 'Apple Reports Record Services Revenue',
                source: 'CNBC',
                time: '5 hours ago',
                ticker: 'AAPL',
                category: 'earnings'
            },
            {
                title: 'Energy Sector Faces Headwinds Amid Oil Price Decline',
                source: 'MarketWatch',
                time: '6 hours ago',
                ticker: 'XLE',
                category: 'analysis'
            },
            {
                title: 'Microsoft Cloud Growth Exceeds Expectations',
                source: 'WSJ',
                time: '8 hours ago',
                ticker: 'MSFT',
                category: 'earnings'
            },
            {
                title: 'Retail Sales Data Points to Strong Consumer Spending',
                source: 'Reuters',
                time: '1 day ago',
                ticker: null,
                category: 'analysis'
            }
        ];

        function renderNews(filter = 'all') {
            const container = document.getElementById('newsList');
            let filteredNews = mockNews;

            if (filter === 'portfolio' && portfolioData?.positions) {
                const symbols = portfolioData.positions.map(p => p.symbol);
                filteredNews = mockNews.filter(n => n.ticker && symbols.includes(n.ticker));
            } else if (filter === 'earnings') {
                filteredNews = mockNews.filter(n => n.category === 'earnings');
            } else if (filter === 'analysis') {
                filteredNews = mockNews.filter(n => n.category === 'analysis');
            }

            if (filteredNews.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="padding: 40px;">
                        <p>No news articles found</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = filteredNews.map(news => `
                <div class="news-item">
                    <div class="news-thumbnail"></div>
                    <div class="news-content">
                        <div class="news-item-title">${news.title}</div>
                        <div class="news-meta">
                            <span class="news-source">${news.source}</span>
                            <span>${news.time}</span>
                            ${news.ticker ? `<span class="news-ticker">${news.ticker}</span>` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Setup news filter buttons
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.news-filter-btn').forEach(btn => {
                btn.onclick = () => {
                    const parent = btn.closest('.news-filter');
                    parent.querySelectorAll('.news-filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    renderNews(btn.dataset.filter);
                };
            });
        });

        // =============================================================================
        // EARNINGS CALENDAR FUNCTIONALITY
        // =============================================================================

        function generateEarningsCalendar() {
            const container = document.getElementById('earningsList');
            const emptyState = document.getElementById('earningsEmptyState');

            // Generate mock earnings based on portfolio holdings
            const holdings = portfolioData?.positions || [];
            if (holdings.length === 0) {
                container.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';

            // Generate random earnings dates for holdings
            const earnings = holdings.slice(0, 8).map(holding => {
                const date = new Date();
                date.setDate(date.getDate() + Math.floor(Math.random() * 60));
                return {
                    symbol: holding.symbol,
                    name: holding.name || holding.symbol,
                    date: date,
                    epsEstimate: (Math.random() * 5 + 0.5).toFixed(2),
                    time: Math.random() > 0.5 ? 'Before Open' : 'After Close'
                };
            }).sort((a, b) => a.date - b.date);

            container.innerHTML = earnings.map(e => {
                const day = e.date.getDate();
                const month = e.date.toLocaleString('default', { month: 'short' });
                return `
                    <div class="earnings-item">
                        <div class="earnings-date">
                            <div class="earnings-day">${day}</div>
                            <div class="earnings-month">${month}</div>
                        </div>
                        <div class="earnings-info">
                            <div class="earnings-symbol">${e.symbol}</div>
                            <div class="earnings-name">${e.name}</div>
                        </div>
                        <div class="earnings-estimates">
                            <div class="earnings-eps-label">EPS Est.</div>
                            <div class="earnings-eps-value">$${e.epsEstimate}</div>
                        </div>
                        <div class="earnings-time">${e.time}</div>
                    </div>
                `;
            }).join('');
        }

        // =============================================================================
        // PERFORMANCE CHART FUNCTIONALITY
        // =============================================================================

        let performanceChart = null;
        let selectedPeriod = '1M';

        function generatePerformanceData(period) {
            const periods = {
                '1W': 7,
                '1M': 30,
                '3M': 90,
                '6M': 180,
                '1Y': 365,
                'ALL': 730
            };
            const days = periods[period] || 30;
            const data = [];
            const benchmarkData = [];
            let value = portfolioData?.total_value || 100000;
            let benchmark = value;

            for (let i = days; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);

                // Add some randomness to simulate price movement
                const change = (Math.random() - 0.48) * 0.02;
                const benchmarkChange = (Math.random() - 0.49) * 0.015;

                value = value * (1 - change);
                benchmark = benchmark * (1 - benchmarkChange);

                data.push({
                    x: date,
                    y: value
                });
                benchmarkData.push({
                    x: date,
                    y: benchmark
                });
            }

            // Make sure current value matches actual portfolio
            if (portfolioData?.total_value) {
                const factor = portfolioData.total_value / data[data.length - 1].y;
                data.forEach(d => d.y *= factor);
            }

            return { portfolio: data, benchmark: benchmarkData };
        }

        function renderPerformanceChart() {
            const canvas = document.getElementById('performanceChartCanvas');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            const { portfolio, benchmark } = generatePerformanceData(selectedPeriod);

            if (performanceChart) {
                performanceChart.destroy();
            }

            performanceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [
                        {
                            label: 'Portfolio',
                            data: portfolio,
                            borderColor: '#635bff',
                            backgroundColor: 'rgba(99, 91, 255, 0.1)',
                            fill: true,
                            tension: 0.4,
                            pointRadius: 0,
                            borderWidth: 2
                        },
                        {
                            label: 'S&P 500',
                            data: benchmark,
                            borderColor: '#8898aa',
                            backgroundColor: 'transparent',
                            fill: false,
                            tension: 0.4,
                            pointRadius: 0,
                            borderWidth: 1.5,
                            borderDash: [5, 5]
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            align: 'end'
                        },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => `${ctx.dataset.label}: $${ctx.raw.y.toLocaleString(undefined, {maximumFractionDigits: 0})}`
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: selectedPeriod === '1W' ? 'day' : selectedPeriod === '1M' ? 'week' : 'month'
                            },
                            grid: { display: false }
                        },
                        y: {
                            ticks: {
                                callback: (value) => '$' + (value / 1000).toFixed(0) + 'k'
                            },
                            grid: { color: 'rgba(0,0,0,0.05)' }
                        }
                    }
                }
            });

            // Update stats
            const startValue = portfolio[0].y;
            const endValue = portfolio[portfolio.length - 1].y;
            const change = endValue - startValue;
            const changePercent = ((endValue / startValue) - 1) * 100;

            const benchmarkStart = benchmark[0].y;
            const benchmarkEnd = benchmark[benchmark.length - 1].y;
            const benchmarkChange = ((benchmarkEnd / benchmarkStart) - 1) * 100;

            document.getElementById('perfReturn').textContent = `${changePercent >= 0 ? '+' : ''}${changePercent.toFixed(2)}%`;
            document.getElementById('perfReturn').className = `perf-stat-value ${changePercent >= 0 ? 'positive' : 'negative'}`;
            document.getElementById('perfVsBenchmark').textContent = `${(changePercent - benchmarkChange) >= 0 ? '+' : ''}${(changePercent - benchmarkChange).toFixed(2)}%`;
            document.getElementById('perfHigh').textContent = '$' + Math.max(...portfolio.map(p => p.y)).toLocaleString(undefined, {maximumFractionDigits: 0});
            document.getElementById('perfLow').textContent = '$' + Math.min(...portfolio.map(p => p.y)).toLocaleString(undefined, {maximumFractionDigits: 0});
        }

        // Initialize watchlist, goals, and news on tab switch
        const originalSwitchTab = window.switchTab || function() {};
        window.switchTab = function(tabName) {
            // Call original if exists
            if (typeof originalSwitchTab === 'function') {
                originalSwitchTab(tabName);
            }

            // Handle tab visibility
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.tab === tabName);
            });
            const tabContent = document.getElementById('tab-' + tabName);
            if (tabContent) {
                tabContent.classList.add('active');
            }

            // Initialize content for new tabs
            if (tabName === 'watchlist') {
                renderWatchlist();
            } else if (tabName === 'goals') {
                renderGoals();
            } else if (tabName === 'news') {
                renderNews();
            } else if (tabName === 'earnings') {
                generateEarningsCalendar();
            } else if (tabName === 'performance') {
                setTimeout(renderPerformanceChart, 100);
            }
        };

        // Setup period tabs
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.period-tab').forEach(tab => {
                tab.onclick = () => {
                    document.querySelectorAll('.period-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    selectedPeriod = tab.dataset.period;
                    renderPerformanceChart();
                };
            });
        });

        // =============================================================================
        // SERVICE WORKER REGISTRATION
        // =============================================================================

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then((registration) => {
                        console.log('Service Worker registered:', registration.scope);

                        // Check for updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // New content available
                                    showToast('Update available! Refresh to see changes.', 'info', {
                                        title: 'App Update',
                                        action: {
                                            label: 'Refresh',
                                            callback: () => window.location.reload()
                                        },
                                        duration: 0
                                    });
                                }
                            });
                        });
                    })
                    .catch((error) => {
                        console.log('Service Worker registration failed:', error);
                    });
            });
        }
    </script>
</body>
</html>
